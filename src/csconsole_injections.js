var csconsole_injections = [
  /* jquery-3.4.1 */ 'LyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjMuNC4xCiAqIGh0dHBzOi8vanF1ZXJ5LmNvbS8KICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHBzOi8vc2l6emxlanMuY29tLwogKgogKiBDb3B5cmlnaHQgSlMgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQogKiBodHRwczovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDE5LTA1LTAxVDIxOjA0WgogKi8KKCBmdW5jdGlvbiggZ2xvYmFsLCBmYWN0b3J5ICkgewoKCSJ1c2Ugc3RyaWN0IjsKCglpZiAoIHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gIm9iamVjdCIgKSB7CgoJCS8vIEZvciBDb21tb25KUyBhbmQgQ29tbW9uSlMtbGlrZSBlbnZpcm9ubWVudHMgd2hlcmUgYSBwcm9wZXIgYHdpbmRvd2AKCQkvLyBpcyBwcmVzZW50LCBleGVjdXRlIHRoZSBmYWN0b3J5IGFuZCBnZXQgalF1ZXJ5LgoJCS8vIEZvciBlbnZpcm9ubWVudHMgdGhhdCBkbyBub3QgaGF2ZSBhIGB3aW5kb3dgIHdpdGggYSBgZG9jdW1lbnRgCgkJLy8gKHN1Y2ggYXMgTm9kZS5qcyksIGV4cG9zZSBhIGZhY3RvcnkgYXMgbW9kdWxlLmV4cG9ydHMuCgkJLy8gVGhpcyBhY2NlbnR1YXRlcyB0aGUgbmVlZCBmb3IgdGhlIGNyZWF0aW9uIG9mIGEgcmVhbCBgd2luZG93YC4KCQkvLyBlLmcuIHZhciBqUXVlcnkgPSByZXF1aXJlKCJqcXVlcnkiKSh3aW5kb3cpOwoJCS8vIFNlZSB0aWNrZXQgIzE0NTQ5IGZvciBtb3JlIGluZm8uCgkJbW9kdWxlLmV4cG9ydHMgPSBnbG9iYWwuZG9jdW1lbnQgPwoJCQlmYWN0b3J5KCBnbG9iYWwsIHRydWUgKSA6CgkJCWZ1bmN0aW9uKCB3ICkgewoJCQkJaWYgKCAhdy5kb2N1bWVudCApIHsKCQkJCQl0aHJvdyBuZXcgRXJyb3IoICJqUXVlcnkgcmVxdWlyZXMgYSB3aW5kb3cgd2l0aCBhIGRvY3VtZW50IiApOwoJCQkJfQoJCQkJcmV0dXJuIGZhY3RvcnkoIHcgKTsKCQkJfTsKCX0gZWxzZSB7CgkJZmFjdG9yeSggZ2xvYmFsICk7Cgl9CgovLyBQYXNzIHRoaXMgaWYgd2luZG93IGlzIG5vdCBkZWZpbmVkIHlldAp9ICkoIHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDogdGhpcywgZnVuY3Rpb24oIHdpbmRvdywgbm9HbG9iYWwgKSB7CgovLyBFZGdlIDw9IDEyIC0gMTMrLCBGaXJlZm94IDw9MTggLSA0NSssIElFIDEwIC0gMTEsIFNhZmFyaSA1LjEgLSA5KywgaU9TIDYgLSA5LjEKLy8gdGhyb3cgZXhjZXB0aW9ucyB3aGVuIG5vbi1zdHJpY3QgY29kZSAoZS5nLiwgQVNQLk5FVCA0LjUpIGFjY2Vzc2VzIHN0cmljdCBtb2RlCi8vIGFyZ3VtZW50cy5jYWxsZWUuY2FsbGVyICh0cmFjLTEzMzM1KS4gQnV0IGFzIG9mIGpRdWVyeSAzLjAgKDIwMTYpLCBzdHJpY3QgbW9kZSBzaG91bGQgYmUgY29tbW9uCi8vIGVub3VnaCB0aGF0IGFsbCBzdWNoIGF0dGVtcHRzIGFyZSBndWFyZGVkIGluIGEgdHJ5IGJsb2NrLgoidXNlIHN0cmljdCI7Cgp2YXIgYXJyID0gW107Cgp2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7Cgp2YXIgZ2V0UHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7Cgp2YXIgc2xpY2UgPSBhcnIuc2xpY2U7Cgp2YXIgY29uY2F0ID0gYXJyLmNvbmNhdDsKCnZhciBwdXNoID0gYXJyLnB1c2g7Cgp2YXIgaW5kZXhPZiA9IGFyci5pbmRleE9mOwoKdmFyIGNsYXNzMnR5cGUgPSB7fTsKCnZhciB0b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmc7Cgp2YXIgaGFzT3duID0gY2xhc3MydHlwZS5oYXNPd25Qcm9wZXJ0eTsKCnZhciBmblRvU3RyaW5nID0gaGFzT3duLnRvU3RyaW5nOwoKdmFyIE9iamVjdEZ1bmN0aW9uU3RyaW5nID0gZm5Ub1N0cmluZy5jYWxsKCBPYmplY3QgKTsKCnZhciBzdXBwb3J0ID0ge307Cgp2YXIgaXNGdW5jdGlvbiA9IGZ1bmN0aW9uIGlzRnVuY3Rpb24oIG9iaiApIHsKCiAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSA8PTU3LCBGaXJlZm94IDw9NTIKICAgICAgLy8gSW4gc29tZSBicm93c2VycywgdHlwZW9mIHJldHVybnMgImZ1bmN0aW9uIiBmb3IgSFRNTCA8b2JqZWN0PiBlbGVtZW50cwogICAgICAvLyAoaS5lLiwgYHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAib2JqZWN0IiApID09PSAiZnVuY3Rpb24iYCkuCiAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gY2xhc3NpZnkgKmFueSogRE9NIG5vZGUgYXMgYSBmdW5jdGlvbi4KICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG9iai5ub2RlVHlwZSAhPT0gIm51bWJlciI7CiAgfTsKCgp2YXIgaXNXaW5kb3cgPSBmdW5jdGlvbiBpc1dpbmRvdyggb2JqICkgewoJCXJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT09IG9iai53aW5kb3c7Cgl9OwoKCgoKCXZhciBwcmVzZXJ2ZWRTY3JpcHRBdHRyaWJ1dGVzID0gewoJCXR5cGU6IHRydWUsCgkJc3JjOiB0cnVlLAoJCW5vbmNlOiB0cnVlLAoJCW5vTW9kdWxlOiB0cnVlCgl9OwoKCWZ1bmN0aW9uIERPTUV2YWwoIGNvZGUsIG5vZGUsIGRvYyApIHsKCQlkb2MgPSBkb2MgfHwgZG9jdW1lbnQ7CgoJCXZhciBpLCB2YWwsCgkJCXNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCAic2NyaXB0IiApOwoKCQlzY3JpcHQudGV4dCA9IGNvZGU7CgkJaWYgKCBub2RlICkgewoJCQlmb3IgKCBpIGluIHByZXNlcnZlZFNjcmlwdEF0dHJpYnV0ZXMgKSB7CgoJCQkJLy8gU3VwcG9ydDogRmlyZWZveCA2NCssIEVkZ2UgMTgrCgkJCQkvLyBTb21lIGJyb3dzZXJzIGRvbid0IHN1cHBvcnQgdGhlICJub25jZSIgcHJvcGVydHkgb24gc2NyaXB0cy4KCQkJCS8vIE9uIHRoZSBvdGhlciBoYW5kLCBqdXN0IHVzaW5nIGBnZXRBdHRyaWJ1dGVgIGlzIG5vdCBlbm91Z2ggYXMKCQkJCS8vIHRoZSBgbm9uY2VgIGF0dHJpYnV0ZSBpcyByZXNldCB0byBhbiBlbXB0eSBzdHJpbmcgd2hlbmV2ZXIgaXQKCQkJCS8vIGJlY29tZXMgYnJvd3NpbmctY29udGV4dCBjb25uZWN0ZWQuCgkJCQkvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3doYXR3Zy9odG1sL2lzc3Vlcy8yMzY5CgkJCQkvLyBTZWUgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy8jbm9uY2UtYXR0cmlidXRlcwoJCQkJLy8gVGhlIGBub2RlLmdldEF0dHJpYnV0ZWAgY2hlY2sgd2FzIGFkZGVkIGZvciB0aGUgc2FrZSBvZgoJCQkJLy8gYGpRdWVyeS5nbG9iYWxFdmFsYCBzbyB0aGF0IGl0IGNhbiBmYWtlIGEgbm9uY2UtY29udGFpbmluZyBub2RlCgkJCQkvLyB2aWEgYW4gb2JqZWN0LgoJCQkJdmFsID0gbm9kZVsgaSBdIHx8IG5vZGUuZ2V0QXR0cmlidXRlICYmIG5vZGUuZ2V0QXR0cmlidXRlKCBpICk7CgkJCQlpZiAoIHZhbCApIHsKCQkJCQlzY3JpcHQuc2V0QXR0cmlidXRlKCBpLCB2YWwgKTsKCQkJCX0KCQkJfQoJCX0KCQlkb2MuaGVhZC5hcHBlbmRDaGlsZCggc2NyaXB0ICkucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggc2NyaXB0ICk7Cgl9CgoKZnVuY3Rpb24gdG9UeXBlKCBvYmogKSB7CglpZiAoIG9iaiA9PSBudWxsICkgewoJCXJldHVybiBvYmogKyAiIjsKCX0KCgkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9Mi4zIG9ubHkgKGZ1bmN0aW9uaXNoIFJlZ0V4cCkKCXJldHVybiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IiB8fCB0eXBlb2Ygb2JqID09PSAiZnVuY3Rpb24iID8KCQljbGFzczJ0eXBlWyB0b1N0cmluZy5jYWxsKCBvYmogKSBdIHx8ICJvYmplY3QiIDoKCQl0eXBlb2Ygb2JqOwp9Ci8qIGdsb2JhbCBTeW1ib2wgKi8KLy8gRGVmaW5pbmcgdGhpcyBnbG9iYWwgaW4gLmVzbGludHJjLmpzb24gd291bGQgY3JlYXRlIGEgZGFuZ2VyIG9mIHVzaW5nIHRoZSBnbG9iYWwKLy8gdW5ndWFyZGVkIGluIGFub3RoZXIgcGxhY2UsIGl0IHNlZW1zIHNhZmVyIHRvIGRlZmluZSBnbG9iYWwgb25seSBmb3IgdGhpcyBtb2R1bGUKCgoKdmFyCgl2ZXJzaW9uID0gIjMuNC4xIiwKCgkvLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQoJalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoKCQkvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcKCQkvLyBOZWVkIGluaXQgaWYgalF1ZXJ5IGlzIGNhbGxlZCAoanVzdCBhbGxvdyBlcnJvciB0byBiZSB0aHJvd24gaWYgbm90IGluY2x1ZGVkKQoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0ICk7Cgl9LAoKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seQoJLy8gTWFrZSBzdXJlIHdlIHRyaW0gQk9NIGFuZCBOQlNQCglydHJpbSA9IC9eW1xzXHVGRUZGXHhBMF0rfFtcc1x1RkVGRlx4QTBdKyQvZzsKCmpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7CgoJLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBqUXVlcnkgYmVpbmcgdXNlZAoJanF1ZXJ5OiB2ZXJzaW9uLAoKCWNvbnN0cnVjdG9yOiBqUXVlcnksCgoJLy8gVGhlIGRlZmF1bHQgbGVuZ3RoIG9mIGEgalF1ZXJ5IG9iamVjdCBpcyAwCglsZW5ndGg6IDAsCgoJdG9BcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHNsaWNlLmNhbGwoIHRoaXMgKTsKCX0sCgoJLy8gR2V0IHRoZSBOdGggZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldCBPUgoJLy8gR2V0IHRoZSB3aG9sZSBtYXRjaGVkIGVsZW1lbnQgc2V0IGFzIGEgY2xlYW4gYXJyYXkKCWdldDogZnVuY3Rpb24oIG51bSApIHsKCgkJLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgaW4gYSBjbGVhbiBhcnJheQoJCWlmICggbnVtID09IG51bGwgKSB7CgkJCXJldHVybiBzbGljZS5jYWxsKCB0aGlzICk7CgkJfQoKCQkvLyBSZXR1cm4ganVzdCB0aGUgb25lIGVsZW1lbnQgZnJvbSB0aGUgc2V0CgkJcmV0dXJuIG51bSA8IDAgPyB0aGlzWyBudW0gKyB0aGlzLmxlbmd0aCBdIDogdGhpc1sgbnVtIF07Cgl9LAoKCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKCS8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQoJcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgoJCS8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CgkJdmFyIHJldCA9IGpRdWVyeS5tZXJnZSggdGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCgkJLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgoJZWFjaDogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXJldHVybiBqUXVlcnkuZWFjaCggdGhpcywgY2FsbGJhY2sgKTsKCX0sCgoJbWFwOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubWFwKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuIGNhbGxiYWNrLmNhbGwoIGVsZW0sIGksIGVsZW0gKTsKCQl9ICkgKTsKCX0sCgoJc2xpY2U6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7Cgl9LAoKCWZpcnN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lcSggMCApOwoJfSwKCglsYXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lcSggLTEgKTsKCX0sCgoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCXZhciBsZW4gPSB0aGlzLmxlbmd0aCwKCQkJaiA9ICtpICsgKCBpIDwgMCA/IGxlbiA6IDAgKTsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGogPj0gMCAmJiBqIDwgbGVuID8gWyB0aGlzWyBqIF0gXSA6IFtdICk7Cgl9LAoKCWVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucHJldk9iamVjdCB8fCB0aGlzLmNvbnN0cnVjdG9yKCk7Cgl9LAoKCS8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KCS8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLgoJcHVzaDogcHVzaCwKCXNvcnQ6IGFyci5zb3J0LAoJc3BsaWNlOiBhcnIuc3BsaWNlCn07CgpqUXVlcnkuZXh0ZW5kID0galF1ZXJ5LmZuLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewoJdmFyIG9wdGlvbnMsIG5hbWUsIHNyYywgY29weSwgY29weUlzQXJyYXksIGNsb25lLAoJCXRhcmdldCA9IGFyZ3VtZW50c1sgMCBdIHx8IHt9LAoJCWkgPSAxLAoJCWxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCgkJZGVlcCA9IGZhbHNlOwoKCS8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KCWlmICggdHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iICkgewoJCWRlZXAgPSB0YXJnZXQ7CgoJCS8vIFNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKCQl0YXJnZXQgPSBhcmd1bWVudHNbIGkgXSB8fCB7fTsKCQlpKys7Cgl9CgoJLy8gSGFuZGxlIGNhc2Ugd2hlbiB0YXJnZXQgaXMgYSBzdHJpbmcgb3Igc29tZXRoaW5nIChwb3NzaWJsZSBpbiBkZWVwIGNvcHkpCglpZiAoIHR5cGVvZiB0YXJnZXQgIT09ICJvYmplY3QiICYmICFpc0Z1bmN0aW9uKCB0YXJnZXQgKSApIHsKCQl0YXJnZXQgPSB7fTsKCX0KCgkvLyBFeHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQKCWlmICggaSA9PT0gbGVuZ3RoICkgewoJCXRhcmdldCA9IHRoaXM7CgkJaS0tOwoJfQoKCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoKCQkvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzCgkJaWYgKCAoIG9wdGlvbnMgPSBhcmd1bWVudHNbIGkgXSApICE9IG51bGwgKSB7CgoJCQkvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CgkJCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKCQkJCWNvcHkgPSBvcHRpb25zWyBuYW1lIF07CgoJCQkJLy8gUHJldmVudCBPYmplY3QucHJvdG90eXBlIHBvbGx1dGlvbgoJCQkJLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAoJCQkJaWYgKCBuYW1lID09PSAiX19wcm90b19fIiB8fCB0YXJnZXQgPT09IGNvcHkgKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJLy8gUmVjdXJzZSBpZiB3ZSdyZSBtZXJnaW5nIHBsYWluIG9iamVjdHMgb3IgYXJyYXlzCgkJCQlpZiAoIGRlZXAgJiYgY29weSAmJiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KCBjb3B5ICkgfHwKCQkJCQkoIGNvcHlJc0FycmF5ID0gQXJyYXkuaXNBcnJheSggY29weSApICkgKSApIHsKCQkJCQlzcmMgPSB0YXJnZXRbIG5hbWUgXTsKCgkJCQkJLy8gRW5zdXJlIHByb3BlciB0eXBlIGZvciB0aGUgc291cmNlIHZhbHVlCgkJCQkJaWYgKCBjb3B5SXNBcnJheSAmJiAhQXJyYXkuaXNBcnJheSggc3JjICkgKSB7CgkJCQkJCWNsb25lID0gW107CgkJCQkJfSBlbHNlIGlmICggIWNvcHlJc0FycmF5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdCggc3JjICkgKSB7CgkJCQkJCWNsb25lID0ge307CgkJCQkJfSBlbHNlIHsKCQkJCQkJY2xvbmUgPSBzcmM7CgkJCQkJfQoJCQkJCWNvcHlJc0FycmF5ID0gZmFsc2U7CgoJCQkJCS8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggZGVlcCwgY2xvbmUsIGNvcHkgKTsKCgkJCQkvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCgkJCQl9IGVsc2UgaWYgKCBjb3B5ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGFyZ2V0WyBuYW1lIF0gPSBjb3B5OwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CglyZXR1cm4gdGFyZ2V0Owp9OwoKalF1ZXJ5LmV4dGVuZCggewoKCS8vIFVuaXF1ZSBmb3IgZWFjaCBjb3B5IG9mIGpRdWVyeSBvbiB0aGUgcGFnZQoJZXhwYW5kbzogImpRdWVyeSIgKyAoIHZlcnNpb24gKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSggL1xEL2csICIiICksCgoJLy8gQXNzdW1lIGpRdWVyeSBpcyByZWFkeSB3aXRob3V0IHRoZSByZWFkeSBtb2R1bGUKCWlzUmVhZHk6IHRydWUsCgoJZXJyb3I6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgbmV3IEVycm9yKCBtc2cgKTsKCX0sCgoJbm9vcDogZnVuY3Rpb24oKSB7fSwKCglpc1BsYWluT2JqZWN0OiBmdW5jdGlvbiggb2JqICkgewoJCXZhciBwcm90bywgQ3RvcjsKCgkJLy8gRGV0ZWN0IG9idmlvdXMgbmVnYXRpdmVzCgkJLy8gVXNlIHRvU3RyaW5nIGluc3RlYWQgb2YgalF1ZXJ5LnR5cGUgdG8gY2F0Y2ggaG9zdCBvYmplY3RzCgkJaWYgKCAhb2JqIHx8IHRvU3RyaW5nLmNhbGwoIG9iaiApICE9PSAiW29iamVjdCBPYmplY3RdIiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJcHJvdG8gPSBnZXRQcm90byggb2JqICk7CgoJCS8vIE9iamVjdHMgd2l0aCBubyBwcm90b3R5cGUgKGUuZy4sIGBPYmplY3QuY3JlYXRlKCBudWxsIClgKSBhcmUgcGxhaW4KCQlpZiAoICFwcm90byApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQkvLyBPYmplY3RzIHdpdGggcHJvdG90eXBlIGFyZSBwbGFpbiBpZmYgdGhleSB3ZXJlIGNvbnN0cnVjdGVkIGJ5IGEgZ2xvYmFsIE9iamVjdCBmdW5jdGlvbgoJCUN0b3IgPSBoYXNPd24uY2FsbCggcHJvdG8sICJjb25zdHJ1Y3RvciIgKSAmJiBwcm90by5jb25zdHJ1Y3RvcjsKCQlyZXR1cm4gdHlwZW9mIEN0b3IgPT09ICJmdW5jdGlvbiIgJiYgZm5Ub1N0cmluZy5jYWxsKCBDdG9yICkgPT09IE9iamVjdEZ1bmN0aW9uU3RyaW5nOwoJfSwKCglpc0VtcHR5T2JqZWN0OiBmdW5jdGlvbiggb2JqICkgewoJCXZhciBuYW1lOwoKCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLy8gRXZhbHVhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKCWdsb2JhbEV2YWw6IGZ1bmN0aW9uKCBjb2RlLCBvcHRpb25zICkgewoJCURPTUV2YWwoIGNvZGUsIHsgbm9uY2U6IG9wdGlvbnMgJiYgb3B0aW9ucy5ub25jZSB9ICk7Cgl9LAoKCWVhY2g6IGZ1bmN0aW9uKCBvYmosIGNhbGxiYWNrICkgewoJCXZhciBsZW5ndGgsIGkgPSAwOwoKCQlpZiAoIGlzQXJyYXlMaWtlKCBvYmogKSApIHsKCQkJbGVuZ3RoID0gb2JqLmxlbmd0aDsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIGNhbGxiYWNrLmNhbGwoIG9ialsgaSBdLCBpLCBvYmpbIGkgXSApID09PSBmYWxzZSApIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCWZvciAoIGkgaW4gb2JqICkgewoJCQkJaWYgKCBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKSA9PT0gZmFsc2UgKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seQoJdHJpbTogZnVuY3Rpb24oIHRleHQgKSB7CgkJcmV0dXJuIHRleHQgPT0gbnVsbCA/CgkJCSIiIDoKCQkJKCB0ZXh0ICsgIiIgKS5yZXBsYWNlKCBydHJpbSwgIiIgKTsKCX0sCgoJLy8gcmVzdWx0cyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyLCByZXN1bHRzICkgewoJCXZhciByZXQgPSByZXN1bHRzIHx8IFtdOwoKCQlpZiAoIGFyciAhPSBudWxsICkgewoJCQlpZiAoIGlzQXJyYXlMaWtlKCBPYmplY3QoIGFyciApICkgKSB7CgkJCQlqUXVlcnkubWVyZ2UoIHJldCwKCQkJCQl0eXBlb2YgYXJyID09PSAic3RyaW5nIiA/CgkJCQkJWyBhcnIgXSA6IGFycgoJCQkJKTsKCQkJfSBlbHNlIHsKCQkJCXB1c2guY2FsbCggcmV0LCBhcnIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJaW5BcnJheTogZnVuY3Rpb24oIGVsZW0sIGFyciwgaSApIHsKCQlyZXR1cm4gYXJyID09IG51bGwgPyAtMSA6IGluZGV4T2YuY2FsbCggYXJyLCBlbGVtLCBpICk7Cgl9LAoKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQoJLy8gcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdAoJbWVyZ2U6IGZ1bmN0aW9uKCBmaXJzdCwgc2Vjb25kICkgewoJCXZhciBsZW4gPSArc2Vjb25kLmxlbmd0aCwKCQkJaiA9IDAsCgkJCWkgPSBmaXJzdC5sZW5ndGg7CgoJCWZvciAoIDsgaiA8IGxlbjsgaisrICkgewoJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsKCQl9CgoJCWZpcnN0Lmxlbmd0aCA9IGk7CgoJCXJldHVybiBmaXJzdDsKCX0sCgoJZ3JlcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgaW52ZXJ0ICkgewoJCXZhciBjYWxsYmFja0ludmVyc2UsCgkJCW1hdGNoZXMgPSBbXSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJY2FsbGJhY2tFeHBlY3QgPSAhaW52ZXJ0OwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCgkJLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24KCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJY2FsbGJhY2tJbnZlcnNlID0gIWNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICk7CgkJCWlmICggY2FsbGJhY2tJbnZlcnNlICE9PSBjYWxsYmFja0V4cGVjdCApIHsKCQkJCW1hdGNoZXMucHVzaCggZWxlbXNbIGkgXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gbWF0Y2hlczsKCX0sCgoJLy8gYXJnIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgltYXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGFyZyApIHsKCQl2YXIgbGVuZ3RoLCB2YWx1ZSwKCQkJaSA9IDAsCgkJCXJldCA9IFtdOwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIgbmV3IHZhbHVlcwoJCWlmICggaXNBcnJheUxpa2UoIGVsZW1zICkgKSB7CgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aDsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQl2YWx1ZSA9IGNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpLCBhcmcgKTsKCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7CgkJCQkJcmV0LnB1c2goIHZhbHVlICk7CgkJCQl9CgkJCX0KCgkJLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKCQl9IGVsc2UgewoJCQlmb3IgKCBpIGluIGVsZW1zICkgewoJCQkJdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgoJCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJCXJldC5wdXNoKCB2YWx1ZSApOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJcmV0dXJuIGNvbmNhdC5hcHBseSggW10sIHJldCApOwoJfSwKCgkvLyBBIGdsb2JhbCBHVUlEIGNvdW50ZXIgZm9yIG9iamVjdHMKCWd1aWQ6IDEsCgoJLy8galF1ZXJ5LnN1cHBvcnQgaXMgbm90IHVzZWQgaW4gQ29yZSBidXQgb3RoZXIgcHJvamVjdHMgYXR0YWNoIHRoZWlyCgkvLyBwcm9wZXJ0aWVzIHRvIGl0IHNvIGl0IG5lZWRzIHRvIGV4aXN0LgoJc3VwcG9ydDogc3VwcG9ydAp9ICk7CgppZiAoIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgKSB7CglqUXVlcnkuZm5bIFN5bWJvbC5pdGVyYXRvciBdID0gYXJyWyBTeW1ib2wuaXRlcmF0b3IgXTsKfQoKLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCmpRdWVyeS5lYWNoKCAiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCBFcnJvciBTeW1ib2wiLnNwbGl0KCAiICIgKSwKZnVuY3Rpb24oIGksIG5hbWUgKSB7CgljbGFzczJ0eXBlWyAiW29iamVjdCAiICsgbmFtZSArICJdIiBdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwp9ICk7CgpmdW5jdGlvbiBpc0FycmF5TGlrZSggb2JqICkgewoKCS8vIFN1cHBvcnQ6IHJlYWwgaU9TIDguMiBvbmx5IChub3QgcmVwcm9kdWNpYmxlIGluIHNpbXVsYXRvcikKCS8vIGBpbmAgY2hlY2sgdXNlZCB0byBwcmV2ZW50IEpJVCBlcnJvciAoZ2gtMjE0NSkKCS8vIGhhc093biBpc24ndCB1c2VkIGhlcmUgZHVlIHRvIGZhbHNlIG5lZ2F0aXZlcwoJLy8gcmVnYXJkaW5nIE5vZGVsaXN0IGxlbmd0aCBpbiBJRQoJdmFyIGxlbmd0aCA9ICEhb2JqICYmICJsZW5ndGgiIGluIG9iaiAmJiBvYmoubGVuZ3RoLAoJCXR5cGUgPSB0b1R5cGUoIG9iaiApOwoKCWlmICggaXNGdW5jdGlvbiggb2JqICkgfHwgaXNXaW5kb3coIG9iaiApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCglyZXR1cm4gdHlwZSA9PT0gImFycmF5IiB8fCBsZW5ndGggPT09IDAgfHwKCQl0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiBsZW5ndGggPiAwICYmICggbGVuZ3RoIC0gMSApIGluIG9iajsKfQp2YXIgU2l6emxlID0KLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lIHYyLjMuNAogKiBodHRwczovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IEpTIEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cHM6Ly9qcy5mb3VuZGF0aW9uLwogKgogKiBEYXRlOiAyMDE5LTA0LTA4CiAqLwooZnVuY3Rpb24oIHdpbmRvdyApIHsKCnZhciBpLAoJc3VwcG9ydCwKCUV4cHIsCglnZXRUZXh0LAoJaXNYTUwsCgl0b2tlbml6ZSwKCWNvbXBpbGUsCglzZWxlY3QsCglvdXRlcm1vc3RDb250ZXh0LAoJc29ydElucHV0LAoJaGFzRHVwbGljYXRlLAoKCS8vIExvY2FsIGRvY3VtZW50IHZhcnMKCXNldERvY3VtZW50LAoJZG9jdW1lbnQsCglkb2NFbGVtLAoJZG9jdW1lbnRJc0hUTUwsCglyYnVnZ3lRU0EsCglyYnVnZ3lNYXRjaGVzLAoJbWF0Y2hlcywKCWNvbnRhaW5zLAoKCS8vIEluc3RhbmNlLXNwZWNpZmljIGRhdGEKCWV4cGFuZG8gPSAic2l6emxlIiArIDEgKiBuZXcgRGF0ZSgpLAoJcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LAoJZGlycnVucyA9IDAsCglkb25lID0gMCwKCWNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJdG9rZW5DYWNoZSA9IGNyZWF0ZUNhY2hlKCksCgljb21waWxlckNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCW5vbm5hdGl2ZVNlbGVjdG9yQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCX0KCQlyZXR1cm4gMDsKCX0sCgoJLy8gSW5zdGFuY2UgbWV0aG9kcwoJaGFzT3duID0gKHt9KS5oYXNPd25Qcm9wZXJ0eSwKCWFyciA9IFtdLAoJcG9wID0gYXJyLnBvcCwKCXB1c2hfbmF0aXZlID0gYXJyLnB1c2gsCglwdXNoID0gYXJyLnB1c2gsCglzbGljZSA9IGFyci5zbGljZSwKCS8vIFVzZSBhIHN0cmlwcGVkLWRvd24gaW5kZXhPZiBhcyBpdCdzIGZhc3RlciB0aGFuIG5hdGl2ZQoJLy8gaHR0cHM6Ly9qc3BlcmYuY29tL3Rob3ItaW5kZXhvZi12cy1mb3IvNQoJaW5kZXhPZiA9IGZ1bmN0aW9uKCBsaXN0LCBlbGVtICkgewoJCXZhciBpID0gMCwKCQkJbGVuID0gbGlzdC5sZW5ndGg7CgkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCWlmICggbGlzdFtpXSA9PT0gZWxlbSApIHsKCQkJCXJldHVybiBpOwoJCQl9CgkJfQoJCXJldHVybiAtMTsKCX0sCgoJYm9vbGVhbnMgPSAiY2hlY2tlZHxzZWxlY3RlZHxhc3luY3xhdXRvZm9jdXN8YXV0b3BsYXl8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufGlzbWFwfGxvb3B8bXVsdGlwbGV8b3BlbnxyZWFkb25seXxyZXF1aXJlZHxzY29wZWQiLAoKCS8vIFJlZ3VsYXIgZXhwcmVzc2lvbnMKCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jd2hpdGVzcGFjZQoJd2hpdGVzcGFjZSA9ICJbXFx4MjBcXHRcXHJcXG5cXGZdIiwKCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9zeW5kYXRhLmh0bWwjdmFsdWUtZGVmLWlkZW50aWZpZXIKCWlkZW50aWZpZXIgPSAiKD86XFxcXC58W1xcdy1dfFteXDAtXFx4YTBdKSsiLAoKCS8vIEF0dHJpYnV0ZSBzZWxlY3RvcnM6IGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwoJYXR0cmlidXRlcyA9ICJcXFsiICsgd2hpdGVzcGFjZSArICIqKCIgKyBpZGVudGlmaWVyICsgIikoPzoiICsgd2hpdGVzcGFjZSArCgkJLy8gT3BlcmF0b3IgKGNhcHR1cmUgMikKCQkiKihbKl4kfCF+XT89KSIgKyB3aGl0ZXNwYWNlICsKCQkvLyAiQXR0cmlidXRlIHZhbHVlcyBtdXN0IGJlIENTUyBpZGVudGlmaWVycyBbY2FwdHVyZSA1XSBvciBzdHJpbmdzIFtjYXB0dXJlIDMgb3IgY2FwdHVyZSA0XSIKCQkiKig/OicoKD86XFxcXC58W15cXFxcJ10pKiknfFwiKCg/OlxcXFwufFteXFxcXFwiXSkqKVwifCgiICsgaWRlbnRpZmllciArICIpKXwpIiArIHdoaXRlc3BhY2UgKwoJCSIqXFxdIiwKCglwc2V1ZG9zID0gIjooIiArIGlkZW50aWZpZXIgKyAiKSg/OlxcKCgiICsKCQkvLyBUbyByZWR1Y2UgdGhlIG51bWJlciBvZiBzZWxlY3RvcnMgbmVlZGluZyB0b2tlbml6ZSBpbiB0aGUgcHJlRmlsdGVyLCBwcmVmZXIgYXJndW1lbnRzOgoJCS8vIDEuIHF1b3RlZCAoY2FwdHVyZSAzOyBjYXB0dXJlIDQgb3IgY2FwdHVyZSA1KQoJCSIoJygoPzpcXFxcLnxbXlxcXFwnXSkqKSd8XCIoKD86XFxcXC58W15cXFxcXCJdKSopXCIpfCIgKwoJCS8vIDIuIHNpbXBsZSAoY2FwdHVyZSA2KQoJCSIoKD86XFxcXC58W15cXFxcKClbXFxdXXwiICsgYXR0cmlidXRlcyArICIpKil8IiArCgkJLy8gMy4gYW55dGhpbmcgZWxzZSAoY2FwdHVyZSAyKQoJCSIuKiIgKwoJCSIpXFwpfCkiLAoKCS8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKCXJ3aGl0ZXNwYWNlID0gbmV3IFJlZ0V4cCggd2hpdGVzcGFjZSArICIrIiwgImciICksCglydHJpbSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiK3woKD86XnxbXlxcXFxdKSg/OlxcXFwuKSopIiArIHdoaXRlc3BhY2UgKyAiKyQiLCAiZyIgKSwKCglyY29tbWEgPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIiosIiArIHdoaXRlc3BhY2UgKyAiKiIgKSwKCXJjb21iaW5hdG9ycyA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKihbPit+XXwiICsgd2hpdGVzcGFjZSArICIpIiArIHdoaXRlc3BhY2UgKyAiKiIgKSwKCXJkZXNjZW5kID0gbmV3IFJlZ0V4cCggd2hpdGVzcGFjZSArICJ8PiIgKSwKCglycHNldWRvID0gbmV3IFJlZ0V4cCggcHNldWRvcyApLAoJcmlkZW50aWZpZXIgPSBuZXcgUmVnRXhwKCAiXiIgKyBpZGVudGlmaWVyICsgIiQiICksCgoJbWF0Y2hFeHByID0gewoJCSJJRCI6IG5ldyBSZWdFeHAoICJeIygiICsgaWRlbnRpZmllciArICIpIiApLAoJCSJDTEFTUyI6IG5ldyBSZWdFeHAoICJeXFwuKCIgKyBpZGVudGlmaWVyICsgIikiICksCgkJIlRBRyI6IG5ldyBSZWdFeHAoICJeKCIgKyBpZGVudGlmaWVyICsgInxbKl0pIiApLAoJCSJBVFRSIjogbmV3IFJlZ0V4cCggIl4iICsgYXR0cmlidXRlcyApLAoJCSJQU0VVRE8iOiBuZXcgUmVnRXhwKCAiXiIgKyBwc2V1ZG9zICksCgkJIkNISUxEIjogbmV3IFJlZ0V4cCggIl46KG9ubHl8Zmlyc3R8bGFzdHxudGh8bnRoLWxhc3QpLShjaGlsZHxvZi10eXBlKSg/OlxcKCIgKyB3aGl0ZXNwYWNlICsKCQkJIiooZXZlbnxvZGR8KChbKy1dfCkoXFxkKilufCkiICsgd2hpdGVzcGFjZSArICIqKD86KFsrLV18KSIgKyB3aGl0ZXNwYWNlICsKCQkJIiooXFxkKyl8KSkiICsgd2hpdGVzcGFjZSArICIqXFwpfCkiLCAiaSIgKSwKCQkiYm9vbCI6IG5ldyBSZWdFeHAoICJeKD86IiArIGJvb2xlYW5zICsgIikkIiwgImkiICksCgkJLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCgkJLy8gV2UgdXNlIHRoaXMgZm9yIFBPUyBtYXRjaGluZyBpbiBgc2VsZWN0YAoJCSJuZWVkc0NvbnRleHQiOiBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIipbPit+XXw6KGV2ZW58b2RkfGVxfGd0fGx0fG50aHxmaXJzdHxsYXN0KSg/OlxcKCIgKwoJCQl3aGl0ZXNwYWNlICsgIiooKD86LVxcZCk/XFxkKikiICsgd2hpdGVzcGFjZSArICIqXFwpfCkoPz1bXi1dfCQpIiwgImkiICkKCX0sCgoJcmh0bWwgPSAvSFRNTCQvaSwKCXJpbnB1dHMgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLAoJcmhlYWRlciA9IC9eaFxkJC9pLAoKCXJuYXRpdmUgPSAvXltee10rXHtccypcW25hdGl2ZSBcdy8sCgoJLy8gRWFzaWx5LXBhcnNlYWJsZS9yZXRyaWV2YWJsZSBJRCBvciBUQUcgb3IgQ0xBU1Mgc2VsZWN0b3JzCglycXVpY2tFeHByID0gL14oPzojKFtcdy1dKyl8KFx3Kyl8XC4oW1x3LV0rKSkkLywKCglyc2libGluZyA9IC9bK35dLywKCgkvLyBDU1MgZXNjYXBlcwoJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI2VzY2FwZWQtY2hhcmFjdGVycwoJcnVuZXNjYXBlID0gbmV3IFJlZ0V4cCggIlxcXFwoW1xcZGEtZl17MSw2fSIgKyB3aGl0ZXNwYWNlICsgIj98KCIgKyB3aGl0ZXNwYWNlICsgIil8LikiLCAiaWciICksCglmdW5lc2NhcGUgPSBmdW5jdGlvbiggXywgZXNjYXBlZCwgZXNjYXBlZFdoaXRlc3BhY2UgKSB7CgkJdmFyIGhpZ2ggPSAiMHgiICsgZXNjYXBlZCAtIDB4MTAwMDA7CgkJLy8gTmFOIG1lYW5zIG5vbi1jb2RlcG9pbnQKCQkvLyBTdXBwb3J0OiBGaXJlZm94PDI0CgkJLy8gV29ya2Fyb3VuZCBlcnJvbmVvdXMgbnVtZXJpYyBpbnRlcnByZXRhdGlvbiBvZiArIjB4IgoJCXJldHVybiBoaWdoICE9PSBoaWdoIHx8IGVzY2FwZWRXaGl0ZXNwYWNlID8KCQkJZXNjYXBlZCA6CgkJCWhpZ2ggPCAwID8KCQkJCS8vIEJNUCBjb2RlcG9pbnQKCQkJCVN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggKyAweDEwMDAwICkgOgoJCQkJLy8gU3VwcGxlbWVudGFsIFBsYW5lIGNvZGVwb2ludCAoc3Vycm9nYXRlIHBhaXIpCgkJCQlTdHJpbmcuZnJvbUNoYXJDb2RlKCBoaWdoID4+IDEwIHwgMHhEODAwLCBoaWdoICYgMHgzRkYgfCAweERDMDAgKTsKCX0sCgoJLy8gQ1NTIHN0cmluZy9pZGVudGlmaWVyIHNlcmlhbGl6YXRpb24KCS8vIGh0dHBzOi8vZHJhZnRzLmNzc3dnLm9yZy9jc3NvbS8jY29tbW9uLXNlcmlhbGl6aW5nLWlkaW9tcwoJcmNzc2VzY2FwZSA9IC8oW1wwLVx4MWZceDdmXXxeLT9cZCl8Xi0kfFteXDAtXHgxZlx4N2YtXHVGRkZGXHctXS9nLAoJZmNzc2VzY2FwZSA9IGZ1bmN0aW9uKCBjaCwgYXNDb2RlUG9pbnQgKSB7CgkJaWYgKCBhc0NvZGVQb2ludCApIHsKCgkJCS8vIFUrMDAwMCBOVUxMIGJlY29tZXMgVStGRkZEIFJFUExBQ0VNRU5UIENIQVJBQ1RFUgoJCQlpZiAoIGNoID09PSAiXDAiICkgewoJCQkJcmV0dXJuICJcdUZGRkQiOwoJCQl9CgoJCQkvLyBDb250cm9sIGNoYXJhY3RlcnMgYW5kIChkZXBlbmRlbnQgdXBvbiBwb3NpdGlvbikgbnVtYmVycyBnZXQgZXNjYXBlZCBhcyBjb2RlIHBvaW50cwoJCQlyZXR1cm4gY2guc2xpY2UoIDAsIC0xICkgKyAiXFwiICsgY2guY2hhckNvZGVBdCggY2gubGVuZ3RoIC0gMSApLnRvU3RyaW5nKCAxNiApICsgIiAiOwoJCX0KCgkJLy8gT3RoZXIgcG90ZW50aWFsbHktc3BlY2lhbCBBU0NJSSBjaGFyYWN0ZXJzIGdldCBiYWNrc2xhc2gtZXNjYXBlZAoJCXJldHVybiAiXFwiICsgY2g7Cgl9LAoKCS8vIFVzZWQgZm9yIGlmcmFtZXMKCS8vIFNlZSBzZXREb2N1bWVudCgpCgkvLyBSZW1vdmluZyB0aGUgZnVuY3Rpb24gd3JhcHBlciBjYXVzZXMgYSAiUGVybWlzc2lvbiBEZW5pZWQiCgkvLyBlcnJvciBpbiBJRQoJdW5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCXNldERvY3VtZW50KCk7Cgl9LAoKCWluRGlzYWJsZWRGaWVsZHNldCA9IGFkZENvbWJpbmF0b3IoCgkJZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImZpZWxkc2V0IjsKCQl9LAoJCXsgZGlyOiAicGFyZW50Tm9kZSIsIG5leHQ6ICJsZWdlbmQiIH0KCSk7CgovLyBPcHRpbWl6ZSBmb3IgcHVzaC5hcHBseSggXywgTm9kZUxpc3QgKQp0cnkgewoJcHVzaC5hcHBseSgKCQkoYXJyID0gc2xpY2UuY2FsbCggcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMgKSksCgkJcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMKCSk7CgkvLyBTdXBwb3J0OiBBbmRyb2lkPDQuMAoJLy8gRGV0ZWN0IHNpbGVudGx5IGZhaWxpbmcgcHVzaC5hcHBseQoJYXJyWyBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcy5sZW5ndGggXS5ub2RlVHlwZTsKfSBjYXRjaCAoIGUgKSB7CglwdXNoID0geyBhcHBseTogYXJyLmxlbmd0aCA/CgoJCS8vIExldmVyYWdlIHNsaWNlIGlmIHBvc3NpYmxlCgkJZnVuY3Rpb24oIHRhcmdldCwgZWxzICkgewoJCQlwdXNoX25hdGl2ZS5hcHBseSggdGFyZ2V0LCBzbGljZS5jYWxsKGVscykgKTsKCQl9IDoKCgkJLy8gU3VwcG9ydDogSUU8OQoJCS8vIE90aGVyd2lzZSBhcHBlbmQgZGlyZWN0bHkKCQlmdW5jdGlvbiggdGFyZ2V0LCBlbHMgKSB7CgkJCXZhciBqID0gdGFyZ2V0Lmxlbmd0aCwKCQkJCWkgPSAwOwoJCQkvLyBDYW4ndCB0cnVzdCBOb2RlTGlzdC5sZW5ndGgKCQkJd2hpbGUgKCAodGFyZ2V0W2orK10gPSBlbHNbaSsrXSkgKSB7fQoJCQl0YXJnZXQubGVuZ3RoID0gaiAtIDE7CgkJfQoJfTsKfQoKZnVuY3Rpb24gU2l6emxlKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsKCXZhciBtLCBpLCBlbGVtLCBuaWQsIG1hdGNoLCBncm91cHMsIG5ld1NlbGVjdG9yLAoJCW5ld0NvbnRleHQgPSBjb250ZXh0ICYmIGNvbnRleHQub3duZXJEb2N1bWVudCwKCgkJLy8gbm9kZVR5cGUgZGVmYXVsdHMgdG8gOSwgc2luY2UgY29udGV4dCBkZWZhdWx0cyB0byBkb2N1bWVudAoJCW5vZGVUeXBlID0gY29udGV4dCA/IGNvbnRleHQubm9kZVR5cGUgOiA5OwoKCXJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwoKCS8vIFJldHVybiBlYXJseSBmcm9tIGNhbGxzIHdpdGggaW52YWxpZCBzZWxlY3RvciBvciBjb250ZXh0CglpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgfHwgIXNlbGVjdG9yIHx8CgkJbm9kZVR5cGUgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkgJiYgbm9kZVR5cGUgIT09IDExICkgewoKCQlyZXR1cm4gcmVzdWx0czsKCX0KCgkvLyBUcnkgdG8gc2hvcnRjdXQgZmluZCBvcGVyYXRpb25zIChhcyBvcHBvc2VkIHRvIGZpbHRlcnMpIGluIEhUTUwgZG9jdW1lbnRzCglpZiAoICFzZWVkICkgewoKCQlpZiAoICggY29udGV4dCA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogcHJlZmVycmVkRG9jICkgIT09IGRvY3VtZW50ICkgewoJCQlzZXREb2N1bWVudCggY29udGV4dCApOwoJCX0KCQljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCgkJaWYgKCBkb2N1bWVudElzSFRNTCApIHsKCgkJCS8vIElmIHRoZSBzZWxlY3RvciBpcyBzdWZmaWNpZW50bHkgc2ltcGxlLCB0cnkgdXNpbmcgYSAiZ2V0KkJ5KiIgRE9NIG1ldGhvZAoJCQkvLyAoZXhjZXB0aW5nIERvY3VtZW50RnJhZ21lbnQgY29udGV4dCwgd2hlcmUgdGhlIG1ldGhvZHMgZG9uJ3QgZXhpc3QpCgkJCWlmICggbm9kZVR5cGUgIT09IDExICYmIChtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKSkgKSB7CgoJCQkJLy8gSUQgc2VsZWN0b3IKCQkJCWlmICggKG0gPSBtYXRjaFsxXSkgKSB7CgoJCQkJCS8vIERvY3VtZW50IGNvbnRleHQKCQkJCQlpZiAoIG5vZGVUeXBlID09PSA5ICkgewoJCQkJCQlpZiAoIChlbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggbSApKSApIHsKCgkJCQkJCQkvLyBTdXBwb3J0OiBJRSwgT3BlcmEsIFdlYmtpdAoJCQkJCQkJLy8gVE9ETzogaWRlbnRpZnkgdmVyc2lvbnMKCQkJCQkJCS8vIGdldEVsZW1lbnRCeUlkIGNhbiBtYXRjaCBlbGVtZW50cyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJCWlmICggZWxlbS5pZCA9PT0gbSApIHsKCQkJCQkJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsKCQkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCQl9CgoJCQkJCS8vIEVsZW1lbnQgY29udGV4dAoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBTdXBwb3J0OiBJRSwgT3BlcmEsIFdlYmtpdAoJCQkJCQkvLyBUT0RPOiBpZGVudGlmeSB2ZXJzaW9ucwoJCQkJCQkvLyBnZXRFbGVtZW50QnlJZCBjYW4gbWF0Y2ggZWxlbWVudHMgYnkgbmFtZSBpbnN0ZWFkIG9mIElECgkJCQkJCWlmICggbmV3Q29udGV4dCAmJiAoZWxlbSA9IG5ld0NvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKSkgJiYKCQkJCQkJCWNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYKCQkJCQkJCWVsZW0uaWQgPT09IG0gKSB7CgoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJfQoJCQkJCX0KCgkJCQkvLyBUeXBlIHNlbGVjdG9yCgkJCQl9IGVsc2UgaWYgKCBtYXRjaFsyXSApIHsKCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCBzZWxlY3RvciApICk7CgkJCQkJcmV0dXJuIHJlc3VsdHM7CgoJCQkJLy8gQ2xhc3Mgc2VsZWN0b3IKCQkJCX0gZWxzZSBpZiAoIChtID0gbWF0Y2hbM10pICYmIHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJgoJCQkJCWNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSApIHsKCgkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBtICkgKTsKCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCX0KCQkJfQoKCQkJLy8gVGFrZSBhZHZhbnRhZ2Ugb2YgcXVlcnlTZWxlY3RvckFsbAoJCQlpZiAoIHN1cHBvcnQucXNhICYmCgkJCQkhbm9ubmF0aXZlU2VsZWN0b3JDYWNoZVsgc2VsZWN0b3IgKyAiICIgXSAmJgoJCQkJKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KCBzZWxlY3RvciApKSAmJgoKCQkJCS8vIFN1cHBvcnQ6IElFIDggb25seQoJCQkJLy8gRXhjbHVkZSBvYmplY3QgZWxlbWVudHMKCQkJCShub2RlVHlwZSAhPT0gMSB8fCBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJvYmplY3QiKSApIHsKCgkJCQluZXdTZWxlY3RvciA9IHNlbGVjdG9yOwoJCQkJbmV3Q29udGV4dCA9IGNvbnRleHQ7CgoJCQkJLy8gcVNBIGNvbnNpZGVycyBlbGVtZW50cyBvdXRzaWRlIGEgc2NvcGluZyByb290IHdoZW4gZXZhbHVhdGluZyBjaGlsZCBvcgoJCQkJLy8gZGVzY2VuZGFudCBjb21iaW5hdG9ycywgd2hpY2ggaXMgbm90IHdoYXQgd2Ugd2FudC4KCQkJCS8vIEluIHN1Y2ggY2FzZXMsIHdlIHdvcmsgYXJvdW5kIHRoZSBiZWhhdmlvciBieSBwcmVmaXhpbmcgZXZlcnkgc2VsZWN0b3IgaW4gdGhlCgkJCQkvLyBsaXN0IHdpdGggYW4gSUQgc2VsZWN0b3IgcmVmZXJlbmNpbmcgdGhlIHNjb3BlIGNvbnRleHQuCgkJCQkvLyBUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhpcyB0ZWNobmlxdWUuCgkJCQlpZiAoIG5vZGVUeXBlID09PSAxICYmIHJkZXNjZW5kLnRlc3QoIHNlbGVjdG9yICkgKSB7CgoJCQkJCS8vIENhcHR1cmUgdGhlIGNvbnRleHQgSUQsIHNldHRpbmcgaXQgZmlyc3QgaWYgbmVjZXNzYXJ5CgkJCQkJaWYgKCAobmlkID0gY29udGV4dC5nZXRBdHRyaWJ1dGUoICJpZCIgKSkgKSB7CgkJCQkJCW5pZCA9IG5pZC5yZXBsYWNlKCByY3NzZXNjYXBlLCBmY3NzZXNjYXBlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJY29udGV4dC5zZXRBdHRyaWJ1dGUoICJpZCIsIChuaWQgPSBleHBhbmRvKSApOwoJCQkJCX0KCgkJCQkJLy8gUHJlZml4IGV2ZXJ5IHNlbGVjdG9yIGluIHRoZSBsaXN0CgkJCQkJZ3JvdXBzID0gdG9rZW5pemUoIHNlbGVjdG9yICk7CgkJCQkJaSA9IGdyb3Vwcy5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCWdyb3Vwc1tpXSA9ICIjIiArIG5pZCArICIgIiArIHRvU2VsZWN0b3IoIGdyb3Vwc1tpXSApOwoJCQkJCX0KCQkJCQluZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCAiLCIgKTsKCgkJCQkJLy8gRXhwYW5kIGNvbnRleHQgZm9yIHNpYmxpbmcgc2VsZWN0b3JzCgkJCQkJbmV3Q29udGV4dCA9IHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8CgkJCQkJCWNvbnRleHQ7CgkJCQl9CgoJCQkJdHJ5IHsKCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLAoJCQkJCQluZXdDb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoIG5ld1NlbGVjdG9yICkKCQkJCQkpOwoJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJfSBjYXRjaCAoIHFzYUVycm9yICkgewoJCQkJCW5vbm5hdGl2ZVNlbGVjdG9yQ2FjaGUoIHNlbGVjdG9yLCB0cnVlICk7CgkJCQl9IGZpbmFsbHkgewoJCQkJCWlmICggbmlkID09PSBleHBhbmRvICkgewoJCQkJCQljb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSggImlkIiApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBBbGwgb3RoZXJzCglyZXR1cm4gc2VsZWN0KCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICk7Cn0KCi8qKgogKiBDcmVhdGUga2V5LXZhbHVlIGNhY2hlcyBvZiBsaW1pdGVkIHNpemUKICogQHJldHVybnMge2Z1bmN0aW9uKHN0cmluZywgb2JqZWN0KX0gUmV0dXJucyB0aGUgT2JqZWN0IGRhdGEgYWZ0ZXIgc3RvcmluZyBpdCBvbiBpdHNlbGYgd2l0aAogKglwcm9wZXJ0eSBuYW1lIHRoZSAoc3BhY2Utc3VmZml4ZWQpIHN0cmluZyBhbmQgKGlmIHRoZSBjYWNoZSBpcyBsYXJnZXIgdGhhbiBFeHByLmNhY2hlTGVuZ3RoKQogKglkZWxldGluZyB0aGUgb2xkZXN0IGVudHJ5CiAqLwpmdW5jdGlvbiBjcmVhdGVDYWNoZSgpIHsKCXZhciBrZXlzID0gW107CgoJZnVuY3Rpb24gY2FjaGUoIGtleSwgdmFsdWUgKSB7CgkJLy8gVXNlIChrZXkgKyAiICIpIHRvIGF2b2lkIGNvbGxpc2lvbiB3aXRoIG5hdGl2ZSBwcm90b3R5cGUgcHJvcGVydGllcyAoc2VlIElzc3VlICMxNTcpCgkJaWYgKCBrZXlzLnB1c2goIGtleSArICIgIiApID4gRXhwci5jYWNoZUxlbmd0aCApIHsKCQkJLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCgkJCWRlbGV0ZSBjYWNoZVsga2V5cy5zaGlmdCgpIF07CgkJfQoJCXJldHVybiAoY2FjaGVbIGtleSArICIgIiBdID0gdmFsdWUpOwoJfQoJcmV0dXJuIGNhY2hlOwp9CgovKioKICogTWFyayBhIGZ1bmN0aW9uIGZvciBzcGVjaWFsIHVzZSBieSBTaXp6bGUKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICovCmZ1bmN0aW9uIG1hcmtGdW5jdGlvbiggZm4gKSB7CglmblsgZXhwYW5kbyBdID0gdHJ1ZTsKCXJldHVybiBmbjsKfQoKLyoqCiAqIFN1cHBvcnQgdGVzdGluZyB1c2luZyBhbiBlbGVtZW50CiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFBhc3NlZCB0aGUgY3JlYXRlZCBlbGVtZW50IGFuZCByZXR1cm5zIGEgYm9vbGVhbiByZXN1bHQKICovCmZ1bmN0aW9uIGFzc2VydCggZm4gKSB7Cgl2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmaWVsZHNldCIpOwoKCXRyeSB7CgkJcmV0dXJuICEhZm4oIGVsICk7Cgl9IGNhdGNoIChlKSB7CgkJcmV0dXJuIGZhbHNlOwoJfSBmaW5hbGx5IHsKCQkvLyBSZW1vdmUgZnJvbSBpdHMgcGFyZW50IGJ5IGRlZmF1bHQKCQlpZiAoIGVsLnBhcmVudE5vZGUgKSB7CgkJCWVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGVsICk7CgkJfQoJCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFCgkJZWwgPSBudWxsOwoJfQp9CgovKioKICogQWRkcyB0aGUgc2FtZSBoYW5kbGVyIGZvciBhbGwgb2YgdGhlIHNwZWNpZmllZCBhdHRycwogKiBAcGFyYW0ge1N0cmluZ30gYXR0cnMgUGlwZS1zZXBhcmF0ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzCiAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIG1ldGhvZCB0aGF0IHdpbGwgYmUgYXBwbGllZAogKi8KZnVuY3Rpb24gYWRkSGFuZGxlKCBhdHRycywgaGFuZGxlciApIHsKCXZhciBhcnIgPSBhdHRycy5zcGxpdCgifCIpLAoJCWkgPSBhcnIubGVuZ3RoOwoKCXdoaWxlICggaS0tICkgewoJCUV4cHIuYXR0ckhhbmRsZVsgYXJyW2ldIF0gPSBoYW5kbGVyOwoJfQp9CgovKioKICogQ2hlY2tzIGRvY3VtZW50IG9yZGVyIG9mIHR3byBzaWJsaW5ncwogKiBAcGFyYW0ge0VsZW1lbnR9IGEKICogQHBhcmFtIHtFbGVtZW50fSBiCiAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgbGVzcyB0aGFuIDAgaWYgYSBwcmVjZWRlcyBiLCBncmVhdGVyIHRoYW4gMCBpZiBhIGZvbGxvd3MgYgogKi8KZnVuY3Rpb24gc2libGluZ0NoZWNrKCBhLCBiICkgewoJdmFyIGN1ciA9IGIgJiYgYSwKCQlkaWZmID0gY3VyICYmIGEubm9kZVR5cGUgPT09IDEgJiYgYi5ub2RlVHlwZSA9PT0gMSAmJgoJCQlhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCgkvLyBVc2UgSUUgc291cmNlSW5kZXggaWYgYXZhaWxhYmxlIG9uIGJvdGggbm9kZXMKCWlmICggZGlmZiApIHsKCQlyZXR1cm4gZGlmZjsKCX0KCgkvLyBDaGVjayBpZiBiIGZvbGxvd3MgYQoJaWYgKCBjdXIgKSB7CgkJd2hpbGUgKCAoY3VyID0gY3VyLm5leHRTaWJsaW5nKSApIHsKCQkJaWYgKCBjdXIgPT09IGIgKSB7CgkJCQlyZXR1cm4gLTE7CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGEgPyAxIDogLTE7Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGlucHV0IHR5cGVzCiAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAqLwpmdW5jdGlvbiBjcmVhdGVJbnB1dFBzZXVkbyggdHlwZSApIHsKCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQlyZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09IHR5cGU7Cgl9Owp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBidXR0b25zCiAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAqLwpmdW5jdGlvbiBjcmVhdGVCdXR0b25Qc2V1ZG8oIHR5cGUgKSB7CglyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7Cgl9Owp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciA6ZW5hYmxlZC86ZGlzYWJsZWQKICogQHBhcmFtIHtCb29sZWFufSBkaXNhYmxlZCB0cnVlIGZvciA6ZGlzYWJsZWQ7IGZhbHNlIGZvciA6ZW5hYmxlZAogKi8KZnVuY3Rpb24gY3JlYXRlRGlzYWJsZWRQc2V1ZG8oIGRpc2FibGVkICkgewoKCS8vIEtub3duIDpkaXNhYmxlZCBmYWxzZSBwb3NpdGl2ZXM6IGZpZWxkc2V0W2Rpc2FibGVkXSA+IGxlZ2VuZDpudGgtb2YtdHlwZShuKzIpIDpjYW4tZGlzYWJsZQoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoKCQkvLyBPbmx5IGNlcnRhaW4gZWxlbWVudHMgY2FuIG1hdGNoIDplbmFibGVkIG9yIDpkaXNhYmxlZAoJCS8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3NjcmlwdGluZy5odG1sI3NlbGVjdG9yLWVuYWJsZWQKCQkvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9zY3JpcHRpbmcuaHRtbCNzZWxlY3Rvci1kaXNhYmxlZAoJCWlmICggImZvcm0iIGluIGVsZW0gKSB7CgoJCQkvLyBDaGVjayBmb3IgaW5oZXJpdGVkIGRpc2FibGVkbmVzcyBvbiByZWxldmFudCBub24tZGlzYWJsZWQgZWxlbWVudHM6CgkJCS8vICogbGlzdGVkIGZvcm0tYXNzb2NpYXRlZCBlbGVtZW50cyBpbiBhIGRpc2FibGVkIGZpZWxkc2V0CgkJCS8vICAgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNjYXRlZ29yeS1saXN0ZWQKCQkJLy8gICBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9mb3Jtcy5odG1sI2NvbmNlcHQtZmUtZGlzYWJsZWQKCQkJLy8gKiBvcHRpb24gZWxlbWVudHMgaW4gYSBkaXNhYmxlZCBvcHRncm91cAoJCQkvLyAgIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL2Zvcm1zLmh0bWwjY29uY2VwdC1vcHRpb24tZGlzYWJsZWQKCQkJLy8gQWxsIHN1Y2ggZWxlbWVudHMgaGF2ZSBhICJmb3JtIiBwcm9wZXJ0eS4KCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgJiYgZWxlbS5kaXNhYmxlZCA9PT0gZmFsc2UgKSB7CgoJCQkJLy8gT3B0aW9uIGVsZW1lbnRzIGRlZmVyIHRvIGEgcGFyZW50IG9wdGdyb3VwIGlmIHByZXNlbnQKCQkJCWlmICggImxhYmVsIiBpbiBlbGVtICkgewoJCQkJCWlmICggImxhYmVsIiBpbiBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQkJCXJldHVybiBlbGVtLnBhcmVudE5vZGUuZGlzYWJsZWQgPT09IGRpc2FibGVkOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBkaXNhYmxlZDsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU3VwcG9ydDogSUUgNiAtIDExCgkJCQkvLyBVc2UgdGhlIGlzRGlzYWJsZWQgc2hvcnRjdXQgcHJvcGVydHkgdG8gY2hlY2sgZm9yIGRpc2FibGVkIGZpZWxkc2V0IGFuY2VzdG9ycwoJCQkJcmV0dXJuIGVsZW0uaXNEaXNhYmxlZCA9PT0gZGlzYWJsZWQgfHwKCgkJCQkJLy8gV2hlcmUgdGhlcmUgaXMgbm8gaXNEaXNhYmxlZCwgY2hlY2sgbWFudWFsbHkKCQkJCQkvKiBqc2hpbnQgLVcwMTggKi8KCQkJCQllbGVtLmlzRGlzYWJsZWQgIT09ICFkaXNhYmxlZCAmJgoJCQkJCQlpbkRpc2FibGVkRmllbGRzZXQoIGVsZW0gKSA9PT0gZGlzYWJsZWQ7CgkJCX0KCgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBkaXNhYmxlZDsKCgkJLy8gVHJ5IHRvIHdpbm5vdyBvdXQgZWxlbWVudHMgdGhhdCBjYW4ndCBiZSBkaXNhYmxlZCBiZWZvcmUgdHJ1c3RpbmcgdGhlIGRpc2FibGVkIHByb3BlcnR5LgoJCS8vIFNvbWUgdmljdGltcyBnZXQgY2F1Z2h0IGluIG91ciBuZXQgKGxhYmVsLCBsZWdlbmQsIG1lbnUsIHRyYWNrKSwgYnV0IGl0IHNob3VsZG4ndAoJCS8vIGV2ZW4gZXhpc3Qgb24gdGhlbSwgbGV0IGFsb25lIGhhdmUgYSBib29sZWFuIHZhbHVlLgoJCX0gZWxzZSBpZiAoICJsYWJlbCIgaW4gZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGRpc2FibGVkOwoJCX0KCgkJLy8gUmVtYWluaW5nIGVsZW1lbnRzIGFyZSBuZWl0aGVyIDplbmFibGVkIG5vciA6ZGlzYWJsZWQKCQlyZXR1cm4gZmFsc2U7Cgl9Owp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBwb3NpdGlvbmFscwogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbgogKi8KZnVuY3Rpb24gY3JlYXRlUG9zaXRpb25hbFBzZXVkbyggZm4gKSB7CglyZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBhcmd1bWVudCApIHsKCQlhcmd1bWVudCA9ICthcmd1bWVudDsKCQlyZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWVkLCBtYXRjaGVzICkgewoJCQl2YXIgaiwKCQkJCW1hdGNoSW5kZXhlcyA9IGZuKCBbXSwgc2VlZC5sZW5ndGgsIGFyZ3VtZW50ICksCgkJCQlpID0gbWF0Y2hJbmRleGVzLmxlbmd0aDsKCgkJCS8vIE1hdGNoIGVsZW1lbnRzIGZvdW5kIGF0IHRoZSBzcGVjaWZpZWQgaW5kZXhlcwoJCQl3aGlsZSAoIGktLSApIHsKCQkJCWlmICggc2VlZFsgKGogPSBtYXRjaEluZGV4ZXNbaV0pIF0gKSB7CgkJCQkJc2VlZFtqXSA9ICEobWF0Y2hlc1tqXSA9IHNlZWRbal0pOwoJCQkJfQoJCQl9CgkJfSk7Cgl9KTsKfQoKLyoqCiAqIENoZWNrcyBhIG5vZGUgZm9yIHZhbGlkaXR5IGFzIGEgU2l6emxlIGNvbnRleHQKICogQHBhcmFtIHtFbGVtZW50fE9iamVjdD19IGNvbnRleHQKICogQHJldHVybnMge0VsZW1lbnR8T2JqZWN0fEJvb2xlYW59IFRoZSBpbnB1dCBub2RlIGlmIGFjY2VwdGFibGUsIG90aGVyd2lzZSBhIGZhbHN5IHZhbHVlCiAqLwpmdW5jdGlvbiB0ZXN0Q29udGV4dCggY29udGV4dCApIHsKCXJldHVybiBjb250ZXh0ICYmIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIiAmJiBjb250ZXh0Owp9CgovLyBFeHBvc2Ugc3VwcG9ydCB2YXJzIGZvciBjb252ZW5pZW5jZQpzdXBwb3J0ID0gU2l6emxlLnN1cHBvcnQgPSB7fTsKCi8qKgogKiBEZXRlY3RzIFhNTCBub2RlcwogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBlbGVtIEFuIGVsZW1lbnQgb3IgYSBkb2N1bWVudAogKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZmYgZWxlbSBpcyBhIG5vbi1IVE1MIFhNTCBub2RlCiAqLwppc1hNTCA9IFNpenpsZS5pc1hNTCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJdmFyIG5hbWVzcGFjZSA9IGVsZW0ubmFtZXNwYWNlVVJJLAoJCWRvY0VsZW0gPSAoZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0pLmRvY3VtZW50RWxlbWVudDsKCgkvLyBTdXBwb3J0OiBJRSA8PTgKCS8vIEFzc3VtZSBIVE1MIHdoZW4gZG9jdW1lbnRFbGVtZW50IGRvZXNuJ3QgeWV0IGV4aXN0LCBzdWNoIGFzIGluc2lkZSBsb2FkaW5nIGlmcmFtZXMKCS8vIGh0dHBzOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC80ODMzCglyZXR1cm4gIXJodG1sLnRlc3QoIG5hbWVzcGFjZSB8fCBkb2NFbGVtICYmIGRvY0VsZW0ubm9kZU5hbWUgfHwgIkhUTUwiICk7Cn07CgovKioKICogU2V0cyBkb2N1bWVudC1yZWxhdGVkIHZhcmlhYmxlcyBvbmNlIGJhc2VkIG9uIHRoZSBjdXJyZW50IGRvY3VtZW50CiAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IFtkb2NdIEFuIGVsZW1lbnQgb3IgZG9jdW1lbnQgb2JqZWN0IHRvIHVzZSB0byBzZXQgdGhlIGRvY3VtZW50CiAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGN1cnJlbnQgZG9jdW1lbnQKICovCnNldERvY3VtZW50ID0gU2l6emxlLnNldERvY3VtZW50ID0gZnVuY3Rpb24oIG5vZGUgKSB7Cgl2YXIgaGFzQ29tcGFyZSwgc3ViV2luZG93LAoJCWRvYyA9IG5vZGUgPyBub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSA6IHByZWZlcnJlZERvYzsKCgkvLyBSZXR1cm4gZWFybHkgaWYgZG9jIGlzIGludmFsaWQgb3IgYWxyZWFkeSBzZWxlY3RlZAoJaWYgKCBkb2MgPT09IGRvY3VtZW50IHx8IGRvYy5ub2RlVHlwZSAhPT0gOSB8fCAhZG9jLmRvY3VtZW50RWxlbWVudCApIHsKCQlyZXR1cm4gZG9jdW1lbnQ7Cgl9CgoJLy8gVXBkYXRlIGdsb2JhbCB2YXJpYWJsZXMKCWRvY3VtZW50ID0gZG9jOwoJZG9jRWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCWRvY3VtZW50SXNIVE1MID0gIWlzWE1MKCBkb2N1bWVudCApOwoKCS8vIFN1cHBvcnQ6IElFIDktMTEsIEVkZ2UKCS8vIEFjY2Vzc2luZyBpZnJhbWUgZG9jdW1lbnRzIGFmdGVyIHVubG9hZCB0aHJvd3MgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvcnMgKGpRdWVyeSAjMTM5MzYpCglpZiAoIHByZWZlcnJlZERvYyAhPT0gZG9jdW1lbnQgJiYKCQkoc3ViV2luZG93ID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcpICYmIHN1YldpbmRvdy50b3AgIT09IHN1YldpbmRvdyApIHsKCgkJLy8gU3VwcG9ydDogSUUgMTEsIEVkZ2UKCQlpZiAoIHN1YldpbmRvdy5hZGRFdmVudExpc3RlbmVyICkgewoJCQlzdWJXaW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggInVubG9hZCIsIHVubG9hZEhhbmRsZXIsIGZhbHNlICk7CgoJCS8vIFN1cHBvcnQ6IElFIDkgLSAxMCBvbmx5CgkJfSBlbHNlIGlmICggc3ViV2luZG93LmF0dGFjaEV2ZW50ICkgewoJCQlzdWJXaW5kb3cuYXR0YWNoRXZlbnQoICJvbnVubG9hZCIsIHVubG9hZEhhbmRsZXIgKTsKCQl9Cgl9CgoJLyogQXR0cmlidXRlcwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIFN1cHBvcnQ6IElFPDgKCS8vIFZlcmlmeSB0aGF0IGdldEF0dHJpYnV0ZSByZWFsbHkgcmV0dXJucyBhdHRyaWJ1dGVzIGFuZCBub3QgcHJvcGVydGllcwoJLy8gKGV4Y2VwdGluZyBJRTggYm9vbGVhbnMpCglzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGVsICkgewoJCWVsLmNsYXNzTmFtZSA9ICJpIjsKCQlyZXR1cm4gIWVsLmdldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIik7Cgl9KTsKCgkvKiBnZXRFbGVtZW50KHMpQnkqCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKCXN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGVsICkgewoJCWVsLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVDb21tZW50KCIiKSApOwoJCXJldHVybiAhZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGg7Cgl9KTsKCgkvLyBTdXBwb3J0OiBJRTw5CglzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSBybmF0aXZlLnRlc3QoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgKTsKCgkvLyBTdXBwb3J0OiBJRTwxMAoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudEJ5SWQgcmV0dXJucyBlbGVtZW50cyBieSBuYW1lCgkvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtbWF0aWNhbGx5LXNldCBuYW1lcywKCS8vIHNvIHVzZSBhIHJvdW5kYWJvdXQgZ2V0RWxlbWVudHNCeU5hbWUgdGVzdAoJc3VwcG9ydC5nZXRCeUlkID0gYXNzZXJ0KGZ1bmN0aW9uKCBlbCApIHsKCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBlbCApLmlkID0gZXhwYW5kbzsKCQlyZXR1cm4gIWRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lIHx8ICFkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyApLmxlbmd0aDsKCX0pOwoKCS8vIElEIGZpbHRlciBhbmQgZmluZAoJaWYgKCBzdXBwb3J0LmdldEJ5SWQgKSB7CgkJRXhwci5maWx0ZXJbIklEIl0gPSBmdW5jdGlvbiggaWQgKSB7CgkJCXZhciBhdHRySWQgPSBpZC5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IGF0dHJJZDsKCQkJfTsKCQl9OwoJCUV4cHIuZmluZFsiSUQiXSA9IGZ1bmN0aW9uKCBpZCwgY29udGV4dCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnRJc0hUTUwgKSB7CgkJCQl2YXIgZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CgkJCQlyZXR1cm4gZWxlbSA/IFsgZWxlbSBdIDogW107CgkJCX0KCQl9OwoJfSBlbHNlIHsKCQlFeHByLmZpbHRlclsiSUQiXSA9ICBmdW5jdGlvbiggaWQgKSB7CgkJCXZhciBhdHRySWQgPSBpZC5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgbm9kZSA9IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUgIT09ICJ1bmRlZmluZWQiICYmCgkJCQkJZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQkJcmV0dXJuIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gYXR0cklkOwoJCQl9OwoJCX07CgoJCS8vIFN1cHBvcnQ6IElFIDYgLSA3IG9ubHkKCQkvLyBnZXRFbGVtZW50QnlJZCBpcyBub3QgcmVsaWFibGUgYXMgYSBmaW5kIHNob3J0Y3V0CgkJRXhwci5maW5kWyJJRCJdID0gZnVuY3Rpb24oIGlkLCBjb250ZXh0ICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudElzSFRNTCApIHsKCQkJCXZhciBub2RlLCBpLCBlbGVtcywKCQkJCQllbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggaWQgKTsKCgkJCQlpZiAoIGVsZW0gKSB7CgoJCQkJCS8vIFZlcmlmeSB0aGUgaWQgYXR0cmlidXRlCgkJCQkJbm9kZSA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKCQkJCQlpZiAoIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gaWQgKSB7CgkJCQkJCXJldHVybiBbIGVsZW0gXTsKCQkJCQl9CgoJCQkJCS8vIEZhbGwgYmFjayBvbiBnZXRFbGVtZW50c0J5TmFtZQoJCQkJCWVsZW1zID0gY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSggaWQgKTsKCQkJCQlpID0gMDsKCQkJCQl3aGlsZSAoIChlbGVtID0gZWxlbXNbaSsrXSkgKSB7CgkJCQkJCW5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoImlkIik7CgkJCQkJCWlmICggbm9kZSAmJiBub2RlLnZhbHVlID09PSBpZCApIHsKCQkJCQkJCXJldHVybiBbIGVsZW0gXTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gW107CgkJCX0KCQl9OwoJfQoKCS8vIFRhZwoJRXhwci5maW5kWyJUQUciXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPwoJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJLy8gRG9jdW1lbnRGcmFnbWVudCBub2RlcyBkb24ndCBoYXZlIGdFQlROCgkJCX0gZWxzZSBpZiAoIHN1cHBvcnQucXNhICkgewoJCQkJcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnICk7CgkJCX0KCQl9IDoKCgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJdmFyIGVsZW0sCgkJCQl0bXAgPSBbXSwKCQkJCWkgPSAwLAoJCQkJLy8gQnkgaGFwcHkgY29pbmNpZGVuY2UsIGEgKGJyb2tlbikgZ0VCVE4gYXBwZWFycyBvbiBEb2N1bWVudEZyYWdtZW50IG5vZGVzIHRvbwoJCQkJcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwoJCQlpZiAoIHRhZyA9PT0gIioiICkgewoJCQkJd2hpbGUgKCAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQl0bXAucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdG1wOwoJCQl9CgkJCXJldHVybiByZXN1bHRzOwoJCX07CgoJLy8gQ2xhc3MKCUV4cHIuZmluZFsiQ0xBU1MiXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiggY2xhc3NOYW1lLCBjb250ZXh0ICkgewoJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnRJc0hUTUwgKSB7CgkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIGNsYXNzTmFtZSApOwoJCX0KCX07CgoJLyogUVNBL21hdGNoZXNTZWxlY3RvcgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIFFTQSBhbmQgbWF0Y2hlc1NlbGVjdG9yIHN1cHBvcnQKCgkvLyBtYXRjaGVzU2VsZWN0b3IoOmFjdGl2ZSkgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKElFOS9PcGVyYSAxMS41KQoJcmJ1Z2d5TWF0Y2hlcyA9IFtdOwoKCS8vIHFTYSg6Zm9jdXMpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChDaHJvbWUgMjEpCgkvLyBXZSBhbGxvdyB0aGlzIGJlY2F1c2Ugb2YgYSBidWcgaW4gSUU4LzkgdGhhdCB0aHJvd3MgYW4gZXJyb3IKCS8vIHdoZW5ldmVyIGBkb2N1bWVudC5hY3RpdmVFbGVtZW50YCBpcyBhY2Nlc3NlZCBvbiBhbiBpZnJhbWUKCS8vIFNvLCB3ZSBhbGxvdyA6Zm9jdXMgdG8gcGFzcyB0aHJvdWdoIFFTQSBhbGwgdGhlIHRpbWUgdG8gYXZvaWQgdGhlIElFIGVycm9yCgkvLyBTZWUgaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4CglyYnVnZ3lRU0EgPSBbXTsKCglpZiAoIChzdXBwb3J0LnFzYSA9IHJuYXRpdmUudGVzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCApKSApIHsKCQkvLyBCdWlsZCBRU0EgcmVnZXgKCQkvLyBSZWdleCBzdHJhdGVneSBhZG9wdGVkIGZyb20gRGllZ28gUGVyaW5pCgkJYXNzZXJ0KGZ1bmN0aW9uKCBlbCApIHsKCQkJLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQoJCQkvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY2l0bHkKCQkJLy8gc2V0dGluZyBhIGJvb2xlYW4gY29udGVudCBhdHRyaWJ1dGUsCgkJCS8vIHNpbmNlIGl0cyBwcmVzZW5jZSBzaG91bGQgYmUgZW5vdWdoCgkJCS8vIGh0dHBzOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMjM1OQoJCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBlbCApLmlubmVySFRNTCA9ICI8YSBpZD0nIiArIGV4cGFuZG8gKyAiJz48L2E+IiArCgkJCQkiPHNlbGVjdCBpZD0nIiArIGV4cGFuZG8gKyAiLVxyXFwnIG1zYWxsb3djYXB0dXJlPScnPiIgKwoJCQkJIjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCgkJCS8vIFN1cHBvcnQ6IElFOCwgT3BlcmEgMTEtMTIuMTYKCQkJLy8gTm90aGluZyBzaG91bGQgYmUgc2VsZWN0ZWQgd2hlbiBlbXB0eSBzdHJpbmdzIGZvbGxvdyBePSBvciAkPSBvciAqPQoJCQkvLyBUaGUgdGVzdCBhdHRyaWJ1dGUgbXVzdCBiZSB1bmtub3duIGluIE9wZXJhIGJ1dCAic2FmZSIgZm9yIFdpblJUCgkJCS8vIGh0dHBzOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvaGg0NjUzODguYXNweCNhdHRyaWJ1dGVfc2VjdGlvbgoJCQlpZiAoIGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIlttc2FsbG93Y2FwdHVyZV49JyddIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJbKl4kXT0iICsgd2hpdGVzcGFjZSArICIqKD86Jyd8XCJcIikiICk7CgkJCX0KCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQkvLyBCb29sZWFuIGF0dHJpYnV0ZXMgYW5kICJ2YWx1ZSIgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQoJCQlpZiAoICFlbC5xdWVyeVNlbGVjdG9yQWxsKCJbc2VsZWN0ZWRdIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJcXFsiICsgd2hpdGVzcGFjZSArICIqKD86dmFsdWV8IiArIGJvb2xlYW5zICsgIikiICk7CgkJCX0KCgkJCS8vIFN1cHBvcnQ6IENocm9tZTwyOSwgQW5kcm9pZDw0LjQsIFNhZmFyaTw3LjArLCBpT1M8Ny4wKywgUGhhbnRvbUpTPDEuOS44KwoJCQlpZiAoICFlbC5xdWVyeVNlbGVjdG9yQWxsKCAiW2lkfj0iICsgZXhwYW5kbyArICItXSIgKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgifj0iKTsKCQkJfQoKCQkJLy8gV2Via2l0L09wZXJhIC0gOmNoZWNrZWQgc2hvdWxkIHJldHVybiBzZWxlY3RlZCBvcHRpb24gZWxlbWVudHMKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKCQkJLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMKCQkJaWYgKCAhZWwucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKCQkJfQoKCQkJLy8gU3VwcG9ydDogU2FmYXJpIDgrLCBpT1MgOCsKCQkJLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNjg1MQoJCQkvLyBJbi1wYWdlIGBzZWxlY3RvciNpZCBzaWJsaW5nLWNvbWJpbmF0b3Igc2VsZWN0b3JgIGZhaWxzCgkJCWlmICggIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoICJhIyIgKyBleHBhbmRvICsgIisqIiApLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCIuIy4rWyt+XSIpOwoJCQl9CgkJfSk7CgoJCWFzc2VydChmdW5jdGlvbiggZWwgKSB7CgkJCWVsLmlubmVySFRNTCA9ICI8YSBocmVmPScnIGRpc2FibGVkPSdkaXNhYmxlZCc+PC9hPiIgKwoJCQkJIjxzZWxlY3QgZGlzYWJsZWQ9J2Rpc2FibGVkJz48b3B0aW9uLz48L3NlbGVjdD4iOwoKCQkJLy8gU3VwcG9ydDogV2luZG93cyA4IE5hdGl2ZSBBcHBzCgkJCS8vIFRoZSB0eXBlIGFuZCBuYW1lIGF0dHJpYnV0ZXMgYXJlIHJlc3RyaWN0ZWQgZHVyaW5nIC5pbm5lckhUTUwgYXNzaWdubWVudAoJCQl2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCQlpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgImhpZGRlbiIgKTsKCQkJZWwuYXBwZW5kQ2hpbGQoIGlucHV0ICkuc2V0QXR0cmlidXRlKCAibmFtZSIsICJEIiApOwoKCQkJLy8gU3VwcG9ydDogSUU4CgkJCS8vIEVuZm9yY2UgY2FzZS1zZW5zaXRpdml0eSBvZiBuYW1lIGF0dHJpYnV0ZQoJCQlpZiAoIGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIltuYW1lPWRdIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJuYW1lIiArIHdoaXRlc3BhY2UgKyAiKlsqXiR8IX5dPz0iICk7CgkJCX0KCgkJCS8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpCgkJCS8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCgkJCWlmICggZWwucXVlcnlTZWxlY3RvckFsbCgiOmVuYWJsZWQiKS5sZW5ndGggIT09IDIgKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIjplbmFibGVkIiwgIjpkaXNhYmxlZCIgKTsKCQkJfQoKCQkJLy8gU3VwcG9ydDogSUU5LTExKwoJCQkvLyBJRSdzIDpkaXNhYmxlZCBzZWxlY3RvciBkb2VzIG5vdCBwaWNrIHVwIHRoZSBjaGlsZHJlbiBvZiBkaXNhYmxlZCBmaWVsZHNldHMKCQkJZG9jRWxlbS5hcHBlbmRDaGlsZCggZWwgKS5kaXNhYmxlZCA9IHRydWU7CgkJCWlmICggZWwucXVlcnlTZWxlY3RvckFsbCgiOmRpc2FibGVkIikubGVuZ3RoICE9PSAyICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiICk7CgkJCX0KCgkJCS8vIE9wZXJhIDEwLTExIGRvZXMgbm90IHRocm93IG9uIHBvc3QtY29tbWEgaW52YWxpZCBwc2V1ZG9zCgkJCWVsLnF1ZXJ5U2VsZWN0b3JBbGwoIiosOngiKTsKCQkJcmJ1Z2d5UVNBLnB1c2goIiwuKjoiKTsKCQl9KTsKCX0KCglpZiAoIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IHJuYXRpdmUudGVzdCggKG1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXMgfHwKCQlkb2NFbGVtLndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fAoJCWRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5tc01hdGNoZXNTZWxlY3RvcikgKSkgKSB7CgoJCWFzc2VydChmdW5jdGlvbiggZWwgKSB7CgkJCS8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgoJCQkvLyBvbiBhIGRpc2Nvbm5lY3RlZCBub2RlIChJRSA5KQoJCQlzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoID0gbWF0Y2hlcy5jYWxsKCBlbCwgIioiICk7CgoJCQkvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCgkJCS8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKCQkJbWF0Y2hlcy5jYWxsKCBlbCwgIltzIT0nJ106eCIgKTsKCQkJcmJ1Z2d5TWF0Y2hlcy5wdXNoKCAiIT0iLCBwc2V1ZG9zICk7CgkJfSk7Cgl9CgoJcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lRU0Euam9pbigifCIpICk7CglyYnVnZ3lNYXRjaGVzID0gcmJ1Z2d5TWF0Y2hlcy5sZW5ndGggJiYgbmV3IFJlZ0V4cCggcmJ1Z2d5TWF0Y2hlcy5qb2luKCJ8IikgKTsKCgkvKiBDb250YWlucwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoJaGFzQ29tcGFyZSA9IHJuYXRpdmUudGVzdCggZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApOwoKCS8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgoJLy8gUHVycG9zZWZ1bGx5IHNlbGYtZXhjbHVzaXZlCgkvLyBBcyBpbiwgYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZgoJY29udGFpbnMgPSBoYXNDb21wYXJlIHx8IHJuYXRpdmUudGVzdCggZG9jRWxlbS5jb250YWlucyApID8KCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKCQkJCWJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwoJCQlyZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKCQkJCWFkb3duLmNvbnRhaW5zID8KCQkJCQlhZG93bi5jb250YWlucyggYnVwICkgOgoJCQkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNgoJCQkpKTsKCQl9IDoKCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJaWYgKCBiICkgewoJCQkJd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CgkJCQkJaWYgKCBiID09PSBhICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJLyogU29ydGluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIERvY3VtZW50IG9yZGVyIHNvcnRpbmcKCXNvcnRPcmRlciA9IGhhc0NvbXBhcmUgPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgoJCS8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCS8vIFNvcnQgb24gbWV0aG9kIGV4aXN0ZW5jZSBpZiBvbmx5IG9uZSBpbnB1dCBoYXMgY29tcGFyZURvY3VtZW50UG9zaXRpb24KCQl2YXIgY29tcGFyZSA9ICFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIC0gIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb247CgkJaWYgKCBjb21wYXJlICkgewoJCQlyZXR1cm4gY29tcGFyZTsKCQl9CgoJCS8vIENhbGN1bGF0ZSBwb3NpdGlvbiBpZiBib3RoIGlucHV0cyBiZWxvbmcgdG8gdGhlIHNhbWUgZG9jdW1lbnQKCQljb21wYXJlID0gKCBhLm93bmVyRG9jdW1lbnQgfHwgYSApID09PSAoIGIub3duZXJEb2N1bWVudCB8fCBiICkgPwoJCQlhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBiICkgOgoKCQkJLy8gT3RoZXJ3aXNlIHdlIGtub3cgdGhleSBhcmUgZGlzY29ubmVjdGVkCgkJCTE7CgoJCS8vIERpc2Nvbm5lY3RlZCBub2RlcwoJCWlmICggY29tcGFyZSAmIDEgfHwKCQkJKCFzdXBwb3J0LnNvcnREZXRhY2hlZCAmJiBiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBhICkgPT09IGNvbXBhcmUpICkgewoKCQkJLy8gQ2hvb3NlIHRoZSBmaXJzdCBlbGVtZW50IHRoYXQgaXMgcmVsYXRlZCB0byBvdXIgcHJlZmVycmVkIGRvY3VtZW50CgkJCWlmICggYSA9PT0gZG9jdW1lbnQgfHwgYS5vd25lckRvY3VtZW50ID09PSBwcmVmZXJyZWREb2MgJiYgY29udGFpbnMocHJlZmVycmVkRG9jLCBhKSApIHsKCQkJCXJldHVybiAtMTsKCQkJfQoJCQlpZiAoIGIgPT09IGRvY3VtZW50IHx8IGIub3duZXJEb2N1bWVudCA9PT0gcHJlZmVycmVkRG9jICYmIGNvbnRhaW5zKHByZWZlcnJlZERvYywgYikgKSB7CgkJCQlyZXR1cm4gMTsKCQkJfQoKCQkJLy8gTWFpbnRhaW4gb3JpZ2luYWwgb3JkZXIKCQkJcmV0dXJuIHNvcnRJbnB1dCA/CgkJCQkoIGluZGV4T2YoIHNvcnRJbnB1dCwgYSApIC0gaW5kZXhPZiggc29ydElucHV0LCBiICkgKSA6CgkJCQkwOwoJCX0KCgkJcmV0dXJuIGNvbXBhcmUgJiA0ID8gLTEgOiAxOwoJfSA6CglmdW5jdGlvbiggYSwgYiApIHsKCQkvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCXZhciBjdXIsCgkJCWkgPSAwLAoJCQlhdXAgPSBhLnBhcmVudE5vZGUsCgkJCWJ1cCA9IGIucGFyZW50Tm9kZSwKCQkJYXAgPSBbIGEgXSwKCQkJYnAgPSBbIGIgXTsKCgkJLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKCQlpZiAoICFhdXAgfHwgIWJ1cCApIHsKCQkJcmV0dXJuIGEgPT09IGRvY3VtZW50ID8gLTEgOgoJCQkJYiA9PT0gZG9jdW1lbnQgPyAxIDoKCQkJCWF1cCA/IC0xIDoKCQkJCWJ1cCA/IDEgOgoJCQkJc29ydElucHV0ID8KCQkJCSggaW5kZXhPZiggc29ydElucHV0LCBhICkgLSBpbmRleE9mKCBzb3J0SW5wdXQsIGIgKSApIDoKCQkJCTA7CgoJCS8vIElmIHRoZSBub2RlcyBhcmUgc2libGluZ3MsIHdlIGNhbiBkbyBhIHF1aWNrIGNoZWNrCgkJfSBlbHNlIGlmICggYXVwID09PSBidXAgKSB7CgkJCXJldHVybiBzaWJsaW5nQ2hlY2soIGEsIGIgKTsKCQl9CgoJCS8vIE90aGVyd2lzZSB3ZSBuZWVkIGZ1bGwgbGlzdHMgb2YgdGhlaXIgYW5jZXN0b3JzIGZvciBjb21wYXJpc29uCgkJY3VyID0gYTsKCQl3aGlsZSAoIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgKSB7CgkJCWFwLnVuc2hpZnQoIGN1ciApOwoJCX0KCQljdXIgPSBiOwoJCXdoaWxlICggKGN1ciA9IGN1ci5wYXJlbnROb2RlKSApIHsKCQkJYnAudW5zaGlmdCggY3VyICk7CgkJfQoKCQkvLyBXYWxrIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgYSBkaXNjcmVwYW5jeQoJCXdoaWxlICggYXBbaV0gPT09IGJwW2ldICkgewoJCQlpKys7CgkJfQoKCQlyZXR1cm4gaSA/CgkJCS8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3RvcgoJCQlzaWJsaW5nQ2hlY2soIGFwW2ldLCBicFtpXSApIDoKCgkJCS8vIE90aGVyd2lzZSBub2RlcyBpbiBvdXIgZG9jdW1lbnQgc29ydCBmaXJzdAoJCQlhcFtpXSA9PT0gcHJlZmVycmVkRG9jID8gLTEgOgoJCQlicFtpXSA9PT0gcHJlZmVycmVkRG9jID8gMSA6CgkJCTA7Cgl9OwoKCXJldHVybiBkb2N1bWVudDsKfTsKClNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1lbnRzICkgewoJcmV0dXJuIFNpenpsZSggZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMgKTsKfTsKClNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWxlbSwgZXhwciApIHsKCS8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAoJaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBlbGVtICk7Cgl9CgoJaWYgKCBzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciAmJiBkb2N1bWVudElzSFRNTCAmJgoJCSFub25uYXRpdmVTZWxlY3RvckNhY2hlWyBleHByICsgIiAiIF0gJiYKCQkoICFyYnVnZ3lNYXRjaGVzIHx8ICFyYnVnZ3lNYXRjaGVzLnRlc3QoIGV4cHIgKSApICYmCgkJKCAhcmJ1Z2d5UVNBICAgICB8fCAhcmJ1Z2d5UVNBLnRlc3QoIGV4cHIgKSApICkgewoKCQl0cnkgewoJCQl2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKCBlbGVtLCBleHByICk7CgoJCQkvLyBJRSA5J3MgbWF0Y2hlc1NlbGVjdG9yIHJldHVybnMgZmFsc2Ugb24gZGlzY29ubmVjdGVkIG5vZGVzCgkJCWlmICggcmV0IHx8IHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggfHwKCQkJCQkvLyBBcyB3ZWxsLCBkaXNjb25uZWN0ZWQgbm9kZXMgYXJlIHNhaWQgdG8gYmUgaW4gYSBkb2N1bWVudAoJCQkJCS8vIGZyYWdtZW50IGluIElFIDkKCQkJCQllbGVtLmRvY3VtZW50ICYmIGVsZW0uZG9jdW1lbnQubm9kZVR5cGUgIT09IDExICkgewoJCQkJcmV0dXJuIHJldDsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJbm9ubmF0aXZlU2VsZWN0b3JDYWNoZSggZXhwciwgdHJ1ZSApOwoJCX0KCX0KCglyZXR1cm4gU2l6emxlKCBleHByLCBkb2N1bWVudCwgbnVsbCwgWyBlbGVtIF0gKS5sZW5ndGggPiAwOwp9OwoKU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24oIGNvbnRleHQsIGVsZW0gKSB7CgkvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKCWlmICggKCBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCApICE9PSBkb2N1bWVudCApIHsKCQlzZXREb2N1bWVudCggY29udGV4dCApOwoJfQoJcmV0dXJuIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICk7Cn07CgpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0gKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGVsZW0gKTsKCX0KCgl2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbIG5hbWUudG9Mb3dlckNhc2UoKSBdLAoJCS8vIERvbid0IGdldCBmb29sZWQgYnkgT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzIChqUXVlcnkgIzEzODA3KQoJCXZhbCA9IGZuICYmIGhhc093bi5jYWxsKCBFeHByLmF0dHJIYW5kbGUsIG5hbWUudG9Mb3dlckNhc2UoKSApID8KCQkJZm4oIGVsZW0sIG5hbWUsICFkb2N1bWVudElzSFRNTCApIDoKCQkJdW5kZWZpbmVkOwoKCXJldHVybiB2YWwgIT09IHVuZGVmaW5lZCA/CgkJdmFsIDoKCQlzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWRvY3VtZW50SXNIVE1MID8KCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKSA6CgkJCSh2YWwgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSkpICYmIHZhbC5zcGVjaWZpZWQgPwoJCQkJdmFsLnZhbHVlIDoKCQkJCW51bGw7Cn07CgpTaXp6bGUuZXNjYXBlID0gZnVuY3Rpb24oIHNlbCApIHsKCXJldHVybiAoc2VsICsgIiIpLnJlcGxhY2UoIHJjc3Nlc2NhcGUsIGZjc3Nlc2NhcGUgKTsKfTsKClNpenpsZS5lcnJvciA9IGZ1bmN0aW9uKCBtc2cgKSB7Cgl0aHJvdyBuZXcgRXJyb3IoICJTeW50YXggZXJyb3IsIHVucmVjb2duaXplZCBleHByZXNzaW9uOiAiICsgbXNnICk7Cn07CgovKioKICogRG9jdW1lbnQgc29ydGluZyBhbmQgcmVtb3ZpbmcgZHVwbGljYXRlcwogKiBAcGFyYW0ge0FycmF5TGlrZX0gcmVzdWx0cwogKi8KU2l6emxlLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiggcmVzdWx0cyApIHsKCXZhciBlbGVtLAoJCWR1cGxpY2F0ZXMgPSBbXSwKCQlqID0gMCwKCQlpID0gMDsKCgkvLyBVbmxlc3Mgd2UgKmtub3cqIHdlIGNhbiBkZXRlY3QgZHVwbGljYXRlcywgYXNzdW1lIHRoZWlyIHByZXNlbmNlCgloYXNEdXBsaWNhdGUgPSAhc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzOwoJc29ydElucHV0ID0gIXN1cHBvcnQuc29ydFN0YWJsZSAmJiByZXN1bHRzLnNsaWNlKCAwICk7CglyZXN1bHRzLnNvcnQoIHNvcnRPcmRlciApOwoKCWlmICggaGFzRHVwbGljYXRlICkgewoJCXdoaWxlICggKGVsZW0gPSByZXN1bHRzW2krK10pICkgewoJCQlpZiAoIGVsZW0gPT09IHJlc3VsdHNbIGkgXSApIHsKCQkJCWogPSBkdXBsaWNhdGVzLnB1c2goIGkgKTsKCQkJfQoJCX0KCQl3aGlsZSAoIGotLSApIHsKCQkJcmVzdWx0cy5zcGxpY2UoIGR1cGxpY2F0ZXNbIGogXSwgMSApOwoJCX0KCX0KCgkvLyBDbGVhciBpbnB1dCBhZnRlciBzb3J0aW5nIHRvIHJlbGVhc2Ugb2JqZWN0cwoJLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvc2l6emxlL3B1bGwvMjI1Cglzb3J0SW5wdXQgPSBudWxsOwoKCXJldHVybiByZXN1bHRzOwp9OwoKLyoqCiAqIFV0aWxpdHkgZnVuY3Rpb24gZm9yIHJldHJpZXZpbmcgdGhlIHRleHQgdmFsdWUgb2YgYW4gYXJyYXkgb2YgRE9NIG5vZGVzCiAqIEBwYXJhbSB7QXJyYXl8RWxlbWVudH0gZWxlbQogKi8KZ2V0VGV4dCA9IFNpenpsZS5nZXRUZXh0ID0gZnVuY3Rpb24oIGVsZW0gKSB7Cgl2YXIgbm9kZSwKCQlyZXQgPSAiIiwKCQlpID0gMCwKCQlub2RlVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgoJaWYgKCAhbm9kZVR5cGUgKSB7CgkJLy8gSWYgbm8gbm9kZVR5cGUsIHRoaXMgaXMgZXhwZWN0ZWQgdG8gYmUgYW4gYXJyYXkKCQl3aGlsZSAoIChub2RlID0gZWxlbVtpKytdKSApIHsKCQkJLy8gRG8gbm90IHRyYXZlcnNlIGNvbW1lbnQgbm9kZXMKCQkJcmV0ICs9IGdldFRleHQoIG5vZGUgKTsKCQl9Cgl9IGVsc2UgaWYgKCBub2RlVHlwZSA9PT0gMSB8fCBub2RlVHlwZSA9PT0gOSB8fCBub2RlVHlwZSA9PT0gMTEgKSB7CgkJLy8gVXNlIHRleHRDb250ZW50IGZvciBlbGVtZW50cwoJCS8vIGlubmVyVGV4dCB1c2FnZSByZW1vdmVkIGZvciBjb25zaXN0ZW5jeSBvZiBuZXcgbGluZXMgKGpRdWVyeSAjMTExNTMpCgkJaWYgKCB0eXBlb2YgZWxlbS50ZXh0Q29udGVudCA9PT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBlbGVtLnRleHRDb250ZW50OwoJCX0gZWxzZSB7CgkJCS8vIFRyYXZlcnNlIGl0cyBjaGlsZHJlbgoJCQlmb3IgKCBlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZyApIHsKCQkJCXJldCArPSBnZXRUZXh0KCBlbGVtICk7CgkJCX0KCQl9Cgl9IGVsc2UgaWYgKCBub2RlVHlwZSA9PT0gMyB8fCBub2RlVHlwZSA9PT0gNCApIHsKCQlyZXR1cm4gZWxlbS5ub2RlVmFsdWU7Cgl9CgkvLyBEbyBub3QgaW5jbHVkZSBjb21tZW50IG9yIHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb24gbm9kZXMKCglyZXR1cm4gcmV0Owp9OwoKRXhwciA9IFNpenpsZS5zZWxlY3RvcnMgPSB7CgoJLy8gQ2FuIGJlIGFkanVzdGVkIGJ5IHRoZSB1c2VyCgljYWNoZUxlbmd0aDogNTAsCgoJY3JlYXRlUHNldWRvOiBtYXJrRnVuY3Rpb24sCgoJbWF0Y2g6IG1hdGNoRXhwciwKCglhdHRySGFuZGxlOiB7fSwKCglmaW5kOiB7fSwKCglyZWxhdGl2ZTogewoJCSI+IjogeyBkaXI6ICJwYXJlbnROb2RlIiwgZmlyc3Q6IHRydWUgfSwKCQkiICI6IHsgZGlyOiAicGFyZW50Tm9kZSIgfSwKCQkiKyI6IHsgZGlyOiAicHJldmlvdXNTaWJsaW5nIiwgZmlyc3Q6IHRydWUgfSwKCQkifiI6IHsgZGlyOiAicHJldmlvdXNTaWJsaW5nIiB9Cgl9LAoKCXByZUZpbHRlcjogewoJCSJBVFRSIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQltYXRjaFsxXSA9IG1hdGNoWzFdLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgoJCQkvLyBNb3ZlIHRoZSBnaXZlbiB2YWx1ZSB0byBtYXRjaFszXSB3aGV0aGVyIHF1b3RlZCBvciB1bnF1b3RlZAoJCQltYXRjaFszXSA9ICggbWF0Y2hbM10gfHwgbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgIiIgKS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoKCQkJaWYgKCBtYXRjaFsyXSA9PT0gIn49IiApIHsKCQkJCW1hdGNoWzNdID0gIiAiICsgbWF0Y2hbM10gKyAiICI7CgkJCX0KCgkJCXJldHVybiBtYXRjaC5zbGljZSggMCwgNCApOwoJCX0sCgoJCSJDSElMRCI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJLyogbWF0Y2hlcyBmcm9tIG1hdGNoRXhwclsiQ0hJTEQiXQoJCQkJMSB0eXBlIChvbmx5fG50aHwuLi4pCgkJCQkyIHdoYXQgKGNoaWxkfG9mLXR5cGUpCgkJCQkzIGFyZ3VtZW50IChldmVufG9kZHxcZCp8XGQqbihbKy1dXGQrKT98Li4uKQoJCQkJNCB4bi1jb21wb25lbnQgb2YgeG4reSBhcmd1bWVudCAoWystXT9cZCpufCkKCQkJCTUgc2lnbiBvZiB4bi1jb21wb25lbnQKCQkJCTYgeCBvZiB4bi1jb21wb25lbnQKCQkJCTcgc2lnbiBvZiB5LWNvbXBvbmVudAoJCQkJOCB5IG9mIHktY29tcG9uZW50CgkJCSovCgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0udG9Mb3dlckNhc2UoKTsKCgkJCWlmICggbWF0Y2hbMV0uc2xpY2UoIDAsIDMgKSA9PT0gIm50aCIgKSB7CgkJCQkvLyBudGgtKiByZXF1aXJlcyBhcmd1bWVudAoJCQkJaWYgKCAhbWF0Y2hbM10gKSB7CgkJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQkJfQoKCQkJCS8vIG51bWVyaWMgeCBhbmQgeSBwYXJhbWV0ZXJzIGZvciBFeHByLmZpbHRlci5DSElMRAoJCQkJLy8gcmVtZW1iZXIgdGhhdCBmYWxzZS90cnVlIGNhc3QgcmVzcGVjdGl2ZWx5IHRvIDAvMQoJCQkJbWF0Y2hbNF0gPSArKCBtYXRjaFs0XSA/IG1hdGNoWzVdICsgKG1hdGNoWzZdIHx8IDEpIDogMiAqICggbWF0Y2hbM10gPT09ICJldmVuIiB8fCBtYXRjaFszXSA9PT0gIm9kZCIgKSApOwoJCQkJbWF0Y2hbNV0gPSArKCAoIG1hdGNoWzddICsgbWF0Y2hbOF0gKSB8fCBtYXRjaFszXSA9PT0gIm9kZCIgKTsKCgkJCS8vIG90aGVyIHR5cGVzIHByb2hpYml0IGFyZ3VtZW50cwoJCQl9IGVsc2UgaWYgKCBtYXRjaFszXSApIHsKCQkJCVNpenpsZS5lcnJvciggbWF0Y2hbMF0gKTsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoOwoJCX0sCgoJCSJQU0VVRE8iOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCXZhciBleGNlc3MsCgkJCQl1bnF1b3RlZCA9ICFtYXRjaFs2XSAmJiBtYXRjaFsyXTsKCgkJCWlmICggbWF0Y2hFeHByWyJDSElMRCJdLnRlc3QoIG1hdGNoWzBdICkgKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoKCQkJLy8gQWNjZXB0IHF1b3RlZCBhcmd1bWVudHMgYXMtaXMKCQkJaWYgKCBtYXRjaFszXSApIHsKCQkJCW1hdGNoWzJdID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgIiI7CgoJCQkvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cwoJCQl9IGVsc2UgaWYgKCB1bnF1b3RlZCAmJiBycHNldWRvLnRlc3QoIHVucXVvdGVkICkgJiYKCQkJCS8vIEdldCBleGNlc3MgZnJvbSB0b2tlbml6ZSAocmVjdXJzaXZlbHkpCgkJCQkoZXhjZXNzID0gdG9rZW5pemUoIHVucXVvdGVkLCB0cnVlICkpICYmCgkJCQkvLyBhZHZhbmNlIHRvIHRoZSBuZXh0IGNsb3NpbmcgcGFyZW50aGVzaXMKCQkJCShleGNlc3MgPSB1bnF1b3RlZC5pbmRleE9mKCAiKSIsIHVucXVvdGVkLmxlbmd0aCAtIGV4Y2VzcyApIC0gdW5xdW90ZWQubGVuZ3RoKSApIHsKCgkJCQkvLyBleGNlc3MgaXMgYSBuZWdhdGl2ZSBpbmRleAoJCQkJbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSggMCwgZXhjZXNzICk7CgkJCQltYXRjaFsyXSA9IHVucXVvdGVkLnNsaWNlKCAwLCBleGNlc3MgKTsKCQkJfQoKCQkJLy8gUmV0dXJuIG9ubHkgY2FwdHVyZXMgbmVlZGVkIGJ5IHRoZSBwc2V1ZG8gZmlsdGVyIG1ldGhvZCAodHlwZSBhbmQgYXJndW1lbnQpCgkJCXJldHVybiBtYXRjaC5zbGljZSggMCwgMyApOwoJCX0KCX0sCgoJZmlsdGVyOiB7CgoJCSJUQUciOiBmdW5jdGlvbiggbm9kZU5hbWVTZWxlY3RvciApIHsKCQkJdmFyIG5vZGVOYW1lID0gbm9kZU5hbWVTZWxlY3Rvci5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBub2RlTmFtZVNlbGVjdG9yID09PSAiKiIgPwoJCQkJZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9IDoKCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWU7CgkJCQl9OwoJCX0sCgoJCSJDTEFTUyI6IGZ1bmN0aW9uKCBjbGFzc05hbWUgKSB7CgkJCXZhciBwYXR0ZXJuID0gY2xhc3NDYWNoZVsgY2xhc3NOYW1lICsgIiAiIF07CgoJCQlyZXR1cm4gcGF0dGVybiB8fAoJCQkJKHBhdHRlcm4gPSBuZXcgUmVnRXhwKCAiKF58IiArIHdoaXRlc3BhY2UgKyAiKSIgKyBjbGFzc05hbWUgKyAiKCIgKyB3aGl0ZXNwYWNlICsgInwkKSIgKSkgJiYKCQkJCWNsYXNzQ2FjaGUoIGNsYXNzTmFtZSwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuIHBhdHRlcm4udGVzdCggdHlwZW9mIGVsZW0uY2xhc3NOYW1lID09PSAic3RyaW5nIiAmJiBlbGVtLmNsYXNzTmFtZSB8fCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgIT09ICJ1bmRlZmluZWQiICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpIHx8ICIiICk7CgkJCQl9KTsKCQl9LAoKCQkiQVRUUiI6IGZ1bmN0aW9uKCBuYW1lLCBvcGVyYXRvciwgY2hlY2sgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciByZXN1bHQgPSBTaXp6bGUuYXR0ciggZWxlbSwgbmFtZSApOwoKCQkJCWlmICggcmVzdWx0ID09IG51bGwgKSB7CgkJCQkJcmV0dXJuIG9wZXJhdG9yID09PSAiIT0iOwoJCQkJfQoJCQkJaWYgKCAhb3BlcmF0b3IgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgoJCQkJcmVzdWx0ICs9ICIiOwoKCQkJCXJldHVybiBvcGVyYXRvciA9PT0gIj0iID8gcmVzdWx0ID09PSBjaGVjayA6CgkJCQkJb3BlcmF0b3IgPT09ICIhPSIgPyByZXN1bHQgIT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIl49IiA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKCBjaGVjayApID09PSAwIDoKCQkJCQlvcGVyYXRvciA9PT0gIio9IiA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKCBjaGVjayApID4gLTEgOgoJCQkJCW9wZXJhdG9yID09PSAiJD0iID8gY2hlY2sgJiYgcmVzdWx0LnNsaWNlKCAtY2hlY2subGVuZ3RoICkgPT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIn49IiA/ICggIiAiICsgcmVzdWx0LnJlcGxhY2UoIHJ3aGl0ZXNwYWNlLCAiICIgKSArICIgIiApLmluZGV4T2YoIGNoZWNrICkgPiAtMSA6CgkJCQkJb3BlcmF0b3IgPT09ICJ8PSIgPyByZXN1bHQgPT09IGNoZWNrIHx8IHJlc3VsdC5zbGljZSggMCwgY2hlY2subGVuZ3RoICsgMSApID09PSBjaGVjayArICItIiA6CgkJCQkJZmFsc2U7CgkJCX07CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIHR5cGUsIHdoYXQsIGFyZ3VtZW50LCBmaXJzdCwgbGFzdCApIHsKCQkJdmFyIHNpbXBsZSA9IHR5cGUuc2xpY2UoIDAsIDMgKSAhPT0gIm50aCIsCgkJCQlmb3J3YXJkID0gdHlwZS5zbGljZSggLTQgKSAhPT0gImxhc3QiLAoJCQkJb2ZUeXBlID0gd2hhdCA9PT0gIm9mLXR5cGUiOwoKCQkJcmV0dXJuIGZpcnN0ID09PSAxICYmIGxhc3QgPT09IDAgPwoKCQkJCS8vIFNob3J0Y3V0IGZvciA6bnRoLSoobikKCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiAhIWVsZW0ucGFyZW50Tm9kZTsKCQkJCX0gOgoKCQkJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCQkJdmFyIGNhY2hlLCB1bmlxdWVDYWNoZSwgb3V0ZXJDYWNoZSwgbm9kZSwgbm9kZUluZGV4LCBzdGFydCwKCQkJCQkJZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gIm5leHRTaWJsaW5nIiA6ICJwcmV2aW91c1NpYmxpbmciLAoJCQkJCQlwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGUsCgkJCQkJCW5hbWUgPSBvZlR5cGUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQkJCQl1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZSwKCQkJCQkJZGlmZiA9IGZhbHNlOwoKCQkJCQlpZiAoIHBhcmVudCApIHsKCgkJCQkJCS8vIDooZmlyc3R8bGFzdHxvbmx5KS0oY2hpbGR8b2YtdHlwZSkKCQkJCQkJaWYgKCBzaW1wbGUgKSB7CgkJCQkJCQl3aGlsZSAoIGRpciApIHsKCQkJCQkJCQlub2RlID0gZWxlbTsKCQkJCQkJCQl3aGlsZSAoIChub2RlID0gbm9kZVsgZGlyIF0pICkgewoJCQkJCQkJCQlpZiAoIG9mVHlwZSA/CgkJCQkJCQkJCQlub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOgoJCQkJCQkJCQkJbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsKCgkJCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkJCX0KCQkJCQkJCQl9CgkJCQkJCQkJLy8gUmV2ZXJzZSBkaXJlY3Rpb24gZm9yIDpvbmx5LSogKGlmIHdlIGhhdmVuJ3QgeWV0IGRvbmUgc28pCgkJCQkJCQkJc3RhcnQgPSBkaXIgPSB0eXBlID09PSAib25seSIgJiYgIXN0YXJ0ICYmICJuZXh0U2libGluZyI7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoKCQkJCQkJc3RhcnQgPSBbIGZvcndhcmQgPyBwYXJlbnQuZmlyc3RDaGlsZCA6IHBhcmVudC5sYXN0Q2hpbGQgXTsKCgkJCQkJCS8vIG5vbi14bWwgOm50aC1jaGlsZCguLi4pIHN0b3JlcyBjYWNoZSBkYXRhIG9uIGBwYXJlbnRgCgkJCQkJCWlmICggZm9yd2FyZCAmJiB1c2VDYWNoZSApIHsKCgkJCQkJCQkvLyBTZWVrIGBlbGVtYCBmcm9tIGEgcHJldmlvdXNseS1jYWNoZWQgaW5kZXgKCgkJCQkJCQkvLyAuLi5pbiBhIGd6aXAtZnJpZW5kbHkgd2F5CgkJCQkJCQlub2RlID0gcGFyZW50OwoJCQkJCQkJb3V0ZXJDYWNoZSA9IG5vZGVbIGV4cGFuZG8gXSB8fCAobm9kZVsgZXhwYW5kbyBdID0ge30pOwoKCQkJCQkJCS8vIFN1cHBvcnQ6IElFIDw5IG9ubHkKCQkJCQkJCS8vIERlZmVuZCBhZ2FpbnN0IGNsb25lZCBhdHRyb3BlcnRpZXMgKGpRdWVyeSBnaC0xNzA5KQoJCQkJCQkJdW5pcXVlQ2FjaGUgPSBvdXRlckNhY2hlWyBub2RlLnVuaXF1ZUlEIF0gfHwKCQkJCQkJCQkob3V0ZXJDYWNoZVsgbm9kZS51bmlxdWVJRCBdID0ge30pOwoKCQkJCQkJCWNhY2hlID0gdW5pcXVlQ2FjaGVbIHR5cGUgXSB8fCBbXTsKCQkJCQkJCW5vZGVJbmRleCA9IGNhY2hlWyAwIF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbIDEgXTsKCQkJCQkJCWRpZmYgPSBub2RlSW5kZXggJiYgY2FjaGVbIDIgXTsKCQkJCQkJCW5vZGUgPSBub2RlSW5kZXggJiYgcGFyZW50LmNoaWxkTm9kZXNbIG5vZGVJbmRleCBdOwoKCQkJCQkJCXdoaWxlICggKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbIGRpciBdIHx8CgoJCQkJCQkJCS8vIEZhbGxiYWNrIHRvIHNlZWtpbmcgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CgkJCQkJCQkJKGRpZmYgPSBub2RlSW5kZXggPSAwKSB8fCBzdGFydC5wb3AoKSkgKSB7CgoJCQkJCQkJCS8vIFdoZW4gZm91bmQsIGNhY2hlIGluZGV4ZXMgb24gYHBhcmVudGAgYW5kIGJyZWFrCgkJCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICYmICsrZGlmZiAmJiBub2RlID09PSBlbGVtICkgewoJCQkJCQkJCQl1bmlxdWVDYWNoZVsgdHlwZSBdID0gWyBkaXJydW5zLCBub2RlSW5kZXgsIGRpZmYgXTsKCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJfQoJCQkJCQkJfQoKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQoJCQkJCQkJaWYgKCB1c2VDYWNoZSApIHsKCQkJCQkJCQkvLyAuLi5pbiBhIGd6aXAtZnJpZW5kbHkgd2F5CgkJCQkJCQkJbm9kZSA9IGVsZW07CgkJCQkJCQkJb3V0ZXJDYWNoZSA9IG5vZGVbIGV4cGFuZG8gXSB8fCAobm9kZVsgZXhwYW5kbyBdID0ge30pOwoKCQkJCQkJCQkvLyBTdXBwb3J0OiBJRSA8OSBvbmx5CgkJCQkJCQkJLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpCgkJCQkJCQkJdW5pcXVlQ2FjaGUgPSBvdXRlckNhY2hlWyBub2RlLnVuaXF1ZUlEIF0gfHwKCQkJCQkJCQkJKG91dGVyQ2FjaGVbIG5vZGUudW5pcXVlSUQgXSA9IHt9KTsKCgkJCQkJCQkJY2FjaGUgPSB1bmlxdWVDYWNoZVsgdHlwZSBdIHx8IFtdOwoJCQkJCQkJCW5vZGVJbmRleCA9IGNhY2hlWyAwIF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbIDEgXTsKCQkJCQkJCQlkaWZmID0gbm9kZUluZGV4OwoJCQkJCQkJfQoKCQkJCQkJCS8vIHhtbCA6bnRoLWNoaWxkKC4uLikKCQkJCQkJCS8vIG9yIDpudGgtbGFzdC1jaGlsZCguLi4pIG9yIDpudGgoLWxhc3QpPy1vZi10eXBlKC4uLikKCQkJCQkJCWlmICggZGlmZiA9PT0gZmFsc2UgKSB7CgkJCQkJCQkJLy8gVXNlIHRoZSBzYW1lIGxvb3AgYXMgYWJvdmUgdG8gc2VlayBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKCQkJCQkJCQl3aGlsZSAoIChub2RlID0gKytub2RlSW5kZXggJiYgbm9kZSAmJiBub2RlWyBkaXIgXSB8fAoJCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsKCgkJCQkJCQkJCWlmICggKCBvZlR5cGUgPwoJCQkJCQkJCQkJbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lIDoKCQkJCQkJCQkJCW5vZGUubm9kZVR5cGUgPT09IDEgKSAmJgoJCQkJCQkJCQkJKytkaWZmICkgewoKCQkJCQkJCQkJCS8vIENhY2hlIHRoZSBpbmRleCBvZiBlYWNoIGVuY291bnRlcmVkIGVsZW1lbnQKCQkJCQkJCQkJCWlmICggdXNlQ2FjaGUgKSB7CgkJCQkJCQkJCQkJb3V0ZXJDYWNoZSA9IG5vZGVbIGV4cGFuZG8gXSB8fCAobm9kZVsgZXhwYW5kbyBdID0ge30pOwoKCQkJCQkJCQkJCQkvLyBTdXBwb3J0OiBJRSA8OSBvbmx5CgkJCQkJCQkJCQkJLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpCgkJCQkJCQkJCQkJdW5pcXVlQ2FjaGUgPSBvdXRlckNhY2hlWyBub2RlLnVuaXF1ZUlEIF0gfHwKCQkJCQkJCQkJCQkJKG91dGVyQ2FjaGVbIG5vZGUudW5pcXVlSUQgXSA9IHt9KTsKCgkJCQkJCQkJCQkJdW5pcXVlQ2FjaGVbIHR5cGUgXSA9IFsgZGlycnVucywgZGlmZiBdOwoJCQkJCQkJCQkJfQoKCQkJCQkJCQkJCWlmICggbm9kZSA9PT0gZWxlbSApIHsKCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJfQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJLy8gSW5jb3Jwb3JhdGUgdGhlIG9mZnNldCwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKCQkJCQkJZGlmZiAtPSBsYXN0OwoJCQkJCQlyZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgKCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDAgKTsKCQkJCQl9CgkJCQl9OwoJCX0sCgoJCSJQU0VVRE8iOiBmdW5jdGlvbiggcHNldWRvLCBhcmd1bWVudCApIHsKCQkJLy8gcHNldWRvLWNsYXNzIG5hbWVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKCQkJLy8gUHJpb3JpdGl6ZSBieSBjYXNlIHNlbnNpdGl2aXR5IGluIGNhc2UgY3VzdG9tIHBzZXVkb3MgYXJlIGFkZGVkIHdpdGggdXBwZXJjYXNlIGxldHRlcnMKCQkJLy8gUmVtZW1iZXIgdGhhdCBzZXRGaWx0ZXJzIGluaGVyaXRzIGZyb20gcHNldWRvcwoJCQl2YXIgYXJncywKCQkJCWZuID0gRXhwci5wc2V1ZG9zWyBwc2V1ZG8gXSB8fCBFeHByLnNldEZpbHRlcnNbIHBzZXVkby50b0xvd2VyQ2FzZSgpIF0gfHwKCQkJCQlTaXp6bGUuZXJyb3IoICJ1bnN1cHBvcnRlZCBwc2V1ZG86ICIgKyBwc2V1ZG8gKTsKCgkJCS8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKCQkJLy8gYXJndW1lbnRzIGFyZSBuZWVkZWQgdG8gY3JlYXRlIHRoZSBmaWx0ZXIgZnVuY3Rpb24KCQkJLy8ganVzdCBhcyBTaXp6bGUgZG9lcwoJCQlpZiAoIGZuWyBleHBhbmRvIF0gKSB7CgkJCQlyZXR1cm4gZm4oIGFyZ3VtZW50ICk7CgkJCX0KCgkJCS8vIEJ1dCBtYWludGFpbiBzdXBwb3J0IGZvciBvbGQgc2lnbmF0dXJlcwoJCQlpZiAoIGZuLmxlbmd0aCA+IDEgKSB7CgkJCQlhcmdzID0gWyBwc2V1ZG8sIHBzZXVkbywgIiIsIGFyZ3VtZW50IF07CgkJCQlyZXR1cm4gRXhwci5zZXRGaWx0ZXJzLmhhc093blByb3BlcnR5KCBwc2V1ZG8udG9Mb3dlckNhc2UoKSApID8KCQkJCQltYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCQkJCXZhciBpZHgsCgkJCQkJCQltYXRjaGVkID0gZm4oIHNlZWQsIGFyZ3VtZW50ICksCgkJCQkJCQlpID0gbWF0Y2hlZC5sZW5ndGg7CgkJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQkJaWR4ID0gaW5kZXhPZiggc2VlZCwgbWF0Y2hlZFtpXSApOwoJCQkJCQkJc2VlZFsgaWR4IF0gPSAhKCBtYXRjaGVzWyBpZHggXSA9IG1hdGNoZWRbaV0gKTsKCQkJCQkJfQoJCQkJCX0pIDoKCQkJCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJCQkJcmV0dXJuIGZuKCBlbGVtLCAwLCBhcmdzICk7CgkJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIGZuOwoJCX0KCX0sCgoJcHNldWRvczogewoJCS8vIFBvdGVudGlhbGx5IGNvbXBsZXggcHNldWRvcwoJCSJub3QiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCQkvLyBUcmltIHRoZSBzZWxlY3RvciBwYXNzZWQgdG8gY29tcGlsZQoJCQkvLyB0byBhdm9pZCB0cmVhdGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZwoJCQkvLyBzcGFjZXMgYXMgY29tYmluYXRvcnMKCQkJdmFyIGlucHV0ID0gW10sCgkJCQlyZXN1bHRzID0gW10sCgkJCQltYXRjaGVyID0gY29tcGlsZSggc2VsZWN0b3IucmVwbGFjZSggcnRyaW0sICIkMSIgKSApOwoKCQkJcmV0dXJuIG1hdGNoZXJbIGV4cGFuZG8gXSA/CgkJCQltYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMsIGNvbnRleHQsIHhtbCApIHsKCQkJCQl2YXIgZWxlbSwKCQkJCQkJdW5tYXRjaGVkID0gbWF0Y2hlciggc2VlZCwgbnVsbCwgeG1sLCBbXSApLAoJCQkJCQlpID0gc2VlZC5sZW5ndGg7CgoJCQkJCS8vIE1hdGNoIGVsZW1lbnRzIHVubWF0Y2hlZCBieSBgbWF0Y2hlcmAKCQkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQkJaWYgKCAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgKSB7CgkJCQkJCQlzZWVkW2ldID0gIShtYXRjaGVzW2ldID0gZWxlbSk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9KSA6CgkJCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQkJCWlucHV0WzBdID0gZWxlbTsKCQkJCQltYXRjaGVyKCBpbnB1dCwgbnVsbCwgeG1sLCByZXN1bHRzICk7CgkJCQkJLy8gRG9uJ3Qga2VlcCB0aGUgZWxlbWVudCAoaXNzdWUgIzI5OSkKCQkJCQlpbnB1dFswXSA9IG51bGw7CgkJCQkJcmV0dXJuICFyZXN1bHRzLnBvcCgpOwoJCQkJfTsKCQl9KSwKCgkJImhhcyI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBTaXp6bGUoIHNlbGVjdG9yLCBlbGVtICkubGVuZ3RoID4gMDsKCQkJfTsKCQl9KSwKCgkJImNvbnRhaW5zIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCB0ZXh0ICkgewoJCQl0ZXh0ID0gdGV4dC5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gKCBlbGVtLnRleHRDb250ZW50IHx8IGdldFRleHQoIGVsZW0gKSApLmluZGV4T2YoIHRleHQgKSA+IC0xOwoJCQl9OwoJCX0pLAoKCQkvLyAiV2hldGhlciBhbiBlbGVtZW50IGlzIHJlcHJlc2VudGVkIGJ5IGEgOmxhbmcoKSBzZWxlY3RvcgoJCS8vIGlzIGJhc2VkIHNvbGVseSBvbiB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlCgkJLy8gYmVpbmcgZXF1YWwgdG8gdGhlIGlkZW50aWZpZXIgQywKCQkvLyBvciBiZWdpbm5pbmcgd2l0aCB0aGUgaWRlbnRpZmllciBDIGltbWVkaWF0ZWx5IGZvbGxvd2VkIGJ5ICItIi4KCQkvLyBUaGUgbWF0Y2hpbmcgb2YgQyBhZ2FpbnN0IHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUgaXMgcGVyZm9ybWVkIGNhc2UtaW5zZW5zaXRpdmVseS4KCQkvLyBUaGUgaWRlbnRpZmllciBDIGRvZXMgbm90IGhhdmUgdG8gYmUgYSB2YWxpZCBsYW5ndWFnZSBuYW1lLiIKCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2xhbmctcHNldWRvCgkJImxhbmciOiBtYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBsYW5nICkgewoJCQkvLyBsYW5nIHZhbHVlIG11c3QgYmUgYSB2YWxpZCBpZGVudGlmaWVyCgkJCWlmICggIXJpZGVudGlmaWVyLnRlc3QobGFuZyB8fCAiIikgKSB7CgkJCQlTaXp6bGUuZXJyb3IoICJ1bnN1cHBvcnRlZCBsYW5nOiAiICsgbGFuZyApOwoJCQl9CgkJCWxhbmcgPSBsYW5nLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICkudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIGVsZW1MYW5nOwoJCQkJZG8gewoJCQkJCWlmICggKGVsZW1MYW5nID0gZG9jdW1lbnRJc0hUTUwgPwoJCQkJCQllbGVtLmxhbmcgOgoJCQkJCQllbGVtLmdldEF0dHJpYnV0ZSgieG1sOmxhbmciKSB8fCBlbGVtLmdldEF0dHJpYnV0ZSgibGFuZyIpKSApIHsKCgkJCQkJCWVsZW1MYW5nID0gZWxlbUxhbmcudG9Mb3dlckNhc2UoKTsKCQkJCQkJcmV0dXJuIGVsZW1MYW5nID09PSBsYW5nIHx8IGVsZW1MYW5nLmluZGV4T2YoIGxhbmcgKyAiLSIgKSA9PT0gMDsKCQkJCQl9CgkJCQl9IHdoaWxlICggKGVsZW0gPSBlbGVtLnBhcmVudE5vZGUpICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfTsKCQl9KSwKCgkJLy8gTWlzY2VsbGFuZW91cwoJCSJ0YXJnZXQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIGhhc2ggPSB3aW5kb3cubG9jYXRpb24gJiYgd2luZG93LmxvY2F0aW9uLmhhc2g7CgkJCXJldHVybiBoYXNoICYmIGhhc2guc2xpY2UoIDEgKSA9PT0gZWxlbS5pZDsKCQl9LAoKCQkicm9vdCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZG9jRWxlbTsKCQl9LAoKCQkiZm9jdXMiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0gPT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgKCFkb2N1bWVudC5oYXNGb2N1cyB8fCBkb2N1bWVudC5oYXNGb2N1cygpKSAmJiAhIShlbGVtLnR5cGUgfHwgZWxlbS5ocmVmIHx8IH5lbGVtLnRhYkluZGV4KTsKCQl9LAoKCQkvLyBCb29sZWFuIHByb3BlcnRpZXMKCQkiZW5hYmxlZCI6IGNyZWF0ZURpc2FibGVkUHNldWRvKCBmYWxzZSApLAoJCSJkaXNhYmxlZCI6IGNyZWF0ZURpc2FibGVkUHNldWRvKCB0cnVlICksCgoJCSJjaGVja2VkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIEluIENTUzMsIDpjaGVja2VkIHNob3VsZCByZXR1cm4gYm90aCBjaGVja2VkIGFuZCBzZWxlY3RlZCBlbGVtZW50cwoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAoJCQl2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgISFlbGVtLmNoZWNrZWQpIHx8IChub2RlTmFtZSA9PT0gIm9wdGlvbiIgJiYgISFlbGVtLnNlbGVjdGVkKTsKCQl9LAoKCQkic2VsZWN0ZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gQWNjZXNzaW5nIHRoaXMgcHJvcGVydHkgbWFrZXMgc2VsZWN0ZWQtYnktZGVmYXVsdAoJCQkvLyBvcHRpb25zIGluIFNhZmFyaSB3b3JrIHByb3Blcmx5CgkJCWlmICggZWxlbS5wYXJlbnROb2RlICkgewoJCQkJZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCX0KCgkJCXJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIENvbnRlbnRzCgkJImVtcHR5IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvCgkJCS8vIDplbXB0eSBpcyBuZWdhdGVkIGJ5IGVsZW1lbnQgKDEpIG9yIGNvbnRlbnQgbm9kZXMgKHRleHQ6IDM7IGNkYXRhOiA0OyBlbnRpdHkgcmVmOiA1KSwKCQkJLy8gICBidXQgbm90IGJ5IG90aGVycyAoY29tbWVudDogODsgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbjogNzsgZXRjLikKCQkJLy8gbm9kZVR5cGUgPCA2IHdvcmtzIGJlY2F1c2UgYXR0cmlidXRlcyAoMikgZG8gbm90IGFwcGVhciBhcyBjaGlsZHJlbgoJCQlmb3IgKCBlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZyApIHsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA8IDYgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCSJwYXJlbnQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICFFeHByLnBzZXVkb3NbImVtcHR5Il0oIGVsZW0gKTsKCQl9LAoKCQkvLyBFbGVtZW50L2lucHV0IHR5cGVzCgkJImhlYWRlciI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gcmhlYWRlci50ZXN0KCBlbGVtLm5vZGVOYW1lICk7CgkJfSwKCgkJImlucHV0IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaW5wdXRzLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkiYnV0dG9uIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJidXR0b24iIHx8IG5hbWUgPT09ICJidXR0b24iOwoJCX0sCgoJCSJ0ZXh0IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBhdHRyOwoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmCgkJCQllbGVtLnR5cGUgPT09ICJ0ZXh0IiAmJgoKCQkJCS8vIFN1cHBvcnQ6IElFPDgKCQkJCS8vIE5ldyBIVE1MNSBhdHRyaWJ1dGUgdmFsdWVzIChlLmcuLCAic2VhcmNoIikgYXBwZWFyIHdpdGggZWxlbS50eXBlID09PSAidGV4dCIKCQkJCSggKGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpKSA9PSBudWxsIHx8IGF0dHIudG9Mb3dlckNhc2UoKSA9PT0gInRleHQiICk7CgkJfSwKCgkJLy8gUG9zaXRpb24taW4tY29sbGVjdGlvbgoJCSJmaXJzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oKSB7CgkJCXJldHVybiBbIDAgXTsKCQl9KSwKCgkJImxhc3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJcmV0dXJuIFsgbGVuZ3RoIC0gMSBdOwoJCX0pLAoKCQkiZXEiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXJldHVybiBbIGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQgXTsKCQl9KSwKCgkJImV2ZW4iOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJdmFyIGkgPSAwOwoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJIm9kZCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQl2YXIgaSA9IDE7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgewoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKCQkJfQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOwoJCX0pLAoKCQkibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXZhciBpID0gYXJndW1lbnQgPCAwID8KCQkJCWFyZ3VtZW50ICsgbGVuZ3RoIDoKCQkJCWFyZ3VtZW50ID4gbGVuZ3RoID8KCQkJCQlsZW5ndGggOgoJCQkJCWFyZ3VtZW50OwoJCQlmb3IgKCA7IC0taSA+PSAwOyApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJImd0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewoJCQl2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CgkJCWZvciAoIDsgKytpIDwgbGVuZ3RoOyApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KQoJfQp9OwoKRXhwci5wc2V1ZG9zWyJudGgiXSA9IEV4cHIucHNldWRvc1siZXEiXTsKCi8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zCmZvciAoIGkgaW4geyByYWRpbzogdHJ1ZSwgY2hlY2tib3g6IHRydWUsIGZpbGU6IHRydWUsIHBhc3N3b3JkOiB0cnVlLCBpbWFnZTogdHJ1ZSB9ICkgewoJRXhwci5wc2V1ZG9zWyBpIF0gPSBjcmVhdGVJbnB1dFBzZXVkbyggaSApOwp9CmZvciAoIGkgaW4geyBzdWJtaXQ6IHRydWUsIHJlc2V0OiB0cnVlIH0gKSB7CglFeHByLnBzZXVkb3NbIGkgXSA9IGNyZWF0ZUJ1dHRvblBzZXVkbyggaSApOwp9CgovLyBFYXN5IEFQSSBmb3IgY3JlYXRpbmcgbmV3IHNldEZpbHRlcnMKZnVuY3Rpb24gc2V0RmlsdGVycygpIHt9CnNldEZpbHRlcnMucHJvdG90eXBlID0gRXhwci5maWx0ZXJzID0gRXhwci5wc2V1ZG9zOwpFeHByLnNldEZpbHRlcnMgPSBuZXcgc2V0RmlsdGVycygpOwoKdG9rZW5pemUgPSBTaXp6bGUudG9rZW5pemUgPSBmdW5jdGlvbiggc2VsZWN0b3IsIHBhcnNlT25seSApIHsKCXZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLAoJCXNvRmFyLCBncm91cHMsIHByZUZpbHRlcnMsCgkJY2FjaGVkID0gdG9rZW5DYWNoZVsgc2VsZWN0b3IgKyAiICIgXTsKCglpZiAoIGNhY2hlZCApIHsKCQlyZXR1cm4gcGFyc2VPbmx5ID8gMCA6IGNhY2hlZC5zbGljZSggMCApOwoJfQoKCXNvRmFyID0gc2VsZWN0b3I7Cglncm91cHMgPSBbXTsKCXByZUZpbHRlcnMgPSBFeHByLnByZUZpbHRlcjsKCgl3aGlsZSAoIHNvRmFyICkgewoKCQkvLyBDb21tYSBhbmQgZmlyc3QgcnVuCgkJaWYgKCAhbWF0Y2hlZCB8fCAobWF0Y2ggPSByY29tbWEuZXhlYyggc29GYXIgKSkgKSB7CgkJCWlmICggbWF0Y2ggKSB7CgkJCQkvLyBEb24ndCBjb25zdW1lIHRyYWlsaW5nIGNvbW1hcyBhcyB2YWxpZAoJCQkJc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hbMF0ubGVuZ3RoICkgfHwgc29GYXI7CgkJCX0KCQkJZ3JvdXBzLnB1c2goICh0b2tlbnMgPSBbXSkgKTsKCQl9CgoJCW1hdGNoZWQgPSBmYWxzZTsKCgkJLy8gQ29tYmluYXRvcnMKCQlpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKCQkJbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CgkJCXRva2Vucy5wdXNoKHsKCQkJCXZhbHVlOiBtYXRjaGVkLAoJCQkJLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCgkJCQl0eXBlOiBtYXRjaFswXS5yZXBsYWNlKCBydHJpbSwgIiAiICkKCQkJfSk7CgkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJfQoKCQkvLyBGaWx0ZXJzCgkJZm9yICggdHlwZSBpbiBFeHByLmZpbHRlciApIHsKCQkJaWYgKCAobWF0Y2ggPSBtYXRjaEV4cHJbIHR5cGUgXS5leGVjKCBzb0ZhciApKSAmJiAoIXByZUZpbHRlcnNbIHR5cGUgXSB8fAoJCQkJKG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCApKSkgKSB7CgkJCQltYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKCQkJCXRva2Vucy5wdXNoKHsKCQkJCQl2YWx1ZTogbWF0Y2hlZCwKCQkJCQl0eXBlOiB0eXBlLAoJCQkJCW1hdGNoZXM6IG1hdGNoCgkJCQl9KTsKCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJCX0KCQl9CgoJCWlmICggIW1hdGNoZWQgKSB7CgkJCWJyZWFrOwoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIGxlbmd0aCBvZiB0aGUgaW52YWxpZCBleGNlc3MKCS8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwoJLy8gT3RoZXJ3aXNlLCB0aHJvdyBhbiBlcnJvciBvciByZXR1cm4gdG9rZW5zCglyZXR1cm4gcGFyc2VPbmx5ID8KCQlzb0Zhci5sZW5ndGggOgoJCXNvRmFyID8KCQkJU2l6emxlLmVycm9yKCBzZWxlY3RvciApIDoKCQkJLy8gQ2FjaGUgdGhlIHRva2VucwoJCQl0b2tlbkNhY2hlKCBzZWxlY3RvciwgZ3JvdXBzICkuc2xpY2UoIDAgKTsKfTsKCmZ1bmN0aW9uIHRvU2VsZWN0b3IoIHRva2VucyApIHsKCXZhciBpID0gMCwKCQlsZW4gPSB0b2tlbnMubGVuZ3RoLAoJCXNlbGVjdG9yID0gIiI7Cglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlzZWxlY3RvciArPSB0b2tlbnNbaV0udmFsdWU7Cgl9CglyZXR1cm4gc2VsZWN0b3I7Cn0KCmZ1bmN0aW9uIGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UgKSB7Cgl2YXIgZGlyID0gY29tYmluYXRvci5kaXIsCgkJc2tpcCA9IGNvbWJpbmF0b3IubmV4dCwKCQlrZXkgPSBza2lwIHx8IGRpciwKCQljaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBrZXkgPT09ICJwYXJlbnROb2RlIiwKCQlkb25lTmFtZSA9IGRvbmUrKzsKCglyZXR1cm4gY29tYmluYXRvci5maXJzdCA/CgkJLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewoJCQkJCXJldHVybiBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfSA6CgoJCS8vIENoZWNrIGFnYWluc3QgYWxsIGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50cwoJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCXZhciBvbGRDYWNoZSwgdW5pcXVlQ2FjaGUsIG91dGVyQ2FjaGUsCgkJCQluZXdDYWNoZSA9IFsgZGlycnVucywgZG9uZU5hbWUgXTsKCgkJCS8vIFdlIGNhbid0IHNldCBhcmJpdHJhcnkgZGF0YSBvbiBYTUwgbm9kZXMsIHNvIHRoZXkgZG9uJ3QgYmVuZWZpdCBmcm9tIGNvbWJpbmF0b3IgY2FjaGluZwoJCQlpZiAoIHhtbCApIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCW91dGVyQ2FjaGUgPSBlbGVtWyBleHBhbmRvIF0gfHwgKGVsZW1bIGV4cGFuZG8gXSA9IHt9KTsKCgkJCQkJCS8vIFN1cHBvcnQ6IElFIDw5IG9ubHkKCQkJCQkJLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpCgkJCQkJCXVuaXF1ZUNhY2hlID0gb3V0ZXJDYWNoZVsgZWxlbS51bmlxdWVJRCBdIHx8IChvdXRlckNhY2hlWyBlbGVtLnVuaXF1ZUlEIF0gPSB7fSk7CgoJCQkJCQlpZiAoIHNraXAgJiYgc2tpcCA9PT0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICkgewoJCQkJCQkJZWxlbSA9IGVsZW1bIGRpciBdIHx8IGVsZW07CgkJCQkJCX0gZWxzZSBpZiAoIChvbGRDYWNoZSA9IHVuaXF1ZUNhY2hlWyBrZXkgXSkgJiYKCQkJCQkJCW9sZENhY2hlWyAwIF0gPT09IGRpcnJ1bnMgJiYgb2xkQ2FjaGVbIDEgXSA9PT0gZG9uZU5hbWUgKSB7CgoJCQkJCQkJLy8gQXNzaWduIHRvIG5ld0NhY2hlIHNvIHJlc3VsdHMgYmFjay1wcm9wYWdhdGUgdG8gcHJldmlvdXMgZWxlbWVudHMKCQkJCQkJCXJldHVybiAobmV3Q2FjaGVbIDIgXSA9IG9sZENhY2hlWyAyIF0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy8gUmV1c2UgbmV3Y2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwoJCQkJCQkJdW5pcXVlQ2FjaGVbIGtleSBdID0gbmV3Q2FjaGU7CgoJCQkJCQkJLy8gQSBtYXRjaCBtZWFucyB3ZSdyZSBkb25lOyBhIGZhaWwgbWVhbnMgd2UgaGF2ZSB0byBrZWVwIGNoZWNraW5nCgkJCQkJCQlpZiAoIChuZXdDYWNoZVsgMiBdID0gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkpICkgewoJCQkJCQkJCXJldHVybiB0cnVlOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9Owp9CgpmdW5jdGlvbiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSB7CglyZXR1cm4gbWF0Y2hlcnMubGVuZ3RoID4gMSA/CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJdmFyIGkgPSBtYXRjaGVycy5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCAhbWF0Y2hlcnNbaV0oIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IDoKCQltYXRjaGVyc1swXTsKfQoKZnVuY3Rpb24gbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IsIGNvbnRleHRzLCByZXN1bHRzICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IGNvbnRleHRzLmxlbmd0aDsKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCVNpenpsZSggc2VsZWN0b3IsIGNvbnRleHRzW2ldLCByZXN1bHRzICk7Cgl9CglyZXR1cm4gcmVzdWx0czsKfQoKZnVuY3Rpb24gY29uZGVuc2UoIHVubWF0Y2hlZCwgbWFwLCBmaWx0ZXIsIGNvbnRleHQsIHhtbCApIHsKCXZhciBlbGVtLAoJCW5ld1VubWF0Y2hlZCA9IFtdLAoJCWkgPSAwLAoJCWxlbiA9IHVubWF0Y2hlZC5sZW5ndGgsCgkJbWFwcGVkID0gbWFwICE9IG51bGw7CgoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJaWYgKCAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgKSB7CgkJCWlmICggIWZpbHRlciB8fCBmaWx0ZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewoJCQkJbmV3VW5tYXRjaGVkLnB1c2goIGVsZW0gKTsKCQkJCWlmICggbWFwcGVkICkgewoJCQkJCW1hcC5wdXNoKCBpICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIG5ld1VubWF0Y2hlZDsKfQoKZnVuY3Rpb24gc2V0TWF0Y2hlciggcHJlRmlsdGVyLCBzZWxlY3RvciwgbWF0Y2hlciwgcG9zdEZpbHRlciwgcG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yICkgewoJaWYgKCBwb3N0RmlsdGVyICYmICFwb3N0RmlsdGVyWyBleHBhbmRvIF0gKSB7CgkJcG9zdEZpbHRlciA9IHNldE1hdGNoZXIoIHBvc3RGaWx0ZXIgKTsKCX0KCWlmICggcG9zdEZpbmRlciAmJiAhcG9zdEZpbmRlclsgZXhwYW5kbyBdICkgewoJCXBvc3RGaW5kZXIgPSBzZXRNYXRjaGVyKCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKTsKCX0KCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIHJlc3VsdHMsIGNvbnRleHQsIHhtbCApIHsKCQl2YXIgdGVtcCwgaSwgZWxlbSwKCQkJcHJlTWFwID0gW10sCgkJCXBvc3RNYXAgPSBbXSwKCQkJcHJlZXhpc3RpbmcgPSByZXN1bHRzLmxlbmd0aCwKCgkJCS8vIEdldCBpbml0aWFsIGVsZW1lbnRzIGZyb20gc2VlZCBvciBjb250ZXh0CgkJCWVsZW1zID0gc2VlZCB8fCBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciB8fCAiKiIsIGNvbnRleHQubm9kZVR5cGUgPyBbIGNvbnRleHQgXSA6IGNvbnRleHQsIFtdICksCgoJCQkvLyBQcmVmaWx0ZXIgdG8gZ2V0IG1hdGNoZXIgaW5wdXQsIHByZXNlcnZpbmcgYSBtYXAgZm9yIHNlZWQtcmVzdWx0cyBzeW5jaHJvbml6YXRpb24KCQkJbWF0Y2hlckluID0gcHJlRmlsdGVyICYmICggc2VlZCB8fCAhc2VsZWN0b3IgKSA/CgkJCQljb25kZW5zZSggZWxlbXMsIHByZU1hcCwgcHJlRmlsdGVyLCBjb250ZXh0LCB4bWwgKSA6CgkJCQllbGVtcywKCgkJCW1hdGNoZXJPdXQgPSBtYXRjaGVyID8KCQkJCS8vIElmIHdlIGhhdmUgYSBwb3N0RmluZGVyLCBvciBmaWx0ZXJlZCBzZWVkLCBvciBub24tc2VlZCBwb3N0RmlsdGVyIG9yIHByZWV4aXN0aW5nIHJlc3VsdHMsCgkJCQlwb3N0RmluZGVyIHx8ICggc2VlZCA/IHByZUZpbHRlciA6IHByZWV4aXN0aW5nIHx8IHBvc3RGaWx0ZXIgKSA/CgoJCQkJCS8vIC4uLmludGVybWVkaWF0ZSBwcm9jZXNzaW5nIGlzIG5lY2Vzc2FyeQoJCQkJCVtdIDoKCgkJCQkJLy8gLi4ub3RoZXJ3aXNlIHVzZSByZXN1bHRzIGRpcmVjdGx5CgkJCQkJcmVzdWx0cyA6CgkJCQltYXRjaGVySW47CgoJCS8vIEZpbmQgcHJpbWFyeSBtYXRjaGVzCgkJaWYgKCBtYXRjaGVyICkgewoJCQltYXRjaGVyKCBtYXRjaGVySW4sIG1hdGNoZXJPdXQsIGNvbnRleHQsIHhtbCApOwoJCX0KCgkJLy8gQXBwbHkgcG9zdEZpbHRlcgoJCWlmICggcG9zdEZpbHRlciApIHsKCQkJdGVtcCA9IGNvbmRlbnNlKCBtYXRjaGVyT3V0LCBwb3N0TWFwICk7CgkJCXBvc3RGaWx0ZXIoIHRlbXAsIFtdLCBjb250ZXh0LCB4bWwgKTsKCgkJCS8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4KCQkJaSA9IHRlbXAubGVuZ3RoOwoJCQl3aGlsZSAoIGktLSApIHsKCQkJCWlmICggKGVsZW0gPSB0ZW1wW2ldKSApIHsKCQkJCQltYXRjaGVyT3V0WyBwb3N0TWFwW2ldIF0gPSAhKG1hdGNoZXJJblsgcG9zdE1hcFtpXSBdID0gZWxlbSk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggc2VlZCApIHsKCQkJaWYgKCBwb3N0RmluZGVyIHx8IHByZUZpbHRlciApIHsKCQkJCWlmICggcG9zdEZpbmRlciApIHsKCQkJCQkvLyBHZXQgdGhlIGZpbmFsIG1hdGNoZXJPdXQgYnkgY29uZGVuc2luZyB0aGlzIGludGVybWVkaWF0ZSBpbnRvIHBvc3RGaW5kZXIgY29udGV4dHMKCQkJCQl0ZW1wID0gW107CgkJCQkJaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQlpZiAoIChlbGVtID0gbWF0Y2hlck91dFtpXSkgKSB7CgkJCQkJCQkvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAoJCQkJCQkJdGVtcC5wdXNoKCAobWF0Y2hlckluW2ldID0gZWxlbSkgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlwb3N0RmluZGVyKCBudWxsLCAobWF0Y2hlck91dCA9IFtdKSwgdGVtcCwgeG1sICk7CgkJCQl9CgoJCQkJLy8gTW92ZSBtYXRjaGVkIGVsZW1lbnRzIGZyb20gc2VlZCB0byByZXN1bHRzIHRvIGtlZXAgdGhlbSBzeW5jaHJvbml6ZWQKCQkJCWkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsKCQkJCXdoaWxlICggaS0tICkgewoJCQkJCWlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSAmJgoJCQkJCQkodGVtcCA9IHBvc3RGaW5kZXIgPyBpbmRleE9mKCBzZWVkLCBlbGVtICkgOiBwcmVNYXBbaV0pID4gLTEgKSB7CgoJCQkJCQlzZWVkW3RlbXBdID0gIShyZXN1bHRzW3RlbXBdID0gZWxlbSk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEFkZCBlbGVtZW50cyB0byByZXN1bHRzLCB0aHJvdWdoIHBvc3RGaW5kZXIgaWYgZGVmaW5lZAoJCX0gZWxzZSB7CgkJCW1hdGNoZXJPdXQgPSBjb25kZW5zZSgKCQkJCW1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPwoJCQkJCW1hdGNoZXJPdXQuc3BsaWNlKCBwcmVleGlzdGluZywgbWF0Y2hlck91dC5sZW5ndGggKSA6CgkJCQkJbWF0Y2hlck91dAoJCQkpOwoJCQlpZiAoIHBvc3RGaW5kZXIgKSB7CgkJCQlwb3N0RmluZGVyKCBudWxsLCByZXN1bHRzLCBtYXRjaGVyT3V0LCB4bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIG1hdGNoZXJPdXQgKTsKCQkJfQoJCX0KCX0pOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zICkgewoJdmFyIGNoZWNrQ29udGV4dCwgbWF0Y2hlciwgaiwKCQlsZW4gPSB0b2tlbnMubGVuZ3RoLAoJCWxlYWRpbmdSZWxhdGl2ZSA9IEV4cHIucmVsYXRpdmVbIHRva2Vuc1swXS50eXBlIF0sCgkJaW1wbGljaXRSZWxhdGl2ZSA9IGxlYWRpbmdSZWxhdGl2ZSB8fCBFeHByLnJlbGF0aXZlWyIgIl0sCgkJaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLAoKCQkvLyBUaGUgZm91bmRhdGlvbmFsIG1hdGNoZXIgZW5zdXJlcyB0aGF0IGVsZW1lbnRzIGFyZSByZWFjaGFibGUgZnJvbSB0b3AtbGV2ZWwgY29udGV4dChzKQoJCW1hdGNoQ29udGV4dCA9IGFkZENvbWJpbmF0b3IoIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gY2hlY2tDb250ZXh0OwoJCX0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUgKSwKCQltYXRjaEFueUNvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGluZGV4T2YoIGNoZWNrQ29udGV4dCwgZWxlbSApID4gLTE7CgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAoJCW1hdGNoZXJzID0gWyBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgcmV0ID0gKCAhbGVhZGluZ1JlbGF0aXZlICYmICggeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQgKSApIHx8ICgKCQkJCShjaGVja0NvbnRleHQgPSBjb250ZXh0KS5ub2RlVHlwZSA/CgkJCQkJbWF0Y2hDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSA6CgkJCQkJbWF0Y2hBbnlDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSApOwoJCQkvLyBBdm9pZCBoYW5naW5nIG9udG8gZWxlbWVudCAoaXNzdWUgIzI5OSkKCQkJY2hlY2tDb250ZXh0ID0gbnVsbDsKCQkJcmV0dXJuIHJldDsKCQl9IF07CgoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJaWYgKCAobWF0Y2hlciA9IEV4cHIucmVsYXRpdmVbIHRva2Vuc1tpXS50eXBlIF0pICkgewoJCQltYXRjaGVycyA9IFsgYWRkQ29tYmluYXRvcihlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwgbWF0Y2hlcikgXTsKCQl9IGVsc2UgewoJCQltYXRjaGVyID0gRXhwci5maWx0ZXJbIHRva2Vuc1tpXS50eXBlIF0uYXBwbHkoIG51bGwsIHRva2Vuc1tpXS5tYXRjaGVzICk7CgoJCQkvLyBSZXR1cm4gc3BlY2lhbCB1cG9uIHNlZWluZyBhIHBvc2l0aW9uYWwgbWF0Y2hlcgoJCQlpZiAoIG1hdGNoZXJbIGV4cGFuZG8gXSApIHsKCQkJCS8vIEZpbmQgdGhlIG5leHQgcmVsYXRpdmUgb3BlcmF0b3IgKGlmIGFueSkgZm9yIHByb3BlciBoYW5kbGluZwoJCQkJaiA9ICsraTsKCQkJCWZvciAoIDsgaiA8IGxlbjsgaisrICkgewoJCQkJCWlmICggRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2pdLnR5cGUgXSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHNldE1hdGNoZXIoCgkJCQkJaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICksCgkJCQkJaSA+IDEgJiYgdG9TZWxlY3RvcigKCQkJCQkJLy8gSWYgdGhlIHByZWNlZGluZyB0b2tlbiB3YXMgYSBkZXNjZW5kYW50IGNvbWJpbmF0b3IsIGluc2VydCBhbiBpbXBsaWNpdCBhbnktZWxlbWVudCBgKmAKCQkJCQkJdG9rZW5zLnNsaWNlKCAwLCBpIC0gMSApLmNvbmNhdCh7IHZhbHVlOiB0b2tlbnNbIGkgLSAyIF0udHlwZSA9PT0gIiAiID8gIioiIDogIiIgfSkKCQkJCQkpLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksCgkJCQkJbWF0Y2hlciwKCQkJCQlpIDwgaiAmJiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zLnNsaWNlKCBpLCBqICkgKSwKCQkJCQlqIDwgbGVuICYmIG1hdGNoZXJGcm9tVG9rZW5zKCAodG9rZW5zID0gdG9rZW5zLnNsaWNlKCBqICkpICksCgkJCQkJaiA8IGxlbiAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKQoJCQkJKTsKCQkJfQoJCQltYXRjaGVycy5wdXNoKCBtYXRjaGVyICk7CgkJfQoJfQoKCXJldHVybiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKTsKfQoKZnVuY3Rpb24gbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgewoJdmFyIGJ5U2V0ID0gc2V0TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiggc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBvdXRlcm1vc3QgKSB7CgkJCXZhciBlbGVtLCBqLCBtYXRjaGVyLAoJCQkJbWF0Y2hlZENvdW50ID0gMCwKCQkJCWkgPSAiMCIsCgkJCQl1bm1hdGNoZWQgPSBzZWVkICYmIFtdLAoJCQkJc2V0TWF0Y2hlZCA9IFtdLAoJCQkJY29udGV4dEJhY2t1cCA9IG91dGVybW9zdENvbnRleHQsCgkJCQkvLyBXZSBtdXN0IGFsd2F5cyBoYXZlIGVpdGhlciBzZWVkIGVsZW1lbnRzIG9yIG91dGVybW9zdCBjb250ZXh0CgkJCQllbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZFsiVEFHIl0oICIqIiwgb3V0ZXJtb3N0ICksCgkJCQkvLyBVc2UgaW50ZWdlciBkaXJydW5zIGlmZiB0aGlzIGlzIHRoZSBvdXRlcm1vc3QgbWF0Y2hlcgoJCQkJZGlycnVuc1VuaXF1ZSA9IChkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSksCgkJCQlsZW4gPSBlbGVtcy5sZW5ndGg7CgoJCQlpZiAoIG91dGVybW9zdCApIHsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0ID09PSBkb2N1bWVudCB8fCBjb250ZXh0IHx8IG91dGVybW9zdDsKCQkJfQoKCQkJLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMKCQkJLy8gU3VwcG9ydDogSUU8OSwgU2FmYXJpCgkJCS8vIFRvbGVyYXRlIE5vZGVMaXN0IHByb3BlcnRpZXMgKElFOiAibGVuZ3RoIjsgU2FmYXJpOiA8bnVtYmVyPikgbWF0Y2hpbmcgZWxlbWVudHMgYnkgaWQKCQkJZm9yICggOyBpICE9PSBsZW4gJiYgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBieUVsZW1lbnQgJiYgZWxlbSApIHsKCQkJCQlqID0gMDsKCQkJCQlpZiAoICFjb250ZXh0ICYmIGVsZW0ub3duZXJEb2N1bWVudCAhPT0gZG9jdW1lbnQgKSB7CgkJCQkJCXNldERvY3VtZW50KCBlbGVtICk7CgkJCQkJCXhtbCA9ICFkb2N1bWVudElzSFRNTDsKCQkJCQl9CgkJCQkJd2hpbGUgKCAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSApIHsKCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0IHx8IGRvY3VtZW50LCB4bWwpICkgewoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIG91dGVybW9zdCApIHsKCQkJCQkJZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFRyYWNrIHVubWF0Y2hlZCBlbGVtZW50cyBmb3Igc2V0IGZpbHRlcnMKCQkJCWlmICggYnlTZXQgKSB7CgkJCQkJLy8gVGhleSB3aWxsIGhhdmUgZ29uZSB0aHJvdWdoIGFsbCBwb3NzaWJsZSBtYXRjaGVycwoJCQkJCWlmICggKGVsZW0gPSAhbWF0Y2hlciAmJiBlbGVtKSApIHsKCQkJCQkJbWF0Y2hlZENvdW50LS07CgkJCQkJfQoKCQkJCQkvLyBMZW5ndGhlbiB0aGUgYXJyYXkgZm9yIGV2ZXJ5IGVsZW1lbnQsIG1hdGNoZWQgb3Igbm90CgkJCQkJaWYgKCBzZWVkICkgewoJCQkJCQl1bm1hdGNoZWQucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gYGlgIGlzIG5vdyB0aGUgY291bnQgb2YgZWxlbWVudHMgdmlzaXRlZCBhYm92ZSwgYW5kIGFkZGluZyBpdCB0byBgbWF0Y2hlZENvdW50YAoJCQkvLyBtYWtlcyB0aGUgbGF0dGVyIG5vbm5lZ2F0aXZlLgoJCQltYXRjaGVkQ291bnQgKz0gaTsKCgkJCS8vIEFwcGx5IHNldCBmaWx0ZXJzIHRvIHVubWF0Y2hlZCBlbGVtZW50cwoJCQkvLyBOT1RFOiBUaGlzIGNhbiBiZSBza2lwcGVkIGlmIHRoZXJlIGFyZSBubyB1bm1hdGNoZWQgZWxlbWVudHMgKGkuZS4sIGBtYXRjaGVkQ291bnRgCgkJCS8vIGVxdWFscyBgaWApLCB1bmxlc3Mgd2UgZGlkbid0IHZpc2l0IF9hbnlfIGVsZW1lbnRzIGluIHRoZSBhYm92ZSBsb29wIGJlY2F1c2Ugd2UgaGF2ZQoJCQkvLyBubyBlbGVtZW50IG1hdGNoZXJzIGFuZCBubyBzZWVkLgoJCQkvLyBJbmNyZW1lbnRpbmcgYW4gaW5pdGlhbGx5LXN0cmluZyAiMCIgYGlgIGFsbG93cyBgaWAgdG8gcmVtYWluIGEgc3RyaW5nIG9ubHkgaW4gdGhhdAoJCQkvLyBjYXNlLCB3aGljaCB3aWxsIHJlc3VsdCBpbiBhICIwMCIgYG1hdGNoZWRDb3VudGAgdGhhdCBkaWZmZXJzIGZyb20gYGlgIGJ1dCBpcyBhbHNvCgkJCS8vIG51bWVyaWNhbGx5IHplcm8uCgkJCWlmICggYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50ICkgewoJCQkJaiA9IDA7CgkJCQl3aGlsZSAoIChtYXRjaGVyID0gc2V0TWF0Y2hlcnNbaisrXSkgKSB7CgkJCQkJbWF0Y2hlciggdW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCgkJCQlpZiAoIHNlZWQgKSB7CgkJCQkJLy8gUmVpbnRlZ3JhdGUgZWxlbWVudCBtYXRjaGVzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3Igc29ydGluZwoJCQkJCWlmICggbWF0Y2hlZENvdW50ID4gMCApIHsKCQkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCQlpZiAoICEodW5tYXRjaGVkW2ldIHx8IHNldE1hdGNoZWRbaV0pICkgewoJCQkJCQkJCXNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbCggcmVzdWx0cyApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBEaXNjYXJkIGluZGV4IHBsYWNlaG9sZGVyIHZhbHVlcyB0byBnZXQgb25seSBhY3R1YWwgbWF0Y2hlcwoJCQkJCXNldE1hdGNoZWQgPSBjb25kZW5zZSggc2V0TWF0Y2hlZCApOwoJCQkJfQoKCQkJCS8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNldE1hdGNoZWQgKTsKCgkJCQkvLyBTZWVkbGVzcyBzZXQgbWF0Y2hlcyBzdWNjZWVkaW5nIG11bHRpcGxlIHN1Y2Nlc3NmdWwgbWF0Y2hlcnMgc3RpcHVsYXRlIHNvcnRpbmcKCQkJCWlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJgoJCQkJCSggbWF0Y2hlZENvdW50ICsgc2V0TWF0Y2hlcnMubGVuZ3RoICkgPiAxICkgewoKCQkJCQlTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOwoJCQkJfQoJCQl9CgoJCQkvLyBPdmVycmlkZSBtYW5pcHVsYXRpb24gb2YgZ2xvYmFscyBieSBuZXN0ZWQgbWF0Y2hlcnMKCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQlkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0QmFja3VwOwoJCQl9CgoJCQlyZXR1cm4gdW5tYXRjaGVkOwoJCX07CgoJcmV0dXJuIGJ5U2V0ID8KCQltYXJrRnVuY3Rpb24oIHN1cGVyTWF0Y2hlciApIDoKCQlzdXBlck1hdGNoZXI7Cn0KCmNvbXBpbGUgPSBTaXp6bGUuY29tcGlsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgbWF0Y2ggLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7Cgl2YXIgaSwKCQlzZXRNYXRjaGVycyA9IFtdLAoJCWVsZW1lbnRNYXRjaGVycyA9IFtdLAoJCWNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgoJaWYgKCAhY2FjaGVkICkgewoJCS8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAoJCWlmICggIW1hdGNoICkgewoJCQltYXRjaCA9IHRva2VuaXplKCBzZWxlY3RvciApOwoJCX0KCQlpID0gbWF0Y2gubGVuZ3RoOwoJCXdoaWxlICggaS0tICkgewoJCQljYWNoZWQgPSBtYXRjaGVyRnJvbVRva2VucyggbWF0Y2hbaV0gKTsKCQkJaWYgKCBjYWNoZWRbIGV4cGFuZG8gXSApIHsKCQkJCXNldE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9CgkJfQoKCQkvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24KCQljYWNoZWQgPSBjb21waWxlckNhY2hlKCBzZWxlY3RvciwgbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgKTsKCgkJLy8gU2F2ZSBzZWxlY3RvciBhbmQgdG9rZW5pemF0aW9uCgkJY2FjaGVkLnNlbGVjdG9yID0gc2VsZWN0b3I7Cgl9CglyZXR1cm4gY2FjaGVkOwp9OwoKLyoqCiAqIEEgbG93LWxldmVsIHNlbGVjdGlvbiBmdW5jdGlvbiB0aGF0IHdvcmtzIHdpdGggU2l6emxlJ3MgY29tcGlsZWQKICogIHNlbGVjdG9yIGZ1bmN0aW9ucwogKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gc2VsZWN0b3IgQSBzZWxlY3RvciBvciBhIHByZS1jb21waWxlZAogKiAgc2VsZWN0b3IgZnVuY3Rpb24gYnVpbHQgd2l0aCBTaXp6bGUuY29tcGlsZQogKiBAcGFyYW0ge0VsZW1lbnR9IGNvbnRleHQKICogQHBhcmFtIHtBcnJheX0gW3Jlc3VsdHNdCiAqIEBwYXJhbSB7QXJyYXl9IFtzZWVkXSBBIHNldCBvZiBlbGVtZW50cyB0byBtYXRjaCBhZ2FpbnN0CiAqLwpzZWxlY3QgPSBTaXp6bGUuc2VsZWN0ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgewoJdmFyIGksIHRva2VucywgdG9rZW4sIHR5cGUsIGZpbmQsCgkJY29tcGlsZWQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIgJiYgc2VsZWN0b3IsCgkJbWF0Y2ggPSAhc2VlZCAmJiB0b2tlbml6ZSggKHNlbGVjdG9yID0gY29tcGlsZWQuc2VsZWN0b3IgfHwgc2VsZWN0b3IpICk7CgoJcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CgoJLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgb25seSBvbmUgc2VsZWN0b3IgaW4gdGhlIGxpc3QgYW5kIG5vIHNlZWQKCS8vICh0aGUgbGF0dGVyIG9mIHdoaWNoIGd1YXJhbnRlZXMgdXMgY29udGV4dCkKCWlmICggbWF0Y2gubGVuZ3RoID09PSAxICkgewoKCQkvLyBSZWR1Y2UgY29udGV4dCBpZiB0aGUgbGVhZGluZyBjb21wb3VuZCBzZWxlY3RvciBpcyBhbiBJRAoJCXRva2VucyA9IG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAgKTsKCQlpZiAoIHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gIklEIiAmJgoJCQkJY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiBkb2N1bWVudElzSFRNTCAmJiBFeHByLnJlbGF0aXZlWyB0b2tlbnNbMV0udHlwZSBdICkgewoKCQkJY29udGV4dCA9ICggRXhwci5maW5kWyJJRCJdKCB0b2tlbi5tYXRjaGVzWzBdLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLCBjb250ZXh0ICkgfHwgW10gKVswXTsKCQkJaWYgKCAhY29udGV4dCApIHsKCQkJCXJldHVybiByZXN1bHRzOwoKCQkJLy8gUHJlY29tcGlsZWQgbWF0Y2hlcnMgd2lsbCBzdGlsbCB2ZXJpZnkgYW5jZXN0cnksIHNvIHN0ZXAgdXAgYSBsZXZlbAoJCQl9IGVsc2UgaWYgKCBjb21waWxlZCApIHsKCQkJCWNvbnRleHQgPSBjb250ZXh0LnBhcmVudE5vZGU7CgkJCX0KCgkJCXNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UoIHRva2Vucy5zaGlmdCgpLnZhbHVlLmxlbmd0aCApOwoJCX0KCgkJLy8gRmV0Y2ggYSBzZWVkIHNldCBmb3IgcmlnaHQtdG8tbGVmdCBtYXRjaGluZwoJCWkgPSBtYXRjaEV4cHJbIm5lZWRzQ29udGV4dCJdLnRlc3QoIHNlbGVjdG9yICkgPyAwIDogdG9rZW5zLmxlbmd0aDsKCQl3aGlsZSAoIGktLSApIHsKCQkJdG9rZW4gPSB0b2tlbnNbaV07CgoJCQkvLyBBYm9ydCBpZiB3ZSBoaXQgYSBjb21iaW5hdG9yCgkJCWlmICggRXhwci5yZWxhdGl2ZVsgKHR5cGUgPSB0b2tlbi50eXBlKSBdICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJaWYgKCAoZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdKSApIHsKCQkJCS8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwoJCQkJaWYgKCAoc2VlZCA9IGZpbmQoCgkJCQkJdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLAoJCQkJCXJzaWJsaW5nLnRlc3QoIHRva2Vuc1swXS50eXBlICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8IGNvbnRleHQKCQkJCSkpICkgewoKCQkJCQkvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKCQkJCQl0b2tlbnMuc3BsaWNlKCBpLCAxICk7CgkJCQkJc2VsZWN0b3IgPSBzZWVkLmxlbmd0aCAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKTsKCQkJCQlpZiAoICFzZWxlY3RvciApIHsKCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2VlZCApOwoJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQl9CgoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIENvbXBpbGUgYW5kIGV4ZWN1dGUgYSBmaWx0ZXJpbmcgZnVuY3Rpb24gaWYgb25lIGlzIG5vdCBwcm92aWRlZAoJLy8gUHJvdmlkZSBgbWF0Y2hgIHRvIGF2b2lkIHJldG9rZW5pemF0aW9uIGlmIHdlIG1vZGlmaWVkIHRoZSBzZWxlY3RvciBhYm92ZQoJKCBjb21waWxlZCB8fCBjb21waWxlKCBzZWxlY3RvciwgbWF0Y2ggKSApKAoJCXNlZWQsCgkJY29udGV4dCwKCQkhZG9jdW1lbnRJc0hUTUwsCgkJcmVzdWx0cywKCQkhY29udGV4dCB8fCByc2libGluZy50ZXN0KCBzZWxlY3RvciApICYmIHRlc3RDb250ZXh0KCBjb250ZXh0LnBhcmVudE5vZGUgKSB8fCBjb250ZXh0CgkpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovLyBPbmUtdGltZSBhc3NpZ25tZW50cwoKLy8gU29ydCBzdGFiaWxpdHkKc3VwcG9ydC5zb3J0U3RhYmxlID0gZXhwYW5kby5zcGxpdCgiIikuc29ydCggc29ydE9yZGVyICkuam9pbigiIikgPT09IGV4cGFuZG87CgovLyBTdXBwb3J0OiBDaHJvbWUgMTQtMzUrCi8vIEFsd2F5cyBhc3N1bWUgZHVwbGljYXRlcyBpZiB0aGV5IGFyZW4ndCBwYXNzZWQgdG8gdGhlIGNvbXBhcmlzb24gZnVuY3Rpb24Kc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzID0gISFoYXNEdXBsaWNhdGU7CgovLyBJbml0aWFsaXplIGFnYWluc3QgdGhlIGRlZmF1bHQgZG9jdW1lbnQKc2V0RG9jdW1lbnQoKTsKCi8vIFN1cHBvcnQ6IFdlYmtpdDw1MzcuMzIgLSBTYWZhcmkgNi4wLjMvQ2hyb21lIDI1IChmaXhlZCBpbiBDaHJvbWUgMjcpCi8vIERldGFjaGVkIG5vZGVzIGNvbmZvdW5kaW5nbHkgZm9sbG93ICplYWNoIG90aGVyKgpzdXBwb3J0LnNvcnREZXRhY2hlZCA9IGFzc2VydChmdW5jdGlvbiggZWwgKSB7CgkvLyBTaG91bGQgcmV0dXJuIDEsIGJ1dCByZXR1cm5zIDQgKGZvbGxvd2luZykKCXJldHVybiBlbC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZmllbGRzZXQiKSApICYgMTsKfSk7CgovLyBTdXBwb3J0OiBJRTw4Ci8vIFByZXZlbnQgYXR0cmlidXRlL3Byb3BlcnR5ICJpbnRlcnBvbGF0aW9uIgovLyBodHRwczovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTM2NDI5JTI4VlMuODUlMjkuYXNweAppZiAoICFhc3NlcnQoZnVuY3Rpb24oIGVsICkgewoJZWwuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwoJcmV0dXJuIGVsLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIjIiA7Cn0pICkgewoJYWRkSGFuZGxlKCAidHlwZXxocmVmfGhlaWdodHx3aWR0aCIsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQlpZiAoICFpc1hNTCApIHsKCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJ0eXBlIiA/IDEgOiAyICk7CgkJfQoJfSk7Cn0KCi8vIFN1cHBvcnQ6IElFPDkKLy8gVXNlIGRlZmF1bHRWYWx1ZSBpbiBwbGFjZSBvZiBnZXRBdHRyaWJ1dGUoInZhbHVlIikKaWYgKCAhc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFhc3NlcnQoZnVuY3Rpb24oIGVsICkgewoJZWwuaW5uZXJIVE1MID0gIjxpbnB1dC8+IjsKCWVsLmZpcnN0Q2hpbGQuc2V0QXR0cmlidXRlKCAidmFsdWUiLCAiIiApOwoJcmV0dXJuIGVsLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOwp9KSApIHsKCWFkZEhhbmRsZSggInZhbHVlIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiApIHsKCQkJcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOwoJCX0KCX0pOwp9CgovLyBTdXBwb3J0OiBJRTw5Ci8vIFVzZSBnZXRBdHRyaWJ1dGVOb2RlIHRvIGZldGNoIGJvb2xlYW5zIHdoZW4gZ2V0QXR0cmlidXRlIGxpZXMKaWYgKCAhYXNzZXJ0KGZ1bmN0aW9uKCBlbCApIHsKCXJldHVybiBlbC5nZXRBdHRyaWJ1dGUoImRpc2FibGVkIikgPT0gbnVsbDsKfSkgKSB7CglhZGRIYW5kbGUoIGJvb2xlYW5zLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJdmFyIHZhbDsKCQlpZiAoICFpc1hNTCApIHsKCQkJcmV0dXJuIGVsZW1bIG5hbWUgXSA9PT0gdHJ1ZSA/IG5hbWUudG9Mb3dlckNhc2UoKSA6CgkJCQkJKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCQl2YWwudmFsdWUgOgoJCQkJbnVsbDsKCQl9Cgl9KTsKfQoKcmV0dXJuIFNpenpsZTsKCn0pKCB3aW5kb3cgKTsKCgoKalF1ZXJ5LmZpbmQgPSBTaXp6bGU7CmpRdWVyeS5leHByID0gU2l6emxlLnNlbGVjdG9yczsKCi8vIERlcHJlY2F0ZWQKalF1ZXJ5LmV4cHJbICI6IiBdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZVNvcnQgPSBqUXVlcnkudW5pcXVlID0gU2l6emxlLnVuaXF1ZVNvcnQ7CmpRdWVyeS50ZXh0ID0gU2l6emxlLmdldFRleHQ7CmpRdWVyeS5pc1hNTERvYyA9IFNpenpsZS5pc1hNTDsKalF1ZXJ5LmNvbnRhaW5zID0gU2l6emxlLmNvbnRhaW5zOwpqUXVlcnkuZXNjYXBlU2VsZWN0b3IgPSBTaXp6bGUuZXNjYXBlOwoKCgoKdmFyIGRpciA9IGZ1bmN0aW9uKCBlbGVtLCBkaXIsIHVudGlsICkgewoJdmFyIG1hdGNoZWQgPSBbXSwKCQl0cnVuY2F0ZSA9IHVudGlsICE9PSB1bmRlZmluZWQ7CgoJd2hpbGUgKCAoIGVsZW0gPSBlbGVtWyBkaXIgXSApICYmIGVsZW0ubm9kZVR5cGUgIT09IDkgKSB7CgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQlpZiAoIHRydW5jYXRlICYmIGpRdWVyeSggZWxlbSApLmlzKCB1bnRpbCApICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJbWF0Y2hlZC5wdXNoKCBlbGVtICk7CgkJfQoJfQoJcmV0dXJuIG1hdGNoZWQ7Cn07CgoKdmFyIHNpYmxpbmdzID0gZnVuY3Rpb24oIG4sIGVsZW0gKSB7Cgl2YXIgbWF0Y2hlZCA9IFtdOwoKCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKSB7CgkJaWYgKCBuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0gKSB7CgkJCW1hdGNoZWQucHVzaCggbiApOwoJCX0KCX0KCglyZXR1cm4gbWF0Y2hlZDsKfTsKCgp2YXIgcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dDsKCgoKZnVuY3Rpb24gbm9kZU5hbWUoIGVsZW0sIG5hbWUgKSB7CgogIHJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwoKfTsKdmFyIHJzaW5nbGVUYWcgPSAoIC9ePChbYS16XVteXC9cMD46XHgyMFx0XHJcblxmXSopW1x4MjBcdFxyXG5cZl0qXC8/Pig/OjxcL1wxPnwpJC9pICk7CgoKCi8vIEltcGxlbWVudCB0aGUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGZpbHRlciBhbmQgbm90CmZ1bmN0aW9uIHdpbm5vdyggZWxlbWVudHMsIHF1YWxpZmllciwgbm90ICkgewoJaWYgKCBpc0Z1bmN0aW9uKCBxdWFsaWZpZXIgKSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoIGVsZW0sIGksIGVsZW0gKSAhPT0gbm90OwoJCX0gKTsKCX0KCgkvLyBTaW5nbGUgZWxlbWVudAoJaWYgKCBxdWFsaWZpZXIubm9kZVR5cGUgKSB7CgkJcmV0dXJuIGpRdWVyeS5ncmVwKCBlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApICE9PSBub3Q7CgkJfSApOwoJfQoKCS8vIEFycmF5bGlrZSBvZiBlbGVtZW50cyAoalF1ZXJ5LCBhcmd1bWVudHMsIEFycmF5KQoJaWYgKCB0eXBlb2YgcXVhbGlmaWVyICE9PSAic3RyaW5nIiApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICggaW5kZXhPZi5jYWxsKCBxdWFsaWZpZXIsIGVsZW0gKSA+IC0xICkgIT09IG5vdDsKCQl9ICk7Cgl9CgoJLy8gRmlsdGVyZWQgZGlyZWN0bHkgZm9yIGJvdGggc2ltcGxlIGFuZCBjb21wbGV4IHNlbGVjdG9ycwoJcmV0dXJuIGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZWxlbWVudHMsIG5vdCApOwp9CgpqUXVlcnkuZmlsdGVyID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1zLCBub3QgKSB7Cgl2YXIgZWxlbSA9IGVsZW1zWyAwIF07CgoJaWYgKCBub3QgKSB7CgkJZXhwciA9ICI6bm90KCIgKyBleHByICsgIikiOwoJfQoKCWlmICggZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJcmV0dXJuIGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvciggZWxlbSwgZXhwciApID8gWyBlbGVtIF0gOiBbXTsKCX0KCglyZXR1cm4galF1ZXJ5LmZpbmQubWF0Y2hlcyggZXhwciwgalF1ZXJ5LmdyZXAoIGVsZW1zLCBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKCX0gKSApOwp9OwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBpLCByZXQsCgkJCWxlbiA9IHRoaXMubGVuZ3RoLAoJCQlzZWxmID0gdGhpczsKCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeSggc2VsZWN0b3IgKS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggc2VsZlsgaSBdLCB0aGlzICkgKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJfSApICk7CgkJfQoKCQlyZXQgPSB0aGlzLnB1c2hTdGFjayggW10gKTsKCgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJalF1ZXJ5LmZpbmQoIHNlbGVjdG9yLCBzZWxmWyBpIF0sIHJldCApOwoJCX0KCgkJcmV0dXJuIGxlbiA+IDEgPyBqUXVlcnkudW5pcXVlU29ydCggcmV0ICkgOiByZXQ7Cgl9LAoJZmlsdGVyOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3coIHRoaXMsIHNlbGVjdG9yIHx8IFtdLCBmYWxzZSApICk7Cgl9LAoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3coIHRoaXMsIHNlbGVjdG9yIHx8IFtdLCB0cnVlICkgKTsKCX0sCglpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiAhIXdpbm5vdygKCQkJdGhpcywKCgkJCS8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsL3JlbGF0aXZlIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQKCQkJLy8gc28gJCgicDpmaXJzdCIpLmlzKCJwOmxhc3QiKSB3b24ndCByZXR1cm4gdHJ1ZSBmb3IgYSBkb2Mgd2l0aCB0d28gInAiLgoJCQl0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICYmIHJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSA/CgkJCQlqUXVlcnkoIHNlbGVjdG9yICkgOgoJCQkJc2VsZWN0b3IgfHwgW10sCgkJCWZhbHNlCgkJKS5sZW5ndGg7Cgl9Cn0gKTsKCgovLyBJbml0aWFsaXplIGEgalF1ZXJ5IG9iamVjdAoKCi8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQp2YXIgcm9vdGpRdWVyeSwKCgkvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwoJLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQoJLy8gU3RyaWN0IEhUTUwgcmVjb2duaXRpb24gKCMxMTI5MDogbXVzdCBzdGFydCB3aXRoIDwpCgkvLyBTaG9ydGN1dCBzaW1wbGUgI2lkIGNhc2UgZm9yIHNwZWVkCglycXVpY2tFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0rKSkkLywKCglpbml0ID0galF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJvb3QgKSB7CgkJdmFyIG1hdGNoLCBlbGVtOwoKCQkvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gTWV0aG9kIGluaXQoKSBhY2NlcHRzIGFuIGFsdGVybmF0ZSByb290alF1ZXJ5CgkJLy8gc28gbWlncmF0ZSBjYW4gc3VwcG9ydCBqUXVlcnkuc3ViIChnaC0yMTAxKQoJCXJvb3QgPSByb290IHx8IHJvb3RqUXVlcnk7CgoJCS8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKCQlpZiAoIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCWlmICggc2VsZWN0b3JbIDAgXSA9PT0gIjwiICYmCgkJCQlzZWxlY3Rvclsgc2VsZWN0b3IubGVuZ3RoIC0gMSBdID09PSAiPiIgJiYKCQkJCXNlbGVjdG9yLmxlbmd0aCA+PSAzICkgewoKCQkJCS8vIEFzc3VtZSB0aGF0IHN0cmluZ3MgdGhhdCBzdGFydCBhbmQgZW5kIHdpdGggPD4gYXJlIEhUTUwgYW5kIHNraXAgdGhlIHJlZ2V4IGNoZWNrCgkJCQltYXRjaCA9IFsgbnVsbCwgc2VsZWN0b3IsIG51bGwgXTsKCgkJCX0gZWxzZSB7CgkJCQltYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKTsKCQkJfQoKCQkJLy8gTWF0Y2ggaHRtbCBvciBtYWtlIHN1cmUgbm8gY29udGV4dCBpcyBzcGVjaWZpZWQgZm9yICNpZAoJCQlpZiAoIG1hdGNoICYmICggbWF0Y2hbIDEgXSB8fCAhY29udGV4dCApICkgewoKCQkJCS8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQoJCQkJaWYgKCBtYXRjaFsgMSBdICkgewoJCQkJCWNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFsgMCBdIDogY29udGV4dDsKCgkJCQkJLy8gT3B0aW9uIHRvIHJ1biBzY3JpcHRzIGlzIHRydWUgZm9yIGJhY2stY29tcGF0CgkJCQkJLy8gSW50ZW50aW9uYWxseSBsZXQgdGhlIGVycm9yIGJlIHRocm93biBpZiBwYXJzZUhUTUwgaXMgbm90IHByZXNlbnQKCQkJCQlqUXVlcnkubWVyZ2UoIHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwoCgkJCQkJCW1hdGNoWyAxIF0sCgkJCQkJCWNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsCgkJCQkJCXRydWUKCQkJCQkpICk7CgoJCQkJCS8vIEhBTkRMRTogJChodG1sLCBwcm9wcykKCQkJCQlpZiAoIHJzaW5nbGVUYWcudGVzdCggbWF0Y2hbIDEgXSApICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KCBjb250ZXh0ICkgKSB7CgkJCQkJCWZvciAoIG1hdGNoIGluIGNvbnRleHQgKSB7CgoJCQkJCQkJLy8gUHJvcGVydGllcyBvZiBjb250ZXh0IGFyZSBjYWxsZWQgYXMgbWV0aG9kcyBpZiBwb3NzaWJsZQoJCQkJCQkJaWYgKCBpc0Z1bmN0aW9uKCB0aGlzWyBtYXRjaCBdICkgKSB7CgkJCQkJCQkJdGhpc1sgbWF0Y2ggXSggY29udGV4dFsgbWF0Y2ggXSApOwoKCQkJCQkJCS8vIC4uLmFuZCBvdGhlcndpc2Ugc2V0IGFzIGF0dHJpYnV0ZXMKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJdGhpcy5hdHRyKCBtYXRjaCwgY29udGV4dFsgbWF0Y2ggXSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQlyZXR1cm4gdGhpczsKCgkJCQkvLyBIQU5ETEU6ICQoI2lkKQoJCQkJfSBlbHNlIHsKCQkJCQllbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG1hdGNoWyAyIF0gKTsKCgkJCQkJaWYgKCBlbGVtICkgewoKCQkJCQkJLy8gSW5qZWN0IHRoZSBlbGVtZW50IGRpcmVjdGx5IGludG8gdGhlIGpRdWVyeSBvYmplY3QKCQkJCQkJdGhpc1sgMCBdID0gZWxlbTsKCQkJCQkJdGhpcy5sZW5ndGggPSAxOwoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCgkJCS8vIEhBTkRMRTogJChleHByLCAkKC4uLikpCgkJCX0gZWxzZSBpZiAoICFjb250ZXh0IHx8IGNvbnRleHQuanF1ZXJ5ICkgewoJCQkJcmV0dXJuICggY29udGV4dCB8fCByb290ICkuZmluZCggc2VsZWN0b3IgKTsKCgkJCS8vIEhBTkRMRTogJChleHByLCBjb250ZXh0KQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKCQkJfSBlbHNlIHsKCQkJCXJldHVybiB0aGlzLmNvbnN0cnVjdG9yKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKTsKCQkJfQoKCQkvLyBIQU5ETEU6ICQoRE9NRWxlbWVudCkKCQl9IGVsc2UgaWYgKCBzZWxlY3Rvci5ub2RlVHlwZSApIHsKCQkJdGhpc1sgMCBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBpc0Z1bmN0aW9uKCBzZWxlY3RvciApICkgewoJCQlyZXR1cm4gcm9vdC5yZWFkeSAhPT0gdW5kZWZpbmVkID8KCQkJCXJvb3QucmVhZHkoIHNlbGVjdG9yICkgOgoKCQkJCS8vIEV4ZWN1dGUgaW1tZWRpYXRlbHkgaWYgcmVhZHkgaXMgbm90IHByZXNlbnQKCQkJCXNlbGVjdG9yKCBqUXVlcnkgKTsKCQl9CgoJCXJldHVybiBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciwgdGhpcyApOwoJfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KaW5pdC5wcm90b3R5cGUgPSBqUXVlcnkuZm47CgovLyBJbml0aWFsaXplIGNlbnRyYWwgcmVmZXJlbmNlCnJvb3RqUXVlcnkgPSBqUXVlcnkoIGRvY3VtZW50ICk7CgoKdmFyIHJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAoKCS8vIE1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0CglndWFyYW50ZWVkVW5pcXVlID0gewoJCWNoaWxkcmVuOiB0cnVlLAoJCWNvbnRlbnRzOiB0cnVlLAoJCW5leHQ6IHRydWUsCgkJcHJldjogdHJ1ZQoJfTsKCmpRdWVyeS5mbi5leHRlbmQoIHsKCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgdGFyZ2V0cyA9IGpRdWVyeSggdGFyZ2V0LCB0aGlzICksCgkJCWwgPSB0YXJnZXRzLmxlbmd0aDsKCgkJcmV0dXJuIHRoaXMuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJdmFyIGkgPSAwOwoJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggdGhpcywgdGFyZ2V0c1sgaSBdICkgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQl9ICk7Cgl9LAoKCWNsb3Nlc3Q6IGZ1bmN0aW9uKCBzZWxlY3RvcnMsIGNvbnRleHQgKSB7CgkJdmFyIGN1ciwKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aCwKCQkJbWF0Y2hlZCA9IFtdLAoJCQl0YXJnZXRzID0gdHlwZW9mIHNlbGVjdG9ycyAhPT0gInN0cmluZyIgJiYgalF1ZXJ5KCBzZWxlY3RvcnMgKTsKCgkJLy8gUG9zaXRpb25hbCBzZWxlY3RvcnMgbmV2ZXIgbWF0Y2gsIHNpbmNlIHRoZXJlJ3Mgbm8gX3NlbGVjdGlvbl8gY29udGV4dAoJCWlmICggIXJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3JzICkgKSB7CgkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCWZvciAoIGN1ciA9IHRoaXNbIGkgXTsgY3VyICYmIGN1ciAhPT0gY29udGV4dDsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7CgoJCQkJCS8vIEFsd2F5cyBza2lwIGRvY3VtZW50IGZyYWdtZW50cwoJCQkJCWlmICggY3VyLm5vZGVUeXBlIDwgMTEgJiYgKCB0YXJnZXRzID8KCQkJCQkJdGFyZ2V0cy5pbmRleCggY3VyICkgPiAtMSA6CgoJCQkJCQkvLyBEb24ndCBwYXNzIG5vbi1lbGVtZW50cyB0byBTaXp6bGUKCQkJCQkJY3VyLm5vZGVUeXBlID09PSAxICYmCgkJCQkJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoIGN1ciwgc2VsZWN0b3JzICkgKSApIHsKCgkJCQkJCW1hdGNoZWQucHVzaCggY3VyICk7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBtYXRjaGVkLmxlbmd0aCA+IDEgPyBqUXVlcnkudW5pcXVlU29ydCggbWF0Y2hlZCApIDogbWF0Y2hlZCApOwoJfSwKCgkvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluIHRoZSBzZXQKCWluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsKCgkJLy8gTm8gYXJndW1lbnQsIHJldHVybiBpbmRleCBpbiBwYXJlbnQKCQlpZiAoICFlbGVtICkgewoJCQlyZXR1cm4gKCB0aGlzWyAwIF0gJiYgdGhpc1sgMCBdLnBhcmVudE5vZGUgKSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CgkJfQoKCQkvLyBJbmRleCBpbiBzZWxlY3RvcgoJCWlmICggdHlwZW9mIGVsZW0gPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gaW5kZXhPZi5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdGhpc1sgMCBdICk7CgkJfQoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4gaW5kZXhPZi5jYWxsKCB0aGlzLAoKCQkJLy8gSWYgaXQgcmVjZWl2ZXMgYSBqUXVlcnkgb2JqZWN0LCB0aGUgZmlyc3QgZWxlbWVudCBpcyB1c2VkCgkJCWVsZW0uanF1ZXJ5ID8gZWxlbVsgMCBdIDogZWxlbQoJCSk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjaygKCQkJalF1ZXJ5LnVuaXF1ZVNvcnQoCgkJCQlqUXVlcnkubWVyZ2UoIHRoaXMuZ2V0KCksIGpRdWVyeSggc2VsZWN0b3IsIGNvbnRleHQgKSApCgkJCSkKCQkpOwoJfSwKCglhZGRCYWNrOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Cn0gKTsKCmZ1bmN0aW9uIHNpYmxpbmcoIGN1ciwgZGlyICkgewoJd2hpbGUgKCAoIGN1ciA9IGN1clsgZGlyIF0gKSAmJiBjdXIubm9kZVR5cGUgIT09IDEgKSB7fQoJcmV0dXJuIGN1cjsKfQoKalF1ZXJ5LmVhY2goIHsKCXBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQlyZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwoJfSwKCXBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBkaXIoIGVsZW0sICJwYXJlbnROb2RlIiApOwoJfSwKCXBhcmVudHNVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBkaXIoIGVsZW0sICJwYXJlbnROb2RlIiwgdW50aWwgKTsKCX0sCgluZXh0OiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gc2libGluZyggZWxlbSwgIm5leHRTaWJsaW5nIiApOwoJfSwKCXByZXY6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBkaXIoIGVsZW0sICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBkaXIoIGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsICk7Cgl9LAoJcHJldlVudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CgkJcmV0dXJuIGRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsICk7Cgl9LAoJc2libGluZ3M6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5ncyggKCBlbGVtLnBhcmVudE5vZGUgfHwge30gKS5maXJzdENoaWxkLCBlbGVtICk7Cgl9LAoJY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5ncyggZWxlbS5maXJzdENoaWxkICk7Cgl9LAoJY29udGVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCWlmICggdHlwZW9mIGVsZW0uY29udGVudERvY3VtZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmV0dXJuIGVsZW0uY29udGVudERvY3VtZW50OwoJCX0KCgkJLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHksIGlPUyA3IG9ubHksIEFuZHJvaWQgQnJvd3NlciA8PTQuMyBvbmx5CgkJLy8gVHJlYXQgdGhlIHRlbXBsYXRlIGVsZW1lbnQgYXMgYSByZWd1bGFyIG9uZSBpbiBicm93c2VycyB0aGF0CgkJLy8gZG9uJ3Qgc3VwcG9ydCBpdC4KCQlpZiAoIG5vZGVOYW1lKCBlbGVtLCAidGVtcGxhdGUiICkgKSB7CgkJCWVsZW0gPSBlbGVtLmNvbnRlbnQgfHwgZWxlbTsKCQl9CgoJCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmNoaWxkTm9kZXMgKTsKCX0KfSwgZnVuY3Rpb24oIG5hbWUsIGZuICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggdW50aWwsIHNlbGVjdG9yICkgewoJCXZhciBtYXRjaGVkID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgoJCWlmICggbmFtZS5zbGljZSggLTUgKSAhPT0gIlVudGlsIiApIHsKCQkJc2VsZWN0b3IgPSB1bnRpbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJbWF0Y2hlZCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCBtYXRjaGVkICk7CgkJfQoKCQlpZiAoIHRoaXMubGVuZ3RoID4gMSApIHsKCgkJCS8vIFJlbW92ZSBkdXBsaWNhdGVzCgkJCWlmICggIWd1YXJhbnRlZWRVbmlxdWVbIG5hbWUgXSApIHsKCQkJCWpRdWVyeS51bmlxdWVTb3J0KCBtYXRjaGVkICk7CgkJCX0KCgkJCS8vIFJldmVyc2Ugb3JkZXIgZm9yIHBhcmVudHMqIGFuZCBwcmV2LWRlcml2YXRpdmVzCgkJCWlmICggcnBhcmVudHNwcmV2LnRlc3QoIG5hbWUgKSApIHsKCQkJCW1hdGNoZWQucmV2ZXJzZSgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIG1hdGNoZWQgKTsKCX07Cn0gKTsKdmFyIHJub3RodG1sd2hpdGUgPSAoIC9bXlx4MjBcdFxyXG5cZl0rL2cgKTsKCgoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMKZnVuY3Rpb24gY3JlYXRlT3B0aW9ucyggb3B0aW9ucyApIHsKCXZhciBvYmplY3QgPSB7fTsKCWpRdWVyeS5lYWNoKCBvcHRpb25zLm1hdGNoKCBybm90aHRtbHdoaXRlICkgfHwgW10sIGZ1bmN0aW9uKCBfLCBmbGFnICkgewoJCW9iamVjdFsgZmxhZyBdID0gdHJ1ZTsKCX0gKTsKCXJldHVybiBvYmplY3Q7Cn0KCi8qCiAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogKgogKglvcHRpb25zOiBhbiBvcHRpb25hbCBsaXN0IG9mIHNwYWNlLXNlcGFyYXRlZCBvcHRpb25zIHRoYXQgd2lsbCBjaGFuZ2UgaG93CiAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcyBvciBhIG1vcmUgdHJhZGl0aW9uYWwgb3B0aW9uIG9iamVjdAogKgogKiBCeSBkZWZhdWx0IGEgY2FsbGJhY2sgbGlzdCB3aWxsIGFjdCBsaWtlIGFuIGV2ZW50IGNhbGxiYWNrIGxpc3QgYW5kIGNhbiBiZQogKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLgogKgogKiBQb3NzaWJsZSBvcHRpb25zOgogKgogKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQKICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAqCQkJCQl2YWx1ZXMgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogKgogKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlCiAqCiAqLwpqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJLy8gQ29udmVydCBvcHRpb25zIGZyb20gU3RyaW5nLWZvcm1hdHRlZCB0byBPYmplY3QtZm9ybWF0dGVkIGlmIG5lZWRlZAoJLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQoJb3B0aW9ucyA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiA/CgkJY3JlYXRlT3B0aW9ucyggb3B0aW9ucyApIDoKCQlqUXVlcnkuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOwoKCXZhciAvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCBpcyBjdXJyZW50bHkgZmlyaW5nCgkJZmlyaW5nLAoKCQkvLyBMYXN0IGZpcmUgdmFsdWUgZm9yIG5vbi1mb3JnZXR0YWJsZSBsaXN0cwoJCW1lbW9yeSwKCgkJLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKCQlmaXJlZCwKCgkJLy8gRmxhZyB0byBwcmV2ZW50IGZpcmluZwoJCWxvY2tlZCwKCgkJLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKCQlsaXN0ID0gW10sCgoJCS8vIFF1ZXVlIG9mIGV4ZWN1dGlvbiBkYXRhIGZvciByZXBlYXRhYmxlIGxpc3RzCgkJcXVldWUgPSBbXSwKCgkJLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgYWRkL3JlbW92ZSBhcyBuZWVkZWQpCgkJZmlyaW5nSW5kZXggPSAtMSwKCgkJLy8gRmlyZSBjYWxsYmFja3MKCQlmaXJlID0gZnVuY3Rpb24oKSB7CgoJCQkvLyBFbmZvcmNlIHNpbmdsZS1maXJpbmcKCQkJbG9ja2VkID0gbG9ja2VkIHx8IG9wdGlvbnMub25jZTsKCgkJCS8vIEV4ZWN1dGUgY2FsbGJhY2tzIGZvciBhbGwgcGVuZGluZyBleGVjdXRpb25zLAoJCQkvLyByZXNwZWN0aW5nIGZpcmluZ0luZGV4IG92ZXJyaWRlcyBhbmQgcnVudGltZSBjaGFuZ2VzCgkJCWZpcmVkID0gZmlyaW5nID0gdHJ1ZTsKCQkJZm9yICggOyBxdWV1ZS5sZW5ndGg7IGZpcmluZ0luZGV4ID0gLTEgKSB7CgkJCQltZW1vcnkgPSBxdWV1ZS5zaGlmdCgpOwoJCQkJd2hpbGUgKCArK2ZpcmluZ0luZGV4IDwgbGlzdC5sZW5ndGggKSB7CgoJCQkJCS8vIFJ1biBjYWxsYmFjayBhbmQgY2hlY2sgZm9yIGVhcmx5IHRlcm1pbmF0aW9uCgkJCQkJaWYgKCBsaXN0WyBmaXJpbmdJbmRleCBdLmFwcGx5KCBtZW1vcnlbIDAgXSwgbWVtb3J5WyAxIF0gKSA9PT0gZmFsc2UgJiYKCQkJCQkJb3B0aW9ucy5zdG9wT25GYWxzZSApIHsKCgkJCQkJCS8vIEp1bXAgdG8gZW5kIGFuZCBmb3JnZXQgdGhlIGRhdGEgc28gLmFkZCBkb2Vzbid0IHJlLWZpcmUKCQkJCQkJZmlyaW5nSW5kZXggPSBsaXN0Lmxlbmd0aDsKCQkJCQkJbWVtb3J5ID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBGb3JnZXQgdGhlIGRhdGEgaWYgd2UncmUgZG9uZSB3aXRoIGl0CgkJCWlmICggIW9wdGlvbnMubWVtb3J5ICkgewoJCQkJbWVtb3J5ID0gZmFsc2U7CgkJCX0KCgkJCWZpcmluZyA9IGZhbHNlOwoKCQkJLy8gQ2xlYW4gdXAgaWYgd2UncmUgZG9uZSBmaXJpbmcgZm9yIGdvb2QKCQkJaWYgKCBsb2NrZWQgKSB7CgoJCQkJLy8gS2VlcCBhbiBlbXB0eSBsaXN0IGlmIHdlIGhhdmUgZGF0YSBmb3IgZnV0dXJlIGFkZCBjYWxscwoJCQkJaWYgKCBtZW1vcnkgKSB7CgkJCQkJbGlzdCA9IFtdOwoKCQkJCS8vIE90aGVyd2lzZSwgdGhpcyBvYmplY3QgaXMgc3BlbnQKCQkJCX0gZWxzZSB7CgkJCQkJbGlzdCA9ICIiOwoJCQkJfQoJCQl9CgkJfSwKCgkJLy8gQWN0dWFsIENhbGxiYWNrcyBvYmplY3QKCQlzZWxmID0gewoKCQkJLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAoJCQlhZGQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoKCQkJCQkvLyBJZiB3ZSBoYXZlIG1lbW9yeSBmcm9tIGEgcGFzdCBydW4sIHdlIHNob3VsZCBmaXJlIGFmdGVyIGFkZGluZwoJCQkJCWlmICggbWVtb3J5ICYmICFmaXJpbmcgKSB7CgkJCQkJCWZpcmluZ0luZGV4ID0gbGlzdC5sZW5ndGggLSAxOwoJCQkJCQlxdWV1ZS5wdXNoKCBtZW1vcnkgKTsKCQkJCQl9CgoJCQkJCSggZnVuY3Rpb24gYWRkKCBhcmdzICkgewoJCQkJCQlqUXVlcnkuZWFjaCggYXJncywgZnVuY3Rpb24oIF8sIGFyZyApIHsKCQkJCQkJCWlmICggaXNGdW5jdGlvbiggYXJnICkgKSB7CgkJCQkJCQkJaWYgKCAhb3B0aW9ucy51bmlxdWUgfHwgIXNlbGYuaGFzKCBhcmcgKSApIHsKCQkJCQkJCQkJbGlzdC5wdXNoKCBhcmcgKTsKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgaWYgKCBhcmcgJiYgYXJnLmxlbmd0aCAmJiB0b1R5cGUoIGFyZyApICE9PSAic3RyaW5nIiApIHsKCgkJCQkJCQkJLy8gSW5zcGVjdCByZWN1cnNpdmVseQoJCQkJCQkJCWFkZCggYXJnICk7CgkJCQkJCQl9CgkJCQkJCX0gKTsKCQkJCQl9ICkoIGFyZ3VtZW50cyApOwoKCQkJCQlpZiAoIG1lbW9yeSAmJiAhZmlyaW5nICkgewoJCQkJCQlmaXJlKCk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQkvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0CgkJCXJlbW92ZTogZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZWFjaCggYXJndW1lbnRzLCBmdW5jdGlvbiggXywgYXJnICkgewoJCQkJCXZhciBpbmRleDsKCQkJCQl3aGlsZSAoICggaW5kZXggPSBqUXVlcnkuaW5BcnJheSggYXJnLCBsaXN0LCBpbmRleCApICkgPiAtMSApIHsKCQkJCQkJbGlzdC5zcGxpY2UoIGluZGV4LCAxICk7CgoJCQkJCQkvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKCQkJCQkJaWYgKCBpbmRleCA8PSBmaXJpbmdJbmRleCApIHsKCQkJCQkJCWZpcmluZ0luZGV4LS07CgkJCQkJCX0KCQkJCQl9CgkJCQl9ICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCgkJCS8vIENoZWNrIGlmIGEgZ2l2ZW4gY2FsbGJhY2sgaXMgaW4gdGhlIGxpc3QuCgkJCS8vIElmIG5vIGFyZ3VtZW50IGlzIGdpdmVuLCByZXR1cm4gd2hldGhlciBvciBub3QgbGlzdCBoYXMgY2FsbGJhY2tzIGF0dGFjaGVkLgoJCQloYXM6IGZ1bmN0aW9uKCBmbiApIHsKCQkJCXJldHVybiBmbiA/CgkJCQkJalF1ZXJ5LmluQXJyYXkoIGZuLCBsaXN0ICkgPiAtMSA6CgkJCQkJbGlzdC5sZW5ndGggPiAwOwoJCQl9LAoKCQkJLy8gUmVtb3ZlIGFsbCBjYWxsYmFja3MgZnJvbSB0aGUgbGlzdAoJCQllbXB0eTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGxpc3QgKSB7CgkJCQkJbGlzdCA9IFtdOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQkvLyBEaXNhYmxlIC5maXJlIGFuZCAuYWRkCgkJCS8vIEFib3J0IGFueSBjdXJyZW50L3BlbmRpbmcgZXhlY3V0aW9ucwoJCQkvLyBDbGVhciBhbGwgY2FsbGJhY2tzIGFuZCB2YWx1ZXMKCQkJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJCQlsb2NrZWQgPSBxdWV1ZSA9IFtdOwoJCQkJbGlzdCA9IG1lbW9yeSA9ICIiOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCWRpc2FibGVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhbGlzdDsKCQkJfSwKCgkJCS8vIERpc2FibGUgLmZpcmUKCQkJLy8gQWxzbyBkaXNhYmxlIC5hZGQgdW5sZXNzIHdlIGhhdmUgbWVtb3J5IChzaW5jZSBpdCB3b3VsZCBoYXZlIG5vIGVmZmVjdCkKCQkJLy8gQWJvcnQgYW55IHBlbmRpbmcgZXhlY3V0aW9ucwoJCQlsb2NrOiBmdW5jdGlvbigpIHsKCQkJCWxvY2tlZCA9IHF1ZXVlID0gW107CgkJCQlpZiAoICFtZW1vcnkgJiYgIWZpcmluZyApIHsKCQkJCQlsaXN0ID0gbWVtb3J5ID0gIiI7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJbG9ja2VkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhIWxvY2tlZDsKCQkJfSwKCgkJCS8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMKCQkJZmlyZVdpdGg6IGZ1bmN0aW9uKCBjb250ZXh0LCBhcmdzICkgewoJCQkJaWYgKCAhbG9ja2VkICkgewoJCQkJCWFyZ3MgPSBhcmdzIHx8IFtdOwoJCQkJCWFyZ3MgPSBbIGNvbnRleHQsIGFyZ3Muc2xpY2UgPyBhcmdzLnNsaWNlKCkgOiBhcmdzIF07CgkJCQkJcXVldWUucHVzaCggYXJncyApOwoJCQkJCWlmICggIWZpcmluZyApIHsKCQkJCQkJZmlyZSgpOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoKCQkJLy8gQ2FsbCBhbGwgdGhlIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMKCQkJZmlyZTogZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmZpcmVXaXRoKCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoKCQkJLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCgkJCWZpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhIWZpcmVkOwoJCQl9CgkJfTsKCglyZXR1cm4gc2VsZjsKfTsKCgpmdW5jdGlvbiBJZGVudGl0eSggdiApIHsKCXJldHVybiB2Owp9CmZ1bmN0aW9uIFRocm93ZXIoIGV4ICkgewoJdGhyb3cgZXg7Cn0KCmZ1bmN0aW9uIGFkb3B0VmFsdWUoIHZhbHVlLCByZXNvbHZlLCByZWplY3QsIG5vVmFsdWUgKSB7Cgl2YXIgbWV0aG9kOwoKCXRyeSB7CgoJCS8vIENoZWNrIGZvciBwcm9taXNlIGFzcGVjdCBmaXJzdCB0byBwcml2aWxlZ2Ugc3luY2hyb25vdXMgYmVoYXZpb3IKCQlpZiAoIHZhbHVlICYmIGlzRnVuY3Rpb24oICggbWV0aG9kID0gdmFsdWUucHJvbWlzZSApICkgKSB7CgkJCW1ldGhvZC5jYWxsKCB2YWx1ZSApLmRvbmUoIHJlc29sdmUgKS5mYWlsKCByZWplY3QgKTsKCgkJLy8gT3RoZXIgdGhlbmFibGVzCgkJfSBlbHNlIGlmICggdmFsdWUgJiYgaXNGdW5jdGlvbiggKCBtZXRob2QgPSB2YWx1ZS50aGVuICkgKSApIHsKCQkJbWV0aG9kLmNhbGwoIHZhbHVlLCByZXNvbHZlLCByZWplY3QgKTsKCgkJLy8gT3RoZXIgbm9uLXRoZW5hYmxlcwoJCX0gZWxzZSB7CgoJCQkvLyBDb250cm9sIGByZXNvbHZlYCBhcmd1bWVudHMgYnkgbGV0dGluZyBBcnJheSNzbGljZSBjYXN0IGJvb2xlYW4gYG5vVmFsdWVgIHRvIGludGVnZXI6CgkJCS8vICogZmFsc2U6IFsgdmFsdWUgXS5zbGljZSggMCApID0+IHJlc29sdmUoIHZhbHVlICkKCQkJLy8gKiB0cnVlOiBbIHZhbHVlIF0uc2xpY2UoIDEgKSA9PiByZXNvbHZlKCkKCQkJcmVzb2x2ZS5hcHBseSggdW5kZWZpbmVkLCBbIHZhbHVlIF0uc2xpY2UoIG5vVmFsdWUgKSApOwoJCX0KCgkvLyBGb3IgUHJvbWlzZXMvQSssIGNvbnZlcnQgZXhjZXB0aW9ucyBpbnRvIHJlamVjdGlvbnMKCS8vIFNpbmNlIGpRdWVyeS53aGVuIGRvZXNuJ3QgdW53cmFwIHRoZW5hYmxlcywgd2UgY2FuIHNraXAgdGhlIGV4dHJhIGNoZWNrcyBhcHBlYXJpbmcgaW4KCS8vIERlZmVycmVkI3RoZW4gdG8gY29uZGl0aW9uYWxseSBzdXBwcmVzcyByZWplY3Rpb24uCgl9IGNhdGNoICggdmFsdWUgKSB7CgoJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIG9ubHkKCQkvLyBTdHJpY3QgbW9kZSBmdW5jdGlvbnMgaW52b2tlZCB3aXRob3V0IC5jYWxsLy5hcHBseSBnZXQgZ2xvYmFsLW9iamVjdCBjb250ZXh0CgkJcmVqZWN0LmFwcGx5KCB1bmRlZmluZWQsIFsgdmFsdWUgXSApOwoJfQp9CgpqUXVlcnkuZXh0ZW5kKCB7CgoJRGVmZXJyZWQ6IGZ1bmN0aW9uKCBmdW5jICkgewoJCXZhciB0dXBsZXMgPSBbCgoJCQkJLy8gYWN0aW9uLCBhZGQgbGlzdGVuZXIsIGNhbGxiYWNrcywKCQkJCS8vIC4uLiAudGhlbiBoYW5kbGVycywgYXJndW1lbnQgaW5kZXgsIFtmaW5hbCBzdGF0ZV0KCQkJCVsgIm5vdGlmeSIsICJwcm9ncmVzcyIsIGpRdWVyeS5DYWxsYmFja3MoICJtZW1vcnkiICksCgkJCQkJalF1ZXJ5LkNhbGxiYWNrcyggIm1lbW9yeSIgKSwgMiBdLAoJCQkJWyAicmVzb2x2ZSIsICJkb25lIiwgalF1ZXJ5LkNhbGxiYWNrcyggIm9uY2UgbWVtb3J5IiApLAoJCQkJCWpRdWVyeS5DYWxsYmFja3MoICJvbmNlIG1lbW9yeSIgKSwgMCwgInJlc29sdmVkIiBdLAoJCQkJWyAicmVqZWN0IiwgImZhaWwiLCBqUXVlcnkuQ2FsbGJhY2tzKCAib25jZSBtZW1vcnkiICksCgkJCQkJalF1ZXJ5LkNhbGxiYWNrcyggIm9uY2UgbWVtb3J5IiApLCAxLCAicmVqZWN0ZWQiIF0KCQkJXSwKCQkJc3RhdGUgPSAicGVuZGluZyIsCgkJCXByb21pc2UgPSB7CgkJCQlzdGF0ZTogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIHN0YXRlOwoJCQkJfSwKCQkJCWFsd2F5czogZnVuY3Rpb24oKSB7CgkJCQkJZGVmZXJyZWQuZG9uZSggYXJndW1lbnRzICkuZmFpbCggYXJndW1lbnRzICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoJCQkJImNhdGNoIjogZnVuY3Rpb24oIGZuICkgewoJCQkJCXJldHVybiBwcm9taXNlLnRoZW4oIG51bGwsIGZuICk7CgkJCQl9LAoKCQkJCS8vIEtlZXAgcGlwZSBmb3IgYmFjay1jb21wYXQKCQkJCXBpcGU6IGZ1bmN0aW9uKCAvKiBmbkRvbmUsIGZuRmFpbCwgZm5Qcm9ncmVzcyAqLyApIHsKCQkJCQl2YXIgZm5zID0gYXJndW1lbnRzOwoKCQkJCQlyZXR1cm4galF1ZXJ5LkRlZmVycmVkKCBmdW5jdGlvbiggbmV3RGVmZXIgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCgkJCQkJCQkvLyBNYXAgdHVwbGVzIChwcm9ncmVzcywgZG9uZSwgZmFpbCkgdG8gYXJndW1lbnRzIChkb25lLCBmYWlsLCBwcm9ncmVzcykKCQkJCQkJCXZhciBmbiA9IGlzRnVuY3Rpb24oIGZuc1sgdHVwbGVbIDQgXSBdICkgJiYgZm5zWyB0dXBsZVsgNCBdIF07CgoJCQkJCQkJLy8gZGVmZXJyZWQucHJvZ3Jlc3MoZnVuY3Rpb24oKSB7IGJpbmQgdG8gbmV3RGVmZXIgb3IgbmV3RGVmZXIubm90aWZ5IH0pCgkJCQkJCQkvLyBkZWZlcnJlZC5kb25lKGZ1bmN0aW9uKCkgeyBiaW5kIHRvIG5ld0RlZmVyIG9yIG5ld0RlZmVyLnJlc29sdmUgfSkKCQkJCQkJCS8vIGRlZmVycmVkLmZhaWwoZnVuY3Rpb24oKSB7IGJpbmQgdG8gbmV3RGVmZXIgb3IgbmV3RGVmZXIucmVqZWN0IH0pCgkJCQkJCQlkZWZlcnJlZFsgdHVwbGVbIDEgXSBdKCBmdW5jdGlvbigpIHsKCQkJCQkJCQl2YXIgcmV0dXJuZWQgPSBmbiAmJiBmbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQkJCQkJaWYgKCByZXR1cm5lZCAmJiBpc0Z1bmN0aW9uKCByZXR1cm5lZC5wcm9taXNlICkgKSB7CgkJCQkJCQkJCXJldHVybmVkLnByb21pc2UoKQoJCQkJCQkJCQkJLnByb2dyZXNzKCBuZXdEZWZlci5ub3RpZnkgKQoJCQkJCQkJCQkJLmRvbmUoIG5ld0RlZmVyLnJlc29sdmUgKQoJCQkJCQkJCQkJLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCW5ld0RlZmVyWyB0dXBsZVsgMCBdICsgIldpdGgiIF0oCgkJCQkJCQkJCQl0aGlzLAoJCQkJCQkJCQkJZm4gPyBbIHJldHVybmVkIF0gOiBhcmd1bWVudHMKCQkJCQkJCQkJKTsKCQkJCQkJCQl9CgkJCQkJCQl9ICk7CgkJCQkJCX0gKTsKCQkJCQkJZm5zID0gbnVsbDsKCQkJCQl9ICkucHJvbWlzZSgpOwoJCQkJfSwKCQkJCXRoZW46IGZ1bmN0aW9uKCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyApIHsKCQkJCQl2YXIgbWF4RGVwdGggPSAwOwoJCQkJCWZ1bmN0aW9uIHJlc29sdmUoIGRlcHRoLCBkZWZlcnJlZCwgaGFuZGxlciwgc3BlY2lhbCApIHsKCQkJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCQkJdmFyIHRoYXQgPSB0aGlzLAoJCQkJCQkJCWFyZ3MgPSBhcmd1bWVudHMsCgkJCQkJCQkJbWlnaHRUaHJvdyA9IGZ1bmN0aW9uKCkgewoJCQkJCQkJCQl2YXIgcmV0dXJuZWQsIHRoZW47CgoJCQkJCQkJCQkvLyBTdXBwb3J0OiBQcm9taXNlcy9BKyBzZWN0aW9uIDIuMy4zLjMuMwoJCQkJCQkJCQkvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC01OQoJCQkJCQkJCQkvLyBJZ25vcmUgZG91YmxlLXJlc29sdXRpb24gYXR0ZW1wdHMKCQkJCQkJCQkJaWYgKCBkZXB0aCA8IG1heERlcHRoICkgewoJCQkJCQkJCQkJcmV0dXJuOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQlyZXR1cm5lZCA9IGhhbmRsZXIuYXBwbHkoIHRoYXQsIGFyZ3MgKTsKCgkJCQkJCQkJCS8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjEKCQkJCQkJCQkJLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNDgKCQkJCQkJCQkJaWYgKCByZXR1cm5lZCA9PT0gZGVmZXJyZWQucHJvbWlzZSgpICkgewoJCQkJCQkJCQkJdGhyb3cgbmV3IFR5cGVFcnJvciggIlRoZW5hYmxlIHNlbGYtcmVzb2x1dGlvbiIgKTsKCQkJCQkJCQkJfQoKCQkJCQkJCQkJLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbnMgMi4zLjMuMSwgMy41CgkJCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTU0CgkJCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTc1CgkJCQkJCQkJCS8vIFJldHJpZXZlIGB0aGVuYCBvbmx5IG9uY2UKCQkJCQkJCQkJdGhlbiA9IHJldHVybmVkICYmCgoJCQkJCQkJCQkJLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuNAoJCQkJCQkJCQkJLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNjQKCQkJCQkJCQkJCS8vIE9ubHkgY2hlY2sgb2JqZWN0cyBhbmQgZnVuY3Rpb25zIGZvciB0aGVuYWJpbGl0eQoJCQkJCQkJCQkJKCB0eXBlb2YgcmV0dXJuZWQgPT09ICJvYmplY3QiIHx8CgkJCQkJCQkJCQkJdHlwZW9mIHJldHVybmVkID09PSAiZnVuY3Rpb24iICkgJiYKCQkJCQkJCQkJCXJldHVybmVkLnRoZW47CgoJCQkJCQkJCQkvLyBIYW5kbGUgYSByZXR1cm5lZCB0aGVuYWJsZQoJCQkJCQkJCQlpZiAoIGlzRnVuY3Rpb24oIHRoZW4gKSApIHsKCgkJCQkJCQkJCQkvLyBTcGVjaWFsIHByb2Nlc3NvcnMgKG5vdGlmeSkganVzdCB3YWl0IGZvciByZXNvbHV0aW9uCgkJCQkJCQkJCQlpZiAoIHNwZWNpYWwgKSB7CgkJCQkJCQkJCQkJdGhlbi5jYWxsKAoJCQkJCQkJCQkJCQlyZXR1cm5lZCwKCQkJCQkJCQkJCQkJcmVzb2x2ZSggbWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwgc3BlY2lhbCApLAoJCQkJCQkJCQkJCQlyZXNvbHZlKCBtYXhEZXB0aCwgZGVmZXJyZWQsIFRocm93ZXIsIHNwZWNpYWwgKQoJCQkJCQkJCQkJCSk7CgoJCQkJCQkJCQkJLy8gTm9ybWFsIHByb2Nlc3NvcnMgKHJlc29sdmUpIGFsc28gaG9vayBpbnRvIHByb2dyZXNzCgkJCQkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQkJCQkvLyAuLi5hbmQgZGlzcmVnYXJkIG9sZGVyIHJlc29sdXRpb24gdmFsdWVzCgkJCQkJCQkJCQkJbWF4RGVwdGgrKzsKCgkJCQkJCQkJCQkJdGhlbi5jYWxsKAoJCQkJCQkJCQkJCQlyZXR1cm5lZCwKCQkJCQkJCQkJCQkJcmVzb2x2ZSggbWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwgc3BlY2lhbCApLAoJCQkJCQkJCQkJCQlyZXNvbHZlKCBtYXhEZXB0aCwgZGVmZXJyZWQsIFRocm93ZXIsIHNwZWNpYWwgKSwKCQkJCQkJCQkJCQkJcmVzb2x2ZSggbWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwKCQkJCQkJCQkJCQkJCWRlZmVycmVkLm5vdGlmeVdpdGggKQoJCQkJCQkJCQkJCSk7CgkJCQkJCQkJCQl9CgoJCQkJCQkJCQkvLyBIYW5kbGUgYWxsIG90aGVyIHJldHVybmVkIHZhbHVlcwoJCQkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQkJCS8vIE9ubHkgc3Vic3RpdHV0ZSBoYW5kbGVycyBwYXNzIG9uIGNvbnRleHQKCQkJCQkJCQkJCS8vIGFuZCBtdWx0aXBsZSB2YWx1ZXMgKG5vbi1zcGVjIGJlaGF2aW9yKQoJCQkJCQkJCQkJaWYgKCBoYW5kbGVyICE9PSBJZGVudGl0eSApIHsKCQkJCQkJCQkJCQl0aGF0ID0gdW5kZWZpbmVkOwoJCQkJCQkJCQkJCWFyZ3MgPSBbIHJldHVybmVkIF07CgkJCQkJCQkJCQl9CgoJCQkJCQkJCQkJLy8gUHJvY2VzcyB0aGUgdmFsdWUocykKCQkJCQkJCQkJCS8vIERlZmF1bHQgcHJvY2VzcyBpcyByZXNvbHZlCgkJCQkJCQkJCQkoIHNwZWNpYWwgfHwgZGVmZXJyZWQucmVzb2x2ZVdpdGggKSggdGhhdCwgYXJncyApOwoJCQkJCQkJCQl9CgkJCQkJCQkJfSwKCgkJCQkJCQkJLy8gT25seSBub3JtYWwgcHJvY2Vzc29ycyAocmVzb2x2ZSkgY2F0Y2ggYW5kIHJlamVjdCBleGNlcHRpb25zCgkJCQkJCQkJcHJvY2VzcyA9IHNwZWNpYWwgPwoJCQkJCQkJCQltaWdodFRocm93IDoKCQkJCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQkJCQl0cnkgewoJCQkJCQkJCQkJCW1pZ2h0VGhyb3coKTsKCQkJCQkJCQkJCX0gY2F0Y2ggKCBlICkgewoKCQkJCQkJCQkJCQlpZiAoIGpRdWVyeS5EZWZlcnJlZC5leGNlcHRpb25Ib29rICkgewoJCQkJCQkJCQkJCQlqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayggZSwKCQkJCQkJCQkJCQkJCXByb2Nlc3Muc3RhY2tUcmFjZSApOwoJCQkJCQkJCQkJCX0KCgkJCQkJCQkJCQkJLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuMy4zLjQuMQoJCQkJCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTYxCgkJCQkJCQkJCQkJLy8gSWdub3JlIHBvc3QtcmVzb2x1dGlvbiBleGNlcHRpb25zCgkJCQkJCQkJCQkJaWYgKCBkZXB0aCArIDEgPj0gbWF4RGVwdGggKSB7CgoJCQkJCQkJCQkJCQkvLyBPbmx5IHN1YnN0aXR1dGUgaGFuZGxlcnMgcGFzcyBvbiBjb250ZXh0CgkJCQkJCQkJCQkJCS8vIGFuZCBtdWx0aXBsZSB2YWx1ZXMgKG5vbi1zcGVjIGJlaGF2aW9yKQoJCQkJCQkJCQkJCQlpZiAoIGhhbmRsZXIgIT09IFRocm93ZXIgKSB7CgkJCQkJCQkJCQkJCQl0aGF0ID0gdW5kZWZpbmVkOwoJCQkJCQkJCQkJCQkJYXJncyA9IFsgZSBdOwoJCQkJCQkJCQkJCQl9CgoJCQkJCQkJCQkJCQlkZWZlcnJlZC5yZWplY3RXaXRoKCB0aGF0LCBhcmdzICk7CgkJCQkJCQkJCQkJfQoJCQkJCQkJCQkJfQoJCQkJCQkJCQl9OwoKCQkJCQkJCS8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjMuMy4xCgkJCQkJCQkvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC01NwoJCQkJCQkJLy8gUmUtcmVzb2x2ZSBwcm9taXNlcyBpbW1lZGlhdGVseSB0byBkb2RnZSBmYWxzZSByZWplY3Rpb24gZnJvbQoJCQkJCQkJLy8gc3Vic2VxdWVudCBlcnJvcnMKCQkJCQkJCWlmICggZGVwdGggKSB7CgkJCQkJCQkJcHJvY2VzcygpOwoJCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkJLy8gQ2FsbCBhbiBvcHRpb25hbCBob29rIHRvIHJlY29yZCB0aGUgc3RhY2ssIGluIGNhc2Ugb2YgZXhjZXB0aW9uCgkJCQkJCQkJLy8gc2luY2UgaXQncyBvdGhlcndpc2UgbG9zdCB3aGVuIGV4ZWN1dGlvbiBnb2VzIGFzeW5jCgkJCQkJCQkJaWYgKCBqUXVlcnkuRGVmZXJyZWQuZ2V0U3RhY2tIb29rICkgewoJCQkJCQkJCQlwcm9jZXNzLnN0YWNrVHJhY2UgPSBqUXVlcnkuRGVmZXJyZWQuZ2V0U3RhY2tIb29rKCk7CgkJCQkJCQkJfQoJCQkJCQkJCXdpbmRvdy5zZXRUaW1lb3V0KCBwcm9jZXNzICk7CgkJCQkJCQl9CgkJCQkJCX07CgkJCQkJfQoKCQkJCQlyZXR1cm4galF1ZXJ5LkRlZmVycmVkKCBmdW5jdGlvbiggbmV3RGVmZXIgKSB7CgoJCQkJCQkvLyBwcm9ncmVzc19oYW5kbGVycy5hZGQoIC4uLiApCgkJCQkJCXR1cGxlc1sgMCBdWyAzIF0uYWRkKAoJCQkJCQkJcmVzb2x2ZSgKCQkJCQkJCQkwLAoJCQkJCQkJCW5ld0RlZmVyLAoJCQkJCQkJCWlzRnVuY3Rpb24oIG9uUHJvZ3Jlc3MgKSA/CgkJCQkJCQkJCW9uUHJvZ3Jlc3MgOgoJCQkJCQkJCQlJZGVudGl0eSwKCQkJCQkJCQluZXdEZWZlci5ub3RpZnlXaXRoCgkJCQkJCQkpCgkJCQkJCSk7CgoJCQkJCQkvLyBmdWxmaWxsZWRfaGFuZGxlcnMuYWRkKCAuLi4gKQoJCQkJCQl0dXBsZXNbIDEgXVsgMyBdLmFkZCgKCQkJCQkJCXJlc29sdmUoCgkJCQkJCQkJMCwKCQkJCQkJCQluZXdEZWZlciwKCQkJCQkJCQlpc0Z1bmN0aW9uKCBvbkZ1bGZpbGxlZCApID8KCQkJCQkJCQkJb25GdWxmaWxsZWQgOgoJCQkJCQkJCQlJZGVudGl0eQoJCQkJCQkJKQoJCQkJCQkpOwoKCQkJCQkJLy8gcmVqZWN0ZWRfaGFuZGxlcnMuYWRkKCAuLi4gKQoJCQkJCQl0dXBsZXNbIDIgXVsgMyBdLmFkZCgKCQkJCQkJCXJlc29sdmUoCgkJCQkJCQkJMCwKCQkJCQkJCQluZXdEZWZlciwKCQkJCQkJCQlpc0Z1bmN0aW9uKCBvblJlamVjdGVkICkgPwoJCQkJCQkJCQlvblJlamVjdGVkIDoKCQkJCQkJCQkJVGhyb3dlcgoJCQkJCQkJKQoJCQkJCQkpOwoJCQkJCX0gKS5wcm9taXNlKCk7CgkJCQl9LAoKCQkJCS8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQKCQkJCS8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKCQkJCXByb21pc2U6IGZ1bmN0aW9uKCBvYmogKSB7CgkJCQkJcmV0dXJuIG9iaiAhPSBudWxsID8galF1ZXJ5LmV4dGVuZCggb2JqLCBwcm9taXNlICkgOiBwcm9taXNlOwoJCQkJfQoJCQl9LAoJCQlkZWZlcnJlZCA9IHt9OwoKCQkvLyBBZGQgbGlzdC1zcGVjaWZpYyBtZXRob2RzCgkJalF1ZXJ5LmVhY2goIHR1cGxlcywgZnVuY3Rpb24oIGksIHR1cGxlICkgewoJCQl2YXIgbGlzdCA9IHR1cGxlWyAyIF0sCgkJCQlzdGF0ZVN0cmluZyA9IHR1cGxlWyA1IF07CgoJCQkvLyBwcm9taXNlLnByb2dyZXNzID0gbGlzdC5hZGQKCQkJLy8gcHJvbWlzZS5kb25lID0gbGlzdC5hZGQKCQkJLy8gcHJvbWlzZS5mYWlsID0gbGlzdC5hZGQKCQkJcHJvbWlzZVsgdHVwbGVbIDEgXSBdID0gbGlzdC5hZGQ7CgoJCQkvLyBIYW5kbGUgc3RhdGUKCQkJaWYgKCBzdGF0ZVN0cmluZyApIHsKCQkJCWxpc3QuYWRkKAoJCQkJCWZ1bmN0aW9uKCkgewoKCQkJCQkJLy8gc3RhdGUgPSAicmVzb2x2ZWQiIChpLmUuLCBmdWxmaWxsZWQpCgkJCQkJCS8vIHN0YXRlID0gInJlamVjdGVkIgoJCQkJCQlzdGF0ZSA9IHN0YXRlU3RyaW5nOwoJCQkJCX0sCgoJCQkJCS8vIHJlamVjdGVkX2NhbGxiYWNrcy5kaXNhYmxlCgkJCQkJLy8gZnVsZmlsbGVkX2NhbGxiYWNrcy5kaXNhYmxlCgkJCQkJdHVwbGVzWyAzIC0gaSBdWyAyIF0uZGlzYWJsZSwKCgkJCQkJLy8gcmVqZWN0ZWRfaGFuZGxlcnMuZGlzYWJsZQoJCQkJCS8vIGZ1bGZpbGxlZF9oYW5kbGVycy5kaXNhYmxlCgkJCQkJdHVwbGVzWyAzIC0gaSBdWyAzIF0uZGlzYWJsZSwKCgkJCQkJLy8gcHJvZ3Jlc3NfY2FsbGJhY2tzLmxvY2sKCQkJCQl0dXBsZXNbIDAgXVsgMiBdLmxvY2ssCgoJCQkJCS8vIHByb2dyZXNzX2hhbmRsZXJzLmxvY2sKCQkJCQl0dXBsZXNbIDAgXVsgMyBdLmxvY2sKCQkJCSk7CgkJCX0KCgkJCS8vIHByb2dyZXNzX2hhbmRsZXJzLmZpcmUKCQkJLy8gZnVsZmlsbGVkX2hhbmRsZXJzLmZpcmUKCQkJLy8gcmVqZWN0ZWRfaGFuZGxlcnMuZmlyZQoJCQlsaXN0LmFkZCggdHVwbGVbIDMgXS5maXJlICk7CgoJCQkvLyBkZWZlcnJlZC5ub3RpZnkgPSBmdW5jdGlvbigpIHsgZGVmZXJyZWQubm90aWZ5V2l0aCguLi4pIH0KCQkJLy8gZGVmZXJyZWQucmVzb2x2ZSA9IGZ1bmN0aW9uKCkgeyBkZWZlcnJlZC5yZXNvbHZlV2l0aCguLi4pIH0KCQkJLy8gZGVmZXJyZWQucmVqZWN0ID0gZnVuY3Rpb24oKSB7IGRlZmVycmVkLnJlamVjdFdpdGgoLi4uKSB9CgkJCWRlZmVycmVkWyB0dXBsZVsgMCBdIF0gPSBmdW5jdGlvbigpIHsKCQkJCWRlZmVycmVkWyB0dXBsZVsgMCBdICsgIldpdGgiIF0oIHRoaXMgPT09IGRlZmVycmVkID8gdW5kZWZpbmVkIDogdGhpcywgYXJndW1lbnRzICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfTsKCgkJCS8vIGRlZmVycmVkLm5vdGlmeVdpdGggPSBsaXN0LmZpcmVXaXRoCgkJCS8vIGRlZmVycmVkLnJlc29sdmVXaXRoID0gbGlzdC5maXJlV2l0aAoJCQkvLyBkZWZlcnJlZC5yZWplY3RXaXRoID0gbGlzdC5maXJlV2l0aAoJCQlkZWZlcnJlZFsgdHVwbGVbIDAgXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsKCQl9ICk7CgoJCS8vIE1ha2UgdGhlIGRlZmVycmVkIGEgcHJvbWlzZQoJCXByb21pc2UucHJvbWlzZSggZGVmZXJyZWQgKTsKCgkJLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQoJCWlmICggZnVuYyApIHsKCQkJZnVuYy5jYWxsKCBkZWZlcnJlZCwgZGVmZXJyZWQgKTsKCQl9CgoJCS8vIEFsbCBkb25lIQoJCXJldHVybiBkZWZlcnJlZDsKCX0sCgoJLy8gRGVmZXJyZWQgaGVscGVyCgl3aGVuOiBmdW5jdGlvbiggc2luZ2xlVmFsdWUgKSB7CgkJdmFyCgoJCQkvLyBjb3VudCBvZiB1bmNvbXBsZXRlZCBzdWJvcmRpbmF0ZXMKCQkJcmVtYWluaW5nID0gYXJndW1lbnRzLmxlbmd0aCwKCgkJCS8vIGNvdW50IG9mIHVucHJvY2Vzc2VkIGFyZ3VtZW50cwoJCQlpID0gcmVtYWluaW5nLAoKCQkJLy8gc3Vib3JkaW5hdGUgZnVsZmlsbG1lbnQgZGF0YQoJCQlyZXNvbHZlQ29udGV4dHMgPSBBcnJheSggaSApLAoJCQlyZXNvbHZlVmFsdWVzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgoJCQkvLyB0aGUgbWFzdGVyIERlZmVycmVkCgkJCW1hc3RlciA9IGpRdWVyeS5EZWZlcnJlZCgpLAoKCQkJLy8gc3Vib3JkaW5hdGUgY2FsbGJhY2sgZmFjdG9yeQoJCQl1cGRhdGVGdW5jID0gZnVuY3Rpb24oIGkgKSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCXJlc29sdmVDb250ZXh0c1sgaSBdID0gdGhpczsKCQkJCQlyZXNvbHZlVmFsdWVzWyBpIF0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApIDogdmFsdWU7CgkJCQkJaWYgKCAhKCAtLXJlbWFpbmluZyApICkgewoJCQkJCQltYXN0ZXIucmVzb2x2ZVdpdGgoIHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyApOwoJCQkJCX0KCQkJCX07CgkJCX07CgoJCS8vIFNpbmdsZS0gYW5kIGVtcHR5IGFyZ3VtZW50cyBhcmUgYWRvcHRlZCBsaWtlIFByb21pc2UucmVzb2x2ZQoJCWlmICggcmVtYWluaW5nIDw9IDEgKSB7CgkJCWFkb3B0VmFsdWUoIHNpbmdsZVZhbHVlLCBtYXN0ZXIuZG9uZSggdXBkYXRlRnVuYyggaSApICkucmVzb2x2ZSwgbWFzdGVyLnJlamVjdCwKCQkJCSFyZW1haW5pbmcgKTsKCgkJCS8vIFVzZSAudGhlbigpIHRvIHVud3JhcCBzZWNvbmRhcnkgdGhlbmFibGVzIChjZi4gZ2gtMzAwMCkKCQkJaWYgKCBtYXN0ZXIuc3RhdGUoKSA9PT0gInBlbmRpbmciIHx8CgkJCQlpc0Z1bmN0aW9uKCByZXNvbHZlVmFsdWVzWyBpIF0gJiYgcmVzb2x2ZVZhbHVlc1sgaSBdLnRoZW4gKSApIHsKCgkJCQlyZXR1cm4gbWFzdGVyLnRoZW4oKTsKCQkJfQoJCX0KCgkJLy8gTXVsdGlwbGUgYXJndW1lbnRzIGFyZSBhZ2dyZWdhdGVkIGxpa2UgUHJvbWlzZS5hbGwgYXJyYXkgZWxlbWVudHMKCQl3aGlsZSAoIGktLSApIHsKCQkJYWRvcHRWYWx1ZSggcmVzb2x2ZVZhbHVlc1sgaSBdLCB1cGRhdGVGdW5jKCBpICksIG1hc3Rlci5yZWplY3QgKTsKCQl9CgoJCXJldHVybiBtYXN0ZXIucHJvbWlzZSgpOwoJfQp9ICk7CgoKLy8gVGhlc2UgdXN1YWxseSBpbmRpY2F0ZSBhIHByb2dyYW1tZXIgbWlzdGFrZSBkdXJpbmcgZGV2ZWxvcG1lbnQsCi8vIHdhcm4gYWJvdXQgdGhlbSBBU0FQIHJhdGhlciB0aGFuIHN3YWxsb3dpbmcgdGhlbSBieSBkZWZhdWx0Lgp2YXIgcmVycm9yTmFtZXMgPSAvXihFdmFsfEludGVybmFsfFJhbmdlfFJlZmVyZW5jZXxTeW50YXh8VHlwZXxVUkkpRXJyb3IkLzsKCmpRdWVyeS5EZWZlcnJlZC5leGNlcHRpb25Ib29rID0gZnVuY3Rpb24oIGVycm9yLCBzdGFjayApIHsKCgkvLyBTdXBwb3J0OiBJRSA4IC0gOSBvbmx5CgkvLyBDb25zb2xlIGV4aXN0cyB3aGVuIGRldiB0b29scyBhcmUgb3Blbiwgd2hpY2ggY2FuIGhhcHBlbiBhdCBhbnkgdGltZQoJaWYgKCB3aW5kb3cuY29uc29sZSAmJiB3aW5kb3cuY29uc29sZS53YXJuICYmIGVycm9yICYmIHJlcnJvck5hbWVzLnRlc3QoIGVycm9yLm5hbWUgKSApIHsKCQl3aW5kb3cuY29uc29sZS53YXJuKCAialF1ZXJ5LkRlZmVycmVkIGV4Y2VwdGlvbjogIiArIGVycm9yLm1lc3NhZ2UsIGVycm9yLnN0YWNrLCBzdGFjayApOwoJfQp9OwoKCgoKalF1ZXJ5LnJlYWR5RXhjZXB0aW9uID0gZnVuY3Rpb24oIGVycm9yICkgewoJd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXRocm93IGVycm9yOwoJfSApOwp9OwoKCgoKLy8gVGhlIGRlZmVycmVkIHVzZWQgb24gRE9NIHJlYWR5CnZhciByZWFkeUxpc3QgPSBqUXVlcnkuRGVmZXJyZWQoKTsKCmpRdWVyeS5mbi5yZWFkeSA9IGZ1bmN0aW9uKCBmbiApIHsKCglyZWFkeUxpc3QKCQkudGhlbiggZm4gKQoKCQkvLyBXcmFwIGpRdWVyeS5yZWFkeUV4Y2VwdGlvbiBpbiBhIGZ1bmN0aW9uIHNvIHRoYXQgdGhlIGxvb2t1cAoJCS8vIGhhcHBlbnMgYXQgdGhlIHRpbWUgb2YgZXJyb3IgaGFuZGxpbmcgaW5zdGVhZCBvZiBjYWxsYmFjawoJCS8vIHJlZ2lzdHJhdGlvbi4KCQkuY2F0Y2goIGZ1bmN0aW9uKCBlcnJvciApIHsKCQkJalF1ZXJ5LnJlYWR5RXhjZXB0aW9uKCBlcnJvciApOwoJCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCmpRdWVyeS5leHRlbmQoIHsKCgkvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgoJaXNSZWFkeTogZmFsc2UsCgoJLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQoJLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKCXJlYWR5V2FpdDogMSwKCgkvLyBIYW5kbGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CglyZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgoJCS8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKCQlpZiAoIHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CgkJalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwoKCQkvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQoJCWlmICggd2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCgkJcmVhZHlMaXN0LnJlc29sdmVXaXRoKCBkb2N1bWVudCwgWyBqUXVlcnkgXSApOwoJfQp9ICk7CgpqUXVlcnkucmVhZHkudGhlbiA9IHJlYWR5TGlzdC50aGVuOwoKLy8gVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXIgYW5kIHNlbGYgY2xlYW51cCBtZXRob2QKZnVuY3Rpb24gY29tcGxldGVkKCkgewoJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggIkRPTUNvbnRlbnRMb2FkZWQiLCBjb21wbGV0ZWQgKTsKCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCApOwoJalF1ZXJ5LnJlYWR5KCk7Cn0KCi8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkCi8vIGFmdGVyIHRoZSBicm93c2VyIGV2ZW50IGhhcyBhbHJlYWR5IG9jY3VycmVkLgovLyBTdXBwb3J0OiBJRSA8PTkgLSAxMCBvbmx5Ci8vIE9sZGVyIElFIHNvbWV0aW1lcyBzaWduYWxzICJpbnRlcmFjdGl2ZSIgdG9vIHNvb24KaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiIHx8CgkoIGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICJsb2FkaW5nIiAmJiAhZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsICkgKSB7CgoJLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5Cgl3aW5kb3cuc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5ICk7Cgp9IGVsc2UgewoKCS8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sKCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgY29tcGxldGVkICk7CgoJLy8gQSBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkLCB0aGF0IHdpbGwgYWx3YXlzIHdvcmsKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCApOwp9CgoKCgovLyBNdWx0aWZ1bmN0aW9uYWwgbWV0aG9kIHRvIGdldCBhbmQgc2V0IHZhbHVlcyBvZiBhIGNvbGxlY3Rpb24KLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCnZhciBhY2Nlc3MgPSBmdW5jdGlvbiggZWxlbXMsIGZuLCBrZXksIHZhbHVlLCBjaGFpbmFibGUsIGVtcHR5R2V0LCByYXcgKSB7Cgl2YXIgaSA9IDAsCgkJbGVuID0gZWxlbXMubGVuZ3RoLAoJCWJ1bGsgPSBrZXkgPT0gbnVsbDsKCgkvLyBTZXRzIG1hbnkgdmFsdWVzCglpZiAoIHRvVHlwZSgga2V5ICkgPT09ICJvYmplY3QiICkgewoJCWNoYWluYWJsZSA9IHRydWU7CgkJZm9yICggaSBpbiBrZXkgKSB7CgkJCWFjY2VzcyggZWxlbXMsIGZuLCBpLCBrZXlbIGkgXSwgdHJ1ZSwgZW1wdHlHZXQsIHJhdyApOwoJCX0KCgkvLyBTZXRzIG9uZSB2YWx1ZQoJfSBlbHNlIGlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQljaGFpbmFibGUgPSB0cnVlOwoKCQlpZiAoICFpc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyYXcgPSB0cnVlOwoJCX0KCgkJaWYgKCBidWxrICkgewoKCQkJLy8gQnVsayBvcGVyYXRpb25zIHJ1biBhZ2FpbnN0IHRoZSBlbnRpcmUgc2V0CgkJCWlmICggcmF3ICkgewoJCQkJZm4uY2FsbCggZWxlbXMsIHZhbHVlICk7CgkJCQlmbiA9IG51bGw7CgoJCQkvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCgkJCX0gZWxzZSB7CgkJCQlidWxrID0gZm47CgkJCQlmbiA9IGZ1bmN0aW9uKCBlbGVtLCBrZXksIHZhbHVlICkgewoJCQkJCXJldHVybiBidWxrLmNhbGwoIGpRdWVyeSggZWxlbSApLCB2YWx1ZSApOwoJCQkJfTsKCQkJfQoJCX0KCgkJaWYgKCBmbiApIHsKCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCQlmbigKCQkJCQllbGVtc1sgaSBdLCBrZXksIHJhdyA/CgkJCQkJdmFsdWUgOgoJCQkJCXZhbHVlLmNhbGwoIGVsZW1zWyBpIF0sIGksIGZuKCBlbGVtc1sgaSBdLCBrZXkgKSApCgkJCQkpOwoJCQl9CgkJfQoJfQoKCWlmICggY2hhaW5hYmxlICkgewoJCXJldHVybiBlbGVtczsKCX0KCgkvLyBHZXRzCglpZiAoIGJ1bGsgKSB7CgkJcmV0dXJuIGZuLmNhbGwoIGVsZW1zICk7Cgl9CgoJcmV0dXJuIGxlbiA/IGZuKCBlbGVtc1sgMCBdLCBrZXkgKSA6IGVtcHR5R2V0Owp9OwoKCi8vIE1hdGNoZXMgZGFzaGVkIHN0cmluZyBmb3IgY2FtZWxpemluZwp2YXIgcm1zUHJlZml4ID0gL14tbXMtLywKCXJkYXNoQWxwaGEgPSAvLShbYS16XSkvZzsKCi8vIFVzZWQgYnkgY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQpmdW5jdGlvbiBmY2FtZWxDYXNlKCBhbGwsIGxldHRlciApIHsKCXJldHVybiBsZXR0ZXIudG9VcHBlckNhc2UoKTsKfQoKLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwovLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSwgRWRnZSAxMiAtIDE1Ci8vIE1pY3Jvc29mdCBmb3Jnb3QgdG8gaHVtcCB0aGVpciB2ZW5kb3IgcHJlZml4ICgjOTU3MikKZnVuY3Rpb24gY2FtZWxDYXNlKCBzdHJpbmcgKSB7CglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoIHJtc1ByZWZpeCwgIm1zLSIgKS5yZXBsYWNlKCByZGFzaEFscGhhLCBmY2FtZWxDYXNlICk7Cn0KdmFyIGFjY2VwdERhdGEgPSBmdW5jdGlvbiggb3duZXIgKSB7CgoJLy8gQWNjZXB0cyBvbmx5OgoJLy8gIC0gTm9kZQoJLy8gICAgLSBOb2RlLkVMRU1FTlRfTk9ERQoJLy8gICAgLSBOb2RlLkRPQ1VNRU5UX05PREUKCS8vICAtIE9iamVjdAoJLy8gICAgLSBBbnkKCXJldHVybiBvd25lci5ub2RlVHlwZSA9PT0gMSB8fCBvd25lci5ub2RlVHlwZSA9PT0gOSB8fCAhKCArb3duZXIubm9kZVR5cGUgKTsKfTsKCgoKCmZ1bmN0aW9uIERhdGEoKSB7Cgl0aGlzLmV4cGFuZG8gPSBqUXVlcnkuZXhwYW5kbyArIERhdGEudWlkKys7Cn0KCkRhdGEudWlkID0gMTsKCkRhdGEucHJvdG90eXBlID0gewoKCWNhY2hlOiBmdW5jdGlvbiggb3duZXIgKSB7CgoJCS8vIENoZWNrIGlmIHRoZSBvd25lciBvYmplY3QgYWxyZWFkeSBoYXMgYSBjYWNoZQoJCXZhciB2YWx1ZSA9IG93bmVyWyB0aGlzLmV4cGFuZG8gXTsKCgkJLy8gSWYgbm90LCBjcmVhdGUgb25lCgkJaWYgKCAhdmFsdWUgKSB7CgkJCXZhbHVlID0ge307CgoJCQkvLyBXZSBjYW4gYWNjZXB0IGRhdGEgZm9yIG5vbi1lbGVtZW50IG5vZGVzIGluIG1vZGVybiBicm93c2VycywKCQkJLy8gYnV0IHdlIHNob3VsZCBub3QsIHNlZSAjODMzNS4KCQkJLy8gQWx3YXlzIHJldHVybiBhbiBlbXB0eSBvYmplY3QuCgkJCWlmICggYWNjZXB0RGF0YSggb3duZXIgKSApIHsKCgkJCQkvLyBJZiBpdCBpcyBhIG5vZGUgdW5saWtlbHkgdG8gYmUgc3RyaW5naWZ5LWVkIG9yIGxvb3BlZCBvdmVyCgkJCQkvLyB1c2UgcGxhaW4gYXNzaWdubWVudAoJCQkJaWYgKCBvd25lci5ub2RlVHlwZSApIHsKCQkJCQlvd25lclsgdGhpcy5leHBhbmRvIF0gPSB2YWx1ZTsKCgkJCQkvLyBPdGhlcndpc2Ugc2VjdXJlIGl0IGluIGEgbm9uLWVudW1lcmFibGUgcHJvcGVydHkKCQkJCS8vIGNvbmZpZ3VyYWJsZSBtdXN0IGJlIHRydWUgdG8gYWxsb3cgdGhlIHByb3BlcnR5IHRvIGJlCgkJCQkvLyBkZWxldGVkIHdoZW4gZGF0YSBpcyByZW1vdmVkCgkJCQl9IGVsc2UgewoJCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggb3duZXIsIHRoaXMuZXhwYW5kbywgewoJCQkJCQl2YWx1ZTogdmFsdWUsCgkJCQkJCWNvbmZpZ3VyYWJsZTogdHJ1ZQoJCQkJCX0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHZhbHVlOwoJfSwKCXNldDogZnVuY3Rpb24oIG93bmVyLCBkYXRhLCB2YWx1ZSApIHsKCQl2YXIgcHJvcCwKCQkJY2FjaGUgPSB0aGlzLmNhY2hlKCBvd25lciApOwoKCQkvLyBIYW5kbGU6IFsgb3duZXIsIGtleSwgdmFsdWUgXSBhcmdzCgkJLy8gQWx3YXlzIHVzZSBjYW1lbENhc2Uga2V5IChnaC0yMjU3KQoJCWlmICggdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciICkgewoJCQljYWNoZVsgY2FtZWxDYXNlKCBkYXRhICkgXSA9IHZhbHVlOwoKCQkvLyBIYW5kbGU6IFsgb3duZXIsIHsgcHJvcGVydGllcyB9IF0gYXJncwoJCX0gZWxzZSB7CgoJCQkvLyBDb3B5IHRoZSBwcm9wZXJ0aWVzIG9uZS1ieS1vbmUgdG8gdGhlIGNhY2hlIG9iamVjdAoJCQlmb3IgKCBwcm9wIGluIGRhdGEgKSB7CgkJCQljYWNoZVsgY2FtZWxDYXNlKCBwcm9wICkgXSA9IGRhdGFbIHByb3AgXTsKCQkJfQoJCX0KCQlyZXR1cm4gY2FjaGU7Cgl9LAoJZ2V0OiBmdW5jdGlvbiggb3duZXIsIGtleSApIHsKCQlyZXR1cm4ga2V5ID09PSB1bmRlZmluZWQgPwoJCQl0aGlzLmNhY2hlKCBvd25lciApIDoKCgkJCS8vIEFsd2F5cyB1c2UgY2FtZWxDYXNlIGtleSAoZ2gtMjI1NykKCQkJb3duZXJbIHRoaXMuZXhwYW5kbyBdICYmIG93bmVyWyB0aGlzLmV4cGFuZG8gXVsgY2FtZWxDYXNlKCBrZXkgKSBdOwoJfSwKCWFjY2VzczogZnVuY3Rpb24oIG93bmVyLCBrZXksIHZhbHVlICkgewoKCQkvLyBJbiBjYXNlcyB3aGVyZSBlaXRoZXI6CgkJLy8KCQkvLyAgIDEuIE5vIGtleSB3YXMgc3BlY2lmaWVkCgkJLy8gICAyLiBBIHN0cmluZyBrZXkgd2FzIHNwZWNpZmllZCwgYnV0IG5vIHZhbHVlIHByb3ZpZGVkCgkJLy8KCQkvLyBUYWtlIHRoZSAicmVhZCIgcGF0aCBhbmQgYWxsb3cgdGhlIGdldCBtZXRob2QgdG8gZGV0ZXJtaW5lCgkJLy8gd2hpY2ggdmFsdWUgdG8gcmV0dXJuLCByZXNwZWN0aXZlbHkgZWl0aGVyOgoJCS8vCgkJLy8gICAxLiBUaGUgZW50aXJlIGNhY2hlIG9iamVjdAoJCS8vICAgMi4gVGhlIGRhdGEgc3RvcmVkIGF0IHRoZSBrZXkKCQkvLwoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgfHwKCQkJCSggKCBrZXkgJiYgdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgKSB7CgoJCQlyZXR1cm4gdGhpcy5nZXQoIG93bmVyLCBrZXkgKTsKCQl9CgoJCS8vIFdoZW4gdGhlIGtleSBpcyBub3QgYSBzdHJpbmcsIG9yIGJvdGggYSBrZXkgYW5kIHZhbHVlCgkJLy8gYXJlIHNwZWNpZmllZCwgc2V0IG9yIGV4dGVuZCAoZXhpc3Rpbmcgb2JqZWN0cykgd2l0aCBlaXRoZXI6CgkJLy8KCQkvLyAgIDEuIEFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzCgkJLy8gICAyLiBBIGtleSBhbmQgdmFsdWUKCQkvLwoJCXRoaXMuc2V0KCBvd25lciwga2V5LCB2YWx1ZSApOwoKCQkvLyBTaW5jZSB0aGUgInNldCIgcGF0aCBjYW4gaGF2ZSB0d28gcG9zc2libGUgZW50cnkgcG9pbnRzCgkJLy8gcmV0dXJuIHRoZSBleHBlY3RlZCBkYXRhIGJhc2VkIG9uIHdoaWNoIHBhdGggd2FzIHRha2VuWypdCgkJcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IGtleTsKCX0sCglyZW1vdmU6IGZ1bmN0aW9uKCBvd25lciwga2V5ICkgewoJCXZhciBpLAoJCQljYWNoZSA9IG93bmVyWyB0aGlzLmV4cGFuZG8gXTsKCgkJaWYgKCBjYWNoZSA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSAhPT0gdW5kZWZpbmVkICkgewoKCQkJLy8gU3VwcG9ydCBhcnJheSBvciBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG9mIGtleXMKCQkJaWYgKCBBcnJheS5pc0FycmF5KCBrZXkgKSApIHsKCgkJCQkvLyBJZiBrZXkgaXMgYW4gYXJyYXkgb2Yga2V5cy4uLgoJCQkJLy8gV2UgYWx3YXlzIHNldCBjYW1lbENhc2Uga2V5cywgc28gcmVtb3ZlIHRoYXQuCgkJCQlrZXkgPSBrZXkubWFwKCBjYW1lbENhc2UgKTsKCQkJfSBlbHNlIHsKCQkJCWtleSA9IGNhbWVsQ2FzZSgga2V5ICk7CgoJCQkJLy8gSWYgYSBrZXkgd2l0aCB0aGUgc3BhY2VzIGV4aXN0cywgdXNlIGl0LgoJCQkJLy8gT3RoZXJ3aXNlLCBjcmVhdGUgYW4gYXJyYXkgYnkgbWF0Y2hpbmcgbm9uLXdoaXRlc3BhY2UKCQkJCWtleSA9IGtleSBpbiBjYWNoZSA/CgkJCQkJWyBrZXkgXSA6CgkJCQkJKCBrZXkubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbXSApOwoJCQl9CgoJCQlpID0ga2V5Lmxlbmd0aDsKCgkJCXdoaWxlICggaS0tICkgewoJCQkJZGVsZXRlIGNhY2hlWyBrZXlbIGkgXSBdOwoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgdGhlcmUncyBubyBtb3JlIGRhdGEKCQlpZiAoIGtleSA9PT0gdW5kZWZpbmVkIHx8IGpRdWVyeS5pc0VtcHR5T2JqZWN0KCBjYWNoZSApICkgewoKCQkJLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NQoJCQkvLyBXZWJraXQgJiBCbGluayBwZXJmb3JtYW5jZSBzdWZmZXJzIHdoZW4gZGVsZXRpbmcgcHJvcGVydGllcwoJCQkvLyBmcm9tIERPTSBub2Rlcywgc28gc2V0IHRvIHVuZGVmaW5lZCBpbnN0ZWFkCgkJCS8vIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTM3ODYwNyAoYnVnIHJlc3RyaWN0ZWQpCgkJCWlmICggb3duZXIubm9kZVR5cGUgKSB7CgkJCQlvd25lclsgdGhpcy5leHBhbmRvIF0gPSB1bmRlZmluZWQ7CgkJCX0gZWxzZSB7CgkJCQlkZWxldGUgb3duZXJbIHRoaXMuZXhwYW5kbyBdOwoJCQl9CgkJfQoJfSwKCWhhc0RhdGE6IGZ1bmN0aW9uKCBvd25lciApIHsKCQl2YXIgY2FjaGUgPSBvd25lclsgdGhpcy5leHBhbmRvIF07CgkJcmV0dXJuIGNhY2hlICE9PSB1bmRlZmluZWQgJiYgIWpRdWVyeS5pc0VtcHR5T2JqZWN0KCBjYWNoZSApOwoJfQp9Owp2YXIgZGF0YVByaXYgPSBuZXcgRGF0YSgpOwoKdmFyIGRhdGFVc2VyID0gbmV3IERhdGEoKTsKCgoKLy8JSW1wbGVtZW50YXRpb24gU3VtbWFyeQovLwovLwkxLiBFbmZvcmNlIEFQSSBzdXJmYWNlIGFuZCBzZW1hbnRpYyBjb21wYXRpYmlsaXR5IHdpdGggMS45LnggYnJhbmNoCi8vCTIuIEltcHJvdmUgdGhlIG1vZHVsZSdzIG1haW50YWluYWJpbGl0eSBieSByZWR1Y2luZyB0aGUgc3RvcmFnZQovLwkJcGF0aHMgdG8gYSBzaW5nbGUgbWVjaGFuaXNtLgovLwkzLiBVc2UgdGhlIHNhbWUgc2luZ2xlIG1lY2hhbmlzbSB0byBzdXBwb3J0ICJwcml2YXRlIiBhbmQgInVzZXIiIGRhdGEuCi8vCTQuIF9OZXZlcl8gZXhwb3NlICJwcml2YXRlIiBkYXRhIHRvIHVzZXIgY29kZSAoVE9ETzogRHJvcCBfZGF0YSwgX3JlbW92ZURhdGEpCi8vCTUuIEF2b2lkIGV4cG9zaW5nIGltcGxlbWVudGF0aW9uIGRldGFpbHMgb24gdXNlciBvYmplY3RzIChlZy4gZXhwYW5kbyBwcm9wZXJ0aWVzKQovLwk2LiBQcm92aWRlIGEgY2xlYXIgcGF0aCBmb3IgaW1wbGVtZW50YXRpb24gdXBncmFkZSB0byBXZWFrTWFwIGluIDIwMTQKCnZhciByYnJhY2UgPSAvXig/Olx7W1x3XFddKlx9fFxbW1x3XFddKlxdKSQvLAoJcm11bHRpRGFzaCA9IC9bQS1aXS9nOwoKZnVuY3Rpb24gZ2V0RGF0YSggZGF0YSApIHsKCWlmICggZGF0YSA9PT0gInRydWUiICkgewoJCXJldHVybiB0cnVlOwoJfQoKCWlmICggZGF0YSA9PT0gImZhbHNlIiApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJaWYgKCBkYXRhID09PSAibnVsbCIgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKCWlmICggZGF0YSA9PT0gK2RhdGEgKyAiIiApIHsKCQlyZXR1cm4gK2RhdGE7Cgl9CgoJaWYgKCByYnJhY2UudGVzdCggZGF0YSApICkgewoJCXJldHVybiBKU09OLnBhcnNlKCBkYXRhICk7Cgl9CgoJcmV0dXJuIGRhdGE7Cn0KCmZ1bmN0aW9uIGRhdGFBdHRyKCBlbGVtLCBrZXksIGRhdGEgKSB7Cgl2YXIgbmFtZTsKCgkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbnRlcm5hbGx5LCB0cnkgdG8gZmV0Y2ggYW55CgkvLyBkYXRhIGZyb20gdGhlIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUKCWlmICggZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJbmFtZSA9ICJkYXRhLSIgKyBrZXkucmVwbGFjZSggcm11bHRpRGFzaCwgIi0kJiIgKS50b0xvd2VyQ2FzZSgpOwoJCWRhdGEgPSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApOwoKCQlpZiAoIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiApIHsKCQkJdHJ5IHsKCQkJCWRhdGEgPSBnZXREYXRhKCBkYXRhICk7CgkJCX0gY2F0Y2ggKCBlICkge30KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBzZXQgdGhlIGRhdGEgc28gaXQgaXNuJ3QgY2hhbmdlZCBsYXRlcgoJCQlkYXRhVXNlci5zZXQoIGVsZW0sIGtleSwgZGF0YSApOwoJCX0gZWxzZSB7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoJfQoJcmV0dXJuIGRhdGE7Cn0KCmpRdWVyeS5leHRlbmQoIHsKCWhhc0RhdGE6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBkYXRhVXNlci5oYXNEYXRhKCBlbGVtICkgfHwgZGF0YVByaXYuaGFzRGF0YSggZWxlbSApOwoJfSwKCglkYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKCQlyZXR1cm4gZGF0YVVzZXIuYWNjZXNzKCBlbGVtLCBuYW1lLCBkYXRhICk7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWRhdGFVc2VyLnJlbW92ZSggZWxlbSwgbmFtZSApOwoJfSwKCgkvLyBUT0RPOiBOb3cgdGhhdCBhbGwgY2FsbHMgdG8gX2RhdGEgYW5kIF9yZW1vdmVEYXRhIGhhdmUgYmVlbiByZXBsYWNlZAoJLy8gd2l0aCBkaXJlY3QgY2FsbHMgdG8gZGF0YVByaXYgbWV0aG9kcywgdGhlc2UgY2FuIGJlIGRlcHJlY2F0ZWQuCglfZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEgKSB7CgkJcmV0dXJuIGRhdGFQcml2LmFjY2VzcyggZWxlbSwgbmFtZSwgZGF0YSApOwoJfSwKCglfcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJZGF0YVByaXYucmVtb3ZlKCBlbGVtLCBuYW1lICk7Cgl9Cn0gKTsKCmpRdWVyeS5mbi5leHRlbmQoIHsKCWRhdGE6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBpLCBuYW1lLCBkYXRhLAoJCQllbGVtID0gdGhpc1sgMCBdLAoJCQlhdHRycyA9IGVsZW0gJiYgZWxlbS5hdHRyaWJ1dGVzOwoKCQkvLyBHZXRzIGFsbCB2YWx1ZXMKCQlpZiAoIGtleSA9PT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMubGVuZ3RoICkgewoJCQkJZGF0YSA9IGRhdGFVc2VyLmdldCggZWxlbSApOwoKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhZGF0YVByaXYuZ2V0KCBlbGVtLCAiaGFzRGF0YUF0dHJzIiApICkgewoJCQkJCWkgPSBhdHRycy5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgoJCQkJCQkvLyBTdXBwb3J0OiBJRSAxMSBvbmx5CgkJCQkJCS8vIFRoZSBhdHRycyBlbGVtZW50cyBjYW4gYmUgbnVsbCAoIzE0ODk0KQoJCQkJCQlpZiAoIGF0dHJzWyBpIF0gKSB7CgkJCQkJCQluYW1lID0gYXR0cnNbIGkgXS5uYW1lOwoJCQkJCQkJaWYgKCBuYW1lLmluZGV4T2YoICJkYXRhLSIgKSA9PT0gMCApIHsKCQkJCQkJCQluYW1lID0gY2FtZWxDYXNlKCBuYW1lLnNsaWNlKCA1ICkgKTsKCQkJCQkJCQlkYXRhQXR0ciggZWxlbSwgbmFtZSwgZGF0YVsgbmFtZSBdICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQkJZGF0YVByaXYuc2V0KCBlbGVtLCAiaGFzRGF0YUF0dHJzIiwgdHJ1ZSApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gZGF0YTsKCQl9CgoJCS8vIFNldHMgbXVsdGlwbGUgdmFsdWVzCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAib2JqZWN0IiApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQlkYXRhVXNlci5zZXQoIHRoaXMsIGtleSApOwoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciBkYXRhOwoKCQkJLy8gVGhlIGNhbGxpbmcgalF1ZXJ5IG9iamVjdCAoZWxlbWVudCBtYXRjaGVzKSBpcyBub3QgZW1wdHkKCQkJLy8gKGFuZCB0aGVyZWZvcmUgaGFzIGFuIGVsZW1lbnQgYXBwZWFycyBhdCB0aGlzWyAwIF0pIGFuZCB0aGUKCQkJLy8gYHZhbHVlYCBwYXJhbWV0ZXIgd2FzIG5vdCB1bmRlZmluZWQuIEFuIGVtcHR5IGpRdWVyeSBvYmplY3QKCQkJLy8gd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgZm9yIGVsZW0gPSB0aGlzWyAwIF0gd2hpY2ggd2lsbAoJCQkvLyB0aHJvdyBhbiBleGNlcHRpb24gaWYgYW4gYXR0ZW1wdCB0byByZWFkIGEgZGF0YSBjYWNoZSBpcyBtYWRlLgoJCQlpZiAoIGVsZW0gJiYgdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkvLyBBdHRlbXB0IHRvIGdldCBkYXRhIGZyb20gdGhlIGNhY2hlCgkJCQkvLyBUaGUga2V5IHdpbGwgYWx3YXlzIGJlIGNhbWVsQ2FzZWQgaW4gRGF0YQoJCQkJZGF0YSA9IGRhdGFVc2VyLmdldCggZWxlbSwga2V5ICk7CgkJCQlpZiAoIGRhdGEgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0KCgkJCQkvLyBBdHRlbXB0IHRvICJkaXNjb3ZlciIgdGhlIGRhdGEgaW4KCQkJCS8vIEhUTUw1IGN1c3RvbSBkYXRhLSogYXR0cnMKCQkJCWRhdGEgPSBkYXRhQXR0ciggZWxlbSwga2V5ICk7CgkJCQlpZiAoIGRhdGEgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0KCgkJCQkvLyBXZSB0cmllZCByZWFsbHkgaGFyZCwgYnV0IHRoZSBkYXRhIGRvZXNuJ3QgZXhpc3QuCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFNldCB0aGUgZGF0YS4uLgoJCQl0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoKCQkJCS8vIFdlIGFsd2F5cyBzdG9yZSB0aGUgY2FtZWxDYXNlZCBrZXkKCQkJCWRhdGFVc2VyLnNldCggdGhpcywga2V5LCB2YWx1ZSApOwoJCQl9ICk7CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxLCBudWxsLCB0cnVlICk7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBrZXkgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWRhdGFVc2VyLnJlbW92ZSggdGhpcywga2V5ICk7CgkJfSApOwoJfQp9ICk7CgoKalF1ZXJ5LmV4dGVuZCggewoJcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBkYXRhICkgewoJCXZhciBxdWV1ZTsKCgkJaWYgKCBlbGVtICkgewoJCQl0eXBlID0gKCB0eXBlIHx8ICJmeCIgKSArICJxdWV1ZSI7CgkJCXF1ZXVlID0gZGF0YVByaXYuZ2V0KCBlbGVtLCB0eXBlICk7CgoJCQkvLyBTcGVlZCB1cCBkZXF1ZXVlIGJ5IGdldHRpbmcgb3V0IHF1aWNrbHkgaWYgdGhpcyBpcyBqdXN0IGEgbG9va3VwCgkJCWlmICggZGF0YSApIHsKCQkJCWlmICggIXF1ZXVlIHx8IEFycmF5LmlzQXJyYXkoIGRhdGEgKSApIHsKCQkJCQlxdWV1ZSA9IGRhdGFQcml2LmFjY2VzcyggZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheSggZGF0YSApICk7CgkJCQl9IGVsc2UgewoJCQkJCXF1ZXVlLnB1c2goIGRhdGEgKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcXVldWUgfHwgW107CgkJfQoJfSwKCglkZXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIGVsZW0sIHR5cGUgKSwKCQkJc3RhcnRMZW5ndGggPSBxdWV1ZS5sZW5ndGgsCgkJCWZuID0gcXVldWUuc2hpZnQoKSwKCQkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sIHR5cGUgKSwKCQkJbmV4dCA9IGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LmRlcXVldWUoIGVsZW0sIHR5cGUgKTsKCQkJfTsKCgkJLy8gSWYgdGhlIGZ4IHF1ZXVlIGlzIGRlcXVldWVkLCBhbHdheXMgcmVtb3ZlIHRoZSBwcm9ncmVzcyBzZW50aW5lbAoJCWlmICggZm4gPT09ICJpbnByb2dyZXNzIiApIHsKCQkJZm4gPSBxdWV1ZS5zaGlmdCgpOwoJCQlzdGFydExlbmd0aC0tOwoJCX0KCgkJaWYgKCBmbiApIHsKCgkJCS8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKCQkJLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAoJCQlpZiAoIHR5cGUgPT09ICJmeCIgKSB7CgkJCQlxdWV1ZS51bnNoaWZ0KCAiaW5wcm9ncmVzcyIgKTsKCQkJfQoKCQkJLy8gQ2xlYXIgdXAgdGhlIGxhc3QgcXVldWUgc3RvcCBmdW5jdGlvbgoJCQlkZWxldGUgaG9va3Muc3RvcDsKCQkJZm4uY2FsbCggZWxlbSwgbmV4dCwgaG9va3MgKTsKCQl9CgoJCWlmICggIXN0YXJ0TGVuZ3RoICYmIGhvb2tzICkgewoJCQlob29rcy5lbXB0eS5maXJlKCk7CgkJfQoJfSwKCgkvLyBOb3QgcHVibGljIC0gZ2VuZXJhdGUgYSBxdWV1ZUhvb2tzIG9iamVjdCwgb3IgcmV0dXJuIHRoZSBjdXJyZW50IG9uZQoJX3F1ZXVlSG9va3M6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgewoJCXZhciBrZXkgPSB0eXBlICsgInF1ZXVlSG9va3MiOwoJCXJldHVybiBkYXRhUHJpdi5nZXQoIGVsZW0sIGtleSApIHx8IGRhdGFQcml2LmFjY2VzcyggZWxlbSwga2V5LCB7CgkJCWVtcHR5OiBqUXVlcnkuQ2FsbGJhY2tzKCAib25jZSBtZW1vcnkiICkuYWRkKCBmdW5jdGlvbigpIHsKCQkJCWRhdGFQcml2LnJlbW92ZSggZWxlbSwgWyB0eXBlICsgInF1ZXVlIiwga2V5IF0gKTsKCQkJfSApCgkJfSApOwoJfQp9ICk7CgpqUXVlcnkuZm4uZXh0ZW5kKCB7CglxdWV1ZTogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJdmFyIHNldHRlciA9IDI7CgoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlkYXRhID0gdHlwZTsKCQkJdHlwZSA9ICJmeCI7CgkJCXNldHRlci0tOwoJCX0KCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgc2V0dGVyICkgewoJCQlyZXR1cm4galF1ZXJ5LnF1ZXVlKCB0aGlzWyAwIF0sIHR5cGUgKTsKCQl9CgoJCXJldHVybiBkYXRhID09PSB1bmRlZmluZWQgPwoJCQl0aGlzIDoKCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgZGF0YSApOwoKCQkJCS8vIEVuc3VyZSBhIGhvb2tzIGZvciB0aGlzIHF1ZXVlCgkJCQlqUXVlcnkuX3F1ZXVlSG9va3MoIHRoaXMsIHR5cGUgKTsKCgkJCQlpZiAoIHR5cGUgPT09ICJmeCIgJiYgcXVldWVbIDAgXSAhPT0gImlucHJvZ3Jlc3MiICkgewoJCQkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJCQl9CgkJCX0gKTsKCX0sCglkZXF1ZXVlOiBmdW5jdGlvbiggdHlwZSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQl9ICk7Cgl9LAoJY2xlYXJRdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCX0sCgoJLy8gR2V0IGEgcHJvbWlzZSByZXNvbHZlZCB3aGVuIHF1ZXVlcyBvZiBhIGNlcnRhaW4gdHlwZQoJLy8gYXJlIGVtcHRpZWQgKGZ4IGlzIHRoZSB0eXBlIGJ5IGRlZmF1bHQpCglwcm9taXNlOiBmdW5jdGlvbiggdHlwZSwgb2JqICkgewoJCXZhciB0bXAsCgkJCWNvdW50ID0gMSwKCQkJZGVmZXIgPSBqUXVlcnkuRGVmZXJyZWQoKSwKCQkJZWxlbWVudHMgPSB0aGlzLAoJCQlpID0gdGhpcy5sZW5ndGgsCgkJCXJlc29sdmUgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggISggLS1jb3VudCApICkgewoJCQkJCWRlZmVyLnJlc29sdmVXaXRoKCBlbGVtZW50cywgWyBlbGVtZW50cyBdICk7CgkJCQl9CgkJCX07CgoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlvYmogPSB0eXBlOwoJCQl0eXBlID0gdW5kZWZpbmVkOwoJCX0KCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQl3aGlsZSAoIGktLSApIHsKCQkJdG1wID0gZGF0YVByaXYuZ2V0KCBlbGVtZW50c1sgaSBdLCB0eXBlICsgInF1ZXVlSG9va3MiICk7CgkJCWlmICggdG1wICYmIHRtcC5lbXB0eSApIHsKCQkJCWNvdW50Kys7CgkJCQl0bXAuZW1wdHkuYWRkKCByZXNvbHZlICk7CgkJCX0KCQl9CgkJcmVzb2x2ZSgpOwoJCXJldHVybiBkZWZlci5wcm9taXNlKCBvYmogKTsKCX0KfSApOwp2YXIgcG51bSA9ICggL1srLV0/KD86XGQqXC58KVxkKyg/OltlRV1bKy1dP1xkK3wpLyApLnNvdXJjZTsKCnZhciByY3NzTnVtID0gbmV3IFJlZ0V4cCggIl4oPzooWystXSk9fCkoIiArIHBudW0gKyAiKShbYS16JV0qKSQiLCAiaSIgKTsKCgp2YXIgY3NzRXhwYW5kID0gWyAiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0IiBdOwoKdmFyIGRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgoKCXZhciBpc0F0dGFjaGVkID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOwoJCX0sCgkJY29tcG9zZWQgPSB7IGNvbXBvc2VkOiB0cnVlIH07CgoJLy8gU3VwcG9ydDogSUUgOSAtIDExKywgRWRnZSAxMiAtIDE4KywgaU9TIDEwLjAgLSAxMC4yIG9ubHkKCS8vIENoZWNrIGF0dGFjaG1lbnQgYWNyb3NzIHNoYWRvdyBET00gYm91bmRhcmllcyB3aGVuIHBvc3NpYmxlIChnaC0zNTA0KQoJLy8gU3VwcG9ydDogaU9TIDEwLjAtMTAuMiBvbmx5CgkvLyBFYXJseSBpT1MgMTAgdmVyc2lvbnMgc3VwcG9ydCBgYXR0YWNoU2hhZG93YCBidXQgbm90IGBnZXRSb290Tm9kZWAsCgkvLyBsZWFkaW5nIHRvIGVycm9ycy4gV2UgbmVlZCB0byBjaGVjayBmb3IgYGdldFJvb3ROb2RlYC4KCWlmICggZG9jdW1lbnRFbGVtZW50LmdldFJvb3ROb2RlICkgewoJCWlzQXR0YWNoZWQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICkgfHwKCQkJCWVsZW0uZ2V0Um9vdE5vZGUoIGNvbXBvc2VkICkgPT09IGVsZW0ub3duZXJEb2N1bWVudDsKCQl9OwoJfQp2YXIgaXNIaWRkZW5XaXRoaW5UcmVlID0gZnVuY3Rpb24oIGVsZW0sIGVsICkgewoKCQkvLyBpc0hpZGRlbldpdGhpblRyZWUgbWlnaHQgYmUgY2FsbGVkIGZyb20galF1ZXJ5I2ZpbHRlciBmdW5jdGlvbjsKCQkvLyBpbiB0aGF0IGNhc2UsIGVsZW1lbnQgd2lsbCBiZSBzZWNvbmQgYXJndW1lbnQKCQllbGVtID0gZWwgfHwgZWxlbTsKCgkJLy8gSW5saW5lIHN0eWxlIHRydW1wcyBhbGwKCQlyZXR1cm4gZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgfHwKCQkJZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAiIiAmJgoKCQkJLy8gT3RoZXJ3aXNlLCBjaGVjayBjb21wdXRlZCBzdHlsZQoJCQkvLyBTdXBwb3J0OiBGaXJlZm94IDw9NDMgLSA0NQoJCQkvLyBEaXNjb25uZWN0ZWQgZWxlbWVudHMgY2FuIGhhdmUgY29tcHV0ZWQgZGlzcGxheTogbm9uZSwgc28gZmlyc3QgY29uZmlybSB0aGF0IGVsZW0gaXMKCQkJLy8gaW4gdGhlIGRvY3VtZW50LgoJCQlpc0F0dGFjaGVkKCBlbGVtICkgJiYKCgkJCWpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSI7Cgl9OwoKdmFyIHN3YXAgPSBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgY2FsbGJhY2ssIGFyZ3MgKSB7Cgl2YXIgcmV0LCBuYW1lLAoJCW9sZCA9IHt9OwoKCS8vIFJlbWVtYmVyIHRoZSBvbGQgdmFsdWVzLCBhbmQgaW5zZXJ0IHRoZSBuZXcgb25lcwoJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCW9sZFsgbmFtZSBdID0gZWxlbS5zdHlsZVsgbmFtZSBdOwoJCWVsZW0uc3R5bGVbIG5hbWUgXSA9IG9wdGlvbnNbIG5hbWUgXTsKCX0KCglyZXQgPSBjYWxsYmFjay5hcHBseSggZWxlbSwgYXJncyB8fCBbXSApOwoKCS8vIFJldmVydCB0aGUgb2xkIHZhbHVlcwoJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCWVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwoJfQoKCXJldHVybiByZXQ7Cn07CgoKCgpmdW5jdGlvbiBhZGp1c3RDU1MoIGVsZW0sIHByb3AsIHZhbHVlUGFydHMsIHR3ZWVuICkgewoJdmFyIGFkanVzdGVkLCBzY2FsZSwKCQltYXhJdGVyYXRpb25zID0gMjAsCgkJY3VycmVudFZhbHVlID0gdHdlZW4gPwoJCQlmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0d2Vlbi5jdXIoKTsKCQkJfSA6CgkJCWZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sIHByb3AsICIiICk7CgkJCX0sCgkJaW5pdGlhbCA9IGN1cnJlbnRWYWx1ZSgpLAoJCXVuaXQgPSB2YWx1ZVBhcnRzICYmIHZhbHVlUGFydHNbIDMgXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApLAoKCQkvLyBTdGFydGluZyB2YWx1ZSBjb21wdXRhdGlvbiBpcyByZXF1aXJlZCBmb3IgcG90ZW50aWFsIHVuaXQgbWlzbWF0Y2hlcwoJCWluaXRpYWxJblVuaXQgPSBlbGVtLm5vZGVUeXBlICYmCgkJCSggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdIHx8IHVuaXQgIT09ICJweCIgJiYgK2luaXRpYWwgKSAmJgoJCQlyY3NzTnVtLmV4ZWMoIGpRdWVyeS5jc3MoIGVsZW0sIHByb3AgKSApOwoKCWlmICggaW5pdGlhbEluVW5pdCAmJiBpbml0aWFsSW5Vbml0WyAzIF0gIT09IHVuaXQgKSB7CgoJCS8vIFN1cHBvcnQ6IEZpcmVmb3ggPD01NAoJCS8vIEhhbHZlIHRoZSBpdGVyYXRpb24gdGFyZ2V0IHZhbHVlIHRvIHByZXZlbnQgaW50ZXJmZXJlbmNlIGZyb20gQ1NTIHVwcGVyIGJvdW5kcyAoZ2gtMjE0NCkKCQlpbml0aWFsID0gaW5pdGlhbCAvIDI7CgoJCS8vIFRydXN0IHVuaXRzIHJlcG9ydGVkIGJ5IGpRdWVyeS5jc3MKCQl1bml0ID0gdW5pdCB8fCBpbml0aWFsSW5Vbml0WyAzIF07CgoJCS8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CgkJaW5pdGlhbEluVW5pdCA9ICtpbml0aWFsIHx8IDE7CgoJCXdoaWxlICggbWF4SXRlcmF0aW9ucy0tICkgewoKCQkJLy8gRXZhbHVhdGUgYW5kIHVwZGF0ZSBvdXIgYmVzdCBndWVzcyAoZG91YmxpbmcgZ3Vlc3NlcyB0aGF0IHplcm8gb3V0KS4KCQkJLy8gRmluaXNoIGlmIHRoZSBzY2FsZSBlcXVhbHMgb3IgY3Jvc3NlcyAxIChtYWtpbmcgdGhlIG9sZCpuZXcgcHJvZHVjdCBub24tcG9zaXRpdmUpLgoJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AsIGluaXRpYWxJblVuaXQgKyB1bml0ICk7CgkJCWlmICggKCAxIC0gc2NhbGUgKSAqICggMSAtICggc2NhbGUgPSBjdXJyZW50VmFsdWUoKSAvIGluaXRpYWwgfHwgMC41ICkgKSA8PSAwICkgewoJCQkJbWF4SXRlcmF0aW9ucyA9IDA7CgkJCX0KCQkJaW5pdGlhbEluVW5pdCA9IGluaXRpYWxJblVuaXQgLyBzY2FsZTsKCgkJfQoKCQlpbml0aWFsSW5Vbml0ID0gaW5pdGlhbEluVW5pdCAqIDI7CgkJalF1ZXJ5LnN0eWxlKCBlbGVtLCBwcm9wLCBpbml0aWFsSW5Vbml0ICsgdW5pdCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uCgkJdmFsdWVQYXJ0cyA9IHZhbHVlUGFydHMgfHwgW107Cgl9CgoJaWYgKCB2YWx1ZVBhcnRzICkgewoJCWluaXRpYWxJblVuaXQgPSAraW5pdGlhbEluVW5pdCB8fCAraW5pdGlhbCB8fCAwOwoKCQkvLyBBcHBseSByZWxhdGl2ZSBvZmZzZXQgKCs9Ly09KSBpZiBzcGVjaWZpZWQKCQlhZGp1c3RlZCA9IHZhbHVlUGFydHNbIDEgXSA/CgkJCWluaXRpYWxJblVuaXQgKyAoIHZhbHVlUGFydHNbIDEgXSArIDEgKSAqIHZhbHVlUGFydHNbIDIgXSA6CgkJCSt2YWx1ZVBhcnRzWyAyIF07CgkJaWYgKCB0d2VlbiApIHsKCQkJdHdlZW4udW5pdCA9IHVuaXQ7CgkJCXR3ZWVuLnN0YXJ0ID0gaW5pdGlhbEluVW5pdDsKCQkJdHdlZW4uZW5kID0gYWRqdXN0ZWQ7CgkJfQoJfQoJcmV0dXJuIGFkanVzdGVkOwp9CgoKdmFyIGRlZmF1bHREaXNwbGF5TWFwID0ge307CgpmdW5jdGlvbiBnZXREZWZhdWx0RGlzcGxheSggZWxlbSApIHsKCXZhciB0ZW1wLAoJCWRvYyA9IGVsZW0ub3duZXJEb2N1bWVudCwKCQlub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUsCgkJZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5TWFwWyBub2RlTmFtZSBdOwoKCWlmICggZGlzcGxheSApIHsKCQlyZXR1cm4gZGlzcGxheTsKCX0KCgl0ZW1wID0gZG9jLmJvZHkuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVFbGVtZW50KCBub2RlTmFtZSApICk7CglkaXNwbGF5ID0galF1ZXJ5LmNzcyggdGVtcCwgImRpc3BsYXkiICk7CgoJdGVtcC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0ZW1wICk7CgoJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgKSB7CgkJZGlzcGxheSA9ICJibG9jayI7Cgl9CglkZWZhdWx0RGlzcGxheU1hcFsgbm9kZU5hbWUgXSA9IGRpc3BsYXk7CgoJcmV0dXJuIGRpc3BsYXk7Cn0KCmZ1bmN0aW9uIHNob3dIaWRlKCBlbGVtZW50cywgc2hvdyApIHsKCXZhciBkaXNwbGF5LCBlbGVtLAoJCXZhbHVlcyA9IFtdLAoJCWluZGV4ID0gMCwKCQlsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgoJLy8gRGV0ZXJtaW5lIG5ldyBkaXNwbGF5IHZhbHVlIGZvciBlbGVtZW50cyB0aGF0IG5lZWQgdG8gY2hhbmdlCglmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCWVsZW0gPSBlbGVtZW50c1sgaW5kZXggXTsKCQlpZiAoICFlbGVtLnN0eWxlICkgewoJCQljb250aW51ZTsKCQl9CgoJCWRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CgkJaWYgKCBzaG93ICkgewoKCQkJLy8gU2luY2Ugd2UgZm9yY2UgdmlzaWJpbGl0eSB1cG9uIGNhc2NhZGUtaGlkZGVuIGVsZW1lbnRzLCBhbiBpbW1lZGlhdGUgKGFuZCBzbG93KQoJCQkvLyBjaGVjayBpcyByZXF1aXJlZCBpbiB0aGlzIGZpcnN0IGxvb3AgdW5sZXNzIHdlIGhhdmUgYSBub25lbXB0eSBkaXNwbGF5IHZhbHVlIChlaXRoZXIKCQkJLy8gaW5saW5lIG9yIGFib3V0LXRvLWJlLXJlc3RvcmVkKQoJCQlpZiAoIGRpc3BsYXkgPT09ICJub25lIiApIHsKCQkJCXZhbHVlc1sgaW5kZXggXSA9IGRhdGFQcml2LmdldCggZWxlbSwgImRpc3BsYXkiICkgfHwgbnVsbDsKCQkJCWlmICggIXZhbHVlc1sgaW5kZXggXSApIHsKCQkJCQllbGVtLnN0eWxlLmRpc3BsYXkgPSAiIjsKCQkJCX0KCQkJfQoJCQlpZiAoIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgJiYgaXNIaWRkZW5XaXRoaW5UcmVlKCBlbGVtICkgKSB7CgkJCQl2YWx1ZXNbIGluZGV4IF0gPSBnZXREZWZhdWx0RGlzcGxheSggZWxlbSApOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCBkaXNwbGF5ICE9PSAibm9uZSIgKSB7CgkJCQl2YWx1ZXNbIGluZGV4IF0gPSAibm9uZSI7CgoJCQkJLy8gUmVtZW1iZXIgd2hhdCB3ZSdyZSBvdmVyd3JpdGluZwoJCQkJZGF0YVByaXYuc2V0KCBlbGVtLCAiZGlzcGxheSIsIGRpc3BsYXkgKTsKCQkJfQoJCX0KCX0KCgkvLyBTZXQgdGhlIGRpc3BsYXkgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AgdG8gYXZvaWQgY29uc3RhbnQgcmVmbG93Cglmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCWlmICggdmFsdWVzWyBpbmRleCBdICE9IG51bGwgKSB7CgkJCWVsZW1lbnRzWyBpbmRleCBdLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZXNbIGluZGV4IF07CgkJfQoJfQoKCXJldHVybiBlbGVtZW50czsKfQoKalF1ZXJ5LmZuLmV4dGVuZCggewoJc2hvdzogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHNob3dIaWRlKCB0aGlzLCB0cnVlICk7Cgl9LAoJaGlkZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHNob3dIaWRlKCB0aGlzICk7Cgl9LAoJdG9nZ2xlOiBmdW5jdGlvbiggc3RhdGUgKSB7CgkJaWYgKCB0eXBlb2Ygc3RhdGUgPT09ICJib29sZWFuIiApIHsKCQkJcmV0dXJuIHN0YXRlID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlpZiAoIGlzSGlkZGVuV2l0aGluVHJlZSggdGhpcyApICkgewoJCQkJalF1ZXJ5KCB0aGlzICkuc2hvdygpOwoJCQl9IGVsc2UgewoJCQkJalF1ZXJ5KCB0aGlzICkuaGlkZSgpOwoJCQl9CgkJfSApOwoJfQp9ICk7CnZhciByY2hlY2thYmxlVHlwZSA9ICggL14oPzpjaGVja2JveHxyYWRpbykkL2kgKTsKCnZhciBydGFnTmFtZSA9ICggLzwoW2Etel1bXlwvXDA+XHgyMFx0XHJcblxmXSopL2kgKTsKCnZhciByc2NyaXB0VHlwZSA9ICggL14kfF5tb2R1bGUkfFwvKD86amF2YXxlY21hKXNjcmlwdC9pICk7CgoKCi8vIFdlIGhhdmUgdG8gY2xvc2UgdGhlc2UgdGFncyB0byBzdXBwb3J0IFhIVE1MICgjMTMyMDApCnZhciB3cmFwTWFwID0gewoKCS8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CglvcHRpb246IFsgMSwgIjxzZWxlY3QgbXVsdGlwbGU9J211bHRpcGxlJz4iLCAiPC9zZWxlY3Q+IiBdLAoKCS8vIFhIVE1MIHBhcnNlcnMgZG8gbm90IG1hZ2ljYWxseSBpbnNlcnQgZWxlbWVudHMgaW4gdGhlCgkvLyBzYW1lIHdheSB0aGF0IHRhZyBzb3VwIHBhcnNlcnMgZG8uIFNvIHdlIGNhbm5vdCBzaG9ydGVuCgkvLyB0aGlzIGJ5IG9taXR0aW5nIDx0Ym9keT4gb3Igb3RoZXIgcmVxdWlyZWQgZWxlbWVudHMuCgl0aGVhZDogWyAxLCAiPHRhYmxlPiIsICI8L3RhYmxlPiIgXSwKCWNvbDogWyAyLCAiPHRhYmxlPjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwKCXRyOiBbIDIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+IiBdLAoJdGQ6IFsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0sCgoJX2RlZmF1bHQ6IFsgMCwgIiIsICIiIF0KfTsKCi8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CndyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKCndyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CndyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKCmZ1bmN0aW9uIGdldEFsbCggY29udGV4dCwgdGFnICkgewoKCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExIG9ubHkKCS8vIFVzZSB0eXBlb2YgdG8gYXZvaWQgemVyby1hcmd1bWVudCBtZXRob2QgaW52b2NhdGlvbiBvbiBob3N0IG9iamVjdHMgKCMxNTE1MSkKCXZhciByZXQ7CgoJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgKSB7CgkJcmV0ID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggdGFnIHx8ICIqIiApOwoKCX0gZWxzZSBpZiAoIHR5cGVvZiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwgIT09ICJ1bmRlZmluZWQiICkgewoJCXJldCA9IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnIHx8ICIqIiApOwoKCX0gZWxzZSB7CgkJcmV0ID0gW107Cgl9CgoJaWYgKCB0YWcgPT09IHVuZGVmaW5lZCB8fCB0YWcgJiYgbm9kZU5hbWUoIGNvbnRleHQsIHRhZyApICkgewoJCXJldHVybiBqUXVlcnkubWVyZ2UoIFsgY29udGV4dCBdLCByZXQgKTsKCX0KCglyZXR1cm4gcmV0Owp9CgoKLy8gTWFyayBzY3JpcHRzIGFzIGhhdmluZyBhbHJlYWR5IGJlZW4gZXZhbHVhdGVkCmZ1bmN0aW9uIHNldEdsb2JhbEV2YWwoIGVsZW1zLCByZWZFbGVtZW50cyApIHsKCXZhciBpID0gMCwKCQlsID0gZWxlbXMubGVuZ3RoOwoKCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQlkYXRhUHJpdi5zZXQoCgkJCWVsZW1zWyBpIF0sCgkJCSJnbG9iYWxFdmFsIiwKCQkJIXJlZkVsZW1lbnRzIHx8IGRhdGFQcml2LmdldCggcmVmRWxlbWVudHNbIGkgXSwgImdsb2JhbEV2YWwiICkKCQkpOwoJfQp9CgoKdmFyIHJodG1sID0gLzx8JiM/XHcrOy87CgpmdW5jdGlvbiBidWlsZEZyYWdtZW50KCBlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uLCBpZ25vcmVkICkgewoJdmFyIGVsZW0sIHRtcCwgdGFnLCB3cmFwLCBhdHRhY2hlZCwgaiwKCQlmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCW5vZGVzID0gW10sCgkJaSA9IDAsCgkJbCA9IGVsZW1zLmxlbmd0aDsKCglmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJZWxlbSA9IGVsZW1zWyBpIF07CgoJCWlmICggZWxlbSB8fCBlbGVtID09PSAwICkgewoKCQkJLy8gQWRkIG5vZGVzIGRpcmVjdGx5CgkJCWlmICggdG9UeXBlKCBlbGVtICkgPT09ICJvYmplY3QiICkgewoKCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQoJCQkJLy8gcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdAoJCQkJalF1ZXJ5Lm1lcmdlKCBub2RlcywgZWxlbS5ub2RlVHlwZSA/IFsgZWxlbSBdIDogZWxlbSApOwoKCQkJLy8gQ29udmVydCBub24taHRtbCBpbnRvIGEgdGV4dCBub2RlCgkJCX0gZWxzZSBpZiAoICFyaHRtbC50ZXN0KCBlbGVtICkgKSB7CgkJCQlub2Rlcy5wdXNoKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBlbGVtICkgKTsKCgkJCS8vIENvbnZlcnQgaHRtbCBpbnRvIERPTSBub2RlcwoJCQl9IGVsc2UgewoJCQkJdG1wID0gdG1wIHx8IGZyYWdtZW50LmFwcGVuZENoaWxkKCBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkgKTsKCgkJCQkvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uCgkJCQl0YWcgPSAoIHJ0YWdOYW1lLmV4ZWMoIGVsZW0gKSB8fCBbICIiLCAiIiBdIClbIDEgXS50b0xvd2VyQ2FzZSgpOwoJCQkJd3JhcCA9IHdyYXBNYXBbIHRhZyBdIHx8IHdyYXBNYXAuX2RlZmF1bHQ7CgkJCQl0bXAuaW5uZXJIVE1MID0gd3JhcFsgMSBdICsgalF1ZXJ5Lmh0bWxQcmVmaWx0ZXIoIGVsZW0gKSArIHdyYXBbIDIgXTsKCgkJCQkvLyBEZXNjZW5kIHRocm91Z2ggd3JhcHBlcnMgdG8gdGhlIHJpZ2h0IGNvbnRlbnQKCQkJCWogPSB3cmFwWyAwIF07CgkJCQl3aGlsZSAoIGotLSApIHsKCQkJCQl0bXAgPSB0bXAubGFzdENoaWxkOwoJCQkJfQoKCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQoJCQkJLy8gcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdAoJCQkJalF1ZXJ5Lm1lcmdlKCBub2RlcywgdG1wLmNoaWxkTm9kZXMgKTsKCgkJCQkvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lcgoJCQkJdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCgkJCQkvLyBFbnN1cmUgdGhlIGNyZWF0ZWQgbm9kZXMgYXJlIG9ycGhhbmVkICgjMTIzOTIpCgkJCQl0bXAudGV4dENvbnRlbnQgPSAiIjsKCQkJfQoJCX0KCX0KCgkvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CglmcmFnbWVudC50ZXh0Q29udGVudCA9ICIiOwoKCWkgPSAwOwoJd2hpbGUgKCAoIGVsZW0gPSBub2Rlc1sgaSsrIF0gKSApIHsKCgkJLy8gU2tpcCBlbGVtZW50cyBhbHJlYWR5IGluIHRoZSBjb250ZXh0IGNvbGxlY3Rpb24gKHRyYWMtNDA4NykKCQlpZiAoIHNlbGVjdGlvbiAmJiBqUXVlcnkuaW5BcnJheSggZWxlbSwgc2VsZWN0aW9uICkgPiAtMSApIHsKCQkJaWYgKCBpZ25vcmVkICkgewoJCQkJaWdub3JlZC5wdXNoKCBlbGVtICk7CgkJCX0KCQkJY29udGludWU7CgkJfQoKCQlhdHRhY2hlZCA9IGlzQXR0YWNoZWQoIGVsZW0gKTsKCgkJLy8gQXBwZW5kIHRvIGZyYWdtZW50CgkJdG1wID0gZ2V0QWxsKCBmcmFnbWVudC5hcHBlbmRDaGlsZCggZWxlbSApLCAic2NyaXB0IiApOwoKCQkvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CgkJaWYgKCBhdHRhY2hlZCApIHsKCQkJc2V0R2xvYmFsRXZhbCggdG1wICk7CgkJfQoKCQkvLyBDYXB0dXJlIGV4ZWN1dGFibGVzCgkJaWYgKCBzY3JpcHRzICkgewoJCQlqID0gMDsKCQkJd2hpbGUgKCAoIGVsZW0gPSB0bXBbIGorKyBdICkgKSB7CgkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIGVsZW0udHlwZSB8fCAiIiApICkgewoJCQkJCXNjcmlwdHMucHVzaCggZWxlbSApOwoJCQkJfQoJCQl9CgkJfQoJfQoKCXJldHVybiBmcmFnbWVudDsKfQoKCiggZnVuY3Rpb24oKSB7Cgl2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJZGl2ID0gZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkgKSwKCQlpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJpbnB1dCIgKTsKCgkvLyBTdXBwb3J0OiBBbmRyb2lkIDQuMCAtIDQuMyBvbmx5CgkvLyBDaGVjayBzdGF0ZSBsb3N0IGlmIHRoZSBuYW1lIGlzIHNldCAoIzExMjE3KQoJLy8gU3VwcG9ydDogV2luZG93cyBXZWIgQXBwcyAoV1dBKQoJLy8gYG5hbWVgIGFuZCBgdHlwZWAgbXVzdCB1c2UgLnNldEF0dHJpYnV0ZSBmb3IgV1dBICgjMTQ5MDEpCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgInJhZGlvIiApOwoJaW5wdXQuc2V0QXR0cmlidXRlKCAiY2hlY2tlZCIsICJjaGVja2VkIiApOwoJaW5wdXQuc2V0QXR0cmlidXRlKCAibmFtZSIsICJ0IiApOwoKCWRpdi5hcHBlbmRDaGlsZCggaW5wdXQgKTsKCgkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4xIG9ubHkKCS8vIE9sZGVyIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwoJc3VwcG9ydC5jaGVja0Nsb25lID0gZGl2LmNsb25lTm9kZSggdHJ1ZSApLmNsb25lTm9kZSggdHJ1ZSApLmxhc3RDaGlsZC5jaGVja2VkOwoKCS8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQoJLy8gTWFrZSBzdXJlIHRleHRhcmVhIChhbmQgY2hlY2tib3gpIGRlZmF1bHRWYWx1ZSBpcyBwcm9wZXJseSBjbG9uZWQKCWRpdi5pbm5lckhUTUwgPSAiPHRleHRhcmVhPng8L3RleHRhcmVhPiI7CglzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkID0gISFkaXYuY2xvbmVOb2RlKCB0cnVlICkubGFzdENoaWxkLmRlZmF1bHRWYWx1ZTsKfSApKCk7CgoKdmFyCglya2V5RXZlbnQgPSAvXmtleS8sCglybW91c2VFdmVudCA9IC9eKD86bW91c2V8cG9pbnRlcnxjb250ZXh0bWVudXxkcmFnfGRyb3ApfGNsaWNrLywKCXJ0eXBlbmFtZXNwYWNlID0gL14oW14uXSopKD86XC4oLispfCkvOwoKZnVuY3Rpb24gcmV0dXJuVHJ1ZSgpIHsKCXJldHVybiB0cnVlOwp9CgpmdW5jdGlvbiByZXR1cm5GYWxzZSgpIHsKCXJldHVybiBmYWxzZTsKfQoKLy8gU3VwcG9ydDogSUUgPD05IC0gMTErCi8vIGZvY3VzKCkgYW5kIGJsdXIoKSBhcmUgYXN5bmNocm9ub3VzLCBleGNlcHQgd2hlbiB0aGV5IGFyZSBuby1vcC4KLy8gU28gZXhwZWN0IGZvY3VzIHRvIGJlIHN5bmNocm9ub3VzIHdoZW4gdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSBhY3RpdmUsCi8vIGFuZCBibHVyIHRvIGJlIHN5bmNocm9ub3VzIHdoZW4gdGhlIGVsZW1lbnQgaXMgbm90IGFscmVhZHkgYWN0aXZlLgovLyAoZm9jdXMgYW5kIGJsdXIgYXJlIGFsd2F5cyBzeW5jaHJvbm91cyBpbiBvdGhlciBzdXBwb3J0ZWQgYnJvd3NlcnMsCi8vIHRoaXMganVzdCBkZWZpbmVzIHdoZW4gd2UgY2FuIGNvdW50IG9uIGl0KS4KZnVuY3Rpb24gZXhwZWN0U3luYyggZWxlbSwgdHlwZSApIHsKCXJldHVybiAoIGVsZW0gPT09IHNhZmVBY3RpdmVFbGVtZW50KCkgKSA9PT0gKCB0eXBlID09PSAiZm9jdXMiICk7Cn0KCi8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5Ci8vIEFjY2Vzc2luZyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGNhbiB0aHJvdyB1bmV4cGVjdGVkbHkKLy8gaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzkzCmZ1bmN0aW9uIHNhZmVBY3RpdmVFbGVtZW50KCkgewoJdHJ5IHsKCQlyZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCX0gY2F0Y2ggKCBlcnIgKSB7IH0KfQoKZnVuY3Rpb24gb24oIGVsZW0sIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIG9uZSApIHsKCXZhciBvcmlnRm4sIHR5cGU7CgoJLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzCglpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7CgoJCS8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoKCQkJLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQoJCQlkYXRhID0gZGF0YSB8fCBzZWxlY3RvcjsKCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJfQoJCWZvciAoIHR5cGUgaW4gdHlwZXMgKSB7CgkJCW9uKCBlbGVtLCB0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbIHR5cGUgXSwgb25lICk7CgkJfQoJCXJldHVybiBlbGVtOwoJfQoKCWlmICggZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwgKSB7CgoJCS8vICggdHlwZXMsIGZuICkKCQlmbiA9IHNlbGVjdG9yOwoJCWRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKCX0gZWxzZSBpZiAoIGZuID09IG51bGwgKSB7CgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoKCQkJLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkKCQkJZm4gPSBkYXRhOwoJCQlkYXRhID0gdW5kZWZpbmVkOwoJCX0gZWxzZSB7CgoJCQkvLyAoIHR5cGVzLCBkYXRhLCBmbiApCgkJCWZuID0gZGF0YTsKCQkJZGF0YSA9IHNlbGVjdG9yOwoJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9Cgl9CglpZiAoIGZuID09PSBmYWxzZSApIHsKCQlmbiA9IHJldHVybkZhbHNlOwoJfSBlbHNlIGlmICggIWZuICkgewoJCXJldHVybiBlbGVtOwoJfQoKCWlmICggb25lID09PSAxICkgewoJCW9yaWdGbiA9IGZuOwoJCWZuID0gZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCgkJCWpRdWVyeSgpLm9mZiggZXZlbnQgKTsKCQkJcmV0dXJuIG9yaWdGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfTsKCgkJLy8gVXNlIHNhbWUgZ3VpZCBzbyBjYWxsZXIgY2FuIHJlbW92ZSB1c2luZyBvcmlnRm4KCQlmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsKCX0KCXJldHVybiBlbGVtLmVhY2goIGZ1bmN0aW9uKCkgewoJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IgKTsKCX0gKTsKfQoKLyoKICogSGVscGVyIGZ1bmN0aW9ucyBmb3IgbWFuYWdpbmcgZXZlbnRzIC0tIG5vdCBwYXJ0IG9mIHRoZSBwdWJsaWMgaW50ZXJmYWNlLgogKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogKi8KalF1ZXJ5LmV2ZW50ID0gewoKCWdsb2JhbDoge30sCgoJYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yICkgewoKCQl2YXIgaGFuZGxlT2JqSW4sIGV2ZW50SGFuZGxlLCB0bXAsCgkJCWV2ZW50cywgdCwgaGFuZGxlT2JqLAoJCQlzcGVjaWFsLCBoYW5kbGVycywgdHlwZSwgbmFtZXNwYWNlcywgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0gZGF0YVByaXYuZ2V0KCBlbGVtICk7CgoJCS8vIERvbid0IGF0dGFjaCBldmVudHMgdG8gbm9EYXRhIG9yIHRleHQvY29tbWVudCBub2RlcyAoYnV0IGFsbG93IHBsYWluIG9iamVjdHMpCgkJaWYgKCAhZWxlbURhdGEgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBvYmplY3Qgb2YgY3VzdG9tIGRhdGEgaW4gbGlldSBvZiB0aGUgaGFuZGxlcgoJCWlmICggaGFuZGxlci5oYW5kbGVyICkgewoJCQloYW5kbGVPYmpJbiA9IGhhbmRsZXI7CgkJCWhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwoJCQlzZWxlY3RvciA9IGhhbmRsZU9iakluLnNlbGVjdG9yOwoJCX0KCgkJLy8gRW5zdXJlIHRoYXQgaW52YWxpZCBzZWxlY3RvcnMgdGhyb3cgZXhjZXB0aW9ucyBhdCBhdHRhY2ggdGltZQoJCS8vIEV2YWx1YXRlIGFnYWluc3QgZG9jdW1lbnRFbGVtZW50IGluIGNhc2UgZWxlbSBpcyBhIG5vbi1lbGVtZW50IG5vZGUgKGUuZy4sIGRvY3VtZW50KQoJCWlmICggc2VsZWN0b3IgKSB7CgkJCWpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvciggZG9jdW1lbnRFbGVtZW50LCBzZWxlY3RvciApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGhhbmRsZXIgaGFzIGEgdW5pcXVlIElELCB1c2VkIHRvIGZpbmQvcmVtb3ZlIGl0IGxhdGVyCgkJaWYgKCAhaGFuZGxlci5ndWlkICkgewoJCQloYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwoJCX0KCgkJLy8gSW5pdCB0aGUgZWxlbWVudCdzIGV2ZW50IHN0cnVjdHVyZSBhbmQgbWFpbiBoYW5kbGVyLCBpZiB0aGlzIGlzIHRoZSBmaXJzdAoJCWlmICggISggZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzICkgKSB7CgkJCWV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IHt9OwoJCX0KCQlpZiAoICEoIGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlICkgKSB7CgkJCWV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24oIGUgKSB7CgoJCQkJLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUgPwoJCQkJCWpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseSggZWxlbSwgYXJndW1lbnRzICkgOiB1bmRlZmluZWQ7CgkJCX07CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbICIiIF07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbIHQgXSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbIDEgXTsKCQkJbmFtZXNwYWNlcyA9ICggdG1wWyAyIF0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVGhlcmUgKm11c3QqIGJlIGEgdHlwZSwgbm8gYXR0YWNoaW5nIG5hbWVzcGFjZS1vbmx5IGhhbmRsZXJzCgkJCWlmICggIXR5cGUgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKCQkJLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCgkJCXR5cGUgPSAoIHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlICkgfHwgdHlwZTsKCgkJCS8vIFVwZGF0ZSBzcGVjaWFsIGJhc2VkIG9uIG5ld2x5IHJlc2V0IHR5cGUKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQkvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwoJCQloYW5kbGVPYmogPSBqUXVlcnkuZXh0ZW5kKCB7CgkJCQl0eXBlOiB0eXBlLAoJCQkJb3JpZ1R5cGU6IG9yaWdUeXBlLAoJCQkJZGF0YTogZGF0YSwKCQkJCWhhbmRsZXI6IGhhbmRsZXIsCgkJCQlndWlkOiBoYW5kbGVyLmd1aWQsCgkJCQlzZWxlY3Rvcjogc2VsZWN0b3IsCgkJCQluZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvciApLAoJCQkJbmFtZXNwYWNlOiBuYW1lc3BhY2VzLmpvaW4oICIuIiApCgkJCX0sIGhhbmRsZU9iakluICk7CgoJCQkvLyBJbml0IHRoZSBldmVudCBoYW5kbGVyIHF1ZXVlIGlmIHdlJ3JlIHRoZSBmaXJzdAoJCQlpZiAoICEoIGhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gKSApIHsKCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKCQkJCWhhbmRsZXJzLmRlbGVnYXRlQ291bnQgPSAwOwoKCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQoJCQkJaWYgKCAhc3BlY2lhbC5zZXR1cCB8fAoJCQkJCXNwZWNpYWwuc2V0dXAuY2FsbCggZWxlbSwgZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSA9PT0gZmFsc2UgKSB7CgoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlpZiAoIHNwZWNpYWwuYWRkICkgewoJCQkJc3BlY2lhbC5hZGQuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7CgoJCQkJaWYgKCAhaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCApIHsKCQkJCQloYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwoJCQkJfQoJCQl9CgoJCQkvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udAoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJaGFuZGxlcnMuc3BsaWNlKCBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50KyssIDAsIGhhbmRsZU9iaiApOwoJCQl9IGVsc2UgewoJCQkJaGFuZGxlcnMucHVzaCggaGFuZGxlT2JqICk7CgkJCX0KCgkJCS8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgZXZlciBiZWVuIHVzZWQsIGZvciBldmVudCBvcHRpbWl6YXRpb24KCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdID0gdHJ1ZTsKCQl9CgoJfSwKCgkvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMgKSB7CgoJCXZhciBqLCBvcmlnQ291bnQsIHRtcCwKCQkJZXZlbnRzLCB0LCBoYW5kbGVPYmosCgkJCXNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwKCQkJZWxlbURhdGEgPSBkYXRhUHJpdi5oYXNEYXRhKCBlbGVtICkgJiYgZGF0YVByaXYuZ2V0KCBlbGVtICk7CgoJCWlmICggIWVsZW1EYXRhIHx8ICEoIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyApICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBPbmNlIGZvciBlYWNoIHR5cGUubmFtZXNwYWNlIGluIHR5cGVzOyB0eXBlIG1heSBiZSBvbWl0dGVkCgkJdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbICIiIF07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbIHQgXSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbIDEgXTsKCQkJbmFtZXNwYWNlcyA9ICggdG1wWyAyIF0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CgkJCWlmICggIXR5cGUgKSB7CgkJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKCQkJCX0KCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdIHx8IFtdOwoJCQl0bXAgPSB0bXBbIDIgXSAmJgoJCQkJbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCAiXFwuKD86LipcXC58KSIgKSArICIoXFwufCQpIiApOwoKCQkJLy8gUmVtb3ZlIG1hdGNoaW5nIGV2ZW50cwoJCQlvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOwoJCQl3aGlsZSAoIGotLSApIHsKCQkJCWhhbmRsZU9iaiA9IGhhbmRsZXJzWyBqIF07CgoJCQkJaWYgKCAoIG1hcHBlZFR5cGVzIHx8IG9yaWdUeXBlID09PSBoYW5kbGVPYmoub3JpZ1R5cGUgKSAmJgoJCQkJCSggIWhhbmRsZXIgfHwgaGFuZGxlci5ndWlkID09PSBoYW5kbGVPYmouZ3VpZCApICYmCgkJCQkJKCAhdG1wIHx8IHRtcC50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSAmJgoJCQkJCSggIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwKCQkJCQkJc2VsZWN0b3IgPT09ICIqKiIgJiYgaGFuZGxlT2JqLnNlbGVjdG9yICkgKSB7CgkJCQkJaGFuZGxlcnMuc3BsaWNlKCBqLCAxICk7CgoJCQkJCWlmICggaGFuZGxlT2JqLnNlbGVjdG9yICkgewoJCQkJCQloYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07CgkJCQkJfQoJCQkJCWlmICggc3BlY2lhbC5yZW1vdmUgKSB7CgkJCQkJCXNwZWNpYWwucmVtb3ZlLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdAoJCQkvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykKCQkJaWYgKCBvcmlnQ291bnQgJiYgIWhhbmRsZXJzLmxlbmd0aCApIHsKCQkJCWlmICggIXNwZWNpYWwudGVhcmRvd24gfHwKCQkJCQlzcGVjaWFsLnRlYXJkb3duLmNhbGwoIGVsZW0sIG5hbWVzcGFjZXMsIGVsZW1EYXRhLmhhbmRsZSApID09PSBmYWxzZSApIHsKCgkJCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBlbGVtRGF0YS5oYW5kbGUgKTsKCQkJCX0KCgkJCQlkZWxldGUgZXZlbnRzWyB0eXBlIF07CgkJCX0KCQl9CgoJCS8vIFJlbW92ZSBkYXRhIGFuZCB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCgkJaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCggZXZlbnRzICkgKSB7CgkJCWRhdGFQcml2LnJlbW92ZSggZWxlbSwgImhhbmRsZSBldmVudHMiICk7CgkJfQoJfSwKCglkaXNwYXRjaDogZnVuY3Rpb24oIG5hdGl2ZUV2ZW50ICkgewoKCQkvLyBNYWtlIGEgd3JpdGFibGUgalF1ZXJ5LkV2ZW50IGZyb20gdGhlIG5hdGl2ZSBldmVudCBvYmplY3QKCQl2YXIgZXZlbnQgPSBqUXVlcnkuZXZlbnQuZml4KCBuYXRpdmVFdmVudCApOwoKCQl2YXIgaSwgaiwgcmV0LCBtYXRjaGVkLCBoYW5kbGVPYmosIGhhbmRsZXJRdWV1ZSwKCQkJYXJncyA9IG5ldyBBcnJheSggYXJndW1lbnRzLmxlbmd0aCApLAoJCQloYW5kbGVycyA9ICggZGF0YVByaXYuZ2V0KCB0aGlzLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSB8fCBbXSwKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge307CgoJCS8vIFVzZSB0aGUgZml4LWVkIGpRdWVyeS5FdmVudCByYXRoZXIgdGhhbiB0aGUgKHJlYWQtb25seSkgbmF0aXZlIGV2ZW50CgkJYXJnc1sgMCBdID0gZXZlbnQ7CgoJCWZvciAoIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrICkgewoJCQlhcmdzWyBpIF0gPSBhcmd1bWVudHNbIGkgXTsKCQl9CgoJCWV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKCgkJLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAoJCWlmICggc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBEZXRlcm1pbmUgaGFuZGxlcnMKCQloYW5kbGVyUXVldWUgPSBqUXVlcnkuZXZlbnQuaGFuZGxlcnMuY2FsbCggdGhpcywgZXZlbnQsIGhhbmRsZXJzICk7CgoJCS8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCgkJaSA9IDA7CgkJd2hpbGUgKCAoIG1hdGNoZWQgPSBoYW5kbGVyUXVldWVbIGkrKyBdICkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCWV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CgoJCQlqID0gMDsKCQkJd2hpbGUgKCAoIGhhbmRsZU9iaiA9IG1hdGNoZWQuaGFuZGxlcnNbIGorKyBdICkgJiYKCQkJCSFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoKCQkJCS8vIElmIHRoZSBldmVudCBpcyBuYW1lc3BhY2VkLCB0aGVuIGVhY2ggaGFuZGxlciBpcyBvbmx5IGludm9rZWQgaWYgaXQgaXMKCQkJCS8vIHNwZWNpYWxseSB1bml2ZXJzYWwgb3IgaXRzIG5hbWVzcGFjZXMgYXJlIGEgc3VwZXJzZXQgb2YgdGhlIGV2ZW50J3MuCgkJCQlpZiAoICFldmVudC5ybmFtZXNwYWNlIHx8IGhhbmRsZU9iai5uYW1lc3BhY2UgPT09IGZhbHNlIHx8CgkJCQkJZXZlbnQucm5hbWVzcGFjZS50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSB7CgoJCQkJCWV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsKCQkJCQlldmVudC5kYXRhID0gaGFuZGxlT2JqLmRhdGE7CgoJCQkJCXJldCA9ICggKCBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgaGFuZGxlT2JqLm9yaWdUeXBlIF0gfHwge30gKS5oYW5kbGUgfHwKCQkJCQkJaGFuZGxlT2JqLmhhbmRsZXIgKS5hcHBseSggbWF0Y2hlZC5lbGVtLCBhcmdzICk7CgoJCQkJCWlmICggcmV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJCWlmICggKCBldmVudC5yZXN1bHQgPSByZXQgKSA9PT0gZmFsc2UgKSB7CgkJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIENhbGwgdGhlIHBvc3REaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUKCQlpZiAoIHNwZWNpYWwucG9zdERpc3BhdGNoICkgewoJCQlzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKCB0aGlzLCBldmVudCApOwoJCX0KCgkJcmV0dXJuIGV2ZW50LnJlc3VsdDsKCX0sCgoJaGFuZGxlcnM6IGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlcnMgKSB7CgkJdmFyIGksIGhhbmRsZU9iaiwgc2VsLCBtYXRjaGVkSGFuZGxlcnMsIG1hdGNoZWRTZWxlY3RvcnMsCgkJCWhhbmRsZXJRdWV1ZSA9IFtdLAoJCQlkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKCQkJY3VyID0gZXZlbnQudGFyZ2V0OwoKCQkvLyBGaW5kIGRlbGVnYXRlIGhhbmRsZXJzCgkJaWYgKCBkZWxlZ2F0ZUNvdW50ICYmCgoJCQkvLyBTdXBwb3J0OiBJRSA8PTkKCQkJLy8gQmxhY2staG9sZSBTVkcgPHVzZT4gaW5zdGFuY2UgdHJlZXMgKHRyYWMtMTMxODApCgkJCWN1ci5ub2RlVHlwZSAmJgoKCQkJLy8gU3VwcG9ydDogRmlyZWZveCA8PTQyCgkJCS8vIFN1cHByZXNzIHNwZWMtdmlvbGF0aW5nIGNsaWNrcyBpbmRpY2F0aW5nIGEgbm9uLXByaW1hcnkgcG9pbnRlciBidXR0b24gKHRyYWMtMzg2MSkKCQkJLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSL0RPTS1MZXZlbC0zLUV2ZW50cy8jZXZlbnQtdHlwZS1jbGljawoJCQkvLyBTdXBwb3J0OiBJRSAxMSBvbmx5CgkJCS8vIC4uLmJ1dCBub3QgYXJyb3cga2V5ICJjbGlja3MiIG9mIHJhZGlvIGlucHV0cywgd2hpY2ggY2FuIGhhdmUgYGJ1dHRvbmAgLTEgKGdoLTIzNDMpCgkJCSEoIGV2ZW50LnR5cGUgPT09ICJjbGljayIgJiYgZXZlbnQuYnV0dG9uID49IDEgKSApIHsKCgkJCWZvciAoIDsgY3VyICE9PSB0aGlzOyBjdXIgPSBjdXIucGFyZW50Tm9kZSB8fCB0aGlzICkgewoKCQkJCS8vIERvbid0IGNoZWNrIG5vbi1lbGVtZW50cyAoIzEzMjA4KQoJCQkJLy8gRG9uJ3QgcHJvY2VzcyBjbGlja3Mgb24gZGlzYWJsZWQgZWxlbWVudHMgKCM2OTExLCAjODE2NSwgIzExMzgyLCAjMTE3NjQpCgkJCQlpZiAoIGN1ci5ub2RlVHlwZSA9PT0gMSAmJiAhKCBldmVudC50eXBlID09PSAiY2xpY2siICYmIGN1ci5kaXNhYmxlZCA9PT0gdHJ1ZSApICkgewoJCQkJCW1hdGNoZWRIYW5kbGVycyA9IFtdOwoJCQkJCW1hdGNoZWRTZWxlY3RvcnMgPSB7fTsKCQkJCQlmb3IgKCBpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKyApIHsKCQkJCQkJaGFuZGxlT2JqID0gaGFuZGxlcnNbIGkgXTsKCgkJCQkJCS8vIERvbid0IGNvbmZsaWN0IHdpdGggT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzICgjMTMyMDMpCgkJCQkJCXNlbCA9IGhhbmRsZU9iai5zZWxlY3RvciArICIgIjsKCgkJCQkJCWlmICggbWF0Y2hlZFNlbGVjdG9yc1sgc2VsIF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCW1hdGNoZWRTZWxlY3RvcnNbIHNlbCBdID0gaGFuZGxlT2JqLm5lZWRzQ29udGV4dCA/CgkJCQkJCQkJalF1ZXJ5KCBzZWwsIHRoaXMgKS5pbmRleCggY3VyICkgPiAtMSA6CgkJCQkJCQkJalF1ZXJ5LmZpbmQoIHNlbCwgdGhpcywgbnVsbCwgWyBjdXIgXSApLmxlbmd0aDsKCQkJCQkJfQoJCQkJCQlpZiAoIG1hdGNoZWRTZWxlY3RvcnNbIHNlbCBdICkgewoJCQkJCQkJbWF0Y2hlZEhhbmRsZXJzLnB1c2goIGhhbmRsZU9iaiApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWlmICggbWF0Y2hlZEhhbmRsZXJzLmxlbmd0aCApIHsKCQkJCQkJaGFuZGxlclF1ZXVlLnB1c2goIHsgZWxlbTogY3VyLCBoYW5kbGVyczogbWF0Y2hlZEhhbmRsZXJzIH0gKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIEFkZCB0aGUgcmVtYWluaW5nIChkaXJlY3RseS1ib3VuZCkgaGFuZGxlcnMKCQljdXIgPSB0aGlzOwoJCWlmICggZGVsZWdhdGVDb3VudCA8IGhhbmRsZXJzLmxlbmd0aCApIHsKCQkJaGFuZGxlclF1ZXVlLnB1c2goIHsgZWxlbTogY3VyLCBoYW5kbGVyczogaGFuZGxlcnMuc2xpY2UoIGRlbGVnYXRlQ291bnQgKSB9ICk7CgkJfQoKCQlyZXR1cm4gaGFuZGxlclF1ZXVlOwoJfSwKCglhZGRQcm9wOiBmdW5jdGlvbiggbmFtZSwgaG9vayApIHsKCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoIGpRdWVyeS5FdmVudC5wcm90b3R5cGUsIG5hbWUsIHsKCQkJZW51bWVyYWJsZTogdHJ1ZSwKCQkJY29uZmlndXJhYmxlOiB0cnVlLAoKCQkJZ2V0OiBpc0Z1bmN0aW9uKCBob29rICkgPwoJCQkJZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCB0aGlzLm9yaWdpbmFsRXZlbnQgKSB7CgkJCQkJCQlyZXR1cm4gaG9vayggdGhpcy5vcmlnaW5hbEV2ZW50ICk7CgkJCQkJfQoJCQkJfSA6CgkJCQlmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHRoaXMub3JpZ2luYWxFdmVudCApIHsKCQkJCQkJCXJldHVybiB0aGlzLm9yaWdpbmFsRXZlbnRbIG5hbWUgXTsKCQkJCQl9CgkJCQl9LAoKCQkJc2V0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRoaXMsIG5hbWUsIHsKCQkJCQllbnVtZXJhYmxlOiB0cnVlLAoJCQkJCWNvbmZpZ3VyYWJsZTogdHJ1ZSwKCQkJCQl3cml0YWJsZTogdHJ1ZSwKCQkJCQl2YWx1ZTogdmFsdWUKCQkJCX0gKTsKCQkJfQoJCX0gKTsKCX0sCgoJZml4OiBmdW5jdGlvbiggb3JpZ2luYWxFdmVudCApIHsKCQlyZXR1cm4gb3JpZ2luYWxFdmVudFsgalF1ZXJ5LmV4cGFuZG8gXSA/CgkJCW9yaWdpbmFsRXZlbnQgOgoJCQluZXcgalF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7Cgl9LAoKCXNwZWNpYWw6IHsKCQlsb2FkOiB7CgoJCQkvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCgkJCW5vQnViYmxlOiB0cnVlCgkJfSwKCQljbGljazogewoKCQkJLy8gVXRpbGl6ZSBuYXRpdmUgZXZlbnQgdG8gZW5zdXJlIGNvcnJlY3Qgc3RhdGUgZm9yIGNoZWNrYWJsZSBpbnB1dHMKCQkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhICkgewoKCQkJCS8vIEZvciBtdXR1YWwgY29tcHJlc3NpYmlsaXR5IHdpdGggX2RlZmF1bHQsIHJlcGxhY2UgYHRoaXNgIGFjY2VzcyB3aXRoIGEgbG9jYWwgdmFyLgoJCQkJLy8gYHx8IGRhdGFgIGlzIGRlYWQgY29kZSBtZWFudCBvbmx5IHRvIHByZXNlcnZlIHRoZSB2YXJpYWJsZSB0aHJvdWdoIG1pbmlmaWNhdGlvbi4KCQkJCXZhciBlbCA9IHRoaXMgfHwgZGF0YTsKCgkJCQkvLyBDbGFpbSB0aGUgZmlyc3QgaGFuZGxlcgoJCQkJaWYgKCByY2hlY2thYmxlVHlwZS50ZXN0KCBlbC50eXBlICkgJiYKCQkJCQllbC5jbGljayAmJiBub2RlTmFtZSggZWwsICJpbnB1dCIgKSApIHsKCgkJCQkJLy8gZGF0YVByaXYuc2V0KCBlbCwgImNsaWNrIiwgLi4uICkKCQkJCQlsZXZlcmFnZU5hdGl2ZSggZWwsICJjbGljayIsIHJldHVyblRydWUgKTsKCQkJCX0KCgkJCQkvLyBSZXR1cm4gZmFsc2UgdG8gYWxsb3cgbm9ybWFsIHByb2Nlc3NpbmcgaW4gdGhlIGNhbGxlcgoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9LAoJCQl0cmlnZ2VyOiBmdW5jdGlvbiggZGF0YSApIHsKCgkJCQkvLyBGb3IgbXV0dWFsIGNvbXByZXNzaWJpbGl0eSB3aXRoIF9kZWZhdWx0LCByZXBsYWNlIGB0aGlzYCBhY2Nlc3Mgd2l0aCBhIGxvY2FsIHZhci4KCQkJCS8vIGB8fCBkYXRhYCBpcyBkZWFkIGNvZGUgbWVhbnQgb25seSB0byBwcmVzZXJ2ZSB0aGUgdmFyaWFibGUgdGhyb3VnaCBtaW5pZmljYXRpb24uCgkJCQl2YXIgZWwgPSB0aGlzIHx8IGRhdGE7CgoJCQkJLy8gRm9yY2Ugc2V0dXAgYmVmb3JlIHRyaWdnZXJpbmcgYSBjbGljawoJCQkJaWYgKCByY2hlY2thYmxlVHlwZS50ZXN0KCBlbC50eXBlICkgJiYKCQkJCQllbC5jbGljayAmJiBub2RlTmFtZSggZWwsICJpbnB1dCIgKSApIHsKCgkJCQkJbGV2ZXJhZ2VOYXRpdmUoIGVsLCAiY2xpY2siICk7CgkJCQl9CgoJCQkJLy8gUmV0dXJuIG5vbi1mYWxzZSB0byBhbGxvdyBub3JtYWwgZXZlbnQtcGF0aCBwcm9wYWdhdGlvbgoJCQkJcmV0dXJuIHRydWU7CgkJCX0sCgoJCQkvLyBGb3IgY3Jvc3MtYnJvd3NlciBjb25zaXN0ZW5jeSwgc3VwcHJlc3MgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCgkJCS8vIEFsc28gcHJldmVudCBpdCBpZiB3ZSdyZSBjdXJyZW50bHkgaW5zaWRlIGEgbGV2ZXJhZ2VkIG5hdGl2ZS1ldmVudCBzdGFjawoJCQlfZGVmYXVsdDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQkJCXJldHVybiByY2hlY2thYmxlVHlwZS50ZXN0KCB0YXJnZXQudHlwZSApICYmCgkJCQkJdGFyZ2V0LmNsaWNrICYmIG5vZGVOYW1lKCB0YXJnZXQsICJpbnB1dCIgKSAmJgoJCQkJCWRhdGFQcml2LmdldCggdGFyZ2V0LCAiY2xpY2siICkgfHwKCQkJCQlub2RlTmFtZSggdGFyZ2V0LCAiYSIgKTsKCQkJfQoJCX0sCgoJCWJlZm9yZXVubG9hZDogewoJCQlwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkvLyBTdXBwb3J0OiBGaXJlZm94IDIwKwoJCQkJLy8gRmlyZWZveCBkb2Vzbid0IGFsZXJ0IGlmIHRoZSByZXR1cm5WYWx1ZSBmaWVsZCBpcyBub3Qgc2V0LgoJCQkJaWYgKCBldmVudC5yZXN1bHQgIT09IHVuZGVmaW5lZCAmJiBldmVudC5vcmlnaW5hbEV2ZW50ICkgewoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQucmV0dXJuVmFsdWUgPSBldmVudC5yZXN1bHQ7CgkJCQl9CgkJCX0KCQl9Cgl9Cn07CgovLyBFbnN1cmUgdGhlIHByZXNlbmNlIG9mIGFuIGV2ZW50IGxpc3RlbmVyIHRoYXQgaGFuZGxlcyBtYW51YWxseS10cmlnZ2VyZWQKLy8gc3ludGhldGljIGV2ZW50cyBieSBpbnRlcnJ1cHRpbmcgcHJvZ3Jlc3MgdW50aWwgcmVpbnZva2VkIGluIHJlc3BvbnNlIHRvCi8vICpuYXRpdmUqIGV2ZW50cyB0aGF0IGl0IGZpcmVzIGRpcmVjdGx5LCBlbnN1cmluZyB0aGF0IHN0YXRlIGNoYW5nZXMgaGF2ZQovLyBhbHJlYWR5IG9jY3VycmVkIGJlZm9yZSBvdGhlciBsaXN0ZW5lcnMgYXJlIGludm9rZWQuCmZ1bmN0aW9uIGxldmVyYWdlTmF0aXZlKCBlbCwgdHlwZSwgZXhwZWN0U3luYyApIHsKCgkvLyBNaXNzaW5nIGV4cGVjdFN5bmMgaW5kaWNhdGVzIGEgdHJpZ2dlciBjYWxsLCB3aGljaCBtdXN0IGZvcmNlIHNldHVwIHRocm91Z2ggalF1ZXJ5LmV2ZW50LmFkZAoJaWYgKCAhZXhwZWN0U3luYyApIHsKCQlpZiAoIGRhdGFQcml2LmdldCggZWwsIHR5cGUgKSA9PT0gdW5kZWZpbmVkICkgewoJCQlqUXVlcnkuZXZlbnQuYWRkKCBlbCwgdHlwZSwgcmV0dXJuVHJ1ZSApOwoJCX0KCQlyZXR1cm47Cgl9CgoJLy8gUmVnaXN0ZXIgdGhlIGNvbnRyb2xsZXIgYXMgYSBzcGVjaWFsIHVuaXZlcnNhbCBoYW5kbGVyIGZvciBhbGwgZXZlbnQgbmFtZXNwYWNlcwoJZGF0YVByaXYuc2V0KCBlbCwgdHlwZSwgZmFsc2UgKTsKCWpRdWVyeS5ldmVudC5hZGQoIGVsLCB0eXBlLCB7CgkJbmFtZXNwYWNlOiBmYWxzZSwKCQloYW5kbGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBub3RBc3luYywgcmVzdWx0LAoJCQkJc2F2ZWQgPSBkYXRhUHJpdi5nZXQoIHRoaXMsIHR5cGUgKTsKCgkJCWlmICggKCBldmVudC5pc1RyaWdnZXIgJiAxICkgJiYgdGhpc1sgdHlwZSBdICkgewoKCQkJCS8vIEludGVycnVwdCBwcm9jZXNzaW5nIG9mIHRoZSBvdXRlciBzeW50aGV0aWMgLnRyaWdnZXIoKWVkIGV2ZW50CgkJCQkvLyBTYXZlZCBkYXRhIHNob3VsZCBiZSBmYWxzZSBpbiBzdWNoIGNhc2VzLCBidXQgbWlnaHQgYmUgYSBsZWZ0b3ZlciBjYXB0dXJlIG9iamVjdAoJCQkJLy8gZnJvbSBhbiBhc3luYyBuYXRpdmUgaGFuZGxlciAoZ2gtNDM1MCkKCQkJCWlmICggIXNhdmVkLmxlbmd0aCApIHsKCgkJCQkJLy8gU3RvcmUgYXJndW1lbnRzIGZvciB1c2Ugd2hlbiBoYW5kbGluZyB0aGUgaW5uZXIgbmF0aXZlIGV2ZW50CgkJCQkJLy8gVGhlcmUgd2lsbCBhbHdheXMgYmUgYXQgbGVhc3Qgb25lIGFyZ3VtZW50IChhbiBldmVudCBvYmplY3QpLCBzbyB0aGlzIGFycmF5CgkJCQkJLy8gd2lsbCBub3QgYmUgY29uZnVzZWQgd2l0aCBhIGxlZnRvdmVyIGNhcHR1cmUgb2JqZWN0LgoJCQkJCXNhdmVkID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICk7CgkJCQkJZGF0YVByaXYuc2V0KCB0aGlzLCB0eXBlLCBzYXZlZCApOwoKCQkJCQkvLyBUcmlnZ2VyIHRoZSBuYXRpdmUgZXZlbnQgYW5kIGNhcHR1cmUgaXRzIHJlc3VsdAoJCQkJCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExKwoJCQkJCS8vIGZvY3VzKCkgYW5kIGJsdXIoKSBhcmUgYXN5bmNocm9ub3VzCgkJCQkJbm90QXN5bmMgPSBleHBlY3RTeW5jKCB0aGlzLCB0eXBlICk7CgkJCQkJdGhpc1sgdHlwZSBdKCk7CgkJCQkJcmVzdWx0ID0gZGF0YVByaXYuZ2V0KCB0aGlzLCB0eXBlICk7CgkJCQkJaWYgKCBzYXZlZCAhPT0gcmVzdWx0IHx8IG5vdEFzeW5jICkgewoJCQkJCQlkYXRhUHJpdi5zZXQoIHRoaXMsIHR5cGUsIGZhbHNlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVzdWx0ID0ge307CgkJCQkJfQoJCQkJCWlmICggc2F2ZWQgIT09IHJlc3VsdCApIHsKCgkJCQkJCS8vIENhbmNlbCB0aGUgb3V0ZXIgc3ludGhldGljIGV2ZW50CgkJCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQlyZXR1cm4gcmVzdWx0LnZhbHVlOwoJCQkJCX0KCgkJCQkvLyBJZiB0aGlzIGlzIGFuIGlubmVyIHN5bnRoZXRpYyBldmVudCBmb3IgYW4gZXZlbnQgd2l0aCBhIGJ1YmJsaW5nIHN1cnJvZ2F0ZQoJCQkJLy8gKGZvY3VzIG9yIGJsdXIpLCBhc3N1bWUgdGhhdCB0aGUgc3Vycm9nYXRlIGFscmVhZHkgcHJvcGFnYXRlZCBmcm9tIHRyaWdnZXJpbmcgdGhlCgkJCQkvLyBuYXRpdmUgZXZlbnQgYW5kIHByZXZlbnQgdGhhdCBmcm9tIGhhcHBlbmluZyBhZ2FpbiBoZXJlLgoJCQkJLy8gVGhpcyB0ZWNobmljYWxseSBnZXRzIHRoZSBvcmRlcmluZyB3cm9uZyB3LnIudC4gdG8gYC50cmlnZ2VyKClgIChpbiB3aGljaCB0aGUKCQkJCS8vIGJ1YmJsaW5nIHN1cnJvZ2F0ZSBwcm9wYWdhdGVzICphZnRlciogdGhlIG5vbi1idWJibGluZyBiYXNlKSwgYnV0IHRoYXQgc2VlbXMKCQkJCS8vIGxlc3MgYmFkIHRoYW4gZHVwbGljYXRpb24uCgkJCQl9IGVsc2UgaWYgKCAoIGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge30gKS5kZWxlZ2F0ZVR5cGUgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgoJCQkvLyBJZiB0aGlzIGlzIGEgbmF0aXZlIGV2ZW50IHRyaWdnZXJlZCBhYm92ZSwgZXZlcnl0aGluZyBpcyBub3cgaW4gb3JkZXIKCQkJLy8gRmlyZSBhbiBpbm5lciBzeW50aGV0aWMgZXZlbnQgd2l0aCB0aGUgb3JpZ2luYWwgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIHNhdmVkLmxlbmd0aCApIHsKCgkJCQkvLyAuLi5hbmQgY2FwdHVyZSB0aGUgcmVzdWx0CgkJCQlkYXRhUHJpdi5zZXQoIHRoaXMsIHR5cGUsIHsKCQkJCQl2YWx1ZTogalF1ZXJ5LmV2ZW50LnRyaWdnZXIoCgoJCQkJCQkvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSsKCQkJCQkJLy8gRXh0ZW5kIHdpdGggdGhlIHByb3RvdHlwZSB0byByZXNldCB0aGUgYWJvdmUgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCkKCQkJCQkJalF1ZXJ5LmV4dGVuZCggc2F2ZWRbIDAgXSwgalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSApLAoJCQkJCQlzYXZlZC5zbGljZSggMSApLAoJCQkJCQl0aGlzCgkJCQkJKQoJCQkJfSApOwoKCQkJCS8vIEFib3J0IGhhbmRsaW5nIG9mIHRoZSBuYXRpdmUgZXZlbnQKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfSApOwp9CgpqUXVlcnkucmVtb3ZlRXZlbnQgPSBmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewoKCS8vIFRoaXMgImlmIiBpcyBuZWVkZWQgZm9yIHBsYWluIG9iamVjdHMKCWlmICggZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyICkgewoJCWVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlICk7Cgl9Cn07CgpqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiggc3JjLCBwcm9wcyApIHsKCgkvLyBBbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgdGhlICduZXcnIGtleXdvcmQKCWlmICggISggdGhpcyBpbnN0YW5jZW9mIGpRdWVyeS5FdmVudCApICkgewoJCXJldHVybiBuZXcgalF1ZXJ5LkV2ZW50KCBzcmMsIHByb3BzICk7Cgl9CgoJLy8gRXZlbnQgb2JqZWN0CglpZiAoIHNyYyAmJiBzcmMudHlwZSApIHsKCQl0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CgkJdGhpcy50eXBlID0gc3JjLnR5cGU7CgoJCS8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkCgkJLy8gYnkgYSBoYW5kbGVyIGxvd2VyIGRvd24gdGhlIHRyZWU7IHJlZmxlY3QgdGhlIGNvcnJlY3QgdmFsdWUuCgkJdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fAoJCQkJc3JjLmRlZmF1bHRQcmV2ZW50ZWQgPT09IHVuZGVmaW5lZCAmJgoKCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD0yLjMgb25seQoJCQkJc3JjLnJldHVyblZhbHVlID09PSBmYWxzZSA/CgkJCXJldHVyblRydWUgOgoJCQlyZXR1cm5GYWxzZTsKCgkJLy8gQ3JlYXRlIHRhcmdldCBwcm9wZXJ0aWVzCgkJLy8gU3VwcG9ydDogU2FmYXJpIDw9NiAtIDcgb25seQoJCS8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpCgkJdGhpcy50YXJnZXQgPSAoIHNyYy50YXJnZXQgJiYgc3JjLnRhcmdldC5ub2RlVHlwZSA9PT0gMyApID8KCQkJc3JjLnRhcmdldC5wYXJlbnROb2RlIDoKCQkJc3JjLnRhcmdldDsKCgkJdGhpcy5jdXJyZW50VGFyZ2V0ID0gc3JjLmN1cnJlbnRUYXJnZXQ7CgkJdGhpcy5yZWxhdGVkVGFyZ2V0ID0gc3JjLnJlbGF0ZWRUYXJnZXQ7CgoJLy8gRXZlbnQgdHlwZQoJfSBlbHNlIHsKCQl0aGlzLnR5cGUgPSBzcmM7Cgl9CgoJLy8gUHV0IGV4cGxpY2l0bHkgcHJvdmlkZWQgcHJvcGVydGllcyBvbnRvIHRoZSBldmVudCBvYmplY3QKCWlmICggcHJvcHMgKSB7CgkJalF1ZXJ5LmV4dGVuZCggdGhpcywgcHJvcHMgKTsKCX0KCgkvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQoJdGhpcy50aW1lU3RhbXAgPSBzcmMgJiYgc3JjLnRpbWVTdGFtcCB8fCBEYXRlLm5vdygpOwoKCS8vIE1hcmsgaXQgYXMgZml4ZWQKCXRoaXNbIGpRdWVyeS5leHBhbmRvIF0gPSB0cnVlOwp9OwoKLy8galF1ZXJ5LkV2ZW50IGlzIGJhc2VkIG9uIERPTTMgRXZlbnRzIGFzIHNwZWNpZmllZCBieSB0aGUgRUNNQVNjcmlwdCBMYW5ndWFnZSBCaW5kaW5nCi8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsKCWNvbnN0cnVjdG9yOiBqUXVlcnkuRXZlbnQsCglpc0RlZmF1bHRQcmV2ZW50ZWQ6IHJldHVybkZhbHNlLAoJaXNQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJaXNTaW11bGF0ZWQ6IGZhbHNlLAoKCXByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCgkJdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwoKCQlpZiAoIGUgJiYgIXRoaXMuaXNTaW11bGF0ZWQgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9LAoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCgkJdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgoJCWlmICggZSAmJiAhdGhpcy5pc1NpbXVsYXRlZCApIHsKCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9Cgl9LAoJc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCgkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgoJCWlmICggZSAmJiAhdGhpcy5pc1NpbXVsYXRlZCApIHsKCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQl9CgoJCXRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7Cgl9Cn07CgovLyBJbmNsdWRlcyBhbGwgY29tbW9uIGV2ZW50IHByb3BzIGluY2x1ZGluZyBLZXlFdmVudCBhbmQgTW91c2VFdmVudCBzcGVjaWZpYyBwcm9wcwpqUXVlcnkuZWFjaCggewoJYWx0S2V5OiB0cnVlLAoJYnViYmxlczogdHJ1ZSwKCWNhbmNlbGFibGU6IHRydWUsCgljaGFuZ2VkVG91Y2hlczogdHJ1ZSwKCWN0cmxLZXk6IHRydWUsCglkZXRhaWw6IHRydWUsCglldmVudFBoYXNlOiB0cnVlLAoJbWV0YUtleTogdHJ1ZSwKCXBhZ2VYOiB0cnVlLAoJcGFnZVk6IHRydWUsCglzaGlmdEtleTogdHJ1ZSwKCXZpZXc6IHRydWUsCgkiY2hhciI6IHRydWUsCgljb2RlOiB0cnVlLAoJY2hhckNvZGU6IHRydWUsCglrZXk6IHRydWUsCglrZXlDb2RlOiB0cnVlLAoJYnV0dG9uOiB0cnVlLAoJYnV0dG9uczogdHJ1ZSwKCWNsaWVudFg6IHRydWUsCgljbGllbnRZOiB0cnVlLAoJb2Zmc2V0WDogdHJ1ZSwKCW9mZnNldFk6IHRydWUsCglwb2ludGVySWQ6IHRydWUsCglwb2ludGVyVHlwZTogdHJ1ZSwKCXNjcmVlblg6IHRydWUsCglzY3JlZW5ZOiB0cnVlLAoJdGFyZ2V0VG91Y2hlczogdHJ1ZSwKCXRvRWxlbWVudDogdHJ1ZSwKCXRvdWNoZXM6IHRydWUsCgoJd2hpY2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgYnV0dG9uID0gZXZlbnQuYnV0dG9uOwoKCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQlpZiAoIGV2ZW50LndoaWNoID09IG51bGwgJiYgcmtleUV2ZW50LnRlc3QoIGV2ZW50LnR5cGUgKSApIHsKCQkJcmV0dXJuIGV2ZW50LmNoYXJDb2RlICE9IG51bGwgPyBldmVudC5jaGFyQ29kZSA6IGV2ZW50LmtleUNvZGU7CgkJfQoKCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09PSBsZWZ0OyAyID09PSBtaWRkbGU7IDMgPT09IHJpZ2h0CgkJaWYgKCAhZXZlbnQud2hpY2ggJiYgYnV0dG9uICE9PSB1bmRlZmluZWQgJiYgcm1vdXNlRXZlbnQudGVzdCggZXZlbnQudHlwZSApICkgewoJCQlpZiAoIGJ1dHRvbiAmIDEgKSB7CgkJCQlyZXR1cm4gMTsKCQkJfQoKCQkJaWYgKCBidXR0b24gJiAyICkgewoJCQkJcmV0dXJuIDM7CgkJCX0KCgkJCWlmICggYnV0dG9uICYgNCApIHsKCQkJCXJldHVybiAyOwoJCQl9CgoJCQlyZXR1cm4gMDsKCQl9CgoJCXJldHVybiBldmVudC53aGljaDsKCX0KfSwgalF1ZXJ5LmV2ZW50LmFkZFByb3AgKTsKCmpRdWVyeS5lYWNoKCB7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIHR5cGUsIGRlbGVnYXRlVHlwZSApIHsKCWpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gPSB7CgoJCS8vIFV0aWxpemUgbmF0aXZlIGV2ZW50IGlmIHBvc3NpYmxlIHNvIGJsdXIvZm9jdXMgc2VxdWVuY2UgaXMgY29ycmVjdAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJCS8vIENsYWltIHRoZSBmaXJzdCBoYW5kbGVyCgkJCS8vIGRhdGFQcml2LnNldCggdGhpcywgImZvY3VzIiwgLi4uICkKCQkJLy8gZGF0YVByaXYuc2V0KCB0aGlzLCAiYmx1ciIsIC4uLiApCgkJCWxldmVyYWdlTmF0aXZlKCB0aGlzLCB0eXBlLCBleHBlY3RTeW5jICk7CgoJCQkvLyBSZXR1cm4gZmFsc2UgdG8gYWxsb3cgbm9ybWFsIHByb2Nlc3NpbmcgaW4gdGhlIGNhbGxlcgoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsKCgkJCS8vIEZvcmNlIHNldHVwIGJlZm9yZSB0cmlnZ2VyCgkJCWxldmVyYWdlTmF0aXZlKCB0aGlzLCB0eXBlICk7CgoJCQkvLyBSZXR1cm4gbm9uLWZhbHNlIHRvIGFsbG93IG5vcm1hbCBldmVudC1wYXRoIHByb3BhZ2F0aW9uCgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCWRlbGVnYXRlVHlwZTogZGVsZWdhdGVUeXBlCgl9Owp9ICk7CgovLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKLy8gc28gdGhhdCBldmVudCBkZWxlZ2F0aW9uIHdvcmtzIGluIGpRdWVyeS4KLy8gRG8gdGhlIHNhbWUgZm9yIHBvaW50ZXJlbnRlci9wb2ludGVybGVhdmUgYW5kIHBvaW50ZXJvdmVyL3BvaW50ZXJvdXQKLy8KLy8gU3VwcG9ydDogU2FmYXJpIDcgb25seQovLyBTYWZhcmkgc2VuZHMgbW91c2VlbnRlciB0b28gb2Z0ZW47IHNlZToKLy8gaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NDcwMjU4Ci8vIGZvciB0aGUgZGVzY3JpcHRpb24gb2YgdGhlIGJ1ZyAoaXQgZXhpc3RlZCBpbiBvbGRlciBDaHJvbWUgdmVyc2lvbnMgYXMgd2VsbCkuCmpRdWVyeS5lYWNoKCB7Cgltb3VzZWVudGVyOiAibW91c2VvdmVyIiwKCW1vdXNlbGVhdmU6ICJtb3VzZW91dCIsCglwb2ludGVyZW50ZXI6ICJwb2ludGVyb3ZlciIsCglwb2ludGVybGVhdmU6ICJwb2ludGVyb3V0Igp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKCQlkZWxlZ2F0ZVR5cGU6IGZpeCwKCQliaW5kVHlwZTogZml4LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHJldCwKCQkJCXRhcmdldCA9IHRoaXMsCgkJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwKCQkJCWhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iajsKCgkJCS8vIEZvciBtb3VzZWVudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCgkJCS8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CgkJCWlmICggIXJlbGF0ZWQgfHwgKCByZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyggdGFyZ2V0LCByZWxhdGVkICkgKSApIHsKCQkJCWV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CgkJCQlyZXQgPSBoYW5kbGVPYmouaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQlldmVudC50eXBlID0gZml4OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfQoJfTsKfSApOwoKalF1ZXJ5LmZuLmV4dGVuZCggewoKCW9uOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gb24oIHRoaXMsIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKTsKCX0sCglvbmU6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuICkgewoJCXJldHVybiBvbiggdGhpcywgdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgMSApOwoJfSwKCW9mZjogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZm4gKSB7CgkJdmFyIGhhbmRsZU9iaiwgdHlwZTsKCQlpZiAoIHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaiApIHsKCgkJCS8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKCQkJaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOwoJCQlqUXVlcnkoIHR5cGVzLmRlbGVnYXRlVGFyZ2V0ICkub2ZmKAoJCQkJaGFuZGxlT2JqLm5hbWVzcGFjZSA/CgkJCQkJaGFuZGxlT2JqLm9yaWdUeXBlICsgIi4iICsgaGFuZGxlT2JqLm5hbWVzcGFjZSA6CgkJCQkJaGFuZGxlT2JqLm9yaWdUeXBlLAoJCQkJaGFuZGxlT2JqLnNlbGVjdG9yLAoJCQkJaGFuZGxlT2JqLmhhbmRsZXIKCQkJKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsKCgkJCS8vICggdHlwZXMtb2JqZWN0IFssIHNlbGVjdG9yXSApCgkJCWZvciAoIHR5cGUgaW4gdHlwZXMgKSB7CgkJCQl0aGlzLm9mZiggdHlwZSwgc2VsZWN0b3IsIHR5cGVzWyB0eXBlIF0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCBzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAiZnVuY3Rpb24iICkgewoKCQkJLy8gKCB0eXBlcyBbLCBmbl0gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9CgkJaWYgKCBmbiA9PT0gZmFsc2UgKSB7CgkJCWZuID0gcmV0dXJuRmFsc2U7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCB0eXBlcywgZm4sIHNlbGVjdG9yICk7CgkJfSApOwoJfQp9ICk7CgoKdmFyCgoJLyogZXNsaW50LWRpc2FibGUgbWF4LWxlbiAqLwoKCS8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vZXNsaW50L2VzbGludC9pc3N1ZXMvMzIyOQoJcnhodG1sVGFnID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW2Etel1bXlwvXDA+XHgyMFx0XHJcblxmXSopW14+XSopXC8+L2dpLAoKCS8qIGVzbGludC1lbmFibGUgKi8KCgkvLyBTdXBwb3J0OiBJRSA8PTEwIC0gMTEsIEVkZ2UgMTIgLSAxMyBvbmx5CgkvLyBJbiBJRS9FZGdlIHVzaW5nIHJlZ2V4IGdyb3VwcyBoZXJlIGNhdXNlcyBzZXZlcmUgc2xvd2Rvd25zLgoJLy8gU2VlIGh0dHBzOi8vY29ubmVjdC5taWNyb3NvZnQuY29tL0lFL2ZlZWRiYWNrL2RldGFpbHMvMTczNjUxMi8KCXJub0lubmVyaHRtbCA9IC88c2NyaXB0fDxzdHlsZXw8bGluay9pLAoKCS8vIGNoZWNrZWQ9ImNoZWNrZWQiIG9yIGNoZWNrZWQKCXJjaGVja2VkID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksCglyY2xlYW5TY3JpcHQgPSAvXlxzKjwhKD86XFtDREFUQVxbfC0tKXwoPzpcXVxdfC0tKT5ccyokL2c7CgovLyBQcmVmZXIgYSB0Ym9keSBvdmVyIGl0cyBwYXJlbnQgdGFibGUgZm9yIGNvbnRhaW5pbmcgbmV3IHJvd3MKZnVuY3Rpb24gbWFuaXB1bGF0aW9uVGFyZ2V0KCBlbGVtLCBjb250ZW50ICkgewoJaWYgKCBub2RlTmFtZSggZWxlbSwgInRhYmxlIiApICYmCgkJbm9kZU5hbWUoIGNvbnRlbnQubm9kZVR5cGUgIT09IDExID8gY29udGVudCA6IGNvbnRlbnQuZmlyc3RDaGlsZCwgInRyIiApICkgewoKCQlyZXR1cm4galF1ZXJ5KCBlbGVtICkuY2hpbGRyZW4oICJ0Ym9keSIgKVsgMCBdIHx8IGVsZW07Cgl9CgoJcmV0dXJuIGVsZW07Cn0KCi8vIFJlcGxhY2UvcmVzdG9yZSB0aGUgdHlwZSBhdHRyaWJ1dGUgb2Ygc2NyaXB0IGVsZW1lbnRzIGZvciBzYWZlIERPTSBtYW5pcHVsYXRpb24KZnVuY3Rpb24gZGlzYWJsZVNjcmlwdCggZWxlbSApIHsKCWVsZW0udHlwZSA9ICggZWxlbS5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApICE9PSBudWxsICkgKyAiLyIgKyBlbGVtLnR5cGU7CglyZXR1cm4gZWxlbTsKfQpmdW5jdGlvbiByZXN0b3JlU2NyaXB0KCBlbGVtICkgewoJaWYgKCAoIGVsZW0udHlwZSB8fCAiIiApLnNsaWNlKCAwLCA1ICkgPT09ICJ0cnVlLyIgKSB7CgkJZWxlbS50eXBlID0gZWxlbS50eXBlLnNsaWNlKCA1ICk7Cgl9IGVsc2UgewoJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCAidHlwZSIgKTsKCX0KCglyZXR1cm4gZWxlbTsKfQoKZnVuY3Rpb24gY2xvbmVDb3B5RXZlbnQoIHNyYywgZGVzdCApIHsKCXZhciBpLCBsLCB0eXBlLCBwZGF0YU9sZCwgcGRhdGFDdXIsIHVkYXRhT2xkLCB1ZGF0YUN1ciwgZXZlbnRzOwoKCWlmICggZGVzdC5ub2RlVHlwZSAhPT0gMSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gMS4gQ29weSBwcml2YXRlIGRhdGE6IGV2ZW50cywgaGFuZGxlcnMsIGV0Yy4KCWlmICggZGF0YVByaXYuaGFzRGF0YSggc3JjICkgKSB7CgkJcGRhdGFPbGQgPSBkYXRhUHJpdi5hY2Nlc3MoIHNyYyApOwoJCXBkYXRhQ3VyID0gZGF0YVByaXYuc2V0KCBkZXN0LCBwZGF0YU9sZCApOwoJCWV2ZW50cyA9IHBkYXRhT2xkLmV2ZW50czsKCgkJaWYgKCBldmVudHMgKSB7CgkJCWRlbGV0ZSBwZGF0YUN1ci5oYW5kbGU7CgkJCXBkYXRhQ3VyLmV2ZW50cyA9IHt9OwoKCQkJZm9yICggdHlwZSBpbiBldmVudHMgKSB7CgkJCQlmb3IgKCBpID0gMCwgbCA9IGV2ZW50c1sgdHlwZSBdLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCBkZXN0LCB0eXBlLCBldmVudHNbIHR5cGUgXVsgaSBdICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gMi4gQ29weSB1c2VyIGRhdGEKCWlmICggZGF0YVVzZXIuaGFzRGF0YSggc3JjICkgKSB7CgkJdWRhdGFPbGQgPSBkYXRhVXNlci5hY2Nlc3MoIHNyYyApOwoJCXVkYXRhQ3VyID0galF1ZXJ5LmV4dGVuZCgge30sIHVkYXRhT2xkICk7CgoJCWRhdGFVc2VyLnNldCggZGVzdCwgdWRhdGFDdXIgKTsKCX0KfQoKLy8gRml4IElFIGJ1Z3MsIHNlZSBzdXBwb3J0IHRlc3RzCmZ1bmN0aW9uIGZpeElucHV0KCBzcmMsIGRlc3QgKSB7Cgl2YXIgbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgoJLy8gRmFpbHMgdG8gcGVyc2lzdCB0aGUgY2hlY2tlZCBzdGF0ZSBvZiBhIGNsb25lZCBjaGVja2JveCBvciByYWRpbyBidXR0b24uCglpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiICYmIHJjaGVja2FibGVUeXBlLnRlc3QoIHNyYy50eXBlICkgKSB7CgkJZGVzdC5jaGVja2VkID0gc3JjLmNoZWNrZWQ7CgoJLy8gRmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQgc3RhdGUgd2hlbiBjbG9uaW5nIG9wdGlvbnMKCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiICkgewoJCWRlc3QuZGVmYXVsdFZhbHVlID0gc3JjLmRlZmF1bHRWYWx1ZTsKCX0KfQoKZnVuY3Rpb24gZG9tTWFuaXAoIGNvbGxlY3Rpb24sIGFyZ3MsIGNhbGxiYWNrLCBpZ25vcmVkICkgewoKCS8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKCWFyZ3MgPSBjb25jYXQuYXBwbHkoIFtdLCBhcmdzICk7CgoJdmFyIGZyYWdtZW50LCBmaXJzdCwgc2NyaXB0cywgaGFzU2NyaXB0cywgbm9kZSwgZG9jLAoJCWkgPSAwLAoJCWwgPSBjb2xsZWN0aW9uLmxlbmd0aCwKCQlpTm9DbG9uZSA9IGwgLSAxLAoJCXZhbHVlID0gYXJnc1sgMCBdLAoJCXZhbHVlSXNGdW5jdGlvbiA9IGlzRnVuY3Rpb24oIHZhbHVlICk7CgoJLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CglpZiAoIHZhbHVlSXNGdW5jdGlvbiB8fAoJCQkoIGwgPiAxICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYKCQkJCSFzdXBwb3J0LmNoZWNrQ2xvbmUgJiYgcmNoZWNrZWQudGVzdCggdmFsdWUgKSApICkgewoJCXJldHVybiBjb2xsZWN0aW9uLmVhY2goIGZ1bmN0aW9uKCBpbmRleCApIHsKCQkJdmFyIHNlbGYgPSBjb2xsZWN0aW9uLmVxKCBpbmRleCApOwoJCQlpZiAoIHZhbHVlSXNGdW5jdGlvbiApIHsKCQkJCWFyZ3NbIDAgXSA9IHZhbHVlLmNhbGwoIHRoaXMsIGluZGV4LCBzZWxmLmh0bWwoKSApOwoJCQl9CgkJCWRvbU1hbmlwKCBzZWxmLCBhcmdzLCBjYWxsYmFjaywgaWdub3JlZCApOwoJCX0gKTsKCX0KCglpZiAoIGwgKSB7CgkJZnJhZ21lbnQgPSBidWlsZEZyYWdtZW50KCBhcmdzLCBjb2xsZWN0aW9uWyAwIF0ub3duZXJEb2N1bWVudCwgZmFsc2UsIGNvbGxlY3Rpb24sIGlnbm9yZWQgKTsKCQlmaXJzdCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CgoJCWlmICggZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgKSB7CgkJCWZyYWdtZW50ID0gZmlyc3Q7CgkJfQoKCQkvLyBSZXF1aXJlIGVpdGhlciBuZXcgY29udGVudCBvciBhbiBpbnRlcmVzdCBpbiBpZ25vcmVkIGVsZW1lbnRzIHRvIGludm9rZSB0aGUgY2FsbGJhY2sKCQlpZiAoIGZpcnN0IHx8IGlnbm9yZWQgKSB7CgkJCXNjcmlwdHMgPSBqUXVlcnkubWFwKCBnZXRBbGwoIGZyYWdtZW50LCAic2NyaXB0IiApLCBkaXNhYmxlU2NyaXB0ICk7CgkJCWhhc1NjcmlwdHMgPSBzY3JpcHRzLmxlbmd0aDsKCgkJCS8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0KCQkJLy8gaW5zdGVhZCBvZiB0aGUgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwCgkJCS8vIGJlaW5nIGVtcHRpZWQgaW5jb3JyZWN0bHkgaW4gY2VydGFpbiBzaXR1YXRpb25zICgjODA3MCkuCgkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCW5vZGUgPSBmcmFnbWVudDsKCgkJCQlpZiAoIGkgIT09IGlOb0Nsb25lICkgewoJCQkJCW5vZGUgPSBqUXVlcnkuY2xvbmUoIG5vZGUsIHRydWUsIHRydWUgKTsKCgkJCQkJLy8gS2VlcCByZWZlcmVuY2VzIHRvIGNsb25lZCBzY3JpcHRzIGZvciBsYXRlciByZXN0b3JhdGlvbgoJCQkJCWlmICggaGFzU2NyaXB0cyApIHsKCgkJCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQoJCQkJCQkvLyBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzIG9uIGFuY2llbnQgV2ViS2l0CgkJCQkJCWpRdWVyeS5tZXJnZSggc2NyaXB0cywgZ2V0QWxsKCBub2RlLCAic2NyaXB0IiApICk7CgkJCQkJfQoJCQkJfQoKCQkJCWNhbGxiYWNrLmNhbGwoIGNvbGxlY3Rpb25bIGkgXSwgbm9kZSwgaSApOwoJCQl9CgoJCQlpZiAoIGhhc1NjcmlwdHMgKSB7CgkJCQlkb2MgPSBzY3JpcHRzWyBzY3JpcHRzLmxlbmd0aCAtIDEgXS5vd25lckRvY3VtZW50OwoKCQkJCS8vIFJlZW5hYmxlIHNjcmlwdHMKCQkJCWpRdWVyeS5tYXAoIHNjcmlwdHMsIHJlc3RvcmVTY3JpcHQgKTsKCgkJCQkvLyBFdmFsdWF0ZSBleGVjdXRhYmxlIHNjcmlwdHMgb24gZmlyc3QgZG9jdW1lbnQgaW5zZXJ0aW9uCgkJCQlmb3IgKCBpID0gMDsgaSA8IGhhc1NjcmlwdHM7IGkrKyApIHsKCQkJCQlub2RlID0gc2NyaXB0c1sgaSBdOwoJCQkJCWlmICggcnNjcmlwdFR5cGUudGVzdCggbm9kZS50eXBlIHx8ICIiICkgJiYKCQkJCQkJIWRhdGFQcml2LmFjY2Vzcyggbm9kZSwgImdsb2JhbEV2YWwiICkgJiYKCQkJCQkJalF1ZXJ5LmNvbnRhaW5zKCBkb2MsIG5vZGUgKSApIHsKCgkJCQkJCWlmICggbm9kZS5zcmMgJiYgKCBub2RlLnR5cGUgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICAhPT0gIm1vZHVsZSIgKSB7CgoJCQkJCQkJLy8gT3B0aW9uYWwgQUpBWCBkZXBlbmRlbmN5LCBidXQgd29uJ3QgcnVuIHNjcmlwdHMgaWYgbm90IHByZXNlbnQKCQkJCQkJCWlmICggalF1ZXJ5Ll9ldmFsVXJsICYmICFub2RlLm5vTW9kdWxlICkgewoJCQkJCQkJCWpRdWVyeS5fZXZhbFVybCggbm9kZS5zcmMsIHsKCQkJCQkJCQkJbm9uY2U6IG5vZGUubm9uY2UgfHwgbm9kZS5nZXRBdHRyaWJ1dGUoICJub25jZSIgKQoJCQkJCQkJCX0gKTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCURPTUV2YWwoIG5vZGUudGV4dENvbnRlbnQucmVwbGFjZSggcmNsZWFuU2NyaXB0LCAiIiApLCBub2RlLCBkb2MgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4gY29sbGVjdGlvbjsKfQoKZnVuY3Rpb24gcmVtb3ZlKCBlbGVtLCBzZWxlY3Rvciwga2VlcERhdGEgKSB7Cgl2YXIgbm9kZSwKCQlub2RlcyA9IHNlbGVjdG9yID8galF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIGVsZW0gKSA6IGVsZW0sCgkJaSA9IDA7CgoJZm9yICggOyAoIG5vZGUgPSBub2Rlc1sgaSBdICkgIT0gbnVsbDsgaSsrICkgewoJCWlmICggIWtlZXBEYXRhICYmIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7CgkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggbm9kZSApICk7CgkJfQoKCQlpZiAoIG5vZGUucGFyZW50Tm9kZSApIHsKCQkJaWYgKCBrZWVwRGF0YSAmJiBpc0F0dGFjaGVkKCBub2RlICkgKSB7CgkJCQlzZXRHbG9iYWxFdmFsKCBnZXRBbGwoIG5vZGUsICJzY3JpcHQiICkgKTsKCQkJfQoJCQlub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIG5vZGUgKTsKCQl9Cgl9CgoJcmV0dXJuIGVsZW07Cn0KCmpRdWVyeS5leHRlbmQoIHsKCWh0bWxQcmVmaWx0ZXI6IGZ1bmN0aW9uKCBodG1sICkgewoJCXJldHVybiBodG1sLnJlcGxhY2UoIHJ4aHRtbFRhZywgIjwkMT48LyQyPiIgKTsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKCBlbGVtLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQl2YXIgaSwgbCwgc3JjRWxlbWVudHMsIGRlc3RFbGVtZW50cywKCQkJY2xvbmUgPSBlbGVtLmNsb25lTm9kZSggdHJ1ZSApLAoJCQlpblBhZ2UgPSBpc0F0dGFjaGVkKCBlbGVtICk7CgoJCS8vIEZpeCBJRSBjbG9uaW5nIGlzc3VlcwoJCWlmICggIXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgJiYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGVsZW0ubm9kZVR5cGUgPT09IDExICkgJiYKCQkJCSFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKSApIHsKCgkJCS8vIFdlIGVzY2hldyBTaXp6bGUgaGVyZSBmb3IgcGVyZm9ybWFuY2UgcmVhc29uczogaHR0cHM6Ly9qc3BlcmYuY29tL2dldGFsbC12cy1zaXp6bGUvMgoJCQlkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lICk7CgkJCXNyY0VsZW1lbnRzID0gZ2V0QWxsKCBlbGVtICk7CgoJCQlmb3IgKCBpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCWZpeElucHV0KCBzcmNFbGVtZW50c1sgaSBdLCBkZXN0RWxlbWVudHNbIGkgXSApOwoJCQl9CgkJfQoKCQkvLyBDb3B5IHRoZSBldmVudHMgZnJvbSB0aGUgb3JpZ2luYWwgdG8gdGhlIGNsb25lCgkJaWYgKCBkYXRhQW5kRXZlbnRzICkgewoJCQlpZiAoIGRlZXBEYXRhQW5kRXZlbnRzICkgewoJCQkJc3JjRWxlbWVudHMgPSBzcmNFbGVtZW50cyB8fCBnZXRBbGwoIGVsZW0gKTsKCQkJCWRlc3RFbGVtZW50cyA9IGRlc3RFbGVtZW50cyB8fCBnZXRBbGwoIGNsb25lICk7CgoJCQkJZm9yICggaSA9IDAsIGwgPSBzcmNFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJY2xvbmVDb3B5RXZlbnQoIHNyY0VsZW1lbnRzWyBpIF0sIGRlc3RFbGVtZW50c1sgaSBdICk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQljbG9uZUNvcHlFdmVudCggZWxlbSwgY2xvbmUgKTsKCQkJfQoJCX0KCgkJLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQoJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUsICJzY3JpcHQiICk7CgkJaWYgKCBkZXN0RWxlbWVudHMubGVuZ3RoID4gMCApIHsKCQkJc2V0R2xvYmFsRXZhbCggZGVzdEVsZW1lbnRzLCAhaW5QYWdlICYmIGdldEFsbCggZWxlbSwgInNjcmlwdCIgKSApOwoJCX0KCgkJLy8gUmV0dXJuIHRoZSBjbG9uZWQgc2V0CgkJcmV0dXJuIGNsb25lOwoJfSwKCgljbGVhbkRhdGE6IGZ1bmN0aW9uKCBlbGVtcyApIHsKCQl2YXIgZGF0YSwgZWxlbSwgdHlwZSwKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsLAoJCQlpID0gMDsKCgkJZm9yICggOyAoIGVsZW0gPSBlbGVtc1sgaSBdICkgIT09IHVuZGVmaW5lZDsgaSsrICkgewoJCQlpZiAoIGFjY2VwdERhdGEoIGVsZW0gKSApIHsKCQkJCWlmICggKCBkYXRhID0gZWxlbVsgZGF0YVByaXYuZXhwYW5kbyBdICkgKSB7CgkJCQkJaWYgKCBkYXRhLmV2ZW50cyApIHsKCQkJCQkJZm9yICggdHlwZSBpbiBkYXRhLmV2ZW50cyApIHsKCQkJCQkJCWlmICggc3BlY2lhbFsgdHlwZSBdICkgewoJCQkJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKTsKCgkJCQkJCQkvLyBUaGlzIGlzIGEgc2hvcnRjdXQgdG8gYXZvaWQgalF1ZXJ5LmV2ZW50LnJlbW92ZSdzIG92ZXJoZWFkCgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZGF0YS5oYW5kbGUgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NSsKCQkJCQkvLyBBc3NpZ24gdW5kZWZpbmVkIGluc3RlYWQgb2YgdXNpbmcgZGVsZXRlLCBzZWUgRGF0YSNyZW1vdmUKCQkJCQllbGVtWyBkYXRhUHJpdi5leHBhbmRvIF0gPSB1bmRlZmluZWQ7CgkJCQl9CgkJCQlpZiAoIGVsZW1bIGRhdGFVc2VyLmV4cGFuZG8gXSApIHsKCgkJCQkJLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NSsKCQkJCQkvLyBBc3NpZ24gdW5kZWZpbmVkIGluc3RlYWQgb2YgdXNpbmcgZGVsZXRlLCBzZWUgRGF0YSNyZW1vdmUKCQkJCQllbGVtWyBkYXRhVXNlci5leHBhbmRvIF0gPSB1bmRlZmluZWQ7CgkJCQl9CgkJCX0KCQl9Cgl9Cn0gKTsKCmpRdWVyeS5mbi5leHRlbmQoIHsKCWRldGFjaDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiByZW1vdmUoIHRoaXMsIHNlbGVjdG9yLCB0cnVlICk7Cgl9LAoKCXJlbW92ZTogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiByZW1vdmUoIHRoaXMsIHNlbGVjdG9yICk7Cgl9LAoKCXRleHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8KCQkJCWpRdWVyeS50ZXh0KCB0aGlzICkgOgoJCQkJdGhpcy5lbXB0eSgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggdGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5ICkgewoJCQkJCQl0aGlzLnRleHRDb250ZW50ID0gdmFsdWU7CgkJCQkJfQoJCQkJfSApOwoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGRvbU1hbmlwKCB0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCXZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQoIHRoaXMsIGVsZW0gKTsKCQkJCXRhcmdldC5hcHBlbmRDaGlsZCggZWxlbSApOwoJCQl9CgkJfSApOwoJfSwKCglwcmVwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZG9tTWFuaXAoIHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmICggdGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5ICkgewoJCQkJdmFyIHRhcmdldCA9IG1hbmlwdWxhdGlvblRhcmdldCggdGhpcywgZWxlbSApOwoJCQkJdGFyZ2V0Lmluc2VydEJlZm9yZSggZWxlbSwgdGFyZ2V0LmZpcnN0Q2hpbGQgKTsKCQkJfQoJCX0gKTsKCX0sCgoJYmVmb3JlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZG9tTWFuaXAoIHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmICggdGhpcy5wYXJlbnROb2RlICkgewoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcyApOwoJCQl9CgkJfSApOwoJfSwKCglhZnRlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGRvbU1hbmlwKCB0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMucGFyZW50Tm9kZSApIHsKCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMubmV4dFNpYmxpbmcgKTsKCQkJfQoJCX0gKTsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtLAoJCQlpID0gMDsKCgkJZm9yICggOyAoIGVsZW0gPSB0aGlzWyBpIF0gKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCgkJCQkvLyBQcmV2ZW50IG1lbW9yeSBsZWFrcwoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CgoJCQkJLy8gUmVtb3ZlIGFueSByZW1haW5pbmcgbm9kZXMKCQkJCWVsZW0udGV4dENvbnRlbnQgPSAiIjsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbiggZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJZGF0YUFuZEV2ZW50cyA9IGRhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGZhbHNlIDogZGF0YUFuZEV2ZW50czsKCQlkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7CgoJCXJldHVybiB0aGlzLm1hcCggZnVuY3Rpb24oKSB7CgkJCXJldHVybiBqUXVlcnkuY2xvbmUoIHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICk7CgkJfSApOwoJfSwKCglodG1sOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgZWxlbSA9IHRoaXNbIDAgXSB8fCB7fSwKCQkJCWkgPSAwLAoJCQkJbCA9IHRoaXMubGVuZ3RoOwoKCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQlyZXR1cm4gZWxlbS5pbm5lckhUTUw7CgkJCX0KCgkJCS8vIFNlZSBpZiB3ZSBjYW4gdGFrZSBhIHNob3J0Y3V0IGFuZCBqdXN0IHVzZSBpbm5lckhUTUwKCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmICFybm9Jbm5lcmh0bWwudGVzdCggdmFsdWUgKSAmJgoJCQkJIXdyYXBNYXBbICggcnRhZ05hbWUuZXhlYyggdmFsdWUgKSB8fCBbICIiLCAiIiBdIClbIDEgXS50b0xvd2VyQ2FzZSgpIF0gKSB7CgoJCQkJdmFsdWUgPSBqUXVlcnkuaHRtbFByZWZpbHRlciggdmFsdWUgKTsKCgkJCQl0cnkgewoJCQkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCQkJZWxlbSA9IHRoaXNbIGkgXSB8fCB7fTsKCgkJCQkJCS8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwoJCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0sIGZhbHNlICkgKTsKCQkJCQkJCWVsZW0uaW5uZXJIVE1MID0gdmFsdWU7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWVsZW0gPSAwOwoKCQkJCS8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZAoJCQkJfSBjYXRjaCAoIGUgKSB7fQoJCQl9CgoJCQlpZiAoIGVsZW0gKSB7CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCB2YWx1ZSApOwoJCQl9CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKCX0sCgoJcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKCkgewoJCXZhciBpZ25vcmVkID0gW107CgoJCS8vIE1ha2UgdGhlIGNoYW5nZXMsIHJlcGxhY2luZyBlYWNoIG5vbi1pZ25vcmVkIGNvbnRleHQgZWxlbWVudCB3aXRoIHRoZSBuZXcgY29udGVudAoJCXJldHVybiBkb21NYW5pcCggdGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKCgkJCWlmICggalF1ZXJ5LmluQXJyYXkoIHRoaXMsIGlnbm9yZWQgKSA8IDAgKSB7CgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIHRoaXMgKSApOwoJCQkJaWYgKCBwYXJlbnQgKSB7CgkJCQkJcGFyZW50LnJlcGxhY2VDaGlsZCggZWxlbSwgdGhpcyApOwoJCQkJfQoJCQl9CgoJCS8vIEZvcmNlIGNhbGxiYWNrIGludm9jYXRpb24KCQl9LCBpZ25vcmVkICk7Cgl9Cn0gKTsKCmpRdWVyeS5lYWNoKCB7CglhcHBlbmRUbzogImFwcGVuZCIsCglwcmVwZW5kVG86ICJwcmVwZW5kIiwKCWluc2VydEJlZm9yZTogImJlZm9yZSIsCglpbnNlcnRBZnRlcjogImFmdGVyIiwKCXJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKfSwgZnVuY3Rpb24oIG5hbWUsIG9yaWdpbmFsICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGVsZW1zLAoJCQlyZXQgPSBbXSwKCQkJaW5zZXJ0ID0galF1ZXJ5KCBzZWxlY3RvciApLAoJCQlsYXN0ID0gaW5zZXJ0Lmxlbmd0aCAtIDEsCgkJCWkgPSAwOwoKCQlmb3IgKCA7IGkgPD0gbGFzdDsgaSsrICkgewoJCQllbGVtcyA9IGkgPT09IGxhc3QgPyB0aGlzIDogdGhpcy5jbG9uZSggdHJ1ZSApOwoJCQlqUXVlcnkoIGluc2VydFsgaSBdIClbIG9yaWdpbmFsIF0oIGVsZW1zICk7CgoJCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKCQkJLy8gLmdldCgpIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdAoJCQlwdXNoLmFwcGx5KCByZXQsIGVsZW1zLmdldCgpICk7CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldCApOwoJfTsKfSApOwp2YXIgcm51bW5vbnB4ID0gbmV3IFJlZ0V4cCggIl4oIiArIHBudW0gKyAiKSg/IXB4KVthLXolXSskIiwgImkiICk7Cgp2YXIgZ2V0U3R5bGVzID0gZnVuY3Rpb24oIGVsZW0gKSB7CgoJCS8vIFN1cHBvcnQ6IElFIDw9MTEgb25seSwgRmlyZWZveCA8PTMwICgjMTUwOTgsICMxNDE1MCkKCQkvLyBJRSB0aHJvd3Mgb24gZWxlbWVudHMgY3JlYXRlZCBpbiBwb3B1cHMKCQkvLyBGRiBtZWFud2hpbGUgdGhyb3dzIG9uIGZyYW1lIGVsZW1lbnRzIHRocm91Z2ggImRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUiCgkJdmFyIHZpZXcgPSBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7CgoJCWlmICggIXZpZXcgfHwgIXZpZXcub3BlbmVyICkgewoJCQl2aWV3ID0gd2luZG93OwoJCX0KCgkJcmV0dXJuIHZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSApOwoJfTsKCnZhciByYm94U3R5bGUgPSBuZXcgUmVnRXhwKCBjc3NFeHBhbmQuam9pbiggInwiICksICJpIiApOwoKCgooIGZ1bmN0aW9uKCkgewoKCS8vIEV4ZWN1dGluZyBib3RoIHBpeGVsUG9zaXRpb24gJiBib3hTaXppbmdSZWxpYWJsZSB0ZXN0cyByZXF1aXJlIG9ubHkgb25lIGxheW91dAoJLy8gc28gdGhleSdyZSBleGVjdXRlZCBhdCB0aGUgc2FtZSB0aW1lIHRvIHNhdmUgdGhlIHNlY29uZCBjb21wdXRhdGlvbi4KCWZ1bmN0aW9uIGNvbXB1dGVTdHlsZVRlc3RzKCkgewoKCQkvLyBUaGlzIGlzIGEgc2luZ2xldG9uLCB3ZSBuZWVkIHRvIGV4ZWN1dGUgaXQgb25seSBvbmNlCgkJaWYgKCAhZGl2ICkgewoJCQlyZXR1cm47CgkJfQoKCQljb250YWluZXIuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTtsZWZ0Oi0xMTExMXB4O3dpZHRoOjYwcHg7IiArCgkJCSJtYXJnaW4tdG9wOjFweDtwYWRkaW5nOjA7Ym9yZGVyOjAiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0KCQkJInBvc2l0aW9uOnJlbGF0aXZlO2Rpc3BsYXk6YmxvY2s7Ym94LXNpemluZzpib3JkZXItYm94O292ZXJmbG93OnNjcm9sbDsiICsKCQkJIm1hcmdpbjphdXRvO2JvcmRlcjoxcHg7cGFkZGluZzoxcHg7IiArCgkJCSJ3aWR0aDo2MCU7dG9wOjElIjsKCQlkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGNvbnRhaW5lciApLmFwcGVuZENoaWxkKCBkaXYgKTsKCgkJdmFyIGRpdlN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGRpdiApOwoJCXBpeGVsUG9zaXRpb25WYWwgPSBkaXZTdHlsZS50b3AgIT09ICIxJSI7CgoJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHksIEZpcmVmb3ggPD0zIC0gNDQKCQlyZWxpYWJsZU1hcmdpbkxlZnRWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoIGRpdlN0eWxlLm1hcmdpbkxlZnQgKSA9PT0gMTI7CgoJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHksIFNhZmFyaSA8PTkuMSAtIDEwLjEsIGlPUyA8PTcuMCAtIDkuMwoJCS8vIFNvbWUgc3R5bGVzIGNvbWUgYmFjayB3aXRoIHBlcmNlbnRhZ2UgdmFsdWVzLCBldmVuIHRob3VnaCB0aGV5IHNob3VsZG4ndAoJCWRpdi5zdHlsZS5yaWdodCA9ICI2MCUiOwoJCXBpeGVsQm94U3R5bGVzVmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKCBkaXZTdHlsZS5yaWdodCApID09PSAzNjsKCgkJLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHkKCQkvLyBEZXRlY3QgbWlzcmVwb3J0aW5nIG9mIGNvbnRlbnQgZGltZW5zaW9ucyBmb3IgYm94LXNpemluZzpib3JkZXItYm94IGVsZW1lbnRzCgkJYm94U2l6aW5nUmVsaWFibGVWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoIGRpdlN0eWxlLndpZHRoICkgPT09IDM2OwoKCQkvLyBTdXBwb3J0OiBJRSA5IG9ubHkKCQkvLyBEZXRlY3Qgb3ZlcmZsb3c6c2Nyb2xsIHNjcmV3aW5lc3MgKGdoLTM2OTkpCgkJLy8gU3VwcG9ydDogQ2hyb21lIDw9NjQKCQkvLyBEb24ndCBnZXQgdHJpY2tlZCB3aGVuIHpvb20gYWZmZWN0cyBvZmZzZXRXaWR0aCAoZ2gtNDAyOSkKCQlkaXYuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwoJCXNjcm9sbGJveFNpemVWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoIGRpdi5vZmZzZXRXaWR0aCAvIDMgKSA9PT0gMTI7CgoJCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggY29udGFpbmVyICk7CgoJCS8vIE51bGxpZnkgdGhlIGRpdiBzbyBpdCB3b3VsZG4ndCBiZSBzdG9yZWQgaW4gdGhlIG1lbW9yeSBhbmQKCQkvLyBpdCB3aWxsIGFsc28gYmUgYSBzaWduIHRoYXQgY2hlY2tzIGFscmVhZHkgcGVyZm9ybWVkCgkJZGl2ID0gbnVsbDsKCX0KCglmdW5jdGlvbiByb3VuZFBpeGVsTWVhc3VyZXMoIG1lYXN1cmUgKSB7CgkJcmV0dXJuIE1hdGgucm91bmQoIHBhcnNlRmxvYXQoIG1lYXN1cmUgKSApOwoJfQoKCXZhciBwaXhlbFBvc2l0aW9uVmFsLCBib3hTaXppbmdSZWxpYWJsZVZhbCwgc2Nyb2xsYm94U2l6ZVZhbCwgcGl4ZWxCb3hTdHlsZXNWYWwsCgkJcmVsaWFibGVNYXJnaW5MZWZ0VmFsLAoJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCgkvLyBGaW5pc2ggZWFybHkgaW4gbGltaXRlZCAobm9uLWJyb3dzZXIpIGVudmlyb25tZW50cwoJaWYgKCAhZGl2LnN0eWxlICkgewoJCXJldHVybjsKCX0KCgkvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSBvbmx5CgkvLyBTdHlsZSBvZiBjbG9uZWQgZWxlbWVudCBhZmZlY3RzIHNvdXJjZSBlbGVtZW50IGNsb25lZCAoIzg5MDgpCglkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiY29udGVudC1ib3giOwoJZGl2LmNsb25lTm9kZSggdHJ1ZSApLnN0eWxlLmJhY2tncm91bmRDbGlwID0gIiI7CglzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSA9IGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9PT0gImNvbnRlbnQtYm94IjsKCglqUXVlcnkuZXh0ZW5kKCBzdXBwb3J0LCB7CgkJYm94U2l6aW5nUmVsaWFibGU6IGZ1bmN0aW9uKCkgewoJCQljb21wdXRlU3R5bGVUZXN0cygpOwoJCQlyZXR1cm4gYm94U2l6aW5nUmVsaWFibGVWYWw7CgkJfSwKCQlwaXhlbEJveFN0eWxlczogZnVuY3Rpb24oKSB7CgkJCWNvbXB1dGVTdHlsZVRlc3RzKCk7CgkJCXJldHVybiBwaXhlbEJveFN0eWxlc1ZhbDsKCQl9LAoJCXBpeGVsUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQljb21wdXRlU3R5bGVUZXN0cygpOwoJCQlyZXR1cm4gcGl4ZWxQb3NpdGlvblZhbDsKCQl9LAoJCXJlbGlhYmxlTWFyZ2luTGVmdDogZnVuY3Rpb24oKSB7CgkJCWNvbXB1dGVTdHlsZVRlc3RzKCk7CgkJCXJldHVybiByZWxpYWJsZU1hcmdpbkxlZnRWYWw7CgkJfSwKCQlzY3JvbGxib3hTaXplOiBmdW5jdGlvbigpIHsKCQkJY29tcHV0ZVN0eWxlVGVzdHMoKTsKCQkJcmV0dXJuIHNjcm9sbGJveFNpemVWYWw7CgkJfQoJfSApOwp9ICkoKTsKCgpmdW5jdGlvbiBjdXJDU1MoIGVsZW0sIG5hbWUsIGNvbXB1dGVkICkgewoJdmFyIHdpZHRoLCBtaW5XaWR0aCwgbWF4V2lkdGgsIHJldCwKCgkJLy8gU3VwcG9ydDogRmlyZWZveCA1MSsKCQkvLyBSZXRyaWV2aW5nIHN0eWxlIGJlZm9yZSBjb21wdXRlZCBzb21laG93CgkJLy8gZml4ZXMgYW4gaXNzdWUgd2l0aCBnZXR0aW5nIHdyb25nIHZhbHVlcwoJCS8vIG9uIGRldGFjaGVkIGVsZW1lbnRzCgkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCWNvbXB1dGVkID0gY29tcHV0ZWQgfHwgZ2V0U3R5bGVzKCBlbGVtICk7CgoJLy8gZ2V0UHJvcGVydHlWYWx1ZSBpcyBuZWVkZWQgZm9yOgoJLy8gICAuY3NzKCdmaWx0ZXInKSAoSUUgOSBvbmx5LCAjMTI1MzcpCgkvLyAgIC5jc3MoJy0tY3VzdG9tUHJvcGVydHkpICgjMzE0NCkKCWlmICggY29tcHV0ZWQgKSB7CgkJcmV0ID0gY29tcHV0ZWQuZ2V0UHJvcGVydHlWYWx1ZSggbmFtZSApIHx8IGNvbXB1dGVkWyBuYW1lIF07CgoJCWlmICggcmV0ID09PSAiIiAmJiAhaXNBdHRhY2hlZCggZWxlbSApICkgewoJCQlyZXQgPSBqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUgKTsKCQl9CgoJCS8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCgkJLy8gQW5kcm9pZCBCcm93c2VyIHJldHVybnMgcGVyY2VudGFnZSBmb3Igc29tZSB2YWx1ZXMsCgkJLy8gYnV0IHdpZHRoIHNlZW1zIHRvIGJlIHJlbGlhYmx5IHBpeGVscy4KCQkvLyBUaGlzIGlzIGFnYWluc3QgdGhlIENTU09NIGRyYWZ0IHNwZWM6CgkJLy8gaHR0cHM6Ly9kcmFmdHMuY3Nzd2cub3JnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKCQlpZiAoICFzdXBwb3J0LnBpeGVsQm94U3R5bGVzKCkgJiYgcm51bW5vbnB4LnRlc3QoIHJldCApICYmIHJib3hTdHlsZS50ZXN0KCBuYW1lICkgKSB7CgoJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCgkJCXdpZHRoID0gc3R5bGUud2lkdGg7CgkJCW1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CgkJCW1heFdpZHRoID0gc3R5bGUubWF4V2lkdGg7CgoJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CgkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKCQkJcmV0ID0gY29tcHV0ZWQud2lkdGg7CgoJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCgkJCXN0eWxlLndpZHRoID0gd2lkdGg7CgkJCXN0eWxlLm1pbldpZHRoID0gbWluV2lkdGg7CgkJCXN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7CgkJfQoJfQoKCXJldHVybiByZXQgIT09IHVuZGVmaW5lZCA/CgoJCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExIG9ubHkKCQkvLyBJRSByZXR1cm5zIHpJbmRleCB2YWx1ZSBhcyBhbiBpbnRlZ2VyLgoJCXJldCArICIiIDoKCQlyZXQ7Cn0KCgpmdW5jdGlvbiBhZGRHZXRIb29rSWYoIGNvbmRpdGlvbkZuLCBob29rRm4gKSB7CgoJLy8gRGVmaW5lIHRoZSBob29rLCB3ZSdsbCBjaGVjayBvbiB0aGUgZmlyc3QgcnVuIGlmIGl0J3MgcmVhbGx5IG5lZWRlZC4KCXJldHVybiB7CgkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCBjb25kaXRpb25GbigpICkgewoKCQkJCS8vIEhvb2sgbm90IG5lZWRlZCAob3IgaXQncyBub3QgcG9zc2libGUgdG8gdXNlIGl0IGR1ZQoJCQkJLy8gdG8gbWlzc2luZyBkZXBlbmRlbmN5KSwgcmVtb3ZlIGl0LgoJCQkJZGVsZXRlIHRoaXMuZ2V0OwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBIb29rIG5lZWRlZDsgcmVkZWZpbmUgaXQgc28gdGhhdCB0aGUgc3VwcG9ydCB0ZXN0IGlzIG5vdCBleGVjdXRlZCBhZ2Fpbi4KCQkJcmV0dXJuICggdGhpcy5nZXQgPSBob29rRm4gKS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfQoJfTsKfQoKCnZhciBjc3NQcmVmaXhlcyA9IFsgIldlYmtpdCIsICJNb3oiLCAibXMiIF0sCgllbXB0eVN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKS5zdHlsZSwKCXZlbmRvclByb3BzID0ge307CgovLyBSZXR1cm4gYSB2ZW5kb3ItcHJlZml4ZWQgcHJvcGVydHkgb3IgdW5kZWZpbmVkCmZ1bmN0aW9uIHZlbmRvclByb3BOYW1lKCBuYW1lICkgewoKCS8vIENoZWNrIGZvciB2ZW5kb3IgcHJlZml4ZWQgbmFtZXMKCXZhciBjYXBOYW1lID0gbmFtZVsgMCBdLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKCAxICksCgkJaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsKCgl3aGlsZSAoIGktLSApIHsKCQluYW1lID0gY3NzUHJlZml4ZXNbIGkgXSArIGNhcE5hbWU7CgkJaWYgKCBuYW1lIGluIGVtcHR5U3R5bGUgKSB7CgkJCXJldHVybiBuYW1lOwoJCX0KCX0KfQoKLy8gUmV0dXJuIGEgcG90ZW50aWFsbHktbWFwcGVkIGpRdWVyeS5jc3NQcm9wcyBvciB2ZW5kb3IgcHJlZml4ZWQgcHJvcGVydHkKZnVuY3Rpb24gZmluYWxQcm9wTmFtZSggbmFtZSApIHsKCXZhciBmaW5hbCA9IGpRdWVyeS5jc3NQcm9wc1sgbmFtZSBdIHx8IHZlbmRvclByb3BzWyBuYW1lIF07CgoJaWYgKCBmaW5hbCApIHsKCQlyZXR1cm4gZmluYWw7Cgl9CglpZiAoIG5hbWUgaW4gZW1wdHlTdHlsZSApIHsKCQlyZXR1cm4gbmFtZTsKCX0KCXJldHVybiB2ZW5kb3JQcm9wc1sgbmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIG5hbWUgKSB8fCBuYW1lOwp9CgoKdmFyCgoJLy8gU3dhcHBhYmxlIGlmIGRpc3BsYXkgaXMgbm9uZSBvciBzdGFydHMgd2l0aCB0YWJsZQoJLy8gZXhjZXB0ICJ0YWJsZSIsICJ0YWJsZS1jZWxsIiwgb3IgInRhYmxlLWNhcHRpb24iCgkvLyBTZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKCXJkaXNwbGF5c3dhcCA9IC9eKG5vbmV8dGFibGUoPyEtY1tlYV0pLispLywKCXJjdXN0b21Qcm9wID0gL14tLS8sCgljc3NTaG93ID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ICJibG9jayIgfSwKCWNzc05vcm1hbFRyYW5zZm9ybSA9IHsKCQlsZXR0ZXJTcGFjaW5nOiAiMCIsCgkJZm9udFdlaWdodDogIjQwMCIKCX07CgpmdW5jdGlvbiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIHN1YnRyYWN0ICkgewoKCS8vIEFueSByZWxhdGl2ZSAoKy8tKSB2YWx1ZXMgaGF2ZSBhbHJlYWR5IGJlZW4KCS8vIG5vcm1hbGl6ZWQgYXQgdGhpcyBwb2ludAoJdmFyIG1hdGNoZXMgPSByY3NzTnVtLmV4ZWMoIHZhbHVlICk7CglyZXR1cm4gbWF0Y2hlcyA/CgoJCS8vIEd1YXJkIGFnYWluc3QgdW5kZWZpbmVkICJzdWJ0cmFjdCIsIGUuZy4sIHdoZW4gdXNlZCBhcyBpbiBjc3NIb29rcwoJCU1hdGgubWF4KCAwLCBtYXRjaGVzWyAyIF0gLSAoIHN1YnRyYWN0IHx8IDAgKSApICsgKCBtYXRjaGVzWyAzIF0gfHwgInB4IiApIDoKCQl2YWx1ZTsKfQoKZnVuY3Rpb24gYm94TW9kZWxBZGp1c3RtZW50KCBlbGVtLCBkaW1lbnNpb24sIGJveCwgaXNCb3JkZXJCb3gsIHN0eWxlcywgY29tcHV0ZWRWYWwgKSB7Cgl2YXIgaSA9IGRpbWVuc2lvbiA9PT0gIndpZHRoIiA/IDEgOiAwLAoJCWV4dHJhID0gMCwKCQlkZWx0YSA9IDA7CgoJLy8gQWRqdXN0bWVudCBtYXkgbm90IGJlIG5lY2Vzc2FyeQoJaWYgKCBib3ggPT09ICggaXNCb3JkZXJCb3ggPyAiYm9yZGVyIiA6ICJjb250ZW50IiApICkgewoJCXJldHVybiAwOwoJfQoKCWZvciAoIDsgaSA8IDQ7IGkgKz0gMiApIHsKCgkJLy8gQm90aCBib3ggbW9kZWxzIGV4Y2x1ZGUgbWFyZ2luCgkJaWYgKCBib3ggPT09ICJtYXJnaW4iICkgewoJCQlkZWx0YSArPSBqUXVlcnkuY3NzKCBlbGVtLCBib3ggKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgkJfQoKCQkvLyBJZiB3ZSBnZXQgaGVyZSB3aXRoIGEgY29udGVudC1ib3gsIHdlJ3JlIHNlZWtpbmcgInBhZGRpbmciIG9yICJib3JkZXIiIG9yICJtYXJnaW4iCgkJaWYgKCAhaXNCb3JkZXJCb3ggKSB7CgoJCQkvLyBBZGQgcGFkZGluZwoJCQlkZWx0YSArPSBqUXVlcnkuY3NzKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgoJCQkvLyBGb3IgImJvcmRlciIgb3IgIm1hcmdpbiIsIGFkZCBib3JkZXIKCQkJaWYgKCBib3ggIT09ICJwYWRkaW5nIiApIHsKCQkJCWRlbHRhICs9IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKCgkJCS8vIEJ1dCBzdGlsbCBrZWVwIHRyYWNrIG9mIGl0IG90aGVyd2lzZQoJCQl9IGVsc2UgewoJCQkJZXh0cmEgKz0galF1ZXJ5LmNzcyggZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyApOwoJCQl9CgoJCS8vIElmIHdlIGdldCBoZXJlIHdpdGggYSBib3JkZXItYm94IChjb250ZW50ICsgcGFkZGluZyArIGJvcmRlciksIHdlJ3JlIHNlZWtpbmcgImNvbnRlbnQiIG9yCgkJLy8gInBhZGRpbmciIG9yICJtYXJnaW4iCgkJfSBlbHNlIHsKCgkJCS8vIEZvciAiY29udGVudCIsIHN1YnRyYWN0IHBhZGRpbmcKCQkJaWYgKCBib3ggPT09ICJjb250ZW50IiApIHsKCQkJCWRlbHRhIC09IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoKCQkJLy8gRm9yICJjb250ZW50IiBvciAicGFkZGluZyIsIHN1YnRyYWN0IGJvcmRlcgoJCQlpZiAoIGJveCAhPT0gIm1hcmdpbiIgKSB7CgkJCQlkZWx0YSAtPSBqUXVlcnkuY3NzKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiwgdHJ1ZSwgc3R5bGVzICk7CgkJCX0KCQl9Cgl9CgoJLy8gQWNjb3VudCBmb3IgcG9zaXRpdmUgY29udGVudC1ib3ggc2Nyb2xsIGd1dHRlciB3aGVuIHJlcXVlc3RlZCBieSBwcm92aWRpbmcgY29tcHV0ZWRWYWwKCWlmICggIWlzQm9yZGVyQm94ICYmIGNvbXB1dGVkVmFsID49IDAgKSB7CgoJCS8vIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBpcyBhIHJvdW5kZWQgc3VtIG9mIGNvbnRlbnQsIHBhZGRpbmcsIHNjcm9sbCBndXR0ZXIsIGFuZCBib3JkZXIKCQkvLyBBc3N1bWluZyBpbnRlZ2VyIHNjcm9sbCBndXR0ZXIsIHN1YnRyYWN0IHRoZSByZXN0IGFuZCByb3VuZCBkb3duCgkJZGVsdGEgKz0gTWF0aC5tYXgoIDAsIE1hdGguY2VpbCgKCQkJZWxlbVsgIm9mZnNldCIgKyBkaW1lbnNpb25bIDAgXS50b1VwcGVyQ2FzZSgpICsgZGltZW5zaW9uLnNsaWNlKCAxICkgXSAtCgkJCWNvbXB1dGVkVmFsIC0KCQkJZGVsdGEgLQoJCQlleHRyYSAtCgkJCTAuNQoKCQkvLyBJZiBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgaXMgdW5rbm93biwgdGhlbiB3ZSBjYW4ndCBkZXRlcm1pbmUgY29udGVudC1ib3ggc2Nyb2xsIGd1dHRlcgoJCS8vIFVzZSBhbiBleHBsaWNpdCB6ZXJvIHRvIGF2b2lkIE5hTiAoZ2gtMzk2NCkKCQkpICkgfHwgMDsKCX0KCglyZXR1cm4gZGVsdGE7Cn0KCmZ1bmN0aW9uIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIGRpbWVuc2lvbiwgZXh0cmEgKSB7CgoJLy8gU3RhcnQgd2l0aCBjb21wdXRlZCBzdHlsZQoJdmFyIHN0eWxlcyA9IGdldFN0eWxlcyggZWxlbSApLAoKCQkvLyBUbyBhdm9pZCBmb3JjaW5nIGEgcmVmbG93LCBvbmx5IGZldGNoIGJveFNpemluZyBpZiB3ZSBuZWVkIGl0IChnaC00MzIyKS4KCQkvLyBGYWtlIGNvbnRlbnQtYm94IHVudGlsIHdlIGtub3cgaXQncyBuZWVkZWQgdG8ga25vdyB0aGUgdHJ1ZSB2YWx1ZS4KCQlib3hTaXppbmdOZWVkZWQgPSAhc3VwcG9ydC5ib3hTaXppbmdSZWxpYWJsZSgpIHx8IGV4dHJhLAoJCWlzQm9yZGVyQm94ID0gYm94U2l6aW5nTmVlZGVkICYmCgkJCWpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKCQl2YWx1ZUlzQm9yZGVyQm94ID0gaXNCb3JkZXJCb3gsCgoJCXZhbCA9IGN1ckNTUyggZWxlbSwgZGltZW5zaW9uLCBzdHlsZXMgKSwKCQlvZmZzZXRQcm9wID0gIm9mZnNldCIgKyBkaW1lbnNpb25bIDAgXS50b1VwcGVyQ2FzZSgpICsgZGltZW5zaW9uLnNsaWNlKCAxICk7CgoJLy8gU3VwcG9ydDogRmlyZWZveCA8PTU0CgkvLyBSZXR1cm4gYSBjb25mb3VuZGluZyBub24tcGl4ZWwgdmFsdWUgb3IgZmVpZ24gaWdub3JhbmNlLCBhcyBhcHByb3ByaWF0ZS4KCWlmICggcm51bW5vbnB4LnRlc3QoIHZhbCApICkgewoJCWlmICggIWV4dHJhICkgewoJCQlyZXR1cm4gdmFsOwoJCX0KCQl2YWwgPSAiYXV0byI7Cgl9CgoKCS8vIEZhbGwgYmFjayB0byBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgd2hlbiB2YWx1ZSBpcyAiYXV0byIKCS8vIFRoaXMgaGFwcGVucyBmb3IgaW5saW5lIGVsZW1lbnRzIHdpdGggbm8gZXhwbGljaXQgc2V0dGluZyAoZ2gtMzU3MSkKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjEgLSA0LjMgb25seQoJLy8gQWxzbyB1c2Ugb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGZvciBtaXNyZXBvcnRlZCBpbmxpbmUgZGltZW5zaW9ucyAoZ2gtMzYwMikKCS8vIFN1cHBvcnQ6IElFIDktMTEgb25seQoJLy8gQWxzbyB1c2Ugb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGZvciB3aGVuIGJveCBzaXppbmcgaXMgdW5yZWxpYWJsZQoJLy8gV2UgdXNlIGdldENsaWVudFJlY3RzKCkgdG8gY2hlY2sgZm9yIGhpZGRlbi9kaXNjb25uZWN0ZWQuCgkvLyBJbiB0aG9zZSBjYXNlcywgdGhlIGNvbXB1dGVkIHZhbHVlIGNhbiBiZSB0cnVzdGVkIHRvIGJlIGJvcmRlci1ib3gKCWlmICggKCAhc3VwcG9ydC5ib3hTaXppbmdSZWxpYWJsZSgpICYmIGlzQm9yZGVyQm94IHx8CgkJdmFsID09PSAiYXV0byIgfHwKCQkhcGFyc2VGbG9hdCggdmFsICkgJiYgalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiLCBmYWxzZSwgc3R5bGVzICkgPT09ICJpbmxpbmUiICkgJiYKCQllbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoICkgewoKCQlpc0JvcmRlckJveCA9IGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IjsKCgkJLy8gV2hlcmUgYXZhaWxhYmxlLCBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgYXBwcm94aW1hdGUgYm9yZGVyIGJveCBkaW1lbnNpb25zLgoJCS8vIFdoZXJlIG5vdCBhdmFpbGFibGUgKGUuZy4sIFNWRyksIGFzc3VtZSB1bnJlbGlhYmxlIGJveC1zaXppbmcgYW5kIGludGVycHJldCB0aGUKCQkvLyByZXRyaWV2ZWQgdmFsdWUgYXMgYSBjb250ZW50IGJveCBkaW1lbnNpb24uCgkJdmFsdWVJc0JvcmRlckJveCA9IG9mZnNldFByb3AgaW4gZWxlbTsKCQlpZiAoIHZhbHVlSXNCb3JkZXJCb3ggKSB7CgkJCXZhbCA9IGVsZW1bIG9mZnNldFByb3AgXTsKCQl9Cgl9CgoJLy8gTm9ybWFsaXplICIiIGFuZCBhdXRvCgl2YWwgPSBwYXJzZUZsb2F0KCB2YWwgKSB8fCAwOwoKCS8vIEFkanVzdCBmb3IgdGhlIGVsZW1lbnQncyBib3ggbW9kZWwKCXJldHVybiAoIHZhbCArCgkJYm94TW9kZWxBZGp1c3RtZW50KAoJCQllbGVtLAoJCQlkaW1lbnNpb24sCgkJCWV4dHJhIHx8ICggaXNCb3JkZXJCb3ggPyAiYm9yZGVyIiA6ICJjb250ZW50IiApLAoJCQl2YWx1ZUlzQm9yZGVyQm94LAoJCQlzdHlsZXMsCgoJCQkvLyBQcm92aWRlIHRoZSBjdXJyZW50IGNvbXB1dGVkIHNpemUgdG8gcmVxdWVzdCBzY3JvbGwgZ3V0dGVyIGNhbGN1bGF0aW9uIChnaC0zNTg5KQoJCQl2YWwKCQkpCgkpICsgInB4IjsKfQoKalF1ZXJ5LmV4dGVuZCggewoKCS8vIEFkZCBpbiBzdHlsZSBwcm9wZXJ0eSBob29rcyBmb3Igb3ZlcnJpZGluZyB0aGUgZGVmYXVsdAoJLy8gYmVoYXZpb3Igb2YgZ2V0dGluZyBhbmQgc2V0dGluZyBhIHN0eWxlIHByb3BlcnR5Cgljc3NIb29rczogewoJCW9wYWNpdHk6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CgkJCQlpZiAoIGNvbXB1dGVkICkgewoKCQkJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQoJCQkJCXZhciByZXQgPSBjdXJDU1MoIGVsZW0sICJvcGFjaXR5IiApOwoJCQkJCXJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBEb24ndCBhdXRvbWF0aWNhbGx5IGFkZCAicHgiIHRvIHRoZXNlIHBvc3NpYmx5LXVuaXRsZXNzIHByb3BlcnRpZXMKCWNzc051bWJlcjogewoJCSJhbmltYXRpb25JdGVyYXRpb25Db3VudCI6IHRydWUsCgkJImNvbHVtbkNvdW50IjogdHJ1ZSwKCQkiZmlsbE9wYWNpdHkiOiB0cnVlLAoJCSJmbGV4R3JvdyI6IHRydWUsCgkJImZsZXhTaHJpbmsiOiB0cnVlLAoJCSJmb250V2VpZ2h0IjogdHJ1ZSwKCQkiZ3JpZEFyZWEiOiB0cnVlLAoJCSJncmlkQ29sdW1uIjogdHJ1ZSwKCQkiZ3JpZENvbHVtbkVuZCI6IHRydWUsCgkJImdyaWRDb2x1bW5TdGFydCI6IHRydWUsCgkJImdyaWRSb3ciOiB0cnVlLAoJCSJncmlkUm93RW5kIjogdHJ1ZSwKCQkiZ3JpZFJvd1N0YXJ0IjogdHJ1ZSwKCQkibGluZUhlaWdodCI6IHRydWUsCgkJIm9wYWNpdHkiOiB0cnVlLAoJCSJvcmRlciI6IHRydWUsCgkJIm9ycGhhbnMiOiB0cnVlLAoJCSJ3aWRvd3MiOiB0cnVlLAoJCSJ6SW5kZXgiOiB0cnVlLAoJCSJ6b29tIjogdHJ1ZQoJfSwKCgkvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCgkvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCgljc3NQcm9wczoge30sCgoJLy8gR2V0IGFuZCBzZXQgdGhlIHN0eWxlIHByb3BlcnR5IG9uIGEgRE9NIE5vZGUKCXN0eWxlOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhICkgewoKCQkvLyBEb24ndCBzZXQgc3R5bGVzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKCQlpZiAoICFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhZWxlbS5zdHlsZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lCgkJdmFyIHJldCwgdHlwZSwgaG9va3MsCgkJCW9yaWdOYW1lID0gY2FtZWxDYXNlKCBuYW1lICksCgkJCWlzQ3VzdG9tUHJvcCA9IHJjdXN0b21Qcm9wLnRlc3QoIG5hbWUgKSwKCQkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUuIFdlIGRvbid0CgkJLy8gd2FudCB0byBxdWVyeSB0aGUgdmFsdWUgaWYgaXQgaXMgYSBDU1MgY3VzdG9tIHByb3BlcnR5CgkJLy8gc2luY2UgdGhleSBhcmUgdXNlci1kZWZpbmVkLgoJCWlmICggIWlzQ3VzdG9tUHJvcCApIHsKCQkJbmFtZSA9IGZpbmFsUHJvcE5hbWUoIG9yaWdOYW1lICk7CgkJfQoKCQkvLyBHZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uLCB0aGVuIHVucHJlZml4ZWQgdmVyc2lvbgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKCQkvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCXR5cGUgPSB0eXBlb2YgdmFsdWU7CgoJCQkvLyBDb252ZXJ0ICIrPSIgb3IgIi09IiB0byByZWxhdGl2ZSBudW1iZXJzICgjNzM0NSkKCQkJaWYgKCB0eXBlID09PSAic3RyaW5nIiAmJiAoIHJldCA9IHJjc3NOdW0uZXhlYyggdmFsdWUgKSApICYmIHJldFsgMSBdICkgewoJCQkJdmFsdWUgPSBhZGp1c3RDU1MoIGVsZW0sIG5hbWUsIHJldCApOwoKCQkJCS8vIEZpeGVzIGJ1ZyAjOTIzNwoJCQkJdHlwZSA9ICJudW1iZXIiOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhhdCBudWxsIGFuZCBOYU4gdmFsdWVzIGFyZW4ndCBzZXQgKCM3MTE2KQoJCQlpZiAoIHZhbHVlID09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBhIG51bWJlciB3YXMgcGFzc2VkIGluLCBhZGQgdGhlIHVuaXQgKGV4Y2VwdCBmb3IgY2VydGFpbiBDU1MgcHJvcGVydGllcykKCQkJLy8gVGhlIGlzQ3VzdG9tUHJvcCBjaGVjayBjYW4gYmUgcmVtb3ZlZCBpbiBqUXVlcnkgNC4wIHdoZW4gd2Ugb25seSBhdXRvLWFwcGVuZAoJCQkvLyAicHgiIHRvIGEgZmV3IGhhcmRjb2RlZCB2YWx1ZXMuCgkJCWlmICggdHlwZSA9PT0gIm51bWJlciIgJiYgIWlzQ3VzdG9tUHJvcCApIHsKCQkJCXZhbHVlICs9IHJldCAmJiByZXRbIDMgXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIG9yaWdOYW1lIF0gPyAiIiA6ICJweCIgKTsKCQkJfQoKCQkJLy8gYmFja2dyb3VuZC0qIHByb3BzIGFmZmVjdCBvcmlnaW5hbCBjbG9uZSdzIHZhbHVlcwoJCQlpZiAoICFzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSAmJiB2YWx1ZSA9PT0gIiIgJiYgbmFtZS5pbmRleE9mKCAiYmFja2dyb3VuZCIgKSA9PT0gMCApIHsKCQkJCXN0eWxlWyBuYW1lIF0gPSAiaW5oZXJpdCI7CgkJCX0KCgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQoJCQlpZiAoICFob29rcyB8fCAhKCAic2V0IiBpbiBob29rcyApIHx8CgkJCQkoIHZhbHVlID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgZXh0cmEgKSApICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJaWYgKCBpc0N1c3RvbVByb3AgKSB7CgkJCQkJc3R5bGUuc2V0UHJvcGVydHkoIG5hbWUsIHZhbHVlICk7CgkJCQl9IGVsc2UgewoJCQkJCXN0eWxlWyBuYW1lIF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoKCQl9IGVsc2UgewoKCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCgkJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYKCQkJCSggcmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBmYWxzZSwgZXh0cmEgKSApICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJcmV0dXJuIHJldDsKCQkJfQoKCQkJLy8gT3RoZXJ3aXNlIGp1c3QgZ2V0IHRoZSB2YWx1ZSBmcm9tIHRoZSBzdHlsZSBvYmplY3QKCQkJcmV0dXJuIHN0eWxlWyBuYW1lIF07CgkJfQoJfSwKCgljc3M6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBleHRyYSwgc3R5bGVzICkgewoJCXZhciB2YWwsIG51bSwgaG9va3MsCgkJCW9yaWdOYW1lID0gY2FtZWxDYXNlKCBuYW1lICksCgkJCWlzQ3VzdG9tUHJvcCA9IHJjdXN0b21Qcm9wLnRlc3QoIG5hbWUgKTsKCgkJLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lLiBXZSBkb24ndAoJCS8vIHdhbnQgdG8gbW9kaWZ5IHRoZSB2YWx1ZSBpZiBpdCBpcyBhIENTUyBjdXN0b20gcHJvcGVydHkKCQkvLyBzaW5jZSB0aGV5IGFyZSB1c2VyLWRlZmluZWQuCgkJaWYgKCAhaXNDdXN0b21Qcm9wICkgewoJCQluYW1lID0gZmluYWxQcm9wTmFtZSggb3JpZ05hbWUgKTsKCQl9CgoJCS8vIFRyeSBwcmVmaXhlZCBuYW1lIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIG5hbWUKCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCgkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICkgewoJCQl2YWwgPSBob29rcy5nZXQoIGVsZW0sIHRydWUsIGV4dHJhICk7CgkJfQoKCQkvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAoJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCXZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSwgc3R5bGVzICk7CgkJfQoKCQkvLyBDb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCgkJaWYgKCB2YWwgPT09ICJub3JtYWwiICYmIG5hbWUgaW4gY3NzTm9ybWFsVHJhbnNmb3JtICkgewoJCQl2YWwgPSBjc3NOb3JtYWxUcmFuc2Zvcm1bIG5hbWUgXTsKCQl9CgoJCS8vIE1ha2UgbnVtZXJpYyBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYwoJCWlmICggZXh0cmEgPT09ICIiIHx8IGV4dHJhICkgewoJCQludW0gPSBwYXJzZUZsb2F0KCB2YWwgKTsKCQkJcmV0dXJuIGV4dHJhID09PSB0cnVlIHx8IGlzRmluaXRlKCBudW0gKSA/IG51bSB8fCAwIDogdmFsOwoJCX0KCgkJcmV0dXJuIHZhbDsKCX0KfSApOwoKalF1ZXJ5LmVhY2goIFsgImhlaWdodCIsICJ3aWR0aCIgXSwgZnVuY3Rpb24oIGksIGRpbWVuc2lvbiApIHsKCWpRdWVyeS5jc3NIb29rc1sgZGltZW5zaW9uIF0gPSB7CgkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQsIGV4dHJhICkgewoJCQlpZiAoIGNvbXB1dGVkICkgewoKCQkJCS8vIENlcnRhaW4gZWxlbWVudHMgY2FuIGhhdmUgZGltZW5zaW9uIGluZm8gaWYgd2UgaW52aXNpYmx5IHNob3cgdGhlbQoJCQkJLy8gYnV0IGl0IG11c3QgaGF2ZSBhIGN1cnJlbnQgZGlzcGxheSBzdHlsZSB0aGF0IHdvdWxkIGJlbmVmaXQKCQkJCXJldHVybiByZGlzcGxheXN3YXAudGVzdCggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgKSAmJgoKCQkJCQkvLyBTdXBwb3J0OiBTYWZhcmkgOCsKCQkJCQkvLyBUYWJsZSBjb2x1bW5zIGluIFNhZmFyaSBoYXZlIG5vbi16ZXJvIG9mZnNldFdpZHRoICYgemVybwoJCQkJCS8vIGdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoIHVubGVzcyBkaXNwbGF5IGlzIGNoYW5nZWQuCgkJCQkJLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CgkJCQkJLy8gUnVubmluZyBnZXRCb3VuZGluZ0NsaWVudFJlY3Qgb24gYSBkaXNjb25uZWN0ZWQgbm9kZQoJCQkJCS8vIGluIElFIHRocm93cyBhbiBlcnJvci4KCQkJCQkoICFlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoIHx8ICFlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoICkgPwoJCQkJCQlzd2FwKCBlbGVtLCBjc3NTaG93LCBmdW5jdGlvbigpIHsKCQkJCQkJCXJldHVybiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBkaW1lbnNpb24sIGV4dHJhICk7CgkJCQkJCX0gKSA6CgkJCQkJCWdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIGRpbWVuc2lvbiwgZXh0cmEgKTsKCQkJfQoJCX0sCgoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBleHRyYSApIHsKCQkJdmFyIG1hdGNoZXMsCgkJCQlzdHlsZXMgPSBnZXRTdHlsZXMoIGVsZW0gKSwKCgkJCQkvLyBPbmx5IHJlYWQgc3R5bGVzLnBvc2l0aW9uIGlmIHRoZSB0ZXN0IGhhcyBhIGNoYW5jZSB0byBmYWlsCgkJCQkvLyB0byBhdm9pZCBmb3JjaW5nIGEgcmVmbG93LgoJCQkJc2Nyb2xsYm94U2l6ZUJ1Z2d5ID0gIXN1cHBvcnQuc2Nyb2xsYm94U2l6ZSgpICYmCgkJCQkJc3R5bGVzLnBvc2l0aW9uID09PSAiYWJzb2x1dGUiLAoKCQkJCS8vIFRvIGF2b2lkIGZvcmNpbmcgYSByZWZsb3csIG9ubHkgZmV0Y2ggYm94U2l6aW5nIGlmIHdlIG5lZWQgaXQgKGdoLTM5OTEpCgkJCQlib3hTaXppbmdOZWVkZWQgPSBzY3JvbGxib3hTaXplQnVnZ3kgfHwgZXh0cmEsCgkJCQlpc0JvcmRlckJveCA9IGJveFNpemluZ05lZWRlZCAmJgoJCQkJCWpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKCQkJCXN1YnRyYWN0ID0gZXh0cmEgPwoJCQkJCWJveE1vZGVsQWRqdXN0bWVudCgKCQkJCQkJZWxlbSwKCQkJCQkJZGltZW5zaW9uLAoJCQkJCQlleHRyYSwKCQkJCQkJaXNCb3JkZXJCb3gsCgkJCQkJCXN0eWxlcwoJCQkJCSkgOgoJCQkJCTA7CgoJCQkvLyBBY2NvdW50IGZvciB1bnJlbGlhYmxlIGJvcmRlci1ib3ggZGltZW5zaW9ucyBieSBjb21wYXJpbmcgb2Zmc2V0KiB0byBjb21wdXRlZCBhbmQKCQkJLy8gZmFraW5nIGEgY29udGVudC1ib3ggdG8gZ2V0IGJvcmRlciBhbmQgcGFkZGluZyAoZ2gtMzY5OSkKCQkJaWYgKCBpc0JvcmRlckJveCAmJiBzY3JvbGxib3hTaXplQnVnZ3kgKSB7CgkJCQlzdWJ0cmFjdCAtPSBNYXRoLmNlaWwoCgkJCQkJZWxlbVsgIm9mZnNldCIgKyBkaW1lbnNpb25bIDAgXS50b1VwcGVyQ2FzZSgpICsgZGltZW5zaW9uLnNsaWNlKCAxICkgXSAtCgkJCQkJcGFyc2VGbG9hdCggc3R5bGVzWyBkaW1lbnNpb24gXSApIC0KCQkJCQlib3hNb2RlbEFkanVzdG1lbnQoIGVsZW0sIGRpbWVuc2lvbiwgImJvcmRlciIsIGZhbHNlLCBzdHlsZXMgKSAtCgkJCQkJMC41CgkJCQkpOwoJCQl9CgoJCQkvLyBDb252ZXJ0IHRvIHBpeGVscyBpZiB2YWx1ZSBhZGp1c3RtZW50IGlzIG5lZWRlZAoJCQlpZiAoIHN1YnRyYWN0ICYmICggbWF0Y2hlcyA9IHJjc3NOdW0uZXhlYyggdmFsdWUgKSApICYmCgkJCQkoIG1hdGNoZXNbIDMgXSB8fCAicHgiICkgIT09ICJweCIgKSB7CgoJCQkJZWxlbS5zdHlsZVsgZGltZW5zaW9uIF0gPSB2YWx1ZTsKCQkJCXZhbHVlID0galF1ZXJ5LmNzcyggZWxlbSwgZGltZW5zaW9uICk7CgkJCX0KCgkJCXJldHVybiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIHN1YnRyYWN0ICk7CgkJfQoJfTsKfSApOwoKalF1ZXJ5LmNzc0hvb2tzLm1hcmdpbkxlZnQgPSBhZGRHZXRIb29rSWYoIHN1cHBvcnQucmVsaWFibGVNYXJnaW5MZWZ0LAoJZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCWlmICggY29tcHV0ZWQgKSB7CgkJCXJldHVybiAoIHBhcnNlRmxvYXQoIGN1ckNTUyggZWxlbSwgIm1hcmdpbkxlZnQiICkgKSB8fAoJCQkJZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0IC0KCQkJCQlzd2FwKCBlbGVtLCB7IG1hcmdpbkxlZnQ6IDAgfSwgZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7CgkJCQkJfSApCgkJCQkpICsgInB4IjsKCQl9Cgl9Cik7CgovLyBUaGVzZSBob29rcyBhcmUgdXNlZCBieSBhbmltYXRlIHRvIGV4cGFuZCBwcm9wZXJ0aWVzCmpRdWVyeS5lYWNoKCB7CgltYXJnaW46ICIiLAoJcGFkZGluZzogIiIsCglib3JkZXI6ICJXaWR0aCIKfSwgZnVuY3Rpb24oIHByZWZpeCwgc3VmZml4ICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBwcmVmaXggKyBzdWZmaXggXSA9IHsKCQlleHBhbmQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIGkgPSAwLAoJCQkJZXhwYW5kZWQgPSB7fSwKCgkJCQkvLyBBc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKCQkJCXBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCAiICIgKSA6IFsgdmFsdWUgXTsKCgkJCWZvciAoIDsgaSA8IDQ7IGkrKyApIHsKCQkJCWV4cGFuZGVkWyBwcmVmaXggKyBjc3NFeHBhbmRbIGkgXSArIHN1ZmZpeCBdID0KCQkJCQlwYXJ0c1sgaSBdIHx8IHBhcnRzWyBpIC0gMiBdIHx8IHBhcnRzWyAwIF07CgkJCX0KCgkJCXJldHVybiBleHBhbmRlZDsKCQl9Cgl9OwoKCWlmICggcHJlZml4ICE9PSAibWFyZ2luIiApIHsKCQlqUXVlcnkuY3NzSG9va3NbIHByZWZpeCArIHN1ZmZpeCBdLnNldCA9IHNldFBvc2l0aXZlTnVtYmVyOwoJfQp9ICk7CgpqUXVlcnkuZm4uZXh0ZW5kKCB7Cgljc3M6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJCXZhciBzdHlsZXMsIGxlbiwKCQkJCW1hcCA9IHt9LAoJCQkJaSA9IDA7CgoJCQlpZiAoIEFycmF5LmlzQXJyYXkoIG5hbWUgKSApIHsKCQkJCXN0eWxlcyA9IGdldFN0eWxlcyggZWxlbSApOwoJCQkJbGVuID0gbmFtZS5sZW5ndGg7CgoJCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCQkJbWFwWyBuYW1lWyBpIF0gXSA9IGpRdWVyeS5jc3MoIGVsZW0sIG5hbWVbIGkgXSwgZmFsc2UsIHN0eWxlcyApOwoJCQkJfQoKCQkJCXJldHVybiBtYXA7CgkJCX0KCgkJCXJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8KCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSwgdmFsdWUgKSA6CgkJCQlqUXVlcnkuY3NzKCBlbGVtLCBuYW1lICk7CgkJfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9Cn0gKTsKCgpmdW5jdGlvbiBUd2VlbiggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKSB7CglyZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApOwp9CmpRdWVyeS5Ud2VlbiA9IFR3ZWVuOwoKVHdlZW4ucHJvdG90eXBlID0gewoJY29uc3RydWN0b3I6IFR3ZWVuLAoJaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgewoJCXRoaXMuZWxlbSA9IGVsZW07CgkJdGhpcy5wcm9wID0gcHJvcDsKCQl0aGlzLmVhc2luZyA9IGVhc2luZyB8fCBqUXVlcnkuZWFzaW5nLl9kZWZhdWx0OwoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKCQl0aGlzLmVuZCA9IGVuZDsKCQl0aGlzLnVuaXQgPSB1bml0IHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICk7Cgl9LAoJY3VyOiBmdW5jdGlvbigpIHsKCQl2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbIHRoaXMucHJvcCBdOwoKCQlyZXR1cm4gaG9va3MgJiYgaG9va3MuZ2V0ID8KCQkJaG9va3MuZ2V0KCB0aGlzICkgOgoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KCB0aGlzICk7Cgl9LAoJcnVuOiBmdW5jdGlvbiggcGVyY2VudCApIHsKCQl2YXIgZWFzZWQsCgkJCWhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKSB7CgkJCXRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nWyB0aGlzLmVhc2luZyBdKAoJCQkJcGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uCgkJCSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5wb3MgPSBlYXNlZCA9IHBlcmNlbnQ7CgkJfQoJCXRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuc3RlcCApIHsKCQkJdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCggdGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyApOwoJCX0KCgkJaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7CgkJCWhvb2tzLnNldCggdGhpcyApOwoJCX0gZWxzZSB7CgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQoIHRoaXMgKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cn07CgpUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7CgpUd2Vlbi5wcm9wSG9va3MgPSB7CglfZGVmYXVsdDogewoJCWdldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQl2YXIgcmVzdWx0OwoKCQkJLy8gVXNlIGEgcHJvcGVydHkgb24gdGhlIGVsZW1lbnQgZGlyZWN0bHkgd2hlbiBpdCBpcyBub3QgYSBET00gZWxlbWVudCwKCQkJLy8gb3Igd2hlbiB0aGVyZSBpcyBubyBtYXRjaGluZyBzdHlsZSBwcm9wZXJ0eSB0aGF0IGV4aXN0cy4KCQkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICE9PSAxIHx8CgkJCQl0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gIT0gbnVsbCAmJiB0d2Vlbi5lbGVtLnN0eWxlWyB0d2Vlbi5wcm9wIF0gPT0gbnVsbCApIHsKCQkJCXJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07CgkJCX0KCgkJCS8vIFBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQoJCQkvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzLgoJCQkvLyBTaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQ7CgkJCS8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzLWlzLgoJCQlyZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiIiApOwoKCQkJLy8gRW1wdHkgc3RyaW5ncywgbnVsbCwgdW5kZWZpbmVkIGFuZCAiYXV0byIgYXJlIGNvbnZlcnRlZCB0byAwLgoJCQlyZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCgkJCS8vIFVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0LgoJCQkvLyBVc2UgY3NzSG9vayBpZiBpdHMgdGhlcmUuCgkJCS8vIFVzZSAuc3R5bGUgaWYgYXZhaWxhYmxlIGFuZCB1c2UgcGxhaW4gcHJvcGVydGllcyB3aGVyZSBhdmFpbGFibGUuCgkJCWlmICggalF1ZXJ5LmZ4LnN0ZXBbIHR3ZWVuLnByb3AgXSApIHsKCQkJCWpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0oIHR3ZWVuICk7CgkJCX0gZWxzZSBpZiAoIHR3ZWVuLmVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKAoJCQkJCWpRdWVyeS5jc3NIb29rc1sgdHdlZW4ucHJvcCBdIHx8CgkJCQkJdHdlZW4uZWxlbS5zdHlsZVsgZmluYWxQcm9wTmFtZSggdHdlZW4ucHJvcCApIF0gIT0gbnVsbCApICkgewoJCQkJalF1ZXJ5LnN0eWxlKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCB0d2Vlbi5ub3cgKyB0d2Vlbi51bml0ICk7CgkJCX0gZWxzZSB7CgkJCQl0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gPSB0d2Vlbi5ub3c7CgkJCX0KCQl9Cgl9Cn07CgovLyBTdXBwb3J0OiBJRSA8PTkgb25seQovLyBQYW5pYyBiYXNlZCBhcHByb2FjaCB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gewoJc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CgkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICYmIHR3ZWVuLmVsZW0ucGFyZW50Tm9kZSApIHsKCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCX0KCX0KfTsKCmpRdWVyeS5lYXNpbmcgPSB7CglsaW5lYXI6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiBwOwoJfSwKCXN3aW5nOiBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gMC41IC0gTWF0aC5jb3MoIHAgKiBNYXRoLlBJICkgLyAyOwoJfSwKCV9kZWZhdWx0OiAic3dpbmciCn07CgpqUXVlcnkuZnggPSBUd2Vlbi5wcm90b3R5cGUuaW5pdDsKCi8vIEJhY2sgY29tcGF0IDwxLjggZXh0ZW5zaW9uIHBvaW50CmpRdWVyeS5meC5zdGVwID0ge307CgoKCgp2YXIKCWZ4Tm93LCBpblByb2dyZXNzLAoJcmZ4dHlwZXMgPSAvXig/OnRvZ2dsZXxzaG93fGhpZGUpJC8sCglycnVuID0gL3F1ZXVlSG9va3MkLzsKCmZ1bmN0aW9uIHNjaGVkdWxlKCkgewoJaWYgKCBpblByb2dyZXNzICkgewoJCWlmICggZG9jdW1lbnQuaGlkZGVuID09PSBmYWxzZSAmJiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lICkgewoJCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCBzY2hlZHVsZSApOwoJCX0gZWxzZSB7CgkJCXdpbmRvdy5zZXRUaW1lb3V0KCBzY2hlZHVsZSwgalF1ZXJ5LmZ4LmludGVydmFsICk7CgkJfQoKCQlqUXVlcnkuZngudGljaygpOwoJfQp9CgovLyBBbmltYXRpb25zIGNyZWF0ZWQgc3luY2hyb25vdXNseSB3aWxsIHJ1biBzeW5jaHJvbm91c2x5CmZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewoJd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCWZ4Tm93ID0gdW5kZWZpbmVkOwoJfSApOwoJcmV0dXJuICggZnhOb3cgPSBEYXRlLm5vdygpICk7Cn0KCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBpbmNsdWRlV2lkdGggKSB7Cgl2YXIgd2hpY2gsCgkJaSA9IDAsCgkJYXR0cnMgPSB7IGhlaWdodDogdHlwZSB9OwoKCS8vIElmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKCS8vIG90aGVyd2lzZSBzdGVwIHZhbHVlIGlzIDIgdG8gc2tpcCBvdmVyIExlZnQgYW5kIFJpZ2h0CglpbmNsdWRlV2lkdGggPSBpbmNsdWRlV2lkdGggPyAxIDogMDsKCWZvciAoIDsgaSA8IDQ7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCApIHsKCQl3aGljaCA9IGNzc0V4cGFuZFsgaSBdOwoJCWF0dHJzWyAibWFyZ2luIiArIHdoaWNoIF0gPSBhdHRyc1sgInBhZGRpbmciICsgd2hpY2ggXSA9IHR5cGU7Cgl9CgoJaWYgKCBpbmNsdWRlV2lkdGggKSB7CgkJYXR0cnMub3BhY2l0eSA9IGF0dHJzLndpZHRoID0gdHlwZTsKCX0KCglyZXR1cm4gYXR0cnM7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVR3ZWVuKCB2YWx1ZSwgcHJvcCwgYW5pbWF0aW9uICkgewoJdmFyIHR3ZWVuLAoJCWNvbGxlY3Rpb24gPSAoIEFuaW1hdGlvbi50d2VlbmVyc1sgcHJvcCBdIHx8IFtdICkuY29uY2F0KCBBbmltYXRpb24udHdlZW5lcnNbICIqIiBdICksCgkJaW5kZXggPSAwLAoJCWxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQlpZiAoICggdHdlZW4gPSBjb2xsZWN0aW9uWyBpbmRleCBdLmNhbGwoIGFuaW1hdGlvbiwgcHJvcCwgdmFsdWUgKSApICkgewoKCQkJLy8gV2UncmUgZG9uZSB3aXRoIHRoaXMgcHJvcGVydHkKCQkJcmV0dXJuIHR3ZWVuOwoJCX0KCX0KfQoKZnVuY3Rpb24gZGVmYXVsdFByZWZpbHRlciggZWxlbSwgcHJvcHMsIG9wdHMgKSB7Cgl2YXIgcHJvcCwgdmFsdWUsIHRvZ2dsZSwgaG9va3MsIG9sZGZpcmUsIHByb3BUd2VlbiwgcmVzdG9yZURpc3BsYXksIGRpc3BsYXksCgkJaXNCb3ggPSAid2lkdGgiIGluIHByb3BzIHx8ICJoZWlnaHQiIGluIHByb3BzLAoJCWFuaW0gPSB0aGlzLAoJCW9yaWcgPSB7fSwKCQlzdHlsZSA9IGVsZW0uc3R5bGUsCgkJaGlkZGVuID0gZWxlbS5ub2RlVHlwZSAmJiBpc0hpZGRlbldpdGhpblRyZWUoIGVsZW0gKSwKCQlkYXRhU2hvdyA9IGRhdGFQcml2LmdldCggZWxlbSwgImZ4c2hvdyIgKTsKCgkvLyBRdWV1ZS1za2lwcGluZyBhbmltYXRpb25zIGhpamFjayB0aGUgZnggaG9va3MKCWlmICggIW9wdHMucXVldWUgKSB7CgkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sICJmeCIgKTsKCQlpZiAoIGhvb2tzLnVucXVldWVkID09IG51bGwgKSB7CgkJCWhvb2tzLnVucXVldWVkID0gMDsKCQkJb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CgkJCWhvb2tzLmVtcHR5LmZpcmUgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggIWhvb2tzLnVucXVldWVkICkgewoJCQkJCW9sZGZpcmUoKTsKCQkJCX0KCQkJfTsKCQl9CgkJaG9va3MudW5xdWV1ZWQrKzsKCgkJYW5pbS5hbHdheXMoIGZ1bmN0aW9uKCkgewoKCQkJLy8gRW5zdXJlIHRoZSBjb21wbGV0ZSBoYW5kbGVyIGlzIGNhbGxlZCBiZWZvcmUgdGhpcyBjb21wbGV0ZXMKCQkJYW5pbS5hbHdheXMoIGZ1bmN0aW9uKCkgewoJCQkJaG9va3MudW5xdWV1ZWQtLTsKCQkJCWlmICggIWpRdWVyeS5xdWV1ZSggZWxlbSwgImZ4IiApLmxlbmd0aCApIHsKCQkJCQlob29rcy5lbXB0eS5maXJlKCk7CgkJCQl9CgkJCX0gKTsKCQl9ICk7Cgl9CgoJLy8gRGV0ZWN0IHNob3cvaGlkZSBhbmltYXRpb25zCglmb3IgKCBwcm9wIGluIHByb3BzICkgewoJCXZhbHVlID0gcHJvcHNbIHByb3AgXTsKCQlpZiAoIHJmeHR5cGVzLnRlc3QoIHZhbHVlICkgKSB7CgkJCWRlbGV0ZSBwcm9wc1sgcHJvcCBdOwoJCQl0b2dnbGUgPSB0b2dnbGUgfHwgdmFsdWUgPT09ICJ0b2dnbGUiOwoJCQlpZiAoIHZhbHVlID09PSAoIGhpZGRlbiA/ICJoaWRlIiA6ICJzaG93IiApICkgewoKCQkJCS8vIFByZXRlbmQgdG8gYmUgaGlkZGVuIGlmIHRoaXMgaXMgYSAic2hvdyIgYW5kCgkJCQkvLyB0aGVyZSBpcyBzdGlsbCBkYXRhIGZyb20gYSBzdG9wcGVkIHNob3cvaGlkZQoJCQkJaWYgKCB2YWx1ZSA9PT0gInNob3ciICYmIGRhdGFTaG93ICYmIGRhdGFTaG93WyBwcm9wIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCQloaWRkZW4gPSB0cnVlOwoKCQkJCS8vIElnbm9yZSBhbGwgb3RoZXIgbm8tb3Agc2hvdy9oaWRlIGRhdGEKCQkJCX0gZWxzZSB7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCX0KCQkJb3JpZ1sgcHJvcCBdID0gZGF0YVNob3cgJiYgZGF0YVNob3dbIHByb3AgXSB8fCBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AgKTsKCQl9Cgl9CgoJLy8gQmFpbCBvdXQgaWYgdGhpcyBpcyBhIG5vLW9wIGxpa2UgLmhpZGUoKS5oaWRlKCkKCXByb3BUd2VlbiA9ICFqUXVlcnkuaXNFbXB0eU9iamVjdCggcHJvcHMgKTsKCWlmICggIXByb3BUd2VlbiAmJiBqUXVlcnkuaXNFbXB0eU9iamVjdCggb3JpZyApICkgewoJCXJldHVybjsKCX0KCgkvLyBSZXN0cmljdCAib3ZlcmZsb3ciIGFuZCAiZGlzcGxheSIgc3R5bGVzIGR1cmluZyBib3ggYW5pbWF0aW9ucwoJaWYgKCBpc0JveCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoKCQkvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSwgRWRnZSAxMiAtIDE1CgkJLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRSBkb2VzIG5vdCBpbmZlciB0aGUgc2hvcnRoYW5kCgkJLy8gZnJvbSBpZGVudGljYWxseS12YWx1ZWQgb3ZlcmZsb3dYIGFuZCBvdmVyZmxvd1kgYW5kIEVkZ2UganVzdCBtaXJyb3JzCgkJLy8gdGhlIG92ZXJmbG93WCB2YWx1ZSB0aGVyZS4KCQlvcHRzLm92ZXJmbG93ID0gWyBzdHlsZS5vdmVyZmxvdywgc3R5bGUub3ZlcmZsb3dYLCBzdHlsZS5vdmVyZmxvd1kgXTsKCgkJLy8gSWRlbnRpZnkgYSBkaXNwbGF5IHR5cGUsIHByZWZlcnJpbmcgb2xkIHNob3cvaGlkZSBkYXRhIG92ZXIgdGhlIENTUyBjYXNjYWRlCgkJcmVzdG9yZURpc3BsYXkgPSBkYXRhU2hvdyAmJiBkYXRhU2hvdy5kaXNwbGF5OwoJCWlmICggcmVzdG9yZURpc3BsYXkgPT0gbnVsbCApIHsKCQkJcmVzdG9yZURpc3BsYXkgPSBkYXRhUHJpdi5nZXQoIGVsZW0sICJkaXNwbGF5IiApOwoJCX0KCQlkaXNwbGF5ID0galF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICk7CgkJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgKSB7CgkJCWlmICggcmVzdG9yZURpc3BsYXkgKSB7CgkJCQlkaXNwbGF5ID0gcmVzdG9yZURpc3BsYXk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gR2V0IG5vbmVtcHR5IHZhbHVlKHMpIGJ5IHRlbXBvcmFyaWx5IGZvcmNpbmcgdmlzaWJpbGl0eQoJCQkJc2hvd0hpZGUoIFsgZWxlbSBdLCB0cnVlICk7CgkJCQlyZXN0b3JlRGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheSB8fCByZXN0b3JlRGlzcGxheTsKCQkJCWRpc3BsYXkgPSBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKTsKCQkJCXNob3dIaWRlKCBbIGVsZW0gXSApOwoJCQl9CgkJfQoKCQkvLyBBbmltYXRlIGlubGluZSBlbGVtZW50cyBhcyBpbmxpbmUtYmxvY2sKCQlpZiAoIGRpc3BsYXkgPT09ICJpbmxpbmUiIHx8IGRpc3BsYXkgPT09ICJpbmxpbmUtYmxvY2siICYmIHJlc3RvcmVEaXNwbGF5ICE9IG51bGwgKSB7CgkJCWlmICggalF1ZXJ5LmNzcyggZWxlbSwgImZsb2F0IiApID09PSAibm9uZSIgKSB7CgoJCQkJLy8gUmVzdG9yZSB0aGUgb3JpZ2luYWwgZGlzcGxheSB2YWx1ZSBhdCB0aGUgZW5kIG9mIHB1cmUgc2hvdy9oaWRlIGFuaW1hdGlvbnMKCQkJCWlmICggIXByb3BUd2VlbiApIHsKCQkJCQlhbmltLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCQlzdHlsZS5kaXNwbGF5ID0gcmVzdG9yZURpc3BsYXk7CgkJCQkJfSApOwoJCQkJCWlmICggcmVzdG9yZURpc3BsYXkgPT0gbnVsbCApIHsKCQkJCQkJZGlzcGxheSA9IHN0eWxlLmRpc3BsYXk7CgkJCQkJCXJlc3RvcmVEaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gIiIgOiBkaXNwbGF5OwoJCQkJCX0KCQkJCX0KCQkJCXN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsKCQkJfQoJCX0KCX0KCglpZiAoIG9wdHMub3ZlcmZsb3cgKSB7CgkJc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKCQlhbmltLmFsd2F5cyggZnVuY3Rpb24oKSB7CgkJCXN0eWxlLm92ZXJmbG93ID0gb3B0cy5vdmVyZmxvd1sgMCBdOwoJCQlzdHlsZS5vdmVyZmxvd1ggPSBvcHRzLm92ZXJmbG93WyAxIF07CgkJCXN0eWxlLm92ZXJmbG93WSA9IG9wdHMub3ZlcmZsb3dbIDIgXTsKCQl9ICk7Cgl9CgoJLy8gSW1wbGVtZW50IHNob3cvaGlkZSBhbmltYXRpb25zCglwcm9wVHdlZW4gPSBmYWxzZTsKCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCgkJLy8gR2VuZXJhbCBzaG93L2hpZGUgc2V0dXAgZm9yIHRoaXMgZWxlbWVudCBhbmltYXRpb24KCQlpZiAoICFwcm9wVHdlZW4gKSB7CgkJCWlmICggZGF0YVNob3cgKSB7CgkJCQlpZiAoICJoaWRkZW4iIGluIGRhdGFTaG93ICkgewoJCQkJCWhpZGRlbiA9IGRhdGFTaG93LmhpZGRlbjsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWRhdGFTaG93ID0gZGF0YVByaXYuYWNjZXNzKCBlbGVtLCAiZnhzaG93IiwgeyBkaXNwbGF5OiByZXN0b3JlRGlzcGxheSB9ICk7CgkJCX0KCgkJCS8vIFN0b3JlIGhpZGRlbi92aXNpYmxlIGZvciB0b2dnbGUgc28gYC5zdG9wKCkudG9nZ2xlKClgICJyZXZlcnNlcyIKCQkJaWYgKCB0b2dnbGUgKSB7CgkJCQlkYXRhU2hvdy5oaWRkZW4gPSAhaGlkZGVuOwoJCQl9CgoJCQkvLyBTaG93IGVsZW1lbnRzIGJlZm9yZSBhbmltYXRpbmcgdGhlbQoJCQlpZiAoIGhpZGRlbiApIHsKCQkJCXNob3dIaWRlKCBbIGVsZW0gXSwgdHJ1ZSApOwoJCQl9CgoJCQkvKiBlc2xpbnQtZGlzYWJsZSBuby1sb29wLWZ1bmMgKi8KCgkJCWFuaW0uZG9uZSggZnVuY3Rpb24oKSB7CgoJCQkvKiBlc2xpbnQtZW5hYmxlIG5vLWxvb3AtZnVuYyAqLwoKCQkJCS8vIFRoZSBmaW5hbCBzdGVwIG9mIGEgImhpZGUiIGFuaW1hdGlvbiBpcyBhY3R1YWxseSBoaWRpbmcgdGhlIGVsZW1lbnQKCQkJCWlmICggIWhpZGRlbiApIHsKCQkJCQlzaG93SGlkZSggWyBlbGVtIF0gKTsKCQkJCX0KCQkJCWRhdGFQcml2LnJlbW92ZSggZWxlbSwgImZ4c2hvdyIgKTsKCQkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AsIG9yaWdbIHByb3AgXSApOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQkvLyBQZXItcHJvcGVydHkgc2V0dXAKCQlwcm9wVHdlZW4gPSBjcmVhdGVUd2VlbiggaGlkZGVuID8gZGF0YVNob3dbIHByb3AgXSA6IDAsIHByb3AsIGFuaW0gKTsKCQlpZiAoICEoIHByb3AgaW4gZGF0YVNob3cgKSApIHsKCQkJZGF0YVNob3dbIHByb3AgXSA9IHByb3BUd2Vlbi5zdGFydDsKCQkJaWYgKCBoaWRkZW4gKSB7CgkJCQlwcm9wVHdlZW4uZW5kID0gcHJvcFR3ZWVuLnN0YXJ0OwoJCQkJcHJvcFR3ZWVuLnN0YXJ0ID0gMDsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gcHJvcEZpbHRlciggcHJvcHMsIHNwZWNpYWxFYXNpbmcgKSB7Cgl2YXIgaW5kZXgsIG5hbWUsIGVhc2luZywgdmFsdWUsIGhvb2tzOwoKCS8vIGNhbWVsQ2FzZSwgc3BlY2lhbEVhc2luZyBhbmQgZXhwYW5kIGNzc0hvb2sgcGFzcwoJZm9yICggaW5kZXggaW4gcHJvcHMgKSB7CgkJbmFtZSA9IGNhbWVsQ2FzZSggaW5kZXggKTsKCQllYXNpbmcgPSBzcGVjaWFsRWFzaW5nWyBuYW1lIF07CgkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXTsKCQlpZiAoIEFycmF5LmlzQXJyYXkoIHZhbHVlICkgKSB7CgkJCWVhc2luZyA9IHZhbHVlWyAxIF07CgkJCXZhbHVlID0gcHJvcHNbIGluZGV4IF0gPSB2YWx1ZVsgMCBdOwoJCX0KCgkJaWYgKCBpbmRleCAhPT0gbmFtZSApIHsKCQkJcHJvcHNbIG5hbWUgXSA9IHZhbHVlOwoJCQlkZWxldGUgcHJvcHNbIGluZGV4IF07CgkJfQoKCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdOwoJCWlmICggaG9va3MgJiYgImV4cGFuZCIgaW4gaG9va3MgKSB7CgkJCXZhbHVlID0gaG9va3MuZXhwYW5kKCB2YWx1ZSApOwoJCQlkZWxldGUgcHJvcHNbIG5hbWUgXTsKCgkJCS8vIE5vdCBxdWl0ZSAkLmV4dGVuZCwgdGhpcyB3b24ndCBvdmVyd3JpdGUgZXhpc3Rpbmcga2V5cy4KCQkJLy8gUmV1c2luZyAnaW5kZXgnIGJlY2F1c2Ugd2UgaGF2ZSB0aGUgY29ycmVjdCAibmFtZSIKCQkJZm9yICggaW5kZXggaW4gdmFsdWUgKSB7CgkJCQlpZiAoICEoIGluZGV4IGluIHByb3BzICkgKSB7CgkJCQkJcHJvcHNbIGluZGV4IF0gPSB2YWx1ZVsgaW5kZXggXTsKCQkJCQlzcGVjaWFsRWFzaW5nWyBpbmRleCBdID0gZWFzaW5nOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJc3BlY2lhbEVhc2luZ1sgbmFtZSBdID0gZWFzaW5nOwoJCX0KCX0KfQoKZnVuY3Rpb24gQW5pbWF0aW9uKCBlbGVtLCBwcm9wZXJ0aWVzLCBvcHRpb25zICkgewoJdmFyIHJlc3VsdCwKCQlzdG9wcGVkLAoJCWluZGV4ID0gMCwKCQlsZW5ndGggPSBBbmltYXRpb24ucHJlZmlsdGVycy5sZW5ndGgsCgkJZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoIGZ1bmN0aW9uKCkgewoKCQkJLy8gRG9uJ3QgbWF0Y2ggZWxlbSBpbiB0aGUgOmFuaW1hdGVkIHNlbGVjdG9yCgkJCWRlbGV0ZSB0aWNrLmVsZW07CgkJfSApLAoJCXRpY2sgPSBmdW5jdGlvbigpIHsKCQkJaWYgKCBzdG9wcGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCXZhciBjdXJyZW50VGltZSA9IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCgkJCQlyZW1haW5pbmcgPSBNYXRoLm1heCggMCwgYW5pbWF0aW9uLnN0YXJ0VGltZSArIGFuaW1hdGlvbi5kdXJhdGlvbiAtIGN1cnJlbnRUaW1lICksCgoJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMgb25seQoJCQkJLy8gQXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIGAxIC0gKCAwLjUgfHwgMCApYCAoIzEyNDk3KQoJCQkJdGVtcCA9IHJlbWFpbmluZyAvIGFuaW1hdGlvbi5kdXJhdGlvbiB8fCAwLAoJCQkJcGVyY2VudCA9IDEgLSB0ZW1wLAoJCQkJaW5kZXggPSAwLAoJCQkJbGVuZ3RoID0gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGg7CgoJCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCQkJYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIHBlcmNlbnQgKTsKCQkJfQoKCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIHBlcmNlbnQsIHJlbWFpbmluZyBdICk7CgoJCQkvLyBJZiB0aGVyZSdzIG1vcmUgdG8gZG8sIHlpZWxkCgkJCWlmICggcGVyY2VudCA8IDEgJiYgbGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbWFpbmluZzsKCQkJfQoKCQkJLy8gSWYgdGhpcyB3YXMgYW4gZW1wdHkgYW5pbWF0aW9uLCBzeW50aGVzaXplIGEgZmluYWwgcHJvZ3Jlc3Mgbm90aWZpY2F0aW9uCgkJCWlmICggIWxlbmd0aCApIHsKCQkJCWRlZmVycmVkLm5vdGlmeVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCAxLCAwIF0gKTsKCQkJfQoKCQkJLy8gUmVzb2x2ZSB0aGUgYW5pbWF0aW9uIGFuZCByZXBvcnQgaXRzIGNvbmNsdXNpb24KCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uIF0gKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgkJYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSggewoJCQllbGVtOiBlbGVtLAoJCQlwcm9wczogalF1ZXJ5LmV4dGVuZCgge30sIHByb3BlcnRpZXMgKSwKCQkJb3B0czogalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgewoJCQkJc3BlY2lhbEVhc2luZzoge30sCgkJCQllYXNpbmc6IGpRdWVyeS5lYXNpbmcuX2RlZmF1bHQKCQkJfSwgb3B0aW9ucyApLAoJCQlvcmlnaW5hbFByb3BlcnRpZXM6IHByb3BlcnRpZXMsCgkJCW9yaWdpbmFsT3B0aW9uczogb3B0aW9ucywKCQkJc3RhcnRUaW1lOiBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwKCQkJdHdlZW5zOiBbXSwKCQkJY3JlYXRlVHdlZW46IGZ1bmN0aW9uKCBwcm9wLCBlbmQgKSB7CgkJCQl2YXIgdHdlZW4gPSBqUXVlcnkuVHdlZW4oIGVsZW0sIGFuaW1hdGlvbi5vcHRzLCBwcm9wLCBlbmQsCgkJCQkJCWFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmdbIHByb3AgXSB8fCBhbmltYXRpb24ub3B0cy5lYXNpbmcgKTsKCQkJCWFuaW1hdGlvbi50d2VlbnMucHVzaCggdHdlZW4gKTsKCQkJCXJldHVybiB0d2VlbjsKCQkJfSwKCQkJc3RvcDogZnVuY3Rpb24oIGdvdG9FbmQgKSB7CgkJCQl2YXIgaW5kZXggPSAwLAoKCQkJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMKCQkJCQkvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKCQkJCQlsZW5ndGggPSBnb3RvRW5kID8gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGggOiAwOwoJCQkJaWYgKCBzdG9wcGVkICkgewoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQkJc3RvcHBlZCA9IHRydWU7CgkJCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCQkJCWFuaW1hdGlvbi50d2VlbnNbIGluZGV4IF0ucnVuKCAxICk7CgkJCQl9CgoJCQkJLy8gUmVzb2x2ZSB3aGVuIHdlIHBsYXllZCB0aGUgbGFzdCBmcmFtZTsgb3RoZXJ3aXNlLCByZWplY3QKCQkJCWlmICggZ290b0VuZCApIHsKCQkJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgMSwgMCBdICk7CgkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCQl9ICksCgkJcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7CgoJcHJvcEZpbHRlciggcHJvcHMsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmcgKTsKCglmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCXJlc3VsdCA9IEFuaW1hdGlvbi5wcmVmaWx0ZXJzWyBpbmRleCBdLmNhbGwoIGFuaW1hdGlvbiwgZWxlbSwgcHJvcHMsIGFuaW1hdGlvbi5vcHRzICk7CgkJaWYgKCByZXN1bHQgKSB7CgkJCWlmICggaXNGdW5jdGlvbiggcmVzdWx0LnN0b3AgKSApIHsKCQkJCWpRdWVyeS5fcXVldWVIb29rcyggYW5pbWF0aW9uLmVsZW0sIGFuaW1hdGlvbi5vcHRzLnF1ZXVlICkuc3RvcCA9CgkJCQkJcmVzdWx0LnN0b3AuYmluZCggcmVzdWx0ICk7CgkJCX0KCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CgoJalF1ZXJ5Lm1hcCggcHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24gKTsKCglpZiAoIGlzRnVuY3Rpb24oIGFuaW1hdGlvbi5vcHRzLnN0YXJ0ICkgKSB7CgkJYW5pbWF0aW9uLm9wdHMuc3RhcnQuY2FsbCggZWxlbSwgYW5pbWF0aW9uICk7Cgl9CgoJLy8gQXR0YWNoIGNhbGxiYWNrcyBmcm9tIG9wdGlvbnMKCWFuaW1hdGlvbgoJCS5wcm9ncmVzcyggYW5pbWF0aW9uLm9wdHMucHJvZ3Jlc3MgKQoJCS5kb25lKCBhbmltYXRpb24ub3B0cy5kb25lLCBhbmltYXRpb24ub3B0cy5jb21wbGV0ZSApCgkJLmZhaWwoIGFuaW1hdGlvbi5vcHRzLmZhaWwgKQoJCS5hbHdheXMoIGFuaW1hdGlvbi5vcHRzLmFsd2F5cyApOwoKCWpRdWVyeS5meC50aW1lcigKCQlqUXVlcnkuZXh0ZW5kKCB0aWNrLCB7CgkJCWVsZW06IGVsZW0sCgkJCWFuaW06IGFuaW1hdGlvbiwKCQkJcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCgkJfSApCgkpOwoKCXJldHVybiBhbmltYXRpb247Cn0KCmpRdWVyeS5BbmltYXRpb24gPSBqUXVlcnkuZXh0ZW5kKCBBbmltYXRpb24sIHsKCgl0d2VlbmVyczogewoJCSIqIjogWyBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJCXZhciB0d2VlbiA9IHRoaXMuY3JlYXRlVHdlZW4oIHByb3AsIHZhbHVlICk7CgkJCWFkanVzdENTUyggdHdlZW4uZWxlbSwgcHJvcCwgcmNzc051bS5leGVjKCB2YWx1ZSApLCB0d2VlbiApOwoJCQlyZXR1cm4gdHdlZW47CgkJfSBdCgl9LAoKCXR3ZWVuZXI6IGZ1bmN0aW9uKCBwcm9wcywgY2FsbGJhY2sgKSB7CgkJaWYgKCBpc0Z1bmN0aW9uKCBwcm9wcyApICkgewoJCQljYWxsYmFjayA9IHByb3BzOwoJCQlwcm9wcyA9IFsgIioiIF07CgkJfSBlbHNlIHsKCQkJcHJvcHMgPSBwcm9wcy5tYXRjaCggcm5vdGh0bWx3aGl0ZSApOwoJCX0KCgkJdmFyIHByb3AsCgkJCWluZGV4ID0gMCwKCQkJbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCQlwcm9wID0gcHJvcHNbIGluZGV4IF07CgkJCUFuaW1hdGlvbi50d2VlbmVyc1sgcHJvcCBdID0gQW5pbWF0aW9uLnR3ZWVuZXJzWyBwcm9wIF0gfHwgW107CgkJCUFuaW1hdGlvbi50d2VlbmVyc1sgcHJvcCBdLnVuc2hpZnQoIGNhbGxiYWNrICk7CgkJfQoJfSwKCglwcmVmaWx0ZXJzOiBbIGRlZmF1bHRQcmVmaWx0ZXIgXSwKCglwcmVmaWx0ZXI6IGZ1bmN0aW9uKCBjYWxsYmFjaywgcHJlcGVuZCApIHsKCQlpZiAoIHByZXBlbmQgKSB7CgkJCUFuaW1hdGlvbi5wcmVmaWx0ZXJzLnVuc2hpZnQoIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJQW5pbWF0aW9uLnByZWZpbHRlcnMucHVzaCggY2FsbGJhY2sgKTsKCQl9Cgl9Cn0gKTsKCmpRdWVyeS5zcGVlZCA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBmbiApIHsKCXZhciBvcHQgPSBzcGVlZCAmJiB0eXBlb2Ygc3BlZWQgPT09ICJvYmplY3QiID8galF1ZXJ5LmV4dGVuZCgge30sIHNwZWVkICkgOiB7CgkJY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwKCQkJaXNGdW5jdGlvbiggc3BlZWQgKSAmJiBzcGVlZCwKCQlkdXJhdGlvbjogc3BlZWQsCgkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFpc0Z1bmN0aW9uKCBlYXNpbmcgKSAmJiBlYXNpbmcKCX07CgoJLy8gR28gdG8gdGhlIGVuZCBzdGF0ZSBpZiBmeCBhcmUgb2ZmCglpZiAoIGpRdWVyeS5meC5vZmYgKSB7CgkJb3B0LmR1cmF0aW9uID0gMDsKCgl9IGVsc2UgewoJCWlmICggdHlwZW9mIG9wdC5kdXJhdGlvbiAhPT0gIm51bWJlciIgKSB7CgkJCWlmICggb3B0LmR1cmF0aW9uIGluIGpRdWVyeS5meC5zcGVlZHMgKSB7CgkJCQlvcHQuZHVyYXRpb24gPSBqUXVlcnkuZnguc3BlZWRzWyBvcHQuZHVyYXRpb24gXTsKCgkJCX0gZWxzZSB7CgkJCQlvcHQuZHVyYXRpb24gPSBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoJCQl9CgkJfQoJfQoKCS8vIE5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCIKCWlmICggb3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlICkgewoJCW9wdC5xdWV1ZSA9ICJmeCI7Cgl9CgoJLy8gUXVldWVpbmcKCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgoJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKCBpc0Z1bmN0aW9uKCBvcHQub2xkICkgKSB7CgkJCW9wdC5vbGQuY2FsbCggdGhpcyApOwoJCX0KCgkJaWYgKCBvcHQucXVldWUgKSB7CgkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCBvcHQucXVldWUgKTsKCQl9Cgl9OwoKCXJldHVybiBvcHQ7Cn07CgpqUXVlcnkuZm4uZXh0ZW5kKCB7CglmYWRlVG86IGZ1bmN0aW9uKCBzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2sgKSB7CgoJCS8vIFNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAoJCXJldHVybiB0aGlzLmZpbHRlciggaXNIaWRkZW5XaXRoaW5UcmVlICkuY3NzKCAib3BhY2l0eSIsIDAgKS5zaG93KCkKCgkJCS8vIEFuaW1hdGUgdG8gdGhlIHZhbHVlIHNwZWNpZmllZAoJCQkuZW5kKCkuYW5pbWF0ZSggeyBvcGFjaXR5OiB0byB9LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwoJfSwKCWFuaW1hdGU6IGZ1bmN0aW9uKCBwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQl2YXIgZW1wdHkgPSBqUXVlcnkuaXNFbXB0eU9iamVjdCggcHJvcCApLAoJCQlvcHRhbGwgPSBqUXVlcnkuc3BlZWQoIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICksCgkJCWRvQW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7CgoJCQkJLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKCQkJCXZhciBhbmltID0gQW5pbWF0aW9uKCB0aGlzLCBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcCApLCBvcHRhbGwgKTsKCgkJCQkvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKCQkJCWlmICggZW1wdHkgfHwgZGF0YVByaXYuZ2V0KCB0aGlzLCAiZmluaXNoIiApICkgewoJCQkJCWFuaW0uc3RvcCggdHJ1ZSApOwoJCQkJfQoJCQl9OwoJCQlkb0FuaW1hdGlvbi5maW5pc2ggPSBkb0FuaW1hdGlvbjsKCgkJcmV0dXJuIGVtcHR5IHx8IG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPwoJCQl0aGlzLmVhY2goIGRvQW5pbWF0aW9uICkgOgoJCQl0aGlzLnF1ZXVlKCBvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uICk7Cgl9LAoJc3RvcDogZnVuY3Rpb24oIHR5cGUsIGNsZWFyUXVldWUsIGdvdG9FbmQgKSB7CgkJdmFyIHN0b3BRdWV1ZSA9IGZ1bmN0aW9uKCBob29rcyApIHsKCQkJdmFyIHN0b3AgPSBob29rcy5zdG9wOwoJCQlkZWxldGUgaG9va3Muc3RvcDsKCQkJc3RvcCggZ290b0VuZCApOwoJCX07CgoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlnb3RvRW5kID0gY2xlYXJRdWV1ZTsKCQkJY2xlYXJRdWV1ZSA9IHR5cGU7CgkJCXR5cGUgPSB1bmRlZmluZWQ7CgkJfQoJCWlmICggY2xlYXJRdWV1ZSAmJiB0eXBlICE9PSBmYWxzZSApIHsKCQkJdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBkZXF1ZXVlID0gdHJ1ZSwKCQkJCWluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAicXVldWVIb29rcyIsCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCQkJZGF0YSA9IGRhdGFQcml2LmdldCggdGhpcyApOwoKCQkJaWYgKCBpbmRleCApIHsKCQkJCWlmICggZGF0YVsgaW5kZXggXSAmJiBkYXRhWyBpbmRleCBdLnN0b3AgKSB7CgkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCBpbmRleCBpbiBkYXRhICkgewoJCQkJCWlmICggZGF0YVsgaW5kZXggXSAmJiBkYXRhWyBpbmRleCBdLnN0b3AgJiYgcnJ1bi50ZXN0KCBpbmRleCApICkgewoJCQkJCQlzdG9wUXVldWUoIGRhdGFbIGluZGV4IF0gKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCWZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7CgkJCQlpZiAoIHRpbWVyc1sgaW5kZXggXS5lbGVtID09PSB0aGlzICYmCgkJCQkJKCB0eXBlID09IG51bGwgfHwgdGltZXJzWyBpbmRleCBdLnF1ZXVlID09PSB0eXBlICkgKSB7CgoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIGdvdG9FbmQgKTsKCQkJCQlkZXF1ZXVlID0gZmFsc2U7CgkJCQkJdGltZXJzLnNwbGljZSggaW5kZXgsIDEgKTsKCQkJCX0KCQkJfQoKCQkJLy8gU3RhcnQgdGhlIG5leHQgaW4gdGhlIHF1ZXVlIGlmIHRoZSBsYXN0IHN0ZXAgd2Fzbid0IGZvcmNlZC4KCQkJLy8gVGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaAoJCQkvLyB3aWxsIGRlcXVldWUgYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQuCgkJCWlmICggZGVxdWV1ZSB8fCAhZ290b0VuZCApIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJCX0KCQl9ICk7Cgl9LAoJZmluaXNoOiBmdW5jdGlvbiggdHlwZSApIHsKCQlpZiAoIHR5cGUgIT09IGZhbHNlICkgewoJCQl0eXBlID0gdHlwZSB8fCAiZngiOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGluZGV4LAoJCQkJZGF0YSA9IGRhdGFQcml2LmdldCggdGhpcyApLAoJCQkJcXVldWUgPSBkYXRhWyB0eXBlICsgInF1ZXVlIiBdLAoJCQkJaG9va3MgPSBkYXRhWyB0eXBlICsgInF1ZXVlSG9va3MiIF0sCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCQkJbGVuZ3RoID0gcXVldWUgPyBxdWV1ZS5sZW5ndGggOiAwOwoKCQkJLy8gRW5hYmxlIGZpbmlzaGluZyBmbGFnIG9uIHByaXZhdGUgZGF0YQoJCQlkYXRhLmZpbmlzaCA9IHRydWU7CgoJCQkvLyBFbXB0eSB0aGUgcXVldWUgZmlyc3QKCQkJalF1ZXJ5LnF1ZXVlKCB0aGlzLCB0eXBlLCBbXSApOwoKCQkJaWYgKCBob29rcyAmJiBob29rcy5zdG9wICkgewoJCQkJaG9va3Muc3RvcC5jYWxsKCB0aGlzLCB0cnVlICk7CgkJCX0KCgkJCS8vIExvb2sgZm9yIGFueSBhY3RpdmUgYW5pbWF0aW9ucywgYW5kIGZpbmlzaCB0aGVtCgkJCWZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7CgkJCQlpZiAoIHRpbWVyc1sgaW5kZXggXS5lbGVtID09PSB0aGlzICYmIHRpbWVyc1sgaW5kZXggXS5xdWV1ZSA9PT0gdHlwZSApIHsKCQkJCQl0aW1lcnNbIGluZGV4IF0uYW5pbS5zdG9wKCB0cnVlICk7CgkJCQkJdGltZXJzLnNwbGljZSggaW5kZXgsIDEgKTsKCQkJCX0KCQkJfQoKCQkJLy8gTG9vayBmb3IgYW55IGFuaW1hdGlvbnMgaW4gdGhlIG9sZCBxdWV1ZSBhbmQgZmluaXNoIHRoZW0KCQkJZm9yICggaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQkJCWlmICggcXVldWVbIGluZGV4IF0gJiYgcXVldWVbIGluZGV4IF0uZmluaXNoICkgewoJCQkJCXF1ZXVlWyBpbmRleCBdLmZpbmlzaC5jYWxsKCB0aGlzICk7CgkJCQl9CgkJCX0KCgkJCS8vIFR1cm4gb2ZmIGZpbmlzaGluZyBmbGFnCgkJCWRlbGV0ZSBkYXRhLmZpbmlzaDsKCQl9ICk7Cgl9Cn0gKTsKCmpRdWVyeS5lYWNoKCBbICJ0b2dnbGUiLCAic2hvdyIsICJoaWRlIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCXZhciBjc3NGbiA9IGpRdWVyeS5mblsgbmFtZSBdOwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHNwZWVkID09IG51bGwgfHwgdHlwZW9mIHNwZWVkID09PSAiYm9vbGVhbiIgPwoJCQljc3NGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICkgOgoJCQl0aGlzLmFuaW1hdGUoIGdlbkZ4KCBuYW1lLCB0cnVlICksIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7Cgl9Owp9ICk7CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKCB7CglzbGlkZURvd246IGdlbkZ4KCAic2hvdyIgKSwKCXNsaWRlVXA6IGdlbkZ4KCAiaGlkZSIgKSwKCXNsaWRlVG9nZ2xlOiBnZW5GeCggInRvZ2dsZSIgKSwKCWZhZGVJbjogeyBvcGFjaXR5OiAic2hvdyIgfSwKCWZhZGVPdXQ6IHsgb3BhY2l0eTogImhpZGUiIH0sCglmYWRlVG9nZ2xlOiB7IG9wYWNpdHk6ICJ0b2dnbGUiIH0KfSwgZnVuY3Rpb24oIG5hbWUsIHByb3BzICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggcHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7Cgl9Owp9ICk7CgpqUXVlcnkudGltZXJzID0gW107CmpRdWVyeS5meC50aWNrID0gZnVuY3Rpb24oKSB7Cgl2YXIgdGltZXIsCgkJaSA9IDAsCgkJdGltZXJzID0galF1ZXJ5LnRpbWVyczsKCglmeE5vdyA9IERhdGUubm93KCk7CgoJZm9yICggOyBpIDwgdGltZXJzLmxlbmd0aDsgaSsrICkgewoJCXRpbWVyID0gdGltZXJzWyBpIF07CgoJCS8vIFJ1biB0aGUgdGltZXIgYW5kIHNhZmVseSByZW1vdmUgaXQgd2hlbiBkb25lIChhbGxvd2luZyBmb3IgZXh0ZXJuYWwgcmVtb3ZhbCkKCQlpZiAoICF0aW1lcigpICYmIHRpbWVyc1sgaSBdID09PSB0aW1lciApIHsKCQkJdGltZXJzLnNwbGljZSggaS0tLCAxICk7CgkJfQoJfQoKCWlmICggIXRpbWVycy5sZW5ndGggKSB7CgkJalF1ZXJ5LmZ4LnN0b3AoKTsKCX0KCWZ4Tm93ID0gdW5kZWZpbmVkOwp9OwoKalF1ZXJ5LmZ4LnRpbWVyID0gZnVuY3Rpb24oIHRpbWVyICkgewoJalF1ZXJ5LnRpbWVycy5wdXNoKCB0aW1lciApOwoJalF1ZXJ5LmZ4LnN0YXJ0KCk7Cn07CgpqUXVlcnkuZnguaW50ZXJ2YWwgPSAxMzsKalF1ZXJ5LmZ4LnN0YXJ0ID0gZnVuY3Rpb24oKSB7CglpZiAoIGluUHJvZ3Jlc3MgKSB7CgkJcmV0dXJuOwoJfQoKCWluUHJvZ3Jlc3MgPSB0cnVlOwoJc2NoZWR1bGUoKTsKfTsKCmpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24oKSB7CglpblByb2dyZXNzID0gbnVsbDsKfTsKCmpRdWVyeS5meC5zcGVlZHMgPSB7CglzbG93OiA2MDAsCglmYXN0OiAyMDAsCgoJLy8gRGVmYXVsdCBzcGVlZAoJX2RlZmF1bHQ6IDQwMAp9OwoKCi8vIEJhc2VkIG9mZiBvZiB0aGUgcGx1Z2luIGJ5IENsaW50IEhlbGZlcnMsIHdpdGggcGVybWlzc2lvbi4KLy8gaHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTAwMzI0MDE0NzQ3L2h0dHA6Ly9ibGluZHNpZ25hbHMuY29tL2luZGV4LnBocC8yMDA5LzA3L2pxdWVyeS1kZWxheS8KalF1ZXJ5LmZuLmRlbGF5ID0gZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7Cgl0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1sgdGltZSBdIHx8IHRpbWUgOiB0aW1lOwoJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCglyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgewoJCXZhciB0aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKCQlob29rcy5zdG9wID0gZnVuY3Rpb24oKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRpbWVvdXQgKTsKCQl9OwoJfSApOwp9OwoKCiggZnVuY3Rpb24oKSB7Cgl2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiaW5wdXQiICksCgkJc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNlbGVjdCIgKSwKCQlvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJvcHRpb24iICkgKTsKCglpbnB1dC50eXBlID0gImNoZWNrYm94IjsKCgkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4zIG9ubHkKCS8vIERlZmF1bHQgdmFsdWUgZm9yIGEgY2hlY2tib3ggc2hvdWxkIGJlICJvbiIKCXN1cHBvcnQuY2hlY2tPbiA9IGlucHV0LnZhbHVlICE9PSAiIjsKCgkvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKCS8vIE11c3QgYWNjZXNzIHNlbGVjdGVkSW5kZXggdG8gbWFrZSBkZWZhdWx0IG9wdGlvbnMgc2VsZWN0CglzdXBwb3J0Lm9wdFNlbGVjdGVkID0gb3B0LnNlbGVjdGVkOwoKCS8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQoJLy8gQW4gaW5wdXQgbG9zZXMgaXRzIHZhbHVlIGFmdGVyIGJlY29taW5nIGEgcmFkaW8KCWlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImlucHV0IiApOwoJaW5wdXQudmFsdWUgPSAidCI7CglpbnB1dC50eXBlID0gInJhZGlvIjsKCXN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAidCI7Cn0gKSgpOwoKCnZhciBib29sSG9vaywKCWF0dHJIYW5kbGUgPSBqUXVlcnkuZXhwci5hdHRySGFuZGxlOwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJYXR0cjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGpRdWVyeS5hdHRyLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCgoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIG5hbWUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5yZW1vdmVBdHRyKCB0aGlzLCBuYW1lICk7CgkJfSApOwoJfQp9ICk7CgpqUXVlcnkuZXh0ZW5kKCB7CglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIHJldCwgaG9va3MsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gRG9uJ3QgZ2V0L3NldCBhdHRyaWJ1dGVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCgkJaWYgKCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4galF1ZXJ5LnByb3AoIGVsZW0sIG5hbWUsIHZhbHVlICk7CgkJfQoKCQkvLyBBdHRyaWJ1dGUgaG9va3MgYXJlIGRldGVybWluZWQgYnkgdGhlIGxvd2VyY2FzZSB2ZXJzaW9uCgkJLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZAoJCWlmICggblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgewoJCQlob29rcyA9IGpRdWVyeS5hdHRySG9va3NbIG5hbWUudG9Mb3dlckNhc2UoKSBdIHx8CgkJCQkoIGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdCggbmFtZSApID8gYm9vbEhvb2sgOiB1bmRlZmluZWQgKTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCB2YWx1ZSA9PT0gbnVsbCApIHsKCQkJCWpRdWVyeS5yZW1vdmVBdHRyKCBlbGVtLCBuYW1lICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYKCQkJCSggcmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApICkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgkJCX0KCgkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCB2YWx1ZSArICIiICk7CgkJCXJldHVybiB2YWx1ZTsKCQl9CgoJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKCByZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSApICE9PSBudWxsICkgewoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJcmV0ID0galF1ZXJ5LmZpbmQuYXR0ciggZWxlbSwgbmFtZSApOwoKCQkvLyBOb24tZXhpc3RlbnQgYXR0cmlidXRlcyByZXR1cm4gbnVsbCwgd2Ugbm9ybWFsaXplIHRvIHVuZGVmaW5lZAoJCXJldHVybiByZXQgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKCX0sCgoJYXR0ckhvb2tzOiB7CgkJdHlwZTogewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICggIXN1cHBvcnQucmFkaW9WYWx1ZSAmJiB2YWx1ZSA9PT0gInJhZGlvIiAmJgoJCQkJCW5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgKSB7CgkJCQkJdmFyIHZhbCA9IGVsZW0udmFsdWU7CgkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgdmFsdWUgKTsKCQkJCQlpZiAoIHZhbCApIHsKCQkJCQkJZWxlbS52YWx1ZSA9IHZhbDsKCQkJCQl9CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfSwKCglyZW1vdmVBdHRyOiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJdmFyIG5hbWUsCgkJCWkgPSAwLAoKCQkJLy8gQXR0cmlidXRlIG5hbWVzIGNhbiBjb250YWluIG5vbi1IVE1MIHdoaXRlc3BhY2UgY2hhcmFjdGVycwoJCQkvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9zeW50YXguaHRtbCNhdHRyaWJ1dGVzLTIKCQkJYXR0ck5hbWVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2goIHJub3RodG1sd2hpdGUgKTsKCgkJaWYgKCBhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJd2hpbGUgKCAoIG5hbWUgPSBhdHRyTmFtZXNbIGkrKyBdICkgKSB7CgkJCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSggbmFtZSApOwoJCQl9CgkJfQoJfQp9ICk7CgovLyBIb29rcyBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCmJvb2xIb29rID0gewoJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CgkJaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CgoJCQkvLyBSZW1vdmUgYm9vbGVhbiBhdHRyaWJ1dGVzIHdoZW4gc2V0IHRvIGZhbHNlCgkJCWpRdWVyeS5yZW1vdmVBdHRyKCBlbGVtLCBuYW1lICk7CgkJfSBlbHNlIHsKCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsIG5hbWUgKTsKCQl9CgkJcmV0dXJuIG5hbWU7Cgl9Cn07CgpqUXVlcnkuZWFjaCggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC5zb3VyY2UubWF0Y2goIC9cdysvZyApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCXZhciBnZXR0ZXIgPSBhdHRySGFuZGxlWyBuYW1lIF0gfHwgalF1ZXJ5LmZpbmQuYXR0cjsKCglhdHRySGFuZGxlWyBuYW1lIF0gPSBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJdmFyIHJldCwgaGFuZGxlLAoJCQlsb3dlcmNhc2VOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoKCQlpZiAoICFpc1hNTCApIHsKCgkJCS8vIEF2b2lkIGFuIGluZmluaXRlIGxvb3AgYnkgdGVtcG9yYXJpbHkgcmVtb3ZpbmcgdGhpcyBmdW5jdGlvbiBmcm9tIHRoZSBnZXR0ZXIKCQkJaGFuZGxlID0gYXR0ckhhbmRsZVsgbG93ZXJjYXNlTmFtZSBdOwoJCQlhdHRySGFuZGxlWyBsb3dlcmNhc2VOYW1lIF0gPSByZXQ7CgkJCXJldCA9IGdldHRlciggZWxlbSwgbmFtZSwgaXNYTUwgKSAhPSBudWxsID8KCQkJCWxvd2VyY2FzZU5hbWUgOgoJCQkJbnVsbDsKCQkJYXR0ckhhbmRsZVsgbG93ZXJjYXNlTmFtZSBdID0gaGFuZGxlOwoJCX0KCQlyZXR1cm4gcmV0OwoJfTsKfSApOwoKCgoKdmFyIHJmb2N1c2FibGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLAoJcmNsaWNrYWJsZSA9IC9eKD86YXxhcmVhKSQvaTsKCmpRdWVyeS5mbi5leHRlbmQoIHsKCXByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBqUXVlcnkucHJvcCwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoKCXJlbW92ZVByb3A6IGZ1bmN0aW9uKCBuYW1lICkgewoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlkZWxldGUgdGhpc1sgalF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lIF07CgkJfSApOwoJfQp9ICk7CgpqUXVlcnkuZXh0ZW5kKCB7Cglwcm9wOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIHJldCwgaG9va3MsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gRG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgewoKCQkJLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwoJCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCQlob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJgoJCQkJKCByZXQgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICkgKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHJldDsKCQkJfQoKCQkJcmV0dXJuICggZWxlbVsgbmFtZSBdID0gdmFsdWUgKTsKCQl9CgoJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKCByZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSApICE9PSBudWxsICkgewoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJcmV0dXJuIGVsZW1bIG5hbWUgXTsKCX0sCgoJcHJvcEhvb2tzOiB7CgkJdGFiSW5kZXg6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCgkJCQkvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSBvbmx5CgkJCQkvLyBlbGVtLnRhYkluZGV4IGRvZXNuJ3QgYWx3YXlzIHJldHVybiB0aGUKCQkJCS8vIGNvcnJlY3QgdmFsdWUgd2hlbiBpdCBoYXNuJ3QgYmVlbiBleHBsaWNpdGx5IHNldAoJCQkJLy8gaHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTQxMTE2MjMzMzQ3L2h0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvCgkJCQkvLyBVc2UgcHJvcGVyIGF0dHJpYnV0ZSByZXRyaWV2YWwoIzEyMDcyKQoJCQkJdmFyIHRhYmluZGV4ID0galF1ZXJ5LmZpbmQuYXR0ciggZWxlbSwgInRhYmluZGV4IiApOwoKCQkJCWlmICggdGFiaW5kZXggKSB7CgkJCQkJcmV0dXJuIHBhcnNlSW50KCB0YWJpbmRleCwgMTAgKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJcmZvY3VzYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgfHwKCQkJCQlyY2xpY2thYmxlLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSAmJgoJCQkJCWVsZW0uaHJlZgoJCQkJKSB7CgkJCQkJcmV0dXJuIDA7CgkJCQl9CgoJCQkJcmV0dXJuIC0xOwoJCQl9CgkJfQoJfSwKCglwcm9wRml4OiB7CgkJImZvciI6ICJodG1sRm9yIiwKCQkiY2xhc3MiOiAiY2xhc3NOYW1lIgoJfQp9ICk7CgovLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKLy8gQWNjZXNzaW5nIHRoZSBzZWxlY3RlZEluZGV4IHByb3BlcnR5Ci8vIGZvcmNlcyB0aGUgYnJvd3NlciB0byByZXNwZWN0IHNldHRpbmcgc2VsZWN0ZWQKLy8gb24gdGhlIG9wdGlvbgovLyBUaGUgZ2V0dGVyIGVuc3VyZXMgYSBkZWZhdWx0IG9wdGlvbiBpcyBzZWxlY3RlZAovLyB3aGVuIGluIGFuIG9wdGdyb3VwCi8vIGVzbGludCBydWxlICJuby11bnVzZWQtZXhwcmVzc2lvbnMiIGlzIGRpc2FibGVkIGZvciB0aGlzIGNvZGUKLy8gc2luY2UgaXQgY29uc2lkZXJzIHN1Y2ggYWNjZXNzaW9ucyBub29wCmlmICggIXN1cHBvcnQub3B0U2VsZWN0ZWQgKSB7CglqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgoJCQkvKiBlc2xpbnQgbm8tdW51c2VkLWV4cHJlc3Npb25zOiAib2ZmIiAqLwoKCQkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQkJaWYgKCBwYXJlbnQgJiYgcGFyZW50LnBhcmVudE5vZGUgKSB7CgkJCQlwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXJldHVybiBudWxsOwoJCX0sCgkJc2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCgkJCS8qIGVzbGludCBuby11bnVzZWQtZXhwcmVzc2lvbnM6ICJvZmYiICovCgoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCQlpZiAoIHBhcmVudCApIHsKCQkJCXBhcmVudC5zZWxlY3RlZEluZGV4OwoKCQkJCWlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7CgkJCQkJcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJCX0KCQkJfQoJCX0KCX07Cn0KCmpRdWVyeS5lYWNoKCBbCgkidGFiSW5kZXgiLAoJInJlYWRPbmx5IiwKCSJtYXhMZW5ndGgiLAoJImNlbGxTcGFjaW5nIiwKCSJjZWxsUGFkZGluZyIsCgkicm93U3BhbiIsCgkiY29sU3BhbiIsCgkidXNlTWFwIiwKCSJmcmFtZUJvcmRlciIsCgkiY29udGVudEVkaXRhYmxlIgpdLCBmdW5jdGlvbigpIHsKCWpRdWVyeS5wcm9wRml4WyB0aGlzLnRvTG93ZXJDYXNlKCkgXSA9IHRoaXM7Cn0gKTsKCgoKCgkvLyBTdHJpcCBhbmQgY29sbGFwc2Ugd2hpdGVzcGFjZSBhY2NvcmRpbmcgdG8gSFRNTCBzcGVjCgkvLyBodHRwczovL2luZnJhLnNwZWMud2hhdHdnLm9yZy8jc3RyaXAtYW5kLWNvbGxhcHNlLWFzY2lpLXdoaXRlc3BhY2UKCWZ1bmN0aW9uIHN0cmlwQW5kQ29sbGFwc2UoIHZhbHVlICkgewoJCXZhciB0b2tlbnMgPSB2YWx1ZS5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFtdOwoJCXJldHVybiB0b2tlbnMuam9pbiggIiAiICk7Cgl9CgoKZnVuY3Rpb24gZ2V0Q2xhc3MoIGVsZW0gKSB7CglyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoICJjbGFzcyIgKSB8fCAiIjsKfQoKZnVuY3Rpb24gY2xhc3Nlc1RvQXJyYXkoIHZhbHVlICkgewoJaWYgKCBBcnJheS5pc0FycmF5KCB2YWx1ZSApICkgewoJCXJldHVybiB2YWx1ZTsKCX0KCWlmICggdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiApIHsKCQlyZXR1cm4gdmFsdWUubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbXTsKCX0KCXJldHVybiBbXTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCggewoJYWRkQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY2xhc3NlcywgZWxlbSwgY3VyLCBjdXJWYWx1ZSwgY2xhenosIGosIGZpbmFsVmFsdWUsCgkJCWkgPSAwOwoKCQlpZiAoIGlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCBqICkgewoJCQkJalF1ZXJ5KCB0aGlzICkuYWRkQ2xhc3MoIHZhbHVlLmNhbGwoIHRoaXMsIGosIGdldENsYXNzKCB0aGlzICkgKSApOwoJCQl9ICk7CgkJfQoKCQljbGFzc2VzID0gY2xhc3Nlc1RvQXJyYXkoIHZhbHVlICk7CgoJCWlmICggY2xhc3Nlcy5sZW5ndGggKSB7CgkJCXdoaWxlICggKCBlbGVtID0gdGhpc1sgaSsrIF0gKSApIHsKCQkJCWN1clZhbHVlID0gZ2V0Q2xhc3MoIGVsZW0gKTsKCQkJCWN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCAiICIgKyBzdHJpcEFuZENvbGxhcHNlKCBjdXJWYWx1ZSApICsgIiAiICk7CgoJCQkJaWYgKCBjdXIgKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAoIGNsYXp6ID0gY2xhc3Nlc1sgaisrIF0gKSApIHsKCQkJCQkJaWYgKCBjdXIuaW5kZXhPZiggIiAiICsgY2xhenogKyAiICIgKSA8IDAgKSB7CgkJCQkJCQljdXIgKz0gY2xhenogKyAiICI7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIE9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCgkJCQkJZmluYWxWYWx1ZSA9IHN0cmlwQW5kQ29sbGFwc2UoIGN1ciApOwoJCQkJCWlmICggY3VyVmFsdWUgIT09IGZpbmFsVmFsdWUgKSB7CgkJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCAiY2xhc3MiLCBmaW5hbFZhbHVlICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY2xhc3NlcywgZWxlbSwgY3VyLCBjdXJWYWx1ZSwgY2xhenosIGosIGZpbmFsVmFsdWUsCgkJCWkgPSAwOwoKCQlpZiAoIGlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCBqICkgewoJCQkJalF1ZXJ5KCB0aGlzICkucmVtb3ZlQ2xhc3MoIHZhbHVlLmNhbGwoIHRoaXMsIGosIGdldENsYXNzKCB0aGlzICkgKSApOwoJCQl9ICk7CgkJfQoKCQlpZiAoICFhcmd1bWVudHMubGVuZ3RoICkgewoJCQlyZXR1cm4gdGhpcy5hdHRyKCAiY2xhc3MiLCAiIiApOwoJCX0KCgkJY2xhc3NlcyA9IGNsYXNzZXNUb0FycmF5KCB2YWx1ZSApOwoKCQlpZiAoIGNsYXNzZXMubGVuZ3RoICkgewoJCQl3aGlsZSAoICggZWxlbSA9IHRoaXNbIGkrKyBdICkgKSB7CgkJCQljdXJWYWx1ZSA9IGdldENsYXNzKCBlbGVtICk7CgoJCQkJLy8gVGhpcyBleHByZXNzaW9uIGlzIGhlcmUgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSBhZGRDbGFzcykKCQkJCWN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCAiICIgKyBzdHJpcEFuZENvbGxhcHNlKCBjdXJWYWx1ZSApICsgIiAiICk7CgoJCQkJaWYgKCBjdXIgKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAoIGNsYXp6ID0gY2xhc3Nlc1sgaisrIF0gKSApIHsKCgkJCQkJCS8vIFJlbW92ZSAqYWxsKiBpbnN0YW5jZXMKCQkJCQkJd2hpbGUgKCBjdXIuaW5kZXhPZiggIiAiICsgY2xhenogKyAiICIgKSA+IC0xICkgewoJCQkJCQkJY3VyID0gY3VyLnJlcGxhY2UoICIgIiArIGNsYXp6ICsgIiAiLCAiICIgKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gT25seSBhc3NpZ24gaWYgZGlmZmVyZW50IHRvIGF2b2lkIHVubmVlZGVkIHJlbmRlcmluZy4KCQkJCQlmaW5hbFZhbHVlID0gc3RyaXBBbmRDb2xsYXBzZSggY3VyICk7CgkJCQkJaWYgKCBjdXJWYWx1ZSAhPT0gZmluYWxWYWx1ZSApIHsKCQkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoICJjbGFzcyIsIGZpbmFsVmFsdWUgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgl0b2dnbGVDbGFzczogZnVuY3Rpb24oIHZhbHVlLCBzdGF0ZVZhbCApIHsKCQl2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZSwKCQkJaXNWYWxpZFZhbHVlID0gdHlwZSA9PT0gInN0cmluZyIgfHwgQXJyYXkuaXNBcnJheSggdmFsdWUgKTsKCgkJaWYgKCB0eXBlb2Ygc3RhdGVWYWwgPT09ICJib29sZWFuIiAmJiBpc1ZhbGlkVmFsdWUgKSB7CgkJCXJldHVybiBzdGF0ZVZhbCA/IHRoaXMuYWRkQ2xhc3MoIHZhbHVlICkgOiB0aGlzLnJlbW92ZUNsYXNzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBpc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnRvZ2dsZUNsYXNzKAoJCQkJCXZhbHVlLmNhbGwoIHRoaXMsIGksIGdldENsYXNzKCB0aGlzICksIHN0YXRlVmFsICksCgkJCQkJc3RhdGVWYWwKCQkJCSk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY2xhc3NOYW1lLCBpLCBzZWxmLCBjbGFzc05hbWVzOwoKCQkJaWYgKCBpc1ZhbGlkVmFsdWUgKSB7CgoJCQkJLy8gVG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKCQkJCWkgPSAwOwoJCQkJc2VsZiA9IGpRdWVyeSggdGhpcyApOwoJCQkJY2xhc3NOYW1lcyA9IGNsYXNzZXNUb0FycmF5KCB2YWx1ZSApOwoKCQkJCXdoaWxlICggKCBjbGFzc05hbWUgPSBjbGFzc05hbWVzWyBpKysgXSApICkgewoKCQkJCQkvLyBDaGVjayBlYWNoIGNsYXNzTmFtZSBnaXZlbiwgc3BhY2Ugc2VwYXJhdGVkIGxpc3QKCQkJCQlpZiAoIHNlbGYuaGFzQ2xhc3MoIGNsYXNzTmFtZSApICkgewoJCQkJCQlzZWxmLnJlbW92ZUNsYXNzKCBjbGFzc05hbWUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZWxmLmFkZENsYXNzKCBjbGFzc05hbWUgKTsKCQkJCQl9CgkJCQl9CgoJCQkvLyBUb2dnbGUgd2hvbGUgY2xhc3MgbmFtZQoJCQl9IGVsc2UgaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHR5cGUgPT09ICJib29sZWFuIiApIHsKCQkJCWNsYXNzTmFtZSA9IGdldENsYXNzKCB0aGlzICk7CgkJCQlpZiAoIGNsYXNzTmFtZSApIHsKCgkJCQkJLy8gU3RvcmUgY2xhc3NOYW1lIGlmIHNldAoJCQkJCWRhdGFQcml2LnNldCggdGhpcywgIl9fY2xhc3NOYW1lX18iLCBjbGFzc05hbWUgKTsKCQkJCX0KCgkJCQkvLyBJZiB0aGUgZWxlbWVudCBoYXMgYSBjbGFzcyBuYW1lIG9yIGlmIHdlJ3JlIHBhc3NlZCBgZmFsc2VgLAoJCQkJLy8gdGhlbiByZW1vdmUgdGhlIHdob2xlIGNsYXNzbmFtZSAoaWYgdGhlcmUgd2FzIG9uZSwgdGhlIGFib3ZlIHNhdmVkIGl0KS4KCQkJCS8vIE90aGVyd2lzZSBicmluZyBiYWNrIHdoYXRldmVyIHdhcyBwcmV2aW91c2x5IHNhdmVkIChpZiBhbnl0aGluZyksCgkJCQkvLyBmYWxsaW5nIGJhY2sgdG8gdGhlIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBzdG9yZWQuCgkJCQlpZiAoIHRoaXMuc2V0QXR0cmlidXRlICkgewoJCQkJCXRoaXMuc2V0QXR0cmlidXRlKCAiY2xhc3MiLAoJCQkJCQljbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8KCQkJCQkJIiIgOgoJCQkJCQlkYXRhUHJpdi5nZXQoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiApIHx8ICIiCgkJCQkJKTsKCQkJCX0KCQkJfQoJCX0gKTsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgY2xhc3NOYW1lLCBlbGVtLAoJCQlpID0gMDsKCgkJY2xhc3NOYW1lID0gIiAiICsgc2VsZWN0b3IgKyAiICI7CgkJd2hpbGUgKCAoIGVsZW0gPSB0aGlzWyBpKysgXSApICkgewoJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYKCQkJCSggIiAiICsgc3RyaXBBbmRDb2xsYXBzZSggZ2V0Q2xhc3MoIGVsZW0gKSApICsgIiAiICkuaW5kZXhPZiggY2xhc3NOYW1lICkgPiAtMSApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJfQp9ICk7CgoKCgp2YXIgcnJldHVybiA9IC9cci9nOwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJdmFsOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGhvb2tzLCByZXQsIHZhbHVlSXNGdW5jdGlvbiwKCQkJZWxlbSA9IHRoaXNbIDAgXTsKCgkJaWYgKCAhYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJaWYgKCBlbGVtICkgewoJCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIGVsZW0udHlwZSBdIHx8CgkJCQkJalF1ZXJ5LnZhbEhvb2tzWyBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCgkJCQlpZiAoIGhvb2tzICYmCgkJCQkJImdldCIgaW4gaG9va3MgJiYKCQkJCQkoIHJldCA9IGhvb2tzLmdldCggZWxlbSwgInZhbHVlIiApICkgIT09IHVuZGVmaW5lZAoJCQkJKSB7CgkJCQkJcmV0dXJuIHJldDsKCQkJCX0KCgkJCQlyZXQgPSBlbGVtLnZhbHVlOwoKCQkJCS8vIEhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMKCQkJCWlmICggdHlwZW9mIHJldCA9PT0gInN0cmluZyIgKSB7CgkJCQkJcmV0dXJuIHJldC5yZXBsYWNlKCBycmV0dXJuLCAiIiApOwoJCQkJfQoKCQkJCS8vIEhhbmRsZSBjYXNlcyB3aGVyZSB2YWx1ZSBpcyBudWxsL3VuZGVmIG9yIG51bWJlcgoJCQkJcmV0dXJuIHJldCA9PSBudWxsID8gIiIgOiByZXQ7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCXZhbHVlSXNGdW5jdGlvbiA9IGlzRnVuY3Rpb24oIHZhbHVlICk7CgoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgdmFsOwoKCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9PSAxICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHZhbHVlSXNGdW5jdGlvbiApIHsKCQkJCXZhbCA9IHZhbHVlLmNhbGwoIHRoaXMsIGksIGpRdWVyeSggdGhpcyApLnZhbCgpICk7CgkJCX0gZWxzZSB7CgkJCQl2YWwgPSB2YWx1ZTsKCQkJfQoKCQkJLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9ICIiOwoKCQkJfSBlbHNlIGlmICggdHlwZW9mIHZhbCA9PT0gIm51bWJlciIgKSB7CgkJCQl2YWwgKz0gIiI7CgoJCQl9IGVsc2UgaWYgKCBBcnJheS5pc0FycmF5KCB2YWwgKSApIHsKCQkJCXZhbCA9IGpRdWVyeS5tYXAoIHZhbCwgZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCXJldHVybiB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSArICIiOwoJCQkJfSApOwoJCQl9CgoJCQlob29rcyA9IGpRdWVyeS52YWxIb29rc1sgdGhpcy50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCgkJCS8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nCgkJCWlmICggIWhvb2tzIHx8ICEoICJzZXQiIGluIGhvb2tzICkgfHwgaG9va3Muc2V0KCB0aGlzLCB2YWwsICJ2YWx1ZSIgKSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy52YWx1ZSA9IHZhbDsKCQkJfQoJCX0gKTsKCX0KfSApOwoKalF1ZXJ5LmV4dGVuZCggewoJdmFsSG9va3M6IHsKCQlvcHRpb246IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCgkJCQl2YXIgdmFsID0galF1ZXJ5LmZpbmQuYXR0ciggZWxlbSwgInZhbHVlIiApOwoJCQkJcmV0dXJuIHZhbCAhPSBudWxsID8KCQkJCQl2YWwgOgoKCQkJCQkvLyBTdXBwb3J0OiBJRSA8PTEwIC0gMTEgb25seQoJCQkJCS8vIG9wdGlvbi50ZXh0IHRocm93cyBleGNlcHRpb25zICgjMTQ2ODYsICMxNDg1OCkKCQkJCQkvLyBTdHJpcCBhbmQgY29sbGFwc2Ugd2hpdGVzcGFjZQoJCQkJCS8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvI3N0cmlwLWFuZC1jb2xsYXBzZS13aGl0ZXNwYWNlCgkJCQkJc3RyaXBBbmRDb2xsYXBzZSggalF1ZXJ5LnRleHQoIGVsZW0gKSApOwoJCQl9CgkJfSwKCQlzZWxlY3Q6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciB2YWx1ZSwgb3B0aW9uLCBpLAoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsCgkJCQkJb25lID0gZWxlbS50eXBlID09PSAic2VsZWN0LW9uZSIsCgkJCQkJdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLAoJCQkJCW1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoOwoKCQkJCWlmICggaW5kZXggPCAwICkgewoJCQkJCWkgPSBtYXg7CgoJCQkJfSBlbHNlIHsKCQkJCQlpID0gb25lID8gaW5kZXggOiAwOwoJCQkJfQoKCQkJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKCQkJCWZvciAoIDsgaSA8IG1heDsgaSsrICkgewoJCQkJCW9wdGlvbiA9IG9wdGlvbnNbIGkgXTsKCgkJCQkJLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKCQkJCQkvLyBJRTgtOSBkb2Vzbid0IHVwZGF0ZSBzZWxlY3RlZCBhZnRlciBmb3JtIHJlc2V0ICgjMjU1MSkKCQkJCQlpZiAoICggb3B0aW9uLnNlbGVjdGVkIHx8IGkgPT09IGluZGV4ICkgJiYKCgkJCQkJCQkvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCgkJCQkJCQkhb3B0aW9uLmRpc2FibGVkICYmCgkJCQkJCQkoICFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fAoJCQkJCQkJCSFub2RlTmFtZSggb3B0aW9uLnBhcmVudE5vZGUsICJvcHRncm91cCIgKSApICkgewoKCQkJCQkJLy8gR2V0IHRoZSBzcGVjaWZpYyB2YWx1ZSBmb3IgdGhlIG9wdGlvbgoJCQkJCQl2YWx1ZSA9IGpRdWVyeSggb3B0aW9uICkudmFsKCk7CgoJCQkJCQkvLyBXZSBkb24ndCBuZWVkIGFuIGFycmF5IGZvciBvbmUgc2VsZWN0cwoJCQkJCQlpZiAoIG9uZSApIHsKCQkJCQkJCXJldHVybiB2YWx1ZTsKCQkJCQkJfQoKCQkJCQkJLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKCQkJCQkJdmFsdWVzLnB1c2goIHZhbHVlICk7CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiB2YWx1ZXM7CgkJCX0sCgoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCXZhciBvcHRpb25TZXQsIG9wdGlvbiwKCQkJCQlvcHRpb25zID0gZWxlbS5vcHRpb25zLAoJCQkJCXZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkoIHZhbHVlICksCgkJCQkJaSA9IG9wdGlvbnMubGVuZ3RoOwoKCQkJCXdoaWxlICggaS0tICkgewoJCQkJCW9wdGlvbiA9IG9wdGlvbnNbIGkgXTsKCgkJCQkJLyogZXNsaW50LWRpc2FibGUgbm8tY29uZC1hc3NpZ24gKi8KCgkJCQkJaWYgKCBvcHRpb24uc2VsZWN0ZWQgPQoJCQkJCQlqUXVlcnkuaW5BcnJheSggalF1ZXJ5LnZhbEhvb2tzLm9wdGlvbi5nZXQoIG9wdGlvbiApLCB2YWx1ZXMgKSA+IC0xCgkJCQkJKSB7CgkJCQkJCW9wdGlvblNldCA9IHRydWU7CgkJCQkJfQoKCQkJCQkvKiBlc2xpbnQtZW5hYmxlIG5vLWNvbmQtYXNzaWduICovCgkJCQl9CgoJCQkJLy8gRm9yY2UgYnJvd3NlcnMgdG8gYmVoYXZlIGNvbnNpc3RlbnRseSB3aGVuIG5vbi1tYXRjaGluZyB2YWx1ZSBpcyBzZXQKCQkJCWlmICggIW9wdGlvblNldCApIHsKCQkJCQllbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsKCQkJCX0KCQkJCXJldHVybiB2YWx1ZXM7CgkJCX0KCQl9Cgl9Cn0gKTsKCi8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyCmpRdWVyeS5lYWNoKCBbICJyYWRpbyIsICJjaGVja2JveCIgXSwgZnVuY3Rpb24oKSB7CglqUXVlcnkudmFsSG9va3NbIHRoaXMgXSA9IHsKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJaWYgKCBBcnJheS5pc0FycmF5KCB2YWx1ZSApICkgewoJCQkJcmV0dXJuICggZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIGpRdWVyeSggZWxlbSApLnZhbCgpLCB2YWx1ZSApID4gLTEgKTsKCQkJfQoJCX0KCX07CglpZiAoICFzdXBwb3J0LmNoZWNrT24gKSB7CgkJalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0uZ2V0ID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggInZhbHVlIiApID09PSBudWxsID8gIm9uIiA6IGVsZW0udmFsdWU7CgkJfTsKCX0KfSApOwoKCgoKLy8gUmV0dXJuIGpRdWVyeSBmb3IgYXR0cmlidXRlcy1vbmx5IGluY2x1c2lvbgoKCnN1cHBvcnQuZm9jdXNpbiA9ICJvbmZvY3VzaW4iIGluIHdpbmRvdzsKCgp2YXIgcmZvY3VzTW9ycGggPSAvXig/OmZvY3VzaW5mb2N1c3xmb2N1c291dGJsdXIpJC8sCglzdG9wUHJvcGFnYXRpb25DYWxsYmFjayA9IGZ1bmN0aW9uKCBlICkgewoJCWUuc3RvcFByb3BhZ2F0aW9uKCk7Cgl9OwoKalF1ZXJ5LmV4dGVuZCggalF1ZXJ5LmV2ZW50LCB7CgoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtLCBvbmx5SGFuZGxlcnMgKSB7CgoJCXZhciBpLCBjdXIsIHRtcCwgYnViYmxlVHlwZSwgb250eXBlLCBoYW5kbGUsIHNwZWNpYWwsIGxhc3RFbGVtZW50LAoJCQlldmVudFBhdGggPSBbIGVsZW0gfHwgZG9jdW1lbnQgXSwKCQkJdHlwZSA9IGhhc093bi5jYWxsKCBldmVudCwgInR5cGUiICkgPyBldmVudC50eXBlIDogZXZlbnQsCgkJCW5hbWVzcGFjZXMgPSBoYXNPd24uY2FsbCggZXZlbnQsICJuYW1lc3BhY2UiICkgPyBldmVudC5uYW1lc3BhY2Uuc3BsaXQoICIuIiApIDogW107CgoJCWN1ciA9IGxhc3RFbGVtZW50ID0gdG1wID0gZWxlbSA9IGVsZW0gfHwgZG9jdW1lbnQ7CgoJCS8vIERvbid0IGRvIGV2ZW50cyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIGZvY3VzL2JsdXIgbW9ycGhzIHRvIGZvY3VzaW4vb3V0OyBlbnN1cmUgd2UncmUgbm90IGZpcmluZyB0aGVtIHJpZ2h0IG5vdwoJCWlmICggcmZvY3VzTW9ycGgudGVzdCggdHlwZSArIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0eXBlLmluZGV4T2YoICIuIiApID4gLTEgKSB7CgoJCQkvLyBOYW1lc3BhY2VkIHRyaWdnZXI7IGNyZWF0ZSBhIHJlZ2V4cCB0byBtYXRjaCBldmVudCB0eXBlIGluIGhhbmRsZSgpCgkJCW5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCAiLiIgKTsKCQkJdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKCQkJbmFtZXNwYWNlcy5zb3J0KCk7CgkJfQoJCW9udHlwZSA9IHR5cGUuaW5kZXhPZiggIjoiICkgPCAwICYmICJvbiIgKyB0eXBlOwoKCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYSBqUXVlcnkuRXZlbnQgb2JqZWN0LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcKCQlldmVudCA9IGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdID8KCQkJZXZlbnQgOgoJCQluZXcgalF1ZXJ5LkV2ZW50KCB0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiICYmIGV2ZW50ICk7CgoJCS8vIFRyaWdnZXIgYml0bWFzazogJiAxIGZvciBuYXRpdmUgaGFuZGxlcnM7ICYgMiBmb3IgalF1ZXJ5IChhbHdheXMgdHJ1ZSkKCQlldmVudC5pc1RyaWdnZXIgPSBvbmx5SGFuZGxlcnMgPyAyIDogMzsKCQlldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oICIuIiApOwoJCWV2ZW50LnJuYW1lc3BhY2UgPSBldmVudC5uYW1lc3BhY2UgPwoJCQluZXcgUmVnRXhwKCAiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oICJcXC4oPzouKlxcLnwpIiApICsgIihcXC58JCkiICkgOgoJCQludWxsOwoKCQkvLyBDbGVhbiB1cCB0aGUgZXZlbnQgaW4gY2FzZSBpdCBpcyBiZWluZyByZXVzZWQKCQlldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CgkJaWYgKCAhZXZlbnQudGFyZ2V0ICkgewoJCQlldmVudC50YXJnZXQgPSBlbGVtOwoJCX0KCgkJLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAoJCWRhdGEgPSBkYXRhID09IG51bGwgPwoJCQlbIGV2ZW50IF0gOgoJCQlqUXVlcnkubWFrZUFycmF5KCBkYXRhLCBbIGV2ZW50IF0gKTsKCgkJLy8gQWxsb3cgc3BlY2lhbCBldmVudHMgdG8gZHJhdyBvdXRzaWRlIHRoZSBsaW5lcwoJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoJCWlmICggIW9ubHlIYW5kbGVycyAmJiBzcGVjaWFsLnRyaWdnZXIgJiYgc3BlY2lhbC50cmlnZ2VyLmFwcGx5KCBlbGVtLCBkYXRhICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBEZXRlcm1pbmUgZXZlbnQgcHJvcGFnYXRpb24gcGF0aCBpbiBhZHZhbmNlLCBwZXIgVzNDIGV2ZW50cyBzcGVjICgjOTk1MSkKCQkvLyBCdWJibGUgdXAgdG8gZG9jdW1lbnQsIHRoZW4gdG8gd2luZG93OyB3YXRjaCBmb3IgYSBnbG9iYWwgb3duZXJEb2N1bWVudCB2YXIgKCM5NzI0KQoJCWlmICggIW9ubHlIYW5kbGVycyAmJiAhc3BlY2lhbC5ub0J1YmJsZSAmJiAhaXNXaW5kb3coIGVsZW0gKSApIHsKCgkJCWJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwoJCQlpZiAoICFyZm9jdXNNb3JwaC50ZXN0KCBidWJibGVUeXBlICsgdHlwZSApICkgewoJCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJCX0KCQkJZm9yICggOyBjdXI7IGN1ciA9IGN1ci5wYXJlbnROb2RlICkgewoJCQkJZXZlbnRQYXRoLnB1c2goIGN1ciApOwoJCQkJdG1wID0gY3VyOwoJCQl9CgoJCQkvLyBPbmx5IGFkZCB3aW5kb3cgaWYgd2UgZ290IHRvIGRvY3VtZW50IChlLmcuLCBub3QgcGxhaW4gb2JqIG9yIGRldGFjaGVkIERPTSkKCQkJaWYgKCB0bXAgPT09ICggZWxlbS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50ICkgKSB7CgkJCQlldmVudFBhdGgucHVzaCggdG1wLmRlZmF1bHRWaWV3IHx8IHRtcC5wYXJlbnRXaW5kb3cgfHwgd2luZG93ICk7CgkJCX0KCQl9CgoJCS8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgKCQlpID0gMDsKCQl3aGlsZSAoICggY3VyID0gZXZlbnRQYXRoWyBpKysgXSApICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQlsYXN0RWxlbWVudCA9IGN1cjsKCQkJZXZlbnQudHlwZSA9IGkgPiAxID8KCQkJCWJ1YmJsZVR5cGUgOgoJCQkJc3BlY2lhbC5iaW5kVHlwZSB8fCB0eXBlOwoKCQkJLy8galF1ZXJ5IGhhbmRsZXIKCQkJaGFuZGxlID0gKCBkYXRhUHJpdi5nZXQoIGN1ciwgImV2ZW50cyIgKSB8fCB7fSApWyBldmVudC50eXBlIF0gJiYKCQkJCWRhdGFQcml2LmdldCggY3VyLCAiaGFuZGxlIiApOwoJCQlpZiAoIGhhbmRsZSApIHsKCQkJCWhhbmRsZS5hcHBseSggY3VyLCBkYXRhICk7CgkJCX0KCgkJCS8vIE5hdGl2ZSBoYW5kbGVyCgkJCWhhbmRsZSA9IG9udHlwZSAmJiBjdXJbIG9udHlwZSBdOwoJCQlpZiAoIGhhbmRsZSAmJiBoYW5kbGUuYXBwbHkgJiYgYWNjZXB0RGF0YSggY3VyICkgKSB7CgkJCQlldmVudC5yZXN1bHQgPSBoYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOwoJCQkJaWYgKCBldmVudC5yZXN1bHQgPT09IGZhbHNlICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQl9CgkJZXZlbnQudHlwZSA9IHR5cGU7CgoJCS8vIElmIG5vYm9keSBwcmV2ZW50ZWQgdGhlIGRlZmF1bHQgYWN0aW9uLCBkbyBpdCBub3cKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKCQkJaWYgKCAoICFzcGVjaWFsLl9kZWZhdWx0IHx8CgkJCQlzcGVjaWFsLl9kZWZhdWx0LmFwcGx5KCBldmVudFBhdGgucG9wKCksIGRhdGEgKSA9PT0gZmFsc2UgKSAmJgoJCQkJYWNjZXB0RGF0YSggZWxlbSApICkgewoKCQkJCS8vIENhbGwgYSBuYXRpdmUgRE9NIG1ldGhvZCBvbiB0aGUgdGFyZ2V0IHdpdGggdGhlIHNhbWUgbmFtZSBhcyB0aGUgZXZlbnQuCgkJCQkvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAoIzYxNzApCgkJCQlpZiAoIG9udHlwZSAmJiBpc0Z1bmN0aW9uKCBlbGVtWyB0eXBlIF0gKSAmJiAhaXNXaW5kb3coIGVsZW0gKSApIHsKCgkJCQkJLy8gRG9uJ3QgcmUtdHJpZ2dlciBhbiBvbkZPTyBldmVudCB3aGVuIHdlIGNhbGwgaXRzIEZPTygpIG1ldGhvZAoJCQkJCXRtcCA9IGVsZW1bIG9udHlwZSBdOwoKCQkJCQlpZiAoIHRtcCApIHsKCQkJCQkJZWxlbVsgb250eXBlIF0gPSBudWxsOwoJCQkJCX0KCgkJCQkJLy8gUHJldmVudCByZS10cmlnZ2VyaW5nIG9mIHRoZSBzYW1lIGV2ZW50LCBzaW5jZSB3ZSBhbHJlYWR5IGJ1YmJsZWQgaXQgYWJvdmUKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdHlwZTsKCgkJCQkJaWYgKCBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJCQlsYXN0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBzdG9wUHJvcGFnYXRpb25DYWxsYmFjayApOwoJCQkJCX0KCgkJCQkJZWxlbVsgdHlwZSBdKCk7CgoJCQkJCWlmICggZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCQkJbGFzdEVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgc3RvcFByb3BhZ2F0aW9uQ2FsbGJhY2sgKTsKCQkJCQl9CgoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgoJCQkJCWlmICggdG1wICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IHRtcDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBldmVudC5yZXN1bHQ7Cgl9LAoKCS8vIFBpZ2d5YmFjayBvbiBhIGRvbm9yIGV2ZW50IHRvIHNpbXVsYXRlIGEgZGlmZmVyZW50IG9uZQoJLy8gVXNlZCBvbmx5IGZvciBgZm9jdXMoaW4gfCBvdXQpYCBldmVudHMKCXNpbXVsYXRlOiBmdW5jdGlvbiggdHlwZSwgZWxlbSwgZXZlbnQgKSB7CgkJdmFyIGUgPSBqUXVlcnkuZXh0ZW5kKAoJCQluZXcgalF1ZXJ5LkV2ZW50KCksCgkJCWV2ZW50LAoJCQl7CgkJCQl0eXBlOiB0eXBlLAoJCQkJaXNTaW11bGF0ZWQ6IHRydWUKCQkJfQoJCSk7CgoJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCBlLCBudWxsLCBlbGVtICk7Cgl9Cgp9ICk7CgpqUXVlcnkuZm4uZXh0ZW5kKCB7CgoJdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCB0eXBlLCBkYXRhLCB0aGlzICk7CgkJfSApOwoJfSwKCXRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQl2YXIgZWxlbSA9IHRoaXNbIDAgXTsKCQlpZiAoIGVsZW0gKSB7CgkJCXJldHVybiBqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgZWxlbSwgdHJ1ZSApOwoJCX0KCX0KfSApOwoKCi8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00NAovLyBGaXJlZm94IGRvZXNuJ3QgaGF2ZSBmb2N1cyhpbiB8IG91dCkgZXZlbnRzCi8vIFJlbGF0ZWQgdGlja2V0IC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njg3Nzg3Ci8vCi8vIFN1cHBvcnQ6IENocm9tZSA8PTQ4IC0gNDksIFNhZmFyaSA8PTkuMCAtIDkuMQovLyBmb2N1cyhpbiB8IG91dCkgZXZlbnRzIGZpcmUgYWZ0ZXIgZm9jdXMgJiBibHVyIGV2ZW50cywKLy8gd2hpY2ggaXMgc3BlYyB2aW9sYXRpb24gLSBodHRwOi8vd3d3LnczLm9yZy9UUi9ET00tTGV2ZWwtMy1FdmVudHMvI2V2ZW50cy1mb2N1c2V2ZW50LWV2ZW50LW9yZGVyCi8vIFJlbGF0ZWQgdGlja2V0IC0gaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NDQ5ODU3CmlmICggIXN1cHBvcnQuZm9jdXNpbiApIHsKCWpRdWVyeS5lYWNoKCB7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCgkJLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudCB3aGlsZSBzb21lb25lIHdhbnRzIGZvY3VzaW4vZm9jdXNvdXQKCQl2YXIgaGFuZGxlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCBmaXgsIGV2ZW50LnRhcmdldCwgalF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgKSApOwoJCX07CgoJCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLAoJCQkJCWF0dGFjaGVzID0gZGF0YVByaXYuYWNjZXNzKCBkb2MsIGZpeCApOwoKCQkJCWlmICggIWF0dGFjaGVzICkgewoJCQkJCWRvYy5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCQl9CgkJCQlkYXRhUHJpdi5hY2Nlc3MoIGRvYywgZml4LCAoIGF0dGFjaGVzIHx8IDAgKSArIDEgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLAoJCQkJCWF0dGFjaGVzID0gZGF0YVByaXYuYWNjZXNzKCBkb2MsIGZpeCApIC0gMTsKCgkJCQlpZiAoICFhdHRhY2hlcyApIHsKCQkJCQlkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOwoJCQkJCWRhdGFQcml2LnJlbW92ZSggZG9jLCBmaXggKTsKCgkJCQl9IGVsc2UgewoJCQkJCWRhdGFQcml2LmFjY2VzcyggZG9jLCBmaXgsIGF0dGFjaGVzICk7CgkJCQl9CgkJCX0KCQl9OwoJfSApOwp9CnZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKCnZhciBub25jZSA9IERhdGUubm93KCk7Cgp2YXIgcnF1ZXJ5ID0gKCAvXD8vICk7CgoKCi8vIENyb3NzLWJyb3dzZXIgeG1sIHBhcnNpbmcKalF1ZXJ5LnBhcnNlWE1MID0gZnVuY3Rpb24oIGRhdGEgKSB7Cgl2YXIgeG1sOwoJaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHkKCS8vIElFIHRocm93cyBvbiBwYXJzZUZyb21TdHJpbmcgd2l0aCBpbnZhbGlkIGlucHV0LgoJdHJ5IHsKCQl4bWwgPSAoIG5ldyB3aW5kb3cuRE9NUGFyc2VyKCkgKS5wYXJzZUZyb21TdHJpbmcoIGRhdGEsICJ0ZXh0L3htbCIgKTsKCX0gY2F0Y2ggKCBlICkgewoJCXhtbCA9IHVuZGVmaW5lZDsKCX0KCglpZiAoICF4bWwgfHwgeG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCAicGFyc2VyZXJyb3IiICkubGVuZ3RoICkgewoJCWpRdWVyeS5lcnJvciggIkludmFsaWQgWE1MOiAiICsgZGF0YSApOwoJfQoJcmV0dXJuIHhtbDsKfTsKCgp2YXIKCXJicmFja2V0ID0gL1xbXF0kLywKCXJDUkxGID0gL1xyP1xuL2csCglyc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksCglyc3VibWl0dGFibGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxrZXlnZW4pL2k7CgpmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQgKSB7Cgl2YXIgbmFtZTsKCglpZiAoIEFycmF5LmlzQXJyYXkoIG9iaiApICkgewoKCQkvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KCQlqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaSwgdiApIHsKCQkJaWYgKCB0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KCBwcmVmaXggKSApIHsKCgkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCgkJCQlhZGQoIHByZWZpeCwgdiApOwoKCQkJfSBlbHNlIHsKCgkJCQkvLyBJdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMgbnVtZXJpYyBpbmRleC4KCQkJCWJ1aWxkUGFyYW1zKAoJCQkJCXByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiICYmIHYgIT0gbnVsbCA/IGkgOiAiIiApICsgIl0iLAoJCQkJCXYsCgkJCQkJdHJhZGl0aW9uYWwsCgkJCQkJYWRkCgkJCQkpOwoJCQl9CgkJfSApOwoKCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiB0b1R5cGUoIG9iaiApID09PSAib2JqZWN0IiApIHsKCgkJLy8gU2VyaWFsaXplIG9iamVjdCBpdGVtLgoJCWZvciAoIG5hbWUgaW4gb2JqICkgewoJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgbmFtZSArICJdIiwgb2JqWyBuYW1lIF0sIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQl9CgoJfSBlbHNlIHsKCgkJLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgoJCWFkZCggcHJlZml4LCBvYmogKTsKCX0KfQoKLy8gU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKLy8ga2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nCmpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uKCBhLCB0cmFkaXRpb25hbCApIHsKCXZhciBwcmVmaXgsCgkJcyA9IFtdLAoJCWFkZCA9IGZ1bmN0aW9uKCBrZXksIHZhbHVlT3JGdW5jdGlvbiApIHsKCgkJCS8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgdXNlIGl0cyByZXR1cm4gdmFsdWUKCQkJdmFyIHZhbHVlID0gaXNGdW5jdGlvbiggdmFsdWVPckZ1bmN0aW9uICkgPwoJCQkJdmFsdWVPckZ1bmN0aW9uKCkgOgoJCQkJdmFsdWVPckZ1bmN0aW9uOwoKCQkJc1sgcy5sZW5ndGggXSA9IGVuY29kZVVSSUNvbXBvbmVudCgga2V5ICkgKyAiPSIgKwoJCQkJZW5jb2RlVVJJQ29tcG9uZW50KCB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSApOwoJCX07CgoJaWYgKCBhID09IG51bGwgKSB7CgkJcmV0dXJuICIiOwoJfQoKCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCglpZiAoIEFycmF5LmlzQXJyYXkoIGEgKSB8fCAoIGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdCggYSApICkgKSB7CgoJCS8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwoJCWpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKCQkJYWRkKCB0aGlzLm5hbWUsIHRoaXMudmFsdWUgKTsKCQl9ICk7CgoJfSBlbHNlIHsKCgkJLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCgkJLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCgkJZm9yICggcHJlZml4IGluIGEgKSB7CgkJCWJ1aWxkUGFyYW1zKCBwcmVmaXgsIGFbIHByZWZpeCBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KCXJldHVybiBzLmpvaW4oICImIiApOwp9OwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5LnBhcmFtKCB0aGlzLnNlcmlhbGl6ZUFycmF5KCkgKTsKCX0sCglzZXJpYWxpemVBcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbigpIHsKCgkJCS8vIENhbiBhZGQgcHJvcEhvb2sgZm9yICJlbGVtZW50cyIgdG8gZmlsdGVyIG9yIGFkZCBmb3JtIGVsZW1lbnRzCgkJCXZhciBlbGVtZW50cyA9IGpRdWVyeS5wcm9wKCB0aGlzLCAiZWxlbWVudHMiICk7CgkJCXJldHVybiBlbGVtZW50cyA/IGpRdWVyeS5tYWtlQXJyYXkoIGVsZW1lbnRzICkgOiB0aGlzOwoJCX0gKQoJCS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQl2YXIgdHlwZSA9IHRoaXMudHlwZTsKCgkJCS8vIFVzZSAuaXMoICI6ZGlzYWJsZWQiICkgc28gdGhhdCBmaWVsZHNldFtkaXNhYmxlZF0gd29ya3MKCQkJcmV0dXJuIHRoaXMubmFtZSAmJiAhalF1ZXJ5KCB0aGlzICkuaXMoICI6ZGlzYWJsZWQiICkgJiYKCQkJCXJzdWJtaXR0YWJsZS50ZXN0KCB0aGlzLm5vZGVOYW1lICkgJiYgIXJzdWJtaXR0ZXJUeXBlcy50ZXN0KCB0eXBlICkgJiYKCQkJCSggdGhpcy5jaGVja2VkIHx8ICFyY2hlY2thYmxlVHlwZS50ZXN0KCB0eXBlICkgKTsKCQl9ICkKCQkubWFwKCBmdW5jdGlvbiggaSwgZWxlbSApIHsKCQkJdmFyIHZhbCA9IGpRdWVyeSggdGhpcyApLnZhbCgpOwoKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCQlpZiAoIEFycmF5LmlzQXJyYXkoIHZhbCApICkgewoJCQkJcmV0dXJuIGpRdWVyeS5tYXAoIHZhbCwgZnVuY3Rpb24oIHZhbCApIHsKCQkJCQlyZXR1cm4geyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZSggckNSTEYsICJcclxuIiApIH07CgkJCQl9ICk7CgkJCX0KCgkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKCQl9ICkuZ2V0KCk7Cgl9Cn0gKTsKCgp2YXIKCXIyMCA9IC8lMjAvZywKCXJoYXNoID0gLyMuKiQvLAoJcmFudGlDYWNoZSA9IC8oWz8mXSlfPVteJl0qLywKCXJoZWFkZXJzID0gL14oLio/KTpbIFx0XSooW15cclxuXSopJC9tZywKCgkvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KCXJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sCglybm9Db250ZW50ID0gL14oPzpHRVR8SEVBRCkkLywKCXJwcm90b2NvbCA9IC9eXC9cLy8sCgoJLyogUHJlZmlsdGVycwoJICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKCSAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CgkgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CgkgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCgkgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCgkgKi8KCXByZWZpbHRlcnMgPSB7fSwKCgkvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCgkgKiAxKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAoJICovCgl0cmFuc3BvcnRzID0ge30sCgoJLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCglhbGxUeXBlcyA9ICIqLyIuY29uY2F0KCAiKiIgKSwKCgkvLyBBbmNob3IgdGFnIGZvciBwYXJzaW5nIHRoZSBkb2N1bWVudCBvcmlnaW4KCW9yaWdpbkFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJb3JpZ2luQW5jaG9yLmhyZWYgPSBsb2NhdGlvbi5ocmVmOwoKLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQKZnVuY3Rpb24gYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBzdHJ1Y3R1cmUgKSB7CgoJLy8gZGF0YVR5cGVFeHByZXNzaW9uIGlzIG9wdGlvbmFsIGFuZCBkZWZhdWx0cyB0byAiKiIKCXJldHVybiBmdW5jdGlvbiggZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jICkgewoKCQlpZiAoIHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICJzdHJpbmciICkgewoJCQlmdW5jID0gZGF0YVR5cGVFeHByZXNzaW9uOwoJCQlkYXRhVHlwZUV4cHJlc3Npb24gPSAiKiI7CgkJfQoKCQl2YXIgZGF0YVR5cGUsCgkJCWkgPSAwLAoJCQlkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFtdOwoKCQlpZiAoIGlzRnVuY3Rpb24oIGZ1bmMgKSApIHsKCgkJCS8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBkYXRhVHlwZUV4cHJlc3Npb24KCQkJd2hpbGUgKCAoIGRhdGFUeXBlID0gZGF0YVR5cGVzWyBpKysgXSApICkgewoKCQkJCS8vIFByZXBlbmQgaWYgcmVxdWVzdGVkCgkJCQlpZiAoIGRhdGFUeXBlWyAwIF0gPT09ICIrIiApIHsKCQkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKCAxICkgfHwgIioiOwoJCQkJCSggc3RydWN0dXJlWyBkYXRhVHlwZSBdID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdICkudW5zaGlmdCggZnVuYyApOwoKCQkJCS8vIE90aGVyd2lzZSBhcHBlbmQKCQkJCX0gZWxzZSB7CgkJCQkJKCBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10gKS5wdXNoKCBmdW5jICk7CgkJCQl9CgkJCX0KCQl9Cgl9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApIHsKCgl2YXIgaW5zcGVjdGVkID0ge30sCgkJc2Vla2luZ1RyYW5zcG9ydCA9ICggc3RydWN0dXJlID09PSB0cmFuc3BvcnRzICk7CgoJZnVuY3Rpb24gaW5zcGVjdCggZGF0YVR5cGUgKSB7CgkJdmFyIHNlbGVjdGVkOwoJCWluc3BlY3RlZFsgZGF0YVR5cGUgXSA9IHRydWU7CgkJalF1ZXJ5LmVhY2goIHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSwgZnVuY3Rpb24oIF8sIHByZWZpbHRlck9yRmFjdG9yeSApIHsKCQkJdmFyIGRhdGFUeXBlT3JUcmFuc3BvcnQgPSBwcmVmaWx0ZXJPckZhY3RvcnkoIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIgKTsKCQkJaWYgKCB0eXBlb2YgZGF0YVR5cGVPclRyYW5zcG9ydCA9PT0gInN0cmluZyIgJiYKCQkJCSFzZWVraW5nVHJhbnNwb3J0ICYmICFpbnNwZWN0ZWRbIGRhdGFUeXBlT3JUcmFuc3BvcnQgXSApIHsKCgkJCQlvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlpbnNwZWN0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHNlZWtpbmdUcmFuc3BvcnQgKSB7CgkJCQlyZXR1cm4gISggc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCX0KCQl9ICk7CgkJcmV0dXJuIHNlbGVjdGVkOwoJfQoKCXJldHVybiBpbnNwZWN0KCBvcHRpb25zLmRhdGFUeXBlc1sgMCBdICkgfHwgIWluc3BlY3RlZFsgIioiIF0gJiYgaW5zcGVjdCggIioiICk7Cn0KCi8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwovLyB0aGF0IHRha2VzICJmbGF0IiBvcHRpb25zIChub3QgdG8gYmUgZGVlcCBleHRlbmRlZCkKLy8gRml4ZXMgIzk4ODcKZnVuY3Rpb24gYWpheEV4dGVuZCggdGFyZ2V0LCBzcmMgKSB7Cgl2YXIga2V5LCBkZWVwLAoJCWZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKCglmb3IgKCBrZXkgaW4gc3JjICkgewoJCWlmICggc3JjWyBrZXkgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkoIGZsYXRPcHRpb25zWyBrZXkgXSA/IHRhcmdldCA6ICggZGVlcCB8fCAoIGRlZXAgPSB7fSApICkgKVsga2V5IF0gPSBzcmNbIGtleSBdOwoJCX0KCX0KCWlmICggZGVlcCApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0cnVlLCB0YXJnZXQsIGRlZXAgKTsKCX0KCglyZXR1cm4gdGFyZ2V0Owp9CgovKiBIYW5kbGVzIHJlc3BvbnNlcyB0byBhbiBhamF4IHJlcXVlc3Q6CiAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogKi8KZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApIHsKCgl2YXIgY3QsIHR5cGUsIGZpbmFsRGF0YVR5cGUsIGZpcnN0RGF0YVR5cGUsCgkJY29udGVudHMgPSBzLmNvbnRlbnRzLAoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzOwoKCS8vIFJlbW92ZSBhdXRvIGRhdGFUeXBlIGFuZCBnZXQgY29udGVudC10eXBlIGluIHRoZSBwcm9jZXNzCgl3aGlsZSAoIGRhdGFUeXBlc1sgMCBdID09PSAiKiIgKSB7CgkJZGF0YVR5cGVzLnNoaWZ0KCk7CgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewoJCQljdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoICJDb250ZW50LVR5cGUiICk7CgkJfQoJfQoKCS8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQoJaWYgKCBjdCApIHsKCQlmb3IgKCB0eXBlIGluIGNvbnRlbnRzICkgewoJCQlpZiAoIGNvbnRlbnRzWyB0eXBlIF0gJiYgY29udGVudHNbIHR5cGUgXS50ZXN0KCBjdCApICkgewoJCQkJZGF0YVR5cGVzLnVuc2hpZnQoIHR5cGUgKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoKCS8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQoJaWYgKCBkYXRhVHlwZXNbIDAgXSBpbiByZXNwb25zZXMgKSB7CgkJZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1sgMCBdOwoJfSBlbHNlIHsKCgkJLy8gVHJ5IGNvbnZlcnRpYmxlIGRhdGFUeXBlcwoJCWZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewoJCQlpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbIDAgXSBdICkgewoJCQkJZmluYWxEYXRhVHlwZSA9IHR5cGU7CgkJCQlicmVhazsKCQkJfQoJCQlpZiAoICFmaXJzdERhdGFUeXBlICkgewoJCQkJZmlyc3REYXRhVHlwZSA9IHR5cGU7CgkJCX0KCQl9CgoJCS8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQoJCWZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7Cgl9CgoJLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQoJLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKCS8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKCWlmICggZmluYWxEYXRhVHlwZSApIHsKCQlpZiAoIGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1sgMCBdICkgewoJCQlkYXRhVHlwZXMudW5zaGlmdCggZmluYWxEYXRhVHlwZSApOwoJCX0KCQlyZXR1cm4gcmVzcG9uc2VzWyBmaW5hbERhdGFUeXBlIF07Cgl9Cn0KCi8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlCiAqLwpmdW5jdGlvbiBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKSB7Cgl2YXIgY29udjIsIGN1cnJlbnQsIGNvbnYsIHRtcCwgcHJldiwKCQljb252ZXJ0ZXJzID0ge30sCgoJCS8vIFdvcmsgd2l0aCBhIGNvcHkgb2YgZGF0YVR5cGVzIGluIGNhc2Ugd2UgbmVlZCB0byBtb2RpZnkgaXQgZm9yIGNvbnZlcnNpb24KCQlkYXRhVHlwZXMgPSBzLmRhdGFUeXBlcy5zbGljZSgpOwoKCS8vIENyZWF0ZSBjb252ZXJ0ZXJzIG1hcCB3aXRoIGxvd2VyY2FzZWQga2V5cwoJaWYgKCBkYXRhVHlwZXNbIDEgXSApIHsKCQlmb3IgKCBjb252IGluIHMuY29udmVydGVycyApIHsKCQkJY29udmVydGVyc1sgY29udi50b0xvd2VyQ2FzZSgpIF0gPSBzLmNvbnZlcnRlcnNbIGNvbnYgXTsKCQl9Cgl9CgoJY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOwoKCS8vIENvbnZlcnQgdG8gZWFjaCBzZXF1ZW50aWFsIGRhdGFUeXBlCgl3aGlsZSAoIGN1cnJlbnQgKSB7CgoJCWlmICggcy5yZXNwb25zZUZpZWxkc1sgY3VycmVudCBdICkgewoJCQlqcVhIUlsgcy5yZXNwb25zZUZpZWxkc1sgY3VycmVudCBdIF0gPSByZXNwb25zZTsKCQl9CgoJCS8vIEFwcGx5IHRoZSBkYXRhRmlsdGVyIGlmIHByb3ZpZGVkCgkJaWYgKCAhcHJldiAmJiBpc1N1Y2Nlc3MgJiYgcy5kYXRhRmlsdGVyICkgewoJCQlyZXNwb25zZSA9IHMuZGF0YUZpbHRlciggcmVzcG9uc2UsIHMuZGF0YVR5cGUgKTsKCQl9CgoJCXByZXYgPSBjdXJyZW50OwoJCWN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKCgkJaWYgKCBjdXJyZW50ICkgewoKCQkJLy8gVGhlcmUncyBvbmx5IHdvcmsgdG8gZG8gaWYgY3VycmVudCBkYXRhVHlwZSBpcyBub24tYXV0bwoJCQlpZiAoIGN1cnJlbnQgPT09ICIqIiApIHsKCgkJCQljdXJyZW50ID0gcHJldjsKCgkJCS8vIENvbnZlcnQgcmVzcG9uc2UgaWYgcHJldiBkYXRhVHlwZSBpcyBub24tYXV0byBhbmQgZGlmZmVycyBmcm9tIGN1cnJlbnQKCQkJfSBlbHNlIGlmICggcHJldiAhPT0gIioiICYmIHByZXYgIT09IGN1cnJlbnQgKSB7CgoJCQkJLy8gU2VlayBhIGRpcmVjdCBjb252ZXJ0ZXIKCQkJCWNvbnYgPSBjb252ZXJ0ZXJzWyBwcmV2ICsgIiAiICsgY3VycmVudCBdIHx8IGNvbnZlcnRlcnNbICIqICIgKyBjdXJyZW50IF07CgoJCQkJLy8gSWYgbm9uZSBmb3VuZCwgc2VlayBhIHBhaXIKCQkJCWlmICggIWNvbnYgKSB7CgkJCQkJZm9yICggY29udjIgaW4gY29udmVydGVycyApIHsKCgkJCQkJCS8vIElmIGNvbnYyIG91dHB1dHMgY3VycmVudAoJCQkJCQl0bXAgPSBjb252Mi5zcGxpdCggIiAiICk7CgkJCQkJCWlmICggdG1wWyAxIF0gPT09IGN1cnJlbnQgKSB7CgoJCQkJCQkJLy8gSWYgcHJldiBjYW4gYmUgY29udmVydGVkIHRvIGFjY2VwdGVkIGlucHV0CgkJCQkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIHRtcFsgMCBdIF0gfHwKCQkJCQkJCQljb252ZXJ0ZXJzWyAiKiAiICsgdG1wWyAwIF0gXTsKCQkJCQkJCWlmICggY29udiApIHsKCgkJCQkJCQkJLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwoJCQkJCQkJCWlmICggY29udiA9PT0gdHJ1ZSApIHsKCQkJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIGNvbnYyIF07CgoJCQkJCQkJCS8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKCQkJCQkJCQl9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgewoJCQkJCQkJCQljdXJyZW50ID0gdG1wWyAwIF07CgkJCQkJCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0bXBbIDEgXSApOwoJCQkJCQkJCX0KCQkJCQkJCQlicmVhazsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKCQkJCWlmICggY29udiAhPT0gdHJ1ZSApIHsKCgkJCQkJLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQoJCQkJCWlmICggY29udiAmJiBzLnRocm93cyApIHsKCQkJCQkJcmVzcG9uc2UgPSBjb252KCByZXNwb25zZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkJcmV0dXJuIHsKCQkJCQkJCQlzdGF0ZTogInBhcnNlcmVycm9yIiwKCQkJCQkJCQllcnJvcjogY29udiA/IGUgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyBwcmV2ICsgIiB0byAiICsgY3VycmVudAoJCQkJCQkJfTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9CgpqUXVlcnkuZXh0ZW5kKCB7CgoJLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzCglhY3RpdmU6IDAsCgoJLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAoJbGFzdE1vZGlmaWVkOiB7fSwKCWV0YWc6IHt9LAoKCWFqYXhTZXR0aW5nczogewoJCXVybDogbG9jYXRpb24uaHJlZiwKCQl0eXBlOiAiR0VUIiwKCQlpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KCBsb2NhdGlvbi5wcm90b2NvbCApLAoJCWdsb2JhbDogdHJ1ZSwKCQlwcm9jZXNzRGF0YTogdHJ1ZSwKCQlhc3luYzogdHJ1ZSwKCQljb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCIsCgoJCS8qCgkJdGltZW91dDogMCwKCQlkYXRhOiBudWxsLAoJCWRhdGFUeXBlOiBudWxsLAoJCXVzZXJuYW1lOiBudWxsLAoJCXBhc3N3b3JkOiBudWxsLAoJCWNhY2hlOiBudWxsLAoJCXRocm93czogZmFsc2UsCgkJdHJhZGl0aW9uYWw6IGZhbHNlLAoJCWhlYWRlcnM6IHt9LAoJCSovCgoJCWFjY2VwdHM6IHsKCQkJIioiOiBhbGxUeXBlcywKCQkJdGV4dDogInRleHQvcGxhaW4iLAoJCQlodG1sOiAidGV4dC9odG1sIiwKCQkJeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiCgkJfSwKCgkJY29udGVudHM6IHsKCQkJeG1sOiAvXGJ4bWxcYi8sCgkJCWh0bWw6IC9cYmh0bWwvLAoJCQlqc29uOiAvXGJqc29uXGIvCgkJfSwKCgkJcmVzcG9uc2VGaWVsZHM6IHsKCQkJeG1sOiAicmVzcG9uc2VYTUwiLAoJCQl0ZXh0OiAicmVzcG9uc2VUZXh0IiwKCQkJanNvbjogInJlc3BvbnNlSlNPTiIKCQl9LAoKCQkvLyBEYXRhIGNvbnZlcnRlcnMKCQkvLyBLZXlzIHNlcGFyYXRlIHNvdXJjZSAob3IgY2F0Y2hhbGwgIioiKSBhbmQgZGVzdGluYXRpb24gdHlwZXMgd2l0aCBhIHNpbmdsZSBzcGFjZQoJCWNvbnZlcnRlcnM6IHsKCgkJCS8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAoJCQkiKiB0ZXh0IjogU3RyaW5nLAoKCQkJLy8gVGV4dCB0byBodG1sICh0cnVlID0gbm8gdHJhbnNmb3JtYXRpb24pCgkJCSJ0ZXh0IGh0bWwiOiB0cnVlLAoKCQkJLy8gRXZhbHVhdGUgdGV4dCBhcyBhIGpzb24gZXhwcmVzc2lvbgoJCQkidGV4dCBqc29uIjogSlNPTi5wYXJzZSwKCgkJCS8vIFBhcnNlIHRleHQgYXMgeG1sCgkJCSJ0ZXh0IHhtbCI6IGpRdWVyeS5wYXJzZVhNTAoJCX0sCgoJCS8vIEZvciBvcHRpb25zIHRoYXQgc2hvdWxkbid0IGJlIGRlZXAgZXh0ZW5kZWQ6CgkJLy8geW91IGNhbiBhZGQgeW91ciBvd24gY3VzdG9tIG9wdGlvbnMgaGVyZSBpZgoJCS8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCgkJLy8gZGVlcCBleHRlbmRlZCAoc2VlIGFqYXhFeHRlbmQpCgkJZmxhdE9wdGlvbnM6IHsKCQkJdXJsOiB0cnVlLAoJCQljb250ZXh0OiB0cnVlCgkJfQoJfSwKCgkvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldAoJLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgoJLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KCWFqYXhTZXR1cDogZnVuY3Rpb24oIHRhcmdldCwgc2V0dGluZ3MgKSB7CgkJcmV0dXJuIHNldHRpbmdzID8KCgkJCS8vIEJ1aWxkaW5nIGEgc2V0dGluZ3Mgb2JqZWN0CgkJCWFqYXhFeHRlbmQoIGFqYXhFeHRlbmQoIHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyApLCBzZXR0aW5ncyApIDoKCgkJCS8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKCQkJYWpheEV4dGVuZCggalF1ZXJ5LmFqYXhTZXR0aW5ncywgdGFyZ2V0ICk7Cgl9LAoKCWFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycyApLAoJYWpheFRyYW5zcG9ydDogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCB0cmFuc3BvcnRzICksCgoJLy8gTWFpbiBtZXRob2QKCWFqYXg6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgoJCS8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlCgkJaWYgKCB0eXBlb2YgdXJsID09PSAib2JqZWN0IiApIHsKCQkJb3B0aW9ucyA9IHVybDsKCQkJdXJsID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gRm9yY2Ugb3B0aW9ucyB0byBiZSBhbiBvYmplY3QKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCgkJdmFyIHRyYW5zcG9ydCwKCgkJCS8vIFVSTCB3aXRob3V0IGFudGktY2FjaGUgcGFyYW0KCQkJY2FjaGVVUkwsCgoJCQkvLyBSZXNwb25zZSBoZWFkZXJzCgkJCXJlc3BvbnNlSGVhZGVyc1N0cmluZywKCQkJcmVzcG9uc2VIZWFkZXJzLAoKCQkJLy8gdGltZW91dCBoYW5kbGUKCQkJdGltZW91dFRpbWVyLAoKCQkJLy8gVXJsIGNsZWFudXAgdmFyCgkJCXVybEFuY2hvciwKCgkJCS8vIFJlcXVlc3Qgc3RhdGUgKGJlY29tZXMgZmFsc2UgdXBvbiBzZW5kIGFuZCB0cnVlIHVwb24gY29tcGxldGlvbikKCQkJY29tcGxldGVkLAoKCQkJLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCgkJCWZpcmVHbG9iYWxzLAoKCQkJLy8gTG9vcCB2YXJpYWJsZQoJCQlpLAoKCQkJLy8gdW5jYWNoZWQgcGFydCBvZiB0aGUgdXJsCgkJCXVuY2FjaGVkLAoKCQkJLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAoJCQlzID0galF1ZXJ5LmFqYXhTZXR1cCgge30sIG9wdGlvbnMgKSwKCgkJCS8vIENhbGxiYWNrcyBjb250ZXh0CgkJCWNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAoKCQkJLy8gQ29udGV4dCBmb3IgZ2xvYmFsIGV2ZW50cyBpcyBjYWxsYmFja0NvbnRleHQgaWYgaXQgaXMgYSBET00gbm9kZSBvciBqUXVlcnkgY29sbGVjdGlvbgoJCQlnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYKCQkJCSggY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dC5qcXVlcnkgKSA/CgkJCQkJalF1ZXJ5KCBjYWxsYmFja0NvbnRleHQgKSA6CgkJCQkJalF1ZXJ5LmV2ZW50LAoKCQkJLy8gRGVmZXJyZWRzCgkJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCAib25jZSBtZW1vcnkiICksCgoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQlzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAoKCQkJLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKCQkJcmVxdWVzdEhlYWRlcnMgPSB7fSwKCQkJcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAoKCQkJLy8gRGVmYXVsdCBhYm9ydCBtZXNzYWdlCgkJCXN0ckFib3J0ID0gImNhbmNlbGVkIiwKCgkJCS8vIEZha2UgeGhyCgkJCWpxWEhSID0gewoJCQkJcmVhZHlTdGF0ZTogMCwKCgkJCQkvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCgkJCQlnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24oIGtleSApIHsKCQkJCQl2YXIgbWF0Y2g7CgkJCQkJaWYgKCBjb21wbGV0ZWQgKSB7CgkJCQkJCWlmICggIXJlc3BvbnNlSGVhZGVycyApIHsKCQkJCQkJCXJlc3BvbnNlSGVhZGVycyA9IHt9OwoJCQkJCQkJd2hpbGUgKCAoIG1hdGNoID0gcmhlYWRlcnMuZXhlYyggcmVzcG9uc2VIZWFkZXJzU3RyaW5nICkgKSApIHsKCQkJCQkJCQlyZXNwb25zZUhlYWRlcnNbIG1hdGNoWyAxIF0udG9Mb3dlckNhc2UoKSArICIgIiBdID0KCQkJCQkJCQkJKCByZXNwb25zZUhlYWRlcnNbIG1hdGNoWyAxIF0udG9Mb3dlckNhc2UoKSArICIgIiBdIHx8IFtdICkKCQkJCQkJCQkJCS5jb25jYXQoIG1hdGNoWyAyIF0gKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQltYXRjaCA9IHJlc3BvbnNlSGVhZGVyc1sga2V5LnRvTG93ZXJDYXNlKCkgKyAiICIgXTsKCQkJCQl9CgkJCQkJcmV0dXJuIG1hdGNoID09IG51bGwgPyBudWxsIDogbWF0Y2guam9pbiggIiwgIiApOwoJCQkJfSwKCgkJCQkvLyBSYXcgc3RyaW5nCgkJCQlnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBjb21wbGV0ZWQgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwoJCQkJfSwKCgkJCQkvLyBDYWNoZXMgdGhlIGhlYWRlcgoJCQkJc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCQkJCWlmICggY29tcGxldGVkID09IG51bGwgKSB7CgkJCQkJCW5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBuYW1lLnRvTG93ZXJDYXNlKCkgXSA9CgkJCQkJCQlyZXF1ZXN0SGVhZGVyc05hbWVzWyBuYW1lLnRvTG93ZXJDYXNlKCkgXSB8fCBuYW1lOwoJCQkJCQlyZXF1ZXN0SGVhZGVyc1sgbmFtZSBdID0gdmFsdWU7CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCgkJCQkvLyBPdmVycmlkZXMgcmVzcG9uc2UgY29udGVudC10eXBlIGhlYWRlcgoJCQkJb3ZlcnJpZGVNaW1lVHlwZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJCQkJaWYgKCBjb21wbGV0ZWQgPT0gbnVsbCApIHsKCQkJCQkJcy5taW1lVHlwZSA9IHR5cGU7CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCgkJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQkJc3RhdHVzQ29kZTogZnVuY3Rpb24oIG1hcCApIHsKCQkJCQl2YXIgY29kZTsKCQkJCQlpZiAoIG1hcCApIHsKCQkJCQkJaWYgKCBjb21wbGV0ZWQgKSB7CgoJCQkJCQkJLy8gRXhlY3V0ZSB0aGUgYXBwcm9wcmlhdGUgY2FsbGJhY2tzCgkJCQkJCQlqcVhIUi5hbHdheXMoIG1hcFsganFYSFIuc3RhdHVzIF0gKTsKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkvLyBMYXp5LWFkZCB0aGUgbmV3IGNhbGxiYWNrcyBpbiBhIHdheSB0aGF0IHByZXNlcnZlcyBvbGQgb25lcwoJCQkJCQkJZm9yICggY29kZSBpbiBtYXAgKSB7CgkJCQkJCQkJc3RhdHVzQ29kZVsgY29kZSBdID0gWyBzdGF0dXNDb2RlWyBjb2RlIF0sIG1hcFsgY29kZSBdIF07CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIENhbmNlbCB0aGUgcmVxdWVzdAoJCQkJYWJvcnQ6IGZ1bmN0aW9uKCBzdGF0dXNUZXh0ICkgewoJCQkJCXZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwoJCQkJCWlmICggdHJhbnNwb3J0ICkgewoJCQkJCQl0cmFuc3BvcnQuYWJvcnQoIGZpbmFsVGV4dCApOwoJCQkJCX0KCQkJCQlkb25lKCAwLCBmaW5hbFRleHQgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJfTsKCgkJLy8gQXR0YWNoIGRlZmVycmVkcwoJCWRlZmVycmVkLnByb21pc2UoIGpxWEhSICk7CgoJCS8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKHByZWZpbHRlcnMgbWlnaHQgZXhwZWN0IGl0KQoJCS8vIEhhbmRsZSBmYWxzeSB1cmwgaW4gdGhlIHNldHRpbmdzIG9iamVjdCAoIzEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpCgkJLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCgkJcy51cmwgPSAoICggdXJsIHx8IHMudXJsIHx8IGxvY2F0aW9uLmhyZWYgKSArICIiICkKCQkJLnJlcGxhY2UoIHJwcm90b2NvbCwgbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICk7CgoJCS8vIEFsaWFzIG1ldGhvZCBvcHRpb24gdG8gdHlwZSBhcyBwZXIgdGlja2V0ICMxMjAwNAoJCXMudHlwZSA9IG9wdGlvbnMubWV0aG9kIHx8IG9wdGlvbnMudHlwZSB8fCBzLm1ldGhvZCB8fCBzLnR5cGU7CgoJCS8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKCQlzLmRhdGFUeXBlcyA9ICggcy5kYXRhVHlwZSB8fCAiKiIgKS50b0xvd2VyQ2FzZSgpLm1hdGNoKCBybm90aHRtbHdoaXRlICkgfHwgWyAiIiBdOwoKCQkvLyBBIGNyb3NzLWRvbWFpbiByZXF1ZXN0IGlzIGluIG9yZGVyIHdoZW4gdGhlIG9yaWdpbiBkb2Vzbid0IG1hdGNoIHRoZSBjdXJyZW50IG9yaWdpbi4KCQlpZiAoIHMuY3Jvc3NEb21haW4gPT0gbnVsbCApIHsKCQkJdXJsQW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CgoJCQkvLyBTdXBwb3J0OiBJRSA8PTggLSAxMSwgRWRnZSAxMiAtIDE1CgkJCS8vIElFIHRocm93cyBleGNlcHRpb24gb24gYWNjZXNzaW5nIHRoZSBocmVmIHByb3BlcnR5IGlmIHVybCBpcyBtYWxmb3JtZWQsCgkJCS8vIGUuZy4gaHR0cDovL2V4YW1wbGUuY29tOjgweC8KCQkJdHJ5IHsKCQkJCXVybEFuY2hvci5ocmVmID0gcy51cmw7CgoJCQkJLy8gU3VwcG9ydDogSUUgPD04IC0gMTEgb25seQoJCQkJLy8gQW5jaG9yJ3MgaG9zdCBwcm9wZXJ0eSBpc24ndCBjb3JyZWN0bHkgc2V0IHdoZW4gcy51cmwgaXMgcmVsYXRpdmUKCQkJCXVybEFuY2hvci5ocmVmID0gdXJsQW5jaG9yLmhyZWY7CgkJCQlzLmNyb3NzRG9tYWluID0gb3JpZ2luQW5jaG9yLnByb3RvY29sICsgIi8vIiArIG9yaWdpbkFuY2hvci5ob3N0ICE9PQoJCQkJCXVybEFuY2hvci5wcm90b2NvbCArICIvLyIgKyB1cmxBbmNob3IuaG9zdDsKCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJLy8gSWYgdGhlcmUgaXMgYW4gZXJyb3IgcGFyc2luZyB0aGUgVVJMLCBhc3N1bWUgaXQgaXMgY3Jvc3NEb21haW4sCgkJCQkvLyBpdCBjYW4gYmUgcmVqZWN0ZWQgYnkgdGhlIHRyYW5zcG9ydCBpZiBpdCBpcyBpbnZhbGlkCgkJCQlzLmNyb3NzRG9tYWluID0gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCgkJaWYgKCBzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcy5kYXRhID0galF1ZXJ5LnBhcmFtKCBzLmRhdGEsIHMudHJhZGl0aW9uYWwgKTsKCQl9CgoJCS8vIEFwcGx5IHByZWZpbHRlcnMKCQlpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUKCQlpZiAoIGNvbXBsZXRlZCApIHsKCQkJcmV0dXJuIGpxWEhSOwoJCX0KCgkJLy8gV2UgY2FuIGZpcmUgZ2xvYmFsIGV2ZW50cyBhcyBvZiBub3cgaWYgYXNrZWQgdG8KCQkvLyBEb24ndCBmaXJlIGV2ZW50cyBpZiBqUXVlcnkuZXZlbnQgaXMgdW5kZWZpbmVkIGluIGFuIEFNRC11c2FnZSBzY2VuYXJpbyAoIzE1MTE4KQoJCWZpcmVHbG9iYWxzID0galF1ZXJ5LmV2ZW50ICYmIHMuZ2xvYmFsOwoKCQkvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCgkJaWYgKCBmaXJlR2xvYmFscyAmJiBqUXVlcnkuYWN0aXZlKysgPT09IDAgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheFN0YXJ0IiApOwoJCX0KCgkJLy8gVXBwZXJjYXNlIHRoZSB0eXBlCgkJcy50eXBlID0gcy50eXBlLnRvVXBwZXJDYXNlKCk7CgoJCS8vIERldGVybWluZSBpZiByZXF1ZXN0IGhhcyBjb250ZW50CgkJcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdCggcy50eXBlICk7CgoJCS8vIFNhdmUgdGhlIFVSTCBpbiBjYXNlIHdlJ3JlIHRveWluZyB3aXRoIHRoZSBJZi1Nb2RpZmllZC1TaW5jZQoJCS8vIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciBsYXRlciBvbgoJCS8vIFJlbW92ZSBoYXNoIHRvIHNpbXBsaWZ5IHVybCBtYW5pcHVsYXRpb24KCQljYWNoZVVSTCA9IHMudXJsLnJlcGxhY2UoIHJoYXNoLCAiIiApOwoKCQkvLyBNb3JlIG9wdGlvbnMgaGFuZGxpbmcgZm9yIHJlcXVlc3RzIHdpdGggbm8gY29udGVudAoJCWlmICggIXMuaGFzQ29udGVudCApIHsKCgkJCS8vIFJlbWVtYmVyIHRoZSBoYXNoIHNvIHdlIGNhbiBwdXQgaXQgYmFjawoJCQl1bmNhY2hlZCA9IHMudXJsLnNsaWNlKCBjYWNoZVVSTC5sZW5ndGggKTsKCgkJCS8vIElmIGRhdGEgaXMgYXZhaWxhYmxlIGFuZCBzaG91bGQgYmUgcHJvY2Vzc2VkLCBhcHBlbmQgZGF0YSB0byB1cmwKCQkJaWYgKCBzLmRhdGEgJiYgKCBzLnByb2Nlc3NEYXRhIHx8IHR5cGVvZiBzLmRhdGEgPT09ICJzdHJpbmciICkgKSB7CgkJCQljYWNoZVVSTCArPSAoIHJxdWVyeS50ZXN0KCBjYWNoZVVSTCApID8gIiYiIDogIj8iICkgKyBzLmRhdGE7CgoJCQkJLy8gIzk2ODI6IHJlbW92ZSBkYXRhIHNvIHRoYXQgaXQncyBub3QgdXNlZCBpbiBhbiBldmVudHVhbCByZXRyeQoJCQkJZGVsZXRlIHMuZGF0YTsKCQkJfQoKCQkJLy8gQWRkIG9yIHVwZGF0ZSBhbnRpLWNhY2hlIHBhcmFtIGlmIG5lZWRlZAoJCQlpZiAoIHMuY2FjaGUgPT09IGZhbHNlICkgewoJCQkJY2FjaGVVUkwgPSBjYWNoZVVSTC5yZXBsYWNlKCByYW50aUNhY2hlLCAiJDEiICk7CgkJCQl1bmNhY2hlZCA9ICggcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArICJfPSIgKyAoIG5vbmNlKysgKSArIHVuY2FjaGVkOwoJCQl9CgoJCQkvLyBQdXQgaGFzaCBhbmQgYW50aS1jYWNoZSBvbiB0aGUgVVJMIHRoYXQgd2lsbCBiZSByZXF1ZXN0ZWQgKGdoLTE3MzIpCgkJCXMudXJsID0gY2FjaGVVUkwgKyB1bmNhY2hlZDsKCgkJLy8gQ2hhbmdlICclMjAnIHRvICcrJyBpZiB0aGlzIGlzIGVuY29kZWQgZm9ybSBib2R5IGNvbnRlbnQgKGdoLTI2NTgpCgkJfSBlbHNlIGlmICggcy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYKCQkJKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkuaW5kZXhPZiggImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIgKSA9PT0gMCApIHsKCQkJcy5kYXRhID0gcy5kYXRhLnJlcGxhY2UoIHIyMCwgIisiICk7CgkJfQoKCQkvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgoJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQlpZiAoIGpRdWVyeS5sYXN0TW9kaWZpZWRbIGNhY2hlVVJMIF0gKSB7CgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdICk7CgkJCX0KCQkJaWYgKCBqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSApIHsKCQkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJJZi1Ob25lLU1hdGNoIiwgalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKTsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CgkJaWYgKCBzLmRhdGEgJiYgcy5oYXNDb250ZW50ICYmIHMuY29udGVudFR5cGUgIT09IGZhbHNlIHx8IG9wdGlvbnMuY29udGVudFR5cGUgKSB7CgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlICk7CgkJfQoKCQkvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCgkJanFYSFIuc2V0UmVxdWVzdEhlYWRlcigKCQkJIkFjY2VwdCIsCgkJCXMuZGF0YVR5cGVzWyAwIF0gJiYgcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1sgMCBdIF0gPwoJCQkJcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1sgMCBdIF0gKwoJCQkJCSggcy5kYXRhVHlwZXNbIDAgXSAhPT0gIioiID8gIiwgIiArIGFsbFR5cGVzICsgIjsgcT0wLjAxIiA6ICIiICkgOgoJCQkJcy5hY2NlcHRzWyAiKiIgXQoJCSk7CgoJCS8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbgoJCWZvciAoIGkgaW4gcy5oZWFkZXJzICkgewoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCBpLCBzLmhlYWRlcnNbIGkgXSApOwoJCX0KCgkJLy8gQWxsb3cgY3VzdG9tIGhlYWRlcnMvbWltZXR5cGVzIGFuZCBlYXJseSBhYm9ydAoJCWlmICggcy5iZWZvcmVTZW5kICYmCgkJCSggcy5iZWZvcmVTZW5kLmNhbGwoIGNhbGxiYWNrQ29udGV4dCwganFYSFIsIHMgKSA9PT0gZmFsc2UgfHwgY29tcGxldGVkICkgKSB7CgoJCQkvLyBBYm9ydCBpZiBub3QgZG9uZSBhbHJlYWR5IGFuZCByZXR1cm4KCQkJcmV0dXJuIGpxWEhSLmFib3J0KCk7CgkJfQoKCQkvLyBBYm9ydGluZyBpcyBubyBsb25nZXIgYSBjYW5jZWxsYXRpb24KCQlzdHJBYm9ydCA9ICJhYm9ydCI7CgoJCS8vIEluc3RhbGwgY2FsbGJhY2tzIG9uIGRlZmVycmVkcwoJCWNvbXBsZXRlRGVmZXJyZWQuYWRkKCBzLmNvbXBsZXRlICk7CgkJanFYSFIuZG9uZSggcy5zdWNjZXNzICk7CgkJanFYSFIuZmFpbCggcy5lcnJvciApOwoKCQkvLyBHZXQgdHJhbnNwb3J0CgkJdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgoJCS8vIElmIG5vIHRyYW5zcG9ydCwgd2UgYXV0by1hYm9ydAoJCWlmICggIXRyYW5zcG9ydCApIHsKCQkJZG9uZSggLTEsICJObyBUcmFuc3BvcnQiICk7CgkJfSBlbHNlIHsKCQkJanFYSFIucmVhZHlTdGF0ZSA9IDE7CgoJCQkvLyBTZW5kIGdsb2JhbCBldmVudAoJCQlpZiAoIGZpcmVHbG9iYWxzICkgewoJCQkJZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoICJhamF4U2VuZCIsIFsganFYSFIsIHMgXSApOwoJCQl9CgoJCQkvLyBJZiByZXF1ZXN0IHdhcyBhYm9ydGVkIGluc2lkZSBhamF4U2VuZCwgc3RvcCB0aGVyZQoJCQlpZiAoIGNvbXBsZXRlZCApIHsKCQkJCXJldHVybiBqcVhIUjsKCQkJfQoKCQkJLy8gVGltZW91dAoJCQlpZiAoIHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCApIHsKCQkJCXRpbWVvdXRUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlqcVhIUi5hYm9ydCggInRpbWVvdXQiICk7CgkJCQl9LCBzLnRpbWVvdXQgKTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWNvbXBsZXRlZCA9IGZhbHNlOwoJCQkJdHJhbnNwb3J0LnNlbmQoIHJlcXVlc3RIZWFkZXJzLCBkb25lICk7CgkJCX0gY2F0Y2ggKCBlICkgewoKCQkJCS8vIFJldGhyb3cgcG9zdC1jb21wbGV0aW9uIGV4Y2VwdGlvbnMKCQkJCWlmICggY29tcGxldGVkICkgewoJCQkJCXRocm93IGU7CgkJCQl9CgoJCQkJLy8gUHJvcGFnYXRlIG90aGVycyBhcyByZXN1bHRzCgkJCQlkb25lKCAtMSwgZSApOwoJCQl9CgkJfQoKCQkvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKCQlmdW5jdGlvbiBkb25lKCBzdGF0dXMsIG5hdGl2ZVN0YXR1c1RleHQsIHJlc3BvbnNlcywgaGVhZGVycyApIHsKCQkJdmFyIGlzU3VjY2Vzcywgc3VjY2VzcywgZXJyb3IsIHJlc3BvbnNlLCBtb2RpZmllZCwKCQkJCXN0YXR1c1RleHQgPSBuYXRpdmVTdGF0dXNUZXh0OwoKCQkJLy8gSWdub3JlIHJlcGVhdCBpbnZvY2F0aW9ucwoJCQlpZiAoIGNvbXBsZXRlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJY29tcGxldGVkID0gdHJ1ZTsKCgkJCS8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzCgkJCWlmICggdGltZW91dFRpbWVyICkgewoJCQkJd2luZG93LmNsZWFyVGltZW91dCggdGltZW91dFRpbWVyICk7CgkJCX0KCgkJCS8vIERlcmVmZXJlbmNlIHRyYW5zcG9ydCBmb3IgZWFybHkgZ2FyYmFnZSBjb2xsZWN0aW9uCgkJCS8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCgkJCXRyYW5zcG9ydCA9IHVuZGVmaW5lZDsKCgkJCS8vIENhY2hlIHJlc3BvbnNlIGhlYWRlcnMKCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsKCgkJCS8vIFNldCByZWFkeVN0YXRlCgkJCWpxWEhSLnJlYWR5U3RhdGUgPSBzdGF0dXMgPiAwID8gNCA6IDA7CgoJCQkvLyBEZXRlcm1pbmUgaWYgc3VjY2Vzc2Z1bAoJCQlpc1N1Y2Nlc3MgPSBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNDsKCgkJCS8vIEdldCByZXNwb25zZSBkYXRhCgkJCWlmICggcmVzcG9uc2VzICkgewoJCQkJcmVzcG9uc2UgPSBhamF4SGFuZGxlUmVzcG9uc2VzKCBzLCBqcVhIUiwgcmVzcG9uc2VzICk7CgkJCX0KCgkJCS8vIENvbnZlcnQgbm8gbWF0dGVyIHdoYXQgKHRoYXQgd2F5IHJlc3BvbnNlWFhYIGZpZWxkcyBhcmUgYWx3YXlzIHNldCkKCQkJcmVzcG9uc2UgPSBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKTsKCgkJCS8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nCgkJCWlmICggaXNTdWNjZXNzICkgewoKCQkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCgkJCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCAiTGFzdC1Nb2RpZmllZCIgKTsKCQkJCQlpZiAoIG1vZGlmaWVkICkgewoJCQkJCQlqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdID0gbW9kaWZpZWQ7CgkJCQkJfQoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoICJldGFnIiApOwoJCQkJCWlmICggbW9kaWZpZWQgKSB7CgkJCQkJCWpRdWVyeS5ldGFnWyBjYWNoZVVSTCBdID0gbW9kaWZpZWQ7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIGlmIG5vIGNvbnRlbnQKCQkJCWlmICggc3RhdHVzID09PSAyMDQgfHwgcy50eXBlID09PSAiSEVBRCIgKSB7CgkJCQkJc3RhdHVzVGV4dCA9ICJub2NvbnRlbnQiOwoKCQkJCS8vIGlmIG5vdCBtb2RpZmllZAoJCQkJfSBlbHNlIGlmICggc3RhdHVzID09PSAzMDQgKSB7CgkJCQkJc3RhdHVzVGV4dCA9ICJub3Rtb2RpZmllZCI7CgoJCQkJLy8gSWYgd2UgaGF2ZSBkYXRhLCBsZXQncyBjb252ZXJ0IGl0CgkJCQl9IGVsc2UgewoJCQkJCXN0YXR1c1RleHQgPSByZXNwb25zZS5zdGF0ZTsKCQkJCQlzdWNjZXNzID0gcmVzcG9uc2UuZGF0YTsKCQkJCQllcnJvciA9IHJlc3BvbnNlLmVycm9yOwoJCQkJCWlzU3VjY2VzcyA9ICFlcnJvcjsKCQkJCX0KCQkJfSBlbHNlIHsKCgkJCQkvLyBFeHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dCBhbmQgbm9ybWFsaXplIGZvciBub24tYWJvcnRzCgkJCQllcnJvciA9IHN0YXR1c1RleHQ7CgkJCQlpZiAoIHN0YXR1cyB8fCAhc3RhdHVzVGV4dCApIHsKCQkJCQlzdGF0dXNUZXh0ID0gImVycm9yIjsKCQkJCQlpZiAoIHN0YXR1cyA8IDAgKSB7CgkJCQkJCXN0YXR1cyA9IDA7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBTZXQgZGF0YSBmb3IgdGhlIGZha2UgeGhyIG9iamVjdAoJCQlqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CgkJCWpxWEhSLnN0YXR1c1RleHQgPSAoIG5hdGl2ZVN0YXR1c1RleHQgfHwgc3RhdHVzVGV4dCApICsgIiI7CgoJCQkvLyBTdWNjZXNzL0Vycm9yCgkJCWlmICggaXNTdWNjZXNzICkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUiBdICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlcnJlZC5yZWplY3RXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsganFYSFIsIHN0YXR1c1RleHQsIGVycm9yIF0gKTsKCQkJfQoKCQkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKCQkJanFYSFIuc3RhdHVzQ29kZSggc3RhdHVzQ29kZSApOwoJCQlzdGF0dXNDb2RlID0gdW5kZWZpbmVkOwoKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCBpc1N1Y2Nlc3MgPyAiYWpheFN1Y2Nlc3MiIDogImFqYXhFcnJvciIsCgkJCQkJWyBqcVhIUiwgcywgaXNTdWNjZXNzID8gc3VjY2VzcyA6IGVycm9yIF0gKTsKCQkJfQoKCQkJLy8gQ29tcGxldGUKCQkJY29tcGxldGVEZWZlcnJlZC5maXJlV2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0IF0gKTsKCgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhDb21wbGV0ZSIsIFsganFYSFIsIHMgXSApOwoKCQkJCS8vIEhhbmRsZSB0aGUgZ2xvYmFsIEFKQVggY291bnRlcgoJCQkJaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdG9wIiApOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4ganFYSFI7Cgl9LAoKCWdldEpTT046IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIGNhbGxiYWNrICkgewoJCXJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIgKTsKCX0sCgoJZ2V0U2NyaXB0OiBmdW5jdGlvbiggdXJsLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCB1bmRlZmluZWQsIGNhbGxiYWNrLCAic2NyaXB0IiApOwoJfQp9ICk7CgpqUXVlcnkuZWFjaCggWyAiZ2V0IiwgInBvc3QiIF0sIGZ1bmN0aW9uKCBpLCBtZXRob2QgKSB7CglqUXVlcnlbIG1ldGhvZCBdID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUgKSB7CgoJCS8vIFNoaWZ0IGFyZ3VtZW50cyBpZiBkYXRhIGFyZ3VtZW50IHdhcyBvbWl0dGVkCgkJaWYgKCBpc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCXR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwoJCQljYWxsYmFjayA9IGRhdGE7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBUaGUgdXJsIGNhbiBiZSBhbiBvcHRpb25zIG9iamVjdCAod2hpY2ggdGhlbiBtdXN0IGhhdmUgLnVybCkKCQlyZXR1cm4galF1ZXJ5LmFqYXgoIGpRdWVyeS5leHRlbmQoIHsKCQkJdXJsOiB1cmwsCgkJCXR5cGU6IG1ldGhvZCwKCQkJZGF0YVR5cGU6IHR5cGUsCgkJCWRhdGE6IGRhdGEsCgkJCXN1Y2Nlc3M6IGNhbGxiYWNrCgkJfSwgalF1ZXJ5LmlzUGxhaW5PYmplY3QoIHVybCApICYmIHVybCApICk7Cgl9Owp9ICk7CgoKalF1ZXJ5Ll9ldmFsVXJsID0gZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCXJldHVybiBqUXVlcnkuYWpheCggewoJCXVybDogdXJsLAoKCQkvLyBNYWtlIHRoaXMgZXhwbGljaXQsIHNpbmNlIHVzZXIgY2FuIG92ZXJyaWRlIHRoaXMgdGhyb3VnaCBhamF4U2V0dXAgKCMxMTI2NCkKCQl0eXBlOiAiR0VUIiwKCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJY2FjaGU6IHRydWUsCgkJYXN5bmM6IGZhbHNlLAoJCWdsb2JhbDogZmFsc2UsCgoJCS8vIE9ubHkgZXZhbHVhdGUgdGhlIHJlc3BvbnNlIGlmIGl0IGlzIHN1Y2Nlc3NmdWwgKGdoLTQxMjYpCgkJLy8gZGF0YUZpbHRlciBpcyBub3QgaW52b2tlZCBmb3IgZmFpbHVyZSByZXNwb25zZXMsIHNvIHVzaW5nIGl0IGluc3RlYWQKCQkvLyBvZiB0aGUgZGVmYXVsdCBjb252ZXJ0ZXIgaXMga2x1ZGd5IGJ1dCBpdCB3b3Jrcy4KCQljb252ZXJ0ZXJzOiB7CgkJCSJ0ZXh0IHNjcmlwdCI6IGZ1bmN0aW9uKCkge30KCQl9LAoJCWRhdGFGaWx0ZXI6IGZ1bmN0aW9uKCByZXNwb25zZSApIHsKCQkJalF1ZXJ5Lmdsb2JhbEV2YWwoIHJlc3BvbnNlLCBvcHRpb25zICk7CgkJfQoJfSApOwp9OwoKCmpRdWVyeS5mbi5leHRlbmQoIHsKCXdyYXBBbGw6IGZ1bmN0aW9uKCBodG1sICkgewoJCXZhciB3cmFwOwoKCQlpZiAoIHRoaXNbIDAgXSApIHsKCQkJaWYgKCBpc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCQlodG1sID0gaHRtbC5jYWxsKCB0aGlzWyAwIF0gKTsKCQkJfQoKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJd3JhcCA9IGpRdWVyeSggaHRtbCwgdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQgKS5lcSggMCApLmNsb25lKCB0cnVlICk7CgoJCQlpZiAoIHRoaXNbIDAgXS5wYXJlbnROb2RlICkgewoJCQkJd3JhcC5pbnNlcnRCZWZvcmUoIHRoaXNbIDAgXSApOwoJCQl9CgoJCQl3cmFwLm1hcCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgZWxlbSA9IHRoaXM7CgoJCQkJd2hpbGUgKCBlbGVtLmZpcnN0RWxlbWVudENoaWxkICkgewoJCQkJCWVsZW0gPSBlbGVtLmZpcnN0RWxlbWVudENoaWxkOwoJCQkJfQoKCQkJCXJldHVybiBlbGVtOwoJCQl9ICkuYXBwZW5kKCB0aGlzICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcElubmVyOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGlzRnVuY3Rpb24oIGh0bWwgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oIGkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS53cmFwSW5uZXIoIGh0bWwuY2FsbCggdGhpcywgaSApICk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IGpRdWVyeSggdGhpcyApLAoJCQkJY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CgoJCQlpZiAoIGNvbnRlbnRzLmxlbmd0aCApIHsKCQkJCWNvbnRlbnRzLndyYXBBbGwoIGh0bWwgKTsKCgkJCX0gZWxzZSB7CgkJCQlzZWxmLmFwcGVuZCggaHRtbCApOwoJCQl9CgkJfSApOwoJfSwKCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsKCQl2YXIgaHRtbElzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uKCBodG1sICk7CgoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCBpICkgewoJCQlqUXVlcnkoIHRoaXMgKS53cmFwQWxsKCBodG1sSXNGdW5jdGlvbiA/IGh0bWwuY2FsbCggdGhpcywgaSApIDogaHRtbCApOwoJCX0gKTsKCX0sCgoJdW53cmFwOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdGhpcy5wYXJlbnQoIHNlbGVjdG9yICkubm90KCAiYm9keSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5KCB0aGlzICkucmVwbGFjZVdpdGgoIHRoaXMuY2hpbGROb2RlcyApOwoJCX0gKTsKCQlyZXR1cm4gdGhpczsKCX0KfSApOwoKCmpRdWVyeS5leHByLnBzZXVkb3MuaGlkZGVuID0gZnVuY3Rpb24oIGVsZW0gKSB7CglyZXR1cm4gIWpRdWVyeS5leHByLnBzZXVkb3MudmlzaWJsZSggZWxlbSApOwp9OwpqUXVlcnkuZXhwci5wc2V1ZG9zLnZpc2libGUgPSBmdW5jdGlvbiggZWxlbSApIHsKCXJldHVybiAhISggZWxlbS5vZmZzZXRXaWR0aCB8fCBlbGVtLm9mZnNldEhlaWdodCB8fCBlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoICk7Cn07CgoKCgpqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IGZ1bmN0aW9uKCkgewoJdHJ5IHsKCQlyZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwoJfSBjYXRjaCAoIGUgKSB7fQp9OwoKdmFyIHhoclN1Y2Nlc3NTdGF0dXMgPSB7CgoJCS8vIEZpbGUgcHJvdG9jb2wgYWx3YXlzIHlpZWxkcyBzdGF0dXMgY29kZSAwLCBhc3N1bWUgMjAwCgkJMDogMjAwLAoKCQkvLyBTdXBwb3J0OiBJRSA8PTkgb25seQoJCS8vICMxNDUwOiBzb21ldGltZXMgSUUgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAoJCTEyMjM6IDIwNAoJfSwKCXhoclN1cHBvcnRlZCA9IGpRdWVyeS5hamF4U2V0dGluZ3MueGhyKCk7CgpzdXBwb3J0LmNvcnMgPSAhIXhoclN1cHBvcnRlZCAmJiAoICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhoclN1cHBvcnRlZCApOwpzdXBwb3J0LmFqYXggPSB4aHJTdXBwb3J0ZWQgPSAhIXhoclN1cHBvcnRlZDsKCmpRdWVyeS5hamF4VHJhbnNwb3J0KCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXZhciBjYWxsYmFjaywgZXJyb3JDYWxsYmFjazsKCgkvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CglpZiAoIHN1cHBvcnQuY29ycyB8fCB4aHJTdXBwb3J0ZWQgJiYgIW9wdGlvbnMuY3Jvc3NEb21haW4gKSB7CgkJcmV0dXJuIHsKCQkJc2VuZDogZnVuY3Rpb24oIGhlYWRlcnMsIGNvbXBsZXRlICkgewoJCQkJdmFyIGksCgkJCQkJeGhyID0gb3B0aW9ucy54aHIoKTsKCgkJCQl4aHIub3BlbigKCQkJCQlvcHRpb25zLnR5cGUsCgkJCQkJb3B0aW9ucy51cmwsCgkJCQkJb3B0aW9ucy5hc3luYywKCQkJCQlvcHRpb25zLnVzZXJuYW1lLAoJCQkJCW9wdGlvbnMucGFzc3dvcmQKCQkJCSk7CgoJCQkJLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAoJCQkJaWYgKCBvcHRpb25zLnhockZpZWxkcyApIHsKCQkJCQlmb3IgKCBpIGluIG9wdGlvbnMueGhyRmllbGRzICkgewoJCQkJCQl4aHJbIGkgXSA9IG9wdGlvbnMueGhyRmllbGRzWyBpIF07CgkJCQkJfQoJCQkJfQoKCQkJCS8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKCQkJCWlmICggb3B0aW9ucy5taW1lVHlwZSAmJiB4aHIub3ZlcnJpZGVNaW1lVHlwZSApIHsKCQkJCQl4aHIub3ZlcnJpZGVNaW1lVHlwZSggb3B0aW9ucy5taW1lVHlwZSApOwoJCQkJfQoKCQkJCS8vIFgtUmVxdWVzdGVkLVdpdGggaGVhZGVyCgkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCgkJCQkvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgoJCQkJLy8gKGl0IGNhbiBhbHdheXMgYmUgc2V0IG9uIGEgcGVyLXJlcXVlc3QgYmFzaXMgb3IgZXZlbiB1c2luZyBhamF4U2V0dXApCgkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KCQkJCWlmICggIW9wdGlvbnMuY3Jvc3NEb21haW4gJiYgIWhlYWRlcnNbICJYLVJlcXVlc3RlZC1XaXRoIiBdICkgewoJCQkJCWhlYWRlcnNbICJYLVJlcXVlc3RlZC1XaXRoIiBdID0gIlhNTEh0dHBSZXF1ZXN0IjsKCQkJCX0KCgkJCQkvLyBTZXQgaGVhZGVycwoJCQkJZm9yICggaSBpbiBoZWFkZXJzICkgewoJCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKCBpLCBoZWFkZXJzWyBpIF0gKTsKCQkJCX0KCgkJCQkvLyBDYWxsYmFjawoJCQkJY2FsbGJhY2sgPSBmdW5jdGlvbiggdHlwZSApIHsKCQkJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCQljYWxsYmFjayA9IGVycm9yQ2FsbGJhY2sgPSB4aHIub25sb2FkID0KCQkJCQkJCQl4aHIub25lcnJvciA9IHhoci5vbmFib3J0ID0geGhyLm9udGltZW91dCA9CgkJCQkJCQkJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKCQkJCQkJCWlmICggdHlwZSA9PT0gImFib3J0IiApIHsKCQkJCQkJCQl4aHIuYWJvcnQoKTsKCQkJCQkJCX0gZWxzZSBpZiAoIHR5cGUgPT09ICJlcnJvciIgKSB7CgoJCQkJCQkJCS8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CgkJCQkJCQkJLy8gT24gYSBtYW51YWwgbmF0aXZlIGFib3J0LCBJRTkgdGhyb3dzCgkJCQkJCQkJLy8gZXJyb3JzIG9uIGFueSBwcm9wZXJ0eSBhY2Nlc3MgdGhhdCBpcyBub3QgcmVhZHlTdGF0ZQoJCQkJCQkJCWlmICggdHlwZW9mIHhoci5zdGF0dXMgIT09ICJudW1iZXIiICkgewoJCQkJCQkJCQljb21wbGV0ZSggMCwgImVycm9yIiApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWNvbXBsZXRlKAoKCQkJCQkJCQkJCS8vIEZpbGU6IHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIDA7IHNlZSAjODYwNSwgIzE0MjA3CgkJCQkJCQkJCQl4aHIuc3RhdHVzLAoJCQkJCQkJCQkJeGhyLnN0YXR1c1RleHQKCQkJCQkJCQkJKTsKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvbXBsZXRlKAoJCQkJCQkJCQl4aHJTdWNjZXNzU3RhdHVzWyB4aHIuc3RhdHVzIF0gfHwgeGhyLnN0YXR1cywKCQkJCQkJCQkJeGhyLnN0YXR1c1RleHQsCgoJCQkJCQkJCQkvLyBTdXBwb3J0OiBJRSA8PTkgb25seQoJCQkJCQkJCQkvLyBJRTkgaGFzIG5vIFhIUjIgYnV0IHRocm93cyBvbiBiaW5hcnkgKHRyYWMtMTE0MjYpCgkJCQkJCQkJCS8vIEZvciBYSFIyIG5vbi10ZXh0LCBsZXQgdGhlIGNhbGxlciBoYW5kbGUgaXQgKGdoLTI0OTgpCgkJCQkJCQkJCSggeGhyLnJlc3BvbnNlVHlwZSB8fCAidGV4dCIgKSAhPT0gInRleHQiICB8fAoJCQkJCQkJCQl0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCAhPT0gInN0cmluZyIgPwoJCQkJCQkJCQkJeyBiaW5hcnk6IHhoci5yZXNwb25zZSB9IDoKCQkJCQkJCQkJCXsgdGV4dDogeGhyLnJlc3BvbnNlVGV4dCB9LAoJCQkJCQkJCQl4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkKCQkJCQkJCQkpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfTsKCQkJCX07CgoJCQkJLy8gTGlzdGVuIHRvIGV2ZW50cwoJCQkJeGhyLm9ubG9hZCA9IGNhbGxiYWNrKCk7CgkJCQllcnJvckNhbGxiYWNrID0geGhyLm9uZXJyb3IgPSB4aHIub250aW1lb3V0ID0gY2FsbGJhY2soICJlcnJvciIgKTsKCgkJCQkvLyBTdXBwb3J0OiBJRSA5IG9ubHkKCQkJCS8vIFVzZSBvbnJlYWR5c3RhdGVjaGFuZ2UgdG8gcmVwbGFjZSBvbmFib3J0CgkJCQkvLyB0byBoYW5kbGUgdW5jYXVnaHQgYWJvcnRzCgkJCQlpZiAoIHhoci5vbmFib3J0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJeGhyLm9uYWJvcnQgPSBlcnJvckNhbGxiYWNrOwoJCQkJfSBlbHNlIHsKCQkJCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgoJCQkJCQkvLyBDaGVjayByZWFkeVN0YXRlIGJlZm9yZSB0aW1lb3V0IGFzIGl0IGNoYW5nZXMKCQkJCQkJaWYgKCB4aHIucmVhZHlTdGF0ZSA9PT0gNCApIHsKCgkJCQkJCQkvLyBBbGxvdyBvbmVycm9yIHRvIGJlIGNhbGxlZCBmaXJzdCwKCQkJCQkJCS8vIGJ1dCB0aGF0IHdpbGwgbm90IGhhbmRsZSBhIG5hdGl2ZSBhYm9ydAoJCQkJCQkJLy8gQWxzbywgc2F2ZSBlcnJvckNhbGxiYWNrIHRvIGEgdmFyaWFibGUKCQkJCQkJCS8vIGFzIHhoci5vbmVycm9yIGNhbm5vdCBiZSBhY2Nlc3NlZAoJCQkJCQkJd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCQkJCWVycm9yQ2FsbGJhY2soKTsKCQkJCQkJCQl9CgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQl9OwoJCQkJfQoKCQkJCS8vIENyZWF0ZSB0aGUgYWJvcnQgY2FsbGJhY2sKCQkJCWNhbGxiYWNrID0gY2FsbGJhY2soICJhYm9ydCIgKTsKCgkJCQl0cnkgewoKCQkJCQkvLyBEbyBzZW5kIHRoZSByZXF1ZXN0ICh0aGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24pCgkJCQkJeGhyLnNlbmQoIG9wdGlvbnMuaGFzQ29udGVudCAmJiBvcHRpb25zLmRhdGEgfHwgbnVsbCApOwoJCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJCS8vICMxNDY4MzogT25seSByZXRocm93IGlmIHRoaXMgaGFzbid0IGJlZW4gbm90aWZpZWQgYXMgYW4gZXJyb3IgeWV0CgkJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQkJdGhyb3cgZTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhYm9ydDogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrKCk7CgkJCQl9CgkJCX0KCQl9OwoJfQp9ICk7CgoKCgovLyBQcmV2ZW50IGF1dG8tZXhlY3V0aW9uIG9mIHNjcmlwdHMgd2hlbiBubyBleHBsaWNpdCBkYXRhVHlwZSB3YXMgcHJvdmlkZWQgKFNlZSBnaC0yNDMyKQpqUXVlcnkuYWpheFByZWZpbHRlciggZnVuY3Rpb24oIHMgKSB7CglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgkJcy5jb250ZW50cy5zY3JpcHQgPSBmYWxzZTsKCX0KfSApOwoKLy8gSW5zdGFsbCBzY3JpcHQgZGF0YVR5cGUKalF1ZXJ5LmFqYXhTZXR1cCggewoJYWNjZXB0czogewoJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgIiArCgkJCSJhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiCgl9LAoJY29udGVudHM6IHsKCQlzY3JpcHQ6IC9cYig/OmphdmF8ZWNtYSlzY3JpcHRcYi8KCX0sCgljb252ZXJ0ZXJzOiB7CgkJInRleHQgc2NyaXB0IjogZnVuY3Rpb24oIHRleHQgKSB7CgkJCWpRdWVyeS5nbG9iYWxFdmFsKCB0ZXh0ICk7CgkJCXJldHVybiB0ZXh0OwoJCX0KCX0KfSApOwoKLy8gSGFuZGxlIGNhY2hlJ3Mgc3BlY2lhbCBjYXNlIGFuZCBjcm9zc0RvbWFpbgpqUXVlcnkuYWpheFByZWZpbHRlciggInNjcmlwdCIsIGZ1bmN0aW9uKCBzICkgewoJaWYgKCBzLmNhY2hlID09PSB1bmRlZmluZWQgKSB7CgkJcy5jYWNoZSA9IGZhbHNlOwoJfQoJaWYgKCBzLmNyb3NzRG9tYWluICkgewoJCXMudHlwZSA9ICJHRVQiOwoJfQp9ICk7CgovLyBCaW5kIHNjcmlwdCB0YWcgaGFjayB0cmFuc3BvcnQKalF1ZXJ5LmFqYXhUcmFuc3BvcnQoICJzY3JpcHQiLCBmdW5jdGlvbiggcyApIHsKCgkvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIG9yIGZvcmNlZC1ieS1hdHRycyByZXF1ZXN0cwoJaWYgKCBzLmNyb3NzRG9tYWluIHx8IHMuc2NyaXB0QXR0cnMgKSB7CgkJdmFyIHNjcmlwdCwgY2FsbGJhY2s7CgkJcmV0dXJuIHsKCQkJc2VuZDogZnVuY3Rpb24oIF8sIGNvbXBsZXRlICkgewoJCQkJc2NyaXB0ID0galF1ZXJ5KCAiPHNjcmlwdD4iICkKCQkJCQkuYXR0ciggcy5zY3JpcHRBdHRycyB8fCB7fSApCgkJCQkJLnByb3AoIHsgY2hhcnNldDogcy5zY3JpcHRDaGFyc2V0LCBzcmM6IHMudXJsIH0gKQoJCQkJCS5vbiggImxvYWQgZXJyb3IiLCBjYWxsYmFjayA9IGZ1bmN0aW9uKCBldnQgKSB7CgkJCQkJCXNjcmlwdC5yZW1vdmUoKTsKCQkJCQkJY2FsbGJhY2sgPSBudWxsOwoJCQkJCQlpZiAoIGV2dCApIHsKCQkJCQkJCWNvbXBsZXRlKCBldnQudHlwZSA9PT0gImVycm9yIiA/IDQwNCA6IDIwMCwgZXZ0LnR5cGUgKTsKCQkJCQkJfQoJCQkJCX0gKTsKCgkJCQkvLyBVc2UgbmF0aXZlIERPTSBtYW5pcHVsYXRpb24gdG8gYXZvaWQgb3VyIGRvbU1hbmlwIEFKQVggdHJpY2tlcnkKCQkJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoIHNjcmlwdFsgMCBdICk7CgkJCX0sCgkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2soKTsKCQkJCX0KCQkJfQoJCX07Cgl9Cn0gKTsKCgoKCnZhciBvbGRDYWxsYmFja3MgPSBbXSwKCXJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoIHsKCWpzb25wOiAiY2FsbGJhY2siLAoJanNvbnBDYWxsYmFjazogZnVuY3Rpb24oKSB7CgkJdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8ICggalF1ZXJ5LmV4cGFuZG8gKyAiXyIgKyAoIG5vbmNlKysgKSApOwoJCXRoaXNbIGNhbGxiYWNrIF0gPSB0cnVlOwoJCXJldHVybiBjYWxsYmFjazsKCX0KfSApOwoKLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAianNvbiBqc29ucCIsIGZ1bmN0aW9uKCBzLCBvcmlnaW5hbFNldHRpbmdzLCBqcVhIUiApIHsKCgl2YXIgY2FsbGJhY2tOYW1lLCBvdmVyd3JpdHRlbiwgcmVzcG9uc2VDb250YWluZXIsCgkJanNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAoIHJqc29ucC50ZXN0KCBzLnVybCApID8KCQkJInVybCIgOgoJCQl0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJgoJCQkJKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkKCQkJCQkuaW5kZXhPZiggImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIgKSA9PT0gMCAmJgoJCQkJcmpzb25wLnRlc3QoIHMuZGF0YSApICYmICJkYXRhIgoJCSk7CgoJLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQKCWlmICgganNvblByb3AgfHwgcy5kYXRhVHlwZXNbIDAgXSA9PT0gImpzb25wIiApIHsKCgkJLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAoJCWNhbGxiYWNrTmFtZSA9IHMuanNvbnBDYWxsYmFjayA9IGlzRnVuY3Rpb24oIHMuanNvbnBDYWxsYmFjayApID8KCQkJcy5qc29ucENhbGxiYWNrKCkgOgoJCQlzLmpzb25wQ2FsbGJhY2s7CgoJCS8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGEKCQlpZiAoIGpzb25Qcm9wICkgewoJCQlzWyBqc29uUHJvcCBdID0gc1sganNvblByb3AgXS5yZXBsYWNlKCByanNvbnAsICIkMSIgKyBjYWxsYmFja05hbWUgKTsKCQl9IGVsc2UgaWYgKCBzLmpzb25wICE9PSBmYWxzZSApIHsKCQkJcy51cmwgKz0gKCBycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgcy5qc29ucCArICI9IiArIGNhbGxiYWNrTmFtZTsKCQl9CgoJCS8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KCQlzLmNvbnZlcnRlcnNbICJzY3JpcHQganNvbiIgXSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsKCQkJCWpRdWVyeS5lcnJvciggY2FsbGJhY2tOYW1lICsgIiB3YXMgbm90IGNhbGxlZCIgKTsKCQkJfQoJCQlyZXR1cm4gcmVzcG9uc2VDb250YWluZXJbIDAgXTsKCQl9OwoKCQkvLyBGb3JjZSBqc29uIGRhdGFUeXBlCgkJcy5kYXRhVHlwZXNbIDAgXSA9ICJqc29uIjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFjawoJCW92ZXJ3cml0dGVuID0gd2luZG93WyBjYWxsYmFja05hbWUgXTsKCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gZnVuY3Rpb24oKSB7CgkJCXJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOwoJCX07CgoJCS8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQoJCWpxWEhSLmFsd2F5cyggZnVuY3Rpb24oKSB7CgoJCQkvLyBJZiBwcmV2aW91cyB2YWx1ZSBkaWRuJ3QgZXhpc3QgLSByZW1vdmUgaXQKCQkJaWYgKCBvdmVyd3JpdHRlbiA9PT0gdW5kZWZpbmVkICkgewoJCQkJalF1ZXJ5KCB3aW5kb3cgKS5yZW1vdmVQcm9wKCBjYWxsYmFja05hbWUgKTsKCgkJCS8vIE90aGVyd2lzZSByZXN0b3JlIHByZWV4aXN0aW5nIHZhbHVlCgkJCX0gZWxzZSB7CgkJCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gb3ZlcndyaXR0ZW47CgkJCX0KCgkJCS8vIFNhdmUgYmFjayBhcyBmcmVlCgkJCWlmICggc1sgY2FsbGJhY2tOYW1lIF0gKSB7CgoJCQkJLy8gTWFrZSBzdXJlIHRoYXQgcmUtdXNpbmcgdGhlIG9wdGlvbnMgZG9lc24ndCBzY3JldyB0aGluZ3MgYXJvdW5kCgkJCQlzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CgoJCQkJLy8gU2F2ZSB0aGUgY2FsbGJhY2sgbmFtZSBmb3IgZnV0dXJlIHVzZQoJCQkJb2xkQ2FsbGJhY2tzLnB1c2goIGNhbGxiYWNrTmFtZSApOwoJCQl9CgoJCQkvLyBDYWxsIGlmIGl0IHdhcyBhIGZ1bmN0aW9uIGFuZCB3ZSBoYXZlIGEgcmVzcG9uc2UKCQkJaWYgKCByZXNwb25zZUNvbnRhaW5lciAmJiBpc0Z1bmN0aW9uKCBvdmVyd3JpdHRlbiApICkgewoJCQkJb3ZlcndyaXR0ZW4oIHJlc3BvbnNlQ29udGFpbmVyWyAwIF0gKTsKCQkJfQoKCQkJcmVzcG9uc2VDb250YWluZXIgPSBvdmVyd3JpdHRlbiA9IHVuZGVmaW5lZDsKCQl9ICk7CgoJCS8vIERlbGVnYXRlIHRvIHNjcmlwdAoJCXJldHVybiAic2NyaXB0IjsKCX0KfSApOwoKCgoKLy8gU3VwcG9ydDogU2FmYXJpIDggb25seQovLyBJbiBTYWZhcmkgOCBkb2N1bWVudHMgY3JlYXRlZCB2aWEgZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50Ci8vIGNvbGxhcHNlIHNpYmxpbmcgZm9ybXM6IHRoZSBzZWNvbmQgb25lIGJlY29tZXMgYSBjaGlsZCBvZiB0aGUgZmlyc3Qgb25lLgovLyBCZWNhdXNlIG9mIHRoYXQsIHRoaXMgc2VjdXJpdHkgbWVhc3VyZSBoYXMgdG8gYmUgZGlzYWJsZWQgaW4gU2FmYXJpIDguCi8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0xMzczMzcKc3VwcG9ydC5jcmVhdGVIVE1MRG9jdW1lbnQgPSAoIGZ1bmN0aW9uKCkgewoJdmFyIGJvZHkgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoICIiICkuYm9keTsKCWJvZHkuaW5uZXJIVE1MID0gIjxmb3JtPjwvZm9ybT48Zm9ybT48L2Zvcm0+IjsKCXJldHVybiBib2R5LmNoaWxkTm9kZXMubGVuZ3RoID09PSAyOwp9ICkoKTsKCgovLyBBcmd1bWVudCAiZGF0YSIgc2hvdWxkIGJlIHN0cmluZyBvZiBodG1sCi8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwKLy8gZGVmYXVsdHMgdG8gZG9jdW1lbnQKLy8ga2VlcFNjcmlwdHMgKG9wdGlvbmFsKTogSWYgdHJ1ZSwgd2lsbCBpbmNsdWRlIHNjcmlwdHMgcGFzc2VkIGluIHRoZSBodG1sIHN0cmluZwpqUXVlcnkucGFyc2VIVE1MID0gZnVuY3Rpb24oIGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzICkgewoJaWYgKCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CgkJcmV0dXJuIFtdOwoJfQoJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewoJCWtlZXBTY3JpcHRzID0gY29udGV4dDsKCQljb250ZXh0ID0gZmFsc2U7Cgl9CgoJdmFyIGJhc2UsIHBhcnNlZCwgc2NyaXB0czsKCglpZiAoICFjb250ZXh0ICkgewoKCQkvLyBTdG9wIHNjcmlwdHMgb3IgaW5saW5lIGV2ZW50IGhhbmRsZXJzIGZyb20gYmVpbmcgZXhlY3V0ZWQgaW1tZWRpYXRlbHkKCQkvLyBieSB1c2luZyBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbgoJCWlmICggc3VwcG9ydC5jcmVhdGVIVE1MRG9jdW1lbnQgKSB7CgkJCWNvbnRleHQgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoICIiICk7CgoJCQkvLyBTZXQgdGhlIGJhc2UgaHJlZiBmb3IgdGhlIGNyZWF0ZWQgZG9jdW1lbnQKCQkJLy8gc28gYW55IHBhcnNlZCBlbGVtZW50cyB3aXRoIFVSTHMKCQkJLy8gYXJlIGJhc2VkIG9uIHRoZSBkb2N1bWVudCdzIFVSTCAoZ2gtMjk2NSkKCQkJYmFzZSA9IGNvbnRleHQuY3JlYXRlRWxlbWVudCggImJhc2UiICk7CgkJCWJhc2UuaHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CgkJCWNvbnRleHQuaGVhZC5hcHBlbmRDaGlsZCggYmFzZSApOwoJCX0gZWxzZSB7CgkJCWNvbnRleHQgPSBkb2N1bWVudDsKCQl9Cgl9CgoJcGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKCBkYXRhICk7CglzY3JpcHRzID0gIWtlZXBTY3JpcHRzICYmIFtdOwoKCS8vIFNpbmdsZSB0YWcKCWlmICggcGFyc2VkICkgewoJCXJldHVybiBbIGNvbnRleHQuY3JlYXRlRWxlbWVudCggcGFyc2VkWyAxIF0gKSBdOwoJfQoKCXBhcnNlZCA9IGJ1aWxkRnJhZ21lbnQoIFsgZGF0YSBdLCBjb250ZXh0LCBzY3JpcHRzICk7CgoJaWYgKCBzY3JpcHRzICYmIHNjcmlwdHMubGVuZ3RoICkgewoJCWpRdWVyeSggc2NyaXB0cyApLnJlbW92ZSgpOwoJfQoKCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBwYXJzZWQuY2hpbGROb2RlcyApOwp9OwoKCi8qKgogKiBMb2FkIGEgdXJsIGludG8gYSBwYWdlCiAqLwpqUXVlcnkuZm4ubG9hZCA9IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcywgY2FsbGJhY2sgKSB7Cgl2YXIgc2VsZWN0b3IsIHR5cGUsIHJlc3BvbnNlLAoJCXNlbGYgPSB0aGlzLAoJCW9mZiA9IHVybC5pbmRleE9mKCAiICIgKTsKCglpZiAoIG9mZiA+IC0xICkgewoJCXNlbGVjdG9yID0gc3RyaXBBbmRDb2xsYXBzZSggdXJsLnNsaWNlKCBvZmYgKSApOwoJCXVybCA9IHVybC5zbGljZSggMCwgb2ZmICk7Cgl9CgoJLy8gSWYgaXQncyBhIGZ1bmN0aW9uCglpZiAoIGlzRnVuY3Rpb24oIHBhcmFtcyApICkgewoKCQkvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawoJCWNhbGxiYWNrID0gcGFyYW1zOwoJCXBhcmFtcyA9IHVuZGVmaW5lZDsKCgkvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nCgl9IGVsc2UgaWYgKCBwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSB7CgkJdHlwZSA9ICJQT1NUIjsKCX0KCgkvLyBJZiB3ZSBoYXZlIGVsZW1lbnRzIHRvIG1vZGlmeSwgbWFrZSB0aGUgcmVxdWVzdAoJaWYgKCBzZWxmLmxlbmd0aCA+IDAgKSB7CgkJalF1ZXJ5LmFqYXgoIHsKCQkJdXJsOiB1cmwsCgoJCQkvLyBJZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQuCgkJCS8vIE1ha2UgdmFsdWUgb2YgdGhpcyBmaWVsZCBleHBsaWNpdCBzaW5jZQoJCQkvLyB1c2VyIGNhbiBvdmVycmlkZSBpdCB0aHJvdWdoIGFqYXhTZXR1cCBtZXRob2QKCQkJdHlwZTogdHlwZSB8fCAiR0VUIiwKCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJZGF0YTogcGFyYW1zCgkJfSApLmRvbmUoIGZ1bmN0aW9uKCByZXNwb25zZVRleHQgKSB7CgoJCQkvLyBTYXZlIHJlc3BvbnNlIGZvciB1c2UgaW4gY29tcGxldGUgY2FsbGJhY2sKCQkJcmVzcG9uc2UgPSBhcmd1bWVudHM7CgoJCQlzZWxmLmh0bWwoIHNlbGVjdG9yID8KCgkJCQkvLyBJZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQsIGxvY2F0ZSB0aGUgcmlnaHQgZWxlbWVudHMgaW4gYSBkdW1teSBkaXYKCQkJCS8vIEV4Y2x1ZGUgc2NyaXB0cyB0byBhdm9pZCBJRSAnUGVybWlzc2lvbiBEZW5pZWQnIGVycm9ycwoJCQkJalF1ZXJ5KCAiPGRpdj4iICkuYXBwZW5kKCBqUXVlcnkucGFyc2VIVE1MKCByZXNwb25zZVRleHQgKSApLmZpbmQoIHNlbGVjdG9yICkgOgoKCQkJCS8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CgkJCQlyZXNwb25zZVRleHQgKTsKCgkJLy8gSWYgdGhlIHJlcXVlc3Qgc3VjY2VlZHMsIHRoaXMgZnVuY3Rpb24gZ2V0cyAiZGF0YSIsICJzdGF0dXMiLCAianFYSFIiCgkJLy8gYnV0IHRoZXkgYXJlIGlnbm9yZWQgYmVjYXVzZSByZXNwb25zZSB3YXMgc2V0IGFib3ZlLgoJCS8vIElmIGl0IGZhaWxzLCB0aGlzIGZ1bmN0aW9uIGdldHMgImpxWEhSIiwgInN0YXR1cyIsICJlcnJvciIKCQl9ICkuYWx3YXlzKCBjYWxsYmFjayAmJiBmdW5jdGlvbigganFYSFIsIHN0YXR1cyApIHsKCQkJc2VsZi5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLCByZXNwb25zZSB8fCBbIGpxWEhSLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCBqcVhIUiBdICk7CgkJCX0gKTsKCQl9ICk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgoKCgovLyBBdHRhY2ggYSBidW5jaCBvZiBmdW5jdGlvbnMgZm9yIGhhbmRsaW5nIGNvbW1vbiBBSkFYIGV2ZW50cwpqUXVlcnkuZWFjaCggWwoJImFqYXhTdGFydCIsCgkiYWpheFN0b3AiLAoJImFqYXhDb21wbGV0ZSIsCgkiYWpheEVycm9yIiwKCSJhamF4U3VjY2VzcyIsCgkiYWpheFNlbmQiCl0sIGZ1bmN0aW9uKCBpLCB0eXBlICkgewoJalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGUsIGZuICk7Cgl9Owp9ICk7CgoKCgpqUXVlcnkuZXhwci5wc2V1ZG9zLmFuaW1hdGVkID0gZnVuY3Rpb24oIGVsZW0gKSB7CglyZXR1cm4galF1ZXJ5LmdyZXAoIGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKCX0gKS5sZW5ndGg7Cn07CgoKCgpqUXVlcnkub2Zmc2V0ID0gewoJc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKCQl2YXIgY3VyUG9zaXRpb24sIGN1ckxlZnQsIGN1ckNTU1RvcCwgY3VyVG9wLCBjdXJPZmZzZXQsIGN1ckNTU0xlZnQsIGNhbGN1bGF0ZVBvc2l0aW9uLAoJCQlwb3NpdGlvbiA9IGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKSwKCQkJY3VyRWxlbSA9IGpRdWVyeSggZWxlbSApLAoJCQlwcm9wcyA9IHt9OwoKCQkvLyBTZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCgkJaWYgKCBwb3NpdGlvbiA9PT0gInN0YXRpYyIgKSB7CgkJCWVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwoJCX0KCgkJY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKTsKCQljdXJDU1NUb3AgPSBqUXVlcnkuY3NzKCBlbGVtLCAidG9wIiApOwoJCWN1ckNTU0xlZnQgPSBqUXVlcnkuY3NzKCBlbGVtLCAibGVmdCIgKTsKCQljYWxjdWxhdGVQb3NpdGlvbiA9ICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSAmJgoJCQkoIGN1ckNTU1RvcCArIGN1ckNTU0xlZnQgKS5pbmRleE9mKCAiYXV0byIgKSA+IC0xOwoKCQkvLyBOZWVkIHRvIGJlIGFibGUgdG8gY2FsY3VsYXRlIHBvc2l0aW9uIGlmIGVpdGhlcgoJCS8vIHRvcCBvciBsZWZ0IGlzIGF1dG8gYW5kIHBvc2l0aW9uIGlzIGVpdGhlciBhYnNvbHV0ZSBvciBmaXhlZAoJCWlmICggY2FsY3VsYXRlUG9zaXRpb24gKSB7CgkJCWN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwoJCQljdXJUb3AgPSBjdXJQb3NpdGlvbi50b3A7CgkJCWN1ckxlZnQgPSBjdXJQb3NpdGlvbi5sZWZ0OwoKCQl9IGVsc2UgewoJCQljdXJUb3AgPSBwYXJzZUZsb2F0KCBjdXJDU1NUb3AgKSB8fCAwOwoJCQljdXJMZWZ0ID0gcGFyc2VGbG9hdCggY3VyQ1NTTGVmdCApIHx8IDA7CgkJfQoKCQlpZiAoIGlzRnVuY3Rpb24oIG9wdGlvbnMgKSApIHsKCgkJCS8vIFVzZSBqUXVlcnkuZXh0ZW5kIGhlcmUgdG8gYWxsb3cgbW9kaWZpY2F0aW9uIG9mIGNvb3JkaW5hdGVzIGFyZ3VtZW50IChnaC0xODQ4KQoJCQlvcHRpb25zID0gb3B0aW9ucy5jYWxsKCBlbGVtLCBpLCBqUXVlcnkuZXh0ZW5kKCB7fSwgY3VyT2Zmc2V0ICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy50b3AgIT0gbnVsbCApIHsKCQkJcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKCQl9CgkJaWYgKCBvcHRpb25zLmxlZnQgIT0gbnVsbCApIHsKCQkJcHJvcHMubGVmdCA9ICggb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKSArIGN1ckxlZnQ7CgkJfQoKCQlpZiAoICJ1c2luZyIgaW4gb3B0aW9ucyApIHsKCQkJb3B0aW9ucy51c2luZy5jYWxsKCBlbGVtLCBwcm9wcyApOwoKCQl9IGVsc2UgewoJCQljdXJFbGVtLmNzcyggcHJvcHMgKTsKCQl9Cgl9Cn07CgpqUXVlcnkuZm4uZXh0ZW5kKCB7CgoJLy8gb2Zmc2V0KCkgcmVsYXRlcyBhbiBlbGVtZW50J3MgYm9yZGVyIGJveCB0byB0aGUgZG9jdW1lbnQgb3JpZ2luCglvZmZzZXQ6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCQkvLyBQcmVzZXJ2ZSBjaGFpbmluZyBmb3Igc2V0dGVyCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQlyZXR1cm4gb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8KCQkJCXRoaXMgOgoJCQkJdGhpcy5lYWNoKCBmdW5jdGlvbiggaSApIHsKCQkJCQlqUXVlcnkub2Zmc2V0LnNldE9mZnNldCggdGhpcywgb3B0aW9ucywgaSApOwoJCQkJfSApOwoJCX0KCgkJdmFyIHJlY3QsIHdpbiwKCQkJZWxlbSA9IHRoaXNbIDAgXTsKCgkJaWYgKCAhZWxlbSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUmV0dXJuIHplcm9zIGZvciBkaXNjb25uZWN0ZWQgYW5kIGhpZGRlbiAoZGlzcGxheTogbm9uZSkgZWxlbWVudHMgKGdoLTIzMTApCgkJLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CgkJLy8gUnVubmluZyBnZXRCb3VuZGluZ0NsaWVudFJlY3Qgb24gYQoJCS8vIGRpc2Nvbm5lY3RlZCBub2RlIGluIElFIHRocm93cyBhbiBlcnJvcgoJCWlmICggIWVsZW0uZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGggKSB7CgkJCXJldHVybiB7IHRvcDogMCwgbGVmdDogMCB9OwoJCX0KCgkJLy8gR2V0IGRvY3VtZW50LXJlbGF0aXZlIHBvc2l0aW9uIGJ5IGFkZGluZyB2aWV3cG9ydCBzY3JvbGwgdG8gdmlld3BvcnQtcmVsYXRpdmUgZ0JDUgoJCXJlY3QgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoJCXdpbiA9IGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldzsKCQlyZXR1cm4gewoJCQl0b3A6IHJlY3QudG9wICsgd2luLnBhZ2VZT2Zmc2V0LAoJCQlsZWZ0OiByZWN0LmxlZnQgKyB3aW4ucGFnZVhPZmZzZXQKCQl9OwoJfSwKCgkvLyBwb3NpdGlvbigpIHJlbGF0ZXMgYW4gZWxlbWVudCdzIG1hcmdpbiBib3ggdG8gaXRzIG9mZnNldCBwYXJlbnQncyBwYWRkaW5nIGJveAoJLy8gVGhpcyBjb3JyZXNwb25kcyB0byB0aGUgYmVoYXZpb3Igb2YgQ1NTIGFic29sdXRlIHBvc2l0aW9uaW5nCglwb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpc1sgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgb2Zmc2V0UGFyZW50LCBvZmZzZXQsIGRvYywKCQkJZWxlbSA9IHRoaXNbIDAgXSwKCQkJcGFyZW50T2Zmc2V0ID0geyB0b3A6IDAsIGxlZnQ6IDAgfTsKCgkJLy8gcG9zaXRpb246Zml4ZWQgZWxlbWVudHMgYXJlIG9mZnNldCBmcm9tIHRoZSB2aWV3cG9ydCwgd2hpY2ggaXRzZWxmIGFsd2F5cyBoYXMgemVybyBvZmZzZXQKCQlpZiAoIGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKSA9PT0gImZpeGVkIiApIHsKCgkJCS8vIEFzc3VtZSBwb3NpdGlvbjpmaXhlZCBpbXBsaWVzIGF2YWlsYWJpbGl0eSBvZiBnZXRCb3VuZGluZ0NsaWVudFJlY3QKCQkJb2Zmc2V0ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCgkJfSBlbHNlIHsKCQkJb2Zmc2V0ID0gdGhpcy5vZmZzZXQoKTsKCgkJCS8vIEFjY291bnQgZm9yIHRoZSAqcmVhbCogb2Zmc2V0IHBhcmVudCwgd2hpY2ggY2FuIGJlIHRoZSBkb2N1bWVudCBvciBpdHMgcm9vdCBlbGVtZW50CgkJCS8vIHdoZW4gYSBzdGF0aWNhbGx5IHBvc2l0aW9uZWQgZWxlbWVudCBpcyBpZGVudGlmaWVkCgkJCWRvYyA9IGVsZW0ub3duZXJEb2N1bWVudDsKCQkJb2Zmc2V0UGFyZW50ID0gZWxlbS5vZmZzZXRQYXJlbnQgfHwgZG9jLmRvY3VtZW50RWxlbWVudDsKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYKCQkJCSggb2Zmc2V0UGFyZW50ID09PSBkb2MuYm9keSB8fCBvZmZzZXRQYXJlbnQgPT09IGRvYy5kb2N1bWVudEVsZW1lbnQgKSAmJgoJCQkJalF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50LCAicG9zaXRpb24iICkgPT09ICJzdGF0aWMiICkgewoKCQkJCW9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5wYXJlbnROb2RlOwoJCQl9CgkJCWlmICggb2Zmc2V0UGFyZW50ICYmIG9mZnNldFBhcmVudCAhPT0gZWxlbSAmJiBvZmZzZXRQYXJlbnQubm9kZVR5cGUgPT09IDEgKSB7CgoJCQkJLy8gSW5jb3Jwb3JhdGUgYm9yZGVycyBpbnRvIGl0cyBvZmZzZXQsIHNpbmNlIHRoZXkgYXJlIG91dHNpZGUgaXRzIGNvbnRlbnQgb3JpZ2luCgkJCQlwYXJlbnRPZmZzZXQgPSBqUXVlcnkoIG9mZnNldFBhcmVudCApLm9mZnNldCgpOwoJCQkJcGFyZW50T2Zmc2V0LnRvcCArPSBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJib3JkZXJUb3BXaWR0aCIsIHRydWUgKTsKCQkJCXBhcmVudE9mZnNldC5sZWZ0ICs9IGpRdWVyeS5jc3MoIG9mZnNldFBhcmVudCwgImJvcmRlckxlZnRXaWR0aCIsIHRydWUgKTsKCQkJfQoJCX0KCgkJLy8gU3VidHJhY3QgcGFyZW50IG9mZnNldHMgYW5kIGVsZW1lbnQgbWFyZ2lucwoJCXJldHVybiB7CgkJCXRvcDogb2Zmc2V0LnRvcCAtIHBhcmVudE9mZnNldC50b3AgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luVG9wIiwgdHJ1ZSApLAoJCQlsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0IC0galF1ZXJ5LmNzcyggZWxlbSwgIm1hcmdpbkxlZnQiLCB0cnVlICkKCQl9OwoJfSwKCgkvLyBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBkb2N1bWVudEVsZW1lbnQgaW4gdGhlIGZvbGxvd2luZyBjYXNlczoKCS8vIDEpIEZvciB0aGUgZWxlbWVudCBpbnNpZGUgdGhlIGlmcmFtZSB3aXRob3V0IG9mZnNldFBhcmVudCwgdGhpcyBtZXRob2Qgd2lsbCByZXR1cm4KCS8vICAgIGRvY3VtZW50RWxlbWVudCBvZiB0aGUgcGFyZW50IHdpbmRvdwoJLy8gMikgRm9yIHRoZSBoaWRkZW4gb3IgZGV0YWNoZWQgZWxlbWVudAoJLy8gMykgRm9yIGJvZHkgb3IgaHRtbCBlbGVtZW50LCBpLmUuIGluIGNhc2Ugb2YgdGhlIGh0bWwgbm9kZSAtIGl0IHdpbGwgcmV0dXJuIGl0c2VsZgoJLy8KCS8vIGJ1dCB0aG9zZSBleGNlcHRpb25zIHdlcmUgbmV2ZXIgcHJlc2VudGVkIGFzIGEgcmVhbCBsaWZlIHVzZS1jYXNlcwoJLy8gYW5kIG1pZ2h0IGJlIGNvbnNpZGVyZWQgYXMgbW9yZSBwcmVmZXJhYmxlIHJlc3VsdHMuCgkvLwoJLy8gVGhpcyBsb2dpYywgaG93ZXZlciwgaXMgbm90IGd1YXJhbnRlZWQgYW5kIGNhbiBjaGFuZ2UgYXQgYW55IHBvaW50IGluIHRoZSBmdXR1cmUKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50OwoKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYgalF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50LCAicG9zaXRpb24iICkgPT09ICJzdGF0aWMiICkgewoJCQkJb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKCQkJfQoKCQkJcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2N1bWVudEVsZW1lbnQ7CgkJfSApOwoJfQp9ICk7CgovLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHsgc2Nyb2xsTGVmdDogInBhZ2VYT2Zmc2V0Iiwgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIHByb3AgKSB7Cgl2YXIgdG9wID0gInBhZ2VZT2Zmc2V0IiA9PT0gcHJvcDsKCglqUXVlcnkuZm5bIG1ldGhvZCBdID0gZnVuY3Rpb24oIHZhbCApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgbWV0aG9kLCB2YWwgKSB7CgoJCQkvLyBDb2FsZXNjZSBkb2N1bWVudHMgYW5kIHdpbmRvd3MKCQkJdmFyIHdpbjsKCQkJaWYgKCBpc1dpbmRvdyggZWxlbSApICkgewoJCQkJd2luID0gZWxlbTsKCQkJfSBlbHNlIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCXdpbiA9IGVsZW0uZGVmYXVsdFZpZXc7CgkJCX0KCgkJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gd2luID8gd2luWyBwcm9wIF0gOiBlbGVtWyBtZXRob2QgXTsKCQkJfQoKCQkJaWYgKCB3aW4gKSB7CgkJCQl3aW4uc2Nyb2xsVG8oCgkJCQkJIXRvcCA/IHZhbCA6IHdpbi5wYWdlWE9mZnNldCwKCQkJCQl0b3AgPyB2YWwgOiB3aW4ucGFnZVlPZmZzZXQKCQkJCSk7CgoJCQl9IGVsc2UgewoJCQkJZWxlbVsgbWV0aG9kIF0gPSB2YWw7CgkJCX0KCQl9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCApOwoJfTsKfSApOwoKLy8gU3VwcG9ydDogU2FmYXJpIDw9NyAtIDkuMSwgQ2hyb21lIDw9MzcgLSA0OQovLyBBZGQgdGhlIHRvcC9sZWZ0IGNzc0hvb2tzIHVzaW5nIGpRdWVyeS5mbi5wb3NpdGlvbgovLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQKLy8gQmxpbmsgYnVnOiBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD01ODkzNDcKLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodDsKLy8gcmF0aGVyIHRoYW4gbWFrZSB0aGUgY3NzIG1vZHVsZSBkZXBlbmQgb24gdGhlIG9mZnNldCBtb2R1bGUsIGp1c3QgY2hlY2sgZm9yIGl0IGhlcmUKalF1ZXJ5LmVhY2goIFsgInRvcCIsICJsZWZ0IiBdLCBmdW5jdGlvbiggaSwgcHJvcCApIHsKCWpRdWVyeS5jc3NIb29rc1sgcHJvcCBdID0gYWRkR2V0SG9va0lmKCBzdXBwb3J0LnBpeGVsUG9zaXRpb24sCgkJZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQlpZiAoIGNvbXB1dGVkICkgewoJCQkJY29tcHV0ZWQgPSBjdXJDU1MoIGVsZW0sIHByb3AgKTsKCgkJCQkvLyBJZiBjdXJDU1MgcmV0dXJucyBwZXJjZW50YWdlLCBmYWxsYmFjayB0byBvZmZzZXQKCQkJCXJldHVybiBybnVtbm9ucHgudGVzdCggY29tcHV0ZWQgKSA/CgkJCQkJalF1ZXJ5KCBlbGVtICkucG9zaXRpb24oKVsgcHJvcCBdICsgInB4IiA6CgkJCQkJY29tcHV0ZWQ7CgkJCX0KCQl9CgkpOwp9ICk7CgoKLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7IEhlaWdodDogImhlaWdodCIsIFdpZHRoOiAid2lkdGgiIH0sIGZ1bmN0aW9uKCBuYW1lLCB0eXBlICkgewoJalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LAoJCWZ1bmN0aW9uKCBkZWZhdWx0RXh0cmEsIGZ1bmNOYW1lICkgewoKCQkvLyBNYXJnaW4gaXMgb25seSBmb3Igb3V0ZXJIZWlnaHQsIG91dGVyV2lkdGgKCQlqUXVlcnkuZm5bIGZ1bmNOYW1lIF0gPSBmdW5jdGlvbiggbWFyZ2luLCB2YWx1ZSApIHsKCQkJdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKCBkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gImJvb2xlYW4iICksCgkJCQlleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAoIG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICJtYXJnaW4iIDogImJvcmRlciIgKTsKCgkJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCB2YWx1ZSApIHsKCQkJCXZhciBkb2M7CgoJCQkJaWYgKCBpc1dpbmRvdyggZWxlbSApICkgewoKCQkJCQkvLyAkKCB3aW5kb3cgKS5vdXRlcldpZHRoL0hlaWdodCByZXR1cm4gdy9oIGluY2x1ZGluZyBzY3JvbGxiYXJzIChnaC0xNzI5KQoJCQkJCXJldHVybiBmdW5jTmFtZS5pbmRleE9mKCAib3V0ZXIiICkgPT09IDAgPwoJCQkJCQllbGVtWyAiaW5uZXIiICsgbmFtZSBdIDoKCQkJCQkJZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbICJjbGllbnQiICsgbmFtZSBdOwoJCQkJfQoKCQkJCS8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCQlkb2MgPSBlbGVtLmRvY3VtZW50RWxlbWVudDsKCgkJCQkJLy8gRWl0aGVyIHNjcm9sbFtXaWR0aC9IZWlnaHRdIG9yIG9mZnNldFtXaWR0aC9IZWlnaHRdIG9yIGNsaWVudFtXaWR0aC9IZWlnaHRdLAoJCQkJCS8vIHdoaWNoZXZlciBpcyBncmVhdGVzdAoJCQkJCXJldHVybiBNYXRoLm1heCgKCQkJCQkJZWxlbS5ib2R5WyAic2Nyb2xsIiArIG5hbWUgXSwgZG9jWyAic2Nyb2xsIiArIG5hbWUgXSwKCQkJCQkJZWxlbS5ib2R5WyAib2Zmc2V0IiArIG5hbWUgXSwgZG9jWyAib2Zmc2V0IiArIG5hbWUgXSwKCQkJCQkJZG9jWyAiY2xpZW50IiArIG5hbWUgXQoJCQkJCSk7CgkJCQl9CgoJCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoKCQkJCQkvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50LCByZXF1ZXN0aW5nIGJ1dCBub3QgZm9yY2luZyBwYXJzZUZsb2F0CgkJCQkJalF1ZXJ5LmNzcyggZWxlbSwgdHlwZSwgZXh0cmEgKSA6CgoJCQkJCS8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKCQkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHR5cGUsIHZhbHVlLCBleHRyYSApOwoJCQl9LCB0eXBlLCBjaGFpbmFibGUgPyBtYXJnaW4gOiB1bmRlZmluZWQsIGNoYWluYWJsZSApOwoJCX07Cgl9ICk7Cn0gKTsKCgpqUXVlcnkuZWFjaCggKCAiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IHJlc2l6ZSBzY3JvbGwgY2xpY2sgZGJsY2xpY2sgIiArCgkibW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZWVudGVyIG1vdXNlbGVhdmUgIiArCgkiY2hhbmdlIHNlbGVjdCBzdWJtaXQga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBjb250ZXh0bWVudSIgKS5zcGxpdCggIiAiICksCglmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkvLyBIYW5kbGUgZXZlbnQgYmluZGluZwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZGF0YSwgZm4gKSB7CgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8KCQkJdGhpcy5vbiggbmFtZSwgbnVsbCwgZGF0YSwgZm4gKSA6CgkJCXRoaXMudHJpZ2dlciggbmFtZSApOwoJfTsKfSApOwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJaG92ZXI6IGZ1bmN0aW9uKCBmbk92ZXIsIGZuT3V0ICkgewoJCXJldHVybiB0aGlzLm1vdXNlZW50ZXIoIGZuT3ZlciApLm1vdXNlbGVhdmUoIGZuT3V0IHx8IGZuT3ZlciApOwoJfQp9ICk7CgoKCgpqUXVlcnkuZm4uZXh0ZW5kKCB7CgoJYmluZDogZnVuY3Rpb24oIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIG51bGwsIGRhdGEsIGZuICk7Cgl9LAoJdW5iaW5kOiBmdW5jdGlvbiggdHlwZXMsIGZuICkgewoJCXJldHVybiB0aGlzLm9mZiggdHlwZXMsIG51bGwsIGZuICk7Cgl9LAoKCWRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOwoJfSwKCXVuZGVsZWdhdGU6IGZ1bmN0aW9uKCBzZWxlY3RvciwgdHlwZXMsIGZuICkgewoKCQkvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPwoJCQl0aGlzLm9mZiggc2VsZWN0b3IsICIqKiIgKSA6CgkJCXRoaXMub2ZmKCB0eXBlcywgc2VsZWN0b3IgfHwgIioqIiwgZm4gKTsKCX0KfSApOwoKLy8gQmluZCBhIGZ1bmN0aW9uIHRvIGEgY29udGV4dCwgb3B0aW9uYWxseSBwYXJ0aWFsbHkgYXBwbHlpbmcgYW55Ci8vIGFyZ3VtZW50cy4KLy8galF1ZXJ5LnByb3h5IGlzIGRlcHJlY2F0ZWQgdG8gcHJvbW90ZSBzdGFuZGFyZHMgKHNwZWNpZmljYWxseSBGdW5jdGlvbiNiaW5kKQovLyBIb3dldmVyLCBpdCBpcyBub3Qgc2xhdGVkIGZvciByZW1vdmFsIGFueSB0aW1lIHNvb24KalF1ZXJ5LnByb3h5ID0gZnVuY3Rpb24oIGZuLCBjb250ZXh0ICkgewoJdmFyIHRtcCwgYXJncywgcHJveHk7CgoJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gInN0cmluZyIgKSB7CgkJdG1wID0gZm5bIGNvbnRleHQgXTsKCQljb250ZXh0ID0gZm47CgkJZm4gPSB0bXA7Cgl9CgoJLy8gUXVpY2sgY2hlY2sgdG8gZGV0ZXJtaW5lIGlmIHRhcmdldCBpcyBjYWxsYWJsZSwgaW4gdGhlIHNwZWMKCS8vIHRoaXMgdGhyb3dzIGEgVHlwZUVycm9yLCBidXQgd2Ugd2lsbCBqdXN0IHJldHVybiB1bmRlZmluZWQuCglpZiAoICFpc0Z1bmN0aW9uKCBmbiApICkgewoJCXJldHVybiB1bmRlZmluZWQ7Cgl9CgoJLy8gU2ltdWxhdGVkIGJpbmQKCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsKCXByb3h5ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGZuLmFwcGx5KCBjb250ZXh0IHx8IHRoaXMsIGFyZ3MuY29uY2F0KCBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSApICk7Cgl9OwoKCS8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAoJcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CgoJcmV0dXJuIHByb3h5Owp9OwoKalF1ZXJ5LmhvbGRSZWFkeSA9IGZ1bmN0aW9uKCBob2xkICkgewoJaWYgKCBob2xkICkgewoJCWpRdWVyeS5yZWFkeVdhaXQrKzsKCX0gZWxzZSB7CgkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7Cgl9Cn07CmpRdWVyeS5pc0FycmF5ID0gQXJyYXkuaXNBcnJheTsKalF1ZXJ5LnBhcnNlSlNPTiA9IEpTT04ucGFyc2U7CmpRdWVyeS5ub2RlTmFtZSA9IG5vZGVOYW1lOwpqUXVlcnkuaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CmpRdWVyeS5pc1dpbmRvdyA9IGlzV2luZG93OwpqUXVlcnkuY2FtZWxDYXNlID0gY2FtZWxDYXNlOwpqUXVlcnkudHlwZSA9IHRvVHlwZTsKCmpRdWVyeS5ub3cgPSBEYXRlLm5vdzsKCmpRdWVyeS5pc051bWVyaWMgPSBmdW5jdGlvbiggb2JqICkgewoKCS8vIEFzIG9mIGpRdWVyeSAzLjAsIGlzTnVtZXJpYyBpcyBsaW1pdGVkIHRvCgkvLyBzdHJpbmdzIGFuZCBudW1iZXJzIChwcmltaXRpdmVzIG9yIG9iamVjdHMpCgkvLyB0aGF0IGNhbiBiZSBjb2VyY2VkIHRvIGZpbml0ZSBudW1iZXJzIChnaC0yNjYyKQoJdmFyIHR5cGUgPSBqUXVlcnkudHlwZSggb2JqICk7CglyZXR1cm4gKCB0eXBlID09PSAibnVtYmVyIiB8fCB0eXBlID09PSAic3RyaW5nIiApICYmCgoJCS8vIHBhcnNlRmxvYXQgTmFOcyBudW1lcmljLWNhc3QgZmFsc2UgcG9zaXRpdmVzICgiIikKCQkvLyAuLi5idXQgbWlzaW50ZXJwcmV0cyBsZWFkaW5nLW51bWJlciBzdHJpbmdzLCBwYXJ0aWN1bGFybHkgaGV4IGxpdGVyYWxzICgiMHguLi4iKQoJCS8vIHN1YnRyYWN0aW9uIGZvcmNlcyBpbmZpbml0aWVzIHRvIE5hTgoJCSFpc05hTiggb2JqIC0gcGFyc2VGbG9hdCggb2JqICkgKTsKfTsKCgoKCi8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgQU1EIG1vZHVsZSwgc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlcgovLyBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLCBidXQgbm90IHZpYSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0Ci8vIHVuZGVyc3RhbmRzIGFub255bW91cyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdAovLyB3YXkgdG8gcmVnaXN0ZXIuIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlCi8vIGRlcml2ZWQgZnJvbSBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZQovLyBmaWxlIG5hbWUuIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMKLy8gdG8gY2FsbCBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgoKLy8gTm90ZSB0aGF0IGZvciBtYXhpbXVtIHBvcnRhYmlsaXR5LCBsaWJyYXJpZXMgdGhhdCBhcmUgbm90IGpRdWVyeSBzaG91bGQKLy8gZGVjbGFyZSB0aGVtc2VsdmVzIGFzIGFub255bW91cyBtb2R1bGVzLCBhbmQgYXZvaWQgc2V0dGluZyBhIGdsb2JhbCBpZiBhbgovLyBBTUQgbG9hZGVyIGlzIHByZXNlbnQuIGpRdWVyeSBpcyBhIHNwZWNpYWwgY2FzZS4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZQovLyBodHRwczovL2dpdGh1Yi5jb20vanJidXJrZS9yZXF1aXJlanMvd2lraS9VcGRhdGluZy1leGlzdGluZy1saWJyYXJpZXMjd2lraS1hbm9uCgppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCWRlZmluZSggImpxdWVyeSIsIFtdLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5OwoJfSApOwp9CgoKCgp2YXIKCgkvLyBNYXAgb3ZlciBqUXVlcnkgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV9qUXVlcnkgPSB3aW5kb3cualF1ZXJ5LAoKCS8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCglfJCA9IHdpbmRvdy4kOwoKalF1ZXJ5Lm5vQ29uZmxpY3QgPSBmdW5jdGlvbiggZGVlcCApIHsKCWlmICggd2luZG93LiQgPT09IGpRdWVyeSApIHsKCQl3aW5kb3cuJCA9IF8kOwoJfQoKCWlmICggZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkgKSB7CgkJd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7Cgl9CgoJcmV0dXJuIGpRdWVyeTsKfTsKCi8vIEV4cG9zZSBqUXVlcnkgYW5kICQgaWRlbnRpZmllcnMsIGV2ZW4gaW4gQU1ECi8vICgjNzEwMiNjb21tZW50OjEwLCBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzU1NykKLy8gYW5kIENvbW1vbkpTIGZvciBicm93c2VyIGVtdWxhdG9ycyAoIzEzNTY2KQppZiAoICFub0dsb2JhbCApIHsKCXdpbmRvdy5qUXVlcnkgPSB3aW5kb3cuJCA9IGpRdWVyeTsKfQoKCgoKcmV0dXJuIGpRdWVyeTsKfSApOwo=',
  /* lodash-4.17.15 */ 'LyoqCiAqIEBsaWNlbnNlCiAqIExvZGFzaCA8aHR0cHM6Ly9sb2Rhc2guY29tLz4KICogQ29weXJpZ2h0IE9wZW5KUyBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMgPGh0dHBzOi8vb3BlbmpzZi5vcmcvPgogKiBSZWxlYXNlZCB1bmRlciBNSVQgbGljZW5zZSA8aHR0cHM6Ly9sb2Rhc2guY29tL2xpY2Vuc2U+CiAqIEJhc2VkIG9uIFVuZGVyc2NvcmUuanMgMS44LjMgPGh0dHA6Ly91bmRlcnNjb3JlanMub3JnL0xJQ0VOU0U+CiAqIENvcHlyaWdodCBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwogKi8KOyhmdW5jdGlvbigpIHsKCiAgLyoqIFVzZWQgYXMgYSBzYWZlIHJlZmVyZW5jZSBmb3IgYHVuZGVmaW5lZGAgaW4gcHJlLUVTNSBlbnZpcm9ubWVudHMuICovCiAgdmFyIHVuZGVmaW5lZDsKCiAgLyoqIFVzZWQgYXMgdGhlIHNlbWFudGljIHZlcnNpb24gbnVtYmVyLiAqLwogIHZhciBWRVJTSU9OID0gJzQuMTcuMTUnOwoKICAvKiogVXNlZCBhcyB0aGUgc2l6ZSB0byBlbmFibGUgbGFyZ2UgYXJyYXkgb3B0aW1pemF0aW9ucy4gKi8KICB2YXIgTEFSR0VfQVJSQVlfU0laRSA9IDIwMDsKCiAgLyoqIEVycm9yIG1lc3NhZ2UgY29uc3RhbnRzLiAqLwogIHZhciBDT1JFX0VSUk9SX1RFWFQgPSAnVW5zdXBwb3J0ZWQgY29yZS1qcyB1c2UuIFRyeSBodHRwczovL25wbXMuaW8vc2VhcmNoP3E9cG9ueWZpbGwuJywKICAgICAgRlVOQ19FUlJPUl9URVhUID0gJ0V4cGVjdGVkIGEgZnVuY3Rpb24nOwoKICAvKiogVXNlZCB0byBzdGFuZC1pbiBmb3IgYHVuZGVmaW5lZGAgaGFzaCB2YWx1ZXMuICovCiAgdmFyIEhBU0hfVU5ERUZJTkVEID0gJ19fbG9kYXNoX2hhc2hfdW5kZWZpbmVkX18nOwoKICAvKiogVXNlZCBhcyB0aGUgbWF4aW11bSBtZW1vaXplIGNhY2hlIHNpemUuICovCiAgdmFyIE1BWF9NRU1PSVpFX1NJWkUgPSA1MDA7CgogIC8qKiBVc2VkIGFzIHRoZSBpbnRlcm5hbCBhcmd1bWVudCBwbGFjZWhvbGRlci4gKi8KICB2YXIgUExBQ0VIT0xERVIgPSAnX19sb2Rhc2hfcGxhY2Vob2xkZXJfXyc7CgogIC8qKiBVc2VkIHRvIGNvbXBvc2UgYml0bWFza3MgZm9yIGNsb25pbmcuICovCiAgdmFyIENMT05FX0RFRVBfRkxBRyA9IDEsCiAgICAgIENMT05FX0ZMQVRfRkxBRyA9IDIsCiAgICAgIENMT05FX1NZTUJPTFNfRkxBRyA9IDQ7CgogIC8qKiBVc2VkIHRvIGNvbXBvc2UgYml0bWFza3MgZm9yIHZhbHVlIGNvbXBhcmlzb25zLiAqLwogIHZhciBDT01QQVJFX1BBUlRJQUxfRkxBRyA9IDEsCiAgICAgIENPTVBBUkVfVU5PUkRFUkVEX0ZMQUcgPSAyOwoKICAvKiogVXNlZCB0byBjb21wb3NlIGJpdG1hc2tzIGZvciBmdW5jdGlvbiBtZXRhZGF0YS4gKi8KICB2YXIgV1JBUF9CSU5EX0ZMQUcgPSAxLAogICAgICBXUkFQX0JJTkRfS0VZX0ZMQUcgPSAyLAogICAgICBXUkFQX0NVUlJZX0JPVU5EX0ZMQUcgPSA0LAogICAgICBXUkFQX0NVUlJZX0ZMQUcgPSA4LAogICAgICBXUkFQX0NVUlJZX1JJR0hUX0ZMQUcgPSAxNiwKICAgICAgV1JBUF9QQVJUSUFMX0ZMQUcgPSAzMiwKICAgICAgV1JBUF9QQVJUSUFMX1JJR0hUX0ZMQUcgPSA2NCwKICAgICAgV1JBUF9BUllfRkxBRyA9IDEyOCwKICAgICAgV1JBUF9SRUFSR19GTEFHID0gMjU2LAogICAgICBXUkFQX0ZMSVBfRkxBRyA9IDUxMjsKCiAgLyoqIFVzZWQgYXMgZGVmYXVsdCBvcHRpb25zIGZvciBgXy50cnVuY2F0ZWAuICovCiAgdmFyIERFRkFVTFRfVFJVTkNfTEVOR1RIID0gMzAsCiAgICAgIERFRkFVTFRfVFJVTkNfT01JU1NJT04gPSAnLi4uJzsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0IGhvdCBmdW5jdGlvbnMgYnkgbnVtYmVyIG9mIGNhbGxzIHdpdGhpbiBhIHNwYW4gb2YgbWlsbGlzZWNvbmRzLiAqLwogIHZhciBIT1RfQ09VTlQgPSA4MDAsCiAgICAgIEhPVF9TUEFOID0gMTY7CgogIC8qKiBVc2VkIHRvIGluZGljYXRlIHRoZSB0eXBlIG9mIGxhenkgaXRlcmF0ZWVzLiAqLwogIHZhciBMQVpZX0ZJTFRFUl9GTEFHID0gMSwKICAgICAgTEFaWV9NQVBfRkxBRyA9IDIsCiAgICAgIExBWllfV0hJTEVfRkxBRyA9IDM7CgogIC8qKiBVc2VkIGFzIHJlZmVyZW5jZXMgZm9yIHZhcmlvdXMgYE51bWJlcmAgY29uc3RhbnRzLiAqLwogIHZhciBJTkZJTklUWSA9IDEgLyAwLAogICAgICBNQVhfU0FGRV9JTlRFR0VSID0gOTAwNzE5OTI1NDc0MDk5MSwKICAgICAgTUFYX0lOVEVHRVIgPSAxLjc5NzY5MzEzNDg2MjMxNTdlKzMwOCwKICAgICAgTkFOID0gMCAvIDA7CgogIC8qKiBVc2VkIGFzIHJlZmVyZW5jZXMgZm9yIHRoZSBtYXhpbXVtIGxlbmd0aCBhbmQgaW5kZXggb2YgYW4gYXJyYXkuICovCiAgdmFyIE1BWF9BUlJBWV9MRU5HVEggPSA0Mjk0OTY3Mjk1LAogICAgICBNQVhfQVJSQVlfSU5ERVggPSBNQVhfQVJSQVlfTEVOR1RIIC0gMSwKICAgICAgSEFMRl9NQVhfQVJSQVlfTEVOR1RIID0gTUFYX0FSUkFZX0xFTkdUSCA+Pj4gMTsKCiAgLyoqIFVzZWQgdG8gYXNzb2NpYXRlIHdyYXAgbWV0aG9kcyB3aXRoIHRoZWlyIGJpdCBmbGFncy4gKi8KICB2YXIgd3JhcEZsYWdzID0gWwogICAgWydhcnknLCBXUkFQX0FSWV9GTEFHXSwKICAgIFsnYmluZCcsIFdSQVBfQklORF9GTEFHXSwKICAgIFsnYmluZEtleScsIFdSQVBfQklORF9LRVlfRkxBR10sCiAgICBbJ2N1cnJ5JywgV1JBUF9DVVJSWV9GTEFHXSwKICAgIFsnY3VycnlSaWdodCcsIFdSQVBfQ1VSUllfUklHSFRfRkxBR10sCiAgICBbJ2ZsaXAnLCBXUkFQX0ZMSVBfRkxBR10sCiAgICBbJ3BhcnRpYWwnLCBXUkFQX1BBUlRJQUxfRkxBR10sCiAgICBbJ3BhcnRpYWxSaWdodCcsIFdSQVBfUEFSVElBTF9SSUdIVF9GTEFHXSwKICAgIFsncmVhcmcnLCBXUkFQX1JFQVJHX0ZMQUddCiAgXTsKCiAgLyoqIGBPYmplY3QjdG9TdHJpbmdgIHJlc3VsdCByZWZlcmVuY2VzLiAqLwogIHZhciBhcmdzVGFnID0gJ1tvYmplY3QgQXJndW1lbnRzXScsCiAgICAgIGFycmF5VGFnID0gJ1tvYmplY3QgQXJyYXldJywKICAgICAgYXN5bmNUYWcgPSAnW29iamVjdCBBc3luY0Z1bmN0aW9uXScsCiAgICAgIGJvb2xUYWcgPSAnW29iamVjdCBCb29sZWFuXScsCiAgICAgIGRhdGVUYWcgPSAnW29iamVjdCBEYXRlXScsCiAgICAgIGRvbUV4Y1RhZyA9ICdbb2JqZWN0IERPTUV4Y2VwdGlvbl0nLAogICAgICBlcnJvclRhZyA9ICdbb2JqZWN0IEVycm9yXScsCiAgICAgIGZ1bmNUYWcgPSAnW29iamVjdCBGdW5jdGlvbl0nLAogICAgICBnZW5UYWcgPSAnW29iamVjdCBHZW5lcmF0b3JGdW5jdGlvbl0nLAogICAgICBtYXBUYWcgPSAnW29iamVjdCBNYXBdJywKICAgICAgbnVtYmVyVGFnID0gJ1tvYmplY3QgTnVtYmVyXScsCiAgICAgIG51bGxUYWcgPSAnW29iamVjdCBOdWxsXScsCiAgICAgIG9iamVjdFRhZyA9ICdbb2JqZWN0IE9iamVjdF0nLAogICAgICBwcm9taXNlVGFnID0gJ1tvYmplY3QgUHJvbWlzZV0nLAogICAgICBwcm94eVRhZyA9ICdbb2JqZWN0IFByb3h5XScsCiAgICAgIHJlZ2V4cFRhZyA9ICdbb2JqZWN0IFJlZ0V4cF0nLAogICAgICBzZXRUYWcgPSAnW29iamVjdCBTZXRdJywKICAgICAgc3RyaW5nVGFnID0gJ1tvYmplY3QgU3RyaW5nXScsCiAgICAgIHN5bWJvbFRhZyA9ICdbb2JqZWN0IFN5bWJvbF0nLAogICAgICB1bmRlZmluZWRUYWcgPSAnW29iamVjdCBVbmRlZmluZWRdJywKICAgICAgd2Vha01hcFRhZyA9ICdbb2JqZWN0IFdlYWtNYXBdJywKICAgICAgd2Vha1NldFRhZyA9ICdbb2JqZWN0IFdlYWtTZXRdJzsKCiAgdmFyIGFycmF5QnVmZmVyVGFnID0gJ1tvYmplY3QgQXJyYXlCdWZmZXJdJywKICAgICAgZGF0YVZpZXdUYWcgPSAnW29iamVjdCBEYXRhVmlld10nLAogICAgICBmbG9hdDMyVGFnID0gJ1tvYmplY3QgRmxvYXQzMkFycmF5XScsCiAgICAgIGZsb2F0NjRUYWcgPSAnW29iamVjdCBGbG9hdDY0QXJyYXldJywKICAgICAgaW50OFRhZyA9ICdbb2JqZWN0IEludDhBcnJheV0nLAogICAgICBpbnQxNlRhZyA9ICdbb2JqZWN0IEludDE2QXJyYXldJywKICAgICAgaW50MzJUYWcgPSAnW29iamVjdCBJbnQzMkFycmF5XScsCiAgICAgIHVpbnQ4VGFnID0gJ1tvYmplY3QgVWludDhBcnJheV0nLAogICAgICB1aW50OENsYW1wZWRUYWcgPSAnW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0nLAogICAgICB1aW50MTZUYWcgPSAnW29iamVjdCBVaW50MTZBcnJheV0nLAogICAgICB1aW50MzJUYWcgPSAnW29iamVjdCBVaW50MzJBcnJheV0nOwoKICAvKiogVXNlZCB0byBtYXRjaCBlbXB0eSBzdHJpbmcgbGl0ZXJhbHMgaW4gY29tcGlsZWQgdGVtcGxhdGUgc291cmNlLiAqLwogIHZhciByZUVtcHR5U3RyaW5nTGVhZGluZyA9IC9cYl9fcCBcKz0gJyc7L2csCiAgICAgIHJlRW1wdHlTdHJpbmdNaWRkbGUgPSAvXGIoX19wIFwrPSkgJycgXCsvZywKICAgICAgcmVFbXB0eVN0cmluZ1RyYWlsaW5nID0gLyhfX2VcKC4qP1wpfFxiX190XCkpIFwrXG4nJzsvZzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggSFRNTCBlbnRpdGllcyBhbmQgSFRNTCBjaGFyYWN0ZXJzLiAqLwogIHZhciByZUVzY2FwZWRIdG1sID0gLyYoPzphbXB8bHR8Z3R8cXVvdHwjMzkpOy9nLAogICAgICByZVVuZXNjYXBlZEh0bWwgPSAvWyY8PiInXS9nLAogICAgICByZUhhc0VzY2FwZWRIdG1sID0gUmVnRXhwKHJlRXNjYXBlZEh0bWwuc291cmNlKSwKICAgICAgcmVIYXNVbmVzY2FwZWRIdG1sID0gUmVnRXhwKHJlVW5lc2NhcGVkSHRtbC5zb3VyY2UpOwoKICAvKiogVXNlZCB0byBtYXRjaCB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLiAqLwogIHZhciByZUVzY2FwZSA9IC88JS0oW1xzXFNdKz8pJT4vZywKICAgICAgcmVFdmFsdWF0ZSA9IC88JShbXHNcU10rPyklPi9nLAogICAgICByZUludGVycG9sYXRlID0gLzwlPShbXHNcU10rPyklPi9nOwoKICAvKiogVXNlZCB0byBtYXRjaCBwcm9wZXJ0eSBuYW1lcyB3aXRoaW4gcHJvcGVydHkgcGF0aHMuICovCiAgdmFyIHJlSXNEZWVwUHJvcCA9IC9cLnxcWyg/OlteW1xdXSp8KFsiJ10pKD86KD8hXDEpW15cXF18XFwuKSo/XDEpXF0vLAogICAgICByZUlzUGxhaW5Qcm9wID0gL15cdyokLywKICAgICAgcmVQcm9wTmFtZSA9IC9bXi5bXF1dK3xcWyg/OigtP1xkKyg/OlwuXGQrKT8pfChbIiddKSgoPzooPyFcMilbXlxcXXxcXC4pKj8pXDIpXF18KD89KD86XC58XFtcXSkoPzpcLnxcW1xdfCQpKS9nOwoKICAvKioKICAgKiBVc2VkIHRvIG1hdGNoIGBSZWdFeHBgCiAgICogW3N5bnRheCBjaGFyYWN0ZXJzXShodHRwOi8vZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy1wYXR0ZXJucykuCiAgICovCiAgdmFyIHJlUmVnRXhwQ2hhciA9IC9bXFxeJC4qKz8oKVtcXXt9fF0vZywKICAgICAgcmVIYXNSZWdFeHBDaGFyID0gUmVnRXhwKHJlUmVnRXhwQ2hhci5zb3VyY2UpOwoKICAvKiogVXNlZCB0byBtYXRjaCBsZWFkaW5nIGFuZCB0cmFpbGluZyB3aGl0ZXNwYWNlLiAqLwogIHZhciByZVRyaW0gPSAvXlxzK3xccyskL2csCiAgICAgIHJlVHJpbVN0YXJ0ID0gL15ccysvLAogICAgICByZVRyaW1FbmQgPSAvXHMrJC87CgogIC8qKiBVc2VkIHRvIG1hdGNoIHdyYXAgZGV0YWlsIGNvbW1lbnRzLiAqLwogIHZhciByZVdyYXBDb21tZW50ID0gL1x7KD86XG5cL1wqIFxbd3JhcHBlZCB3aXRoIC4rXF0gXCpcLyk/XG4/LywKICAgICAgcmVXcmFwRGV0YWlscyA9IC9ce1xuXC9cKiBcW3dyYXBwZWQgd2l0aCAoLispXF0gXCovLAogICAgICByZVNwbGl0RGV0YWlscyA9IC8sPyAmIC87CgogIC8qKiBVc2VkIHRvIG1hdGNoIHdvcmRzIGNvbXBvc2VkIG9mIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzLiAqLwogIHZhciByZUFzY2lpV29yZCA9IC9bXlx4MDAtXHgyZlx4M2EtXHg0MFx4NWItXHg2MFx4N2ItXHg3Zl0rL2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGJhY2tzbGFzaGVzIGluIHByb3BlcnR5IHBhdGhzLiAqLwogIHZhciByZUVzY2FwZUNoYXIgPSAvXFwoXFwpPy9nOwoKICAvKioKICAgKiBVc2VkIHRvIG1hdGNoCiAgICogW0VTIHRlbXBsYXRlIGRlbGltaXRlcnNdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXRlbXBsYXRlLWxpdGVyYWwtbGV4aWNhbC1jb21wb25lbnRzKS4KICAgKi8KICB2YXIgcmVFc1RlbXBsYXRlID0gL1wkXHsoW15cXH1dKig/OlxcLlteXFx9XSopKilcfS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCBgUmVnRXhwYCBmbGFncyBmcm9tIHRoZWlyIGNvZXJjZWQgc3RyaW5nIHZhbHVlcy4gKi8KICB2YXIgcmVGbGFncyA9IC9cdyokLzsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0IGJhZCBzaWduZWQgaGV4YWRlY2ltYWwgc3RyaW5nIHZhbHVlcy4gKi8KICB2YXIgcmVJc0JhZEhleCA9IC9eWy0rXTB4WzAtOWEtZl0rJC9pOwoKICAvKiogVXNlZCB0byBkZXRlY3QgYmluYXJ5IHN0cmluZyB2YWx1ZXMuICovCiAgdmFyIHJlSXNCaW5hcnkgPSAvXjBiWzAxXSskL2k7CgogIC8qKiBVc2VkIHRvIGRldGVjdCBob3N0IGNvbnN0cnVjdG9ycyAoU2FmYXJpKS4gKi8KICB2YXIgcmVJc0hvc3RDdG9yID0gL15cW29iamVjdCAuKz9Db25zdHJ1Y3RvclxdJC87CgogIC8qKiBVc2VkIHRvIGRldGVjdCBvY3RhbCBzdHJpbmcgdmFsdWVzLiAqLwogIHZhciByZUlzT2N0YWwgPSAvXjBvWzAtN10rJC9pOwoKICAvKiogVXNlZCB0byBkZXRlY3QgdW5zaWduZWQgaW50ZWdlciB2YWx1ZXMuICovCiAgdmFyIHJlSXNVaW50ID0gL14oPzowfFsxLTldXGQqKSQvOwoKICAvKiogVXNlZCB0byBtYXRjaCBMYXRpbiBVbmljb2RlIGxldHRlcnMgKGV4Y2x1ZGluZyBtYXRoZW1hdGljYWwgb3BlcmF0b3JzKS4gKi8KICB2YXIgcmVMYXRpbiA9IC9bXHhjMC1ceGQ2XHhkOC1ceGY2XHhmOC1ceGZmXHUwMTAwLVx1MDE3Zl0vZzsKCiAgLyoqIFVzZWQgdG8gZW5zdXJlIGNhcHR1cmluZyBvcmRlciBvZiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLiAqLwogIHZhciByZU5vTWF0Y2ggPSAvKCReKS87CgogIC8qKiBVc2VkIHRvIG1hdGNoIHVuZXNjYXBlZCBjaGFyYWN0ZXJzIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscy4gKi8KICB2YXIgcmVVbmVzY2FwZWRTdHJpbmcgPSAvWydcblxyXHUyMDI4XHUyMDI5XFxdL2c7CgogIC8qKiBVc2VkIHRvIGNvbXBvc2UgdW5pY29kZSBjaGFyYWN0ZXIgY2xhc3Nlcy4gKi8KICB2YXIgcnNBc3RyYWxSYW5nZSA9ICdcXHVkODAwLVxcdWRmZmYnLAogICAgICByc0NvbWJvTWFya3NSYW5nZSA9ICdcXHUwMzAwLVxcdTAzNmYnLAogICAgICByZUNvbWJvSGFsZk1hcmtzUmFuZ2UgPSAnXFx1ZmUyMC1cXHVmZTJmJywKICAgICAgcnNDb21ib1N5bWJvbHNSYW5nZSA9ICdcXHUyMGQwLVxcdTIwZmYnLAogICAgICByc0NvbWJvUmFuZ2UgPSByc0NvbWJvTWFya3NSYW5nZSArIHJlQ29tYm9IYWxmTWFya3NSYW5nZSArIHJzQ29tYm9TeW1ib2xzUmFuZ2UsCiAgICAgIHJzRGluZ2JhdFJhbmdlID0gJ1xcdTI3MDAtXFx1MjdiZicsCiAgICAgIHJzTG93ZXJSYW5nZSA9ICdhLXpcXHhkZi1cXHhmNlxceGY4LVxceGZmJywKICAgICAgcnNNYXRoT3BSYW5nZSA9ICdcXHhhY1xceGIxXFx4ZDdcXHhmNycsCiAgICAgIHJzTm9uQ2hhclJhbmdlID0gJ1xceDAwLVxceDJmXFx4M2EtXFx4NDBcXHg1Yi1cXHg2MFxceDdiLVxceGJmJywKICAgICAgcnNQdW5jdHVhdGlvblJhbmdlID0gJ1xcdTIwMDAtXFx1MjA2ZicsCiAgICAgIHJzU3BhY2VSYW5nZSA9ICcgXFx0XFx4MGJcXGZcXHhhMFxcdWZlZmZcXG5cXHJcXHUyMDI4XFx1MjAyOVxcdTE2ODBcXHUxODBlXFx1MjAwMFxcdTIwMDFcXHUyMDAyXFx1MjAwM1xcdTIwMDRcXHUyMDA1XFx1MjAwNlxcdTIwMDdcXHUyMDA4XFx1MjAwOVxcdTIwMGFcXHUyMDJmXFx1MjA1ZlxcdTMwMDAnLAogICAgICByc1VwcGVyUmFuZ2UgPSAnQS1aXFx4YzAtXFx4ZDZcXHhkOC1cXHhkZScsCiAgICAgIHJzVmFyUmFuZ2UgPSAnXFx1ZmUwZVxcdWZlMGYnLAogICAgICByc0JyZWFrUmFuZ2UgPSByc01hdGhPcFJhbmdlICsgcnNOb25DaGFyUmFuZ2UgKyByc1B1bmN0dWF0aW9uUmFuZ2UgKyByc1NwYWNlUmFuZ2U7CgogIC8qKiBVc2VkIHRvIGNvbXBvc2UgdW5pY29kZSBjYXB0dXJlIGdyb3Vwcy4gKi8KICB2YXIgcnNBcG9zID0gIlsnXHUyMDE5XSIsCiAgICAgIHJzQXN0cmFsID0gJ1snICsgcnNBc3RyYWxSYW5nZSArICddJywKICAgICAgcnNCcmVhayA9ICdbJyArIHJzQnJlYWtSYW5nZSArICddJywKICAgICAgcnNDb21ibyA9ICdbJyArIHJzQ29tYm9SYW5nZSArICddJywKICAgICAgcnNEaWdpdHMgPSAnXFxkKycsCiAgICAgIHJzRGluZ2JhdCA9ICdbJyArIHJzRGluZ2JhdFJhbmdlICsgJ10nLAogICAgICByc0xvd2VyID0gJ1snICsgcnNMb3dlclJhbmdlICsgJ10nLAogICAgICByc01pc2MgPSAnW14nICsgcnNBc3RyYWxSYW5nZSArIHJzQnJlYWtSYW5nZSArIHJzRGlnaXRzICsgcnNEaW5nYmF0UmFuZ2UgKyByc0xvd2VyUmFuZ2UgKyByc1VwcGVyUmFuZ2UgKyAnXScsCiAgICAgIHJzRml0eiA9ICdcXHVkODNjW1xcdWRmZmItXFx1ZGZmZl0nLAogICAgICByc01vZGlmaWVyID0gJyg/OicgKyByc0NvbWJvICsgJ3wnICsgcnNGaXR6ICsgJyknLAogICAgICByc05vbkFzdHJhbCA9ICdbXicgKyByc0FzdHJhbFJhbmdlICsgJ10nLAogICAgICByc1JlZ2lvbmFsID0gJyg/OlxcdWQ4M2NbXFx1ZGRlNi1cXHVkZGZmXSl7Mn0nLAogICAgICByc1N1cnJQYWlyID0gJ1tcXHVkODAwLVxcdWRiZmZdW1xcdWRjMDAtXFx1ZGZmZl0nLAogICAgICByc1VwcGVyID0gJ1snICsgcnNVcHBlclJhbmdlICsgJ10nLAogICAgICByc1pXSiA9ICdcXHUyMDBkJzsKCiAgLyoqIFVzZWQgdG8gY29tcG9zZSB1bmljb2RlIHJlZ2V4ZXMuICovCiAgdmFyIHJzTWlzY0xvd2VyID0gJyg/OicgKyByc0xvd2VyICsgJ3wnICsgcnNNaXNjICsgJyknLAogICAgICByc01pc2NVcHBlciA9ICcoPzonICsgcnNVcHBlciArICd8JyArIHJzTWlzYyArICcpJywKICAgICAgcnNPcHRDb250ckxvd2VyID0gJyg/OicgKyByc0Fwb3MgKyAnKD86ZHxsbHxtfHJlfHN8dHx2ZSkpPycsCiAgICAgIHJzT3B0Q29udHJVcHBlciA9ICcoPzonICsgcnNBcG9zICsgJyg/OkR8TEx8TXxSRXxTfFR8VkUpKT8nLAogICAgICByZU9wdE1vZCA9IHJzTW9kaWZpZXIgKyAnPycsCiAgICAgIHJzT3B0VmFyID0gJ1snICsgcnNWYXJSYW5nZSArICddPycsCiAgICAgIHJzT3B0Sm9pbiA9ICcoPzonICsgcnNaV0ogKyAnKD86JyArIFtyc05vbkFzdHJhbCwgcnNSZWdpb25hbCwgcnNTdXJyUGFpcl0uam9pbignfCcpICsgJyknICsgcnNPcHRWYXIgKyByZU9wdE1vZCArICcpKicsCiAgICAgIHJzT3JkTG93ZXIgPSAnXFxkKig/OjFzdHwybmR8M3JkfCg/IVsxMjNdKVxcZHRoKSg/PVxcYnxbQS1aX10pJywKICAgICAgcnNPcmRVcHBlciA9ICdcXGQqKD86MVNUfDJORHwzUkR8KD8hWzEyM10pXFxkVEgpKD89XFxifFthLXpfXSknLAogICAgICByc1NlcSA9IHJzT3B0VmFyICsgcmVPcHRNb2QgKyByc09wdEpvaW4sCiAgICAgIHJzRW1vamkgPSAnKD86JyArIFtyc0RpbmdiYXQsIHJzUmVnaW9uYWwsIHJzU3VyclBhaXJdLmpvaW4oJ3wnKSArICcpJyArIHJzU2VxLAogICAgICByc1N5bWJvbCA9ICcoPzonICsgW3JzTm9uQXN0cmFsICsgcnNDb21ibyArICc/JywgcnNDb21ibywgcnNSZWdpb25hbCwgcnNTdXJyUGFpciwgcnNBc3RyYWxdLmpvaW4oJ3wnKSArICcpJzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggYXBvc3Ryb3BoZXMuICovCiAgdmFyIHJlQXBvcyA9IFJlZ0V4cChyc0Fwb3MsICdnJyk7CgogIC8qKgogICAqIFVzZWQgdG8gbWF0Y2ggW2NvbWJpbmluZyBkaWFjcml0aWNhbCBtYXJrc10oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29tYmluaW5nX0RpYWNyaXRpY2FsX01hcmtzKSBhbmQKICAgKiBbY29tYmluaW5nIGRpYWNyaXRpY2FsIG1hcmtzIGZvciBzeW1ib2xzXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db21iaW5pbmdfRGlhY3JpdGljYWxfTWFya3NfZm9yX1N5bWJvbHMpLgogICAqLwogIHZhciByZUNvbWJvTWFyayA9IFJlZ0V4cChyc0NvbWJvLCAnZycpOwoKICAvKiogVXNlZCB0byBtYXRjaCBbc3RyaW5nIHN5bWJvbHNdKGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LXVuaWNvZGUpLiAqLwogIHZhciByZVVuaWNvZGUgPSBSZWdFeHAocnNGaXR6ICsgJyg/PScgKyByc0ZpdHogKyAnKXwnICsgcnNTeW1ib2wgKyByc1NlcSwgJ2cnKTsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggY29tcGxleCBvciBjb21wb3VuZCB3b3Jkcy4gKi8KICB2YXIgcmVVbmljb2RlV29yZCA9IFJlZ0V4cChbCiAgICByc1VwcGVyICsgJz8nICsgcnNMb3dlciArICcrJyArIHJzT3B0Q29udHJMb3dlciArICcoPz0nICsgW3JzQnJlYWssIHJzVXBwZXIsICckJ10uam9pbignfCcpICsgJyknLAogICAgcnNNaXNjVXBwZXIgKyAnKycgKyByc09wdENvbnRyVXBwZXIgKyAnKD89JyArIFtyc0JyZWFrLCByc1VwcGVyICsgcnNNaXNjTG93ZXIsICckJ10uam9pbignfCcpICsgJyknLAogICAgcnNVcHBlciArICc/JyArIHJzTWlzY0xvd2VyICsgJysnICsgcnNPcHRDb250ckxvd2VyLAogICAgcnNVcHBlciArICcrJyArIHJzT3B0Q29udHJVcHBlciwKICAgIHJzT3JkVXBwZXIsCiAgICByc09yZExvd2VyLAogICAgcnNEaWdpdHMsCiAgICByc0Vtb2ppCiAgXS5qb2luKCd8JyksICdnJyk7CgogIC8qKiBVc2VkIHRvIGRldGVjdCBzdHJpbmdzIHdpdGggW3plcm8td2lkdGggam9pbmVycyBvciBjb2RlIHBvaW50cyBmcm9tIHRoZSBhc3RyYWwgcGxhbmVzXShodHRwOi8vZWV2LmVlL2Jsb2cvMjAxNS8wOS8xMi9kYXJrLWNvcm5lcnMtb2YtdW5pY29kZS8pLiAqLwogIHZhciByZUhhc1VuaWNvZGUgPSBSZWdFeHAoJ1snICsgcnNaV0ogKyByc0FzdHJhbFJhbmdlICArIHJzQ29tYm9SYW5nZSArIHJzVmFyUmFuZ2UgKyAnXScpOwoKICAvKiogVXNlZCB0byBkZXRlY3Qgc3RyaW5ncyB0aGF0IG5lZWQgYSBtb3JlIHJvYnVzdCByZWdleHAgdG8gbWF0Y2ggd29yZHMuICovCiAgdmFyIHJlSGFzVW5pY29kZVdvcmQgPSAvW2Etel1bQS1aXXxbQS1aXXsyfVthLXpdfFswLTldW2EtekEtWl18W2EtekEtWl1bMC05XXxbXmEtekEtWjAtOSBdLzsKCiAgLyoqIFVzZWQgdG8gYXNzaWduIGRlZmF1bHQgYGNvbnRleHRgIG9iamVjdCBwcm9wZXJ0aWVzLiAqLwogIHZhciBjb250ZXh0UHJvcHMgPSBbCiAgICAnQXJyYXknLCAnQnVmZmVyJywgJ0RhdGFWaWV3JywgJ0RhdGUnLCAnRXJyb3InLCAnRmxvYXQzMkFycmF5JywgJ0Zsb2F0NjRBcnJheScsCiAgICAnRnVuY3Rpb24nLCAnSW50OEFycmF5JywgJ0ludDE2QXJyYXknLCAnSW50MzJBcnJheScsICdNYXAnLCAnTWF0aCcsICdPYmplY3QnLAogICAgJ1Byb21pc2UnLCAnUmVnRXhwJywgJ1NldCcsICdTdHJpbmcnLCAnU3ltYm9sJywgJ1R5cGVFcnJvcicsICdVaW50OEFycmF5JywKICAgICdVaW50OENsYW1wZWRBcnJheScsICdVaW50MTZBcnJheScsICdVaW50MzJBcnJheScsICdXZWFrTWFwJywKICAgICdfJywgJ2NsZWFyVGltZW91dCcsICdpc0Zpbml0ZScsICdwYXJzZUludCcsICdzZXRUaW1lb3V0JwogIF07CgogIC8qKiBVc2VkIHRvIG1ha2UgdGVtcGxhdGUgc291cmNlVVJMcyBlYXNpZXIgdG8gaWRlbnRpZnkuICovCiAgdmFyIHRlbXBsYXRlQ291bnRlciA9IC0xOwoKICAvKiogVXNlZCB0byBpZGVudGlmeSBgdG9TdHJpbmdUYWdgIHZhbHVlcyBvZiB0eXBlZCBhcnJheXMuICovCiAgdmFyIHR5cGVkQXJyYXlUYWdzID0ge307CiAgdHlwZWRBcnJheVRhZ3NbZmxvYXQzMlRhZ10gPSB0eXBlZEFycmF5VGFnc1tmbG9hdDY0VGFnXSA9CiAgdHlwZWRBcnJheVRhZ3NbaW50OFRhZ10gPSB0eXBlZEFycmF5VGFnc1tpbnQxNlRhZ10gPQogIHR5cGVkQXJyYXlUYWdzW2ludDMyVGFnXSA9IHR5cGVkQXJyYXlUYWdzW3VpbnQ4VGFnXSA9CiAgdHlwZWRBcnJheVRhZ3NbdWludDhDbGFtcGVkVGFnXSA9IHR5cGVkQXJyYXlUYWdzW3VpbnQxNlRhZ10gPQogIHR5cGVkQXJyYXlUYWdzW3VpbnQzMlRhZ10gPSB0cnVlOwogIHR5cGVkQXJyYXlUYWdzW2FyZ3NUYWddID0gdHlwZWRBcnJheVRhZ3NbYXJyYXlUYWddID0KICB0eXBlZEFycmF5VGFnc1thcnJheUJ1ZmZlclRhZ10gPSB0eXBlZEFycmF5VGFnc1tib29sVGFnXSA9CiAgdHlwZWRBcnJheVRhZ3NbZGF0YVZpZXdUYWddID0gdHlwZWRBcnJheVRhZ3NbZGF0ZVRhZ10gPQogIHR5cGVkQXJyYXlUYWdzW2Vycm9yVGFnXSA9IHR5cGVkQXJyYXlUYWdzW2Z1bmNUYWddID0KICB0eXBlZEFycmF5VGFnc1ttYXBUYWddID0gdHlwZWRBcnJheVRhZ3NbbnVtYmVyVGFnXSA9CiAgdHlwZWRBcnJheVRhZ3Nbb2JqZWN0VGFnXSA9IHR5cGVkQXJyYXlUYWdzW3JlZ2V4cFRhZ10gPQogIHR5cGVkQXJyYXlUYWdzW3NldFRhZ10gPSB0eXBlZEFycmF5VGFnc1tzdHJpbmdUYWddID0KICB0eXBlZEFycmF5VGFnc1t3ZWFrTWFwVGFnXSA9IGZhbHNlOwoKICAvKiogVXNlZCB0byBpZGVudGlmeSBgdG9TdHJpbmdUYWdgIHZhbHVlcyBzdXBwb3J0ZWQgYnkgYF8uY2xvbmVgLiAqLwogIHZhciBjbG9uZWFibGVUYWdzID0ge307CiAgY2xvbmVhYmxlVGFnc1thcmdzVGFnXSA9IGNsb25lYWJsZVRhZ3NbYXJyYXlUYWddID0KICBjbG9uZWFibGVUYWdzW2FycmF5QnVmZmVyVGFnXSA9IGNsb25lYWJsZVRhZ3NbZGF0YVZpZXdUYWddID0KICBjbG9uZWFibGVUYWdzW2Jvb2xUYWddID0gY2xvbmVhYmxlVGFnc1tkYXRlVGFnXSA9CiAgY2xvbmVhYmxlVGFnc1tmbG9hdDMyVGFnXSA9IGNsb25lYWJsZVRhZ3NbZmxvYXQ2NFRhZ10gPQogIGNsb25lYWJsZVRhZ3NbaW50OFRhZ10gPSBjbG9uZWFibGVUYWdzW2ludDE2VGFnXSA9CiAgY2xvbmVhYmxlVGFnc1tpbnQzMlRhZ10gPSBjbG9uZWFibGVUYWdzW21hcFRhZ10gPQogIGNsb25lYWJsZVRhZ3NbbnVtYmVyVGFnXSA9IGNsb25lYWJsZVRhZ3Nbb2JqZWN0VGFnXSA9CiAgY2xvbmVhYmxlVGFnc1tyZWdleHBUYWddID0gY2xvbmVhYmxlVGFnc1tzZXRUYWddID0KICBjbG9uZWFibGVUYWdzW3N0cmluZ1RhZ10gPSBjbG9uZWFibGVUYWdzW3N5bWJvbFRhZ10gPQogIGNsb25lYWJsZVRhZ3NbdWludDhUYWddID0gY2xvbmVhYmxlVGFnc1t1aW50OENsYW1wZWRUYWddID0KICBjbG9uZWFibGVUYWdzW3VpbnQxNlRhZ10gPSBjbG9uZWFibGVUYWdzW3VpbnQzMlRhZ10gPSB0cnVlOwogIGNsb25lYWJsZVRhZ3NbZXJyb3JUYWddID0gY2xvbmVhYmxlVGFnc1tmdW5jVGFnXSA9CiAgY2xvbmVhYmxlVGFnc1t3ZWFrTWFwVGFnXSA9IGZhbHNlOwoKICAvKiogVXNlZCB0byBtYXAgTGF0aW4gVW5pY29kZSBsZXR0ZXJzIHRvIGJhc2ljIExhdGluIGxldHRlcnMuICovCiAgdmFyIGRlYnVycmVkTGV0dGVycyA9IHsKICAgIC8vIExhdGluLTEgU3VwcGxlbWVudCBibG9jay4KICAgICdceGMwJzogJ0EnLCAgJ1x4YzEnOiAnQScsICdceGMyJzogJ0EnLCAnXHhjMyc6ICdBJywgJ1x4YzQnOiAnQScsICdceGM1JzogJ0EnLAogICAgJ1x4ZTAnOiAnYScsICAnXHhlMSc6ICdhJywgJ1x4ZTInOiAnYScsICdceGUzJzogJ2EnLCAnXHhlNCc6ICdhJywgJ1x4ZTUnOiAnYScsCiAgICAnXHhjNyc6ICdDJywgICdceGU3JzogJ2MnLAogICAgJ1x4ZDAnOiAnRCcsICAnXHhmMCc6ICdkJywKICAgICdceGM4JzogJ0UnLCAgJ1x4YzknOiAnRScsICdceGNhJzogJ0UnLCAnXHhjYic6ICdFJywKICAgICdceGU4JzogJ2UnLCAgJ1x4ZTknOiAnZScsICdceGVhJzogJ2UnLCAnXHhlYic6ICdlJywKICAgICdceGNjJzogJ0knLCAgJ1x4Y2QnOiAnSScsICdceGNlJzogJ0knLCAnXHhjZic6ICdJJywKICAgICdceGVjJzogJ2knLCAgJ1x4ZWQnOiAnaScsICdceGVlJzogJ2knLCAnXHhlZic6ICdpJywKICAgICdceGQxJzogJ04nLCAgJ1x4ZjEnOiAnbicsCiAgICAnXHhkMic6ICdPJywgICdceGQzJzogJ08nLCAnXHhkNCc6ICdPJywgJ1x4ZDUnOiAnTycsICdceGQ2JzogJ08nLCAnXHhkOCc6ICdPJywKICAgICdceGYyJzogJ28nLCAgJ1x4ZjMnOiAnbycsICdceGY0JzogJ28nLCAnXHhmNSc6ICdvJywgJ1x4ZjYnOiAnbycsICdceGY4JzogJ28nLAogICAgJ1x4ZDknOiAnVScsICAnXHhkYSc6ICdVJywgJ1x4ZGInOiAnVScsICdceGRjJzogJ1UnLAogICAgJ1x4ZjknOiAndScsICAnXHhmYSc6ICd1JywgJ1x4ZmInOiAndScsICdceGZjJzogJ3UnLAogICAgJ1x4ZGQnOiAnWScsICAnXHhmZCc6ICd5JywgJ1x4ZmYnOiAneScsCiAgICAnXHhjNic6ICdBZScsICdceGU2JzogJ2FlJywKICAgICdceGRlJzogJ1RoJywgJ1x4ZmUnOiAndGgnLAogICAgJ1x4ZGYnOiAnc3MnLAogICAgLy8gTGF0aW4gRXh0ZW5kZWQtQSBibG9jay4KICAgICdcdTAxMDAnOiAnQScsICAnXHUwMTAyJzogJ0EnLCAnXHUwMTA0JzogJ0EnLAogICAgJ1x1MDEwMSc6ICdhJywgICdcdTAxMDMnOiAnYScsICdcdTAxMDUnOiAnYScsCiAgICAnXHUwMTA2JzogJ0MnLCAgJ1x1MDEwOCc6ICdDJywgJ1x1MDEwYSc6ICdDJywgJ1x1MDEwYyc6ICdDJywKICAgICdcdTAxMDcnOiAnYycsICAnXHUwMTA5JzogJ2MnLCAnXHUwMTBiJzogJ2MnLCAnXHUwMTBkJzogJ2MnLAogICAgJ1x1MDEwZSc6ICdEJywgICdcdTAxMTAnOiAnRCcsICdcdTAxMGYnOiAnZCcsICdcdTAxMTEnOiAnZCcsCiAgICAnXHUwMTEyJzogJ0UnLCAgJ1x1MDExNCc6ICdFJywgJ1x1MDExNic6ICdFJywgJ1x1MDExOCc6ICdFJywgJ1x1MDExYSc6ICdFJywKICAgICdcdTAxMTMnOiAnZScsICAnXHUwMTE1JzogJ2UnLCAnXHUwMTE3JzogJ2UnLCAnXHUwMTE5JzogJ2UnLCAnXHUwMTFiJzogJ2UnLAogICAgJ1x1MDExYyc6ICdHJywgICdcdTAxMWUnOiAnRycsICdcdTAxMjAnOiAnRycsICdcdTAxMjInOiAnRycsCiAgICAnXHUwMTFkJzogJ2cnLCAgJ1x1MDExZic6ICdnJywgJ1x1MDEyMSc6ICdnJywgJ1x1MDEyMyc6ICdnJywKICAgICdcdTAxMjQnOiAnSCcsICAnXHUwMTI2JzogJ0gnLCAnXHUwMTI1JzogJ2gnLCAnXHUwMTI3JzogJ2gnLAogICAgJ1x1MDEyOCc6ICdJJywgICdcdTAxMmEnOiAnSScsICdcdTAxMmMnOiAnSScsICdcdTAxMmUnOiAnSScsICdcdTAxMzAnOiAnSScsCiAgICAnXHUwMTI5JzogJ2knLCAgJ1x1MDEyYic6ICdpJywgJ1x1MDEyZCc6ICdpJywgJ1x1MDEyZic6ICdpJywgJ1x1MDEzMSc6ICdpJywKICAgICdcdTAxMzQnOiAnSicsICAnXHUwMTM1JzogJ2onLAogICAgJ1x1MDEzNic6ICdLJywgICdcdTAxMzcnOiAnaycsICdcdTAxMzgnOiAnaycsCiAgICAnXHUwMTM5JzogJ0wnLCAgJ1x1MDEzYic6ICdMJywgJ1x1MDEzZCc6ICdMJywgJ1x1MDEzZic6ICdMJywgJ1x1MDE0MSc6ICdMJywKICAgICdcdTAxM2EnOiAnbCcsICAnXHUwMTNjJzogJ2wnLCAnXHUwMTNlJzogJ2wnLCAnXHUwMTQwJzogJ2wnLCAnXHUwMTQyJzogJ2wnLAogICAgJ1x1MDE0Myc6ICdOJywgICdcdTAxNDUnOiAnTicsICdcdTAxNDcnOiAnTicsICdcdTAxNGEnOiAnTicsCiAgICAnXHUwMTQ0JzogJ24nLCAgJ1x1MDE0Nic6ICduJywgJ1x1MDE0OCc6ICduJywgJ1x1MDE0Yic6ICduJywKICAgICdcdTAxNGMnOiAnTycsICAnXHUwMTRlJzogJ08nLCAnXHUwMTUwJzogJ08nLAogICAgJ1x1MDE0ZCc6ICdvJywgICdcdTAxNGYnOiAnbycsICdcdTAxNTEnOiAnbycsCiAgICAnXHUwMTU0JzogJ1InLCAgJ1x1MDE1Nic6ICdSJywgJ1x1MDE1OCc6ICdSJywKICAgICdcdTAxNTUnOiAncicsICAnXHUwMTU3JzogJ3InLCAnXHUwMTU5JzogJ3InLAogICAgJ1x1MDE1YSc6ICdTJywgICdcdTAxNWMnOiAnUycsICdcdTAxNWUnOiAnUycsICdcdTAxNjAnOiAnUycsCiAgICAnXHUwMTViJzogJ3MnLCAgJ1x1MDE1ZCc6ICdzJywgJ1x1MDE1Zic6ICdzJywgJ1x1MDE2MSc6ICdzJywKICAgICdcdTAxNjInOiAnVCcsICAnXHUwMTY0JzogJ1QnLCAnXHUwMTY2JzogJ1QnLAogICAgJ1x1MDE2Myc6ICd0JywgICdcdTAxNjUnOiAndCcsICdcdTAxNjcnOiAndCcsCiAgICAnXHUwMTY4JzogJ1UnLCAgJ1x1MDE2YSc6ICdVJywgJ1x1MDE2Yyc6ICdVJywgJ1x1MDE2ZSc6ICdVJywgJ1x1MDE3MCc6ICdVJywgJ1x1MDE3Mic6ICdVJywKICAgICdcdTAxNjknOiAndScsICAnXHUwMTZiJzogJ3UnLCAnXHUwMTZkJzogJ3UnLCAnXHUwMTZmJzogJ3UnLCAnXHUwMTcxJzogJ3UnLCAnXHUwMTczJzogJ3UnLAogICAgJ1x1MDE3NCc6ICdXJywgICdcdTAxNzUnOiAndycsCiAgICAnXHUwMTc2JzogJ1knLCAgJ1x1MDE3Nyc6ICd5JywgJ1x1MDE3OCc6ICdZJywKICAgICdcdTAxNzknOiAnWicsICAnXHUwMTdiJzogJ1onLCAnXHUwMTdkJzogJ1onLAogICAgJ1x1MDE3YSc6ICd6JywgICdcdTAxN2MnOiAneicsICdcdTAxN2UnOiAneicsCiAgICAnXHUwMTMyJzogJ0lKJywgJ1x1MDEzMyc6ICdpaicsCiAgICAnXHUwMTUyJzogJ09lJywgJ1x1MDE1Myc6ICdvZScsCiAgICAnXHUwMTQ5JzogIiduIiwgJ1x1MDE3Zic6ICdzJwogIH07CgogIC8qKiBVc2VkIHRvIG1hcCBjaGFyYWN0ZXJzIHRvIEhUTUwgZW50aXRpZXMuICovCiAgdmFyIGh0bWxFc2NhcGVzID0gewogICAgJyYnOiAnJmFtcDsnLAogICAgJzwnOiAnJmx0OycsCiAgICAnPic6ICcmZ3Q7JywKICAgICciJzogJyZxdW90OycsCiAgICAiJyI6ICcmIzM5OycKICB9OwoKICAvKiogVXNlZCB0byBtYXAgSFRNTCBlbnRpdGllcyB0byBjaGFyYWN0ZXJzLiAqLwogIHZhciBodG1sVW5lc2NhcGVzID0gewogICAgJyZhbXA7JzogJyYnLAogICAgJyZsdDsnOiAnPCcsCiAgICAnJmd0Oyc6ICc+JywKICAgICcmcXVvdDsnOiAnIicsCiAgICAnJiMzOTsnOiAiJyIKICB9OwoKICAvKiogVXNlZCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscy4gKi8KICB2YXIgc3RyaW5nRXNjYXBlcyA9IHsKICAgICdcXCc6ICdcXCcsCiAgICAiJyI6ICInIiwKICAgICdcbic6ICduJywKICAgICdccic6ICdyJywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICAvKiogQnVpbHQtaW4gbWV0aG9kIHJlZmVyZW5jZXMgd2l0aG91dCBhIGRlcGVuZGVuY3kgb24gYHJvb3RgLiAqLwogIHZhciBmcmVlUGFyc2VGbG9hdCA9IHBhcnNlRmxvYXQsCiAgICAgIGZyZWVQYXJzZUludCA9IHBhcnNlSW50OwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYGdsb2JhbGAgZnJvbSBOb2RlLmpzLiAqLwogIHZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAnb2JqZWN0JyAmJiBnbG9iYWwgJiYgZ2xvYmFsLk9iamVjdCA9PT0gT2JqZWN0ICYmIGdsb2JhbDsKCiAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlIGBzZWxmYC4gKi8KICB2YXIgZnJlZVNlbGYgPSB0eXBlb2Ygc2VsZiA9PSAnb2JqZWN0JyAmJiBzZWxmICYmIHNlbGYuT2JqZWN0ID09PSBPYmplY3QgJiYgc2VsZjsKCiAgLyoqIFVzZWQgYXMgYSByZWZlcmVuY2UgdG8gdGhlIGdsb2JhbCBvYmplY3QuICovCiAgdmFyIHJvb3QgPSBmcmVlR2xvYmFsIHx8IGZyZWVTZWxmIHx8IEZ1bmN0aW9uKCdyZXR1cm4gdGhpcycpKCk7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgZXhwb3J0c2AuICovCiAgdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcgJiYgZXhwb3J0cyAmJiAhZXhwb3J0cy5ub2RlVHlwZSAmJiBleHBvcnRzOwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYG1vZHVsZWAuICovCiAgdmFyIGZyZWVNb2R1bGUgPSBmcmVlRXhwb3J0cyAmJiB0eXBlb2YgbW9kdWxlID09ICdvYmplY3QnICYmIG1vZHVsZSAmJiAhbW9kdWxlLm5vZGVUeXBlICYmIG1vZHVsZTsKCiAgLyoqIERldGVjdCB0aGUgcG9wdWxhciBDb21tb25KUyBleHRlbnNpb24gYG1vZHVsZS5leHBvcnRzYC4gKi8KICB2YXIgbW9kdWxlRXhwb3J0cyA9IGZyZWVNb2R1bGUgJiYgZnJlZU1vZHVsZS5leHBvcnRzID09PSBmcmVlRXhwb3J0czsKCiAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlIGBwcm9jZXNzYCBmcm9tIE5vZGUuanMuICovCiAgdmFyIGZyZWVQcm9jZXNzID0gbW9kdWxlRXhwb3J0cyAmJiBmcmVlR2xvYmFsLnByb2Nlc3M7CgogIC8qKiBVc2VkIHRvIGFjY2VzcyBmYXN0ZXIgTm9kZS5qcyBoZWxwZXJzLiAqLwogIHZhciBub2RlVXRpbCA9IChmdW5jdGlvbigpIHsKICAgIHRyeSB7CiAgICAgIC8vIFVzZSBgdXRpbC50eXBlc2AgZm9yIE5vZGUuanMgMTArLgogICAgICB2YXIgdHlwZXMgPSBmcmVlTW9kdWxlICYmIGZyZWVNb2R1bGUucmVxdWlyZSAmJiBmcmVlTW9kdWxlLnJlcXVpcmUoJ3V0aWwnKS50eXBlczsKCiAgICAgIGlmICh0eXBlcykgewogICAgICAgIHJldHVybiB0eXBlczsKICAgICAgfQoKICAgICAgLy8gTGVnYWN5IGBwcm9jZXNzLmJpbmRpbmcoJ3V0aWwnKWAgZm9yIE5vZGUuanMgPCAxMC4KICAgICAgcmV0dXJuIGZyZWVQcm9jZXNzICYmIGZyZWVQcm9jZXNzLmJpbmRpbmcgJiYgZnJlZVByb2Nlc3MuYmluZGluZygndXRpbCcpOwogICAgfSBjYXRjaCAoZSkge30KICB9KCkpOwoKICAvKiBOb2RlLmpzIGhlbHBlciByZWZlcmVuY2VzLiAqLwogIHZhciBub2RlSXNBcnJheUJ1ZmZlciA9IG5vZGVVdGlsICYmIG5vZGVVdGlsLmlzQXJyYXlCdWZmZXIsCiAgICAgIG5vZGVJc0RhdGUgPSBub2RlVXRpbCAmJiBub2RlVXRpbC5pc0RhdGUsCiAgICAgIG5vZGVJc01hcCA9IG5vZGVVdGlsICYmIG5vZGVVdGlsLmlzTWFwLAogICAgICBub2RlSXNSZWdFeHAgPSBub2RlVXRpbCAmJiBub2RlVXRpbC5pc1JlZ0V4cCwKICAgICAgbm9kZUlzU2V0ID0gbm9kZVV0aWwgJiYgbm9kZVV0aWwuaXNTZXQsCiAgICAgIG5vZGVJc1R5cGVkQXJyYXkgPSBub2RlVXRpbCAmJiBub2RlVXRpbC5pc1R5cGVkQXJyYXk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBBIGZhc3RlciBhbHRlcm5hdGl2ZSB0byBgRnVuY3Rpb24jYXBwbHlgLCB0aGlzIGZ1bmN0aW9uIGludm9rZXMgYGZ1bmNgCiAgICogd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgYHRoaXNBcmdgIGFuZCB0aGUgYXJndW1lbnRzIG9mIGBhcmdzYC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaW52b2tlLgogICAqIEBwYXJhbSB7Kn0gdGhpc0FyZyBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAqIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBpbnZva2UgYGZ1bmNgIHdpdGguCiAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc3VsdCBvZiBgZnVuY2AuCiAgICovCiAgZnVuY3Rpb24gYXBwbHkoZnVuYywgdGhpc0FyZywgYXJncykgewogICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewogICAgICBjYXNlIDA6IHJldHVybiBmdW5jLmNhbGwodGhpc0FyZyk7CiAgICAgIGNhc2UgMTogcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCBhcmdzWzBdKTsKICAgICAgY2FzZSAyOiByZXR1cm4gZnVuYy5jYWxsKHRoaXNBcmcsIGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgICBjYXNlIDM6IHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICB9CiAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICB9CgogIC8qKgogICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgYmFzZUFnZ3JlZ2F0b3JgIGZvciBhcnJheXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheV0gVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBzZXR0ZXIgVGhlIGZ1bmN0aW9uIHRvIHNldCBgYWNjdW11bGF0b3JgIHZhbHVlcy4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRlZSBUaGUgaXRlcmF0ZWUgdG8gdHJhbnNmb3JtIGtleXMuCiAgICogQHBhcmFtIHtPYmplY3R9IGFjY3VtdWxhdG9yIFRoZSBpbml0aWFsIGFnZ3JlZ2F0ZWQgb2JqZWN0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBgYWNjdW11bGF0b3JgLgogICAqLwogIGZ1bmN0aW9uIGFycmF5QWdncmVnYXRvcihhcnJheSwgc2V0dGVyLCBpdGVyYXRlZSwgYWNjdW11bGF0b3IpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgc2V0dGVyKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaXRlcmF0ZWUodmFsdWUpLCBhcnJheSk7CiAgICB9CiAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgfQoKICAvKioKICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYF8uZm9yRWFjaGAgZm9yIGFycmF5cyB3aXRob3V0IHN1cHBvcnQgZm9yCiAgICogaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5XSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGBhcnJheWAuCiAgICovCiAgZnVuY3Rpb24gYXJyYXlFYWNoKGFycmF5LCBpdGVyYXRlZSkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgaWYgKGl0ZXJhdGVlKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSA9PT0gZmFsc2UpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFycmF5OwogIH0KCiAgLyoqCiAgICogQSBzcGVjaWFsaXplZCB2ZXJzaW9uIG9mIGBfLmZvckVhY2hSaWdodGAgZm9yIGFycmF5cyB3aXRob3V0IHN1cHBvcnQgZm9yCiAgICogaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5XSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGBhcnJheWAuCiAgICovCiAgZnVuY3Rpb24gYXJyYXlFYWNoUmlnaHQoYXJyYXksIGl0ZXJhdGVlKSB7CiAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CgogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIGlmIChpdGVyYXRlZShhcnJheVtsZW5ndGhdLCBsZW5ndGgsIGFycmF5KSA9PT0gZmFsc2UpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFycmF5OwogIH0KCiAgLyoqCiAgICogQSBzcGVjaWFsaXplZCB2ZXJzaW9uIG9mIGBfLmV2ZXJ5YCBmb3IgYXJyYXlzIHdpdGhvdXQgc3VwcG9ydCBmb3IKICAgKiBpdGVyYXRlZSBzaG9ydGhhbmRzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXldIFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZGljYXRlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFsbCBlbGVtZW50cyBwYXNzIHRoZSBwcmVkaWNhdGUgY2hlY2ssCiAgICogIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBhcnJheUV2ZXJ5KGFycmF5LCBwcmVkaWNhdGUpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmICghcHJlZGljYXRlKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvKioKICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYF8uZmlsdGVyYCBmb3IgYXJyYXlzIHdpdGhvdXQgc3VwcG9ydCBmb3IKICAgKiBpdGVyYXRlZSBzaG9ydGhhbmRzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXldIFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZGljYXRlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZmlsdGVyZWQgYXJyYXkuCiAgICovCiAgZnVuY3Rpb24gYXJyYXlGaWx0ZXIoYXJyYXksIHByZWRpY2F0ZSkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGgsCiAgICAgICAgcmVzSW5kZXggPSAwLAogICAgICAgIHJlc3VsdCA9IFtdOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgIHJlc3VsdFtyZXNJbmRleCsrXSA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQSBzcGVjaWFsaXplZCB2ZXJzaW9uIG9mIGBfLmluY2x1ZGVzYCBmb3IgYXJyYXlzIHdpdGhvdXQgc3VwcG9ydCBmb3IKICAgKiBzcGVjaWZ5aW5nIGFuIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXldIFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAqIEBwYXJhbSB7Kn0gdGFyZ2V0IFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdGFyZ2V0YCBpcyBmb3VuZCwgZWxzZSBgZmFsc2VgLgogICAqLwogIGZ1bmN0aW9uIGFycmF5SW5jbHVkZXMoYXJyYXksIHZhbHVlKSB7CiAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CiAgICByZXR1cm4gISFsZW5ndGggJiYgYmFzZUluZGV4T2YoYXJyYXksIHZhbHVlLCAwKSA+IC0xOwogIH0KCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBpcyBsaWtlIGBhcnJheUluY2x1ZGVzYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGEgY29tcGFyYXRvci4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5XSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICAgKiBAcGFyYW0geyp9IHRhcmdldCBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb21wYXJhdG9yIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB0YXJnZXRgIGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICovCiAgZnVuY3Rpb24gYXJyYXlJbmNsdWRlc1dpdGgoYXJyYXksIHZhbHVlLCBjb21wYXJhdG9yKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoY29tcGFyYXRvcih2YWx1ZSwgYXJyYXlbaW5kZXhdKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICAvKioKICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYF8ubWFwYCBmb3IgYXJyYXlzIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUKICAgKiBzaG9ydGhhbmRzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXldIFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0ZWUgVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBtYXBwZWQgYXJyYXkuCiAgICovCiAgZnVuY3Rpb24gYXJyYXlNYXAoYXJyYXksIGl0ZXJhdGVlKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aCwKICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBpdGVyYXRlZShhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQXBwZW5kcyB0aGUgZWxlbWVudHMgb2YgYHZhbHVlc2AgdG8gYGFycmF5YC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZXMgVGhlIHZhbHVlcyB0byBhcHBlbmQuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGBhcnJheWAuCiAgICovCiAgZnVuY3Rpb24gYXJyYXlQdXNoKGFycmF5LCB2YWx1ZXMpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IHZhbHVlcy5sZW5ndGgsCiAgICAgICAgb2Zmc2V0ID0gYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGFycmF5W29mZnNldCArIGluZGV4XSA9IHZhbHVlc1tpbmRleF07CiAgICB9CiAgICByZXR1cm4gYXJyYXk7CiAgfQoKICAvKioKICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYF8ucmVkdWNlYCBmb3IgYXJyYXlzIHdpdGhvdXQgc3VwcG9ydCBmb3IKICAgKiBpdGVyYXRlZSBzaG9ydGhhbmRzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXldIFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0ZWUgVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0geyp9IFthY2N1bXVsYXRvcl0gVGhlIGluaXRpYWwgdmFsdWUuCiAgICogQHBhcmFtIHtib29sZWFufSBbaW5pdEFjY3VtXSBTcGVjaWZ5IHVzaW5nIHRoZSBmaXJzdCBlbGVtZW50IG9mIGBhcnJheWAgYXMKICAgKiAgdGhlIGluaXRpYWwgdmFsdWUuCiAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqLwogIGZ1bmN0aW9uIGFycmF5UmVkdWNlKGFycmF5LCBpdGVyYXRlZSwgYWNjdW11bGF0b3IsIGluaXRBY2N1bSkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CgogICAgaWYgKGluaXRBY2N1bSAmJiBsZW5ndGgpIHsKICAgICAgYWNjdW11bGF0b3IgPSBhcnJheVsrK2luZGV4XTsKICAgIH0KICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGFjY3VtdWxhdG9yID0gaXRlcmF0ZWUoYWNjdW11bGF0b3IsIGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KTsKICAgIH0KICAgIHJldHVybiBhY2N1bXVsYXRvcjsKICB9CgogIC8qKgogICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgXy5yZWR1Y2VSaWdodGAgZm9yIGFycmF5cyB3aXRob3V0IHN1cHBvcnQgZm9yCiAgICogaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5XSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIFRoZSBpbml0aWFsIHZhbHVlLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2luaXRBY2N1bV0gU3BlY2lmeSB1c2luZyB0aGUgbGFzdCBlbGVtZW50IG9mIGBhcnJheWAgYXMKICAgKiAgdGhlIGluaXRpYWwgdmFsdWUuCiAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqLwogIGZ1bmN0aW9uIGFycmF5UmVkdWNlUmlnaHQoYXJyYXksIGl0ZXJhdGVlLCBhY2N1bXVsYXRvciwgaW5pdEFjY3VtKSB7CiAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CiAgICBpZiAoaW5pdEFjY3VtICYmIGxlbmd0aCkgewogICAgICBhY2N1bXVsYXRvciA9IGFycmF5Wy0tbGVuZ3RoXTsKICAgIH0KICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICBhY2N1bXVsYXRvciA9IGl0ZXJhdGVlKGFjY3VtdWxhdG9yLCBhcnJheVtsZW5ndGhdLCBsZW5ndGgsIGFycmF5KTsKICAgIH0KICAgIHJldHVybiBhY2N1bXVsYXRvcjsKICB9CgogIC8qKgogICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgXy5zb21lYCBmb3IgYXJyYXlzIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUKICAgKiBzaG9ydGhhbmRzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXldIFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZGljYXRlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFueSBlbGVtZW50IHBhc3NlcyB0aGUgcHJlZGljYXRlIGNoZWNrLAogICAqICBlbHNlIGBmYWxzZWAuCiAgICovCiAgZnVuY3Rpb24gYXJyYXlTb21lKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIHNpemUgb2YgYW4gQVNDSUkgYHN0cmluZ2AuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIHN0cmluZyBzaXplLgogICAqLwogIHZhciBhc2NpaVNpemUgPSBiYXNlUHJvcGVydHkoJ2xlbmd0aCcpOwoKICAvKioKICAgKiBDb252ZXJ0cyBhbiBBU0NJSSBgc3RyaW5nYCB0byBhbiBhcnJheS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBUaGUgc3RyaW5nIHRvIGNvbnZlcnQuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBjb252ZXJ0ZWQgYXJyYXkuCiAgICovCiAgZnVuY3Rpb24gYXNjaWlUb0FycmF5KHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZy5zcGxpdCgnJyk7CiAgfQoKICAvKioKICAgKiBTcGxpdHMgYW4gQVNDSUkgYHN0cmluZ2AgaW50byBhbiBhcnJheSBvZiBpdHMgd29yZHMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBUaGUgc3RyaW5nIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSB3b3JkcyBvZiBgc3RyaW5nYC4KICAgKi8KICBmdW5jdGlvbiBhc2NpaVdvcmRzKHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZy5tYXRjaChyZUFzY2lpV29yZCkgfHwgW107CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBtZXRob2RzIGxpa2UgYF8uZmluZEtleWAgYW5kIGBfLmZpbmRMYXN0S2V5YCwKICAgKiB3aXRob3V0IHN1cHBvcnQgZm9yIGl0ZXJhdGVlIHNob3J0aGFuZHMsIHdoaWNoIGl0ZXJhdGVzIG92ZXIgYGNvbGxlY3Rpb25gCiAgICogdXNpbmcgYGVhY2hGdW5jYC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaW5zcGVjdC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcmVkaWNhdGUgVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlYWNoRnVuYyBUaGUgZnVuY3Rpb24gdG8gaXRlcmF0ZSBvdmVyIGBjb2xsZWN0aW9uYC4KICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZm91bmQgZWxlbWVudCBvciBpdHMga2V5LCBlbHNlIGB1bmRlZmluZWRgLgogICAqLwogIGZ1bmN0aW9uIGJhc2VGaW5kS2V5KGNvbGxlY3Rpb24sIHByZWRpY2F0ZSwgZWFjaEZ1bmMpIHsKICAgIHZhciByZXN1bHQ7CiAgICBlYWNoRnVuYyhjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgIGlmIChwcmVkaWNhdGUodmFsdWUsIGtleSwgY29sbGVjdGlvbikpIHsKICAgICAgICByZXN1bHQgPSBrZXk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5maW5kSW5kZXhgIGFuZCBgXy5maW5kTGFzdEluZGV4YCB3aXRob3V0CiAgICogc3VwcG9ydCBmb3IgaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZGljYXRlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IGZyb21JbmRleCBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICogQHBhcmFtIHtib29sZWFufSBbZnJvbVJpZ2h0XSBTcGVjaWZ5IGl0ZXJhdGluZyBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUsIGVsc2UgYC0xYC4KICAgKi8KICBmdW5jdGlvbiBiYXNlRmluZEluZGV4KGFycmF5LCBwcmVkaWNhdGUsIGZyb21JbmRleCwgZnJvbVJpZ2h0KSB7CiAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgIGluZGV4ID0gZnJvbUluZGV4ICsgKGZyb21SaWdodCA/IDEgOiAtMSk7CgogICAgd2hpbGUgKChmcm9tUmlnaHQgPyBpbmRleC0tIDogKytpbmRleCA8IGxlbmd0aCkpIHsKICAgICAgaWYgKHByZWRpY2F0ZShhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmluZGV4T2ZgIHdpdGhvdXQgYGZyb21JbmRleGAgYm91bmRzIGNoZWNrcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge251bWJlcn0gZnJvbUluZGV4IFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSwgZWxzZSBgLTFgLgogICAqLwogIGZ1bmN0aW9uIGJhc2VJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlCiAgICAgID8gc3RyaWN0SW5kZXhPZihhcnJheSwgdmFsdWUsIGZyb21JbmRleCkKICAgICAgOiBiYXNlRmluZEluZGV4KGFycmF5LCBiYXNlSXNOYU4sIGZyb21JbmRleCk7CiAgfQoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGlzIGxpa2UgYGJhc2VJbmRleE9mYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGEgY29tcGFyYXRvci4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge251bWJlcn0gZnJvbUluZGV4IFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb21wYXJhdG9yIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUsIGVsc2UgYC0xYC4KICAgKi8KICBmdW5jdGlvbiBiYXNlSW5kZXhPZldpdGgoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgsIGNvbXBhcmF0b3IpIHsKICAgIHZhciBpbmRleCA9IGZyb21JbmRleCAtIDEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmIChjb21wYXJhdG9yKGFycmF5W2luZGV4XSwgdmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pc05hTmAgd2l0aG91dCBzdXBwb3J0IGZvciBudW1iZXIgb2JqZWN0cy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYE5hTmAsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBiYXNlSXNOYU4odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPT0gdmFsdWU7CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5tZWFuYCBhbmQgYF8ubWVhbkJ5YCB3aXRob3V0IHN1cHBvcnQgZm9yCiAgICogaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRlZSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIG1lYW4uCiAgICovCiAgZnVuY3Rpb24gYmFzZU1lYW4oYXJyYXksIGl0ZXJhdGVlKSB7CiAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CiAgICByZXR1cm4gbGVuZ3RoID8gKGJhc2VTdW0oYXJyYXksIGl0ZXJhdGVlKSAvIGxlbmd0aCkgOiBOQU47CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5wcm9wZXJ0eWAgd2l0aG91dCBzdXBwb3J0IGZvciBkZWVwIHBhdGhzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHByb3BlcnR5IHRvIGdldC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBhY2Nlc3NvciBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiBiYXNlUHJvcGVydHkoa2V5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgIHJldHVybiBvYmplY3QgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IG9iamVjdFtrZXldOwogICAgfTsKICB9CgogIC8qKgogICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnByb3BlcnR5T2ZgIHdpdGhvdXQgc3VwcG9ydCBmb3IgZGVlcCBwYXRocy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHF1ZXJ5LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGFjY2Vzc29yIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIGJhc2VQcm9wZXJ0eU9mKG9iamVjdCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGtleSkgewogICAgICByZXR1cm4gb2JqZWN0ID09IG51bGwgPyB1bmRlZmluZWQgOiBvYmplY3Rba2V5XTsKICAgIH07CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5yZWR1Y2VgIGFuZCBgXy5yZWR1Y2VSaWdodGAsIHdpdGhvdXQgc3VwcG9ydAogICAqIGZvciBpdGVyYXRlZSBzaG9ydGhhbmRzLCB3aGljaCBpdGVyYXRlcyBvdmVyIGBjb2xsZWN0aW9uYCB1c2luZyBgZWFjaEZ1bmNgLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0ZWUgVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0geyp9IGFjY3VtdWxhdG9yIFRoZSBpbml0aWFsIHZhbHVlLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gaW5pdEFjY3VtIFNwZWNpZnkgdXNpbmcgdGhlIGZpcnN0IG9yIGxhc3QgZWxlbWVudCBvZgogICAqICBgY29sbGVjdGlvbmAgYXMgdGhlIGluaXRpYWwgdmFsdWUuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZWFjaEZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGl0ZXJhdGUgb3ZlciBgY29sbGVjdGlvbmAuCiAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqLwogIGZ1bmN0aW9uIGJhc2VSZWR1Y2UoY29sbGVjdGlvbiwgaXRlcmF0ZWUsIGFjY3VtdWxhdG9yLCBpbml0QWNjdW0sIGVhY2hGdW5jKSB7CiAgICBlYWNoRnVuYyhjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgYWNjdW11bGF0b3IgPSBpbml0QWNjdW0KICAgICAgICA/IChpbml0QWNjdW0gPSBmYWxzZSwgdmFsdWUpCiAgICAgICAgOiBpdGVyYXRlZShhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgIH0pOwogICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogIH0KCiAgLyoqCiAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uc29ydEJ5YCB3aGljaCB1c2VzIGBjb21wYXJlcmAgdG8gZGVmaW5lIHRoZQogICAqIHNvcnQgb3JkZXIgb2YgYGFycmF5YCBhbmQgcmVwbGFjZXMgY3JpdGVyaWEgb2JqZWN0cyB3aXRoIHRoZWlyIGNvcnJlc3BvbmRpbmcKICAgKiB2YWx1ZXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzb3J0LgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbXBhcmVyIFRoZSBmdW5jdGlvbiB0byBkZWZpbmUgc29ydCBvcmRlci4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYGFycmF5YC4KICAgKi8KICBmdW5jdGlvbiBiYXNlU29ydEJ5KGFycmF5LCBjb21wYXJlcikgewogICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICBhcnJheS5zb3J0KGNvbXBhcmVyKTsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICBhcnJheVtsZW5ndGhdID0gYXJyYXlbbGVuZ3RoXS52YWx1ZTsKICAgIH0KICAgIHJldHVybiBhcnJheTsKICB9CgogIC8qKgogICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnN1bWAgYW5kIGBfLnN1bUJ5YCB3aXRob3V0IHN1cHBvcnQgZm9yCiAgICogaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRlZSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIHN1bS4KICAgKi8KICBmdW5jdGlvbiBiYXNlU3VtKGFycmF5LCBpdGVyYXRlZSkgewogICAgdmFyIHJlc3VsdCwKICAgICAgICBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgY3VycmVudCA9IGl0ZXJhdGVlKGFycmF5W2luZGV4XSk7CiAgICAgIGlmIChjdXJyZW50ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXN1bHQgPSByZXN1bHQgPT09IHVuZGVmaW5lZCA/IGN1cnJlbnQgOiAocmVzdWx0ICsgY3VycmVudCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy50aW1lc2Agd2l0aG91dCBzdXBwb3J0IGZvciBpdGVyYXRlZSBzaG9ydGhhbmRzCiAgICogb3IgbWF4IGFycmF5IGxlbmd0aCBjaGVja3MuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgdGltZXMgdG8gaW52b2tlIGBpdGVyYXRlZWAuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0ZWUgVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGFycmF5IG9mIHJlc3VsdHMuCiAgICovCiAgZnVuY3Rpb24gYmFzZVRpbWVzKG4sIGl0ZXJhdGVlKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICByZXN1bHQgPSBBcnJheShuKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IG4pIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IGl0ZXJhdGVlKGluZGV4KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy50b1BhaXJzYCBhbmQgYF8udG9QYWlyc0luYCB3aGljaCBjcmVhdGVzIGFuIGFycmF5CiAgICogb2Yga2V5LXZhbHVlIHBhaXJzIGZvciBgb2JqZWN0YCBjb3JyZXNwb25kaW5nIHRvIHRoZSBwcm9wZXJ0eSBuYW1lcyBvZiBgcHJvcHNgLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtBcnJheX0gcHJvcHMgVGhlIHByb3BlcnR5IG5hbWVzIHRvIGdldCB2YWx1ZXMgZm9yLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGtleS12YWx1ZSBwYWlycy4KICAgKi8KICBmdW5jdGlvbiBiYXNlVG9QYWlycyhvYmplY3QsIHByb3BzKSB7CiAgICByZXR1cm4gYXJyYXlNYXAocHJvcHMsIGZ1bmN0aW9uKGtleSkgewogICAgICByZXR1cm4gW2tleSwgb2JqZWN0W2tleV1dOwogICAgfSk7CiAgfQoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy51bmFyeWAgd2l0aG91dCBzdXBwb3J0IGZvciBzdG9yaW5nIG1ldGFkYXRhLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBjYXAgYXJndW1lbnRzIGZvci4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBjYXBwZWQgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gYmFzZVVuYXJ5KGZ1bmMpIHsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gZnVuYyh2YWx1ZSk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8udmFsdWVzYCBhbmQgYF8udmFsdWVzSW5gIHdoaWNoIGNyZWF0ZXMgYW4KICAgKiBhcnJheSBvZiBgb2JqZWN0YCBwcm9wZXJ0eSB2YWx1ZXMgY29ycmVzcG9uZGluZyB0byB0aGUgcHJvcGVydHkgbmFtZXMKICAgKiBvZiBgcHJvcHNgLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtBcnJheX0gcHJvcHMgVGhlIHByb3BlcnR5IG5hbWVzIHRvIGdldCB2YWx1ZXMgZm9yLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGFycmF5IG9mIHByb3BlcnR5IHZhbHVlcy4KICAgKi8KICBmdW5jdGlvbiBiYXNlVmFsdWVzKG9iamVjdCwgcHJvcHMpIHsKICAgIHJldHVybiBhcnJheU1hcChwcm9wcywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIHJldHVybiBvYmplY3Rba2V5XTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgYGNhY2hlYCB2YWx1ZSBmb3IgYGtleWAgZXhpc3RzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gY2FjaGUgVGhlIGNhY2hlIHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgZW50cnkgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFuIGVudHJ5IGZvciBga2V5YCBleGlzdHMsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBjYWNoZUhhcyhjYWNoZSwga2V5KSB7CiAgICByZXR1cm4gY2FjaGUuaGFzKGtleSk7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBfLnRyaW1gIGFuZCBgXy50cmltU3RhcnRgIHRvIGdldCB0aGUgaW5kZXggb2YgdGhlIGZpcnN0IHN0cmluZyBzeW1ib2wKICAgKiB0aGF0IGlzIG5vdCBmb3VuZCBpbiB0aGUgY2hhcmFjdGVyIHN5bWJvbHMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IHN0clN5bWJvbHMgVGhlIHN0cmluZyBzeW1ib2xzIHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHtBcnJheX0gY2hyU3ltYm9scyBUaGUgY2hhcmFjdGVyIHN5bWJvbHMgdG8gZmluZC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZmlyc3QgdW5tYXRjaGVkIHN0cmluZyBzeW1ib2wuCiAgICovCiAgZnVuY3Rpb24gY2hhcnNTdGFydEluZGV4KHN0clN5bWJvbHMsIGNoclN5bWJvbHMpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IHN0clN5bWJvbHMubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoICYmIGJhc2VJbmRleE9mKGNoclN5bWJvbHMsIHN0clN5bWJvbHNbaW5kZXhdLCAwKSA+IC0xKSB7fQogICAgcmV0dXJuIGluZGV4OwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgXy50cmltYCBhbmQgYF8udHJpbUVuZGAgdG8gZ2V0IHRoZSBpbmRleCBvZiB0aGUgbGFzdCBzdHJpbmcgc3ltYm9sCiAgICogdGhhdCBpcyBub3QgZm91bmQgaW4gdGhlIGNoYXJhY3RlciBzeW1ib2xzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBzdHJTeW1ib2xzIFRoZSBzdHJpbmcgc3ltYm9scyB0byBpbnNwZWN0LgogICAqIEBwYXJhbSB7QXJyYXl9IGNoclN5bWJvbHMgVGhlIGNoYXJhY3RlciBzeW1ib2xzIHRvIGZpbmQuCiAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIGxhc3QgdW5tYXRjaGVkIHN0cmluZyBzeW1ib2wuCiAgICovCiAgZnVuY3Rpb24gY2hhcnNFbmRJbmRleChzdHJTeW1ib2xzLCBjaHJTeW1ib2xzKSB7CiAgICB2YXIgaW5kZXggPSBzdHJTeW1ib2xzLmxlbmd0aDsKCiAgICB3aGlsZSAoaW5kZXgtLSAmJiBiYXNlSW5kZXhPZihjaHJTeW1ib2xzLCBzdHJTeW1ib2xzW2luZGV4XSwgMCkgPiAtMSkge30KICAgIHJldHVybiBpbmRleDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIG51bWJlciBvZiBgcGxhY2Vob2xkZXJgIG9jY3VycmVuY2VzIGluIGBhcnJheWAuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAqIEBwYXJhbSB7Kn0gcGxhY2Vob2xkZXIgVGhlIHBsYWNlaG9sZGVyIHRvIHNlYXJjaCBmb3IuCiAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgcGxhY2Vob2xkZXIgY291bnQuCiAgICovCiAgZnVuY3Rpb24gY291bnRIb2xkZXJzKGFycmF5LCBwbGFjZWhvbGRlcikgewogICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICByZXN1bHQgPSAwOwoKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICBpZiAoYXJyYXlbbGVuZ3RoXSA9PT0gcGxhY2Vob2xkZXIpIHsKICAgICAgICArK3Jlc3VsdDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYF8uZGVidXJyYCB0byBjb252ZXJ0IExhdGluLTEgU3VwcGxlbWVudCBhbmQgTGF0aW4gRXh0ZW5kZWQtQQogICAqIGxldHRlcnMgdG8gYmFzaWMgTGF0aW4gbGV0dGVycy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IGxldHRlciBUaGUgbWF0Y2hlZCBsZXR0ZXIgdG8gZGVidXJyLgogICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGRlYnVycmVkIGxldHRlci4KICAgKi8KICB2YXIgZGVidXJyTGV0dGVyID0gYmFzZVByb3BlcnR5T2YoZGVidXJyZWRMZXR0ZXJzKTsKCiAgLyoqCiAgICogVXNlZCBieSBgXy5lc2NhcGVgIHRvIGNvbnZlcnQgY2hhcmFjdGVycyB0byBIVE1MIGVudGl0aWVzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gY2hyIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBjaGFyYWN0ZXIuCiAgICovCiAgdmFyIGVzY2FwZUh0bWxDaGFyID0gYmFzZVByb3BlcnR5T2YoaHRtbEVzY2FwZXMpOwoKICAvKioKICAgKiBVc2VkIGJ5IGBfLnRlbXBsYXRlYCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IGNociBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gZXNjYXBlLgogICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZVN0cmluZ0NoYXIoY2hyKSB7CiAgICByZXR1cm4gJ1xcJyArIHN0cmluZ0VzY2FwZXNbY2hyXTsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIHZhbHVlIGF0IGBrZXlgIG9mIGBvYmplY3RgLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gW29iamVjdF0gVGhlIG9iamVjdCB0byBxdWVyeS4KICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHByb3BlcnR5IHRvIGdldC4KICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgcHJvcGVydHkgdmFsdWUuCiAgICovCiAgZnVuY3Rpb24gZ2V0VmFsdWUob2JqZWN0LCBrZXkpIHsKICAgIHJldHVybiBvYmplY3QgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IG9iamVjdFtrZXldOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGBzdHJpbmdgIGNvbnRhaW5zIFVuaWNvZGUgc3ltYm9scy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBUaGUgc3RyaW5nIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGEgc3ltYm9sIGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICovCiAgZnVuY3Rpb24gaGFzVW5pY29kZShzdHJpbmcpIHsKICAgIHJldHVybiByZUhhc1VuaWNvZGUudGVzdChzdHJpbmcpOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGBzdHJpbmdgIGNvbnRhaW5zIGEgd29yZCBjb21wb3NlZCBvZiBVbmljb2RlIHN5bWJvbHMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhIHdvcmQgaXMgZm91bmQsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBoYXNVbmljb2RlV29yZChzdHJpbmcpIHsKICAgIHJldHVybiByZUhhc1VuaWNvZGVXb3JkLnRlc3Qoc3RyaW5nKTsKICB9CgogIC8qKgogICAqIENvbnZlcnRzIGBpdGVyYXRvcmAgdG8gYW4gYXJyYXkuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBpdGVyYXRvciBUaGUgaXRlcmF0b3IgdG8gY29udmVydC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGNvbnZlcnRlZCBhcnJheS4KICAgKi8KICBmdW5jdGlvbiBpdGVyYXRvclRvQXJyYXkoaXRlcmF0b3IpIHsKICAgIHZhciBkYXRhLAogICAgICAgIHJlc3VsdCA9IFtdOwoKICAgIHdoaWxlICghKGRhdGEgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgcmVzdWx0LnB1c2goZGF0YS52YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ29udmVydHMgYG1hcGAgdG8gaXRzIGtleS12YWx1ZSBwYWlycy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IG1hcCBUaGUgbWFwIHRvIGNvbnZlcnQuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBrZXktdmFsdWUgcGFpcnMuCiAgICovCiAgZnVuY3Rpb24gbWFwVG9BcnJheShtYXApIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHJlc3VsdCA9IEFycmF5KG1hcC5zaXplKTsKCiAgICBtYXAuZm9yRWFjaChmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIHJlc3VsdFsrK2luZGV4XSA9IFtrZXksIHZhbHVlXTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSB1bmFyeSBmdW5jdGlvbiB0aGF0IGludm9rZXMgYGZ1bmNgIHdpdGggaXRzIGFyZ3VtZW50IHRyYW5zZm9ybWVkLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byB3cmFwLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IHRyYW5zZm9ybSBUaGUgYXJndW1lbnQgdHJhbnNmb3JtLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIG92ZXJBcmcoZnVuYywgdHJhbnNmb3JtKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oYXJnKSB7CiAgICAgIHJldHVybiBmdW5jKHRyYW5zZm9ybShhcmcpKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBSZXBsYWNlcyBhbGwgYHBsYWNlaG9sZGVyYCBlbGVtZW50cyBpbiBgYXJyYXlgIHdpdGggYW4gaW50ZXJuYWwgcGxhY2Vob2xkZXIKICAgKiBhbmQgcmV0dXJucyBhbiBhcnJheSBvZiB0aGVpciBpbmRleGVzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gbW9kaWZ5LgogICAqIEBwYXJhbSB7Kn0gcGxhY2Vob2xkZXIgVGhlIHBsYWNlaG9sZGVyIHRvIHJlcGxhY2UuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgYXJyYXkgb2YgcGxhY2Vob2xkZXIgaW5kZXhlcy4KICAgKi8KICBmdW5jdGlvbiByZXBsYWNlSG9sZGVycyhhcnJheSwgcGxhY2Vob2xkZXIpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICByZXNJbmRleCA9IDAsCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAodmFsdWUgPT09IHBsYWNlaG9sZGVyIHx8IHZhbHVlID09PSBQTEFDRUhPTERFUikgewogICAgICAgIGFycmF5W2luZGV4XSA9IFBMQUNFSE9MREVSOwogICAgICAgIHJlc3VsdFtyZXNJbmRleCsrXSA9IGluZGV4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ29udmVydHMgYHNldGAgdG8gYW4gYXJyYXkgb2YgaXRzIHZhbHVlcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IHNldCBUaGUgc2V0IHRvIGNvbnZlcnQuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSB2YWx1ZXMuCiAgICovCiAgZnVuY3Rpb24gc2V0VG9BcnJheShzZXQpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHJlc3VsdCA9IEFycmF5KHNldC5zaXplKTsKCiAgICBzZXQuZm9yRWFjaChmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXN1bHRbKytpbmRleF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENvbnZlcnRzIGBzZXRgIHRvIGl0cyB2YWx1ZS12YWx1ZSBwYWlycy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IHNldCBUaGUgc2V0IHRvIGNvbnZlcnQuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSB2YWx1ZS12YWx1ZSBwYWlycy4KICAgKi8KICBmdW5jdGlvbiBzZXRUb1BhaXJzKHNldCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkoc2V0LnNpemUpOwoKICAgIHNldC5mb3JFYWNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJlc3VsdFsrK2luZGV4XSA9IFt2YWx1ZSwgdmFsdWVdOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQSBzcGVjaWFsaXplZCB2ZXJzaW9uIG9mIGBfLmluZGV4T2ZgIHdoaWNoIHBlcmZvcm1zIHN0cmljdCBlcXVhbGl0eQogICAqIGNvbXBhcmlzb25zIG9mIHZhbHVlcywgaS5lLiBgPT09YC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge251bWJlcn0gZnJvbUluZGV4IFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSwgZWxzZSBgLTFgLgogICAqLwogIGZ1bmN0aW9uIHN0cmljdEluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIHZhciBpbmRleCA9IGZyb21JbmRleCAtIDEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmIChhcnJheVtpbmRleF0gPT09IHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICAvKioKICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYF8ubGFzdEluZGV4T2ZgIHdoaWNoIHBlcmZvcm1zIHN0cmljdCBlcXVhbGl0eQogICAqIGNvbXBhcmlzb25zIG9mIHZhbHVlcywgaS5lLiBgPT09YC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge251bWJlcn0gZnJvbUluZGV4IFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSwgZWxzZSBgLTFgLgogICAqLwogIGZ1bmN0aW9uIHN0cmljdExhc3RJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSBmcm9tSW5kZXggKyAxOwogICAgd2hpbGUgKGluZGV4LS0pIHsKICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpbmRleDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIG51bWJlciBvZiBzeW1ib2xzIGluIGBzdHJpbmdgLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBzdHJpbmcgc2l6ZS4KICAgKi8KICBmdW5jdGlvbiBzdHJpbmdTaXplKHN0cmluZykgewogICAgcmV0dXJuIGhhc1VuaWNvZGUoc3RyaW5nKQogICAgICA/IHVuaWNvZGVTaXplKHN0cmluZykKICAgICAgOiBhc2NpaVNpemUoc3RyaW5nKTsKICB9CgogIC8qKgogICAqIENvbnZlcnRzIGBzdHJpbmdgIHRvIGFuIGFycmF5LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gY29udmVydC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGNvbnZlcnRlZCBhcnJheS4KICAgKi8KICBmdW5jdGlvbiBzdHJpbmdUb0FycmF5KHN0cmluZykgewogICAgcmV0dXJuIGhhc1VuaWNvZGUoc3RyaW5nKQogICAgICA/IHVuaWNvZGVUb0FycmF5KHN0cmluZykKICAgICAgOiBhc2NpaVRvQXJyYXkoc3RyaW5nKTsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYF8udW5lc2NhcGVgIHRvIGNvbnZlcnQgSFRNTCBlbnRpdGllcyB0byBjaGFyYWN0ZXJzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gY2hyIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byB1bmVzY2FwZS4KICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgY2hhcmFjdGVyLgogICAqLwogIHZhciB1bmVzY2FwZUh0bWxDaGFyID0gYmFzZVByb3BlcnR5T2YoaHRtbFVuZXNjYXBlcyk7CgogIC8qKgogICAqIEdldHMgdGhlIHNpemUgb2YgYSBVbmljb2RlIGBzdHJpbmdgLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBzdHJpbmcgc2l6ZS4KICAgKi8KICBmdW5jdGlvbiB1bmljb2RlU2l6ZShzdHJpbmcpIHsKICAgIHZhciByZXN1bHQgPSByZVVuaWNvZGUubGFzdEluZGV4ID0gMDsKICAgIHdoaWxlIChyZVVuaWNvZGUudGVzdChzdHJpbmcpKSB7CiAgICAgICsrcmVzdWx0OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENvbnZlcnRzIGEgVW5pY29kZSBgc3RyaW5nYCB0byBhbiBhcnJheS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBUaGUgc3RyaW5nIHRvIGNvbnZlcnQuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBjb252ZXJ0ZWQgYXJyYXkuCiAgICovCiAgZnVuY3Rpb24gdW5pY29kZVRvQXJyYXkoc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nLm1hdGNoKHJlVW5pY29kZSkgfHwgW107CiAgfQoKICAvKioKICAgKiBTcGxpdHMgYSBVbmljb2RlIGBzdHJpbmdgIGludG8gYW4gYXJyYXkgb2YgaXRzIHdvcmRzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gVGhlIHN0cmluZyB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgd29yZHMgb2YgYHN0cmluZ2AuCiAgICovCiAgZnVuY3Rpb24gdW5pY29kZVdvcmRzKHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZy5tYXRjaChyZVVuaWNvZGVXb3JkKSB8fCBbXTsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgcHJpc3RpbmUgYGxvZGFzaGAgZnVuY3Rpb24gdXNpbmcgdGhlIGBjb250ZXh0YCBvYmplY3QuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAc2luY2UgMS4xLjAKICAgKiBAY2F0ZWdvcnkgVXRpbAogICAqIEBwYXJhbSB7T2JqZWN0fSBbY29udGV4dD1yb290XSBUaGUgY29udGV4dCBvYmplY3QuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIGEgbmV3IGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm1peGluKHsgJ2Zvbyc6IF8uY29uc3RhbnQoJ2ZvbycpIH0pOwogICAqCiAgICogdmFyIGxvZGFzaCA9IF8ucnVuSW5Db250ZXh0KCk7CiAgICogbG9kYXNoLm1peGluKHsgJ2Jhcic6IGxvZGFzaC5jb25zdGFudCgnYmFyJykgfSk7CiAgICoKICAgKiBfLmlzRnVuY3Rpb24oXy5mb28pOwogICAqIC8vID0+IHRydWUKICAgKiBfLmlzRnVuY3Rpb24oXy5iYXIpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBsb2Rhc2guaXNGdW5jdGlvbihsb2Rhc2guZm9vKTsKICAgKiAvLyA9PiBmYWxzZQogICAqIGxvZGFzaC5pc0Z1bmN0aW9uKGxvZGFzaC5iYXIpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIC8vIENyZWF0ZSBhIHN1cGVkLXVwIGBkZWZlcmAgaW4gTm9kZS5qcy4KICAgKiB2YXIgZGVmZXIgPSBfLnJ1bkluQ29udGV4dCh7ICdzZXRUaW1lb3V0Jzogc2V0SW1tZWRpYXRlIH0pLmRlZmVyOwogICAqLwogIHZhciBydW5JbkNvbnRleHQgPSAoZnVuY3Rpb24gcnVuSW5Db250ZXh0KGNvbnRleHQpIHsKICAgIGNvbnRleHQgPSBjb250ZXh0ID09IG51bGwgPyByb290IDogXy5kZWZhdWx0cyhyb290Lk9iamVjdCgpLCBjb250ZXh0LCBfLnBpY2socm9vdCwgY29udGV4dFByb3BzKSk7CgogICAgLyoqIEJ1aWx0LWluIGNvbnN0cnVjdG9yIHJlZmVyZW5jZXMuICovCiAgICB2YXIgQXJyYXkgPSBjb250ZXh0LkFycmF5LAogICAgICAgIERhdGUgPSBjb250ZXh0LkRhdGUsCiAgICAgICAgRXJyb3IgPSBjb250ZXh0LkVycm9yLAogICAgICAgIEZ1bmN0aW9uID0gY29udGV4dC5GdW5jdGlvbiwKICAgICAgICBNYXRoID0gY29udGV4dC5NYXRoLAogICAgICAgIE9iamVjdCA9IGNvbnRleHQuT2JqZWN0LAogICAgICAgIFJlZ0V4cCA9IGNvbnRleHQuUmVnRXhwLAogICAgICAgIFN0cmluZyA9IGNvbnRleHQuU3RyaW5nLAogICAgICAgIFR5cGVFcnJvciA9IGNvbnRleHQuVHlwZUVycm9yOwoKICAgIC8qKiBVc2VkIGZvciBidWlsdC1pbiBtZXRob2QgcmVmZXJlbmNlcy4gKi8KICAgIHZhciBhcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLAogICAgICAgIGZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZSwKICAgICAgICBvYmplY3RQcm90byA9IE9iamVjdC5wcm90b3R5cGU7CgogICAgLyoqIFVzZWQgdG8gZGV0ZWN0IG92ZXJyZWFjaGluZyBjb3JlLWpzIHNoaW1zLiAqLwogICAgdmFyIGNvcmVKc0RhdGEgPSBjb250ZXh0WydfX2NvcmUtanNfc2hhcmVkX18nXTsKCiAgICAvKiogVXNlZCB0byByZXNvbHZlIHRoZSBkZWNvbXBpbGVkIHNvdXJjZSBvZiBmdW5jdGlvbnMuICovCiAgICB2YXIgZnVuY1RvU3RyaW5nID0gZnVuY1Byb3RvLnRvU3RyaW5nOwoKICAgIC8qKiBVc2VkIHRvIGNoZWNrIG9iamVjdHMgZm9yIG93biBwcm9wZXJ0aWVzLiAqLwogICAgdmFyIGhhc093blByb3BlcnR5ID0gb2JqZWN0UHJvdG8uaGFzT3duUHJvcGVydHk7CgogICAgLyoqIFVzZWQgdG8gZ2VuZXJhdGUgdW5pcXVlIElEcy4gKi8KICAgIHZhciBpZENvdW50ZXIgPSAwOwoKICAgIC8qKiBVc2VkIHRvIGRldGVjdCBtZXRob2RzIG1hc3F1ZXJhZGluZyBhcyBuYXRpdmUuICovCiAgICB2YXIgbWFza1NyY0tleSA9IChmdW5jdGlvbigpIHsKICAgICAgdmFyIHVpZCA9IC9bXi5dKyQvLmV4ZWMoY29yZUpzRGF0YSAmJiBjb3JlSnNEYXRhLmtleXMgJiYgY29yZUpzRGF0YS5rZXlzLklFX1BST1RPIHx8ICcnKTsKICAgICAgcmV0dXJuIHVpZCA/ICgnU3ltYm9sKHNyYylfMS4nICsgdWlkKSA6ICcnOwogICAgfSgpKTsKCiAgICAvKioKICAgICAqIFVzZWQgdG8gcmVzb2x2ZSB0aGUKICAgICAqIFtgdG9TdHJpbmdUYWdgXShodHRwOi8vZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy1vYmplY3QucHJvdG90eXBlLnRvc3RyaW5nKQogICAgICogb2YgdmFsdWVzLgogICAgICovCiAgICB2YXIgbmF0aXZlT2JqZWN0VG9TdHJpbmcgPSBvYmplY3RQcm90by50b1N0cmluZzsKCiAgICAvKiogVXNlZCB0byBpbmZlciB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IuICovCiAgICB2YXIgb2JqZWN0Q3RvclN0cmluZyA9IGZ1bmNUb1N0cmluZy5jYWxsKE9iamVjdCk7CgogICAgLyoqIFVzZWQgdG8gcmVzdG9yZSB0aGUgb3JpZ2luYWwgYF9gIHJlZmVyZW5jZSBpbiBgXy5ub0NvbmZsaWN0YC4gKi8KICAgIHZhciBvbGREYXNoID0gcm9vdC5fOwoKICAgIC8qKiBVc2VkIHRvIGRldGVjdCBpZiBhIG1ldGhvZCBpcyBuYXRpdmUuICovCiAgICB2YXIgcmVJc05hdGl2ZSA9IFJlZ0V4cCgnXicgKwogICAgICBmdW5jVG9TdHJpbmcuY2FsbChoYXNPd25Qcm9wZXJ0eSkucmVwbGFjZShyZVJlZ0V4cENoYXIsICdcXCQmJykKICAgICAgLnJlcGxhY2UoL2hhc093blByb3BlcnR5fChmdW5jdGlvbikuKj8oPz1cXFwoKXwgZm9yIC4rPyg/PVxcXF0pL2csICckMS4qPycpICsgJyQnCiAgICApOwoKICAgIC8qKiBCdWlsdC1pbiB2YWx1ZSByZWZlcmVuY2VzLiAqLwogICAgdmFyIEJ1ZmZlciA9IG1vZHVsZUV4cG9ydHMgPyBjb250ZXh0LkJ1ZmZlciA6IHVuZGVmaW5lZCwKICAgICAgICBTeW1ib2wgPSBjb250ZXh0LlN5bWJvbCwKICAgICAgICBVaW50OEFycmF5ID0gY29udGV4dC5VaW50OEFycmF5LAogICAgICAgIGFsbG9jVW5zYWZlID0gQnVmZmVyID8gQnVmZmVyLmFsbG9jVW5zYWZlIDogdW5kZWZpbmVkLAogICAgICAgIGdldFByb3RvdHlwZSA9IG92ZXJBcmcoT2JqZWN0LmdldFByb3RvdHlwZU9mLCBPYmplY3QpLAogICAgICAgIG9iamVjdENyZWF0ZSA9IE9iamVjdC5jcmVhdGUsCiAgICAgICAgcHJvcGVydHlJc0VudW1lcmFibGUgPSBvYmplY3RQcm90by5wcm9wZXJ0eUlzRW51bWVyYWJsZSwKICAgICAgICBzcGxpY2UgPSBhcnJheVByb3RvLnNwbGljZSwKICAgICAgICBzcHJlYWRhYmxlU3ltYm9sID0gU3ltYm9sID8gU3ltYm9sLmlzQ29uY2F0U3ByZWFkYWJsZSA6IHVuZGVmaW5lZCwKICAgICAgICBzeW1JdGVyYXRvciA9IFN5bWJvbCA/IFN5bWJvbC5pdGVyYXRvciA6IHVuZGVmaW5lZCwKICAgICAgICBzeW1Ub1N0cmluZ1RhZyA9IFN5bWJvbCA/IFN5bWJvbC50b1N0cmluZ1RhZyA6IHVuZGVmaW5lZDsKCiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSAoZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIGZ1bmMgPSBnZXROYXRpdmUoT2JqZWN0LCAnZGVmaW5lUHJvcGVydHknKTsKICAgICAgICBmdW5jKHt9LCAnJywge30pOwogICAgICAgIHJldHVybiBmdW5jOwogICAgICB9IGNhdGNoIChlKSB7fQogICAgfSgpKTsKCiAgICAvKiogTW9ja2VkIGJ1aWx0LWlucy4gKi8KICAgIHZhciBjdHhDbGVhclRpbWVvdXQgPSBjb250ZXh0LmNsZWFyVGltZW91dCAhPT0gcm9vdC5jbGVhclRpbWVvdXQgJiYgY29udGV4dC5jbGVhclRpbWVvdXQsCiAgICAgICAgY3R4Tm93ID0gRGF0ZSAmJiBEYXRlLm5vdyAhPT0gcm9vdC5EYXRlLm5vdyAmJiBEYXRlLm5vdywKICAgICAgICBjdHhTZXRUaW1lb3V0ID0gY29udGV4dC5zZXRUaW1lb3V0ICE9PSByb290LnNldFRpbWVvdXQgJiYgY29udGV4dC5zZXRUaW1lb3V0OwoKICAgIC8qIEJ1aWx0LWluIG1ldGhvZCByZWZlcmVuY2VzIGZvciB0aG9zZSB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgb3RoZXIgYGxvZGFzaGAgbWV0aG9kcy4gKi8KICAgIHZhciBuYXRpdmVDZWlsID0gTWF0aC5jZWlsLAogICAgICAgIG5hdGl2ZUZsb29yID0gTWF0aC5mbG9vciwKICAgICAgICBuYXRpdmVHZXRTeW1ib2xzID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scywKICAgICAgICBuYXRpdmVJc0J1ZmZlciA9IEJ1ZmZlciA/IEJ1ZmZlci5pc0J1ZmZlciA6IHVuZGVmaW5lZCwKICAgICAgICBuYXRpdmVJc0Zpbml0ZSA9IGNvbnRleHQuaXNGaW5pdGUsCiAgICAgICAgbmF0aXZlSm9pbiA9IGFycmF5UHJvdG8uam9pbiwKICAgICAgICBuYXRpdmVLZXlzID0gb3ZlckFyZyhPYmplY3Qua2V5cywgT2JqZWN0KSwKICAgICAgICBuYXRpdmVNYXggPSBNYXRoLm1heCwKICAgICAgICBuYXRpdmVNaW4gPSBNYXRoLm1pbiwKICAgICAgICBuYXRpdmVOb3cgPSBEYXRlLm5vdywKICAgICAgICBuYXRpdmVQYXJzZUludCA9IGNvbnRleHQucGFyc2VJbnQsCiAgICAgICAgbmF0aXZlUmFuZG9tID0gTWF0aC5yYW5kb20sCiAgICAgICAgbmF0aXZlUmV2ZXJzZSA9IGFycmF5UHJvdG8ucmV2ZXJzZTsKCiAgICAvKiBCdWlsdC1pbiBtZXRob2QgcmVmZXJlbmNlcyB0aGF0IGFyZSB2ZXJpZmllZCB0byBiZSBuYXRpdmUuICovCiAgICB2YXIgRGF0YVZpZXcgPSBnZXROYXRpdmUoY29udGV4dCwgJ0RhdGFWaWV3JyksCiAgICAgICAgTWFwID0gZ2V0TmF0aXZlKGNvbnRleHQsICdNYXAnKSwKICAgICAgICBQcm9taXNlID0gZ2V0TmF0aXZlKGNvbnRleHQsICdQcm9taXNlJyksCiAgICAgICAgU2V0ID0gZ2V0TmF0aXZlKGNvbnRleHQsICdTZXQnKSwKICAgICAgICBXZWFrTWFwID0gZ2V0TmF0aXZlKGNvbnRleHQsICdXZWFrTWFwJyksCiAgICAgICAgbmF0aXZlQ3JlYXRlID0gZ2V0TmF0aXZlKE9iamVjdCwgJ2NyZWF0ZScpOwoKICAgIC8qKiBVc2VkIHRvIHN0b3JlIGZ1bmN0aW9uIG1ldGFkYXRhLiAqLwogICAgdmFyIG1ldGFNYXAgPSBXZWFrTWFwICYmIG5ldyBXZWFrTWFwOwoKICAgIC8qKiBVc2VkIHRvIGxvb2t1cCB1bm1pbmlmaWVkIGZ1bmN0aW9uIG5hbWVzLiAqLwogICAgdmFyIHJlYWxOYW1lcyA9IHt9OwoKICAgIC8qKiBVc2VkIHRvIGRldGVjdCBtYXBzLCBzZXRzLCBhbmQgd2Vha21hcHMuICovCiAgICB2YXIgZGF0YVZpZXdDdG9yU3RyaW5nID0gdG9Tb3VyY2UoRGF0YVZpZXcpLAogICAgICAgIG1hcEN0b3JTdHJpbmcgPSB0b1NvdXJjZShNYXApLAogICAgICAgIHByb21pc2VDdG9yU3RyaW5nID0gdG9Tb3VyY2UoUHJvbWlzZSksCiAgICAgICAgc2V0Q3RvclN0cmluZyA9IHRvU291cmNlKFNldCksCiAgICAgICAgd2Vha01hcEN0b3JTdHJpbmcgPSB0b1NvdXJjZShXZWFrTWFwKTsKCiAgICAvKiogVXNlZCB0byBjb252ZXJ0IHN5bWJvbHMgdG8gcHJpbWl0aXZlcyBhbmQgc3RyaW5ncy4gKi8KICAgIHZhciBzeW1ib2xQcm90byA9IFN5bWJvbCA/IFN5bWJvbC5wcm90b3R5cGUgOiB1bmRlZmluZWQsCiAgICAgICAgc3ltYm9sVmFsdWVPZiA9IHN5bWJvbFByb3RvID8gc3ltYm9sUHJvdG8udmFsdWVPZiA6IHVuZGVmaW5lZCwKICAgICAgICBzeW1ib2xUb1N0cmluZyA9IHN5bWJvbFByb3RvID8gc3ltYm9sUHJvdG8udG9TdHJpbmcgOiB1bmRlZmluZWQ7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGBsb2Rhc2hgIG9iamVjdCB3aGljaCB3cmFwcyBgdmFsdWVgIHRvIGVuYWJsZSBpbXBsaWNpdCBtZXRob2QKICAgICAqIGNoYWluIHNlcXVlbmNlcy4gTWV0aG9kcyB0aGF0IG9wZXJhdGUgb24gYW5kIHJldHVybiBhcnJheXMsIGNvbGxlY3Rpb25zLAogICAgICogYW5kIGZ1bmN0aW9ucyBjYW4gYmUgY2hhaW5lZCB0b2dldGhlci4gTWV0aG9kcyB0aGF0IHJldHJpZXZlIGEgc2luZ2xlIHZhbHVlCiAgICAgKiBvciBtYXkgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlIHdpbGwgYXV0b21hdGljYWxseSBlbmQgdGhlIGNoYWluIHNlcXVlbmNlCiAgICAgKiBhbmQgcmV0dXJuIHRoZSB1bndyYXBwZWQgdmFsdWUuIE90aGVyd2lzZSwgdGhlIHZhbHVlIG11c3QgYmUgdW53cmFwcGVkCiAgICAgKiB3aXRoIGBfI3ZhbHVlYC4KICAgICAqCiAgICAgKiBFeHBsaWNpdCBjaGFpbiBzZXF1ZW5jZXMsIHdoaWNoIG11c3QgYmUgdW53cmFwcGVkIHdpdGggYF8jdmFsdWVgLCBtYXkgYmUKICAgICAqIGVuYWJsZWQgdXNpbmcgYF8uY2hhaW5gLgogICAgICoKICAgICAqIFRoZSBleGVjdXRpb24gb2YgY2hhaW5lZCBtZXRob2RzIGlzIGxhenksIHRoYXQgaXMsIGl0J3MgZGVmZXJyZWQgdW50aWwKICAgICAqIGBfI3ZhbHVlYCBpcyBpbXBsaWNpdGx5IG9yIGV4cGxpY2l0bHkgY2FsbGVkLgogICAgICoKICAgICAqIExhenkgZXZhbHVhdGlvbiBhbGxvd3Mgc2V2ZXJhbCBtZXRob2RzIHRvIHN1cHBvcnQgc2hvcnRjdXQgZnVzaW9uLgogICAgICogU2hvcnRjdXQgZnVzaW9uIGlzIGFuIG9wdGltaXphdGlvbiB0byBtZXJnZSBpdGVyYXRlZSBjYWxsczsgdGhpcyBhdm9pZHMKICAgICAqIHRoZSBjcmVhdGlvbiBvZiBpbnRlcm1lZGlhdGUgYXJyYXlzIGFuZCBjYW4gZ3JlYXRseSByZWR1Y2UgdGhlIG51bWJlciBvZgogICAgICogaXRlcmF0ZWUgZXhlY3V0aW9ucy4gU2VjdGlvbnMgb2YgYSBjaGFpbiBzZXF1ZW5jZSBxdWFsaWZ5IGZvciBzaG9ydGN1dAogICAgICogZnVzaW9uIGlmIHRoZSBzZWN0aW9uIGlzIGFwcGxpZWQgdG8gYW4gYXJyYXkgYW5kIGl0ZXJhdGVlcyBhY2NlcHQgb25seQogICAgICogb25lIGFyZ3VtZW50LiBUaGUgaGV1cmlzdGljIGZvciB3aGV0aGVyIGEgc2VjdGlvbiBxdWFsaWZpZXMgZm9yIHNob3J0Y3V0CiAgICAgKiBmdXNpb24gaXMgc3ViamVjdCB0byBjaGFuZ2UuCiAgICAgKgogICAgICogQ2hhaW5pbmcgaXMgc3VwcG9ydGVkIGluIGN1c3RvbSBidWlsZHMgYXMgbG9uZyBhcyB0aGUgYF8jdmFsdWVgIG1ldGhvZCBpcwogICAgICogZGlyZWN0bHkgb3IgaW5kaXJlY3RseSBpbmNsdWRlZCBpbiB0aGUgYnVpbGQuCiAgICAgKgogICAgICogSW4gYWRkaXRpb24gdG8gbG9kYXNoIG1ldGhvZHMsIHdyYXBwZXJzIGhhdmUgYEFycmF5YCBhbmQgYFN0cmluZ2AgbWV0aG9kcy4KICAgICAqCiAgICAgKiBUaGUgd3JhcHBlciBgQXJyYXlgIG1ldGhvZHMgYXJlOgogICAgICogYGNvbmNhdGAsIGBqb2luYCwgYHBvcGAsIGBwdXNoYCwgYHNoaWZ0YCwgYHNvcnRgLCBgc3BsaWNlYCwgYW5kIGB1bnNoaWZ0YAogICAgICoKICAgICAqIFRoZSB3cmFwcGVyIGBTdHJpbmdgIG1ldGhvZHMgYXJlOgogICAgICogYHJlcGxhY2VgIGFuZCBgc3BsaXRgCiAgICAgKgogICAgICogVGhlIHdyYXBwZXIgbWV0aG9kcyB0aGF0IHN1cHBvcnQgc2hvcnRjdXQgZnVzaW9uIGFyZToKICAgICAqIGBhdGAsIGBjb21wYWN0YCwgYGRyb3BgLCBgZHJvcFJpZ2h0YCwgYGRyb3BXaGlsZWAsIGBmaWx0ZXJgLCBgZmluZGAsCiAgICAgKiBgZmluZExhc3RgLCBgaGVhZGAsIGBpbml0aWFsYCwgYGxhc3RgLCBgbWFwYCwgYHJlamVjdGAsIGByZXZlcnNlYCwgYHNsaWNlYCwKICAgICAqIGB0YWlsYCwgYHRha2VgLCBgdGFrZVJpZ2h0YCwgYHRha2VSaWdodFdoaWxlYCwgYHRha2VXaGlsZWAsIGFuZCBgdG9BcnJheWAKICAgICAqCiAgICAgKiBUaGUgY2hhaW5hYmxlIHdyYXBwZXIgbWV0aG9kcyBhcmU6CiAgICAgKiBgYWZ0ZXJgLCBgYXJ5YCwgYGFzc2lnbmAsIGBhc3NpZ25JbmAsIGBhc3NpZ25JbldpdGhgLCBgYXNzaWduV2l0aGAsIGBhdGAsCiAgICAgKiBgYmVmb3JlYCwgYGJpbmRgLCBgYmluZEFsbGAsIGBiaW5kS2V5YCwgYGNhc3RBcnJheWAsIGBjaGFpbmAsIGBjaHVua2AsCiAgICAgKiBgY29tbWl0YCwgYGNvbXBhY3RgLCBgY29uY2F0YCwgYGNvbmZvcm1zYCwgYGNvbnN0YW50YCwgYGNvdW50QnlgLCBgY3JlYXRlYCwKICAgICAqIGBjdXJyeWAsIGBkZWJvdW5jZWAsIGBkZWZhdWx0c2AsIGBkZWZhdWx0c0RlZXBgLCBgZGVmZXJgLCBgZGVsYXlgLAogICAgICogYGRpZmZlcmVuY2VgLCBgZGlmZmVyZW5jZUJ5YCwgYGRpZmZlcmVuY2VXaXRoYCwgYGRyb3BgLCBgZHJvcFJpZ2h0YCwKICAgICAqIGBkcm9wUmlnaHRXaGlsZWAsIGBkcm9wV2hpbGVgLCBgZXh0ZW5kYCwgYGV4dGVuZFdpdGhgLCBgZmlsbGAsIGBmaWx0ZXJgLAogICAgICogYGZsYXRNYXBgLCBgZmxhdE1hcERlZXBgLCBgZmxhdE1hcERlcHRoYCwgYGZsYXR0ZW5gLCBgZmxhdHRlbkRlZXBgLAogICAgICogYGZsYXR0ZW5EZXB0aGAsIGBmbGlwYCwgYGZsb3dgLCBgZmxvd1JpZ2h0YCwgYGZyb21QYWlyc2AsIGBmdW5jdGlvbnNgLAogICAgICogYGZ1bmN0aW9uc0luYCwgYGdyb3VwQnlgLCBgaW5pdGlhbGAsIGBpbnRlcnNlY3Rpb25gLCBgaW50ZXJzZWN0aW9uQnlgLAogICAgICogYGludGVyc2VjdGlvbldpdGhgLCBgaW52ZXJ0YCwgYGludmVydEJ5YCwgYGludm9rZU1hcGAsIGBpdGVyYXRlZWAsIGBrZXlCeWAsCiAgICAgKiBga2V5c2AsIGBrZXlzSW5gLCBgbWFwYCwgYG1hcEtleXNgLCBgbWFwVmFsdWVzYCwgYG1hdGNoZXNgLCBgbWF0Y2hlc1Byb3BlcnR5YCwKICAgICAqIGBtZW1vaXplYCwgYG1lcmdlYCwgYG1lcmdlV2l0aGAsIGBtZXRob2RgLCBgbWV0aG9kT2ZgLCBgbWl4aW5gLCBgbmVnYXRlYCwKICAgICAqIGBudGhBcmdgLCBgb21pdGAsIGBvbWl0QnlgLCBgb25jZWAsIGBvcmRlckJ5YCwgYG92ZXJgLCBgb3ZlckFyZ3NgLAogICAgICogYG92ZXJFdmVyeWAsIGBvdmVyU29tZWAsIGBwYXJ0aWFsYCwgYHBhcnRpYWxSaWdodGAsIGBwYXJ0aXRpb25gLCBgcGlja2AsCiAgICAgKiBgcGlja0J5YCwgYHBsYW50YCwgYHByb3BlcnR5YCwgYHByb3BlcnR5T2ZgLCBgcHVsbGAsIGBwdWxsQWxsYCwgYHB1bGxBbGxCeWAsCiAgICAgKiBgcHVsbEFsbFdpdGhgLCBgcHVsbEF0YCwgYHB1c2hgLCBgcmFuZ2VgLCBgcmFuZ2VSaWdodGAsIGByZWFyZ2AsIGByZWplY3RgLAogICAgICogYHJlbW92ZWAsIGByZXN0YCwgYHJldmVyc2VgLCBgc2FtcGxlU2l6ZWAsIGBzZXRgLCBgc2V0V2l0aGAsIGBzaHVmZmxlYCwKICAgICAqIGBzbGljZWAsIGBzb3J0YCwgYHNvcnRCeWAsIGBzcGxpY2VgLCBgc3ByZWFkYCwgYHRhaWxgLCBgdGFrZWAsIGB0YWtlUmlnaHRgLAogICAgICogYHRha2VSaWdodFdoaWxlYCwgYHRha2VXaGlsZWAsIGB0YXBgLCBgdGhyb3R0bGVgLCBgdGhydWAsIGB0b0FycmF5YCwKICAgICAqIGB0b1BhaXJzYCwgYHRvUGFpcnNJbmAsIGB0b1BhdGhgLCBgdG9QbGFpbk9iamVjdGAsIGB0cmFuc2Zvcm1gLCBgdW5hcnlgLAogICAgICogYHVuaW9uYCwgYHVuaW9uQnlgLCBgdW5pb25XaXRoYCwgYHVuaXFgLCBgdW5pcUJ5YCwgYHVuaXFXaXRoYCwgYHVuc2V0YCwKICAgICAqIGB1bnNoaWZ0YCwgYHVuemlwYCwgYHVuemlwV2l0aGAsIGB1cGRhdGVgLCBgdXBkYXRlV2l0aGAsIGB2YWx1ZXNgLAogICAgICogYHZhbHVlc0luYCwgYHdpdGhvdXRgLCBgd3JhcGAsIGB4b3JgLCBgeG9yQnlgLCBgeG9yV2l0aGAsIGB6aXBgLAogICAgICogYHppcE9iamVjdGAsIGB6aXBPYmplY3REZWVwYCwgYW5kIGB6aXBXaXRoYAogICAgICoKICAgICAqIFRoZSB3cmFwcGVyIG1ldGhvZHMgdGhhdCBhcmUgKipub3QqKiBjaGFpbmFibGUgYnkgZGVmYXVsdCBhcmU6CiAgICAgKiBgYWRkYCwgYGF0dGVtcHRgLCBgY2FtZWxDYXNlYCwgYGNhcGl0YWxpemVgLCBgY2VpbGAsIGBjbGFtcGAsIGBjbG9uZWAsCiAgICAgKiBgY2xvbmVEZWVwYCwgYGNsb25lRGVlcFdpdGhgLCBgY2xvbmVXaXRoYCwgYGNvbmZvcm1zVG9gLCBgZGVidXJyYCwKICAgICAqIGBkZWZhdWx0VG9gLCBgZGl2aWRlYCwgYGVhY2hgLCBgZWFjaFJpZ2h0YCwgYGVuZHNXaXRoYCwgYGVxYCwgYGVzY2FwZWAsCiAgICAgKiBgZXNjYXBlUmVnRXhwYCwgYGV2ZXJ5YCwgYGZpbmRgLCBgZmluZEluZGV4YCwgYGZpbmRLZXlgLCBgZmluZExhc3RgLAogICAgICogYGZpbmRMYXN0SW5kZXhgLCBgZmluZExhc3RLZXlgLCBgZmlyc3RgLCBgZmxvb3JgLCBgZm9yRWFjaGAsIGBmb3JFYWNoUmlnaHRgLAogICAgICogYGZvckluYCwgYGZvckluUmlnaHRgLCBgZm9yT3duYCwgYGZvck93blJpZ2h0YCwgYGdldGAsIGBndGAsIGBndGVgLCBgaGFzYCwKICAgICAqIGBoYXNJbmAsIGBoZWFkYCwgYGlkZW50aXR5YCwgYGluY2x1ZGVzYCwgYGluZGV4T2ZgLCBgaW5SYW5nZWAsIGBpbnZva2VgLAogICAgICogYGlzQXJndW1lbnRzYCwgYGlzQXJyYXlgLCBgaXNBcnJheUJ1ZmZlcmAsIGBpc0FycmF5TGlrZWAsIGBpc0FycmF5TGlrZU9iamVjdGAsCiAgICAgKiBgaXNCb29sZWFuYCwgYGlzQnVmZmVyYCwgYGlzRGF0ZWAsIGBpc0VsZW1lbnRgLCBgaXNFbXB0eWAsIGBpc0VxdWFsYCwKICAgICAqIGBpc0VxdWFsV2l0aGAsIGBpc0Vycm9yYCwgYGlzRmluaXRlYCwgYGlzRnVuY3Rpb25gLCBgaXNJbnRlZ2VyYCwgYGlzTGVuZ3RoYCwKICAgICAqIGBpc01hcGAsIGBpc01hdGNoYCwgYGlzTWF0Y2hXaXRoYCwgYGlzTmFOYCwgYGlzTmF0aXZlYCwgYGlzTmlsYCwgYGlzTnVsbGAsCiAgICAgKiBgaXNOdW1iZXJgLCBgaXNPYmplY3RgLCBgaXNPYmplY3RMaWtlYCwgYGlzUGxhaW5PYmplY3RgLCBgaXNSZWdFeHBgLAogICAgICogYGlzU2FmZUludGVnZXJgLCBgaXNTZXRgLCBgaXNTdHJpbmdgLCBgaXNVbmRlZmluZWRgLCBgaXNUeXBlZEFycmF5YCwKICAgICAqIGBpc1dlYWtNYXBgLCBgaXNXZWFrU2V0YCwgYGpvaW5gLCBga2ViYWJDYXNlYCwgYGxhc3RgLCBgbGFzdEluZGV4T2ZgLAogICAgICogYGxvd2VyQ2FzZWAsIGBsb3dlckZpcnN0YCwgYGx0YCwgYGx0ZWAsIGBtYXhgLCBgbWF4QnlgLCBgbWVhbmAsIGBtZWFuQnlgLAogICAgICogYG1pbmAsIGBtaW5CeWAsIGBtdWx0aXBseWAsIGBub0NvbmZsaWN0YCwgYG5vb3BgLCBgbm93YCwgYG50aGAsIGBwYWRgLAogICAgICogYHBhZEVuZGAsIGBwYWRTdGFydGAsIGBwYXJzZUludGAsIGBwb3BgLCBgcmFuZG9tYCwgYHJlZHVjZWAsIGByZWR1Y2VSaWdodGAsCiAgICAgKiBgcmVwZWF0YCwgYHJlc3VsdGAsIGByb3VuZGAsIGBydW5JbkNvbnRleHRgLCBgc2FtcGxlYCwgYHNoaWZ0YCwgYHNpemVgLAogICAgICogYHNuYWtlQ2FzZWAsIGBzb21lYCwgYHNvcnRlZEluZGV4YCwgYHNvcnRlZEluZGV4QnlgLCBgc29ydGVkTGFzdEluZGV4YCwKICAgICAqIGBzb3J0ZWRMYXN0SW5kZXhCeWAsIGBzdGFydENhc2VgLCBgc3RhcnRzV2l0aGAsIGBzdHViQXJyYXlgLCBgc3R1YkZhbHNlYCwKICAgICAqIGBzdHViT2JqZWN0YCwgYHN0dWJTdHJpbmdgLCBgc3R1YlRydWVgLCBgc3VidHJhY3RgLCBgc3VtYCwgYHN1bUJ5YCwKICAgICAqIGB0ZW1wbGF0ZWAsIGB0aW1lc2AsIGB0b0Zpbml0ZWAsIGB0b0ludGVnZXJgLCBgdG9KU09OYCwgYHRvTGVuZ3RoYCwKICAgICAqIGB0b0xvd2VyYCwgYHRvTnVtYmVyYCwgYHRvU2FmZUludGVnZXJgLCBgdG9TdHJpbmdgLCBgdG9VcHBlcmAsIGB0cmltYCwKICAgICAqIGB0cmltRW5kYCwgYHRyaW1TdGFydGAsIGB0cnVuY2F0ZWAsIGB1bmVzY2FwZWAsIGB1bmlxdWVJZGAsIGB1cHBlckNhc2VgLAogICAgICogYHVwcGVyRmlyc3RgLCBgdmFsdWVgLCBhbmQgYHdvcmRzYAogICAgICoKICAgICAqIEBuYW1lIF8KICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQGNhdGVnb3J5IFNlcQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd3JhcCBpbiBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IGBsb2Rhc2hgIHdyYXBwZXIgaW5zdGFuY2UuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIHNxdWFyZShuKSB7CiAgICAgKiAgIHJldHVybiBuICogbjsKICAgICAqIH0KICAgICAqCiAgICAgKiB2YXIgd3JhcHBlZCA9IF8oWzEsIDIsIDNdKTsKICAgICAqCiAgICAgKiAvLyBSZXR1cm5zIGFuIHVud3JhcHBlZCB2YWx1ZS4KICAgICAqIHdyYXBwZWQucmVkdWNlKF8uYWRkKTsKICAgICAqIC8vID0+IDYKICAgICAqCiAgICAgKiAvLyBSZXR1cm5zIGEgd3JhcHBlZCB2YWx1ZS4KICAgICAqIHZhciBzcXVhcmVzID0gd3JhcHBlZC5tYXAoc3F1YXJlKTsKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoc3F1YXJlcyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNBcnJheShzcXVhcmVzLnZhbHVlKCkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBsb2Rhc2godmFsdWUpIHsKICAgICAgaWYgKGlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgIWlzQXJyYXkodmFsdWUpICYmICEodmFsdWUgaW5zdGFuY2VvZiBMYXp5V3JhcHBlcikpIHsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBMb2Rhc2hXcmFwcGVyKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnX193cmFwcGVkX18nKSkgewogICAgICAgICAgcmV0dXJuIHdyYXBwZXJDbG9uZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBuZXcgTG9kYXNoV3JhcHBlcih2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5jcmVhdGVgIHdpdGhvdXQgc3VwcG9ydCBmb3IgYXNzaWduaW5nCiAgICAgKiBwcm9wZXJ0aWVzIHRvIHRoZSBjcmVhdGVkIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IHByb3RvIFRoZSBvYmplY3QgdG8gaW5oZXJpdCBmcm9tLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IG9iamVjdC4KICAgICAqLwogICAgdmFyIGJhc2VDcmVhdGUgPSAoZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIG9iamVjdCgpIHt9CiAgICAgIHJldHVybiBmdW5jdGlvbihwcm90bykgewogICAgICAgIGlmICghaXNPYmplY3QocHJvdG8pKSB7CiAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3RDcmVhdGUpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RDcmVhdGUocHJvdG8pOwogICAgICAgIH0KICAgICAgICBvYmplY3QucHJvdG90eXBlID0gcHJvdG87CiAgICAgICAgdmFyIHJlc3VsdCA9IG5ldyBvYmplY3Q7CiAgICAgICAgb2JqZWN0LnByb3RvdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfSgpKTsKCiAgICAvKioKICAgICAqIFRoZSBmdW5jdGlvbiB3aG9zZSBwcm90b3R5cGUgY2hhaW4gc2VxdWVuY2Ugd3JhcHBlcnMgaW5oZXJpdCBmcm9tLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VMb2Rhc2goKSB7CiAgICAgIC8vIE5vIG9wZXJhdGlvbiBwZXJmb3JtZWQuCiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBjb25zdHJ1Y3RvciBmb3IgY3JlYXRpbmcgYGxvZGFzaGAgd3JhcHBlciBvYmplY3RzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAgICogQHBhcmFtIHtib29sZWFufSBbY2hhaW5BbGxdIEVuYWJsZSBleHBsaWNpdCBtZXRob2QgY2hhaW4gc2VxdWVuY2VzLgogICAgICovCiAgICBmdW5jdGlvbiBMb2Rhc2hXcmFwcGVyKHZhbHVlLCBjaGFpbkFsbCkgewogICAgICB0aGlzLl9fd3JhcHBlZF9fID0gdmFsdWU7CiAgICAgIHRoaXMuX19hY3Rpb25zX18gPSBbXTsKICAgICAgdGhpcy5fX2NoYWluX18gPSAhIWNoYWluQWxsOwogICAgICB0aGlzLl9faW5kZXhfXyA9IDA7CiAgICAgIHRoaXMuX192YWx1ZXNfXyA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvKioKICAgICAqIEJ5IGRlZmF1bHQsIHRoZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzIHVzZWQgYnkgbG9kYXNoIGFyZSBsaWtlIHRob3NlIGluCiAgICAgKiBlbWJlZGRlZCBSdWJ5IChFUkIpIGFzIHdlbGwgYXMgRVMyMDE1IHRlbXBsYXRlIHN0cmluZ3MuIENoYW5nZSB0aGUKICAgICAqIGZvbGxvd2luZyB0ZW1wbGF0ZSBzZXR0aW5ncyB0byB1c2UgYWx0ZXJuYXRpdmUgZGVsaW1pdGVycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUge09iamVjdH0KICAgICAqLwogICAgbG9kYXNoLnRlbXBsYXRlU2V0dGluZ3MgPSB7CgogICAgICAvKioKICAgICAgICogVXNlZCB0byBkZXRlY3QgYGRhdGFgIHByb3BlcnR5IHZhbHVlcyB0byBiZSBIVE1MLWVzY2FwZWQuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUge1JlZ0V4cH0KICAgICAgICovCiAgICAgICdlc2NhcGUnOiByZUVzY2FwZSwKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGRldGVjdCBjb2RlIHRvIGJlIGV2YWx1YXRlZC4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICAgKiBAdHlwZSB7UmVnRXhwfQogICAgICAgKi8KICAgICAgJ2V2YWx1YXRlJzogcmVFdmFsdWF0ZSwKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGRldGVjdCBgZGF0YWAgcHJvcGVydHkgdmFsdWVzIHRvIGluamVjdC4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICAgKiBAdHlwZSB7UmVnRXhwfQogICAgICAgKi8KICAgICAgJ2ludGVycG9sYXRlJzogcmVJbnRlcnBvbGF0ZSwKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIHJlZmVyZW5jZSB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHRlbXBsYXRlIHRleHQuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICovCiAgICAgICd2YXJpYWJsZSc6ICcnLAoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gaW1wb3J0IHZhcmlhYmxlcyBpbnRvIHRoZSBjb21waWxlZCB0ZW1wbGF0ZS4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgKi8KICAgICAgJ2ltcG9ydHMnOiB7CgogICAgICAgIC8qKgogICAgICAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MuaW1wb3J0cwogICAgICAgICAqIEB0eXBlIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICAnXyc6IGxvZGFzaAogICAgICB9CiAgICB9OwoKICAgIC8vIEVuc3VyZSB3cmFwcGVycyBhcmUgaW5zdGFuY2VzIG9mIGBiYXNlTG9kYXNoYC4KICAgIGxvZGFzaC5wcm90b3R5cGUgPSBiYXNlTG9kYXNoLnByb3RvdHlwZTsKICAgIGxvZGFzaC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBsb2Rhc2g7CgogICAgTG9kYXNoV3JhcHBlci5wcm90b3R5cGUgPSBiYXNlQ3JlYXRlKGJhc2VMb2Rhc2gucHJvdG90eXBlKTsKICAgIExvZGFzaFdyYXBwZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTG9kYXNoV3JhcHBlcjsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbGF6eSB3cmFwcGVyIG9iamVjdCB3aGljaCB3cmFwcyBgdmFsdWVgIHRvIGVuYWJsZSBsYXp5IGV2YWx1YXRpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd3JhcC4KICAgICAqLwogICAgZnVuY3Rpb24gTGF6eVdyYXBwZXIodmFsdWUpIHsKICAgICAgdGhpcy5fX3dyYXBwZWRfXyA9IHZhbHVlOwogICAgICB0aGlzLl9fYWN0aW9uc19fID0gW107CiAgICAgIHRoaXMuX19kaXJfXyA9IDE7CiAgICAgIHRoaXMuX19maWx0ZXJlZF9fID0gZmFsc2U7CiAgICAgIHRoaXMuX19pdGVyYXRlZXNfXyA9IFtdOwogICAgICB0aGlzLl9fdGFrZUNvdW50X18gPSBNQVhfQVJSQVlfTEVOR1RIOwogICAgICB0aGlzLl9fdmlld3NfXyA9IFtdOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGNsb25lIG9mIHRoZSBsYXp5IHdyYXBwZXIgb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSBjbG9uZQogICAgICogQG1lbWJlck9mIExhenlXcmFwcGVyCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjbG9uZWQgYExhenlXcmFwcGVyYCBvYmplY3QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxhenlDbG9uZSgpIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyBMYXp5V3JhcHBlcih0aGlzLl9fd3JhcHBlZF9fKTsKICAgICAgcmVzdWx0Ll9fYWN0aW9uc19fID0gY29weUFycmF5KHRoaXMuX19hY3Rpb25zX18pOwogICAgICByZXN1bHQuX19kaXJfXyA9IHRoaXMuX19kaXJfXzsKICAgICAgcmVzdWx0Ll9fZmlsdGVyZWRfXyA9IHRoaXMuX19maWx0ZXJlZF9fOwogICAgICByZXN1bHQuX19pdGVyYXRlZXNfXyA9IGNvcHlBcnJheSh0aGlzLl9faXRlcmF0ZWVzX18pOwogICAgICByZXN1bHQuX190YWtlQ291bnRfXyA9IHRoaXMuX190YWtlQ291bnRfXzsKICAgICAgcmVzdWx0Ll9fdmlld3NfXyA9IGNvcHlBcnJheSh0aGlzLl9fdmlld3NfXyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXZlcnNlcyB0aGUgZGlyZWN0aW9uIG9mIGxhenkgaXRlcmF0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSByZXZlcnNlCiAgICAgKiBAbWVtYmVyT2YgTGF6eVdyYXBwZXIKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyByZXZlcnNlZCBgTGF6eVdyYXBwZXJgIG9iamVjdC4KICAgICAqLwogICAgZnVuY3Rpb24gbGF6eVJldmVyc2UoKSB7CiAgICAgIGlmICh0aGlzLl9fZmlsdGVyZWRfXykgewogICAgICAgIHZhciByZXN1bHQgPSBuZXcgTGF6eVdyYXBwZXIodGhpcyk7CiAgICAgICAgcmVzdWx0Ll9fZGlyX18gPSAtMTsKICAgICAgICByZXN1bHQuX19maWx0ZXJlZF9fID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQgPSB0aGlzLmNsb25lKCk7CiAgICAgICAgcmVzdWx0Ll9fZGlyX18gKj0gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEV4dHJhY3RzIHRoZSB1bndyYXBwZWQgdmFsdWUgZnJvbSBpdHMgbGF6eSB3cmFwcGVyLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSB2YWx1ZQogICAgICogQG1lbWJlck9mIExhenlXcmFwcGVyCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgdW53cmFwcGVkIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBsYXp5VmFsdWUoKSB7CiAgICAgIHZhciBhcnJheSA9IHRoaXMuX193cmFwcGVkX18udmFsdWUoKSwKICAgICAgICAgIGRpciA9IHRoaXMuX19kaXJfXywKICAgICAgICAgIGlzQXJyID0gaXNBcnJheShhcnJheSksCiAgICAgICAgICBpc1JpZ2h0ID0gZGlyIDwgMCwKICAgICAgICAgIGFyckxlbmd0aCA9IGlzQXJyID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHZpZXcgPSBnZXRWaWV3KDAsIGFyckxlbmd0aCwgdGhpcy5fX3ZpZXdzX18pLAogICAgICAgICAgc3RhcnQgPSB2aWV3LnN0YXJ0LAogICAgICAgICAgZW5kID0gdmlldy5lbmQsCiAgICAgICAgICBsZW5ndGggPSBlbmQgLSBzdGFydCwKICAgICAgICAgIGluZGV4ID0gaXNSaWdodCA/IGVuZCA6IChzdGFydCAtIDEpLAogICAgICAgICAgaXRlcmF0ZWVzID0gdGhpcy5fX2l0ZXJhdGVlc19fLAogICAgICAgICAgaXRlckxlbmd0aCA9IGl0ZXJhdGVlcy5sZW5ndGgsCiAgICAgICAgICByZXNJbmRleCA9IDAsCiAgICAgICAgICB0YWtlQ291bnQgPSBuYXRpdmVNaW4obGVuZ3RoLCB0aGlzLl9fdGFrZUNvdW50X18pOwoKICAgICAgaWYgKCFpc0FyciB8fCAoIWlzUmlnaHQgJiYgYXJyTGVuZ3RoID09IGxlbmd0aCAmJiB0YWtlQ291bnQgPT0gbGVuZ3RoKSkgewogICAgICAgIHJldHVybiBiYXNlV3JhcHBlclZhbHVlKGFycmF5LCB0aGlzLl9fYWN0aW9uc19fKTsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gW107CgogICAgICBvdXRlcjoKICAgICAgd2hpbGUgKGxlbmd0aC0tICYmIHJlc0luZGV4IDwgdGFrZUNvdW50KSB7CiAgICAgICAgaW5kZXggKz0gZGlyOwoKICAgICAgICB2YXIgaXRlckluZGV4ID0gLTEsCiAgICAgICAgICAgIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoKICAgICAgICB3aGlsZSAoKytpdGVySW5kZXggPCBpdGVyTGVuZ3RoKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IGl0ZXJhdGVlc1tpdGVySW5kZXhdLAogICAgICAgICAgICAgIGl0ZXJhdGVlID0gZGF0YS5pdGVyYXRlZSwKICAgICAgICAgICAgICB0eXBlID0gZGF0YS50eXBlLAogICAgICAgICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUpOwoKICAgICAgICAgIGlmICh0eXBlID09IExBWllfTUFQX0ZMQUcpIHsKICAgICAgICAgICAgdmFsdWUgPSBjb21wdXRlZDsKICAgICAgICAgIH0gZWxzZSBpZiAoIWNvbXB1dGVkKSB7CiAgICAgICAgICAgIGlmICh0eXBlID09IExBWllfRklMVEVSX0ZMQUcpIHsKICAgICAgICAgICAgICBjb250aW51ZSBvdXRlcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXN1bHRbcmVzSW5kZXgrK10gPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8vIEVuc3VyZSBgTGF6eVdyYXBwZXJgIGlzIGFuIGluc3RhbmNlIG9mIGBiYXNlTG9kYXNoYC4KICAgIExhenlXcmFwcGVyLnByb3RvdHlwZSA9IGJhc2VDcmVhdGUoYmFzZUxvZGFzaC5wcm90b3R5cGUpOwogICAgTGF6eVdyYXBwZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTGF6eVdyYXBwZXI7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGhhc2ggb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7QXJyYXl9IFtlbnRyaWVzXSBUaGUga2V5LXZhbHVlIHBhaXJzIHRvIGNhY2hlLgogICAgICovCiAgICBmdW5jdGlvbiBIYXNoKGVudHJpZXMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBlbnRyaWVzID09IG51bGwgPyAwIDogZW50cmllcy5sZW5ndGg7CgogICAgICB0aGlzLmNsZWFyKCk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGVudHJ5ID0gZW50cmllc1tpbmRleF07CiAgICAgICAgdGhpcy5zZXQoZW50cnlbMF0sIGVudHJ5WzFdKTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwga2V5LXZhbHVlIGVudHJpZXMgZnJvbSB0aGUgaGFzaC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG5hbWUgY2xlYXIKICAgICAqIEBtZW1iZXJPZiBIYXNoCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhhc2hDbGVhcigpIHsKICAgICAgdGhpcy5fX2RhdGFfXyA9IG5hdGl2ZUNyZWF0ZSA/IG5hdGl2ZUNyZWF0ZShudWxsKSA6IHt9OwogICAgICB0aGlzLnNpemUgPSAwOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBga2V5YCBhbmQgaXRzIHZhbHVlIGZyb20gdGhlIGhhc2guCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBuYW1lIGRlbGV0ZQogICAgICogQG1lbWJlck9mIEhhc2gKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBoYXNoIFRoZSBoYXNoIHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gcmVtb3ZlLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBlbnRyeSB3YXMgcmVtb3ZlZCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBoYXNoRGVsZXRlKGtleSkgewogICAgICB2YXIgcmVzdWx0ID0gdGhpcy5oYXMoa2V5KSAmJiBkZWxldGUgdGhpcy5fX2RhdGFfX1trZXldOwogICAgICB0aGlzLnNpemUgLT0gcmVzdWx0ID8gMSA6IDA7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBoYXNoIHZhbHVlIGZvciBga2V5YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG5hbWUgZ2V0CiAgICAgKiBAbWVtYmVyT2YgSGFzaAogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSB2YWx1ZSB0byBnZXQuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZW50cnkgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhhc2hHZXQoa2V5KSB7CiAgICAgIHZhciBkYXRhID0gdGhpcy5fX2RhdGFfXzsKICAgICAgaWYgKG5hdGl2ZUNyZWF0ZSkgewogICAgICAgIHZhciByZXN1bHQgPSBkYXRhW2tleV07CiAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gSEFTSF9VTkRFRklORUQgPyB1bmRlZmluZWQgOiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoZGF0YSwga2V5KSA/IGRhdGFba2V5XSA6IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBhIGhhc2ggdmFsdWUgZm9yIGBrZXlgIGV4aXN0cy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG5hbWUgaGFzCiAgICAgKiBAbWVtYmVyT2YgSGFzaAogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBlbnRyeSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbiBlbnRyeSBmb3IgYGtleWAgZXhpc3RzLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhhc2hIYXMoa2V5KSB7CiAgICAgIHZhciBkYXRhID0gdGhpcy5fX2RhdGFfXzsKICAgICAgcmV0dXJuIG5hdGl2ZUNyZWF0ZSA/IChkYXRhW2tleV0gIT09IHVuZGVmaW5lZCkgOiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGRhdGEsIGtleSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBoYXNoIGBrZXlgIHRvIGB2YWx1ZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBuYW1lIHNldAogICAgICogQG1lbWJlck9mIEhhc2gKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gc2V0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0LgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgaGFzaCBpbnN0YW5jZS4KICAgICAqLwogICAgZnVuY3Rpb24gaGFzaFNldChrZXksIHZhbHVlKSB7CiAgICAgIHZhciBkYXRhID0gdGhpcy5fX2RhdGFfXzsKICAgICAgdGhpcy5zaXplICs9IHRoaXMuaGFzKGtleSkgPyAwIDogMTsKICAgICAgZGF0YVtrZXldID0gKG5hdGl2ZUNyZWF0ZSAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/IEhBU0hfVU5ERUZJTkVEIDogdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIC8vIEFkZCBtZXRob2RzIHRvIGBIYXNoYC4KICAgIEhhc2gucHJvdG90eXBlLmNsZWFyID0gaGFzaENsZWFyOwogICAgSGFzaC5wcm90b3R5cGVbJ2RlbGV0ZSddID0gaGFzaERlbGV0ZTsKICAgIEhhc2gucHJvdG90eXBlLmdldCA9IGhhc2hHZXQ7CiAgICBIYXNoLnByb3RvdHlwZS5oYXMgPSBoYXNoSGFzOwogICAgSGFzaC5wcm90b3R5cGUuc2V0ID0gaGFzaFNldDsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGxpc3QgY2FjaGUgb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7QXJyYXl9IFtlbnRyaWVzXSBUaGUga2V5LXZhbHVlIHBhaXJzIHRvIGNhY2hlLgogICAgICovCiAgICBmdW5jdGlvbiBMaXN0Q2FjaGUoZW50cmllcykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGVudHJpZXMgPT0gbnVsbCA/IDAgOiBlbnRyaWVzLmxlbmd0aDsKCiAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgZW50cnkgPSBlbnRyaWVzW2luZGV4XTsKICAgICAgICB0aGlzLnNldChlbnRyeVswXSwgZW50cnlbMV0pOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmVzIGFsbCBrZXktdmFsdWUgZW50cmllcyBmcm9tIHRoZSBsaXN0IGNhY2hlLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSBjbGVhcgogICAgICogQG1lbWJlck9mIExpc3RDYWNoZQogICAgICovCiAgICBmdW5jdGlvbiBsaXN0Q2FjaGVDbGVhcigpIHsKICAgICAgdGhpcy5fX2RhdGFfXyA9IFtdOwogICAgICB0aGlzLnNpemUgPSAwOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBga2V5YCBhbmQgaXRzIHZhbHVlIGZyb20gdGhlIGxpc3QgY2FjaGUuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBuYW1lIGRlbGV0ZQogICAgICogQG1lbWJlck9mIExpc3RDYWNoZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSB2YWx1ZSB0byByZW1vdmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGVudHJ5IHdhcyByZW1vdmVkLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxpc3RDYWNoZURlbGV0ZShrZXkpIHsKICAgICAgdmFyIGRhdGEgPSB0aGlzLl9fZGF0YV9fLAogICAgICAgICAgaW5kZXggPSBhc3NvY0luZGV4T2YoZGF0YSwga2V5KTsKCiAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIGxhc3RJbmRleCA9IGRhdGEubGVuZ3RoIC0gMTsKICAgICAgaWYgKGluZGV4ID09IGxhc3RJbmRleCkgewogICAgICAgIGRhdGEucG9wKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3BsaWNlLmNhbGwoZGF0YSwgaW5kZXgsIDEpOwogICAgICB9CiAgICAgIC0tdGhpcy5zaXplOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGxpc3QgY2FjaGUgdmFsdWUgZm9yIGBrZXlgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSBnZXQKICAgICAqIEBtZW1iZXJPZiBMaXN0Q2FjaGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gZ2V0LgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGVudHJ5IHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBsaXN0Q2FjaGVHZXQoa2V5KSB7CiAgICAgIHZhciBkYXRhID0gdGhpcy5fX2RhdGFfXywKICAgICAgICAgIGluZGV4ID0gYXNzb2NJbmRleE9mKGRhdGEsIGtleSk7CgogICAgICByZXR1cm4gaW5kZXggPCAwID8gdW5kZWZpbmVkIDogZGF0YVtpbmRleF1bMV07CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYSBsaXN0IGNhY2hlIHZhbHVlIGZvciBga2V5YCBleGlzdHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBuYW1lIGhhcwogICAgICogQG1lbWJlck9mIExpc3RDYWNoZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBlbnRyeSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbiBlbnRyeSBmb3IgYGtleWAgZXhpc3RzLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxpc3RDYWNoZUhhcyhrZXkpIHsKICAgICAgcmV0dXJuIGFzc29jSW5kZXhPZih0aGlzLl9fZGF0YV9fLCBrZXkpID4gLTE7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBsaXN0IGNhY2hlIGBrZXlgIHRvIGB2YWx1ZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBuYW1lIHNldAogICAgICogQG1lbWJlck9mIExpc3RDYWNoZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSB2YWx1ZSB0byBzZXQuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBsaXN0IGNhY2hlIGluc3RhbmNlLgogICAgICovCiAgICBmdW5jdGlvbiBsaXN0Q2FjaGVTZXQoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgZGF0YSA9IHRoaXMuX19kYXRhX18sCiAgICAgICAgICBpbmRleCA9IGFzc29jSW5kZXhPZihkYXRhLCBrZXkpOwoKICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICsrdGhpcy5zaXplOwogICAgICAgIGRhdGEucHVzaChba2V5LCB2YWx1ZV0pOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGFbaW5kZXhdWzFdID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLy8gQWRkIG1ldGhvZHMgdG8gYExpc3RDYWNoZWAuCiAgICBMaXN0Q2FjaGUucHJvdG90eXBlLmNsZWFyID0gbGlzdENhY2hlQ2xlYXI7CiAgICBMaXN0Q2FjaGUucHJvdG90eXBlWydkZWxldGUnXSA9IGxpc3RDYWNoZURlbGV0ZTsKICAgIExpc3RDYWNoZS5wcm90b3R5cGUuZ2V0ID0gbGlzdENhY2hlR2V0OwogICAgTGlzdENhY2hlLnByb3RvdHlwZS5oYXMgPSBsaXN0Q2FjaGVIYXM7CiAgICBMaXN0Q2FjaGUucHJvdG90eXBlLnNldCA9IGxpc3RDYWNoZVNldDsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbWFwIGNhY2hlIG9iamVjdCB0byBzdG9yZSBrZXktdmFsdWUgcGFpcnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtBcnJheX0gW2VudHJpZXNdIFRoZSBrZXktdmFsdWUgcGFpcnMgdG8gY2FjaGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIE1hcENhY2hlKGVudHJpZXMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBlbnRyaWVzID09IG51bGwgPyAwIDogZW50cmllcy5sZW5ndGg7CgogICAgICB0aGlzLmNsZWFyKCk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGVudHJ5ID0gZW50cmllc1tpbmRleF07CiAgICAgICAgdGhpcy5zZXQoZW50cnlbMF0sIGVudHJ5WzFdKTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwga2V5LXZhbHVlIGVudHJpZXMgZnJvbSB0aGUgbWFwLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSBjbGVhcgogICAgICogQG1lbWJlck9mIE1hcENhY2hlCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcENhY2hlQ2xlYXIoKSB7CiAgICAgIHRoaXMuc2l6ZSA9IDA7CiAgICAgIHRoaXMuX19kYXRhX18gPSB7CiAgICAgICAgJ2hhc2gnOiBuZXcgSGFzaCwKICAgICAgICAnbWFwJzogbmV3IChNYXAgfHwgTGlzdENhY2hlKSwKICAgICAgICAnc3RyaW5nJzogbmV3IEhhc2gKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZXMgYGtleWAgYW5kIGl0cyB2YWx1ZSBmcm9tIHRoZSBtYXAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBuYW1lIGRlbGV0ZQogICAgICogQG1lbWJlck9mIE1hcENhY2hlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHZhbHVlIHRvIHJlbW92ZS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZW50cnkgd2FzIHJlbW92ZWQsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gbWFwQ2FjaGVEZWxldGUoa2V5KSB7CiAgICAgIHZhciByZXN1bHQgPSBnZXRNYXBEYXRhKHRoaXMsIGtleSlbJ2RlbGV0ZSddKGtleSk7CiAgICAgIHRoaXMuc2l6ZSAtPSByZXN1bHQgPyAxIDogMDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIG1hcCB2YWx1ZSBmb3IgYGtleWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBuYW1lIGdldAogICAgICogQG1lbWJlck9mIE1hcENhY2hlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHZhbHVlIHRvIGdldC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBlbnRyeSB2YWx1ZS4KICAgICAqLwogICAgZnVuY3Rpb24gbWFwQ2FjaGVHZXQoa2V5KSB7CiAgICAgIHJldHVybiBnZXRNYXBEYXRhKHRoaXMsIGtleSkuZ2V0KGtleSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYSBtYXAgdmFsdWUgZm9yIGBrZXlgIGV4aXN0cy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG5hbWUgaGFzCiAgICAgKiBAbWVtYmVyT2YgTWFwQ2FjaGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgZW50cnkgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYW4gZW50cnkgZm9yIGBrZXlgIGV4aXN0cywgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBtYXBDYWNoZUhhcyhrZXkpIHsKICAgICAgcmV0dXJuIGdldE1hcERhdGEodGhpcywga2V5KS5oYXMoa2V5KTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgdGhlIG1hcCBga2V5YCB0byBgdmFsdWVgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSBzZXQKICAgICAqIEBtZW1iZXJPZiBNYXBDYWNoZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSB2YWx1ZSB0byBzZXQuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBtYXAgY2FjaGUgaW5zdGFuY2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcENhY2hlU2V0KGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGRhdGEgPSBnZXRNYXBEYXRhKHRoaXMsIGtleSksCiAgICAgICAgICBzaXplID0gZGF0YS5zaXplOwoKICAgICAgZGF0YS5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgIHRoaXMuc2l6ZSArPSBkYXRhLnNpemUgPT0gc2l6ZSA/IDAgOiAxOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvLyBBZGQgbWV0aG9kcyB0byBgTWFwQ2FjaGVgLgogICAgTWFwQ2FjaGUucHJvdG90eXBlLmNsZWFyID0gbWFwQ2FjaGVDbGVhcjsKICAgIE1hcENhY2hlLnByb3RvdHlwZVsnZGVsZXRlJ10gPSBtYXBDYWNoZURlbGV0ZTsKICAgIE1hcENhY2hlLnByb3RvdHlwZS5nZXQgPSBtYXBDYWNoZUdldDsKICAgIE1hcENhY2hlLnByb3RvdHlwZS5oYXMgPSBtYXBDYWNoZUhhczsKICAgIE1hcENhY2hlLnByb3RvdHlwZS5zZXQgPSBtYXBDYWNoZVNldDsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBjYWNoZSBvYmplY3QgdG8gc3RvcmUgdW5pcXVlIHZhbHVlcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbdmFsdWVzXSBUaGUgdmFsdWVzIHRvIGNhY2hlLgogICAgICovCiAgICBmdW5jdGlvbiBTZXRDYWNoZSh2YWx1ZXMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSB2YWx1ZXMgPT0gbnVsbCA/IDAgOiB2YWx1ZXMubGVuZ3RoOwoKICAgICAgdGhpcy5fX2RhdGFfXyA9IG5ldyBNYXBDYWNoZTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB0aGlzLmFkZCh2YWx1ZXNbaW5kZXhdKTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQWRkcyBgdmFsdWVgIHRvIHRoZSBhcnJheSBjYWNoZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG5hbWUgYWRkCiAgICAgKiBAbWVtYmVyT2YgU2V0Q2FjaGUKICAgICAqIEBhbGlhcyBwdXNoCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjYWNoZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNhY2hlIGluc3RhbmNlLgogICAgICovCiAgICBmdW5jdGlvbiBzZXRDYWNoZUFkZCh2YWx1ZSkgewogICAgICB0aGlzLl9fZGF0YV9fLnNldCh2YWx1ZSwgSEFTSF9VTkRFRklORUQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGluIHRoZSBhcnJheSBjYWNoZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG5hbWUgaGFzCiAgICAgKiBAbWVtYmVyT2YgU2V0Q2FjaGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldENhY2hlSGFzKHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzLl9fZGF0YV9fLmhhcyh2YWx1ZSk7CiAgICB9CgogICAgLy8gQWRkIG1ldGhvZHMgdG8gYFNldENhY2hlYC4KICAgIFNldENhY2hlLnByb3RvdHlwZS5hZGQgPSBTZXRDYWNoZS5wcm90b3R5cGUucHVzaCA9IHNldENhY2hlQWRkOwogICAgU2V0Q2FjaGUucHJvdG90eXBlLmhhcyA9IHNldENhY2hlSGFzOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBzdGFjayBjYWNoZSBvYmplY3QgdG8gc3RvcmUga2V5LXZhbHVlIHBhaXJzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7QXJyYXl9IFtlbnRyaWVzXSBUaGUga2V5LXZhbHVlIHBhaXJzIHRvIGNhY2hlLgogICAgICovCiAgICBmdW5jdGlvbiBTdGFjayhlbnRyaWVzKSB7CiAgICAgIHZhciBkYXRhID0gdGhpcy5fX2RhdGFfXyA9IG5ldyBMaXN0Q2FjaGUoZW50cmllcyk7CiAgICAgIHRoaXMuc2l6ZSA9IGRhdGEuc2l6ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZXMgYWxsIGtleS12YWx1ZSBlbnRyaWVzIGZyb20gdGhlIHN0YWNrLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSBjbGVhcgogICAgICogQG1lbWJlck9mIFN0YWNrCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YWNrQ2xlYXIoKSB7CiAgICAgIHRoaXMuX19kYXRhX18gPSBuZXcgTGlzdENhY2hlOwogICAgICB0aGlzLnNpemUgPSAwOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBga2V5YCBhbmQgaXRzIHZhbHVlIGZyb20gdGhlIHN0YWNrLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSBkZWxldGUKICAgICAqIEBtZW1iZXJPZiBTdGFjawogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSB2YWx1ZSB0byByZW1vdmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGVudHJ5IHdhcyByZW1vdmVkLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YWNrRGVsZXRlKGtleSkgewogICAgICB2YXIgZGF0YSA9IHRoaXMuX19kYXRhX18sCiAgICAgICAgICByZXN1bHQgPSBkYXRhWydkZWxldGUnXShrZXkpOwoKICAgICAgdGhpcy5zaXplID0gZGF0YS5zaXplOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgc3RhY2sgdmFsdWUgZm9yIGBrZXlgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbmFtZSBnZXQKICAgICAqIEBtZW1iZXJPZiBTdGFjawogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSB2YWx1ZSB0byBnZXQuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZW50cnkgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YWNrR2V0KGtleSkgewogICAgICByZXR1cm4gdGhpcy5fX2RhdGFfXy5nZXQoa2V5KTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBhIHN0YWNrIHZhbHVlIGZvciBga2V5YCBleGlzdHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBuYW1lIGhhcwogICAgICogQG1lbWJlck9mIFN0YWNrCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIGVudHJ5IHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFuIGVudHJ5IGZvciBga2V5YCBleGlzdHMsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gc3RhY2tIYXMoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLl9fZGF0YV9fLmhhcyhrZXkpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgc3RhY2sgYGtleWAgdG8gYHZhbHVlYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG5hbWUgc2V0CiAgICAgKiBAbWVtYmVyT2YgU3RhY2sKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gc2V0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0LgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgc3RhY2sgY2FjaGUgaW5zdGFuY2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YWNrU2V0KGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGRhdGEgPSB0aGlzLl9fZGF0YV9fOwogICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIExpc3RDYWNoZSkgewogICAgICAgIHZhciBwYWlycyA9IGRhdGEuX19kYXRhX187CiAgICAgICAgaWYgKCFNYXAgfHwgKHBhaXJzLmxlbmd0aCA8IExBUkdFX0FSUkFZX1NJWkUgLSAxKSkgewogICAgICAgICAgcGFpcnMucHVzaChba2V5LCB2YWx1ZV0pOwogICAgICAgICAgdGhpcy5zaXplID0gKytkYXRhLnNpemU7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgZGF0YSA9IHRoaXMuX19kYXRhX18gPSBuZXcgTWFwQ2FjaGUocGFpcnMpOwogICAgICB9CiAgICAgIGRhdGEuc2V0KGtleSwgdmFsdWUpOwogICAgICB0aGlzLnNpemUgPSBkYXRhLnNpemU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIC8vIEFkZCBtZXRob2RzIHRvIGBTdGFja2AuCiAgICBTdGFjay5wcm90b3R5cGUuY2xlYXIgPSBzdGFja0NsZWFyOwogICAgU3RhY2sucHJvdG90eXBlWydkZWxldGUnXSA9IHN0YWNrRGVsZXRlOwogICAgU3RhY2sucHJvdG90eXBlLmdldCA9IHN0YWNrR2V0OwogICAgU3RhY2sucHJvdG90eXBlLmhhcyA9IHN0YWNrSGFzOwogICAgU3RhY2sucHJvdG90eXBlLnNldCA9IHN0YWNrU2V0OwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdGhlIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMgb2YgdGhlIGFycmF5LWxpa2UgYHZhbHVlYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGluaGVyaXRlZCBTcGVjaWZ5IHJldHVybmluZyBpbmhlcml0ZWQgcHJvcGVydHkgbmFtZXMuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAgICovCiAgICBmdW5jdGlvbiBhcnJheUxpa2VLZXlzKHZhbHVlLCBpbmhlcml0ZWQpIHsKICAgICAgdmFyIGlzQXJyID0gaXNBcnJheSh2YWx1ZSksCiAgICAgICAgICBpc0FyZyA9ICFpc0FyciAmJiBpc0FyZ3VtZW50cyh2YWx1ZSksCiAgICAgICAgICBpc0J1ZmYgPSAhaXNBcnIgJiYgIWlzQXJnICYmIGlzQnVmZmVyKHZhbHVlKSwKICAgICAgICAgIGlzVHlwZSA9ICFpc0FyciAmJiAhaXNBcmcgJiYgIWlzQnVmZiAmJiBpc1R5cGVkQXJyYXkodmFsdWUpLAogICAgICAgICAgc2tpcEluZGV4ZXMgPSBpc0FyciB8fCBpc0FyZyB8fCBpc0J1ZmYgfHwgaXNUeXBlLAogICAgICAgICAgcmVzdWx0ID0gc2tpcEluZGV4ZXMgPyBiYXNlVGltZXModmFsdWUubGVuZ3RoLCBTdHJpbmcpIDogW10sCiAgICAgICAgICBsZW5ndGggPSByZXN1bHQubGVuZ3RoOwoKICAgICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgICAgaWYgKChpbmhlcml0ZWQgfHwgaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwga2V5KSkgJiYKICAgICAgICAgICAgIShza2lwSW5kZXhlcyAmJiAoCiAgICAgICAgICAgICAgIC8vIFNhZmFyaSA5IGhhcyBlbnVtZXJhYmxlIGBhcmd1bWVudHMubGVuZ3RoYCBpbiBzdHJpY3QgbW9kZS4KICAgICAgICAgICAgICAga2V5ID09ICdsZW5ndGgnIHx8CiAgICAgICAgICAgICAgIC8vIE5vZGUuanMgMC4xMCBoYXMgZW51bWVyYWJsZSBub24taW5kZXggcHJvcGVydGllcyBvbiBidWZmZXJzLgogICAgICAgICAgICAgICAoaXNCdWZmICYmIChrZXkgPT0gJ29mZnNldCcgfHwga2V5ID09ICdwYXJlbnQnKSkgfHwKICAgICAgICAgICAgICAgLy8gUGhhbnRvbUpTIDIgaGFzIGVudW1lcmFibGUgbm9uLWluZGV4IHByb3BlcnRpZXMgb24gdHlwZWQgYXJyYXlzLgogICAgICAgICAgICAgICAoaXNUeXBlICYmIChrZXkgPT0gJ2J1ZmZlcicgfHwga2V5ID09ICdieXRlTGVuZ3RoJyB8fCBrZXkgPT0gJ2J5dGVPZmZzZXQnKSkgfHwKICAgICAgICAgICAgICAgLy8gU2tpcCBpbmRleCBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICBpc0luZGV4KGtleSwgbGVuZ3RoKQogICAgICAgICAgICApKSkgewogICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgXy5zYW1wbGVgIGZvciBhcnJheXMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzYW1wbGUuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgcmFuZG9tIGVsZW1lbnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFycmF5U2FtcGxlKGFycmF5KSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgIHJldHVybiBsZW5ndGggPyBhcnJheVtiYXNlUmFuZG9tKDAsIGxlbmd0aCAtIDEpXSA6IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvKioKICAgICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgXy5zYW1wbGVTaXplYCBmb3IgYXJyYXlzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2FtcGxlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gVGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBzYW1wbGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHJhbmRvbSBlbGVtZW50cy4KICAgICAqLwogICAgZnVuY3Rpb24gYXJyYXlTYW1wbGVTaXplKGFycmF5LCBuKSB7CiAgICAgIHJldHVybiBzaHVmZmxlU2VsZihjb3B5QXJyYXkoYXJyYXkpLCBiYXNlQ2xhbXAobiwgMCwgYXJyYXkubGVuZ3RoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYF8uc2h1ZmZsZWAgZm9yIGFycmF5cy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNodWZmbGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBzaHVmZmxlZCBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gYXJyYXlTaHVmZmxlKGFycmF5KSB7CiAgICAgIHJldHVybiBzaHVmZmxlU2VsZihjb3B5QXJyYXkoYXJyYXkpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgbGlrZSBgYXNzaWduVmFsdWVgIGV4Y2VwdCB0aGF0IGl0IGRvZXNuJ3QgYXNzaWduCiAgICAgKiBgdW5kZWZpbmVkYCB2YWx1ZXMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHByb3BlcnR5IHRvIGFzc2lnbi4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGFzc2lnbi4KICAgICAqLwogICAgZnVuY3Rpb24gYXNzaWduTWVyZ2VWYWx1ZShvYmplY3QsIGtleSwgdmFsdWUpIHsKICAgICAgaWYgKCh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmICFlcShvYmplY3Rba2V5XSwgdmFsdWUpKSB8fAogICAgICAgICAgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgIShrZXkgaW4gb2JqZWN0KSkpIHsKICAgICAgICBiYXNlQXNzaWduVmFsdWUob2JqZWN0LCBrZXksIHZhbHVlKTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQXNzaWducyBgdmFsdWVgIHRvIGBrZXlgIG9mIGBvYmplY3RgIGlmIHRoZSBleGlzdGluZyB2YWx1ZSBpcyBub3QgZXF1aXZhbGVudAogICAgICogdXNpbmcgW2BTYW1lVmFsdWVaZXJvYF0oaHR0cDovL2VjbWEtaW50ZXJuYXRpb25hbC5vcmcvZWNtYS0yNjIvNy4wLyNzZWMtc2FtZXZhbHVlemVybykKICAgICAqIGZvciBlcXVhbGl0eSBjb21wYXJpc29ucy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgcHJvcGVydHkgdG8gYXNzaWduLgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gYXNzaWduLgogICAgICovCiAgICBmdW5jdGlvbiBhc3NpZ25WYWx1ZShvYmplY3QsIGtleSwgdmFsdWUpIHsKICAgICAgdmFyIG9ialZhbHVlID0gb2JqZWN0W2tleV07CiAgICAgIGlmICghKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIGVxKG9ialZhbHVlLCB2YWx1ZSkpIHx8CiAgICAgICAgICAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiAhKGtleSBpbiBvYmplY3QpKSkgewogICAgICAgIGJhc2VBc3NpZ25WYWx1ZShvYmplY3QsIGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBpbmRleCBhdCB3aGljaCB0aGUgYGtleWAgaXMgZm91bmQgaW4gYGFycmF5YCBvZiBrZXktdmFsdWUgcGFpcnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHsqfSBrZXkgVGhlIGtleSB0byBzZWFyY2ggZm9yLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUsIGVsc2UgYC0xYC4KICAgICAqLwogICAgZnVuY3Rpb24gYXNzb2NJbmRleE9mKGFycmF5LCBrZXkpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgaWYgKGVxKGFycmF5W2xlbmd0aF1bMF0sIGtleSkpIHsKICAgICAgICAgIHJldHVybiBsZW5ndGg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIEFnZ3JlZ2F0ZXMgZWxlbWVudHMgb2YgYGNvbGxlY3Rpb25gIG9uIGBhY2N1bXVsYXRvcmAgd2l0aCBrZXlzIHRyYW5zZm9ybWVkCiAgICAgKiBieSBgaXRlcmF0ZWVgIGFuZCB2YWx1ZXMgc2V0IGJ5IGBzZXR0ZXJgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBzZXR0ZXIgVGhlIGZ1bmN0aW9uIHRvIHNldCBgYWNjdW11bGF0b3JgIHZhbHVlcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBpdGVyYXRlZSB0byB0cmFuc2Zvcm0ga2V5cy4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBhY2N1bXVsYXRvciBUaGUgaW5pdGlhbCBhZ2dyZWdhdGVkIG9iamVjdC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBgYWNjdW11bGF0b3JgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlQWdncmVnYXRvcihjb2xsZWN0aW9uLCBzZXR0ZXIsIGl0ZXJhdGVlLCBhY2N1bXVsYXRvcikgewogICAgICBiYXNlRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgc2V0dGVyKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaXRlcmF0ZWUodmFsdWUpLCBjb2xsZWN0aW9uKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBhY2N1bXVsYXRvcjsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmFzc2lnbmAgd2l0aG91dCBzdXBwb3J0IGZvciBtdWx0aXBsZSBzb3VyY2VzCiAgICAgKiBvciBgY3VzdG9taXplcmAgZnVuY3Rpb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBzb3VyY2Ugb2JqZWN0LgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUFzc2lnbihvYmplY3QsIHNvdXJjZSkgewogICAgICByZXR1cm4gb2JqZWN0ICYmIGNvcHlPYmplY3Qoc291cmNlLCBrZXlzKHNvdXJjZSksIG9iamVjdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5hc3NpZ25JbmAgd2l0aG91dCBzdXBwb3J0IGZvciBtdWx0aXBsZSBzb3VyY2VzCiAgICAgKiBvciBgY3VzdG9taXplcmAgZnVuY3Rpb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBzb3VyY2Ugb2JqZWN0LgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUFzc2lnbkluKG9iamVjdCwgc291cmNlKSB7CiAgICAgIHJldHVybiBvYmplY3QgJiYgY29weU9iamVjdChzb3VyY2UsIGtleXNJbihzb3VyY2UpLCBvYmplY3QpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYGFzc2lnblZhbHVlYCBhbmQgYGFzc2lnbk1lcmdlVmFsdWVgIHdpdGhvdXQKICAgICAqIHZhbHVlIGNoZWNrcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgcHJvcGVydHkgdG8gYXNzaWduLgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gYXNzaWduLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlQXNzaWduVmFsdWUob2JqZWN0LCBrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgPT0gJ19fcHJvdG9fXycgJiYgZGVmaW5lUHJvcGVydHkpIHsKICAgICAgICBkZWZpbmVQcm9wZXJ0eShvYmplY3QsIGtleSwgewogICAgICAgICAgJ2NvbmZpZ3VyYWJsZSc6IHRydWUsCiAgICAgICAgICAnZW51bWVyYWJsZSc6IHRydWUsCiAgICAgICAgICAndmFsdWUnOiB2YWx1ZSwKICAgICAgICAgICd3cml0YWJsZSc6IHRydWUKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5hdGAgd2l0aG91dCBzdXBwb3J0IGZvciBpbmRpdmlkdWFsIHBhdGhzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtzdHJpbmdbXX0gcGF0aHMgVGhlIHByb3BlcnR5IHBhdGhzIHRvIHBpY2suCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHBpY2tlZCBlbGVtZW50cy4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUF0KG9iamVjdCwgcGF0aHMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBwYXRocy5sZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpLAogICAgICAgICAgc2tpcCA9IG9iamVjdCA9PSBudWxsOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gc2tpcCA/IHVuZGVmaW5lZCA6IGdldChvYmplY3QsIHBhdGhzW2luZGV4XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmNsYW1wYCB3aGljaCBkb2Vzbid0IGNvZXJjZSBhcmd1bWVudHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW1iZXIgVGhlIG51bWJlciB0byBjbGFtcC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbG93ZXJdIFRoZSBsb3dlciBib3VuZC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB1cHBlciBUaGUgdXBwZXIgYm91bmQuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBjbGFtcGVkIG51bWJlci4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNsYW1wKG51bWJlciwgbG93ZXIsIHVwcGVyKSB7CiAgICAgIGlmIChudW1iZXIgPT09IG51bWJlcikgewogICAgICAgIGlmICh1cHBlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBudW1iZXIgPSBudW1iZXIgPD0gdXBwZXIgPyBudW1iZXIgOiB1cHBlcjsKICAgICAgICB9CiAgICAgICAgaWYgKGxvd2VyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIG51bWJlciA9IG51bWJlciA+PSBsb3dlciA/IG51bWJlciA6IGxvd2VyOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbnVtYmVyOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uY2xvbmVgIGFuZCBgXy5jbG9uZURlZXBgIHdoaWNoIHRyYWNrcwogICAgICogdHJhdmVyc2VkIG9iamVjdHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNsb25lLgogICAgICogQHBhcmFtIHtib29sZWFufSBiaXRtYXNrIFRoZSBiaXRtYXNrIGZsYWdzLgogICAgICogIDEgLSBEZWVwIGNsb25lCiAgICAgKiAgMiAtIEZsYXR0ZW4gaW5oZXJpdGVkIHByb3BlcnRpZXMKICAgICAqICA0IC0gQ2xvbmUgc3ltYm9scwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2N1c3RvbWl6ZXJdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZy4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBba2V5XSBUaGUga2V5IG9mIGB2YWx1ZWAuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29iamVjdF0gVGhlIHBhcmVudCBvYmplY3Qgb2YgYHZhbHVlYC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbc3RhY2tdIFRyYWNrcyB0cmF2ZXJzZWQgb2JqZWN0cyBhbmQgdGhlaXIgY2xvbmUgY291bnRlcnBhcnRzLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGNsb25lZCB2YWx1ZS4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNsb25lKHZhbHVlLCBiaXRtYXNrLCBjdXN0b21pemVyLCBrZXksIG9iamVjdCwgc3RhY2spIHsKICAgICAgdmFyIHJlc3VsdCwKICAgICAgICAgIGlzRGVlcCA9IGJpdG1hc2sgJiBDTE9ORV9ERUVQX0ZMQUcsCiAgICAgICAgICBpc0ZsYXQgPSBiaXRtYXNrICYgQ0xPTkVfRkxBVF9GTEFHLAogICAgICAgICAgaXNGdWxsID0gYml0bWFzayAmIENMT05FX1NZTUJPTFNfRkxBRzsKCiAgICAgIGlmIChjdXN0b21pemVyKSB7CiAgICAgICAgcmVzdWx0ID0gb2JqZWN0ID8gY3VzdG9taXplcih2YWx1ZSwga2V5LCBvYmplY3QsIHN0YWNrKSA6IGN1c3RvbWl6ZXIodmFsdWUpOwogICAgICB9CiAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKCFpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgdmFyIGlzQXJyID0gaXNBcnJheSh2YWx1ZSk7CiAgICAgIGlmIChpc0FycikgewogICAgICAgIHJlc3VsdCA9IGluaXRDbG9uZUFycmF5KHZhbHVlKTsKICAgICAgICBpZiAoIWlzRGVlcCkgewogICAgICAgICAgcmV0dXJuIGNvcHlBcnJheSh2YWx1ZSwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHRhZyA9IGdldFRhZyh2YWx1ZSksCiAgICAgICAgICAgIGlzRnVuYyA9IHRhZyA9PSBmdW5jVGFnIHx8IHRhZyA9PSBnZW5UYWc7CgogICAgICAgIGlmIChpc0J1ZmZlcih2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBjbG9uZUJ1ZmZlcih2YWx1ZSwgaXNEZWVwKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRhZyA9PSBvYmplY3RUYWcgfHwgdGFnID09IGFyZ3NUYWcgfHwgKGlzRnVuYyAmJiAhb2JqZWN0KSkgewogICAgICAgICAgcmVzdWx0ID0gKGlzRmxhdCB8fCBpc0Z1bmMpID8ge30gOiBpbml0Q2xvbmVPYmplY3QodmFsdWUpOwogICAgICAgICAgaWYgKCFpc0RlZXApIHsKICAgICAgICAgICAgcmV0dXJuIGlzRmxhdAogICAgICAgICAgICAgID8gY29weVN5bWJvbHNJbih2YWx1ZSwgYmFzZUFzc2lnbkluKHJlc3VsdCwgdmFsdWUpKQogICAgICAgICAgICAgIDogY29weVN5bWJvbHModmFsdWUsIGJhc2VBc3NpZ24ocmVzdWx0LCB2YWx1ZSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoIWNsb25lYWJsZVRhZ3NbdGFnXSkgewogICAgICAgICAgICByZXR1cm4gb2JqZWN0ID8gdmFsdWUgOiB7fTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdCA9IGluaXRDbG9uZUJ5VGFnKHZhbHVlLCB0YWcsIGlzRGVlcCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIENoZWNrIGZvciBjaXJjdWxhciByZWZlcmVuY2VzIGFuZCByZXR1cm4gaXRzIGNvcnJlc3BvbmRpbmcgY2xvbmUuCiAgICAgIHN0YWNrIHx8IChzdGFjayA9IG5ldyBTdGFjayk7CiAgICAgIHZhciBzdGFja2VkID0gc3RhY2suZ2V0KHZhbHVlKTsKICAgICAgaWYgKHN0YWNrZWQpIHsKICAgICAgICByZXR1cm4gc3RhY2tlZDsKICAgICAgfQogICAgICBzdGFjay5zZXQodmFsdWUsIHJlc3VsdCk7CgogICAgICBpZiAoaXNTZXQodmFsdWUpKSB7CiAgICAgICAgdmFsdWUuZm9yRWFjaChmdW5jdGlvbihzdWJWYWx1ZSkgewogICAgICAgICAgcmVzdWx0LmFkZChiYXNlQ2xvbmUoc3ViVmFsdWUsIGJpdG1hc2ssIGN1c3RvbWl6ZXIsIHN1YlZhbHVlLCB2YWx1ZSwgc3RhY2spKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChpc01hcCh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZS5mb3JFYWNoKGZ1bmN0aW9uKHN1YlZhbHVlLCBrZXkpIHsKICAgICAgICAgIHJlc3VsdC5zZXQoa2V5LCBiYXNlQ2xvbmUoc3ViVmFsdWUsIGJpdG1hc2ssIGN1c3RvbWl6ZXIsIGtleSwgdmFsdWUsIHN0YWNrKSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHZhciBrZXlzRnVuYyA9IGlzRnVsbAogICAgICAgID8gKGlzRmxhdCA/IGdldEFsbEtleXNJbiA6IGdldEFsbEtleXMpCiAgICAgICAgOiAoaXNGbGF0ID8ga2V5c0luIDoga2V5cyk7CgogICAgICB2YXIgcHJvcHMgPSBpc0FyciA/IHVuZGVmaW5lZCA6IGtleXNGdW5jKHZhbHVlKTsKICAgICAgYXJyYXlFYWNoKHByb3BzIHx8IHZhbHVlLCBmdW5jdGlvbihzdWJWYWx1ZSwga2V5KSB7CiAgICAgICAgaWYgKHByb3BzKSB7CiAgICAgICAgICBrZXkgPSBzdWJWYWx1ZTsKICAgICAgICAgIHN1YlZhbHVlID0gdmFsdWVba2V5XTsKICAgICAgICB9CiAgICAgICAgLy8gUmVjdXJzaXZlbHkgcG9wdWxhdGUgY2xvbmUgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKS4KICAgICAgICBhc3NpZ25WYWx1ZShyZXN1bHQsIGtleSwgYmFzZUNsb25lKHN1YlZhbHVlLCBiaXRtYXNrLCBjdXN0b21pemVyLCBrZXksIHZhbHVlLCBzdGFjaykpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmNvbmZvcm1zYCB3aGljaCBkb2Vzbid0IGNsb25lIGBzb3VyY2VgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBvYmplY3Qgb2YgcHJvcGVydHkgcHJlZGljYXRlcyB0byBjb25mb3JtIHRvLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgc3BlYyBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNvbmZvcm1zKHNvdXJjZSkgewogICAgICB2YXIgcHJvcHMgPSBrZXlzKHNvdXJjZSk7CiAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gYmFzZUNvbmZvcm1zVG8ob2JqZWN0LCBzb3VyY2UsIHByb3BzKTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmNvbmZvcm1zVG9gIHdoaWNoIGFjY2VwdHMgYHByb3BzYCB0byBjaGVjay4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBvYmplY3Qgb2YgcHJvcGVydHkgcHJlZGljYXRlcyB0byBjb25mb3JtIHRvLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGBvYmplY3RgIGNvbmZvcm1zLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VDb25mb3Jtc1RvKG9iamVjdCwgc291cmNlLCBwcm9wcykgewogICAgICB2YXIgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwogICAgICBpZiAob2JqZWN0ID09IG51bGwpIHsKICAgICAgICByZXR1cm4gIWxlbmd0aDsKICAgICAgfQogICAgICBvYmplY3QgPSBPYmplY3Qob2JqZWN0KTsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BzW2xlbmd0aF0sCiAgICAgICAgICAgIHByZWRpY2F0ZSA9IHNvdXJjZVtrZXldLAogICAgICAgICAgICB2YWx1ZSA9IG9iamVjdFtrZXldOwoKICAgICAgICBpZiAoKHZhbHVlID09PSB1bmRlZmluZWQgJiYgIShrZXkgaW4gb2JqZWN0KSkgfHwgIXByZWRpY2F0ZSh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5kZWxheWAgYW5kIGBfLmRlZmVyYCB3aGljaCBhY2NlcHRzIGBhcmdzYAogICAgICogdG8gcHJvdmlkZSB0byBgZnVuY2AuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlbGF5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgaW52b2NhdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBwcm92aWRlIHRvIGBmdW5jYC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ8T2JqZWN0fSBSZXR1cm5zIHRoZSB0aW1lciBpZCBvciB0aW1lb3V0IG9iamVjdC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZURlbGF5KGZ1bmMsIHdhaXQsIGFyZ3MpIHsKICAgICAgaWYgKHR5cGVvZiBmdW5jICE9ICdmdW5jdGlvbicpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKEZVTkNfRVJST1JfVEVYVCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgd2FpdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBtZXRob2RzIGxpa2UgYF8uZGlmZmVyZW5jZWAgd2l0aG91dCBzdXBwb3J0CiAgICAgKiBmb3IgZXhjbHVkaW5nIG11bHRpcGxlIGFycmF5cyBvciBpdGVyYXRlZSBzaG9ydGhhbmRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7QXJyYXl9IHZhbHVlcyBUaGUgdmFsdWVzIHRvIGV4Y2x1ZGUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWVdIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NvbXBhcmF0b3JdIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VEaWZmZXJlbmNlKGFycmF5LCB2YWx1ZXMsIGl0ZXJhdGVlLCBjb21wYXJhdG9yKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgaW5jbHVkZXMgPSBhcnJheUluY2x1ZGVzLAogICAgICAgICAgaXNDb21tb24gPSB0cnVlLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0gW10sCiAgICAgICAgICB2YWx1ZXNMZW5ndGggPSB2YWx1ZXMubGVuZ3RoOwoKICAgICAgaWYgKCFsZW5ndGgpIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmIChpdGVyYXRlZSkgewogICAgICAgIHZhbHVlcyA9IGFycmF5TWFwKHZhbHVlcywgYmFzZVVuYXJ5KGl0ZXJhdGVlKSk7CiAgICAgIH0KICAgICAgaWYgKGNvbXBhcmF0b3IpIHsKICAgICAgICBpbmNsdWRlcyA9IGFycmF5SW5jbHVkZXNXaXRoOwogICAgICAgIGlzQ29tbW9uID0gZmFsc2U7CiAgICAgIH0KICAgICAgZWxzZSBpZiAodmFsdWVzLmxlbmd0aCA+PSBMQVJHRV9BUlJBWV9TSVpFKSB7CiAgICAgICAgaW5jbHVkZXMgPSBjYWNoZUhhczsKICAgICAgICBpc0NvbW1vbiA9IGZhbHNlOwogICAgICAgIHZhbHVlcyA9IG5ldyBTZXRDYWNoZSh2YWx1ZXMpOwogICAgICB9CiAgICAgIG91dGVyOgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XSwKICAgICAgICAgICAgY29tcHV0ZWQgPSBpdGVyYXRlZSA9PSBudWxsID8gdmFsdWUgOiBpdGVyYXRlZSh2YWx1ZSk7CgogICAgICAgIHZhbHVlID0gKGNvbXBhcmF0b3IgfHwgdmFsdWUgIT09IDApID8gdmFsdWUgOiAwOwogICAgICAgIGlmIChpc0NvbW1vbiAmJiBjb21wdXRlZCA9PT0gY29tcHV0ZWQpIHsKICAgICAgICAgIHZhciB2YWx1ZXNJbmRleCA9IHZhbHVlc0xlbmd0aDsKICAgICAgICAgIHdoaWxlICh2YWx1ZXNJbmRleC0tKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZXNbdmFsdWVzSW5kZXhdID09PSBjb21wdXRlZCkgewogICAgICAgICAgICAgIGNvbnRpbnVlIG91dGVyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCFpbmNsdWRlcyh2YWx1ZXMsIGNvbXB1dGVkLCBjb21wYXJhdG9yKSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZm9yRWFjaGAgd2l0aG91dCBzdXBwb3J0IGZvciBpdGVyYXRlZSBzaG9ydGhhbmRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRlZSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fE9iamVjdH0gUmV0dXJucyBgY29sbGVjdGlvbmAuCiAgICAgKi8KICAgIHZhciBiYXNlRWFjaCA9IGNyZWF0ZUJhc2VFYWNoKGJhc2VGb3JPd24pOwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZm9yRWFjaFJpZ2h0YCB3aXRob3V0IHN1cHBvcnQgZm9yIGl0ZXJhdGVlIHNob3J0aGFuZHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fSBSZXR1cm5zIGBjb2xsZWN0aW9uYC4KICAgICAqLwogICAgdmFyIGJhc2VFYWNoUmlnaHQgPSBjcmVhdGVCYXNlRWFjaChiYXNlRm9yT3duUmlnaHQsIHRydWUpOwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZXZlcnlgIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZGljYXRlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYWxsIGVsZW1lbnRzIHBhc3MgdGhlIHByZWRpY2F0ZSBjaGVjaywKICAgICAqICBlbHNlIGBmYWxzZWAKICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUV2ZXJ5KGNvbGxlY3Rpb24sIHByZWRpY2F0ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgICAgYmFzZUVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmVzdWx0ID0gISFwcmVkaWNhdGUodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIG1ldGhvZHMgbGlrZSBgXy5tYXhgIGFuZCBgXy5taW5gIHdoaWNoIGFjY2VwdHMgYQogICAgICogYGNvbXBhcmF0b3JgIHRvIGRldGVybWluZSB0aGUgZXh0cmVtdW0gdmFsdWUuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRlZSBUaGUgaXRlcmF0ZWUgaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29tcGFyYXRvciBUaGUgY29tcGFyYXRvciB1c2VkIHRvIGNvbXBhcmUgdmFsdWVzLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGV4dHJlbXVtIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlRXh0cmVtdW0oYXJyYXksIGl0ZXJhdGVlLCBjb21wYXJhdG9yKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF0sCiAgICAgICAgICAgIGN1cnJlbnQgPSBpdGVyYXRlZSh2YWx1ZSk7CgogICAgICAgIGlmIChjdXJyZW50ICE9IG51bGwgJiYgKGNvbXB1dGVkID09PSB1bmRlZmluZWQKICAgICAgICAgICAgICA/IChjdXJyZW50ID09PSBjdXJyZW50ICYmICFpc1N5bWJvbChjdXJyZW50KSkKICAgICAgICAgICAgICA6IGNvbXBhcmF0b3IoY3VycmVudCwgY29tcHV0ZWQpCiAgICAgICAgICAgICkpIHsKICAgICAgICAgIHZhciBjb21wdXRlZCA9IGN1cnJlbnQsCiAgICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5maWxsYCB3aXRob3V0IGFuIGl0ZXJhdGVlIGNhbGwgZ3VhcmQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmaWxsLgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZmlsbCBgYXJyYXlgIHdpdGguCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3N0YXJ0PTBdIFRoZSBzdGFydCBwb3NpdGlvbi4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZW5kPWFycmF5Lmxlbmd0aF0gVGhlIGVuZCBwb3NpdGlvbi4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBgYXJyYXlgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlRmlsbChhcnJheSwgdmFsdWUsIHN0YXJ0LCBlbmQpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICAgIHN0YXJ0ID0gdG9JbnRlZ2VyKHN0YXJ0KTsKICAgICAgaWYgKHN0YXJ0IDwgMCkgewogICAgICAgIHN0YXJ0ID0gLXN0YXJ0ID4gbGVuZ3RoID8gMCA6IChsZW5ndGggKyBzdGFydCk7CiAgICAgIH0KICAgICAgZW5kID0gKGVuZCA9PT0gdW5kZWZpbmVkIHx8IGVuZCA+IGxlbmd0aCkgPyBsZW5ndGggOiB0b0ludGVnZXIoZW5kKTsKICAgICAgaWYgKGVuZCA8IDApIHsKICAgICAgICBlbmQgKz0gbGVuZ3RoOwogICAgICB9CiAgICAgIGVuZCA9IHN0YXJ0ID4gZW5kID8gMCA6IHRvTGVuZ3RoKGVuZCk7CiAgICAgIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgICAgIGFycmF5W3N0YXJ0KytdID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZmlsdGVyYCB3aXRob3V0IHN1cHBvcnQgZm9yIGl0ZXJhdGVlIHNob3J0aGFuZHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByZWRpY2F0ZSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZmlsdGVyZWQgYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VGaWx0ZXIoY29sbGVjdGlvbiwgcHJlZGljYXRlKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgYmFzZUVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmZsYXR0ZW5gIHdpdGggc3VwcG9ydCBmb3IgcmVzdHJpY3RpbmcgZmxhdHRlbmluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZsYXR0ZW4uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZGVwdGggVGhlIG1heGltdW0gcmVjdXJzaW9uIGRlcHRoLgogICAgICogQHBhcmFtIHtib29sZWFufSBbcHJlZGljYXRlPWlzRmxhdHRlbmFibGVdIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1N0cmljdF0gUmVzdHJpY3QgdG8gdmFsdWVzIHRoYXQgcGFzcyBgcHJlZGljYXRlYCBjaGVja3MuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbcmVzdWx0PVtdXSBUaGUgaW5pdGlhbCByZXN1bHQgdmFsdWUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VGbGF0dGVuKGFycmF5LCBkZXB0aCwgcHJlZGljYXRlLCBpc1N0cmljdCwgcmVzdWx0KSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgICAgcHJlZGljYXRlIHx8IChwcmVkaWNhdGUgPSBpc0ZsYXR0ZW5hYmxlKTsKICAgICAgcmVzdWx0IHx8IChyZXN1bHQgPSBbXSk7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgICBpZiAoZGVwdGggPiAwICYmIHByZWRpY2F0ZSh2YWx1ZSkpIHsKICAgICAgICAgIGlmIChkZXB0aCA+IDEpIHsKICAgICAgICAgICAgLy8gUmVjdXJzaXZlbHkgZmxhdHRlbiBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKS4KICAgICAgICAgICAgYmFzZUZsYXR0ZW4odmFsdWUsIGRlcHRoIC0gMSwgcHJlZGljYXRlLCBpc1N0cmljdCwgcmVzdWx0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGFycmF5UHVzaChyZXN1bHQsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFpc1N0cmljdCkgewogICAgICAgICAgcmVzdWx0W3Jlc3VsdC5sZW5ndGhdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgYmFzZUZvck93bmAgd2hpY2ggaXRlcmF0ZXMgb3ZlciBgb2JqZWN0YAogICAgICogcHJvcGVydGllcyByZXR1cm5lZCBieSBga2V5c0Z1bmNgIGFuZCBpbnZva2VzIGBpdGVyYXRlZWAgZm9yIGVhY2ggcHJvcGVydHkuCiAgICAgKiBJdGVyYXRlZSBmdW5jdGlvbnMgbWF5IGV4aXQgaXRlcmF0aW9uIGVhcmx5IGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRlZSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0ga2V5c0Z1bmMgVGhlIGZ1bmN0aW9uIHRvIGdldCB0aGUga2V5cyBvZiBgb2JqZWN0YC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKi8KICAgIHZhciBiYXNlRm9yID0gY3JlYXRlQmFzZUZvcigpOwoKICAgIC8qKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyBsaWtlIGBiYXNlRm9yYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIHByb3BlcnRpZXMKICAgICAqIGluIHRoZSBvcHBvc2l0ZSBvcmRlci4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBrZXlzRnVuYyBUaGUgZnVuY3Rpb24gdG8gZ2V0IHRoZSBrZXlzIG9mIGBvYmplY3RgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqLwogICAgdmFyIGJhc2VGb3JSaWdodCA9IGNyZWF0ZUJhc2VGb3IodHJ1ZSk7CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5mb3JPd25gIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlRm9yT3duKG9iamVjdCwgaXRlcmF0ZWUpIHsKICAgICAgcmV0dXJuIG9iamVjdCAmJiBiYXNlRm9yKG9iamVjdCwgaXRlcmF0ZWUsIGtleXMpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZm9yT3duUmlnaHRgIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlRm9yT3duUmlnaHQob2JqZWN0LCBpdGVyYXRlZSkgewogICAgICByZXR1cm4gb2JqZWN0ICYmIGJhc2VGb3JSaWdodChvYmplY3QsIGl0ZXJhdGVlLCBrZXlzKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmZ1bmN0aW9uc2Agd2hpY2ggY3JlYXRlcyBhbiBhcnJheSBvZgogICAgICogYG9iamVjdGAgZnVuY3Rpb24gcHJvcGVydHkgbmFtZXMgZmlsdGVyZWQgZnJvbSBgcHJvcHNgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7QXJyYXl9IHByb3BzIFRoZSBwcm9wZXJ0eSBuYW1lcyB0byBmaWx0ZXIuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGZ1bmN0aW9uIG5hbWVzLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlRnVuY3Rpb25zKG9iamVjdCwgcHJvcHMpIHsKICAgICAgcmV0dXJuIGFycmF5RmlsdGVyKHByb3BzLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gaXNGdW5jdGlvbihvYmplY3Rba2V5XSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZ2V0YCB3aXRob3V0IHN1cHBvcnQgZm9yIGRlZmF1bHQgdmFsdWVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgcHJvcGVydHkgdG8gZ2V0LgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlR2V0KG9iamVjdCwgcGF0aCkgewogICAgICBwYXRoID0gY2FzdFBhdGgocGF0aCwgb2JqZWN0KTsKCiAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICBsZW5ndGggPSBwYXRoLmxlbmd0aDsKCiAgICAgIHdoaWxlIChvYmplY3QgIT0gbnVsbCAmJiBpbmRleCA8IGxlbmd0aCkgewogICAgICAgIG9iamVjdCA9IG9iamVjdFt0b0tleShwYXRoW2luZGV4KytdKV07CiAgICAgIH0KICAgICAgcmV0dXJuIChpbmRleCAmJiBpbmRleCA9PSBsZW5ndGgpID8gb2JqZWN0IDogdW5kZWZpbmVkOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYGdldEFsbEtleXNgIGFuZCBgZ2V0QWxsS2V5c0luYCB3aGljaCB1c2VzCiAgICAgKiBga2V5c0Z1bmNgIGFuZCBgc3ltYm9sc0Z1bmNgIHRvIGdldCB0aGUgZW51bWVyYWJsZSBwcm9wZXJ0eSBuYW1lcyBhbmQKICAgICAqIHN5bWJvbHMgb2YgYG9iamVjdGAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGtleXNGdW5jIFRoZSBmdW5jdGlvbiB0byBnZXQgdGhlIGtleXMgb2YgYG9iamVjdGAuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBzeW1ib2xzRnVuYyBUaGUgZnVuY3Rpb24gdG8gZ2V0IHRoZSBzeW1ib2xzIG9mIGBvYmplY3RgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyBhbmQgc3ltYm9scy4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUdldEFsbEtleXMob2JqZWN0LCBrZXlzRnVuYywgc3ltYm9sc0Z1bmMpIHsKICAgICAgdmFyIHJlc3VsdCA9IGtleXNGdW5jKG9iamVjdCk7CiAgICAgIHJldHVybiBpc0FycmF5KG9iamVjdCkgPyByZXN1bHQgOiBhcnJheVB1c2gocmVzdWx0LCBzeW1ib2xzRnVuYyhvYmplY3QpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBnZXRUYWdgIHdpdGhvdXQgZmFsbGJhY2tzIGZvciBidWdneSBlbnZpcm9ubWVudHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHF1ZXJ5LgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgYHRvU3RyaW5nVGFnYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUdldFRhZyh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkVGFnIDogbnVsbFRhZzsKICAgICAgfQogICAgICByZXR1cm4gKHN5bVRvU3RyaW5nVGFnICYmIHN5bVRvU3RyaW5nVGFnIGluIE9iamVjdCh2YWx1ZSkpCiAgICAgICAgPyBnZXRSYXdUYWcodmFsdWUpCiAgICAgICAgOiBvYmplY3RUb1N0cmluZyh2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5ndGAgd2hpY2ggZG9lc24ndCBjb2VyY2UgYXJndW1lbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBvdGhlciBUaGUgb3RoZXIgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGdyZWF0ZXIgdGhhbiBgb3RoZXJgLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUd0KHZhbHVlLCBvdGhlcikgewogICAgICByZXR1cm4gdmFsdWUgPiBvdGhlcjsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmhhc2Agd2l0aG91dCBzdXBwb3J0IGZvciBkZWVwIHBhdGhzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29iamVjdF0gVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBrZXkgVGhlIGtleSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBga2V5YCBleGlzdHMsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUhhcyhvYmplY3QsIGtleSkgewogICAgICByZXR1cm4gb2JqZWN0ICE9IG51bGwgJiYgaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5oYXNJbmAgd2l0aG91dCBzdXBwb3J0IGZvciBkZWVwIHBhdGhzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29iamVjdF0gVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBrZXkgVGhlIGtleSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBga2V5YCBleGlzdHMsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUhhc0luKG9iamVjdCwga2V5KSB7CiAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCAmJiBrZXkgaW4gT2JqZWN0KG9iamVjdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pblJhbmdlYCB3aGljaCBkb2Vzbid0IGNvZXJjZSBhcmd1bWVudHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW1iZXIgVGhlIG51bWJlciB0byBjaGVjay4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCBUaGUgc3RhcnQgb2YgdGhlIHJhbmdlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGVuZCBUaGUgZW5kIG9mIHRoZSByYW5nZS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgbnVtYmVyYCBpcyBpbiB0aGUgcmFuZ2UsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUluUmFuZ2UobnVtYmVyLCBzdGFydCwgZW5kKSB7CiAgICAgIHJldHVybiBudW1iZXIgPj0gbmF0aXZlTWluKHN0YXJ0LCBlbmQpICYmIG51bWJlciA8IG5hdGl2ZU1heChzdGFydCwgZW5kKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIG1ldGhvZHMgbGlrZSBgXy5pbnRlcnNlY3Rpb25gLCB3aXRob3V0IHN1cHBvcnQKICAgICAqIGZvciBpdGVyYXRlZSBzaG9ydGhhbmRzLCB0aGF0IGFjY2VwdHMgYW4gYXJyYXkgb2YgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5cyBUaGUgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWVdIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NvbXBhcmF0b3JdIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBzaGFyZWQgdmFsdWVzLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlSW50ZXJzZWN0aW9uKGFycmF5cywgaXRlcmF0ZWUsIGNvbXBhcmF0b3IpIHsKICAgICAgdmFyIGluY2x1ZGVzID0gY29tcGFyYXRvciA/IGFycmF5SW5jbHVkZXNXaXRoIDogYXJyYXlJbmNsdWRlcywKICAgICAgICAgIGxlbmd0aCA9IGFycmF5c1swXS5sZW5ndGgsCiAgICAgICAgICBvdGhMZW5ndGggPSBhcnJheXMubGVuZ3RoLAogICAgICAgICAgb3RoSW5kZXggPSBvdGhMZW5ndGgsCiAgICAgICAgICBjYWNoZXMgPSBBcnJheShvdGhMZW5ndGgpLAogICAgICAgICAgbWF4TGVuZ3RoID0gSW5maW5pdHksCiAgICAgICAgICByZXN1bHQgPSBbXTsKCiAgICAgIHdoaWxlIChvdGhJbmRleC0tKSB7CiAgICAgICAgdmFyIGFycmF5ID0gYXJyYXlzW290aEluZGV4XTsKICAgICAgICBpZiAob3RoSW5kZXggJiYgaXRlcmF0ZWUpIHsKICAgICAgICAgIGFycmF5ID0gYXJyYXlNYXAoYXJyYXksIGJhc2VVbmFyeShpdGVyYXRlZSkpOwogICAgICAgIH0KICAgICAgICBtYXhMZW5ndGggPSBuYXRpdmVNaW4oYXJyYXkubGVuZ3RoLCBtYXhMZW5ndGgpOwogICAgICAgIGNhY2hlc1tvdGhJbmRleF0gPSAhY29tcGFyYXRvciAmJiAoaXRlcmF0ZWUgfHwgKGxlbmd0aCA+PSAxMjAgJiYgYXJyYXkubGVuZ3RoID49IDEyMCkpCiAgICAgICAgICA/IG5ldyBTZXRDYWNoZShvdGhJbmRleCAmJiBhcnJheSkKICAgICAgICAgIDogdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGFycmF5ID0gYXJyYXlzWzBdOwoKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBzZWVuID0gY2FjaGVzWzBdOwoKICAgICAgb3V0ZXI6CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoICYmIHJlc3VsdC5sZW5ndGggPCBtYXhMZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF0sCiAgICAgICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUgPyBpdGVyYXRlZSh2YWx1ZSkgOiB2YWx1ZTsKCiAgICAgICAgdmFsdWUgPSAoY29tcGFyYXRvciB8fCB2YWx1ZSAhPT0gMCkgPyB2YWx1ZSA6IDA7CiAgICAgICAgaWYgKCEoc2VlbgogICAgICAgICAgICAgID8gY2FjaGVIYXMoc2VlbiwgY29tcHV0ZWQpCiAgICAgICAgICAgICAgOiBpbmNsdWRlcyhyZXN1bHQsIGNvbXB1dGVkLCBjb21wYXJhdG9yKQogICAgICAgICAgICApKSB7CiAgICAgICAgICBvdGhJbmRleCA9IG90aExlbmd0aDsKICAgICAgICAgIHdoaWxlICgtLW90aEluZGV4KSB7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IGNhY2hlc1tvdGhJbmRleF07CiAgICAgICAgICAgIGlmICghKGNhY2hlCiAgICAgICAgICAgICAgICAgID8gY2FjaGVIYXMoY2FjaGUsIGNvbXB1dGVkKQogICAgICAgICAgICAgICAgICA6IGluY2x1ZGVzKGFycmF5c1tvdGhJbmRleF0sIGNvbXB1dGVkLCBjb21wYXJhdG9yKSkKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGNvbnRpbnVlIG91dGVyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2VlbikgewogICAgICAgICAgICBzZWVuLnB1c2goY29tcHV0ZWQpOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaW52ZXJ0YCBhbmQgYF8uaW52ZXJ0QnlgIHdoaWNoIGludmVydHMKICAgICAqIGBvYmplY3RgIHdpdGggdmFsdWVzIHRyYW5zZm9ybWVkIGJ5IGBpdGVyYXRlZWAgYW5kIHNldCBieSBgc2V0dGVyYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHNldHRlciBUaGUgZnVuY3Rpb24gdG8gc2V0IGBhY2N1bXVsYXRvcmAgdmFsdWVzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0ZWUgVGhlIGl0ZXJhdGVlIHRvIHRyYW5zZm9ybSB2YWx1ZXMuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gYWNjdW11bGF0b3IgVGhlIGluaXRpYWwgaW52ZXJ0ZWQgb2JqZWN0LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIGBhY2N1bXVsYXRvcmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VJbnZlcnRlcihvYmplY3QsIHNldHRlciwgaXRlcmF0ZWUsIGFjY3VtdWxhdG9yKSB7CiAgICAgIGJhc2VGb3JPd24ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICBzZXR0ZXIoYWNjdW11bGF0b3IsIGl0ZXJhdGVlKHZhbHVlKSwga2V5LCBvYmplY3QpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaW52b2tlYCB3aXRob3V0IHN1cHBvcnQgZm9yIGluZGl2aWR1YWwKICAgICAqIG1ldGhvZCBhcmd1bWVudHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBwYXRoIFRoZSBwYXRoIG9mIHRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgICogQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGludm9rZSB0aGUgbWV0aG9kIHdpdGguCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgcmVzdWx0IG9mIHRoZSBpbnZva2VkIG1ldGhvZC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUludm9rZShvYmplY3QsIHBhdGgsIGFyZ3MpIHsKICAgICAgcGF0aCA9IGNhc3RQYXRoKHBhdGgsIG9iamVjdCk7CiAgICAgIG9iamVjdCA9IHBhcmVudChvYmplY3QsIHBhdGgpOwogICAgICB2YXIgZnVuYyA9IG9iamVjdCA9PSBudWxsID8gb2JqZWN0IDogb2JqZWN0W3RvS2V5KGxhc3QocGF0aCkpXTsKICAgICAgcmV0dXJuIGZ1bmMgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IGFwcGx5KGZ1bmMsIG9iamVjdCwgYXJncyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pc0FyZ3VtZW50c2AuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYW4gYGFyZ3VtZW50c2Agb2JqZWN0LAogICAgICovCiAgICBmdW5jdGlvbiBiYXNlSXNBcmd1bWVudHModmFsdWUpIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgYmFzZUdldFRhZyh2YWx1ZSkgPT0gYXJnc1RhZzsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmlzQXJyYXlCdWZmZXJgIHdpdGhvdXQgTm9kZS5qcyBvcHRpbWl6YXRpb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGFuIGFycmF5IGJ1ZmZlciwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlSXNBcnJheUJ1ZmZlcih2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBiYXNlR2V0VGFnKHZhbHVlKSA9PSBhcnJheUJ1ZmZlclRhZzsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmlzRGF0ZWAgd2l0aG91dCBOb2RlLmpzIG9wdGltaXphdGlvbnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBkYXRlIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlSXNEYXRlKHZhbHVlKSB7CiAgICAgIHJldHVybiBpc09iamVjdExpa2UodmFsdWUpICYmIGJhc2VHZXRUYWcodmFsdWUpID09IGRhdGVUYWc7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pc0VxdWFsYCB3aGljaCBzdXBwb3J0cyBwYXJ0aWFsIGNvbXBhcmlzb25zCiAgICAgKiBhbmQgdHJhY2tzIHRyYXZlcnNlZCBvYmplY3RzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBvdGhlciBUaGUgb3RoZXIgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gYml0bWFzayBUaGUgYml0bWFzayBmbGFncy4KICAgICAqICAxIC0gVW5vcmRlcmVkIGNvbXBhcmlzb24KICAgICAqICAyIC0gUGFydGlhbCBjb21wYXJpc29uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY3VzdG9taXplcl0gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBjb21wYXJpc29ucy4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbc3RhY2tdIFRyYWNrcyB0cmF2ZXJzZWQgYHZhbHVlYCBhbmQgYG90aGVyYCBvYmplY3RzLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUlzRXF1YWwodmFsdWUsIG90aGVyLCBiaXRtYXNrLCBjdXN0b21pemVyLCBzdGFjaykgewogICAgICBpZiAodmFsdWUgPT09IG90aGVyKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlID09IG51bGwgfHwgb3RoZXIgPT0gbnVsbCB8fCAoIWlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgIWlzT2JqZWN0TGlrZShvdGhlcikpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlICE9PSB2YWx1ZSAmJiBvdGhlciAhPT0gb3RoZXI7CiAgICAgIH0KICAgICAgcmV0dXJuIGJhc2VJc0VxdWFsRGVlcCh2YWx1ZSwgb3RoZXIsIGJpdG1hc2ssIGN1c3RvbWl6ZXIsIGJhc2VJc0VxdWFsLCBzdGFjayk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYGJhc2VJc0VxdWFsYCBmb3IgYXJyYXlzIGFuZCBvYmplY3RzIHdoaWNoIHBlcmZvcm1zCiAgICAgKiBkZWVwIGNvbXBhcmlzb25zIGFuZCB0cmFja3MgdHJhdmVyc2VkIG9iamVjdHMgZW5hYmxpbmcgb2JqZWN0cyB3aXRoIGNpcmN1bGFyCiAgICAgKiByZWZlcmVuY2VzIHRvIGJlIGNvbXBhcmVkLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvdGhlciBUaGUgb3RoZXIgb2JqZWN0IHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYml0bWFzayBUaGUgYml0bWFzayBmbGFncy4gU2VlIGBiYXNlSXNFcXVhbGAgZm9yIG1vcmUgZGV0YWlscy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGN1c3RvbWl6ZXIgVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBjb21wYXJpc29ucy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVxdWFsRnVuYyBUaGUgZnVuY3Rpb24gdG8gZGV0ZXJtaW5lIGVxdWl2YWxlbnRzIG9mIHZhbHVlcy4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbc3RhY2tdIFRyYWNrcyB0cmF2ZXJzZWQgYG9iamVjdGAgYW5kIGBvdGhlcmAgb2JqZWN0cy4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgb2JqZWN0cyBhcmUgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlSXNFcXVhbERlZXAob2JqZWN0LCBvdGhlciwgYml0bWFzaywgY3VzdG9taXplciwgZXF1YWxGdW5jLCBzdGFjaykgewogICAgICB2YXIgb2JqSXNBcnIgPSBpc0FycmF5KG9iamVjdCksCiAgICAgICAgICBvdGhJc0FyciA9IGlzQXJyYXkob3RoZXIpLAogICAgICAgICAgb2JqVGFnID0gb2JqSXNBcnIgPyBhcnJheVRhZyA6IGdldFRhZyhvYmplY3QpLAogICAgICAgICAgb3RoVGFnID0gb3RoSXNBcnIgPyBhcnJheVRhZyA6IGdldFRhZyhvdGhlcik7CgogICAgICBvYmpUYWcgPSBvYmpUYWcgPT0gYXJnc1RhZyA/IG9iamVjdFRhZyA6IG9ialRhZzsKICAgICAgb3RoVGFnID0gb3RoVGFnID09IGFyZ3NUYWcgPyBvYmplY3RUYWcgOiBvdGhUYWc7CgogICAgICB2YXIgb2JqSXNPYmogPSBvYmpUYWcgPT0gb2JqZWN0VGFnLAogICAgICAgICAgb3RoSXNPYmogPSBvdGhUYWcgPT0gb2JqZWN0VGFnLAogICAgICAgICAgaXNTYW1lVGFnID0gb2JqVGFnID09IG90aFRhZzsKCiAgICAgIGlmIChpc1NhbWVUYWcgJiYgaXNCdWZmZXIob2JqZWN0KSkgewogICAgICAgIGlmICghaXNCdWZmZXIob3RoZXIpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIG9iaklzQXJyID0gdHJ1ZTsKICAgICAgICBvYmpJc09iaiA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChpc1NhbWVUYWcgJiYgIW9iaklzT2JqKSB7CiAgICAgICAgc3RhY2sgfHwgKHN0YWNrID0gbmV3IFN0YWNrKTsKICAgICAgICByZXR1cm4gKG9iaklzQXJyIHx8IGlzVHlwZWRBcnJheShvYmplY3QpKQogICAgICAgICAgPyBlcXVhbEFycmF5cyhvYmplY3QsIG90aGVyLCBiaXRtYXNrLCBjdXN0b21pemVyLCBlcXVhbEZ1bmMsIHN0YWNrKQogICAgICAgICAgOiBlcXVhbEJ5VGFnKG9iamVjdCwgb3RoZXIsIG9ialRhZywgYml0bWFzaywgY3VzdG9taXplciwgZXF1YWxGdW5jLCBzdGFjayk7CiAgICAgIH0KICAgICAgaWYgKCEoYml0bWFzayAmIENPTVBBUkVfUEFSVElBTF9GTEFHKSkgewogICAgICAgIHZhciBvYmpJc1dyYXBwZWQgPSBvYmpJc09iaiAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgJ19fd3JhcHBlZF9fJyksCiAgICAgICAgICAgIG90aElzV3JhcHBlZCA9IG90aElzT2JqICYmIGhhc093blByb3BlcnR5LmNhbGwob3RoZXIsICdfX3dyYXBwZWRfXycpOwoKICAgICAgICBpZiAob2JqSXNXcmFwcGVkIHx8IG90aElzV3JhcHBlZCkgewogICAgICAgICAgdmFyIG9ialVud3JhcHBlZCA9IG9iaklzV3JhcHBlZCA/IG9iamVjdC52YWx1ZSgpIDogb2JqZWN0LAogICAgICAgICAgICAgIG90aFVud3JhcHBlZCA9IG90aElzV3JhcHBlZCA/IG90aGVyLnZhbHVlKCkgOiBvdGhlcjsKCiAgICAgICAgICBzdGFjayB8fCAoc3RhY2sgPSBuZXcgU3RhY2spOwogICAgICAgICAgcmV0dXJuIGVxdWFsRnVuYyhvYmpVbndyYXBwZWQsIG90aFVud3JhcHBlZCwgYml0bWFzaywgY3VzdG9taXplciwgc3RhY2spOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWlzU2FtZVRhZykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBzdGFjayB8fCAoc3RhY2sgPSBuZXcgU3RhY2spOwogICAgICByZXR1cm4gZXF1YWxPYmplY3RzKG9iamVjdCwgb3RoZXIsIGJpdG1hc2ssIGN1c3RvbWl6ZXIsIGVxdWFsRnVuYywgc3RhY2spOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaXNNYXBgIHdpdGhvdXQgTm9kZS5qcyBvcHRpbWl6YXRpb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgbWFwLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VJc01hcCh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBnZXRUYWcodmFsdWUpID09IG1hcFRhZzsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmlzTWF0Y2hgIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBvYmplY3Qgb2YgcHJvcGVydHkgdmFsdWVzIHRvIG1hdGNoLgogICAgICogQHBhcmFtIHtBcnJheX0gbWF0Y2hEYXRhIFRoZSBwcm9wZXJ0eSBuYW1lcywgdmFsdWVzLCBhbmQgY29tcGFyZSBmbGFncyB0byBtYXRjaC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjdXN0b21pemVyXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmlzb25zLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGBvYmplY3RgIGlzIGEgbWF0Y2gsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUlzTWF0Y2gob2JqZWN0LCBzb3VyY2UsIG1hdGNoRGF0YSwgY3VzdG9taXplcikgewogICAgICB2YXIgaW5kZXggPSBtYXRjaERhdGEubGVuZ3RoLAogICAgICAgICAgbGVuZ3RoID0gaW5kZXgsCiAgICAgICAgICBub0N1c3RvbWl6ZXIgPSAhY3VzdG9taXplcjsKCiAgICAgIGlmIChvYmplY3QgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAhbGVuZ3RoOwogICAgICB9CiAgICAgIG9iamVjdCA9IE9iamVjdChvYmplY3QpOwogICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgIHZhciBkYXRhID0gbWF0Y2hEYXRhW2luZGV4XTsKICAgICAgICBpZiAoKG5vQ3VzdG9taXplciAmJiBkYXRhWzJdKQogICAgICAgICAgICAgID8gZGF0YVsxXSAhPT0gb2JqZWN0W2RhdGFbMF1dCiAgICAgICAgICAgICAgOiAhKGRhdGFbMF0gaW4gb2JqZWN0KQogICAgICAgICAgICApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBkYXRhID0gbWF0Y2hEYXRhW2luZGV4XTsKICAgICAgICB2YXIga2V5ID0gZGF0YVswXSwKICAgICAgICAgICAgb2JqVmFsdWUgPSBvYmplY3Rba2V5XSwKICAgICAgICAgICAgc3JjVmFsdWUgPSBkYXRhWzFdOwoKICAgICAgICBpZiAobm9DdXN0b21pemVyICYmIGRhdGFbMl0pIHsKICAgICAgICAgIGlmIChvYmpWYWx1ZSA9PT0gdW5kZWZpbmVkICYmICEoa2V5IGluIG9iamVjdCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgc3RhY2sgPSBuZXcgU3RhY2s7CiAgICAgICAgICBpZiAoY3VzdG9taXplcikgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gY3VzdG9taXplcihvYmpWYWx1ZSwgc3JjVmFsdWUsIGtleSwgb2JqZWN0LCBzb3VyY2UsIHN0YWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKHJlc3VsdCA9PT0gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICA/IGJhc2VJc0VxdWFsKHNyY1ZhbHVlLCBvYmpWYWx1ZSwgQ09NUEFSRV9QQVJUSUFMX0ZMQUcgfCBDT01QQVJFX1VOT1JERVJFRF9GTEFHLCBjdXN0b21pemVyLCBzdGFjaykKICAgICAgICAgICAgICAgIDogcmVzdWx0CiAgICAgICAgICAgICAgKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaXNOYXRpdmVgIHdpdGhvdXQgYmFkIHNoaW0gY2hlY2tzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgbmF0aXZlIGZ1bmN0aW9uLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUlzTmF0aXZlKHZhbHVlKSB7CiAgICAgIGlmICghaXNPYmplY3QodmFsdWUpIHx8IGlzTWFza2VkKHZhbHVlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB2YXIgcGF0dGVybiA9IGlzRnVuY3Rpb24odmFsdWUpID8gcmVJc05hdGl2ZSA6IHJlSXNIb3N0Q3RvcjsKICAgICAgcmV0dXJuIHBhdHRlcm4udGVzdCh0b1NvdXJjZSh2YWx1ZSkpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaXNSZWdFeHBgIHdpdGhvdXQgTm9kZS5qcyBvcHRpbWl6YXRpb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgcmVnZXhwLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VJc1JlZ0V4cCh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBiYXNlR2V0VGFnKHZhbHVlKSA9PSByZWdleHBUYWc7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pc1NldGAgd2l0aG91dCBOb2RlLmpzIG9wdGltaXphdGlvbnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBzZXQsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUlzU2V0KHZhbHVlKSB7CiAgICAgIHJldHVybiBpc09iamVjdExpa2UodmFsdWUpICYmIGdldFRhZyh2YWx1ZSkgPT0gc2V0VGFnOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaXNUeXBlZEFycmF5YCB3aXRob3V0IE5vZGUuanMgb3B0aW1pemF0aW9ucy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHR5cGVkIGFycmF5LCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VJc1R5cGVkQXJyYXkodmFsdWUpIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYKICAgICAgICBpc0xlbmd0aCh2YWx1ZS5sZW5ndGgpICYmICEhdHlwZWRBcnJheVRhZ3NbYmFzZUdldFRhZyh2YWx1ZSldOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaXRlcmF0ZWVgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IFt2YWx1ZT1fLmlkZW50aXR5XSBUaGUgdmFsdWUgdG8gY29udmVydCB0byBhbiBpdGVyYXRlZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgaXRlcmF0ZWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VJdGVyYXRlZSh2YWx1ZSkgewogICAgICAvLyBEb24ndCBzdG9yZSB0aGUgYHR5cGVvZmAgcmVzdWx0IGluIGEgdmFyaWFibGUgdG8gYXZvaWQgYSBKSVQgYnVnIGluIFNhZmFyaSA5LgogICAgICAvLyBTZWUgaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTE1NjAzNCBmb3IgbW9yZSBkZXRhaWxzLgogICAgICBpZiAodHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICByZXR1cm4gaWRlbnRpdHk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JykgewogICAgICAgIHJldHVybiBpc0FycmF5KHZhbHVlKQogICAgICAgICAgPyBiYXNlTWF0Y2hlc1Byb3BlcnR5KHZhbHVlWzBdLCB2YWx1ZVsxXSkKICAgICAgICAgIDogYmFzZU1hdGNoZXModmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiBwcm9wZXJ0eSh2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5rZXlzYCB3aGljaCBkb2Vzbid0IHRyZWF0IHNwYXJzZSBhcnJheXMgYXMgZGVuc2UuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VLZXlzKG9iamVjdCkgewogICAgICBpZiAoIWlzUHJvdG90eXBlKG9iamVjdCkpIHsKICAgICAgICByZXR1cm4gbmF0aXZlS2V5cyhvYmplY3QpOwogICAgICB9CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgZm9yICh2YXIga2V5IGluIE9iamVjdChvYmplY3QpKSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIGtleSAhPSAnY29uc3RydWN0b3InKSB7CiAgICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8ua2V5c0luYCB3aGljaCBkb2Vzbid0IHRyZWF0IHNwYXJzZSBhcnJheXMgYXMgZGVuc2UuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VLZXlzSW4ob2JqZWN0KSB7CiAgICAgIGlmICghaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgIHJldHVybiBuYXRpdmVLZXlzSW4ob2JqZWN0KTsKICAgICAgfQogICAgICB2YXIgaXNQcm90byA9IGlzUHJvdG90eXBlKG9iamVjdCksCiAgICAgICAgICByZXN1bHQgPSBbXTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICBpZiAoIShrZXkgPT0gJ2NvbnN0cnVjdG9yJyAmJiAoaXNQcm90byB8fCAhaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpKSkgewogICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmx0YCB3aGljaCBkb2Vzbid0IGNvZXJjZSBhcmd1bWVudHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IG90aGVyIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgbGVzcyB0aGFuIGBvdGhlcmAsCiAgICAgKiAgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlTHQodmFsdWUsIG90aGVyKSB7CiAgICAgIHJldHVybiB2YWx1ZSA8IG90aGVyOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8ubWFwYCB3aXRob3V0IHN1cHBvcnQgZm9yIGl0ZXJhdGVlIHNob3J0aGFuZHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdGVlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBtYXBwZWQgYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VNYXAoY29sbGVjdGlvbiwgaXRlcmF0ZWUpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICByZXN1bHQgPSBpc0FycmF5TGlrZShjb2xsZWN0aW9uKSA/IEFycmF5KGNvbGxlY3Rpb24ubGVuZ3RoKSA6IFtdOwoKICAgICAgYmFzZUVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICAgIHJlc3VsdFsrK2luZGV4XSA9IGl0ZXJhdGVlKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLm1hdGNoZXNgIHdoaWNoIGRvZXNuJ3QgY2xvbmUgYHNvdXJjZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UgVGhlIG9iamVjdCBvZiBwcm9wZXJ0eSB2YWx1ZXMgdG8gbWF0Y2guCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBzcGVjIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlTWF0Y2hlcyhzb3VyY2UpIHsKICAgICAgdmFyIG1hdGNoRGF0YSA9IGdldE1hdGNoRGF0YShzb3VyY2UpOwogICAgICBpZiAobWF0Y2hEYXRhLmxlbmd0aCA9PSAxICYmIG1hdGNoRGF0YVswXVsyXSkgewogICAgICAgIHJldHVybiBtYXRjaGVzU3RyaWN0Q29tcGFyYWJsZShtYXRjaERhdGFbMF1bMF0sIG1hdGNoRGF0YVswXVsxXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiBvYmplY3QgPT09IHNvdXJjZSB8fCBiYXNlSXNNYXRjaChvYmplY3QsIHNvdXJjZSwgbWF0Y2hEYXRhKTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLm1hdGNoZXNQcm9wZXJ0eWAgd2hpY2ggZG9lc24ndCBjbG9uZSBgc3JjVmFsdWVgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgcHJvcGVydHkgdG8gZ2V0LgogICAgICogQHBhcmFtIHsqfSBzcmNWYWx1ZSBUaGUgdmFsdWUgdG8gbWF0Y2guCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBzcGVjIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlTWF0Y2hlc1Byb3BlcnR5KHBhdGgsIHNyY1ZhbHVlKSB7CiAgICAgIGlmIChpc0tleShwYXRoKSAmJiBpc1N0cmljdENvbXBhcmFibGUoc3JjVmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZXNTdHJpY3RDb21wYXJhYmxlKHRvS2V5KHBhdGgpLCBzcmNWYWx1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHZhciBvYmpWYWx1ZSA9IGdldChvYmplY3QsIHBhdGgpOwogICAgICAgIHJldHVybiAob2JqVmFsdWUgPT09IHVuZGVmaW5lZCAmJiBvYmpWYWx1ZSA9PT0gc3JjVmFsdWUpCiAgICAgICAgICA/IGhhc0luKG9iamVjdCwgcGF0aCkKICAgICAgICAgIDogYmFzZUlzRXF1YWwoc3JjVmFsdWUsIG9ialZhbHVlLCBDT01QQVJFX1BBUlRJQUxfRkxBRyB8IENPTVBBUkVfVU5PUkRFUkVEX0ZMQUcpOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8ubWVyZ2VgIHdpdGhvdXQgc3VwcG9ydCBmb3IgbXVsdGlwbGUgc291cmNlcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBzcmNJbmRleCBUaGUgaW5kZXggb2YgYHNvdXJjZWAuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY3VzdG9taXplcl0gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBtZXJnZWQgdmFsdWVzLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtzdGFja10gVHJhY2tzIHRyYXZlcnNlZCBzb3VyY2UgdmFsdWVzIGFuZCB0aGVpciBtZXJnZWQKICAgICAqICBjb3VudGVycGFydHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VNZXJnZShvYmplY3QsIHNvdXJjZSwgc3JjSW5kZXgsIGN1c3RvbWl6ZXIsIHN0YWNrKSB7CiAgICAgIGlmIChvYmplY3QgPT09IHNvdXJjZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBiYXNlRm9yKHNvdXJjZSwgZnVuY3Rpb24oc3JjVmFsdWUsIGtleSkgewogICAgICAgIHN0YWNrIHx8IChzdGFjayA9IG5ldyBTdGFjayk7CiAgICAgICAgaWYgKGlzT2JqZWN0KHNyY1ZhbHVlKSkgewogICAgICAgICAgYmFzZU1lcmdlRGVlcChvYmplY3QsIHNvdXJjZSwga2V5LCBzcmNJbmRleCwgYmFzZU1lcmdlLCBjdXN0b21pemVyLCBzdGFjayk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gY3VzdG9taXplcgogICAgICAgICAgICA/IGN1c3RvbWl6ZXIoc2FmZUdldChvYmplY3QsIGtleSksIHNyY1ZhbHVlLCAoa2V5ICsgJycpLCBvYmplY3QsIHNvdXJjZSwgc3RhY2spCiAgICAgICAgICAgIDogdW5kZWZpbmVkOwoKICAgICAgICAgIGlmIChuZXdWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gc3JjVmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NpZ25NZXJnZVZhbHVlKG9iamVjdCwga2V5LCBuZXdWYWx1ZSk7CiAgICAgICAgfQogICAgICB9LCBrZXlzSW4pOwogICAgfQoKICAgIC8qKgogICAgICogQSBzcGVjaWFsaXplZCB2ZXJzaW9uIG9mIGBiYXNlTWVyZ2VgIGZvciBhcnJheXMgYW5kIG9iamVjdHMgd2hpY2ggcGVyZm9ybXMKICAgICAqIGRlZXAgbWVyZ2VzIGFuZCB0cmFja3MgdHJhdmVyc2VkIG9iamVjdHMgZW5hYmxpbmcgb2JqZWN0cyB3aXRoIGNpcmN1bGFyCiAgICAgKiByZWZlcmVuY2VzIHRvIGJlIG1lcmdlZC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gbWVyZ2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gc3JjSW5kZXggVGhlIGluZGV4IG9mIGBzb3VyY2VgLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gbWVyZ2VGdW5jIFRoZSBmdW5jdGlvbiB0byBtZXJnZSB2YWx1ZXMuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY3VzdG9taXplcl0gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBhc3NpZ25lZCB2YWx1ZXMuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW3N0YWNrXSBUcmFja3MgdHJhdmVyc2VkIHNvdXJjZSB2YWx1ZXMgYW5kIHRoZWlyIG1lcmdlZAogICAgICogIGNvdW50ZXJwYXJ0cy4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZU1lcmdlRGVlcChvYmplY3QsIHNvdXJjZSwga2V5LCBzcmNJbmRleCwgbWVyZ2VGdW5jLCBjdXN0b21pemVyLCBzdGFjaykgewogICAgICB2YXIgb2JqVmFsdWUgPSBzYWZlR2V0KG9iamVjdCwga2V5KSwKICAgICAgICAgIHNyY1ZhbHVlID0gc2FmZUdldChzb3VyY2UsIGtleSksCiAgICAgICAgICBzdGFja2VkID0gc3RhY2suZ2V0KHNyY1ZhbHVlKTsKCiAgICAgIGlmIChzdGFja2VkKSB7CiAgICAgICAgYXNzaWduTWVyZ2VWYWx1ZShvYmplY3QsIGtleSwgc3RhY2tlZCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBuZXdWYWx1ZSA9IGN1c3RvbWl6ZXIKICAgICAgICA/IGN1c3RvbWl6ZXIob2JqVmFsdWUsIHNyY1ZhbHVlLCAoa2V5ICsgJycpLCBvYmplY3QsIHNvdXJjZSwgc3RhY2spCiAgICAgICAgOiB1bmRlZmluZWQ7CgogICAgICB2YXIgaXNDb21tb24gPSBuZXdWYWx1ZSA9PT0gdW5kZWZpbmVkOwoKICAgICAgaWYgKGlzQ29tbW9uKSB7CiAgICAgICAgdmFyIGlzQXJyID0gaXNBcnJheShzcmNWYWx1ZSksCiAgICAgICAgICAgIGlzQnVmZiA9ICFpc0FyciAmJiBpc0J1ZmZlcihzcmNWYWx1ZSksCiAgICAgICAgICAgIGlzVHlwZWQgPSAhaXNBcnIgJiYgIWlzQnVmZiAmJiBpc1R5cGVkQXJyYXkoc3JjVmFsdWUpOwoKICAgICAgICBuZXdWYWx1ZSA9IHNyY1ZhbHVlOwogICAgICAgIGlmIChpc0FyciB8fCBpc0J1ZmYgfHwgaXNUeXBlZCkgewogICAgICAgICAgaWYgKGlzQXJyYXkob2JqVmFsdWUpKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gb2JqVmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChpc0FycmF5TGlrZU9iamVjdChvYmpWYWx1ZSkpIHsKICAgICAgICAgICAgbmV3VmFsdWUgPSBjb3B5QXJyYXkob2JqVmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoaXNCdWZmKSB7CiAgICAgICAgICAgIGlzQ29tbW9uID0gZmFsc2U7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gY2xvbmVCdWZmZXIoc3JjVmFsdWUsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoaXNUeXBlZCkgewogICAgICAgICAgICBpc0NvbW1vbiA9IGZhbHNlOwogICAgICAgICAgICBuZXdWYWx1ZSA9IGNsb25lVHlwZWRBcnJheShzcmNWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgbmV3VmFsdWUgPSBbXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaXNQbGFpbk9iamVjdChzcmNWYWx1ZSkgfHwgaXNBcmd1bWVudHMoc3JjVmFsdWUpKSB7CiAgICAgICAgICBuZXdWYWx1ZSA9IG9ialZhbHVlOwogICAgICAgICAgaWYgKGlzQXJndW1lbnRzKG9ialZhbHVlKSkgewogICAgICAgICAgICBuZXdWYWx1ZSA9IHRvUGxhaW5PYmplY3Qob2JqVmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoIWlzT2JqZWN0KG9ialZhbHVlKSB8fCBpc0Z1bmN0aW9uKG9ialZhbHVlKSkgewogICAgICAgICAgICBuZXdWYWx1ZSA9IGluaXRDbG9uZU9iamVjdChzcmNWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgaXNDb21tb24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzQ29tbW9uKSB7CiAgICAgICAgLy8gUmVjdXJzaXZlbHkgbWVyZ2Ugb2JqZWN0cyBhbmQgYXJyYXlzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykuCiAgICAgICAgc3RhY2suc2V0KHNyY1ZhbHVlLCBuZXdWYWx1ZSk7CiAgICAgICAgbWVyZ2VGdW5jKG5ld1ZhbHVlLCBzcmNWYWx1ZSwgc3JjSW5kZXgsIGN1c3RvbWl6ZXIsIHN0YWNrKTsKICAgICAgICBzdGFja1snZGVsZXRlJ10oc3JjVmFsdWUpOwogICAgICB9CiAgICAgIGFzc2lnbk1lcmdlVmFsdWUob2JqZWN0LCBrZXksIG5ld1ZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLm50aGAgd2hpY2ggZG9lc24ndCBjb2VyY2UgYXJndW1lbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbiBUaGUgaW5kZXggb2YgdGhlIGVsZW1lbnQgdG8gcmV0dXJuLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG50aCBlbGVtZW50IG9mIGBhcnJheWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VOdGgoYXJyYXksIG4pIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgaWYgKCFsZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbiArPSBuIDwgMCA/IGxlbmd0aCA6IDA7CiAgICAgIHJldHVybiBpc0luZGV4KG4sIGxlbmd0aCkgPyBhcnJheVtuXSA6IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLm9yZGVyQnlgIHdpdGhvdXQgcGFyYW0gZ3VhcmRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uW118T2JqZWN0W118c3RyaW5nW119IGl0ZXJhdGVlcyBUaGUgaXRlcmF0ZWVzIHRvIHNvcnQgYnkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ1tdfSBvcmRlcnMgVGhlIHNvcnQgb3JkZXJzIG9mIGBpdGVyYXRlZXNgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgc29ydGVkIGFycmF5LgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlT3JkZXJCeShjb2xsZWN0aW9uLCBpdGVyYXRlZXMsIG9yZGVycykgewogICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgaXRlcmF0ZWVzID0gYXJyYXlNYXAoaXRlcmF0ZWVzLmxlbmd0aCA/IGl0ZXJhdGVlcyA6IFtpZGVudGl0eV0sIGJhc2VVbmFyeShnZXRJdGVyYXRlZSgpKSk7CgogICAgICB2YXIgcmVzdWx0ID0gYmFzZU1hcChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgdmFyIGNyaXRlcmlhID0gYXJyYXlNYXAoaXRlcmF0ZWVzLCBmdW5jdGlvbihpdGVyYXRlZSkgewogICAgICAgICAgcmV0dXJuIGl0ZXJhdGVlKHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4geyAnY3JpdGVyaWEnOiBjcml0ZXJpYSwgJ2luZGV4JzogKytpbmRleCwgJ3ZhbHVlJzogdmFsdWUgfTsKICAgICAgfSk7CgogICAgICByZXR1cm4gYmFzZVNvcnRCeShyZXN1bHQsIGZ1bmN0aW9uKG9iamVjdCwgb3RoZXIpIHsKICAgICAgICByZXR1cm4gY29tcGFyZU11bHRpcGxlKG9iamVjdCwgb3RoZXIsIG9yZGVycyk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8ucGlja2Agd2l0aG91dCBzdXBwb3J0IGZvciBpbmRpdmlkdWFsCiAgICAgKiBwcm9wZXJ0eSBpZGVudGlmaWVycy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nW119IHBhdGhzIFRoZSBwcm9wZXJ0eSBwYXRocyB0byBwaWNrLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IG9iamVjdC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVBpY2sob2JqZWN0LCBwYXRocykgewogICAgICByZXR1cm4gYmFzZVBpY2tCeShvYmplY3QsIHBhdGhzLCBmdW5jdGlvbih2YWx1ZSwgcGF0aCkgewogICAgICAgIHJldHVybiBoYXNJbihvYmplY3QsIHBhdGgpOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mICBgXy5waWNrQnlgIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nW119IHBhdGhzIFRoZSBwcm9wZXJ0eSBwYXRocyB0byBwaWNrLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZGljYXRlIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBwcm9wZXJ0eS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBvYmplY3QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VQaWNrQnkob2JqZWN0LCBwYXRocywgcHJlZGljYXRlKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gcGF0aHMubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0ge307CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBwYXRoID0gcGF0aHNbaW5kZXhdLAogICAgICAgICAgICB2YWx1ZSA9IGJhc2VHZXQob2JqZWN0LCBwYXRoKTsKCiAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSwgcGF0aCkpIHsKICAgICAgICAgIGJhc2VTZXQocmVzdWx0LCBjYXN0UGF0aChwYXRoLCBvYmplY3QpLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYGJhc2VQcm9wZXJ0eWAgd2hpY2ggc3VwcG9ydHMgZGVlcCBwYXRocy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHBhdGggVGhlIHBhdGggb2YgdGhlIHByb3BlcnR5IHRvIGdldC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGFjY2Vzc29yIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlUHJvcGVydHlEZWVwKHBhdGgpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiBiYXNlR2V0KG9iamVjdCwgcGF0aCk7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5wdWxsQWxsQnlgIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUKICAgICAqIHNob3J0aGFuZHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZXMgVGhlIHZhbHVlcyB0byByZW1vdmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWVdIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NvbXBhcmF0b3JdIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYGFycmF5YC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVB1bGxBbGwoYXJyYXksIHZhbHVlcywgaXRlcmF0ZWUsIGNvbXBhcmF0b3IpIHsKICAgICAgdmFyIGluZGV4T2YgPSBjb21wYXJhdG9yID8gYmFzZUluZGV4T2ZXaXRoIDogYmFzZUluZGV4T2YsCiAgICAgICAgICBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gdmFsdWVzLmxlbmd0aCwKICAgICAgICAgIHNlZW4gPSBhcnJheTsKCiAgICAgIGlmIChhcnJheSA9PT0gdmFsdWVzKSB7CiAgICAgICAgdmFsdWVzID0gY29weUFycmF5KHZhbHVlcyk7CiAgICAgIH0KICAgICAgaWYgKGl0ZXJhdGVlKSB7CiAgICAgICAgc2VlbiA9IGFycmF5TWFwKGFycmF5LCBiYXNlVW5hcnkoaXRlcmF0ZWUpKTsKICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBmcm9tSW5kZXggPSAwLAogICAgICAgICAgICB2YWx1ZSA9IHZhbHVlc1tpbmRleF0sCiAgICAgICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUgPyBpdGVyYXRlZSh2YWx1ZSkgOiB2YWx1ZTsKCiAgICAgICAgd2hpbGUgKChmcm9tSW5kZXggPSBpbmRleE9mKHNlZW4sIGNvbXB1dGVkLCBmcm9tSW5kZXgsIGNvbXBhcmF0b3IpKSA+IC0xKSB7CiAgICAgICAgICBpZiAoc2VlbiAhPT0gYXJyYXkpIHsKICAgICAgICAgICAgc3BsaWNlLmNhbGwoc2VlbiwgZnJvbUluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICAgIHNwbGljZS5jYWxsKGFycmF5LCBmcm9tSW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJyYXk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5wdWxsQXRgIHdpdGhvdXQgc3VwcG9ydCBmb3IgaW5kaXZpZHVhbAogICAgICogaW5kZXhlcyBvciBjYXB0dXJpbmcgdGhlIHJlbW92ZWQgZWxlbWVudHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSBpbmRleGVzIFRoZSBpbmRleGVzIG9mIGVsZW1lbnRzIHRvIHJlbW92ZS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBgYXJyYXlgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlUHVsbEF0KGFycmF5LCBpbmRleGVzKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA/IGluZGV4ZXMubGVuZ3RoIDogMCwKICAgICAgICAgIGxhc3RJbmRleCA9IGxlbmd0aCAtIDE7CgogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICB2YXIgaW5kZXggPSBpbmRleGVzW2xlbmd0aF07CiAgICAgICAgaWYgKGxlbmd0aCA9PSBsYXN0SW5kZXggfHwgaW5kZXggIT09IHByZXZpb3VzKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXMgPSBpbmRleDsKICAgICAgICAgIGlmIChpc0luZGV4KGluZGV4KSkgewogICAgICAgICAgICBzcGxpY2UuY2FsbChhcnJheSwgaW5kZXgsIDEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmFzZVVuc2V0KGFycmF5LCBpbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnJhbmRvbWAgd2l0aG91dCBzdXBwb3J0IGZvciByZXR1cm5pbmcKICAgICAqIGZsb2F0aW5nLXBvaW50IG51bWJlcnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsb3dlciBUaGUgbG93ZXIgYm91bmQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdXBwZXIgVGhlIHVwcGVyIGJvdW5kLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgcmFuZG9tIG51bWJlci4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVJhbmRvbShsb3dlciwgdXBwZXIpIHsKICAgICAgcmV0dXJuIGxvd2VyICsgbmF0aXZlRmxvb3IobmF0aXZlUmFuZG9tKCkgKiAodXBwZXIgLSBsb3dlciArIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnJhbmdlYCBhbmQgYF8ucmFuZ2VSaWdodGAgd2hpY2ggZG9lc24ndAogICAgICogY29lcmNlIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IFRoZSBzdGFydCBvZiB0aGUgcmFuZ2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZW5kIFRoZSBlbmQgb2YgdGhlIHJhbmdlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXAgVGhlIHZhbHVlIHRvIGluY3JlbWVudCBvciBkZWNyZW1lbnQgYnkuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmcm9tUmlnaHRdIFNwZWNpZnkgaXRlcmF0aW5nIGZyb20gcmlnaHQgdG8gbGVmdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgcmFuZ2Ugb2YgbnVtYmVycy4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVJhbmdlKHN0YXJ0LCBlbmQsIHN0ZXAsIGZyb21SaWdodCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IG5hdGl2ZU1heChuYXRpdmVDZWlsKChlbmQgLSBzdGFydCkgLyAoc3RlcCB8fCAxKSksIDApLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIHJlc3VsdFtmcm9tUmlnaHQgPyBsZW5ndGggOiArK2luZGV4XSA9IHN0YXJ0OwogICAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnJlcGVhdGAgd2hpY2ggZG9lc24ndCBjb2VyY2UgYXJndW1lbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gcmVwZWF0LgogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0byByZXBlYXQgdGhlIHN0cmluZy4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHJlcGVhdGVkIHN0cmluZy4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVJlcGVhdChzdHJpbmcsIG4pIHsKICAgICAgdmFyIHJlc3VsdCA9ICcnOwogICAgICBpZiAoIXN0cmluZyB8fCBuIDwgMSB8fCBuID4gTUFYX1NBRkVfSU5URUdFUikgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgLy8gTGV2ZXJhZ2UgdGhlIGV4cG9uZW50aWF0aW9uIGJ5IHNxdWFyaW5nIGFsZ29yaXRobSBmb3IgYSBmYXN0ZXIgcmVwZWF0LgogICAgICAvLyBTZWUgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRXhwb25lbnRpYXRpb25fYnlfc3F1YXJpbmcgZm9yIG1vcmUgZGV0YWlscy4KICAgICAgZG8gewogICAgICAgIGlmIChuICUgMikgewogICAgICAgICAgcmVzdWx0ICs9IHN0cmluZzsKICAgICAgICB9CiAgICAgICAgbiA9IG5hdGl2ZUZsb29yKG4gLyAyKTsKICAgICAgICBpZiAobikgewogICAgICAgICAgc3RyaW5nICs9IHN0cmluZzsKICAgICAgICB9CiAgICAgIH0gd2hpbGUgKG4pOwoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnJlc3RgIHdoaWNoIGRvZXNuJ3QgdmFsaWRhdGUgb3IgY29lcmNlIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gYXBwbHkgYSByZXN0IHBhcmFtZXRlciB0by4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnQ9ZnVuYy5sZW5ndGgtMV0gVGhlIHN0YXJ0IHBvc2l0aW9uIG9mIHRoZSByZXN0IHBhcmFtZXRlci4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlUmVzdChmdW5jLCBzdGFydCkgewogICAgICByZXR1cm4gc2V0VG9TdHJpbmcob3ZlclJlc3QoZnVuYywgc3RhcnQsIGlkZW50aXR5KSwgZnVuYyArICcnKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnNhbXBsZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNhbXBsZS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSByYW5kb20gZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVNhbXBsZShjb2xsZWN0aW9uKSB7CiAgICAgIHJldHVybiBhcnJheVNhbXBsZSh2YWx1ZXMoY29sbGVjdGlvbikpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uc2FtcGxlU2l6ZWAgd2l0aG91dCBwYXJhbSBndWFyZHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNhbXBsZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gc2FtcGxlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSByYW5kb20gZWxlbWVudHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VTYW1wbGVTaXplKGNvbGxlY3Rpb24sIG4pIHsKICAgICAgdmFyIGFycmF5ID0gdmFsdWVzKGNvbGxlY3Rpb24pOwogICAgICByZXR1cm4gc2h1ZmZsZVNlbGYoYXJyYXksIGJhc2VDbGFtcChuLCAwLCBhcnJheS5sZW5ndGgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnNldGAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgcHJvcGVydHkgdG8gc2V0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2N1c3RvbWl6ZXJdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgcGF0aCBjcmVhdGlvbi4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VTZXQob2JqZWN0LCBwYXRoLCB2YWx1ZSwgY3VzdG9taXplcikgewogICAgICBpZiAoIWlzT2JqZWN0KG9iamVjdCkpIHsKICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICB9CiAgICAgIHBhdGggPSBjYXN0UGF0aChwYXRoLCBvYmplY3QpOwoKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBwYXRoLmxlbmd0aCwKICAgICAgICAgIGxhc3RJbmRleCA9IGxlbmd0aCAtIDEsCiAgICAgICAgICBuZXN0ZWQgPSBvYmplY3Q7CgogICAgICB3aGlsZSAobmVzdGVkICE9IG51bGwgJiYgKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSB0b0tleShwYXRoW2luZGV4XSksCiAgICAgICAgICAgIG5ld1ZhbHVlID0gdmFsdWU7CgogICAgICAgIGlmIChpbmRleCAhPSBsYXN0SW5kZXgpIHsKICAgICAgICAgIHZhciBvYmpWYWx1ZSA9IG5lc3RlZFtrZXldOwogICAgICAgICAgbmV3VmFsdWUgPSBjdXN0b21pemVyID8gY3VzdG9taXplcihvYmpWYWx1ZSwga2V5LCBuZXN0ZWQpIDogdW5kZWZpbmVkOwogICAgICAgICAgaWYgKG5ld1ZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgbmV3VmFsdWUgPSBpc09iamVjdChvYmpWYWx1ZSkKICAgICAgICAgICAgICA/IG9ialZhbHVlCiAgICAgICAgICAgICAgOiAoaXNJbmRleChwYXRoW2luZGV4ICsgMV0pID8gW10gOiB7fSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGFzc2lnblZhbHVlKG5lc3RlZCwga2V5LCBuZXdWYWx1ZSk7CiAgICAgICAgbmVzdGVkID0gbmVzdGVkW2tleV07CiAgICAgIH0KICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBzZXREYXRhYCB3aXRob3V0IHN1cHBvcnQgZm9yIGhvdCBsb29wIHNob3J0aW5nLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBhc3NvY2lhdGUgbWV0YWRhdGEgd2l0aC4KICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBUaGUgbWV0YWRhdGEuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgYGZ1bmNgLgogICAgICovCiAgICB2YXIgYmFzZVNldERhdGEgPSAhbWV0YU1hcCA/IGlkZW50aXR5IDogZnVuY3Rpb24oZnVuYywgZGF0YSkgewogICAgICBtZXRhTWFwLnNldChmdW5jLCBkYXRhKTsKICAgICAgcmV0dXJuIGZ1bmM7CiAgICB9OwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYHNldFRvU3RyaW5nYCB3aXRob3V0IHN1cHBvcnQgZm9yIGhvdCBsb29wIHNob3J0aW5nLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBzdHJpbmcgVGhlIGB0b1N0cmluZ2AgcmVzdWx0LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIGBmdW5jYC4KICAgICAqLwogICAgdmFyIGJhc2VTZXRUb1N0cmluZyA9ICFkZWZpbmVQcm9wZXJ0eSA/IGlkZW50aXR5IDogZnVuY3Rpb24oZnVuYywgc3RyaW5nKSB7CiAgICAgIHJldHVybiBkZWZpbmVQcm9wZXJ0eShmdW5jLCAndG9TdHJpbmcnLCB7CiAgICAgICAgJ2NvbmZpZ3VyYWJsZSc6IHRydWUsCiAgICAgICAgJ2VudW1lcmFibGUnOiBmYWxzZSwKICAgICAgICAndmFsdWUnOiBjb25zdGFudChzdHJpbmcpLAogICAgICAgICd3cml0YWJsZSc6IHRydWUKICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uc2h1ZmZsZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNodWZmbGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBzaHVmZmxlZCBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVNodWZmbGUoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gc2h1ZmZsZVNlbGYodmFsdWVzKGNvbGxlY3Rpb24pKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnNsaWNlYCB3aXRob3V0IGFuIGl0ZXJhdGVlIGNhbGwgZ3VhcmQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzbGljZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnQ9MF0gVGhlIHN0YXJ0IHBvc2l0aW9uLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtlbmQ9YXJyYXkubGVuZ3RoXSBUaGUgZW5kIHBvc2l0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBzbGljZSBvZiBgYXJyYXlgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlU2xpY2UoYXJyYXksIHN0YXJ0LCBlbmQpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgICBpZiAoc3RhcnQgPCAwKSB7CiAgICAgICAgc3RhcnQgPSAtc3RhcnQgPiBsZW5ndGggPyAwIDogKGxlbmd0aCArIHN0YXJ0KTsKICAgICAgfQogICAgICBlbmQgPSBlbmQgPiBsZW5ndGggPyBsZW5ndGggOiBlbmQ7CiAgICAgIGlmIChlbmQgPCAwKSB7CiAgICAgICAgZW5kICs9IGxlbmd0aDsKICAgICAgfQogICAgICBsZW5ndGggPSBzdGFydCA+IGVuZCA/IDAgOiAoKGVuZCAtIHN0YXJ0KSA+Pj4gMCk7CiAgICAgIHN0YXJ0ID4+Pj0gMDsKCiAgICAgIHZhciByZXN1bHQgPSBBcnJheShsZW5ndGgpOwogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHJlc3VsdFtpbmRleF0gPSBhcnJheVtpbmRleCArIHN0YXJ0XTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uc29tZWAgd2l0aG91dCBzdXBwb3J0IGZvciBpdGVyYXRlZSBzaG9ydGhhbmRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcmVkaWNhdGUgVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbnkgZWxlbWVudCBwYXNzZXMgdGhlIHByZWRpY2F0ZSBjaGVjaywKICAgICAqICBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VTb21lKGNvbGxlY3Rpb24sIHByZWRpY2F0ZSkgewogICAgICB2YXIgcmVzdWx0OwoKICAgICAgYmFzZUVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmVzdWx0ID0gcHJlZGljYXRlKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgcmV0dXJuICFyZXN1bHQ7CiAgICAgIH0pOwogICAgICByZXR1cm4gISFyZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5zb3J0ZWRJbmRleGAgYW5kIGBfLnNvcnRlZExhc3RJbmRleGAgd2hpY2gKICAgICAqIHBlcmZvcm1zIGEgYmluYXJ5IHNlYXJjaCBvZiBgYXJyYXlgIHRvIGRldGVybWluZSB0aGUgaW5kZXggYXQgd2hpY2ggYHZhbHVlYAogICAgICogc2hvdWxkIGJlIGluc2VydGVkIGludG8gYGFycmF5YCBpbiBvcmRlciB0byBtYWludGFpbiBpdHMgc29ydCBvcmRlci4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIHNvcnRlZCBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXRIaWdoZXN0XSBTcGVjaWZ5IHJldHVybmluZyB0aGUgaGlnaGVzdCBxdWFsaWZpZWQgaW5kZXguCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBhdCB3aGljaCBgdmFsdWVgIHNob3VsZCBiZSBpbnNlcnRlZAogICAgICogIGludG8gYGFycmF5YC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSwgcmV0SGlnaGVzdCkgewogICAgICB2YXIgbG93ID0gMCwKICAgICAgICAgIGhpZ2ggPSBhcnJheSA9PSBudWxsID8gbG93IDogYXJyYXkubGVuZ3RoOwoKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB2YWx1ZSA9PT0gdmFsdWUgJiYgaGlnaCA8PSBIQUxGX01BWF9BUlJBWV9MRU5HVEgpIHsKICAgICAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMSwKICAgICAgICAgICAgICBjb21wdXRlZCA9IGFycmF5W21pZF07CgogICAgICAgICAgaWYgKGNvbXB1dGVkICE9PSBudWxsICYmICFpc1N5bWJvbChjb21wdXRlZCkgJiYKICAgICAgICAgICAgICAocmV0SGlnaGVzdCA/IChjb21wdXRlZCA8PSB2YWx1ZSkgOiAoY29tcHV0ZWQgPCB2YWx1ZSkpKSB7CiAgICAgICAgICAgIGxvdyA9IG1pZCArIDE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoaWdoID0gbWlkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaGlnaDsKICAgICAgfQogICAgICByZXR1cm4gYmFzZVNvcnRlZEluZGV4QnkoYXJyYXksIHZhbHVlLCBpZGVudGl0eSwgcmV0SGlnaGVzdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5zb3J0ZWRJbmRleEJ5YCBhbmQgYF8uc29ydGVkTGFzdEluZGV4QnlgCiAgICAgKiB3aGljaCBpbnZva2VzIGBpdGVyYXRlZWAgZm9yIGB2YWx1ZWAgYW5kIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgIHRvIGNvbXB1dGUKICAgICAqIHRoZWlyIHNvcnQgcmFua2luZy4gVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ7ICh2YWx1ZSkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBzb3J0ZWQgYXJyYXkgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGV2YWx1YXRlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0ZWUgVGhlIGl0ZXJhdGVlIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXRIaWdoZXN0XSBTcGVjaWZ5IHJldHVybmluZyB0aGUgaGlnaGVzdCBxdWFsaWZpZWQgaW5kZXguCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBhdCB3aGljaCBgdmFsdWVgIHNob3VsZCBiZSBpbnNlcnRlZAogICAgICogIGludG8gYGFycmF5YC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVNvcnRlZEluZGV4QnkoYXJyYXksIHZhbHVlLCBpdGVyYXRlZSwgcmV0SGlnaGVzdCkgewogICAgICB2YWx1ZSA9IGl0ZXJhdGVlKHZhbHVlKTsKCiAgICAgIHZhciBsb3cgPSAwLAogICAgICAgICAgaGlnaCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoLAogICAgICAgICAgdmFsSXNOYU4gPSB2YWx1ZSAhPT0gdmFsdWUsCiAgICAgICAgICB2YWxJc051bGwgPSB2YWx1ZSA9PT0gbnVsbCwKICAgICAgICAgIHZhbElzU3ltYm9sID0gaXNTeW1ib2wodmFsdWUpLAogICAgICAgICAgdmFsSXNVbmRlZmluZWQgPSB2YWx1ZSA9PT0gdW5kZWZpbmVkOwoKICAgICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgICB2YXIgbWlkID0gbmF0aXZlRmxvb3IoKGxvdyArIGhpZ2gpIC8gMiksCiAgICAgICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUoYXJyYXlbbWlkXSksCiAgICAgICAgICAgIG90aElzRGVmaW5lZCA9IGNvbXB1dGVkICE9PSB1bmRlZmluZWQsCiAgICAgICAgICAgIG90aElzTnVsbCA9IGNvbXB1dGVkID09PSBudWxsLAogICAgICAgICAgICBvdGhJc1JlZmxleGl2ZSA9IGNvbXB1dGVkID09PSBjb21wdXRlZCwKICAgICAgICAgICAgb3RoSXNTeW1ib2wgPSBpc1N5bWJvbChjb21wdXRlZCk7CgogICAgICAgIGlmICh2YWxJc05hTikgewogICAgICAgICAgdmFyIHNldExvdyA9IHJldEhpZ2hlc3QgfHwgb3RoSXNSZWZsZXhpdmU7CiAgICAgICAgfSBlbHNlIGlmICh2YWxJc1VuZGVmaW5lZCkgewogICAgICAgICAgc2V0TG93ID0gb3RoSXNSZWZsZXhpdmUgJiYgKHJldEhpZ2hlc3QgfHwgb3RoSXNEZWZpbmVkKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbElzTnVsbCkgewogICAgICAgICAgc2V0TG93ID0gb3RoSXNSZWZsZXhpdmUgJiYgb3RoSXNEZWZpbmVkICYmIChyZXRIaWdoZXN0IHx8ICFvdGhJc051bGwpOwogICAgICAgIH0gZWxzZSBpZiAodmFsSXNTeW1ib2wpIHsKICAgICAgICAgIHNldExvdyA9IG90aElzUmVmbGV4aXZlICYmIG90aElzRGVmaW5lZCAmJiAhb3RoSXNOdWxsICYmIChyZXRIaWdoZXN0IHx8ICFvdGhJc1N5bWJvbCk7CiAgICAgICAgfSBlbHNlIGlmIChvdGhJc051bGwgfHwgb3RoSXNTeW1ib2wpIHsKICAgICAgICAgIHNldExvdyA9IGZhbHNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRMb3cgPSByZXRIaWdoZXN0ID8gKGNvbXB1dGVkIDw9IHZhbHVlKSA6IChjb21wdXRlZCA8IHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNldExvdykgewogICAgICAgICAgbG93ID0gbWlkICsgMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaGlnaCA9IG1pZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG5hdGl2ZU1pbihoaWdoLCBNQVhfQVJSQVlfSU5ERVgpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uc29ydGVkVW5pcWAgYW5kIGBfLnNvcnRlZFVuaXFCeWAgd2l0aG91dAogICAgICogc3VwcG9ydCBmb3IgaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWVdIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZHVwbGljYXRlIGZyZWUgYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VTb3J0ZWRVbmlxKGFycmF5LCBpdGVyYXRlZSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICAgIHJlc0luZGV4ID0gMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF0sCiAgICAgICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUgPyBpdGVyYXRlZSh2YWx1ZSkgOiB2YWx1ZTsKCiAgICAgICAgaWYgKCFpbmRleCB8fCAhZXEoY29tcHV0ZWQsIHNlZW4pKSB7CiAgICAgICAgICB2YXIgc2VlbiA9IGNvbXB1dGVkOwogICAgICAgICAgcmVzdWx0W3Jlc0luZGV4KytdID0gdmFsdWUgPT09IDAgPyAwIDogdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy50b051bWJlcmAgd2hpY2ggZG9lc24ndCBlbnN1cmUgY29ycmVjdAogICAgICogY29udmVyc2lvbnMgb2YgYmluYXJ5LCBoZXhhZGVjaW1hbCwgb3Igb2N0YWwgc3RyaW5nIHZhbHVlcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcHJvY2Vzcy4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIG51bWJlci4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVRvTnVtYmVyKHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gJ251bWJlcicpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgaWYgKGlzU3ltYm9sKHZhbHVlKSkgewogICAgICAgIHJldHVybiBOQU47CiAgICAgIH0KICAgICAgcmV0dXJuICt2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnRvU3RyaW5nYCB3aGljaCBkb2Vzbid0IGNvbnZlcnQgbnVsbGlzaAogICAgICogdmFsdWVzIHRvIGVtcHR5IHN0cmluZ3MuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHByb2Nlc3MuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBzdHJpbmcuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VUb1N0cmluZyh2YWx1ZSkgewogICAgICAvLyBFeGl0IGVhcmx5IGZvciBzdHJpbmdzIHRvIGF2b2lkIGEgcGVyZm9ybWFuY2UgaGl0IGluIHNvbWUgZW52aXJvbm1lbnRzLgogICAgICBpZiAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbnZlcnQgdmFsdWVzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykuCiAgICAgICAgcmV0dXJuIGFycmF5TWFwKHZhbHVlLCBiYXNlVG9TdHJpbmcpICsgJyc7CiAgICAgIH0KICAgICAgaWYgKGlzU3ltYm9sKHZhbHVlKSkgewogICAgICAgIHJldHVybiBzeW1ib2xUb1N0cmluZyA/IHN5bWJvbFRvU3RyaW5nLmNhbGwodmFsdWUpIDogJyc7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9ICh2YWx1ZSArICcnKTsKICAgICAgcmV0dXJuIChyZXN1bHQgPT0gJzAnICYmICgxIC8gdmFsdWUpID09IC1JTkZJTklUWSkgPyAnLTAnIDogcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8udW5pcUJ5YCB3aXRob3V0IHN1cHBvcnQgZm9yIGl0ZXJhdGVlIHNob3J0aGFuZHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlXSBUaGUgaXRlcmF0ZWUgaW52b2tlZCBwZXIgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjb21wYXJhdG9yXSBUaGUgY29tcGFyYXRvciBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZHVwbGljYXRlIGZyZWUgYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VVbmlxKGFycmF5LCBpdGVyYXRlZSwgY29tcGFyYXRvcikgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluY2x1ZGVzID0gYXJyYXlJbmNsdWRlcywKICAgICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICAgIGlzQ29tbW9uID0gdHJ1ZSwKICAgICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgICAgc2VlbiA9IHJlc3VsdDsKCiAgICAgIGlmIChjb21wYXJhdG9yKSB7CiAgICAgICAgaXNDb21tb24gPSBmYWxzZTsKICAgICAgICBpbmNsdWRlcyA9IGFycmF5SW5jbHVkZXNXaXRoOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGxlbmd0aCA+PSBMQVJHRV9BUlJBWV9TSVpFKSB7CiAgICAgICAgdmFyIHNldCA9IGl0ZXJhdGVlID8gbnVsbCA6IGNyZWF0ZVNldChhcnJheSk7CiAgICAgICAgaWYgKHNldCkgewogICAgICAgICAgcmV0dXJuIHNldFRvQXJyYXkoc2V0KTsKICAgICAgICB9CiAgICAgICAgaXNDb21tb24gPSBmYWxzZTsKICAgICAgICBpbmNsdWRlcyA9IGNhY2hlSGFzOwogICAgICAgIHNlZW4gPSBuZXcgU2V0Q2FjaGU7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgc2VlbiA9IGl0ZXJhdGVlID8gW10gOiByZXN1bHQ7CiAgICAgIH0KICAgICAgb3V0ZXI6CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdLAogICAgICAgICAgICBjb21wdXRlZCA9IGl0ZXJhdGVlID8gaXRlcmF0ZWUodmFsdWUpIDogdmFsdWU7CgogICAgICAgIHZhbHVlID0gKGNvbXBhcmF0b3IgfHwgdmFsdWUgIT09IDApID8gdmFsdWUgOiAwOwogICAgICAgIGlmIChpc0NvbW1vbiAmJiBjb21wdXRlZCA9PT0gY29tcHV0ZWQpIHsKICAgICAgICAgIHZhciBzZWVuSW5kZXggPSBzZWVuLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChzZWVuSW5kZXgtLSkgewogICAgICAgICAgICBpZiAoc2VlbltzZWVuSW5kZXhdID09PSBjb21wdXRlZCkgewogICAgICAgICAgICAgIGNvbnRpbnVlIG91dGVyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXRlcmF0ZWUpIHsKICAgICAgICAgICAgc2Vlbi5wdXNoKGNvbXB1dGVkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoIWluY2x1ZGVzKHNlZW4sIGNvbXB1dGVkLCBjb21wYXJhdG9yKSkgewogICAgICAgICAgaWYgKHNlZW4gIT09IHJlc3VsdCkgewogICAgICAgICAgICBzZWVuLnB1c2goY29tcHV0ZWQpOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8udW5zZXRgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHBhdGggVGhlIHByb3BlcnR5IHBhdGggdG8gdW5zZXQuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHByb3BlcnR5IGlzIGRlbGV0ZWQsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVVuc2V0KG9iamVjdCwgcGF0aCkgewogICAgICBwYXRoID0gY2FzdFBhdGgocGF0aCwgb2JqZWN0KTsKICAgICAgb2JqZWN0ID0gcGFyZW50KG9iamVjdCwgcGF0aCk7CiAgICAgIHJldHVybiBvYmplY3QgPT0gbnVsbCB8fCBkZWxldGUgb2JqZWN0W3RvS2V5KGxhc3QocGF0aCkpXTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnVwZGF0ZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgcHJvcGVydHkgdG8gdXBkYXRlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gdXBkYXRlciBUaGUgZnVuY3Rpb24gdG8gcHJvZHVjZSB0aGUgdXBkYXRlZCB2YWx1ZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjdXN0b21pemVyXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIHBhdGggY3JlYXRpb24uCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlVXBkYXRlKG9iamVjdCwgcGF0aCwgdXBkYXRlciwgY3VzdG9taXplcikgewogICAgICByZXR1cm4gYmFzZVNldChvYmplY3QsIHBhdGgsIHVwZGF0ZXIoYmFzZUdldChvYmplY3QsIHBhdGgpKSwgY3VzdG9taXplcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBtZXRob2RzIGxpa2UgYF8uZHJvcFdoaWxlYCBhbmQgYF8udGFrZVdoaWxlYAogICAgICogd2l0aG91dCBzdXBwb3J0IGZvciBpdGVyYXRlZSBzaG9ydGhhbmRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcmVkaWNhdGUgVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzRHJvcF0gU3BlY2lmeSBkcm9wcGluZyBlbGVtZW50cyBpbnN0ZWFkIG9mIHRha2luZyB0aGVtLgogICAgICogQHBhcmFtIHtib29sZWFufSBbZnJvbVJpZ2h0XSBTcGVjaWZ5IGl0ZXJhdGluZyBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHNsaWNlIG9mIGBhcnJheWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VXaGlsZShhcnJheSwgcHJlZGljYXRlLCBpc0Ryb3AsIGZyb21SaWdodCkgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgICAgaW5kZXggPSBmcm9tUmlnaHQgPyBsZW5ndGggOiAtMTsKCiAgICAgIHdoaWxlICgoZnJvbVJpZ2h0ID8gaW5kZXgtLSA6ICsraW5kZXggPCBsZW5ndGgpICYmCiAgICAgICAgcHJlZGljYXRlKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkge30KCiAgICAgIHJldHVybiBpc0Ryb3AKICAgICAgICA/IGJhc2VTbGljZShhcnJheSwgKGZyb21SaWdodCA/IDAgOiBpbmRleCksIChmcm9tUmlnaHQgPyBpbmRleCArIDEgOiBsZW5ndGgpKQogICAgICAgIDogYmFzZVNsaWNlKGFycmF5LCAoZnJvbVJpZ2h0ID8gaW5kZXggKyAxIDogMCksIChmcm9tUmlnaHQgPyBsZW5ndGggOiBpbmRleCkpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYHdyYXBwZXJWYWx1ZWAgd2hpY2ggcmV0dXJucyB0aGUgcmVzdWx0IG9mCiAgICAgKiBwZXJmb3JtaW5nIGEgc2VxdWVuY2Ugb2YgYWN0aW9ucyBvbiB0aGUgdW53cmFwcGVkIGB2YWx1ZWAsIHdoZXJlIGVhY2gKICAgICAqIHN1Y2Nlc3NpdmUgYWN0aW9uIGlzIHN1cHBsaWVkIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIHByZXZpb3VzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB1bndyYXBwZWQgdmFsdWUuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhY3Rpb25zIEFjdGlvbnMgdG8gcGVyZm9ybSB0byByZXNvbHZlIHRoZSB1bndyYXBwZWQgdmFsdWUuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgcmVzb2x2ZWQgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VXcmFwcGVyVmFsdWUodmFsdWUsIGFjdGlvbnMpIHsKICAgICAgdmFyIHJlc3VsdCA9IHZhbHVlOwogICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgTGF6eVdyYXBwZXIpIHsKICAgICAgICByZXN1bHQgPSByZXN1bHQudmFsdWUoKTsKICAgICAgfQogICAgICByZXR1cm4gYXJyYXlSZWR1Y2UoYWN0aW9ucywgZnVuY3Rpb24ocmVzdWx0LCBhY3Rpb24pIHsKICAgICAgICByZXR1cm4gYWN0aW9uLmZ1bmMuYXBwbHkoYWN0aW9uLnRoaXNBcmcsIGFycmF5UHVzaChbcmVzdWx0XSwgYWN0aW9uLmFyZ3MpKTsKICAgICAgfSwgcmVzdWx0KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIG1ldGhvZHMgbGlrZSBgXy54b3JgLCB3aXRob3V0IHN1cHBvcnQgZm9yCiAgICAgKiBpdGVyYXRlZSBzaG9ydGhhbmRzLCB0aGF0IGFjY2VwdHMgYW4gYXJyYXkgb2YgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5cyBUaGUgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWVdIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NvbXBhcmF0b3JdIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiB2YWx1ZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VYb3IoYXJyYXlzLCBpdGVyYXRlZSwgY29tcGFyYXRvcikgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXlzLmxlbmd0aDsKICAgICAgaWYgKGxlbmd0aCA8IDIpIHsKICAgICAgICByZXR1cm4gbGVuZ3RoID8gYmFzZVVuaXEoYXJyYXlzWzBdKSA6IFtdOwogICAgICB9CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGFycmF5ID0gYXJyYXlzW2luZGV4XSwKICAgICAgICAgICAgb3RoSW5kZXggPSAtMTsKCiAgICAgICAgd2hpbGUgKCsrb3RoSW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChvdGhJbmRleCAhPSBpbmRleCkgewogICAgICAgICAgICByZXN1bHRbaW5kZXhdID0gYmFzZURpZmZlcmVuY2UocmVzdWx0W2luZGV4XSB8fCBhcnJheSwgYXJyYXlzW290aEluZGV4XSwgaXRlcmF0ZWUsIGNvbXBhcmF0b3IpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYmFzZVVuaXEoYmFzZUZsYXR0ZW4ocmVzdWx0LCAxKSwgaXRlcmF0ZWUsIGNvbXBhcmF0b3IpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnppcE9iamVjdGAgd2hpY2ggYXNzaWducyB2YWx1ZXMgdXNpbmcgYGFzc2lnbkZ1bmNgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBwcm9wcyBUaGUgcHJvcGVydHkgaWRlbnRpZmllcnMuCiAgICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZXMgVGhlIHByb3BlcnR5IHZhbHVlcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGFzc2lnbkZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGFzc2lnbiB2YWx1ZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBuZXcgb2JqZWN0LgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlWmlwT2JqZWN0KHByb3BzLCB2YWx1ZXMsIGFzc2lnbkZ1bmMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgICB2YWxzTGVuZ3RoID0gdmFsdWVzLmxlbmd0aCwKICAgICAgICAgIHJlc3VsdCA9IHt9OwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBpbmRleCA8IHZhbHNMZW5ndGggPyB2YWx1ZXNbaW5kZXhdIDogdW5kZWZpbmVkOwogICAgICAgIGFzc2lnbkZ1bmMocmVzdWx0LCBwcm9wc1tpbmRleF0sIHZhbHVlKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ2FzdHMgYHZhbHVlYCB0byBhbiBlbXB0eSBhcnJheSBpZiBpdCdzIG5vdCBhbiBhcnJheSBsaWtlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheXxPYmplY3R9IFJldHVybnMgdGhlIGNhc3QgYXJyYXktbGlrZSBvYmplY3QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhc3RBcnJheUxpa2VPYmplY3QodmFsdWUpIHsKICAgICAgcmV0dXJuIGlzQXJyYXlMaWtlT2JqZWN0KHZhbHVlKSA/IHZhbHVlIDogW107CiAgICB9CgogICAgLyoqCiAgICAgKiBDYXN0cyBgdmFsdWVgIHRvIGBpZGVudGl0eWAgaWYgaXQncyBub3QgYSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBjYXN0IGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjYXN0RnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nID8gdmFsdWUgOiBpZGVudGl0eTsKICAgIH0KCiAgICAvKioKICAgICAqIENhc3RzIGB2YWx1ZWAgdG8gYSBwYXRoIGFycmF5IGlmIGl0J3Mgbm90IG9uZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb2JqZWN0XSBUaGUgb2JqZWN0IHRvIHF1ZXJ5IGtleXMgb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGNhc3QgcHJvcGVydHkgcGF0aCBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gY2FzdFBhdGgodmFsdWUsIG9iamVjdCkgewogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzS2V5KHZhbHVlLCBvYmplY3QpID8gW3ZhbHVlXSA6IHN0cmluZ1RvUGF0aCh0b1N0cmluZyh2YWx1ZSkpOwogICAgfQoKICAgIC8qKgogICAgICogQSBgYmFzZVJlc3RgIGFsaWFzIHdoaWNoIGNhbiBiZSByZXBsYWNlZCB3aXRoIGBpZGVudGl0eWAgYnkgbW9kdWxlCiAgICAgKiByZXBsYWNlbWVudCBwbHVnaW5zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBhcHBseSBhIHJlc3QgcGFyYW1ldGVyIHRvLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKi8KICAgIHZhciBjYXN0UmVzdCA9IGJhc2VSZXN0OwoKICAgIC8qKgogICAgICogQ2FzdHMgYGFycmF5YCB0byBhIHNsaWNlIGlmIGl0J3MgbmVlZGVkLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCBUaGUgc3RhcnQgcG9zaXRpb24uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2VuZD1hcnJheS5sZW5ndGhdIFRoZSBlbmQgcG9zaXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGNhc3Qgc2xpY2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhc3RTbGljZShhcnJheSwgc3RhcnQsIGVuZCkgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IGxlbmd0aCA6IGVuZDsKICAgICAgcmV0dXJuICghc3RhcnQgJiYgZW5kID49IGxlbmd0aCkgPyBhcnJheSA6IGJhc2VTbGljZShhcnJheSwgc3RhcnQsIGVuZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIHNpbXBsZSB3cmFwcGVyIGFyb3VuZCB0aGUgZ2xvYmFsIFtgY2xlYXJUaW1lb3V0YF0oaHR0cHM6Ly9tZG4uaW8vY2xlYXJUaW1lb3V0KS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtudW1iZXJ8T2JqZWN0fSBpZCBUaGUgdGltZXIgaWQgb3IgdGltZW91dCBvYmplY3Qgb2YgdGhlIHRpbWVyIHRvIGNsZWFyLgogICAgICovCiAgICB2YXIgY2xlYXJUaW1lb3V0ID0gY3R4Q2xlYXJUaW1lb3V0IHx8IGZ1bmN0aW9uKGlkKSB7CiAgICAgIHJldHVybiByb290LmNsZWFyVGltZW91dChpZCk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGNsb25lIG9mICBgYnVmZmVyYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtCdWZmZXJ9IGJ1ZmZlciBUaGUgYnVmZmVyIHRvIGNsb25lLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNEZWVwXSBTcGVjaWZ5IGEgZGVlcCBjbG9uZS4KICAgICAqIEByZXR1cm5zIHtCdWZmZXJ9IFJldHVybnMgdGhlIGNsb25lZCBidWZmZXIuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lQnVmZmVyKGJ1ZmZlciwgaXNEZWVwKSB7CiAgICAgIGlmIChpc0RlZXApIHsKICAgICAgICByZXR1cm4gYnVmZmVyLnNsaWNlKCk7CiAgICAgIH0KICAgICAgdmFyIGxlbmd0aCA9IGJ1ZmZlci5sZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSBhbGxvY1Vuc2FmZSA/IGFsbG9jVW5zYWZlKGxlbmd0aCkgOiBuZXcgYnVmZmVyLmNvbnN0cnVjdG9yKGxlbmd0aCk7CgogICAgICBidWZmZXIuY29weShyZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGNsb25lIG9mIGBhcnJheUJ1ZmZlcmAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXlCdWZmZXJ9IGFycmF5QnVmZmVyIFRoZSBhcnJheSBidWZmZXIgdG8gY2xvbmUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXlCdWZmZXJ9IFJldHVybnMgdGhlIGNsb25lZCBhcnJheSBidWZmZXIuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lQXJyYXlCdWZmZXIoYXJyYXlCdWZmZXIpIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyBhcnJheUJ1ZmZlci5jb25zdHJ1Y3RvcihhcnJheUJ1ZmZlci5ieXRlTGVuZ3RoKTsKICAgICAgbmV3IFVpbnQ4QXJyYXkocmVzdWx0KS5zZXQobmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWZmZXIpKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBjbG9uZSBvZiBgZGF0YVZpZXdgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YVZpZXcgVGhlIGRhdGEgdmlldyB0byBjbG9uZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzRGVlcF0gU3BlY2lmeSBhIGRlZXAgY2xvbmUuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjbG9uZWQgZGF0YSB2aWV3LgogICAgICovCiAgICBmdW5jdGlvbiBjbG9uZURhdGFWaWV3KGRhdGFWaWV3LCBpc0RlZXApIHsKICAgICAgdmFyIGJ1ZmZlciA9IGlzRGVlcCA/IGNsb25lQXJyYXlCdWZmZXIoZGF0YVZpZXcuYnVmZmVyKSA6IGRhdGFWaWV3LmJ1ZmZlcjsKICAgICAgcmV0dXJuIG5ldyBkYXRhVmlldy5jb25zdHJ1Y3RvcihidWZmZXIsIGRhdGFWaWV3LmJ5dGVPZmZzZXQsIGRhdGFWaWV3LmJ5dGVMZW5ndGgpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGNsb25lIG9mIGByZWdleHBgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVnZXhwIFRoZSByZWdleHAgdG8gY2xvbmUuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjbG9uZWQgcmVnZXhwLgogICAgICovCiAgICBmdW5jdGlvbiBjbG9uZVJlZ0V4cChyZWdleHApIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyByZWdleHAuY29uc3RydWN0b3IocmVnZXhwLnNvdXJjZSwgcmVGbGFncy5leGVjKHJlZ2V4cCkpOwogICAgICByZXN1bHQubGFzdEluZGV4ID0gcmVnZXhwLmxhc3RJbmRleDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBjbG9uZSBvZiB0aGUgYHN5bWJvbGAgb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc3ltYm9sIFRoZSBzeW1ib2wgb2JqZWN0IHRvIGNsb25lLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY2xvbmVkIHN5bWJvbCBvYmplY3QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lU3ltYm9sKHN5bWJvbCkgewogICAgICByZXR1cm4gc3ltYm9sVmFsdWVPZiA/IE9iamVjdChzeW1ib2xWYWx1ZU9mLmNhbGwoc3ltYm9sKSkgOiB7fTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBjbG9uZSBvZiBgdHlwZWRBcnJheWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0eXBlZEFycmF5IFRoZSB0eXBlZCBhcnJheSB0byBjbG9uZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzRGVlcF0gU3BlY2lmeSBhIGRlZXAgY2xvbmUuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjbG9uZWQgdHlwZWQgYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lVHlwZWRBcnJheSh0eXBlZEFycmF5LCBpc0RlZXApIHsKICAgICAgdmFyIGJ1ZmZlciA9IGlzRGVlcCA/IGNsb25lQXJyYXlCdWZmZXIodHlwZWRBcnJheS5idWZmZXIpIDogdHlwZWRBcnJheS5idWZmZXI7CiAgICAgIHJldHVybiBuZXcgdHlwZWRBcnJheS5jb25zdHJ1Y3RvcihidWZmZXIsIHR5cGVkQXJyYXkuYnl0ZU9mZnNldCwgdHlwZWRBcnJheS5sZW5ndGgpOwogICAgfQoKICAgIC8qKgogICAgICogQ29tcGFyZXMgdmFsdWVzIHRvIHNvcnQgdGhlbSBpbiBhc2NlbmRpbmcgb3JkZXIuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IG90aGVyIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgc29ydCBvcmRlciBpbmRpY2F0b3IgZm9yIGB2YWx1ZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbXBhcmVBc2NlbmRpbmcodmFsdWUsIG90aGVyKSB7CiAgICAgIGlmICh2YWx1ZSAhPT0gb3RoZXIpIHsKICAgICAgICB2YXIgdmFsSXNEZWZpbmVkID0gdmFsdWUgIT09IHVuZGVmaW5lZCwKICAgICAgICAgICAgdmFsSXNOdWxsID0gdmFsdWUgPT09IG51bGwsCiAgICAgICAgICAgIHZhbElzUmVmbGV4aXZlID0gdmFsdWUgPT09IHZhbHVlLAogICAgICAgICAgICB2YWxJc1N5bWJvbCA9IGlzU3ltYm9sKHZhbHVlKTsKCiAgICAgICAgdmFyIG90aElzRGVmaW5lZCA9IG90aGVyICE9PSB1bmRlZmluZWQsCiAgICAgICAgICAgIG90aElzTnVsbCA9IG90aGVyID09PSBudWxsLAogICAgICAgICAgICBvdGhJc1JlZmxleGl2ZSA9IG90aGVyID09PSBvdGhlciwKICAgICAgICAgICAgb3RoSXNTeW1ib2wgPSBpc1N5bWJvbChvdGhlcik7CgogICAgICAgIGlmICgoIW90aElzTnVsbCAmJiAhb3RoSXNTeW1ib2wgJiYgIXZhbElzU3ltYm9sICYmIHZhbHVlID4gb3RoZXIpIHx8CiAgICAgICAgICAgICh2YWxJc1N5bWJvbCAmJiBvdGhJc0RlZmluZWQgJiYgb3RoSXNSZWZsZXhpdmUgJiYgIW90aElzTnVsbCAmJiAhb3RoSXNTeW1ib2wpIHx8CiAgICAgICAgICAgICh2YWxJc051bGwgJiYgb3RoSXNEZWZpbmVkICYmIG90aElzUmVmbGV4aXZlKSB8fAogICAgICAgICAgICAoIXZhbElzRGVmaW5lZCAmJiBvdGhJc1JlZmxleGl2ZSkgfHwKICAgICAgICAgICAgIXZhbElzUmVmbGV4aXZlKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgaWYgKCghdmFsSXNOdWxsICYmICF2YWxJc1N5bWJvbCAmJiAhb3RoSXNTeW1ib2wgJiYgdmFsdWUgPCBvdGhlcikgfHwKICAgICAgICAgICAgKG90aElzU3ltYm9sICYmIHZhbElzRGVmaW5lZCAmJiB2YWxJc1JlZmxleGl2ZSAmJiAhdmFsSXNOdWxsICYmICF2YWxJc1N5bWJvbCkgfHwKICAgICAgICAgICAgKG90aElzTnVsbCAmJiB2YWxJc0RlZmluZWQgJiYgdmFsSXNSZWZsZXhpdmUpIHx8CiAgICAgICAgICAgICghb3RoSXNEZWZpbmVkICYmIHZhbElzUmVmbGV4aXZlKSB8fAogICAgICAgICAgICAhb3RoSXNSZWZsZXhpdmUpIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIGJ5IGBfLm9yZGVyQnlgIHRvIGNvbXBhcmUgbXVsdGlwbGUgcHJvcGVydGllcyBvZiBhIHZhbHVlIHRvIGFub3RoZXIKICAgICAqIGFuZCBzdGFibGUgc29ydCB0aGVtLgogICAgICoKICAgICAqIElmIGBvcmRlcnNgIGlzIHVuc3BlY2lmaWVkLCBhbGwgdmFsdWVzIGFyZSBzb3J0ZWQgaW4gYXNjZW5kaW5nIG9yZGVyLiBPdGhlcndpc2UsCiAgICAgKiBzcGVjaWZ5IGFuIG9yZGVyIG9mICJkZXNjIiBmb3IgZGVzY2VuZGluZyBvciAiYXNjIiBmb3IgYXNjZW5kaW5nIHNvcnQgb3JkZXIKICAgICAqIG9mIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvdGhlciBUaGUgb3RoZXIgb2JqZWN0IHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW5bXXxzdHJpbmdbXX0gb3JkZXJzIFRoZSBvcmRlciB0byBzb3J0IGJ5IGZvciBlYWNoIHByb3BlcnR5LgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgc29ydCBvcmRlciBpbmRpY2F0b3IgZm9yIGBvYmplY3RgLgogICAgICovCiAgICBmdW5jdGlvbiBjb21wYXJlTXVsdGlwbGUob2JqZWN0LCBvdGhlciwgb3JkZXJzKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgb2JqQ3JpdGVyaWEgPSBvYmplY3QuY3JpdGVyaWEsCiAgICAgICAgICBvdGhDcml0ZXJpYSA9IG90aGVyLmNyaXRlcmlhLAogICAgICAgICAgbGVuZ3RoID0gb2JqQ3JpdGVyaWEubGVuZ3RoLAogICAgICAgICAgb3JkZXJzTGVuZ3RoID0gb3JkZXJzLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNvbXBhcmVBc2NlbmRpbmcob2JqQ3JpdGVyaWFbaW5kZXhdLCBvdGhDcml0ZXJpYVtpbmRleF0pOwogICAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAgIGlmIChpbmRleCA+PSBvcmRlcnNMZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBvcmRlciA9IG9yZGVyc1tpbmRleF07CiAgICAgICAgICByZXR1cm4gcmVzdWx0ICogKG9yZGVyID09ICdkZXNjJyA/IC0xIDogMSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEZpeGVzIGFuIGBBcnJheSNzb3J0YCBidWcgaW4gdGhlIEpTIGVuZ2luZSBlbWJlZGRlZCBpbiBBZG9iZSBhcHBsaWNhdGlvbnMKICAgICAgLy8gdGhhdCBjYXVzZXMgaXQsIHVuZGVyIGNlcnRhaW4gY2lyY3Vtc3RhbmNlcywgdG8gcHJvdmlkZSB0aGUgc2FtZSB2YWx1ZSBmb3IKICAgICAgLy8gYG9iamVjdGAgYW5kIGBvdGhlcmAuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vamFzaGtlbmFzL3VuZGVyc2NvcmUvcHVsbC8xMjQ3CiAgICAgIC8vIGZvciBtb3JlIGRldGFpbHMuCiAgICAgIC8vCiAgICAgIC8vIFRoaXMgYWxzbyBlbnN1cmVzIGEgc3RhYmxlIHNvcnQgaW4gVjggYW5kIG90aGVyIGVuZ2luZXMuCiAgICAgIC8vIFNlZSBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvdjgvaXNzdWVzL2RldGFpbD9pZD05MCBmb3IgbW9yZSBkZXRhaWxzLgogICAgICByZXR1cm4gb2JqZWN0LmluZGV4IC0gb3RoZXIuaW5kZXg7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IHRoYXQgaXMgdGhlIGNvbXBvc2l0aW9uIG9mIHBhcnRpYWxseSBhcHBsaWVkIGFyZ3VtZW50cywKICAgICAqIHBsYWNlaG9sZGVycywgYW5kIHByb3ZpZGVkIGFyZ3VtZW50cyBpbnRvIGEgc2luZ2xlIGFycmF5IG9mIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgcHJvdmlkZWQgYXJndW1lbnRzLgogICAgICogQHBhcmFtIHtBcnJheX0gcGFydGlhbHMgVGhlIGFyZ3VtZW50cyB0byBwcmVwZW5kIHRvIHRob3NlIHByb3ZpZGVkLgogICAgICogQHBhcmFtIHtBcnJheX0gaG9sZGVycyBUaGUgYHBhcnRpYWxzYCBwbGFjZWhvbGRlciBpbmRleGVzLgogICAgICogQHBhcmFtcyB7Ym9vbGVhbn0gW2lzQ3VycmllZF0gU3BlY2lmeSBjb21wb3NpbmcgZm9yIGEgY3VycmllZCBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5IG9mIGNvbXBvc2VkIGFyZ3VtZW50cy4KICAgICAqLwogICAgZnVuY3Rpb24gY29tcG9zZUFyZ3MoYXJncywgcGFydGlhbHMsIGhvbGRlcnMsIGlzQ3VycmllZCkgewogICAgICB2YXIgYXJnc0luZGV4ID0gLTEsCiAgICAgICAgICBhcmdzTGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgICBob2xkZXJzTGVuZ3RoID0gaG9sZGVycy5sZW5ndGgsCiAgICAgICAgICBsZWZ0SW5kZXggPSAtMSwKICAgICAgICAgIGxlZnRMZW5ndGggPSBwYXJ0aWFscy5sZW5ndGgsCiAgICAgICAgICByYW5nZUxlbmd0aCA9IG5hdGl2ZU1heChhcmdzTGVuZ3RoIC0gaG9sZGVyc0xlbmd0aCwgMCksCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZWZ0TGVuZ3RoICsgcmFuZ2VMZW5ndGgpLAogICAgICAgICAgaXNVbmN1cnJpZWQgPSAhaXNDdXJyaWVkOwoKICAgICAgd2hpbGUgKCsrbGVmdEluZGV4IDwgbGVmdExlbmd0aCkgewogICAgICAgIHJlc3VsdFtsZWZ0SW5kZXhdID0gcGFydGlhbHNbbGVmdEluZGV4XTsKICAgICAgfQogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBob2xkZXJzTGVuZ3RoKSB7CiAgICAgICAgaWYgKGlzVW5jdXJyaWVkIHx8IGFyZ3NJbmRleCA8IGFyZ3NMZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdFtob2xkZXJzW2FyZ3NJbmRleF1dID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIH0KICAgICAgfQogICAgICB3aGlsZSAocmFuZ2VMZW5ndGgtLSkgewogICAgICAgIHJlc3VsdFtsZWZ0SW5kZXgrK10gPSBhcmdzW2FyZ3NJbmRleCsrXTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyBsaWtlIGBjb21wb3NlQXJnc2AgZXhjZXB0IHRoYXQgdGhlIGFyZ3VtZW50cyBjb21wb3NpdGlvbgogICAgICogaXMgdGFpbG9yZWQgZm9yIGBfLnBhcnRpYWxSaWdodGAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIHByb3ZpZGVkIGFyZ3VtZW50cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IHBhcnRpYWxzIFRoZSBhcmd1bWVudHMgdG8gYXBwZW5kIHRvIHRob3NlIHByb3ZpZGVkLgogICAgICogQHBhcmFtIHtBcnJheX0gaG9sZGVycyBUaGUgYHBhcnRpYWxzYCBwbGFjZWhvbGRlciBpbmRleGVzLgogICAgICogQHBhcmFtcyB7Ym9vbGVhbn0gW2lzQ3VycmllZF0gU3BlY2lmeSBjb21wb3NpbmcgZm9yIGEgY3VycmllZCBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5IG9mIGNvbXBvc2VkIGFyZ3VtZW50cy4KICAgICAqLwogICAgZnVuY3Rpb24gY29tcG9zZUFyZ3NSaWdodChhcmdzLCBwYXJ0aWFscywgaG9sZGVycywgaXNDdXJyaWVkKSB7CiAgICAgIHZhciBhcmdzSW5kZXggPSAtMSwKICAgICAgICAgIGFyZ3NMZW5ndGggPSBhcmdzLmxlbmd0aCwKICAgICAgICAgIGhvbGRlcnNJbmRleCA9IC0xLAogICAgICAgICAgaG9sZGVyc0xlbmd0aCA9IGhvbGRlcnMubGVuZ3RoLAogICAgICAgICAgcmlnaHRJbmRleCA9IC0xLAogICAgICAgICAgcmlnaHRMZW5ndGggPSBwYXJ0aWFscy5sZW5ndGgsCiAgICAgICAgICByYW5nZUxlbmd0aCA9IG5hdGl2ZU1heChhcmdzTGVuZ3RoIC0gaG9sZGVyc0xlbmd0aCwgMCksCiAgICAgICAgICByZXN1bHQgPSBBcnJheShyYW5nZUxlbmd0aCArIHJpZ2h0TGVuZ3RoKSwKICAgICAgICAgIGlzVW5jdXJyaWVkID0gIWlzQ3VycmllZDsKCiAgICAgIHdoaWxlICgrK2FyZ3NJbmRleCA8IHJhbmdlTGVuZ3RoKSB7CiAgICAgICAgcmVzdWx0W2FyZ3NJbmRleF0gPSBhcmdzW2FyZ3NJbmRleF07CiAgICAgIH0KICAgICAgdmFyIG9mZnNldCA9IGFyZ3NJbmRleDsKICAgICAgd2hpbGUgKCsrcmlnaHRJbmRleCA8IHJpZ2h0TGVuZ3RoKSB7CiAgICAgICAgcmVzdWx0W29mZnNldCArIHJpZ2h0SW5kZXhdID0gcGFydGlhbHNbcmlnaHRJbmRleF07CiAgICAgIH0KICAgICAgd2hpbGUgKCsraG9sZGVyc0luZGV4IDwgaG9sZGVyc0xlbmd0aCkgewogICAgICAgIGlmIChpc1VuY3VycmllZCB8fCBhcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHRbb2Zmc2V0ICsgaG9sZGVyc1tob2xkZXJzSW5kZXhdXSA9IGFyZ3NbYXJnc0luZGV4KytdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgYHNvdXJjZWAgdG8gYGFycmF5YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gc291cmNlIFRoZSBhcnJheSB0byBjb3B5IHZhbHVlcyBmcm9tLgogICAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5PVtdXSBUaGUgYXJyYXkgdG8gY29weSB2YWx1ZXMgdG8uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYGFycmF5YC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weUFycmF5KHNvdXJjZSwgYXJyYXkpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBzb3VyY2UubGVuZ3RoOwoKICAgICAgYXJyYXkgfHwgKGFycmF5ID0gQXJyYXkobGVuZ3RoKSk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgYXJyYXlbaW5kZXhdID0gc291cmNlW2luZGV4XTsKICAgICAgfQogICAgICByZXR1cm4gYXJyYXk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb3BpZXMgcHJvcGVydGllcyBvZiBgc291cmNlYCB0byBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IHRvIGNvcHkgcHJvcGVydGllcyBmcm9tLgogICAgICogQHBhcmFtIHtBcnJheX0gcHJvcHMgVGhlIHByb3BlcnR5IGlkZW50aWZpZXJzIHRvIGNvcHkuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29iamVjdD17fV0gVGhlIG9iamVjdCB0byBjb3B5IHByb3BlcnRpZXMgdG8uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY3VzdG9taXplcl0gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBjb3BpZWQgdmFsdWVzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weU9iamVjdChzb3VyY2UsIHByb3BzLCBvYmplY3QsIGN1c3RvbWl6ZXIpIHsKICAgICAgdmFyIGlzTmV3ID0gIW9iamVjdDsKICAgICAgb2JqZWN0IHx8IChvYmplY3QgPSB7fSk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKCiAgICAgICAgdmFyIG5ld1ZhbHVlID0gY3VzdG9taXplcgogICAgICAgICAgPyBjdXN0b21pemVyKG9iamVjdFtrZXldLCBzb3VyY2Vba2V5XSwga2V5LCBvYmplY3QsIHNvdXJjZSkKICAgICAgICAgIDogdW5kZWZpbmVkOwoKICAgICAgICBpZiAobmV3VmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgbmV3VmFsdWUgPSBzb3VyY2Vba2V5XTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTmV3KSB7CiAgICAgICAgICBiYXNlQXNzaWduVmFsdWUob2JqZWN0LCBrZXksIG5ld1ZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXNzaWduVmFsdWUob2JqZWN0LCBrZXksIG5ld1ZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0KCiAgICAvKioKICAgICAqIENvcGllcyBvd24gc3ltYm9scyBvZiBgc291cmNlYCB0byBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IHRvIGNvcHkgc3ltYm9scyBmcm9tLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvYmplY3Q9e31dIFRoZSBvYmplY3QgdG8gY29weSBzeW1ib2xzIHRvLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weVN5bWJvbHMoc291cmNlLCBvYmplY3QpIHsKICAgICAgcmV0dXJuIGNvcHlPYmplY3Qoc291cmNlLCBnZXRTeW1ib2xzKHNvdXJjZSksIG9iamVjdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb3BpZXMgb3duIGFuZCBpbmhlcml0ZWQgc3ltYm9scyBvZiBgc291cmNlYCB0byBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IHRvIGNvcHkgc3ltYm9scyBmcm9tLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvYmplY3Q9e31dIFRoZSBvYmplY3QgdG8gY29weSBzeW1ib2xzIHRvLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weVN5bWJvbHNJbihzb3VyY2UsIG9iamVjdCkgewogICAgICByZXR1cm4gY29weU9iamVjdChzb3VyY2UsIGdldFN5bWJvbHNJbihzb3VyY2UpLCBvYmplY3QpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIGxpa2UgYF8uZ3JvdXBCeWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHNldHRlciBUaGUgZnVuY3Rpb24gdG8gc2V0IGFjY3VtdWxhdG9yIHZhbHVlcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpbml0aWFsaXplcl0gVGhlIGFjY3VtdWxhdG9yIG9iamVjdCBpbml0aWFsaXplci4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGFnZ3JlZ2F0b3IgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUFnZ3JlZ2F0b3Ioc2V0dGVyLCBpbml0aWFsaXplcikgewogICAgICByZXR1cm4gZnVuY3Rpb24oY29sbGVjdGlvbiwgaXRlcmF0ZWUpIHsKICAgICAgICB2YXIgZnVuYyA9IGlzQXJyYXkoY29sbGVjdGlvbikgPyBhcnJheUFnZ3JlZ2F0b3IgOiBiYXNlQWdncmVnYXRvciwKICAgICAgICAgICAgYWNjdW11bGF0b3IgPSBpbml0aWFsaXplciA/IGluaXRpYWxpemVyKCkgOiB7fTsKCiAgICAgICAgcmV0dXJuIGZ1bmMoY29sbGVjdGlvbiwgc2V0dGVyLCBnZXRJdGVyYXRlZShpdGVyYXRlZSwgMiksIGFjY3VtdWxhdG9yKTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiBsaWtlIGBfLmFzc2lnbmAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGFzc2lnbmVyIFRoZSBmdW5jdGlvbiB0byBhc3NpZ24gdmFsdWVzLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgYXNzaWduZXIgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUFzc2lnbmVyKGFzc2lnbmVyKSB7CiAgICAgIHJldHVybiBiYXNlUmVzdChmdW5jdGlvbihvYmplY3QsIHNvdXJjZXMpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgbGVuZ3RoID0gc291cmNlcy5sZW5ndGgsCiAgICAgICAgICAgIGN1c3RvbWl6ZXIgPSBsZW5ndGggPiAxID8gc291cmNlc1tsZW5ndGggLSAxXSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgZ3VhcmQgPSBsZW5ndGggPiAyID8gc291cmNlc1syXSA6IHVuZGVmaW5lZDsKCiAgICAgICAgY3VzdG9taXplciA9IChhc3NpZ25lci5sZW5ndGggPiAzICYmIHR5cGVvZiBjdXN0b21pemVyID09ICdmdW5jdGlvbicpCiAgICAgICAgICA/IChsZW5ndGgtLSwgY3VzdG9taXplcikKICAgICAgICAgIDogdW5kZWZpbmVkOwoKICAgICAgICBpZiAoZ3VhcmQgJiYgaXNJdGVyYXRlZUNhbGwoc291cmNlc1swXSwgc291cmNlc1sxXSwgZ3VhcmQpKSB7CiAgICAgICAgICBjdXN0b21pemVyID0gbGVuZ3RoIDwgMyA/IHVuZGVmaW5lZCA6IGN1c3RvbWl6ZXI7CiAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgIH0KICAgICAgICBvYmplY3QgPSBPYmplY3Qob2JqZWN0KTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHNvdXJjZSA9IHNvdXJjZXNbaW5kZXhdOwogICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICBhc3NpZ25lcihvYmplY3QsIHNvdXJjZSwgaW5kZXgsIGN1c3RvbWl6ZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBgYmFzZUVhY2hgIG9yIGBiYXNlRWFjaFJpZ2h0YCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZWFjaEZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGl0ZXJhdGUgb3ZlciBhIGNvbGxlY3Rpb24uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmcm9tUmlnaHRdIFNwZWNpZnkgaXRlcmF0aW5nIGZyb20gcmlnaHQgdG8gbGVmdC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJhc2UgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUJhc2VFYWNoKGVhY2hGdW5jLCBmcm9tUmlnaHQpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNvbGxlY3Rpb24sIGl0ZXJhdGVlKSB7CiAgICAgICAgaWYgKGNvbGxlY3Rpb24gPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb247CiAgICAgICAgfQogICAgICAgIGlmICghaXNBcnJheUxpa2UoY29sbGVjdGlvbikpIHsKICAgICAgICAgIHJldHVybiBlYWNoRnVuYyhjb2xsZWN0aW9uLCBpdGVyYXRlZSk7CiAgICAgICAgfQogICAgICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aCwKICAgICAgICAgICAgaW5kZXggPSBmcm9tUmlnaHQgPyBsZW5ndGggOiAtMSwKICAgICAgICAgICAgaXRlcmFibGUgPSBPYmplY3QoY29sbGVjdGlvbik7CgogICAgICAgIHdoaWxlICgoZnJvbVJpZ2h0ID8gaW5kZXgtLSA6ICsraW5kZXggPCBsZW5ndGgpKSB7CiAgICAgICAgICBpZiAoaXRlcmF0ZWUoaXRlcmFibGVbaW5kZXhdLCBpbmRleCwgaXRlcmFibGUpID09PSBmYWxzZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb247CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYmFzZSBmdW5jdGlvbiBmb3IgbWV0aG9kcyBsaWtlIGBfLmZvckluYCBhbmQgYF8uZm9yT3duYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtib29sZWFufSBbZnJvbVJpZ2h0XSBTcGVjaWZ5IGl0ZXJhdGluZyBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBiYXNlIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVCYXNlRm9yKGZyb21SaWdodCkgewogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0LCBpdGVyYXRlZSwga2V5c0Z1bmMpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgaXRlcmFibGUgPSBPYmplY3Qob2JqZWN0KSwKICAgICAgICAgICAgcHJvcHMgPSBrZXlzRnVuYyhvYmplY3QpLAogICAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CgogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgdmFyIGtleSA9IHByb3BzW2Zyb21SaWdodCA/IGxlbmd0aCA6ICsraW5kZXhdOwogICAgICAgICAgaWYgKGl0ZXJhdGVlKGl0ZXJhYmxlW2tleV0sIGtleSwgaXRlcmFibGUpID09PSBmYWxzZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHdyYXBzIGBmdW5jYCB0byBpbnZva2UgaXQgd2l0aCB0aGUgb3B0aW9uYWwgYHRoaXNgCiAgICAgKiBiaW5kaW5nIG9mIGB0aGlzQXJnYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gd3JhcC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBiaXRtYXNrIFRoZSBiaXRtYXNrIGZsYWdzLiBTZWUgYGNyZWF0ZVdyYXBgIGZvciBtb3JlIGRldGFpbHMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgd3JhcHBlZCBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQmluZChmdW5jLCBiaXRtYXNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpc0JpbmQgPSBiaXRtYXNrICYgV1JBUF9CSU5EX0ZMQUcsCiAgICAgICAgICBDdG9yID0gY3JlYXRlQ3RvcihmdW5jKTsKCiAgICAgIGZ1bmN0aW9uIHdyYXBwZXIoKSB7CiAgICAgICAgdmFyIGZuID0gKHRoaXMgJiYgdGhpcyAhPT0gcm9vdCAmJiB0aGlzIGluc3RhbmNlb2Ygd3JhcHBlcikgPyBDdG9yIDogZnVuYzsKICAgICAgICByZXR1cm4gZm4uYXBwbHkoaXNCaW5kID8gdGhpc0FyZyA6IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHdyYXBwZXI7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gbGlrZSBgXy5sb3dlckZpcnN0YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZE5hbWUgVGhlIG5hbWUgb2YgdGhlIGBTdHJpbmdgIGNhc2UgbWV0aG9kIHRvIHVzZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGNhc2UgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUNhc2VGaXJzdChtZXRob2ROYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICBzdHJpbmcgPSB0b1N0cmluZyhzdHJpbmcpOwoKICAgICAgICB2YXIgc3RyU3ltYm9scyA9IGhhc1VuaWNvZGUoc3RyaW5nKQogICAgICAgICAgPyBzdHJpbmdUb0FycmF5KHN0cmluZykKICAgICAgICAgIDogdW5kZWZpbmVkOwoKICAgICAgICB2YXIgY2hyID0gc3RyU3ltYm9scwogICAgICAgICAgPyBzdHJTeW1ib2xzWzBdCiAgICAgICAgICA6IHN0cmluZy5jaGFyQXQoMCk7CgogICAgICAgIHZhciB0cmFpbGluZyA9IHN0clN5bWJvbHMKICAgICAgICAgID8gY2FzdFNsaWNlKHN0clN5bWJvbHMsIDEpLmpvaW4oJycpCiAgICAgICAgICA6IHN0cmluZy5zbGljZSgxKTsKCiAgICAgICAgcmV0dXJuIGNoclttZXRob2ROYW1lXSgpICsgdHJhaWxpbmc7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gbGlrZSBgXy5jYW1lbENhc2VgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gY29tYmluZSBlYWNoIHdvcmQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBjb21wb3VuZGVyIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVDb21wb3VuZGVyKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICByZXR1cm4gYXJyYXlSZWR1Y2Uod29yZHMoZGVidXJyKHN0cmluZykucmVwbGFjZShyZUFwb3MsICcnKSksIGNhbGxiYWNrLCAnJyk7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBwcm9kdWNlcyBhbiBpbnN0YW5jZSBvZiBgQ3RvcmAgcmVnYXJkbGVzcyBvZgogICAgICogd2hldGhlciBpdCB3YXMgaW52b2tlZCBhcyBwYXJ0IG9mIGEgYG5ld2AgZXhwcmVzc2lvbiBvciBieSBgY2FsbGAgb3IgYGFwcGx5YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gQ3RvciBUaGUgY29uc3RydWN0b3IgdG8gd3JhcC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHdyYXBwZWQgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUN0b3IoQ3RvcikgewogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gVXNlIGEgYHN3aXRjaGAgc3RhdGVtZW50IHRvIHdvcmsgd2l0aCBjbGFzcyBjb25zdHJ1Y3RvcnMuIFNlZQogICAgICAgIC8vIGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLWVjbWFzY3JpcHQtZnVuY3Rpb24tb2JqZWN0cy1jYWxsLXRoaXNhcmd1bWVudC1hcmd1bWVudHNsaXN0CiAgICAgICAgLy8gZm9yIG1vcmUgZGV0YWlscy4KICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDA6IHJldHVybiBuZXcgQ3RvcjsKICAgICAgICAgIGNhc2UgMTogcmV0dXJuIG5ldyBDdG9yKGFyZ3NbMF0pOwogICAgICAgICAgY2FzZSAyOiByZXR1cm4gbmV3IEN0b3IoYXJnc1swXSwgYXJnc1sxXSk7CiAgICAgICAgICBjYXNlIDM6IHJldHVybiBuZXcgQ3RvcihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgICAgICAgIGNhc2UgNDogcmV0dXJuIG5ldyBDdG9yKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10pOwogICAgICAgICAgY2FzZSA1OiByZXR1cm4gbmV3IEN0b3IoYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSk7CiAgICAgICAgICBjYXNlIDY6IHJldHVybiBuZXcgQ3RvcihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdKTsKICAgICAgICAgIGNhc2UgNzogcmV0dXJuIG5ldyBDdG9yKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0pOwogICAgICAgIH0KICAgICAgICB2YXIgdGhpc0JpbmRpbmcgPSBiYXNlQ3JlYXRlKEN0b3IucHJvdG90eXBlKSwKICAgICAgICAgICAgcmVzdWx0ID0gQ3Rvci5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CgogICAgICAgIC8vIE1pbWljIHRoZSBjb25zdHJ1Y3RvcidzIGByZXR1cm5gIGJlaGF2aW9yLgogICAgICAgIC8vIFNlZSBodHRwczovL2VzNS5naXRodWIuaW8vI3gxMy4yLjIgZm9yIG1vcmUgZGV0YWlscy4KICAgICAgICByZXR1cm4gaXNPYmplY3QocmVzdWx0KSA/IHJlc3VsdCA6IHRoaXNCaW5kaW5nOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgd3JhcHMgYGZ1bmNgIHRvIGVuYWJsZSBjdXJyeWluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gd3JhcC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBiaXRtYXNrIFRoZSBiaXRtYXNrIGZsYWdzLiBTZWUgYGNyZWF0ZVdyYXBgIGZvciBtb3JlIGRldGFpbHMuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYXJpdHkgVGhlIGFyaXR5IG9mIGBmdW5jYC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHdyYXBwZWQgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUN1cnJ5KGZ1bmMsIGJpdG1hc2ssIGFyaXR5KSB7CiAgICAgIHZhciBDdG9yID0gY3JlYXRlQ3RvcihmdW5jKTsKCiAgICAgIGZ1bmN0aW9uIHdyYXBwZXIoKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgICAgICAgIGFyZ3MgPSBBcnJheShsZW5ndGgpLAogICAgICAgICAgICBpbmRleCA9IGxlbmd0aCwKICAgICAgICAgICAgcGxhY2Vob2xkZXIgPSBnZXRIb2xkZXIod3JhcHBlcik7CgogICAgICAgIHdoaWxlIChpbmRleC0tKSB7CiAgICAgICAgICBhcmdzW2luZGV4XSA9IGFyZ3VtZW50c1tpbmRleF07CiAgICAgICAgfQogICAgICAgIHZhciBob2xkZXJzID0gKGxlbmd0aCA8IDMgJiYgYXJnc1swXSAhPT0gcGxhY2Vob2xkZXIgJiYgYXJnc1tsZW5ndGggLSAxXSAhPT0gcGxhY2Vob2xkZXIpCiAgICAgICAgICA/IFtdCiAgICAgICAgICA6IHJlcGxhY2VIb2xkZXJzKGFyZ3MsIHBsYWNlaG9sZGVyKTsKCiAgICAgICAgbGVuZ3RoIC09IGhvbGRlcnMubGVuZ3RoOwogICAgICAgIGlmIChsZW5ndGggPCBhcml0eSkgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZVJlY3VycnkoCiAgICAgICAgICAgIGZ1bmMsIGJpdG1hc2ssIGNyZWF0ZUh5YnJpZCwgd3JhcHBlci5wbGFjZWhvbGRlciwgdW5kZWZpbmVkLAogICAgICAgICAgICBhcmdzLCBob2xkZXJzLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgYXJpdHkgLSBsZW5ndGgpOwogICAgICAgIH0KICAgICAgICB2YXIgZm4gPSAodGhpcyAmJiB0aGlzICE9PSByb290ICYmIHRoaXMgaW5zdGFuY2VvZiB3cmFwcGVyKSA/IEN0b3IgOiBmdW5jOwogICAgICAgIHJldHVybiBhcHBseShmbiwgdGhpcywgYXJncyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHdyYXBwZXI7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYF8uZmluZGAgb3IgYF8uZmluZExhc3RgIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmaW5kSW5kZXhGdW5jIFRoZSBmdW5jdGlvbiB0byBmaW5kIHRoZSBjb2xsZWN0aW9uIGluZGV4LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZmluZCBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlRmluZChmaW5kSW5kZXhGdW5jKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihjb2xsZWN0aW9uLCBwcmVkaWNhdGUsIGZyb21JbmRleCkgewogICAgICAgIHZhciBpdGVyYWJsZSA9IE9iamVjdChjb2xsZWN0aW9uKTsKICAgICAgICBpZiAoIWlzQXJyYXlMaWtlKGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICB2YXIgaXRlcmF0ZWUgPSBnZXRJdGVyYXRlZShwcmVkaWNhdGUsIDMpOwogICAgICAgICAgY29sbGVjdGlvbiA9IGtleXMoY29sbGVjdGlvbik7CiAgICAgICAgICBwcmVkaWNhdGUgPSBmdW5jdGlvbihrZXkpIHsgcmV0dXJuIGl0ZXJhdGVlKGl0ZXJhYmxlW2tleV0sIGtleSwgaXRlcmFibGUpOyB9OwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXhGdW5jKGNvbGxlY3Rpb24sIHByZWRpY2F0ZSwgZnJvbUluZGV4KTsKICAgICAgICByZXR1cm4gaW5kZXggPiAtMSA/IGl0ZXJhYmxlW2l0ZXJhdGVlID8gY29sbGVjdGlvbltpbmRleF0gOiBpbmRleF0gOiB1bmRlZmluZWQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYF8uZmxvd2Agb3IgYF8uZmxvd1JpZ2h0YCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtib29sZWFufSBbZnJvbVJpZ2h0XSBTcGVjaWZ5IGl0ZXJhdGluZyBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBmbG93IGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVGbG93KGZyb21SaWdodCkgewogICAgICByZXR1cm4gZmxhdFJlc3QoZnVuY3Rpb24oZnVuY3MpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gZnVuY3MubGVuZ3RoLAogICAgICAgICAgICBpbmRleCA9IGxlbmd0aCwKICAgICAgICAgICAgcHJlcmVxID0gTG9kYXNoV3JhcHBlci5wcm90b3R5cGUudGhydTsKCiAgICAgICAgaWYgKGZyb21SaWdodCkgewogICAgICAgICAgZnVuY3MucmV2ZXJzZSgpOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgICAgdmFyIGZ1bmMgPSBmdW5jc1tpbmRleF07CiAgICAgICAgICBpZiAodHlwZW9mIGZ1bmMgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKEZVTkNfRVJST1JfVEVYVCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJlcmVxICYmICF3cmFwcGVyICYmIGdldEZ1bmNOYW1lKGZ1bmMpID09ICd3cmFwcGVyJykgewogICAgICAgICAgICB2YXIgd3JhcHBlciA9IG5ldyBMb2Rhc2hXcmFwcGVyKFtdLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5kZXggPSB3cmFwcGVyID8gaW5kZXggOiBsZW5ndGg7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGZ1bmMgPSBmdW5jc1tpbmRleF07CgogICAgICAgICAgdmFyIGZ1bmNOYW1lID0gZ2V0RnVuY05hbWUoZnVuYyksCiAgICAgICAgICAgICAgZGF0YSA9IGZ1bmNOYW1lID09ICd3cmFwcGVyJyA/IGdldERhdGEoZnVuYykgOiB1bmRlZmluZWQ7CgogICAgICAgICAgaWYgKGRhdGEgJiYgaXNMYXppYWJsZShkYXRhWzBdKSAmJgogICAgICAgICAgICAgICAgZGF0YVsxXSA9PSAoV1JBUF9BUllfRkxBRyB8IFdSQVBfQ1VSUllfRkxBRyB8IFdSQVBfUEFSVElBTF9GTEFHIHwgV1JBUF9SRUFSR19GTEFHKSAmJgogICAgICAgICAgICAgICAgIWRhdGFbNF0ubGVuZ3RoICYmIGRhdGFbOV0gPT0gMQogICAgICAgICAgICAgICkgewogICAgICAgICAgICB3cmFwcGVyID0gd3JhcHBlcltnZXRGdW5jTmFtZShkYXRhWzBdKV0uYXBwbHkod3JhcHBlciwgZGF0YVszXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3cmFwcGVyID0gKGZ1bmMubGVuZ3RoID09IDEgJiYgaXNMYXppYWJsZShmdW5jKSkKICAgICAgICAgICAgICA/IHdyYXBwZXJbZnVuY05hbWVdKCkKICAgICAgICAgICAgICA6IHdyYXBwZXIudGhydShmdW5jKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICAgICAgdmFsdWUgPSBhcmdzWzBdOwoKICAgICAgICAgIGlmICh3cmFwcGVyICYmIGFyZ3MubGVuZ3RoID09IDEgJiYgaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHdyYXBwZXIucGxhbnQodmFsdWUpLnZhbHVlKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5kZXggPSAwLAogICAgICAgICAgICAgIHJlc3VsdCA9IGxlbmd0aCA/IGZ1bmNzW2luZGV4XS5hcHBseSh0aGlzLCBhcmdzKSA6IHZhbHVlOwoKICAgICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmNzW2luZGV4XS5jYWxsKHRoaXMsIHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgd3JhcHMgYGZ1bmNgIHRvIGludm9rZSBpdCB3aXRoIG9wdGlvbmFsIGB0aGlzYAogICAgICogYmluZGluZyBvZiBgdGhpc0FyZ2AsIHBhcnRpYWwgYXBwbGljYXRpb24sIGFuZCBjdXJyeWluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IGZ1bmMgVGhlIGZ1bmN0aW9uIG9yIG1ldGhvZCBuYW1lIHRvIHdyYXAuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYml0bWFzayBUaGUgYml0bWFzayBmbGFncy4gU2VlIGBjcmVhdGVXcmFwYCBmb3IgbW9yZSBkZXRhaWxzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBmdW5jYC4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtwYXJ0aWFsc10gVGhlIGFyZ3VtZW50cyB0byBwcmVwZW5kIHRvIHRob3NlIHByb3ZpZGVkIHRvCiAgICAgKiAgdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtob2xkZXJzXSBUaGUgYHBhcnRpYWxzYCBwbGFjZWhvbGRlciBpbmRleGVzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3BhcnRpYWxzUmlnaHRdIFRoZSBhcmd1bWVudHMgdG8gYXBwZW5kIHRvIHRob3NlIHByb3ZpZGVkCiAgICAgKiAgdG8gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtob2xkZXJzUmlnaHRdIFRoZSBgcGFydGlhbHNSaWdodGAgcGxhY2Vob2xkZXIgaW5kZXhlcy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFthcmdQb3NdIFRoZSBhcmd1bWVudCBwb3NpdGlvbnMgb2YgdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJ5XSBUaGUgYXJpdHkgY2FwIG9mIGBmdW5jYC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHldIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyB3cmFwcGVkIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVIeWJyaWQoZnVuYywgYml0bWFzaywgdGhpc0FyZywgcGFydGlhbHMsIGhvbGRlcnMsIHBhcnRpYWxzUmlnaHQsIGhvbGRlcnNSaWdodCwgYXJnUG9zLCBhcnksIGFyaXR5KSB7CiAgICAgIHZhciBpc0FyeSA9IGJpdG1hc2sgJiBXUkFQX0FSWV9GTEFHLAogICAgICAgICAgaXNCaW5kID0gYml0bWFzayAmIFdSQVBfQklORF9GTEFHLAogICAgICAgICAgaXNCaW5kS2V5ID0gYml0bWFzayAmIFdSQVBfQklORF9LRVlfRkxBRywKICAgICAgICAgIGlzQ3VycmllZCA9IGJpdG1hc2sgJiAoV1JBUF9DVVJSWV9GTEFHIHwgV1JBUF9DVVJSWV9SSUdIVF9GTEFHKSwKICAgICAgICAgIGlzRmxpcCA9IGJpdG1hc2sgJiBXUkFQX0ZMSVBfRkxBRywKICAgICAgICAgIEN0b3IgPSBpc0JpbmRLZXkgPyB1bmRlZmluZWQgOiBjcmVhdGVDdG9yKGZ1bmMpOwoKICAgICAgZnVuY3Rpb24gd3JhcHBlcigpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKICAgICAgICAgICAgYXJncyA9IEFycmF5KGxlbmd0aCksCiAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwoKICAgICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgICAgYXJnc1tpbmRleF0gPSBhcmd1bWVudHNbaW5kZXhdOwogICAgICAgIH0KICAgICAgICBpZiAoaXNDdXJyaWVkKSB7CiAgICAgICAgICB2YXIgcGxhY2Vob2xkZXIgPSBnZXRIb2xkZXIod3JhcHBlciksCiAgICAgICAgICAgICAgaG9sZGVyc0NvdW50ID0gY291bnRIb2xkZXJzKGFyZ3MsIHBsYWNlaG9sZGVyKTsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRpYWxzKSB7CiAgICAgICAgICBhcmdzID0gY29tcG9zZUFyZ3MoYXJncywgcGFydGlhbHMsIGhvbGRlcnMsIGlzQ3VycmllZCk7CiAgICAgICAgfQogICAgICAgIGlmIChwYXJ0aWFsc1JpZ2h0KSB7CiAgICAgICAgICBhcmdzID0gY29tcG9zZUFyZ3NSaWdodChhcmdzLCBwYXJ0aWFsc1JpZ2h0LCBob2xkZXJzUmlnaHQsIGlzQ3VycmllZCk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCAtPSBob2xkZXJzQ291bnQ7CiAgICAgICAgaWYgKGlzQ3VycmllZCAmJiBsZW5ndGggPCBhcml0eSkgewogICAgICAgICAgdmFyIG5ld0hvbGRlcnMgPSByZXBsYWNlSG9sZGVycyhhcmdzLCBwbGFjZWhvbGRlcik7CiAgICAgICAgICByZXR1cm4gY3JlYXRlUmVjdXJyeSgKICAgICAgICAgICAgZnVuYywgYml0bWFzaywgY3JlYXRlSHlicmlkLCB3cmFwcGVyLnBsYWNlaG9sZGVyLCB0aGlzQXJnLAogICAgICAgICAgICBhcmdzLCBuZXdIb2xkZXJzLCBhcmdQb3MsIGFyeSwgYXJpdHkgLSBsZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHZhciB0aGlzQmluZGluZyA9IGlzQmluZCA/IHRoaXNBcmcgOiB0aGlzLAogICAgICAgICAgICBmbiA9IGlzQmluZEtleSA/IHRoaXNCaW5kaW5nW2Z1bmNdIDogZnVuYzsKCiAgICAgICAgbGVuZ3RoID0gYXJncy5sZW5ndGg7CiAgICAgICAgaWYgKGFyZ1BvcykgewogICAgICAgICAgYXJncyA9IHJlb3JkZXIoYXJncywgYXJnUG9zKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRmxpcCAmJiBsZW5ndGggPiAxKSB7CiAgICAgICAgICBhcmdzLnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQXJ5ICYmIGFyeSA8IGxlbmd0aCkgewogICAgICAgICAgYXJncy5sZW5ndGggPSBhcnk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzICYmIHRoaXMgIT09IHJvb3QgJiYgdGhpcyBpbnN0YW5jZW9mIHdyYXBwZXIpIHsKICAgICAgICAgIGZuID0gQ3RvciB8fCBjcmVhdGVDdG9yKGZuKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgICAgfQogICAgICByZXR1cm4gd3JhcHBlcjsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiBsaWtlIGBfLmludmVydEJ5YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gc2V0dGVyIFRoZSBmdW5jdGlvbiB0byBzZXQgYWNjdW11bGF0b3IgdmFsdWVzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gdG9JdGVyYXRlZSBUaGUgZnVuY3Rpb24gdG8gcmVzb2x2ZSBpdGVyYXRlZXMuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBpbnZlcnRlciBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlSW52ZXJ0ZXIoc2V0dGVyLCB0b0l0ZXJhdGVlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QsIGl0ZXJhdGVlKSB7CiAgICAgICAgcmV0dXJuIGJhc2VJbnZlcnRlcihvYmplY3QsIHNldHRlciwgdG9JdGVyYXRlZShpdGVyYXRlZSksIHt9KTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIGEgbWF0aGVtYXRpY2FsIG9wZXJhdGlvbiBvbiB0d28gdmFsdWVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvcGVyYXRvciBUaGUgZnVuY3Rpb24gdG8gcGVyZm9ybSB0aGUgb3BlcmF0aW9uLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtkZWZhdWx0VmFsdWVdIFRoZSB2YWx1ZSB1c2VkIGZvciBgdW5kZWZpbmVkYCBhcmd1bWVudHMuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBtYXRoZW1hdGljYWwgb3BlcmF0aW9uIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVNYXRoT3BlcmF0aW9uKG9wZXJhdG9yLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBvdGhlcikgewogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgb3RoZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAob3RoZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBvdGhlcjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZycgfHwgdHlwZW9mIG90aGVyID09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHZhbHVlID0gYmFzZVRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgb3RoZXIgPSBiYXNlVG9TdHJpbmcob3RoZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBiYXNlVG9OdW1iZXIodmFsdWUpOwogICAgICAgICAgICBvdGhlciA9IGJhc2VUb051bWJlcihvdGhlcik7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHQgPSBvcGVyYXRvcih2YWx1ZSwgb3RoZXIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIGxpa2UgYF8ub3ZlcmAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGFycmF5RnVuYyBUaGUgZnVuY3Rpb24gdG8gaXRlcmF0ZSBvdmVyIGl0ZXJhdGVlcy4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IG92ZXIgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZU92ZXIoYXJyYXlGdW5jKSB7CiAgICAgIHJldHVybiBmbGF0UmVzdChmdW5jdGlvbihpdGVyYXRlZXMpIHsKICAgICAgICBpdGVyYXRlZXMgPSBhcnJheU1hcChpdGVyYXRlZXMsIGJhc2VVbmFyeShnZXRJdGVyYXRlZSgpKSk7CiAgICAgICAgcmV0dXJuIGJhc2VSZXN0KGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAgIHZhciB0aGlzQXJnID0gdGhpczsKICAgICAgICAgIHJldHVybiBhcnJheUZ1bmMoaXRlcmF0ZWVzLCBmdW5jdGlvbihpdGVyYXRlZSkgewogICAgICAgICAgICByZXR1cm4gYXBwbHkoaXRlcmF0ZWUsIHRoaXNBcmcsIGFyZ3MpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyB0aGUgcGFkZGluZyBmb3IgYHN0cmluZ2AgYmFzZWQgb24gYGxlbmd0aGAuIFRoZSBgY2hhcnNgIHN0cmluZwogICAgICogaXMgdHJ1bmNhdGVkIGlmIHRoZSBudW1iZXIgb2YgY2hhcmFjdGVycyBleGNlZWRzIGBsZW5ndGhgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoIFRoZSBwYWRkaW5nIGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY2hhcnM9JyAnXSBUaGUgc3RyaW5nIHVzZWQgYXMgcGFkZGluZy4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHBhZGRpbmcgZm9yIGBzdHJpbmdgLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVQYWRkaW5nKGxlbmd0aCwgY2hhcnMpIHsKICAgICAgY2hhcnMgPSBjaGFycyA9PT0gdW5kZWZpbmVkID8gJyAnIDogYmFzZVRvU3RyaW5nKGNoYXJzKTsKCiAgICAgIHZhciBjaGFyc0xlbmd0aCA9IGNoYXJzLmxlbmd0aDsKICAgICAgaWYgKGNoYXJzTGVuZ3RoIDwgMikgewogICAgICAgIHJldHVybiBjaGFyc0xlbmd0aCA/IGJhc2VSZXBlYXQoY2hhcnMsIGxlbmd0aCkgOiBjaGFyczsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gYmFzZVJlcGVhdChjaGFycywgbmF0aXZlQ2VpbChsZW5ndGggLyBzdHJpbmdTaXplKGNoYXJzKSkpOwogICAgICByZXR1cm4gaGFzVW5pY29kZShjaGFycykKICAgICAgICA/IGNhc3RTbGljZShzdHJpbmdUb0FycmF5KHJlc3VsdCksIDAsIGxlbmd0aCkuam9pbignJykKICAgICAgICA6IHJlc3VsdC5zbGljZSgwLCBsZW5ndGgpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgd3JhcHMgYGZ1bmNgIHRvIGludm9rZSBpdCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZwogICAgICogb2YgYHRoaXNBcmdgIGFuZCBgcGFydGlhbHNgIHByZXBlbmRlZCB0byB0aGUgYXJndW1lbnRzIGl0IHJlY2VpdmVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byB3cmFwLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGJpdG1hc2sgVGhlIGJpdG1hc2sgZmxhZ3MuIFNlZSBgY3JlYXRlV3JhcGAgZm9yIG1vcmUgZGV0YWlscy4KICAgICAqIEBwYXJhbSB7Kn0gdGhpc0FyZyBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAgICogQHBhcmFtIHtBcnJheX0gcGFydGlhbHMgVGhlIGFyZ3VtZW50cyB0byBwcmVwZW5kIHRvIHRob3NlIHByb3ZpZGVkIHRvCiAgICAgKiAgdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHdyYXBwZWQgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVBhcnRpYWwoZnVuYywgYml0bWFzaywgdGhpc0FyZywgcGFydGlhbHMpIHsKICAgICAgdmFyIGlzQmluZCA9IGJpdG1hc2sgJiBXUkFQX0JJTkRfRkxBRywKICAgICAgICAgIEN0b3IgPSBjcmVhdGVDdG9yKGZ1bmMpOwoKICAgICAgZnVuY3Rpb24gd3JhcHBlcigpIHsKICAgICAgICB2YXIgYXJnc0luZGV4ID0gLTEsCiAgICAgICAgICAgIGFyZ3NMZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICBsZWZ0SW5kZXggPSAtMSwKICAgICAgICAgICAgbGVmdExlbmd0aCA9IHBhcnRpYWxzLmxlbmd0aCwKICAgICAgICAgICAgYXJncyA9IEFycmF5KGxlZnRMZW5ndGggKyBhcmdzTGVuZ3RoKSwKICAgICAgICAgICAgZm4gPSAodGhpcyAmJiB0aGlzICE9PSByb290ICYmIHRoaXMgaW5zdGFuY2VvZiB3cmFwcGVyKSA/IEN0b3IgOiBmdW5jOwoKICAgICAgICB3aGlsZSAoKytsZWZ0SW5kZXggPCBsZWZ0TGVuZ3RoKSB7CiAgICAgICAgICBhcmdzW2xlZnRJbmRleF0gPSBwYXJ0aWFsc1tsZWZ0SW5kZXhdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoYXJnc0xlbmd0aC0tKSB7CiAgICAgICAgICBhcmdzW2xlZnRJbmRleCsrXSA9IGFyZ3VtZW50c1srK2FyZ3NJbmRleF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcHBseShmbiwgaXNCaW5kID8gdGhpc0FyZyA6IHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICAgIHJldHVybiB3cmFwcGVyOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGBfLnJhbmdlYCBvciBgXy5yYW5nZVJpZ2h0YCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtib29sZWFufSBbZnJvbVJpZ2h0XSBTcGVjaWZ5IGl0ZXJhdGluZyBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByYW5nZSBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlUmFuZ2UoZnJvbVJpZ2h0KSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzdGFydCwgZW5kLCBzdGVwKSB7CiAgICAgICAgaWYgKHN0ZXAgJiYgdHlwZW9mIHN0ZXAgIT0gJ251bWJlcicgJiYgaXNJdGVyYXRlZUNhbGwoc3RhcnQsIGVuZCwgc3RlcCkpIHsKICAgICAgICAgIGVuZCA9IHN0ZXAgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICAgIC8vIEVuc3VyZSB0aGUgc2lnbiBvZiBgLTBgIGlzIHByZXNlcnZlZC4KICAgICAgICBzdGFydCA9IHRvRmluaXRlKHN0YXJ0KTsKICAgICAgICBpZiAoZW5kID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgc3RhcnQgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbmQgPSB0b0Zpbml0ZShlbmQpOwogICAgICAgIH0KICAgICAgICBzdGVwID0gc3RlcCA9PT0gdW5kZWZpbmVkID8gKHN0YXJ0IDwgZW5kID8gMSA6IC0xKSA6IHRvRmluaXRlKHN0ZXApOwogICAgICAgIHJldHVybiBiYXNlUmFuZ2Uoc3RhcnQsIGVuZCwgc3RlcCwgZnJvbVJpZ2h0KTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIGEgcmVsYXRpb25hbCBvcGVyYXRpb24gb24gdHdvIHZhbHVlcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb3BlcmF0b3IgVGhlIGZ1bmN0aW9uIHRvIHBlcmZvcm0gdGhlIG9wZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHJlbGF0aW9uYWwgb3BlcmF0aW9uIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVSZWxhdGlvbmFsT3BlcmF0aW9uKG9wZXJhdG9yKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgb3RoZXIpIHsKICAgICAgICBpZiAoISh0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZycgJiYgdHlwZW9mIG90aGVyID09ICdzdHJpbmcnKSkgewogICAgICAgICAgdmFsdWUgPSB0b051bWJlcih2YWx1ZSk7CiAgICAgICAgICBvdGhlciA9IHRvTnVtYmVyKG90aGVyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9wZXJhdG9yKHZhbHVlLCBvdGhlcik7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCB3cmFwcyBgZnVuY2AgdG8gY29udGludWUgY3VycnlpbmcuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHdyYXAuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYml0bWFzayBUaGUgYml0bWFzayBmbGFncy4gU2VlIGBjcmVhdGVXcmFwYCBmb3IgbW9yZSBkZXRhaWxzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gd3JhcEZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGNyZWF0ZSB0aGUgYGZ1bmNgIHdyYXBwZXIuCiAgICAgKiBAcGFyYW0geyp9IHBsYWNlaG9sZGVyIFRoZSBwbGFjZWhvbGRlciB2YWx1ZS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgZnVuY2AuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbcGFydGlhbHNdIFRoZSBhcmd1bWVudHMgdG8gcHJlcGVuZCB0byB0aG9zZSBwcm92aWRlZCB0bwogICAgICogIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbaG9sZGVyc10gVGhlIGBwYXJ0aWFsc2AgcGxhY2Vob2xkZXIgaW5kZXhlcy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFthcmdQb3NdIFRoZSBhcmd1bWVudCBwb3NpdGlvbnMgb2YgdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJ5XSBUaGUgYXJpdHkgY2FwIG9mIGBmdW5jYC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHldIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyB3cmFwcGVkIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVSZWN1cnJ5KGZ1bmMsIGJpdG1hc2ssIHdyYXBGdW5jLCBwbGFjZWhvbGRlciwgdGhpc0FyZywgcGFydGlhbHMsIGhvbGRlcnMsIGFyZ1BvcywgYXJ5LCBhcml0eSkgewogICAgICB2YXIgaXNDdXJyeSA9IGJpdG1hc2sgJiBXUkFQX0NVUlJZX0ZMQUcsCiAgICAgICAgICBuZXdIb2xkZXJzID0gaXNDdXJyeSA/IGhvbGRlcnMgOiB1bmRlZmluZWQsCiAgICAgICAgICBuZXdIb2xkZXJzUmlnaHQgPSBpc0N1cnJ5ID8gdW5kZWZpbmVkIDogaG9sZGVycywKICAgICAgICAgIG5ld1BhcnRpYWxzID0gaXNDdXJyeSA/IHBhcnRpYWxzIDogdW5kZWZpbmVkLAogICAgICAgICAgbmV3UGFydGlhbHNSaWdodCA9IGlzQ3VycnkgPyB1bmRlZmluZWQgOiBwYXJ0aWFsczsKCiAgICAgIGJpdG1hc2sgfD0gKGlzQ3VycnkgPyBXUkFQX1BBUlRJQUxfRkxBRyA6IFdSQVBfUEFSVElBTF9SSUdIVF9GTEFHKTsKICAgICAgYml0bWFzayAmPSB+KGlzQ3VycnkgPyBXUkFQX1BBUlRJQUxfUklHSFRfRkxBRyA6IFdSQVBfUEFSVElBTF9GTEFHKTsKCiAgICAgIGlmICghKGJpdG1hc2sgJiBXUkFQX0NVUlJZX0JPVU5EX0ZMQUcpKSB7CiAgICAgICAgYml0bWFzayAmPSB+KFdSQVBfQklORF9GTEFHIHwgV1JBUF9CSU5EX0tFWV9GTEFHKTsKICAgICAgfQogICAgICB2YXIgbmV3RGF0YSA9IFsKICAgICAgICBmdW5jLCBiaXRtYXNrLCB0aGlzQXJnLCBuZXdQYXJ0aWFscywgbmV3SG9sZGVycywgbmV3UGFydGlhbHNSaWdodCwKICAgICAgICBuZXdIb2xkZXJzUmlnaHQsIGFyZ1BvcywgYXJ5LCBhcml0eQogICAgICBdOwoKICAgICAgdmFyIHJlc3VsdCA9IHdyYXBGdW5jLmFwcGx5KHVuZGVmaW5lZCwgbmV3RGF0YSk7CiAgICAgIGlmIChpc0xhemlhYmxlKGZ1bmMpKSB7CiAgICAgICAgc2V0RGF0YShyZXN1bHQsIG5ld0RhdGEpOwogICAgICB9CiAgICAgIHJlc3VsdC5wbGFjZWhvbGRlciA9IHBsYWNlaG9sZGVyOwogICAgICByZXR1cm4gc2V0V3JhcFRvU3RyaW5nKHJlc3VsdCwgZnVuYywgYml0bWFzayk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gbGlrZSBgXy5yb3VuZGAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2ROYW1lIFRoZSBuYW1lIG9mIHRoZSBgTWF0aGAgbWV0aG9kIHRvIHVzZSB3aGVuIHJvdW5kaW5nLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgcm91bmQgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVJvdW5kKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBNYXRoW21ldGhvZE5hbWVdOwogICAgICByZXR1cm4gZnVuY3Rpb24obnVtYmVyLCBwcmVjaXNpb24pIHsKICAgICAgICBudW1iZXIgPSB0b051bWJlcihudW1iZXIpOwogICAgICAgIHByZWNpc2lvbiA9IHByZWNpc2lvbiA9PSBudWxsID8gMCA6IG5hdGl2ZU1pbih0b0ludGVnZXIocHJlY2lzaW9uKSwgMjkyKTsKICAgICAgICBpZiAocHJlY2lzaW9uICYmIG5hdGl2ZUlzRmluaXRlKG51bWJlcikpIHsKICAgICAgICAgIC8vIFNoaWZ0IHdpdGggZXhwb25lbnRpYWwgbm90YXRpb24gdG8gYXZvaWQgZmxvYXRpbmctcG9pbnQgaXNzdWVzLgogICAgICAgICAgLy8gU2VlIFtNRE5dKGh0dHBzOi8vbWRuLmlvL3JvdW5kI0V4YW1wbGVzKSBmb3IgbW9yZSBkZXRhaWxzLgogICAgICAgICAgdmFyIHBhaXIgPSAodG9TdHJpbmcobnVtYmVyKSArICdlJykuc3BsaXQoJ2UnKSwKICAgICAgICAgICAgICB2YWx1ZSA9IGZ1bmMocGFpclswXSArICdlJyArICgrcGFpclsxXSArIHByZWNpc2lvbikpOwoKICAgICAgICAgIHBhaXIgPSAodG9TdHJpbmcodmFsdWUpICsgJ2UnKS5zcGxpdCgnZScpOwogICAgICAgICAgcmV0dXJuICsocGFpclswXSArICdlJyArICgrcGFpclsxXSAtIHByZWNpc2lvbikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZnVuYyhudW1iZXIpOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNldCBvYmplY3Qgb2YgYHZhbHVlc2AuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IHZhbHVlcyBUaGUgdmFsdWVzIHRvIGFkZCB0byB0aGUgc2V0LgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IHNldC4KICAgICAqLwogICAgdmFyIGNyZWF0ZVNldCA9ICEoU2V0ICYmICgxIC8gc2V0VG9BcnJheShuZXcgU2V0KFssLTBdKSlbMV0pID09IElORklOSVRZKSA/IG5vb3AgOiBmdW5jdGlvbih2YWx1ZXMpIHsKICAgICAgcmV0dXJuIG5ldyBTZXQodmFsdWVzKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYF8udG9QYWlyc2Agb3IgYF8udG9QYWlyc0luYCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0ga2V5c0Z1bmMgVGhlIGZ1bmN0aW9uIHRvIGdldCB0aGUga2V5cyBvZiBhIGdpdmVuIG9iamVjdC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHBhaXJzIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVUb1BhaXJzKGtleXNGdW5jKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICB2YXIgdGFnID0gZ2V0VGFnKG9iamVjdCk7CiAgICAgICAgaWYgKHRhZyA9PSBtYXBUYWcpIHsKICAgICAgICAgIHJldHVybiBtYXBUb0FycmF5KG9iamVjdCk7CiAgICAgICAgfQogICAgICAgIGlmICh0YWcgPT0gc2V0VGFnKSB7CiAgICAgICAgICByZXR1cm4gc2V0VG9QYWlycyhvYmplY3QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYmFzZVRvUGFpcnMob2JqZWN0LCBrZXlzRnVuYyhvYmplY3QpKTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGVpdGhlciBjdXJyaWVzIG9yIGludm9rZXMgYGZ1bmNgIHdpdGggb3B0aW9uYWwKICAgICAqIGB0aGlzYCBiaW5kaW5nIGFuZCBwYXJ0aWFsbHkgYXBwbGllZCBhcmd1bWVudHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBmdW5jIFRoZSBmdW5jdGlvbiBvciBtZXRob2QgbmFtZSB0byB3cmFwLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGJpdG1hc2sgVGhlIGJpdG1hc2sgZmxhZ3MuCiAgICAgKiAgICAxIC0gYF8uYmluZGAKICAgICAqICAgIDIgLSBgXy5iaW5kS2V5YAogICAgICogICAgNCAtIGBfLmN1cnJ5YCBvciBgXy5jdXJyeVJpZ2h0YCBvZiBhIGJvdW5kIGZ1bmN0aW9uCiAgICAgKiAgICA4IC0gYF8uY3VycnlgCiAgICAgKiAgIDE2IC0gYF8uY3VycnlSaWdodGAKICAgICAqICAgMzIgLSBgXy5wYXJ0aWFsYAogICAgICogICA2NCAtIGBfLnBhcnRpYWxSaWdodGAKICAgICAqICAxMjggLSBgXy5yZWFyZ2AKICAgICAqICAyNTYgLSBgXy5hcnlgCiAgICAgKiAgNTEyIC0gYF8uZmxpcGAKICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgZnVuY2AuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbcGFydGlhbHNdIFRoZSBhcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbaG9sZGVyc10gVGhlIGBwYXJ0aWFsc2AgcGxhY2Vob2xkZXIgaW5kZXhlcy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFthcmdQb3NdIFRoZSBhcmd1bWVudCBwb3NpdGlvbnMgb2YgdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJ5XSBUaGUgYXJpdHkgY2FwIG9mIGBmdW5jYC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHldIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyB3cmFwcGVkIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVXcmFwKGZ1bmMsIGJpdG1hc2ssIHRoaXNBcmcsIHBhcnRpYWxzLCBob2xkZXJzLCBhcmdQb3MsIGFyeSwgYXJpdHkpIHsKICAgICAgdmFyIGlzQmluZEtleSA9IGJpdG1hc2sgJiBXUkFQX0JJTkRfS0VZX0ZMQUc7CiAgICAgIGlmICghaXNCaW5kS2V5ICYmIHR5cGVvZiBmdW5jICE9ICdmdW5jdGlvbicpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKEZVTkNfRVJST1JfVEVYVCk7CiAgICAgIH0KICAgICAgdmFyIGxlbmd0aCA9IHBhcnRpYWxzID8gcGFydGlhbHMubGVuZ3RoIDogMDsKICAgICAgaWYgKCFsZW5ndGgpIHsKICAgICAgICBiaXRtYXNrICY9IH4oV1JBUF9QQVJUSUFMX0ZMQUcgfCBXUkFQX1BBUlRJQUxfUklHSFRfRkxBRyk7CiAgICAgICAgcGFydGlhbHMgPSBob2xkZXJzID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGFyeSA9IGFyeSA9PT0gdW5kZWZpbmVkID8gYXJ5IDogbmF0aXZlTWF4KHRvSW50ZWdlcihhcnkpLCAwKTsKICAgICAgYXJpdHkgPSBhcml0eSA9PT0gdW5kZWZpbmVkID8gYXJpdHkgOiB0b0ludGVnZXIoYXJpdHkpOwogICAgICBsZW5ndGggLT0gaG9sZGVycyA/IGhvbGRlcnMubGVuZ3RoIDogMDsKCiAgICAgIGlmIChiaXRtYXNrICYgV1JBUF9QQVJUSUFMX1JJR0hUX0ZMQUcpIHsKICAgICAgICB2YXIgcGFydGlhbHNSaWdodCA9IHBhcnRpYWxzLAogICAgICAgICAgICBob2xkZXJzUmlnaHQgPSBob2xkZXJzOwoKICAgICAgICBwYXJ0aWFscyA9IGhvbGRlcnMgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgdmFyIGRhdGEgPSBpc0JpbmRLZXkgPyB1bmRlZmluZWQgOiBnZXREYXRhKGZ1bmMpOwoKICAgICAgdmFyIG5ld0RhdGEgPSBbCiAgICAgICAgZnVuYywgYml0bWFzaywgdGhpc0FyZywgcGFydGlhbHMsIGhvbGRlcnMsIHBhcnRpYWxzUmlnaHQsIGhvbGRlcnNSaWdodCwKICAgICAgICBhcmdQb3MsIGFyeSwgYXJpdHkKICAgICAgXTsKCiAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgbWVyZ2VEYXRhKG5ld0RhdGEsIGRhdGEpOwogICAgICB9CiAgICAgIGZ1bmMgPSBuZXdEYXRhWzBdOwogICAgICBiaXRtYXNrID0gbmV3RGF0YVsxXTsKICAgICAgdGhpc0FyZyA9IG5ld0RhdGFbMl07CiAgICAgIHBhcnRpYWxzID0gbmV3RGF0YVszXTsKICAgICAgaG9sZGVycyA9IG5ld0RhdGFbNF07CiAgICAgIGFyaXR5ID0gbmV3RGF0YVs5XSA9IG5ld0RhdGFbOV0gPT09IHVuZGVmaW5lZAogICAgICAgID8gKGlzQmluZEtleSA/IDAgOiBmdW5jLmxlbmd0aCkKICAgICAgICA6IG5hdGl2ZU1heChuZXdEYXRhWzldIC0gbGVuZ3RoLCAwKTsKCiAgICAgIGlmICghYXJpdHkgJiYgYml0bWFzayAmIChXUkFQX0NVUlJZX0ZMQUcgfCBXUkFQX0NVUlJZX1JJR0hUX0ZMQUcpKSB7CiAgICAgICAgYml0bWFzayAmPSB+KFdSQVBfQ1VSUllfRkxBRyB8IFdSQVBfQ1VSUllfUklHSFRfRkxBRyk7CiAgICAgIH0KICAgICAgaWYgKCFiaXRtYXNrIHx8IGJpdG1hc2sgPT0gV1JBUF9CSU5EX0ZMQUcpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gY3JlYXRlQmluZChmdW5jLCBiaXRtYXNrLCB0aGlzQXJnKTsKICAgICAgfSBlbHNlIGlmIChiaXRtYXNrID09IFdSQVBfQ1VSUllfRkxBRyB8fCBiaXRtYXNrID09IFdSQVBfQ1VSUllfUklHSFRfRkxBRykgewogICAgICAgIHJlc3VsdCA9IGNyZWF0ZUN1cnJ5KGZ1bmMsIGJpdG1hc2ssIGFyaXR5KTsKICAgICAgfSBlbHNlIGlmICgoYml0bWFzayA9PSBXUkFQX1BBUlRJQUxfRkxBRyB8fCBiaXRtYXNrID09IChXUkFQX0JJTkRfRkxBRyB8IFdSQVBfUEFSVElBTF9GTEFHKSkgJiYgIWhvbGRlcnMubGVuZ3RoKSB7CiAgICAgICAgcmVzdWx0ID0gY3JlYXRlUGFydGlhbChmdW5jLCBiaXRtYXNrLCB0aGlzQXJnLCBwYXJ0aWFscyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0ID0gY3JlYXRlSHlicmlkLmFwcGx5KHVuZGVmaW5lZCwgbmV3RGF0YSk7CiAgICAgIH0KICAgICAgdmFyIHNldHRlciA9IGRhdGEgPyBiYXNlU2V0RGF0YSA6IHNldERhdGE7CiAgICAgIHJldHVybiBzZXRXcmFwVG9TdHJpbmcoc2V0dGVyKHJlc3VsdCwgbmV3RGF0YSksIGZ1bmMsIGJpdG1hc2spOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgXy5kZWZhdWx0c2AgdG8gY3VzdG9taXplIGl0cyBgXy5hc3NpZ25JbmAgdXNlIHRvIGFzc2lnbiBwcm9wZXJ0aWVzCiAgICAgKiBvZiBzb3VyY2Ugb2JqZWN0cyB0byB0aGUgZGVzdGluYXRpb24gb2JqZWN0IGZvciBhbGwgZGVzdGluYXRpb24gcHJvcGVydGllcwogICAgICogdGhhdCByZXNvbHZlIHRvIGB1bmRlZmluZWRgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IG9ialZhbHVlIFRoZSBkZXN0aW5hdGlvbiB2YWx1ZS4KICAgICAqIEBwYXJhbSB7Kn0gc3JjVmFsdWUgVGhlIHNvdXJjZSB2YWx1ZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgcHJvcGVydHkgdG8gYXNzaWduLgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgcGFyZW50IG9iamVjdCBvZiBgb2JqVmFsdWVgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHZhbHVlIHRvIGFzc2lnbi4KICAgICAqLwogICAgZnVuY3Rpb24gY3VzdG9tRGVmYXVsdHNBc3NpZ25JbihvYmpWYWx1ZSwgc3JjVmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgIGlmIChvYmpWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAoZXEob2JqVmFsdWUsIG9iamVjdFByb3RvW2tleV0pICYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkpIHsKICAgICAgICByZXR1cm4gc3JjVmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIG9ialZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgXy5kZWZhdWx0c0RlZXBgIHRvIGN1c3RvbWl6ZSBpdHMgYF8ubWVyZ2VgIHVzZSB0byBtZXJnZSBzb3VyY2UKICAgICAqIG9iamVjdHMgaW50byBkZXN0aW5hdGlvbiBvYmplY3RzIHRoYXQgYXJlIHBhc3NlZCB0aHJ1LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IG9ialZhbHVlIFRoZSBkZXN0aW5hdGlvbiB2YWx1ZS4KICAgICAqIEBwYXJhbSB7Kn0gc3JjVmFsdWUgVGhlIHNvdXJjZSB2YWx1ZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgcHJvcGVydHkgdG8gbWVyZ2UuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBwYXJlbnQgb2JqZWN0IG9mIGBvYmpWYWx1ZWAuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBwYXJlbnQgb2JqZWN0IG9mIGBzcmNWYWx1ZWAuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW3N0YWNrXSBUcmFja3MgdHJhdmVyc2VkIHNvdXJjZSB2YWx1ZXMgYW5kIHRoZWlyIG1lcmdlZAogICAgICogIGNvdW50ZXJwYXJ0cy4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSB2YWx1ZSB0byBhc3NpZ24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGN1c3RvbURlZmF1bHRzTWVyZ2Uob2JqVmFsdWUsIHNyY1ZhbHVlLCBrZXksIG9iamVjdCwgc291cmNlLCBzdGFjaykgewogICAgICBpZiAoaXNPYmplY3Qob2JqVmFsdWUpICYmIGlzT2JqZWN0KHNyY1ZhbHVlKSkgewogICAgICAgIC8vIFJlY3Vyc2l2ZWx5IG1lcmdlIG9iamVjdHMgYW5kIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpLgogICAgICAgIHN0YWNrLnNldChzcmNWYWx1ZSwgb2JqVmFsdWUpOwogICAgICAgIGJhc2VNZXJnZShvYmpWYWx1ZSwgc3JjVmFsdWUsIHVuZGVmaW5lZCwgY3VzdG9tRGVmYXVsdHNNZXJnZSwgc3RhY2spOwogICAgICAgIHN0YWNrWydkZWxldGUnXShzcmNWYWx1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9ialZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgXy5vbWl0YCB0byBjdXN0b21pemUgaXRzIGBfLmNsb25lRGVlcGAgdXNlIHRvIG9ubHkgY2xvbmUgcGxhaW4KICAgICAqIG9iamVjdHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHByb3BlcnR5IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgdW5jbG9uZWQgdmFsdWUgb3IgYHVuZGVmaW5lZGAgdG8gZGVmZXIgY2xvbmluZyB0byBgXy5jbG9uZURlZXBgLgogICAgICovCiAgICBmdW5jdGlvbiBjdXN0b21PbWl0Q2xvbmUodmFsdWUpIHsKICAgICAgcmV0dXJuIGlzUGxhaW5PYmplY3QodmFsdWUpID8gdW5kZWZpbmVkIDogdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYGJhc2VJc0VxdWFsRGVlcGAgZm9yIGFycmF5cyB3aXRoIHN1cHBvcnQgZm9yCiAgICAgKiBwYXJ0aWFsIGRlZXAgY29tcGFyaXNvbnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHtBcnJheX0gb3RoZXIgVGhlIG90aGVyIGFycmF5IHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYml0bWFzayBUaGUgYml0bWFzayBmbGFncy4gU2VlIGBiYXNlSXNFcXVhbGAgZm9yIG1vcmUgZGV0YWlscy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGN1c3RvbWl6ZXIgVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBjb21wYXJpc29ucy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVxdWFsRnVuYyBUaGUgZnVuY3Rpb24gdG8gZGV0ZXJtaW5lIGVxdWl2YWxlbnRzIG9mIHZhbHVlcy4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzdGFjayBUcmFja3MgdHJhdmVyc2VkIGBhcnJheWAgYW5kIGBvdGhlcmAgb2JqZWN0cy4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXJyYXlzIGFyZSBlcXVpdmFsZW50LCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVxdWFsQXJyYXlzKGFycmF5LCBvdGhlciwgYml0bWFzaywgY3VzdG9taXplciwgZXF1YWxGdW5jLCBzdGFjaykgewogICAgICB2YXIgaXNQYXJ0aWFsID0gYml0bWFzayAmIENPTVBBUkVfUEFSVElBTF9GTEFHLAogICAgICAgICAgYXJyTGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgICAgb3RoTGVuZ3RoID0gb3RoZXIubGVuZ3RoOwoKICAgICAgaWYgKGFyckxlbmd0aCAhPSBvdGhMZW5ndGggJiYgIShpc1BhcnRpYWwgJiYgb3RoTGVuZ3RoID4gYXJyTGVuZ3RoKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBBc3N1bWUgY3ljbGljIHZhbHVlcyBhcmUgZXF1YWwuCiAgICAgIHZhciBzdGFja2VkID0gc3RhY2suZ2V0KGFycmF5KTsKICAgICAgaWYgKHN0YWNrZWQgJiYgc3RhY2suZ2V0KG90aGVyKSkgewogICAgICAgIHJldHVybiBzdGFja2VkID09IG90aGVyOwogICAgICB9CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgcmVzdWx0ID0gdHJ1ZSwKICAgICAgICAgIHNlZW4gPSAoYml0bWFzayAmIENPTVBBUkVfVU5PUkRFUkVEX0ZMQUcpID8gbmV3IFNldENhY2hlIDogdW5kZWZpbmVkOwoKICAgICAgc3RhY2suc2V0KGFycmF5LCBvdGhlcik7CiAgICAgIHN0YWNrLnNldChvdGhlciwgYXJyYXkpOwoKICAgICAgLy8gSWdub3JlIG5vbi1pbmRleCBwcm9wZXJ0aWVzLgogICAgICB3aGlsZSAoKytpbmRleCA8IGFyckxlbmd0aCkgewogICAgICAgIHZhciBhcnJWYWx1ZSA9IGFycmF5W2luZGV4XSwKICAgICAgICAgICAgb3RoVmFsdWUgPSBvdGhlcltpbmRleF07CgogICAgICAgIGlmIChjdXN0b21pemVyKSB7CiAgICAgICAgICB2YXIgY29tcGFyZWQgPSBpc1BhcnRpYWwKICAgICAgICAgICAgPyBjdXN0b21pemVyKG90aFZhbHVlLCBhcnJWYWx1ZSwgaW5kZXgsIG90aGVyLCBhcnJheSwgc3RhY2spCiAgICAgICAgICAgIDogY3VzdG9taXplcihhcnJWYWx1ZSwgb3RoVmFsdWUsIGluZGV4LCBhcnJheSwgb3RoZXIsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbXBhcmVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGlmIChjb21wYXJlZCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdCA9IGZhbHNlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgYXJyYXlzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykuCiAgICAgICAgaWYgKHNlZW4pIHsKICAgICAgICAgIGlmICghYXJyYXlTb21lKG90aGVyLCBmdW5jdGlvbihvdGhWYWx1ZSwgb3RoSW5kZXgpIHsKICAgICAgICAgICAgICAgIGlmICghY2FjaGVIYXMoc2Vlbiwgb3RoSW5kZXgpICYmCiAgICAgICAgICAgICAgICAgICAgKGFyclZhbHVlID09PSBvdGhWYWx1ZSB8fCBlcXVhbEZ1bmMoYXJyVmFsdWUsIG90aFZhbHVlLCBiaXRtYXNrLCBjdXN0b21pemVyLCBzdGFjaykpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzZWVuLnB1c2gob3RoSW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCEoCiAgICAgICAgICAgICAgYXJyVmFsdWUgPT09IG90aFZhbHVlIHx8CiAgICAgICAgICAgICAgICBlcXVhbEZ1bmMoYXJyVmFsdWUsIG90aFZhbHVlLCBiaXRtYXNrLCBjdXN0b21pemVyLCBzdGFjaykKICAgICAgICAgICAgKSkgewogICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgc3RhY2tbJ2RlbGV0ZSddKGFycmF5KTsKICAgICAgc3RhY2tbJ2RlbGV0ZSddKG90aGVyKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgYmFzZUlzRXF1YWxEZWVwYCBmb3IgY29tcGFyaW5nIG9iamVjdHMgb2YKICAgICAqIHRoZSBzYW1lIGB0b1N0cmluZ1RhZ2AuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgZnVuY3Rpb24gb25seSBzdXBwb3J0cyBjb21wYXJpbmcgdmFsdWVzIHdpdGggdGFncyBvZgogICAgICogYEJvb2xlYW5gLCBgRGF0ZWAsIGBFcnJvcmAsIGBOdW1iZXJgLCBgUmVnRXhwYCwgb3IgYFN0cmluZ2AuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHtPYmplY3R9IG90aGVyIFRoZSBvdGhlciBvYmplY3QgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YWcgVGhlIGB0b1N0cmluZ1RhZ2Agb2YgdGhlIG9iamVjdHMgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBiaXRtYXNrIFRoZSBiaXRtYXNrIGZsYWdzLiBTZWUgYGJhc2VJc0VxdWFsYCBmb3IgbW9yZSBkZXRhaWxzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY3VzdG9taXplciBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmlzb25zLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXF1YWxGdW5jIFRoZSBmdW5jdGlvbiB0byBkZXRlcm1pbmUgZXF1aXZhbGVudHMgb2YgdmFsdWVzLgogICAgICogQHBhcmFtIHtPYmplY3R9IHN0YWNrIFRyYWNrcyB0cmF2ZXJzZWQgYG9iamVjdGAgYW5kIGBvdGhlcmAgb2JqZWN0cy4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgb2JqZWN0cyBhcmUgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbEJ5VGFnKG9iamVjdCwgb3RoZXIsIHRhZywgYml0bWFzaywgY3VzdG9taXplciwgZXF1YWxGdW5jLCBzdGFjaykgewogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgZGF0YVZpZXdUYWc6CiAgICAgICAgICBpZiAoKG9iamVjdC5ieXRlTGVuZ3RoICE9IG90aGVyLmJ5dGVMZW5ndGgpIHx8CiAgICAgICAgICAgICAgKG9iamVjdC5ieXRlT2Zmc2V0ICE9IG90aGVyLmJ5dGVPZmZzZXQpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIG9iamVjdCA9IG9iamVjdC5idWZmZXI7CiAgICAgICAgICBvdGhlciA9IG90aGVyLmJ1ZmZlcjsKCiAgICAgICAgY2FzZSBhcnJheUJ1ZmZlclRhZzoKICAgICAgICAgIGlmICgob2JqZWN0LmJ5dGVMZW5ndGggIT0gb3RoZXIuYnl0ZUxlbmd0aCkgfHwKICAgICAgICAgICAgICAhZXF1YWxGdW5jKG5ldyBVaW50OEFycmF5KG9iamVjdCksIG5ldyBVaW50OEFycmF5KG90aGVyKSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAgIGNhc2UgYm9vbFRhZzoKICAgICAgICBjYXNlIGRhdGVUYWc6CiAgICAgICAgY2FzZSBudW1iZXJUYWc6CiAgICAgICAgICAvLyBDb2VyY2UgYm9vbGVhbnMgdG8gYDFgIG9yIGAwYCBhbmQgZGF0ZXMgdG8gbWlsbGlzZWNvbmRzLgogICAgICAgICAgLy8gSW52YWxpZCBkYXRlcyBhcmUgY29lcmNlZCB0byBgTmFOYC4KICAgICAgICAgIHJldHVybiBlcSgrb2JqZWN0LCArb3RoZXIpOwoKICAgICAgICBjYXNlIGVycm9yVGFnOgogICAgICAgICAgcmV0dXJuIG9iamVjdC5uYW1lID09IG90aGVyLm5hbWUgJiYgb2JqZWN0Lm1lc3NhZ2UgPT0gb3RoZXIubWVzc2FnZTsKCiAgICAgICAgY2FzZSByZWdleHBUYWc6CiAgICAgICAgY2FzZSBzdHJpbmdUYWc6CiAgICAgICAgICAvLyBDb2VyY2UgcmVnZXhlcyB0byBzdHJpbmdzIGFuZCB0cmVhdCBzdHJpbmdzLCBwcmltaXRpdmVzIGFuZCBvYmplY3RzLAogICAgICAgICAgLy8gYXMgZXF1YWwuIFNlZSBodHRwOi8vd3d3LmVjbWEtaW50ZXJuYXRpb25hbC5vcmcvZWNtYS0yNjIvNy4wLyNzZWMtcmVnZXhwLnByb3RvdHlwZS50b3N0cmluZwogICAgICAgICAgLy8gZm9yIG1vcmUgZGV0YWlscy4KICAgICAgICAgIHJldHVybiBvYmplY3QgPT0gKG90aGVyICsgJycpOwoKICAgICAgICBjYXNlIG1hcFRhZzoKICAgICAgICAgIHZhciBjb252ZXJ0ID0gbWFwVG9BcnJheTsKCiAgICAgICAgY2FzZSBzZXRUYWc6CiAgICAgICAgICB2YXIgaXNQYXJ0aWFsID0gYml0bWFzayAmIENPTVBBUkVfUEFSVElBTF9GTEFHOwogICAgICAgICAgY29udmVydCB8fCAoY29udmVydCA9IHNldFRvQXJyYXkpOwoKICAgICAgICAgIGlmIChvYmplY3Quc2l6ZSAhPSBvdGhlci5zaXplICYmICFpc1BhcnRpYWwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgLy8gQXNzdW1lIGN5Y2xpYyB2YWx1ZXMgYXJlIGVxdWFsLgogICAgICAgICAgdmFyIHN0YWNrZWQgPSBzdGFjay5nZXQob2JqZWN0KTsKICAgICAgICAgIGlmIChzdGFja2VkKSB7CiAgICAgICAgICAgIHJldHVybiBzdGFja2VkID09IG90aGVyOwogICAgICAgICAgfQogICAgICAgICAgYml0bWFzayB8PSBDT01QQVJFX1VOT1JERVJFRF9GTEFHOwoKICAgICAgICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpLgogICAgICAgICAgc3RhY2suc2V0KG9iamVjdCwgb3RoZXIpOwogICAgICAgICAgdmFyIHJlc3VsdCA9IGVxdWFsQXJyYXlzKGNvbnZlcnQob2JqZWN0KSwgY29udmVydChvdGhlciksIGJpdG1hc2ssIGN1c3RvbWl6ZXIsIGVxdWFsRnVuYywgc3RhY2spOwogICAgICAgICAgc3RhY2tbJ2RlbGV0ZSddKG9iamVjdCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgICAgICBjYXNlIHN5bWJvbFRhZzoKICAgICAgICAgIGlmIChzeW1ib2xWYWx1ZU9mKSB7CiAgICAgICAgICAgIHJldHVybiBzeW1ib2xWYWx1ZU9mLmNhbGwob2JqZWN0KSA9PSBzeW1ib2xWYWx1ZU9mLmNhbGwob3RoZXIpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgYmFzZUlzRXF1YWxEZWVwYCBmb3Igb2JqZWN0cyB3aXRoIHN1cHBvcnQgZm9yCiAgICAgKiBwYXJ0aWFsIGRlZXAgY29tcGFyaXNvbnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHtPYmplY3R9IG90aGVyIFRoZSBvdGhlciBvYmplY3QgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBiaXRtYXNrIFRoZSBiaXRtYXNrIGZsYWdzLiBTZWUgYGJhc2VJc0VxdWFsYCBmb3IgbW9yZSBkZXRhaWxzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY3VzdG9taXplciBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmlzb25zLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXF1YWxGdW5jIFRoZSBmdW5jdGlvbiB0byBkZXRlcm1pbmUgZXF1aXZhbGVudHMgb2YgdmFsdWVzLgogICAgICogQHBhcmFtIHtPYmplY3R9IHN0YWNrIFRyYWNrcyB0cmF2ZXJzZWQgYG9iamVjdGAgYW5kIGBvdGhlcmAgb2JqZWN0cy4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgb2JqZWN0cyBhcmUgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbE9iamVjdHMob2JqZWN0LCBvdGhlciwgYml0bWFzaywgY3VzdG9taXplciwgZXF1YWxGdW5jLCBzdGFjaykgewogICAgICB2YXIgaXNQYXJ0aWFsID0gYml0bWFzayAmIENPTVBBUkVfUEFSVElBTF9GTEFHLAogICAgICAgICAgb2JqUHJvcHMgPSBnZXRBbGxLZXlzKG9iamVjdCksCiAgICAgICAgICBvYmpMZW5ndGggPSBvYmpQcm9wcy5sZW5ndGgsCiAgICAgICAgICBvdGhQcm9wcyA9IGdldEFsbEtleXMob3RoZXIpLAogICAgICAgICAgb3RoTGVuZ3RoID0gb3RoUHJvcHMubGVuZ3RoOwoKICAgICAgaWYgKG9iakxlbmd0aCAhPSBvdGhMZW5ndGggJiYgIWlzUGFydGlhbCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB2YXIgaW5kZXggPSBvYmpMZW5ndGg7CiAgICAgIHdoaWxlIChpbmRleC0tKSB7CiAgICAgICAgdmFyIGtleSA9IG9ialByb3BzW2luZGV4XTsKICAgICAgICBpZiAoIShpc1BhcnRpYWwgPyBrZXkgaW4gb3RoZXIgOiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG90aGVyLCBrZXkpKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBBc3N1bWUgY3ljbGljIHZhbHVlcyBhcmUgZXF1YWwuCiAgICAgIHZhciBzdGFja2VkID0gc3RhY2suZ2V0KG9iamVjdCk7CiAgICAgIGlmIChzdGFja2VkICYmIHN0YWNrLmdldChvdGhlcikpIHsKICAgICAgICByZXR1cm4gc3RhY2tlZCA9PSBvdGhlcjsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgICAgc3RhY2suc2V0KG9iamVjdCwgb3RoZXIpOwogICAgICBzdGFjay5zZXQob3RoZXIsIG9iamVjdCk7CgogICAgICB2YXIgc2tpcEN0b3IgPSBpc1BhcnRpYWw7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgb2JqTGVuZ3RoKSB7CiAgICAgICAga2V5ID0gb2JqUHJvcHNbaW5kZXhdOwogICAgICAgIHZhciBvYmpWYWx1ZSA9IG9iamVjdFtrZXldLAogICAgICAgICAgICBvdGhWYWx1ZSA9IG90aGVyW2tleV07CgogICAgICAgIGlmIChjdXN0b21pemVyKSB7CiAgICAgICAgICB2YXIgY29tcGFyZWQgPSBpc1BhcnRpYWwKICAgICAgICAgICAgPyBjdXN0b21pemVyKG90aFZhbHVlLCBvYmpWYWx1ZSwga2V5LCBvdGhlciwgb2JqZWN0LCBzdGFjaykKICAgICAgICAgICAgOiBjdXN0b21pemVyKG9ialZhbHVlLCBvdGhWYWx1ZSwga2V5LCBvYmplY3QsIG90aGVyLCBzdGFjayk7CiAgICAgICAgfQogICAgICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpLgogICAgICAgIGlmICghKGNvbXBhcmVkID09PSB1bmRlZmluZWQKICAgICAgICAgICAgICA/IChvYmpWYWx1ZSA9PT0gb3RoVmFsdWUgfHwgZXF1YWxGdW5jKG9ialZhbHVlLCBvdGhWYWx1ZSwgYml0bWFzaywgY3VzdG9taXplciwgc3RhY2spKQogICAgICAgICAgICAgIDogY29tcGFyZWQKICAgICAgICAgICAgKSkgewogICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgc2tpcEN0b3IgfHwgKHNraXBDdG9yID0ga2V5ID09ICdjb25zdHJ1Y3RvcicpOwogICAgICB9CiAgICAgIGlmIChyZXN1bHQgJiYgIXNraXBDdG9yKSB7CiAgICAgICAgdmFyIG9iakN0b3IgPSBvYmplY3QuY29uc3RydWN0b3IsCiAgICAgICAgICAgIG90aEN0b3IgPSBvdGhlci5jb25zdHJ1Y3RvcjsKCiAgICAgICAgLy8gTm9uIGBPYmplY3RgIG9iamVjdCBpbnN0YW5jZXMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1YWwuCiAgICAgICAgaWYgKG9iakN0b3IgIT0gb3RoQ3RvciAmJgogICAgICAgICAgICAoJ2NvbnN0cnVjdG9yJyBpbiBvYmplY3QgJiYgJ2NvbnN0cnVjdG9yJyBpbiBvdGhlcikgJiYKICAgICAgICAgICAgISh0eXBlb2Ygb2JqQ3RvciA9PSAnZnVuY3Rpb24nICYmIG9iakN0b3IgaW5zdGFuY2VvZiBvYmpDdG9yICYmCiAgICAgICAgICAgICAgdHlwZW9mIG90aEN0b3IgPT0gJ2Z1bmN0aW9uJyAmJiBvdGhDdG9yIGluc3RhbmNlb2Ygb3RoQ3RvcikpIHsKICAgICAgICAgIHJlc3VsdCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICBzdGFja1snZGVsZXRlJ10ob2JqZWN0KTsKICAgICAgc3RhY2tbJ2RlbGV0ZSddKG90aGVyKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgYmFzZVJlc3RgIHdoaWNoIGZsYXR0ZW5zIHRoZSByZXN0IGFycmF5LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBhcHBseSBhIHJlc3QgcGFyYW1ldGVyIHRvLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZsYXRSZXN0KGZ1bmMpIHsKICAgICAgcmV0dXJuIHNldFRvU3RyaW5nKG92ZXJSZXN0KGZ1bmMsIHVuZGVmaW5lZCwgZmxhdHRlbiksIGZ1bmMgKyAnJyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzIGFuZCBzeW1ib2xzIG9mIGBvYmplY3RgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGFycmF5IG9mIHByb3BlcnR5IG5hbWVzIGFuZCBzeW1ib2xzLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRBbGxLZXlzKG9iamVjdCkgewogICAgICByZXR1cm4gYmFzZUdldEFsbEtleXMob2JqZWN0LCBrZXlzLCBnZXRTeW1ib2xzKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2Ygb3duIGFuZCBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0eSBuYW1lcyBhbmQKICAgICAqIHN5bWJvbHMgb2YgYG9iamVjdGAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgYW5kIHN5bWJvbHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldEFsbEtleXNJbihvYmplY3QpIHsKICAgICAgcmV0dXJuIGJhc2VHZXRBbGxLZXlzKG9iamVjdCwga2V5c0luLCBnZXRTeW1ib2xzSW4pOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBtZXRhZGF0YSBmb3IgYGZ1bmNgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBtZXRhZGF0YSBmb3IgYGZ1bmNgLgogICAgICovCiAgICB2YXIgZ2V0RGF0YSA9ICFtZXRhTWFwID8gbm9vcCA6IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgcmV0dXJuIG1ldGFNYXAuZ2V0KGZ1bmMpOwogICAgfTsKCiAgICAvKioKICAgICAqIEdldHMgdGhlIG5hbWUgb2YgYGZ1bmNgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGZ1bmN0aW9uIG5hbWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldEZ1bmNOYW1lKGZ1bmMpIHsKICAgICAgdmFyIHJlc3VsdCA9IChmdW5jLm5hbWUgKyAnJyksCiAgICAgICAgICBhcnJheSA9IHJlYWxOYW1lc1tyZXN1bHRdLAogICAgICAgICAgbGVuZ3RoID0gaGFzT3duUHJvcGVydHkuY2FsbChyZWFsTmFtZXMsIHJlc3VsdCkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgdmFyIGRhdGEgPSBhcnJheVtsZW5ndGhdLAogICAgICAgICAgICBvdGhlckZ1bmMgPSBkYXRhLmZ1bmM7CiAgICAgICAgaWYgKG90aGVyRnVuYyA9PSBudWxsIHx8IG90aGVyRnVuYyA9PSBmdW5jKSB7CiAgICAgICAgICByZXR1cm4gZGF0YS5uYW1lOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgYXJndW1lbnQgcGxhY2Vob2xkZXIgdmFsdWUgZm9yIGBmdW5jYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBwbGFjZWhvbGRlciB2YWx1ZS4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0SG9sZGVyKGZ1bmMpIHsKICAgICAgdmFyIG9iamVjdCA9IGhhc093blByb3BlcnR5LmNhbGwobG9kYXNoLCAncGxhY2Vob2xkZXInKSA/IGxvZGFzaCA6IGZ1bmM7CiAgICAgIHJldHVybiBvYmplY3QucGxhY2Vob2xkZXI7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBhcHByb3ByaWF0ZSAiaXRlcmF0ZWUiIGZ1bmN0aW9uLiBJZiBgXy5pdGVyYXRlZWAgaXMgY3VzdG9taXplZCwKICAgICAqIHRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgY3VzdG9tIG1ldGhvZCwgb3RoZXJ3aXNlIGl0IHJldHVybnMgYGJhc2VJdGVyYXRlZWAuCiAgICAgKiBJZiBhcmd1bWVudHMgYXJlIHByb3ZpZGVkLCB0aGUgY2hvc2VuIGZ1bmN0aW9uIGlzIGludm9rZWQgd2l0aCB0aGVtIGFuZAogICAgICogaXRzIHJlc3VsdCBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSBbdmFsdWVdIFRoZSB2YWx1ZSB0byBjb252ZXJ0IHRvIGFuIGl0ZXJhdGVlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFthcml0eV0gVGhlIGFyaXR5IG9mIHRoZSBjcmVhdGVkIGl0ZXJhdGVlLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBjaG9zZW4gZnVuY3Rpb24gb3IgaXRzIHJlc3VsdC4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0SXRlcmF0ZWUoKSB7CiAgICAgIHZhciByZXN1bHQgPSBsb2Rhc2guaXRlcmF0ZWUgfHwgaXRlcmF0ZWU7CiAgICAgIHJlc3VsdCA9IHJlc3VsdCA9PT0gaXRlcmF0ZWUgPyBiYXNlSXRlcmF0ZWUgOiByZXN1bHQ7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gcmVzdWx0KGFyZ3VtZW50c1swXSwgYXJndW1lbnRzWzFdKSA6IHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGRhdGEgZm9yIGBtYXBgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbWFwIFRoZSBtYXAgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSByZWZlcmVuY2Uga2V5LgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG1hcCBkYXRhLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRNYXBEYXRhKG1hcCwga2V5KSB7CiAgICAgIHZhciBkYXRhID0gbWFwLl9fZGF0YV9fOwogICAgICByZXR1cm4gaXNLZXlhYmxlKGtleSkKICAgICAgICA/IGRhdGFbdHlwZW9mIGtleSA9PSAnc3RyaW5nJyA/ICdzdHJpbmcnIDogJ2hhc2gnXQogICAgICAgIDogZGF0YS5tYXA7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBwcm9wZXJ0eSBuYW1lcywgdmFsdWVzLCBhbmQgY29tcGFyZSBmbGFncyBvZiBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHF1ZXJ5LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBtYXRjaCBkYXRhIG9mIGBvYmplY3RgLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRNYXRjaERhdGEob2JqZWN0KSB7CiAgICAgIHZhciByZXN1bHQgPSBrZXlzKG9iamVjdCksCiAgICAgICAgICBsZW5ndGggPSByZXN1bHQubGVuZ3RoOwoKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgdmFyIGtleSA9IHJlc3VsdFtsZW5ndGhdLAogICAgICAgICAgICB2YWx1ZSA9IG9iamVjdFtrZXldOwoKICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IFtrZXksIHZhbHVlLCBpc1N0cmljdENvbXBhcmFibGUodmFsdWUpXTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgbmF0aXZlIGZ1bmN0aW9uIGF0IGBrZXlgIG9mIGBvYmplY3RgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIG1ldGhvZCB0byBnZXQuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZnVuY3Rpb24gaWYgaXQncyBuYXRpdmUsIGVsc2UgYHVuZGVmaW5lZGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldE5hdGl2ZShvYmplY3QsIGtleSkgewogICAgICB2YXIgdmFsdWUgPSBnZXRWYWx1ZShvYmplY3QsIGtleSk7CiAgICAgIHJldHVybiBiYXNlSXNOYXRpdmUodmFsdWUpID8gdmFsdWUgOiB1bmRlZmluZWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYGJhc2VHZXRUYWdgIHdoaWNoIGlnbm9yZXMgYFN5bWJvbC50b1N0cmluZ1RhZ2AgdmFsdWVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHJhdyBgdG9TdHJpbmdUYWdgLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRSYXdUYWcodmFsdWUpIHsKICAgICAgdmFyIGlzT3duID0gaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgc3ltVG9TdHJpbmdUYWcpLAogICAgICAgICAgdGFnID0gdmFsdWVbc3ltVG9TdHJpbmdUYWddOwoKICAgICAgdHJ5IHsKICAgICAgICB2YWx1ZVtzeW1Ub1N0cmluZ1RhZ10gPSB1bmRlZmluZWQ7CiAgICAgICAgdmFyIHVubWFza2VkID0gdHJ1ZTsKICAgICAgfSBjYXRjaCAoZSkge30KCiAgICAgIHZhciByZXN1bHQgPSBuYXRpdmVPYmplY3RUb1N0cmluZy5jYWxsKHZhbHVlKTsKICAgICAgaWYgKHVubWFza2VkKSB7CiAgICAgICAgaWYgKGlzT3duKSB7CiAgICAgICAgICB2YWx1ZVtzeW1Ub1N0cmluZ1RhZ10gPSB0YWc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB2YWx1ZVtzeW1Ub1N0cmluZ1RhZ107CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHRoZSBvd24gZW51bWVyYWJsZSBzeW1ib2xzIG9mIGBvYmplY3RgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGFycmF5IG9mIHN5bWJvbHMuCiAgICAgKi8KICAgIHZhciBnZXRTeW1ib2xzID0gIW5hdGl2ZUdldFN5bWJvbHMgPyBzdHViQXJyYXkgOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgaWYgKG9iamVjdCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIG9iamVjdCA9IE9iamVjdChvYmplY3QpOwogICAgICByZXR1cm4gYXJyYXlGaWx0ZXIobmF0aXZlR2V0U3ltYm9scyhvYmplY3QpLCBmdW5jdGlvbihzeW1ib2wpIHsKICAgICAgICByZXR1cm4gcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChvYmplY3QsIHN5bWJvbCk7CiAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdGhlIG93biBhbmQgaW5oZXJpdGVkIGVudW1lcmFibGUgc3ltYm9scyBvZiBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHF1ZXJ5LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBhcnJheSBvZiBzeW1ib2xzLgogICAgICovCiAgICB2YXIgZ2V0U3ltYm9sc0luID0gIW5hdGl2ZUdldFN5bWJvbHMgPyBzdHViQXJyYXkgOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB3aGlsZSAob2JqZWN0KSB7CiAgICAgICAgYXJyYXlQdXNoKHJlc3VsdCwgZ2V0U3ltYm9scyhvYmplY3QpKTsKICAgICAgICBvYmplY3QgPSBnZXRQcm90b3R5cGUob2JqZWN0KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKCiAgICAvKioKICAgICAqIEdldHMgdGhlIGB0b1N0cmluZ1RhZ2Agb2YgYHZhbHVlYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcXVlcnkuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBgdG9TdHJpbmdUYWdgLgogICAgICovCiAgICB2YXIgZ2V0VGFnID0gYmFzZUdldFRhZzsKCiAgICAvLyBGYWxsYmFjayBmb3IgZGF0YSB2aWV3cywgbWFwcywgc2V0cywgYW5kIHdlYWsgbWFwcyBpbiBJRSAxMSBhbmQgcHJvbWlzZXMgaW4gTm9kZS5qcyA8IDYuCiAgICBpZiAoKERhdGFWaWV3ICYmIGdldFRhZyhuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKDEpKSkgIT0gZGF0YVZpZXdUYWcpIHx8CiAgICAgICAgKE1hcCAmJiBnZXRUYWcobmV3IE1hcCkgIT0gbWFwVGFnKSB8fAogICAgICAgIChQcm9taXNlICYmIGdldFRhZyhQcm9taXNlLnJlc29sdmUoKSkgIT0gcHJvbWlzZVRhZykgfHwKICAgICAgICAoU2V0ICYmIGdldFRhZyhuZXcgU2V0KSAhPSBzZXRUYWcpIHx8CiAgICAgICAgKFdlYWtNYXAgJiYgZ2V0VGFnKG5ldyBXZWFrTWFwKSAhPSB3ZWFrTWFwVGFnKSkgewogICAgICBnZXRUYWcgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciByZXN1bHQgPSBiYXNlR2V0VGFnKHZhbHVlKSwKICAgICAgICAgICAgQ3RvciA9IHJlc3VsdCA9PSBvYmplY3RUYWcgPyB2YWx1ZS5jb25zdHJ1Y3RvciA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgY3RvclN0cmluZyA9IEN0b3IgPyB0b1NvdXJjZShDdG9yKSA6ICcnOwoKICAgICAgICBpZiAoY3RvclN0cmluZykgewogICAgICAgICAgc3dpdGNoIChjdG9yU3RyaW5nKSB7CiAgICAgICAgICAgIGNhc2UgZGF0YVZpZXdDdG9yU3RyaW5nOiByZXR1cm4gZGF0YVZpZXdUYWc7CiAgICAgICAgICAgIGNhc2UgbWFwQ3RvclN0cmluZzogcmV0dXJuIG1hcFRhZzsKICAgICAgICAgICAgY2FzZSBwcm9taXNlQ3RvclN0cmluZzogcmV0dXJuIHByb21pc2VUYWc7CiAgICAgICAgICAgIGNhc2Ugc2V0Q3RvclN0cmluZzogcmV0dXJuIHNldFRhZzsKICAgICAgICAgICAgY2FzZSB3ZWFrTWFwQ3RvclN0cmluZzogcmV0dXJuIHdlYWtNYXBUYWc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSB2aWV3LCBhcHBseWluZyBhbnkgYHRyYW5zZm9ybXNgIHRvIHRoZSBgc3RhcnRgIGFuZCBgZW5kYCBwb3NpdGlvbnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCBUaGUgc3RhcnQgb2YgdGhlIHZpZXcuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZW5kIFRoZSBlbmQgb2YgdGhlIHZpZXcuCiAgICAgKiBAcGFyYW0ge0FycmF5fSB0cmFuc2Zvcm1zIFRoZSB0cmFuc2Zvcm1hdGlvbnMgdG8gYXBwbHkgdG8gdGhlIHZpZXcuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgc3RhcnRgIGFuZCBgZW5kYAogICAgICogIHBvc2l0aW9ucyBvZiB0aGUgdmlldy4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0VmlldyhzdGFydCwgZW5kLCB0cmFuc2Zvcm1zKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gdHJhbnNmb3Jtcy5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBkYXRhID0gdHJhbnNmb3Jtc1tpbmRleF0sCiAgICAgICAgICAgIHNpemUgPSBkYXRhLnNpemU7CgogICAgICAgIHN3aXRjaCAoZGF0YS50eXBlKSB7CiAgICAgICAgICBjYXNlICdkcm9wJzogICAgICBzdGFydCArPSBzaXplOyBicmVhazsKICAgICAgICAgIGNhc2UgJ2Ryb3BSaWdodCc6IGVuZCAtPSBzaXplOyBicmVhazsKICAgICAgICAgIGNhc2UgJ3Rha2UnOiAgICAgIGVuZCA9IG5hdGl2ZU1pbihlbmQsIHN0YXJ0ICsgc2l6ZSk7IGJyZWFrOwogICAgICAgICAgY2FzZSAndGFrZVJpZ2h0Jzogc3RhcnQgPSBuYXRpdmVNYXgoc3RhcnQsIGVuZCAtIHNpemUpOyBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsgJ3N0YXJ0Jzogc3RhcnQsICdlbmQnOiBlbmQgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEV4dHJhY3RzIHdyYXBwZXIgZGV0YWlscyBmcm9tIHRoZSBgc291cmNlYCBib2R5IGNvbW1lbnQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzb3VyY2UgVGhlIHNvdXJjZSB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSB3cmFwcGVyIGRldGFpbHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldFdyYXBEZXRhaWxzKHNvdXJjZSkgewogICAgICB2YXIgbWF0Y2ggPSBzb3VyY2UubWF0Y2gocmVXcmFwRGV0YWlscyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdLnNwbGl0KHJlU3BsaXREZXRhaWxzKSA6IFtdOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGBwYXRoYCBleGlzdHMgb24gYG9iamVjdGAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBwYXRoIFRoZSBwYXRoIHRvIGNoZWNrLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaGFzRnVuYyBUaGUgZnVuY3Rpb24gdG8gY2hlY2sgcHJvcGVydGllcy4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgcGF0aGAgZXhpc3RzLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhhc1BhdGgob2JqZWN0LCBwYXRoLCBoYXNGdW5jKSB7CiAgICAgIHBhdGggPSBjYXN0UGF0aChwYXRoLCBvYmplY3QpOwoKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBwYXRoLmxlbmd0aCwKICAgICAgICAgIHJlc3VsdCA9IGZhbHNlOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIga2V5ID0gdG9LZXkocGF0aFtpbmRleF0pOwogICAgICAgIGlmICghKHJlc3VsdCA9IG9iamVjdCAhPSBudWxsICYmIGhhc0Z1bmMob2JqZWN0LCBrZXkpKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIG9iamVjdCA9IG9iamVjdFtrZXldOwogICAgICB9CiAgICAgIGlmIChyZXN1bHQgfHwgKytpbmRleCAhPSBsZW5ndGgpIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGxlbmd0aCA9IG9iamVjdCA9PSBudWxsID8gMCA6IG9iamVjdC5sZW5ndGg7CiAgICAgIHJldHVybiAhIWxlbmd0aCAmJiBpc0xlbmd0aChsZW5ndGgpICYmIGlzSW5kZXgoa2V5LCBsZW5ndGgpICYmCiAgICAgICAgKGlzQXJyYXkob2JqZWN0KSB8fCBpc0FyZ3VtZW50cyhvYmplY3QpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEluaXRpYWxpemVzIGFuIGFycmF5IGNsb25lLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY2xvbmUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGluaXRpYWxpemVkIGNsb25lLgogICAgICovCiAgICBmdW5jdGlvbiBpbml0Q2xvbmVBcnJheShhcnJheSkgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0gbmV3IGFycmF5LmNvbnN0cnVjdG9yKGxlbmd0aCk7CgogICAgICAvLyBBZGQgcHJvcGVydGllcyBhc3NpZ25lZCBieSBgUmVnRXhwI2V4ZWNgLgogICAgICBpZiAobGVuZ3RoICYmIHR5cGVvZiBhcnJheVswXSA9PSAnc3RyaW5nJyAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGFycmF5LCAnaW5kZXgnKSkgewogICAgICAgIHJlc3VsdC5pbmRleCA9IGFycmF5LmluZGV4OwogICAgICAgIHJlc3VsdC5pbnB1dCA9IGFycmF5LmlucHV0OwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbml0aWFsaXplcyBhbiBvYmplY3QgY2xvbmUuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBjbG9uZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGluaXRpYWxpemVkIGNsb25lLgogICAgICovCiAgICBmdW5jdGlvbiBpbml0Q2xvbmVPYmplY3Qob2JqZWN0KSB7CiAgICAgIHJldHVybiAodHlwZW9mIG9iamVjdC5jb25zdHJ1Y3RvciA9PSAnZnVuY3Rpb24nICYmICFpc1Byb3RvdHlwZShvYmplY3QpKQogICAgICAgID8gYmFzZUNyZWF0ZShnZXRQcm90b3R5cGUob2JqZWN0KSkKICAgICAgICA6IHt9OwogICAgfQoKICAgIC8qKgogICAgICogSW5pdGlhbGl6ZXMgYW4gb2JqZWN0IGNsb25lIGJhc2VkIG9uIGl0cyBgdG9TdHJpbmdUYWdgLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIGZ1bmN0aW9uIG9ubHkgc3VwcG9ydHMgY2xvbmluZyB2YWx1ZXMgd2l0aCB0YWdzIG9mCiAgICAgKiBgQm9vbGVhbmAsIGBEYXRlYCwgYEVycm9yYCwgYE1hcGAsIGBOdW1iZXJgLCBgUmVnRXhwYCwgYFNldGAsIG9yIGBTdHJpbmdgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gY2xvbmUuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGFnIFRoZSBgdG9TdHJpbmdUYWdgIG9mIHRoZSBvYmplY3QgdG8gY2xvbmUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc0RlZXBdIFNwZWNpZnkgYSBkZWVwIGNsb25lLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgaW5pdGlhbGl6ZWQgY2xvbmUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluaXRDbG9uZUJ5VGFnKG9iamVjdCwgdGFnLCBpc0RlZXApIHsKICAgICAgdmFyIEN0b3IgPSBvYmplY3QuY29uc3RydWN0b3I7CiAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgY2FzZSBhcnJheUJ1ZmZlclRhZzoKICAgICAgICAgIHJldHVybiBjbG9uZUFycmF5QnVmZmVyKG9iamVjdCk7CgogICAgICAgIGNhc2UgYm9vbFRhZzoKICAgICAgICBjYXNlIGRhdGVUYWc6CiAgICAgICAgICByZXR1cm4gbmV3IEN0b3IoK29iamVjdCk7CgogICAgICAgIGNhc2UgZGF0YVZpZXdUYWc6CiAgICAgICAgICByZXR1cm4gY2xvbmVEYXRhVmlldyhvYmplY3QsIGlzRGVlcCk7CgogICAgICAgIGNhc2UgZmxvYXQzMlRhZzogY2FzZSBmbG9hdDY0VGFnOgogICAgICAgIGNhc2UgaW50OFRhZzogY2FzZSBpbnQxNlRhZzogY2FzZSBpbnQzMlRhZzoKICAgICAgICBjYXNlIHVpbnQ4VGFnOiBjYXNlIHVpbnQ4Q2xhbXBlZFRhZzogY2FzZSB1aW50MTZUYWc6IGNhc2UgdWludDMyVGFnOgogICAgICAgICAgcmV0dXJuIGNsb25lVHlwZWRBcnJheShvYmplY3QsIGlzRGVlcCk7CgogICAgICAgIGNhc2UgbWFwVGFnOgogICAgICAgICAgcmV0dXJuIG5ldyBDdG9yOwoKICAgICAgICBjYXNlIG51bWJlclRhZzoKICAgICAgICBjYXNlIHN0cmluZ1RhZzoKICAgICAgICAgIHJldHVybiBuZXcgQ3RvcihvYmplY3QpOwoKICAgICAgICBjYXNlIHJlZ2V4cFRhZzoKICAgICAgICAgIHJldHVybiBjbG9uZVJlZ0V4cChvYmplY3QpOwoKICAgICAgICBjYXNlIHNldFRhZzoKICAgICAgICAgIHJldHVybiBuZXcgQ3RvcjsKCiAgICAgICAgY2FzZSBzeW1ib2xUYWc6CiAgICAgICAgICByZXR1cm4gY2xvbmVTeW1ib2wob2JqZWN0KTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogSW5zZXJ0cyB3cmFwcGVyIGBkZXRhaWxzYCBpbiBhIGNvbW1lbnQgYXQgdGhlIHRvcCBvZiB0aGUgYHNvdXJjZWAgYm9keS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IHNvdXJjZSBUaGUgc291cmNlIHRvIG1vZGlmeS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gZGV0YWlscyBUaGUgZGV0YWlscyB0byBpbnNlcnQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBtb2RpZmllZCBzb3VyY2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluc2VydFdyYXBEZXRhaWxzKHNvdXJjZSwgZGV0YWlscykgewogICAgICB2YXIgbGVuZ3RoID0gZGV0YWlscy5sZW5ndGg7CiAgICAgIGlmICghbGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHNvdXJjZTsKICAgICAgfQogICAgICB2YXIgbGFzdEluZGV4ID0gbGVuZ3RoIC0gMTsKICAgICAgZGV0YWlsc1tsYXN0SW5kZXhdID0gKGxlbmd0aCA+IDEgPyAnJiAnIDogJycpICsgZGV0YWlsc1tsYXN0SW5kZXhdOwogICAgICBkZXRhaWxzID0gZGV0YWlscy5qb2luKGxlbmd0aCA+IDIgPyAnLCAnIDogJyAnKTsKICAgICAgcmV0dXJuIHNvdXJjZS5yZXBsYWNlKHJlV3JhcENvbW1lbnQsICd7XG4vKiBbd3JhcHBlZCB3aXRoICcgKyBkZXRhaWxzICsgJ10gKi9cbicpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBmbGF0dGVuYWJsZSBgYXJndW1lbnRzYCBvYmplY3Qgb3IgYXJyYXkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgZmxhdHRlbmFibGUsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNGbGF0dGVuYWJsZSh2YWx1ZSkgewogICAgICByZXR1cm4gaXNBcnJheSh2YWx1ZSkgfHwgaXNBcmd1bWVudHModmFsdWUpIHx8CiAgICAgICAgISEoc3ByZWFkYWJsZVN5bWJvbCAmJiB2YWx1ZSAmJiB2YWx1ZVtzcHJlYWRhYmxlU3ltYm9sXSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIHZhbGlkIGFycmF5LWxpa2UgaW5kZXguCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtsZW5ndGg9TUFYX1NBRkVfSU5URUdFUl0gVGhlIHVwcGVyIGJvdW5kcyBvZiBhIHZhbGlkIGluZGV4LgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSB2YWxpZCBpbmRleCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBpc0luZGV4KHZhbHVlLCBsZW5ndGgpIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgICAgIGxlbmd0aCA9IGxlbmd0aCA9PSBudWxsID8gTUFYX1NBRkVfSU5URUdFUiA6IGxlbmd0aDsKCiAgICAgIHJldHVybiAhIWxlbmd0aCAmJgogICAgICAgICh0eXBlID09ICdudW1iZXInIHx8CiAgICAgICAgICAodHlwZSAhPSAnc3ltYm9sJyAmJiByZUlzVWludC50ZXN0KHZhbHVlKSkpICYmCiAgICAgICAgICAgICh2YWx1ZSA+IC0xICYmIHZhbHVlICUgMSA9PSAwICYmIHZhbHVlIDwgbGVuZ3RoKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gYXJndW1lbnRzIGFyZSBmcm9tIGFuIGl0ZXJhdGVlIGNhbGwuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHBvdGVudGlhbCBpdGVyYXRlZSB2YWx1ZSBhcmd1bWVudC4KICAgICAqIEBwYXJhbSB7Kn0gaW5kZXggVGhlIHBvdGVudGlhbCBpdGVyYXRlZSBpbmRleCBvciBrZXkgYXJndW1lbnQuCiAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBUaGUgcG90ZW50aWFsIGl0ZXJhdGVlIG9iamVjdCBhcmd1bWVudC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXJndW1lbnRzIGFyZSBmcm9tIGFuIGl0ZXJhdGVlIGNhbGwsCiAgICAgKiAgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBpc0l0ZXJhdGVlQ2FsbCh2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICBpZiAoIWlzT2JqZWN0KG9iamVjdCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgaW5kZXg7CiAgICAgIGlmICh0eXBlID09ICdudW1iZXInCiAgICAgICAgICAgID8gKGlzQXJyYXlMaWtlKG9iamVjdCkgJiYgaXNJbmRleChpbmRleCwgb2JqZWN0Lmxlbmd0aCkpCiAgICAgICAgICAgIDogKHR5cGUgPT0gJ3N0cmluZycgJiYgaW5kZXggaW4gb2JqZWN0KQogICAgICAgICAgKSB7CiAgICAgICAgcmV0dXJuIGVxKG9iamVjdFtpbmRleF0sIHZhbHVlKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIHByb3BlcnR5IG5hbWUgYW5kIG5vdCBhIHByb3BlcnR5IHBhdGguCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvYmplY3RdIFRoZSBvYmplY3QgdG8gcXVlcnkga2V5cyBvbi4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgcHJvcGVydHkgbmFtZSwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBpc0tleSh2YWx1ZSwgb2JqZWN0KSB7CiAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICAgICAgaWYgKHR5cGUgPT0gJ251bWJlcicgfHwgdHlwZSA9PSAnc3ltYm9sJyB8fCB0eXBlID09ICdib29sZWFuJyB8fAogICAgICAgICAgdmFsdWUgPT0gbnVsbCB8fCBpc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gcmVJc1BsYWluUHJvcC50ZXN0KHZhbHVlKSB8fCAhcmVJc0RlZXBQcm9wLnRlc3QodmFsdWUpIHx8CiAgICAgICAgKG9iamVjdCAhPSBudWxsICYmIHZhbHVlIGluIE9iamVjdChvYmplY3QpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIHN1aXRhYmxlIGZvciB1c2UgYXMgdW5pcXVlIG9iamVjdCBrZXkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgc3VpdGFibGUsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNLZXlhYmxlKHZhbHVlKSB7CiAgICAgIHZhciB0eXBlID0gdHlwZW9mIHZhbHVlOwogICAgICByZXR1cm4gKHR5cGUgPT0gJ3N0cmluZycgfHwgdHlwZSA9PSAnbnVtYmVyJyB8fCB0eXBlID09ICdzeW1ib2wnIHx8IHR5cGUgPT0gJ2Jvb2xlYW4nKQogICAgICAgID8gKHZhbHVlICE9PSAnX19wcm90b19fJykKICAgICAgICA6ICh2YWx1ZSA9PT0gbnVsbCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYGZ1bmNgIGhhcyBhIGxhenkgY291bnRlcnBhcnQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGBmdW5jYCBoYXMgYSBsYXp5IGNvdW50ZXJwYXJ0LAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNMYXppYWJsZShmdW5jKSB7CiAgICAgIHZhciBmdW5jTmFtZSA9IGdldEZ1bmNOYW1lKGZ1bmMpLAogICAgICAgICAgb3RoZXIgPSBsb2Rhc2hbZnVuY05hbWVdOwoKICAgICAgaWYgKHR5cGVvZiBvdGhlciAhPSAnZnVuY3Rpb24nIHx8ICEoZnVuY05hbWUgaW4gTGF6eVdyYXBwZXIucHJvdG90eXBlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoZnVuYyA9PT0gb3RoZXIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICB2YXIgZGF0YSA9IGdldERhdGEob3RoZXIpOwogICAgICByZXR1cm4gISFkYXRhICYmIGZ1bmMgPT09IGRhdGFbMF07CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYGZ1bmNgIGhhcyBpdHMgc291cmNlIG1hc2tlZC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYGZ1bmNgIGlzIG1hc2tlZCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBpc01hc2tlZChmdW5jKSB7CiAgICAgIHJldHVybiAhIW1hc2tTcmNLZXkgJiYgKG1hc2tTcmNLZXkgaW4gZnVuYyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYGZ1bmNgIGlzIGNhcGFibGUgb2YgYmVpbmcgbWFza2VkLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgZnVuY2AgaXMgbWFza2FibGUsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgdmFyIGlzTWFza2FibGUgPSBjb3JlSnNEYXRhID8gaXNGdW5jdGlvbiA6IHN0dWJGYWxzZTsKCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGxpa2VseSBhIHByb3RvdHlwZSBvYmplY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBwcm90b3R5cGUsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNQcm90b3R5cGUodmFsdWUpIHsKICAgICAgdmFyIEN0b3IgPSB2YWx1ZSAmJiB2YWx1ZS5jb25zdHJ1Y3RvciwKICAgICAgICAgIHByb3RvID0gKHR5cGVvZiBDdG9yID09ICdmdW5jdGlvbicgJiYgQ3Rvci5wcm90b3R5cGUpIHx8IG9iamVjdFByb3RvOwoKICAgICAgcmV0dXJuIHZhbHVlID09PSBwcm90bzsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIHN1aXRhYmxlIGZvciBzdHJpY3QgZXF1YWxpdHkgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaWYgc3VpdGFibGUgZm9yIHN0cmljdAogICAgICogIGVxdWFsaXR5IGNvbXBhcmlzb25zLCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3RyaWN0Q29tcGFyYWJsZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlICYmICFpc09iamVjdCh2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYG1hdGNoZXNQcm9wZXJ0eWAgZm9yIHNvdXJjZSB2YWx1ZXMgc3VpdGFibGUKICAgICAqIGZvciBzdHJpY3QgZXF1YWxpdHkgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgcHJvcGVydHkgdG8gZ2V0LgogICAgICogQHBhcmFtIHsqfSBzcmNWYWx1ZSBUaGUgdmFsdWUgdG8gbWF0Y2guCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBzcGVjIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBtYXRjaGVzU3RyaWN0Q29tcGFyYWJsZShrZXksIHNyY1ZhbHVlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICBpZiAob2JqZWN0ID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iamVjdFtrZXldID09PSBzcmNWYWx1ZSAmJgogICAgICAgICAgKHNyY1ZhbHVlICE9PSB1bmRlZmluZWQgfHwgKGtleSBpbiBPYmplY3Qob2JqZWN0KSkpOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQSBzcGVjaWFsaXplZCB2ZXJzaW9uIG9mIGBfLm1lbW9pemVgIHdoaWNoIGNsZWFycyB0aGUgbWVtb2l6ZWQgZnVuY3Rpb24ncwogICAgICogY2FjaGUgd2hlbiBpdCBleGNlZWRzIGBNQVhfTUVNT0laRV9TSVpFYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaGF2ZSBpdHMgb3V0cHV0IG1lbW9pemVkLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgbWVtb2l6ZWQgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1lbW9pemVDYXBwZWQoZnVuYykgewogICAgICB2YXIgcmVzdWx0ID0gbWVtb2l6ZShmdW5jLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICBpZiAoY2FjaGUuc2l6ZSA9PT0gTUFYX01FTU9JWkVfU0laRSkgewogICAgICAgICAgY2FjaGUuY2xlYXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGtleTsKICAgICAgfSk7CgogICAgICB2YXIgY2FjaGUgPSByZXN1bHQuY2FjaGU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBNZXJnZXMgdGhlIGZ1bmN0aW9uIG1ldGFkYXRhIG9mIGBzb3VyY2VgIGludG8gYGRhdGFgLgogICAgICoKICAgICAqIE1lcmdpbmcgbWV0YWRhdGEgcmVkdWNlcyB0aGUgbnVtYmVyIG9mIHdyYXBwZXJzIHVzZWQgdG8gaW52b2tlIGEgZnVuY3Rpb24uCiAgICAgKiBUaGlzIGlzIHBvc3NpYmxlIGJlY2F1c2UgbWV0aG9kcyBsaWtlIGBfLmJpbmRgLCBgXy5jdXJyeWAsIGFuZCBgXy5wYXJ0aWFsYAogICAgICogbWF5IGJlIGFwcGxpZWQgcmVnYXJkbGVzcyBvZiBleGVjdXRpb24gb3JkZXIuIE1ldGhvZHMgbGlrZSBgXy5hcnlgIGFuZAogICAgICogYF8ucmVhcmdgIG1vZGlmeSBmdW5jdGlvbiBhcmd1bWVudHMsIG1ha2luZyB0aGUgb3JkZXIgaW4gd2hpY2ggdGhleSBhcmUKICAgICAqIGV4ZWN1dGVkIGltcG9ydGFudCwgcHJldmVudGluZyB0aGUgbWVyZ2luZyBvZiBtZXRhZGF0YS4gSG93ZXZlciwgd2UgbWFrZQogICAgICogYW4gZXhjZXB0aW9uIGZvciBhIHNhZmUgY29tYmluZWQgY2FzZSB3aGVyZSBjdXJyaWVkIGZ1bmN0aW9ucyBoYXZlIGBfLmFyeWAKICAgICAqIGFuZCBvciBgXy5yZWFyZ2AgYXBwbGllZC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gZGF0YSBUaGUgZGVzdGluYXRpb24gbWV0YWRhdGEuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBzb3VyY2UgVGhlIHNvdXJjZSBtZXRhZGF0YS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBgZGF0YWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1lcmdlRGF0YShkYXRhLCBzb3VyY2UpIHsKICAgICAgdmFyIGJpdG1hc2sgPSBkYXRhWzFdLAogICAgICAgICAgc3JjQml0bWFzayA9IHNvdXJjZVsxXSwKICAgICAgICAgIG5ld0JpdG1hc2sgPSBiaXRtYXNrIHwgc3JjQml0bWFzaywKICAgICAgICAgIGlzQ29tbW9uID0gbmV3Qml0bWFzayA8IChXUkFQX0JJTkRfRkxBRyB8IFdSQVBfQklORF9LRVlfRkxBRyB8IFdSQVBfQVJZX0ZMQUcpOwoKICAgICAgdmFyIGlzQ29tYm8gPQogICAgICAgICgoc3JjQml0bWFzayA9PSBXUkFQX0FSWV9GTEFHKSAmJiAoYml0bWFzayA9PSBXUkFQX0NVUlJZX0ZMQUcpKSB8fAogICAgICAgICgoc3JjQml0bWFzayA9PSBXUkFQX0FSWV9GTEFHKSAmJiAoYml0bWFzayA9PSBXUkFQX1JFQVJHX0ZMQUcpICYmIChkYXRhWzddLmxlbmd0aCA8PSBzb3VyY2VbOF0pKSB8fAogICAgICAgICgoc3JjQml0bWFzayA9PSAoV1JBUF9BUllfRkxBRyB8IFdSQVBfUkVBUkdfRkxBRykpICYmIChzb3VyY2VbN10ubGVuZ3RoIDw9IHNvdXJjZVs4XSkgJiYgKGJpdG1hc2sgPT0gV1JBUF9DVVJSWV9GTEFHKSk7CgogICAgICAvLyBFeGl0IGVhcmx5IGlmIG1ldGFkYXRhIGNhbid0IGJlIG1lcmdlZC4KICAgICAgaWYgKCEoaXNDb21tb24gfHwgaXNDb21ibykpIHsKICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgfQogICAgICAvLyBVc2Ugc291cmNlIGB0aGlzQXJnYCBpZiBhdmFpbGFibGUuCiAgICAgIGlmIChzcmNCaXRtYXNrICYgV1JBUF9CSU5EX0ZMQUcpIHsKICAgICAgICBkYXRhWzJdID0gc291cmNlWzJdOwogICAgICAgIC8vIFNldCB3aGVuIGN1cnJ5aW5nIGEgYm91bmQgZnVuY3Rpb24uCiAgICAgICAgbmV3Qml0bWFzayB8PSBiaXRtYXNrICYgV1JBUF9CSU5EX0ZMQUcgPyAwIDogV1JBUF9DVVJSWV9CT1VORF9GTEFHOwogICAgICB9CiAgICAgIC8vIENvbXBvc2UgcGFydGlhbCBhcmd1bWVudHMuCiAgICAgIHZhciB2YWx1ZSA9IHNvdXJjZVszXTsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgdmFyIHBhcnRpYWxzID0gZGF0YVszXTsKICAgICAgICBkYXRhWzNdID0gcGFydGlhbHMgPyBjb21wb3NlQXJncyhwYXJ0aWFscywgdmFsdWUsIHNvdXJjZVs0XSkgOiB2YWx1ZTsKICAgICAgICBkYXRhWzRdID0gcGFydGlhbHMgPyByZXBsYWNlSG9sZGVycyhkYXRhWzNdLCBQTEFDRUhPTERFUikgOiBzb3VyY2VbNF07CiAgICAgIH0KICAgICAgLy8gQ29tcG9zZSBwYXJ0aWFsIHJpZ2h0IGFyZ3VtZW50cy4KICAgICAgdmFsdWUgPSBzb3VyY2VbNV07CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIHBhcnRpYWxzID0gZGF0YVs1XTsKICAgICAgICBkYXRhWzVdID0gcGFydGlhbHMgPyBjb21wb3NlQXJnc1JpZ2h0KHBhcnRpYWxzLCB2YWx1ZSwgc291cmNlWzZdKSA6IHZhbHVlOwogICAgICAgIGRhdGFbNl0gPSBwYXJ0aWFscyA/IHJlcGxhY2VIb2xkZXJzKGRhdGFbNV0sIFBMQUNFSE9MREVSKSA6IHNvdXJjZVs2XTsKICAgICAgfQogICAgICAvLyBVc2Ugc291cmNlIGBhcmdQb3NgIGlmIGF2YWlsYWJsZS4KICAgICAgdmFsdWUgPSBzb3VyY2VbN107CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIGRhdGFbN10gPSB2YWx1ZTsKICAgICAgfQogICAgICAvLyBVc2Ugc291cmNlIGBhcnlgIGlmIGl0J3Mgc21hbGxlci4KICAgICAgaWYgKHNyY0JpdG1hc2sgJiBXUkFQX0FSWV9GTEFHKSB7CiAgICAgICAgZGF0YVs4XSA9IGRhdGFbOF0gPT0gbnVsbCA/IHNvdXJjZVs4XSA6IG5hdGl2ZU1pbihkYXRhWzhdLCBzb3VyY2VbOF0pOwogICAgICB9CiAgICAgIC8vIFVzZSBzb3VyY2UgYGFyaXR5YCBpZiBvbmUgaXMgbm90IHByb3ZpZGVkLgogICAgICBpZiAoZGF0YVs5XSA9PSBudWxsKSB7CiAgICAgICAgZGF0YVs5XSA9IHNvdXJjZVs5XTsKICAgICAgfQogICAgICAvLyBVc2Ugc291cmNlIGBmdW5jYCBhbmQgbWVyZ2UgYml0bWFza3MuCiAgICAgIGRhdGFbMF0gPSBzb3VyY2VbMF07CiAgICAgIGRhdGFbMV0gPSBuZXdCaXRtYXNrOwoKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIGZ1bmN0aW9uIGlzIGxpa2UKICAgICAqIFtgT2JqZWN0LmtleXNgXShodHRwOi8vZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy1vYmplY3Qua2V5cykKICAgICAqIGV4Y2VwdCB0aGF0IGl0IGluY2x1ZGVzIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIG5hdGl2ZUtleXNJbihvYmplY3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBpZiAob2JqZWN0ICE9IG51bGwpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gT2JqZWN0KG9iamVjdCkpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBgdmFsdWVgIHRvIGEgc3RyaW5nIHVzaW5nIGBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nYC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY29udmVydC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGNvbnZlcnRlZCBzdHJpbmcuCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9iamVjdFRvU3RyaW5nKHZhbHVlKSB7CiAgICAgIHJldHVybiBuYXRpdmVPYmplY3RUb1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgYmFzZVJlc3RgIHdoaWNoIHRyYW5zZm9ybXMgdGhlIHJlc3QgYXJyYXkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGFwcGx5IGEgcmVzdCBwYXJhbWV0ZXIgdG8uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3N0YXJ0PWZ1bmMubGVuZ3RoLTFdIFRoZSBzdGFydCBwb3NpdGlvbiBvZiB0aGUgcmVzdCBwYXJhbWV0ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSB0cmFuc2Zvcm0gVGhlIHJlc3QgYXJyYXkgdHJhbnNmb3JtLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIG92ZXJSZXN0KGZ1bmMsIHN0YXJ0LCB0cmFuc2Zvcm0pIHsKICAgICAgc3RhcnQgPSBuYXRpdmVNYXgoc3RhcnQgPT09IHVuZGVmaW5lZCA/IChmdW5jLmxlbmd0aCAtIDEpIDogc3RhcnQsIDApOwogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IG5hdGl2ZU1heChhcmdzLmxlbmd0aCAtIHN0YXJ0LCAwKSwKICAgICAgICAgICAgYXJyYXkgPSBBcnJheShsZW5ndGgpOwoKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgYXJyYXlbaW5kZXhdID0gYXJnc1tzdGFydCArIGluZGV4XTsKICAgICAgICB9CiAgICAgICAgaW5kZXggPSAtMTsKICAgICAgICB2YXIgb3RoZXJBcmdzID0gQXJyYXkoc3RhcnQgKyAxKTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IHN0YXJ0KSB7CiAgICAgICAgICBvdGhlckFyZ3NbaW5kZXhdID0gYXJnc1tpbmRleF07CiAgICAgICAgfQogICAgICAgIG90aGVyQXJnc1tzdGFydF0gPSB0cmFuc2Zvcm0oYXJyYXkpOwogICAgICAgIHJldHVybiBhcHBseShmdW5jLCB0aGlzLCBvdGhlckFyZ3MpOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgcGFyZW50IHZhbHVlIGF0IGBwYXRoYCBvZiBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtBcnJheX0gcGF0aCBUaGUgcGF0aCB0byBnZXQgdGhlIHBhcmVudCB2YWx1ZSBvZi4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBwYXJlbnQgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcmVudChvYmplY3QsIHBhdGgpIHsKICAgICAgcmV0dXJuIHBhdGgubGVuZ3RoIDwgMiA/IG9iamVjdCA6IGJhc2VHZXQob2JqZWN0LCBiYXNlU2xpY2UocGF0aCwgMCwgLTEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlb3JkZXIgYGFycmF5YCBhY2NvcmRpbmcgdG8gdGhlIHNwZWNpZmllZCBpbmRleGVzIHdoZXJlIHRoZSBlbGVtZW50IGF0CiAgICAgKiB0aGUgZmlyc3QgaW5kZXggaXMgYXNzaWduZWQgYXMgdGhlIGZpcnN0IGVsZW1lbnQsIHRoZSBlbGVtZW50IGF0CiAgICAgKiB0aGUgc2Vjb25kIGluZGV4IGlzIGFzc2lnbmVkIGFzIHRoZSBzZWNvbmQgZWxlbWVudCwgYW5kIHNvIG9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcmVvcmRlci4KICAgICAqIEBwYXJhbSB7QXJyYXl9IGluZGV4ZXMgVGhlIGFycmFuZ2VkIGFycmF5IGluZGV4ZXMuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYGFycmF5YC4KICAgICAqLwogICAgZnVuY3Rpb24gcmVvcmRlcihhcnJheSwgaW5kZXhlcykgewogICAgICB2YXIgYXJyTGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgICAgbGVuZ3RoID0gbmF0aXZlTWluKGluZGV4ZXMubGVuZ3RoLCBhcnJMZW5ndGgpLAogICAgICAgICAgb2xkQXJyYXkgPSBjb3B5QXJyYXkoYXJyYXkpOwoKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgdmFyIGluZGV4ID0gaW5kZXhlc1tsZW5ndGhdOwogICAgICAgIGFycmF5W2xlbmd0aF0gPSBpc0luZGV4KGluZGV4LCBhcnJMZW5ndGgpID8gb2xkQXJyYXlbaW5kZXhdIDogdW5kZWZpbmVkOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIHZhbHVlIGF0IGBrZXlgLCB1bmxlc3MgYGtleWAgaXMgIl9fcHJvdG9fXyIgb3IgImNvbnN0cnVjdG9yIi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBwcm9wZXJ0eSB0byBnZXQuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgcHJvcGVydHkgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNhZmVHZXQob2JqZWN0LCBrZXkpIHsKICAgICAgaWYgKGtleSA9PT0gJ2NvbnN0cnVjdG9yJyAmJiB0eXBlb2Ygb2JqZWN0W2tleV0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChrZXkgPT0gJ19fcHJvdG9fXycpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHJldHVybiBvYmplY3Rba2V5XTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgbWV0YWRhdGEgZm9yIGBmdW5jYC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogSWYgdGhpcyBmdW5jdGlvbiBiZWNvbWVzIGhvdCwgaS5lLiBpcyBpbnZva2VkIGEgbG90IGluIGEgc2hvcnQKICAgICAqIHBlcmlvZCBvZiB0aW1lLCBpdCB3aWxsIHRyaXAgaXRzIGJyZWFrZXIgYW5kIHRyYW5zaXRpb24gdG8gYW4gaWRlbnRpdHkKICAgICAqIGZ1bmN0aW9uIHRvIGF2b2lkIGdhcmJhZ2UgY29sbGVjdGlvbiBwYXVzZXMgaW4gVjguIFNlZQogICAgICogW1Y4IGlzc3VlIDIwNzBdKGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTIwNzApCiAgICAgKiBmb3IgbW9yZSBkZXRhaWxzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBhc3NvY2lhdGUgbWV0YWRhdGEgd2l0aC4KICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBUaGUgbWV0YWRhdGEuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgYGZ1bmNgLgogICAgICovCiAgICB2YXIgc2V0RGF0YSA9IHNob3J0T3V0KGJhc2VTZXREYXRhKTsKCiAgICAvKioKICAgICAqIEEgc2ltcGxlIHdyYXBwZXIgYXJvdW5kIHRoZSBnbG9iYWwgW2BzZXRUaW1lb3V0YF0oaHR0cHM6Ly9tZG4uaW8vc2V0VGltZW91dCkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlbGF5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgaW52b2NhdGlvbi4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ8T2JqZWN0fSBSZXR1cm5zIHRoZSB0aW1lciBpZCBvciB0aW1lb3V0IG9iamVjdC4KICAgICAqLwogICAgdmFyIHNldFRpbWVvdXQgPSBjdHhTZXRUaW1lb3V0IHx8IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgICAgcmV0dXJuIHJvb3Quc2V0VGltZW91dChmdW5jLCB3YWl0KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBgdG9TdHJpbmdgIG1ldGhvZCBvZiBgZnVuY2AgdG8gcmV0dXJuIGBzdHJpbmdgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBzdHJpbmcgVGhlIGB0b1N0cmluZ2AgcmVzdWx0LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIGBmdW5jYC4KICAgICAqLwogICAgdmFyIHNldFRvU3RyaW5nID0gc2hvcnRPdXQoYmFzZVNldFRvU3RyaW5nKTsKCiAgICAvKioKICAgICAqIFNldHMgdGhlIGB0b1N0cmluZ2AgbWV0aG9kIG9mIGB3cmFwcGVyYCB0byBtaW1pYyB0aGUgc291cmNlIG9mIGByZWZlcmVuY2VgCiAgICAgKiB3aXRoIHdyYXBwZXIgZGV0YWlscyBpbiBhIGNvbW1lbnQgYXQgdGhlIHRvcCBvZiB0aGUgc291cmNlIGJvZHkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHdyYXBwZXIgVGhlIGZ1bmN0aW9uIHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHJlZmVyZW5jZSBUaGUgcmVmZXJlbmNlIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGJpdG1hc2sgVGhlIGJpdG1hc2sgZmxhZ3MuIFNlZSBgY3JlYXRlV3JhcGAgZm9yIG1vcmUgZGV0YWlscy4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBgd3JhcHBlcmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldFdyYXBUb1N0cmluZyh3cmFwcGVyLCByZWZlcmVuY2UsIGJpdG1hc2spIHsKICAgICAgdmFyIHNvdXJjZSA9IChyZWZlcmVuY2UgKyAnJyk7CiAgICAgIHJldHVybiBzZXRUb1N0cmluZyh3cmFwcGVyLCBpbnNlcnRXcmFwRGV0YWlscyhzb3VyY2UsIHVwZGF0ZVdyYXBEZXRhaWxzKGdldFdyYXBEZXRhaWxzKHNvdXJjZSksIGJpdG1hc2spKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCdsbCBzaG9ydCBvdXQgYW5kIGludm9rZSBgaWRlbnRpdHlgIGluc3RlYWQKICAgICAqIG9mIGBmdW5jYCB3aGVuIGl0J3MgY2FsbGVkIGBIT1RfQ09VTlRgIG9yIG1vcmUgdGltZXMgaW4gYEhPVF9TUEFOYAogICAgICogbWlsbGlzZWNvbmRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byByZXN0cmljdC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHNob3J0YWJsZSBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gc2hvcnRPdXQoZnVuYykgewogICAgICB2YXIgY291bnQgPSAwLAogICAgICAgICAgbGFzdENhbGxlZCA9IDA7CgogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0YW1wID0gbmF0aXZlTm93KCksCiAgICAgICAgICAgIHJlbWFpbmluZyA9IEhPVF9TUEFOIC0gKHN0YW1wIC0gbGFzdENhbGxlZCk7CgogICAgICAgIGxhc3RDYWxsZWQgPSBzdGFtcDsKICAgICAgICBpZiAocmVtYWluaW5nID4gMCkgewogICAgICAgICAgaWYgKCsrY291bnQgPj0gSE9UX0NPVU5UKSB7CiAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHNbMF07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvdW50ID0gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQSBzcGVjaWFsaXplZCB2ZXJzaW9uIG9mIGBfLnNodWZmbGVgIHdoaWNoIG11dGF0ZXMgYW5kIHNldHMgdGhlIHNpemUgb2YgYGFycmF5YC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNodWZmbGUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3NpemU9YXJyYXkubGVuZ3RoXSBUaGUgc2l6ZSBvZiBgYXJyYXlgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGBhcnJheWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNodWZmbGVTZWxmKGFycmF5LCBzaXplKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgICAgbGFzdEluZGV4ID0gbGVuZ3RoIC0gMTsKCiAgICAgIHNpemUgPSBzaXplID09PSB1bmRlZmluZWQgPyBsZW5ndGggOiBzaXplOwogICAgICB3aGlsZSAoKytpbmRleCA8IHNpemUpIHsKICAgICAgICB2YXIgcmFuZCA9IGJhc2VSYW5kb20oaW5kZXgsIGxhc3RJbmRleCksCiAgICAgICAgICAgIHZhbHVlID0gYXJyYXlbcmFuZF07CgogICAgICAgIGFycmF5W3JhbmRdID0gYXJyYXlbaW5kZXhdOwogICAgICAgIGFycmF5W2luZGV4XSA9IHZhbHVlOwogICAgICB9CiAgICAgIGFycmF5Lmxlbmd0aCA9IHNpemU7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIGBzdHJpbmdgIHRvIGEgcHJvcGVydHkgcGF0aCBhcnJheS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBUaGUgc3RyaW5nIHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHByb3BlcnR5IHBhdGggYXJyYXkuCiAgICAgKi8KICAgIHZhciBzdHJpbmdUb1BhdGggPSBtZW1vaXplQ2FwcGVkKGZ1bmN0aW9uKHN0cmluZykgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGlmIChzdHJpbmcuY2hhckNvZGVBdCgwKSA9PT0gNDYgLyogLiAqLykgewogICAgICAgIHJlc3VsdC5wdXNoKCcnKTsKICAgICAgfQogICAgICBzdHJpbmcucmVwbGFjZShyZVByb3BOYW1lLCBmdW5jdGlvbihtYXRjaCwgbnVtYmVyLCBxdW90ZSwgc3ViU3RyaW5nKSB7CiAgICAgICAgcmVzdWx0LnB1c2gocXVvdGUgPyBzdWJTdHJpbmcucmVwbGFjZShyZUVzY2FwZUNoYXIsICckMScpIDogKG51bWJlciB8fCBtYXRjaCkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ29udmVydHMgYHZhbHVlYCB0byBhIHN0cmluZyBrZXkgaWYgaXQncyBub3QgYSBzdHJpbmcgb3Igc3ltYm9sLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge3N0cmluZ3xzeW1ib2x9IFJldHVybnMgdGhlIGtleS4KICAgICAqLwogICAgZnVuY3Rpb24gdG9LZXkodmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyB8fCBpc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9ICh2YWx1ZSArICcnKTsKICAgICAgcmV0dXJuIChyZXN1bHQgPT0gJzAnICYmICgxIC8gdmFsdWUpID09IC1JTkZJTklUWSkgPyAnLTAnIDogcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgYGZ1bmNgIHRvIGl0cyBzb3VyY2UgY29kZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gY29udmVydC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHNvdXJjZSBjb2RlLgogICAgICovCiAgICBmdW5jdGlvbiB0b1NvdXJjZShmdW5jKSB7CiAgICAgIGlmIChmdW5jICE9IG51bGwpIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIGZ1bmNUb1N0cmluZy5jYWxsKGZ1bmMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiAoZnVuYyArICcnKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICB9CiAgICAgIHJldHVybiAnJzsKICAgIH0KCiAgICAvKioKICAgICAqIFVwZGF0ZXMgd3JhcHBlciBgZGV0YWlsc2AgYmFzZWQgb24gYGJpdG1hc2tgIGZsYWdzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IGRldGFpbHMgVGhlIGRldGFpbHMgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IGJpdG1hc2sgVGhlIGJpdG1hc2sgZmxhZ3MuIFNlZSBgY3JlYXRlV3JhcGAgZm9yIG1vcmUgZGV0YWlscy4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBgZGV0YWlsc2AuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBEZXRhaWxzKGRldGFpbHMsIGJpdG1hc2spIHsKICAgICAgYXJyYXlFYWNoKHdyYXBGbGFncywgZnVuY3Rpb24ocGFpcikgewogICAgICAgIHZhciB2YWx1ZSA9ICdfLicgKyBwYWlyWzBdOwogICAgICAgIGlmICgoYml0bWFzayAmIHBhaXJbMV0pICYmICFhcnJheUluY2x1ZGVzKGRldGFpbHMsIHZhbHVlKSkgewogICAgICAgICAgZGV0YWlscy5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gZGV0YWlscy5zb3J0KCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgY2xvbmUgb2YgYHdyYXBwZXJgLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gd3JhcHBlciBUaGUgd3JhcHBlciB0byBjbG9uZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNsb25lZCB3cmFwcGVyLgogICAgICovCiAgICBmdW5jdGlvbiB3cmFwcGVyQ2xvbmUod3JhcHBlcikgewogICAgICBpZiAod3JhcHBlciBpbnN0YW5jZW9mIExhenlXcmFwcGVyKSB7CiAgICAgICAgcmV0dXJuIHdyYXBwZXIuY2xvbmUoKTsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gbmV3IExvZGFzaFdyYXBwZXIod3JhcHBlci5fX3dyYXBwZWRfXywgd3JhcHBlci5fX2NoYWluX18pOwogICAgICByZXN1bHQuX19hY3Rpb25zX18gPSBjb3B5QXJyYXkod3JhcHBlci5fX2FjdGlvbnNfXyk7CiAgICAgIHJlc3VsdC5fX2luZGV4X18gID0gd3JhcHBlci5fX2luZGV4X187CiAgICAgIHJlc3VsdC5fX3ZhbHVlc19fID0gd3JhcHBlci5fX3ZhbHVlc19fOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZWxlbWVudHMgc3BsaXQgaW50byBncm91cHMgdGhlIGxlbmd0aCBvZiBgc2l6ZWAuCiAgICAgKiBJZiBgYXJyYXlgIGNhbid0IGJlIHNwbGl0IGV2ZW5seSwgdGhlIGZpbmFsIGNodW5rIHdpbGwgYmUgdGhlIHJlbWFpbmluZwogICAgICogZWxlbWVudHMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcHJvY2Vzcy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc2l6ZT0xXSBUaGUgbGVuZ3RoIG9mIGVhY2ggY2h1bmsKICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBFbmFibGVzIHVzZSBhcyBhbiBpdGVyYXRlZSBmb3IgbWV0aG9kcyBsaWtlIGBfLm1hcGAuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBjaHVua3MuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY2h1bmsoWydhJywgJ2InLCAnYycsICdkJ10sIDIpOwogICAgICogLy8gPT4gW1snYScsICdiJ10sIFsnYycsICdkJ11dCiAgICAgKgogICAgICogXy5jaHVuayhbJ2EnLCAnYicsICdjJywgJ2QnXSwgMyk7CiAgICAgKiAvLyA9PiBbWydhJywgJ2InLCAnYyddLCBbJ2QnXV0KICAgICAqLwogICAgZnVuY3Rpb24gY2h1bmsoYXJyYXksIHNpemUsIGd1YXJkKSB7CiAgICAgIGlmICgoZ3VhcmQgPyBpc0l0ZXJhdGVlQ2FsbChhcnJheSwgc2l6ZSwgZ3VhcmQpIDogc2l6ZSA9PT0gdW5kZWZpbmVkKSkgewogICAgICAgIHNpemUgPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIHNpemUgPSBuYXRpdmVNYXgodG9JbnRlZ2VyKHNpemUpLCAwKTsKICAgICAgfQogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CiAgICAgIGlmICghbGVuZ3RoIHx8IHNpemUgPCAxKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICByZXNJbmRleCA9IDAsCiAgICAgICAgICByZXN1bHQgPSBBcnJheShuYXRpdmVDZWlsKGxlbmd0aCAvIHNpemUpKTsKCiAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHJlc3VsdFtyZXNJbmRleCsrXSA9IGJhc2VTbGljZShhcnJheSwgaW5kZXgsIChpbmRleCArPSBzaXplKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgd2l0aCBhbGwgZmFsc2V5IHZhbHVlcyByZW1vdmVkLiBUaGUgdmFsdWVzIGBmYWxzZWAsIGBudWxsYCwKICAgICAqIGAwYCwgYCIiYCwgYHVuZGVmaW5lZGAsIGFuZCBgTmFOYCBhcmUgZmFsc2V5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGNvbXBhY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY29tcGFjdChbMCwgMSwgZmFsc2UsIDIsICcnLCAzXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gY29tcGFjdChhcnJheSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoLAogICAgICAgICAgcmVzSW5kZXggPSAwLAogICAgICAgICAgcmVzdWx0ID0gW107CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgIHJlc3VsdFtyZXNJbmRleCsrXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBhcnJheSBjb25jYXRlbmF0aW5nIGBhcnJheWAgd2l0aCBhbnkgYWRkaXRpb25hbCBhcnJheXMKICAgICAqIGFuZC9vciB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29uY2F0ZW5hdGUuCiAgICAgKiBAcGFyYW0gey4uLip9IFt2YWx1ZXNdIFRoZSB2YWx1ZXMgdG8gY29uY2F0ZW5hdGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBjb25jYXRlbmF0ZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBhcnJheSA9IFsxXTsKICAgICAqIHZhciBvdGhlciA9IF8uY29uY2F0KGFycmF5LCAyLCBbM10sIFtbNF1dKTsKICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhvdGhlcik7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgWzRdXQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGFycmF5KTsKICAgICAqIC8vID0+IFsxXQogICAgICovCiAgICBmdW5jdGlvbiBjb25jYXQoKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICBpZiAoIWxlbmd0aCkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICB2YXIgYXJncyA9IEFycmF5KGxlbmd0aCAtIDEpLAogICAgICAgICAgYXJyYXkgPSBhcmd1bWVudHNbMF0sCiAgICAgICAgICBpbmRleCA9IGxlbmd0aDsKCiAgICAgIHdoaWxlIChpbmRleC0tKSB7CiAgICAgICAgYXJnc1tpbmRleCAtIDFdID0gYXJndW1lbnRzW2luZGV4XTsKICAgICAgfQogICAgICByZXR1cm4gYXJyYXlQdXNoKGlzQXJyYXkoYXJyYXkpID8gY29weUFycmF5KGFycmF5KSA6IFthcnJheV0sIGJhc2VGbGF0dGVuKGFyZ3MsIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgYGFycmF5YCB2YWx1ZXMgbm90IGluY2x1ZGVkIGluIHRoZSBvdGhlciBnaXZlbiBhcnJheXMKICAgICAqIHVzaW5nIFtgU2FtZVZhbHVlWmVyb2BdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXNhbWV2YWx1ZXplcm8pCiAgICAgKiBmb3IgZXF1YWxpdHkgY29tcGFyaXNvbnMuIFRoZSBvcmRlciBhbmQgcmVmZXJlbmNlcyBvZiByZXN1bHQgdmFsdWVzIGFyZQogICAgICogZGV0ZXJtaW5lZCBieSB0aGUgZmlyc3QgYXJyYXkuCiAgICAgKgogICAgICogKipOb3RlOioqIFVubGlrZSBgXy5wdWxsQWxsYCwgdGhpcyBtZXRob2QgcmV0dXJucyBhIG5ldyBhcnJheS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW3ZhbHVlc10gVGhlIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgYXJyYXkgb2YgZmlsdGVyZWQgdmFsdWVzLgogICAgICogQHNlZSBfLndpdGhvdXQsIF8ueG9yCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZGlmZmVyZW5jZShbMiwgMV0sIFsyLCAzXSk7CiAgICAgKiAvLyA9PiBbMV0KICAgICAqLwogICAgdmFyIGRpZmZlcmVuY2UgPSBiYXNlUmVzdChmdW5jdGlvbihhcnJheSwgdmFsdWVzKSB7CiAgICAgIHJldHVybiBpc0FycmF5TGlrZU9iamVjdChhcnJheSkKICAgICAgICA/IGJhc2VEaWZmZXJlbmNlKGFycmF5LCBiYXNlRmxhdHRlbih2YWx1ZXMsIDEsIGlzQXJyYXlMaWtlT2JqZWN0LCB0cnVlKSkKICAgICAgICA6IFtdOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmRpZmZlcmVuY2VgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGl0ZXJhdGVlYCB3aGljaAogICAgICogaXMgaW52b2tlZCBmb3IgZWFjaCBlbGVtZW50IG9mIGBhcnJheWAgYW5kIGB2YWx1ZXNgIHRvIGdlbmVyYXRlIHRoZSBjcml0ZXJpb24KICAgICAqIGJ5IHdoaWNoIHRoZXkncmUgY29tcGFyZWQuIFRoZSBvcmRlciBhbmQgcmVmZXJlbmNlcyBvZiByZXN1bHQgdmFsdWVzIGFyZQogICAgICogZGV0ZXJtaW5lZCBieSB0aGUgZmlyc3QgYXJyYXkuIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OgogICAgICogKHZhbHVlKS4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVW5saWtlIGBfLnB1bGxBbGxCeWAsIHRoaXMgbWV0aG9kIHJldHVybnMgYSBuZXcgYXJyYXkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFt2YWx1ZXNdIFRoZSB2YWx1ZXMgdG8gZXhjbHVkZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgaXRlcmF0ZWUgaW52b2tlZCBwZXIgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5IG9mIGZpbHRlcmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5kaWZmZXJlbmNlQnkoWzIuMSwgMS4yXSwgWzIuMywgMy40XSwgTWF0aC5mbG9vcik7CiAgICAgKiAvLyA9PiBbMS4yXQogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5kaWZmZXJlbmNlQnkoW3sgJ3gnOiAyIH0sIHsgJ3gnOiAxIH1dLCBbeyAneCc6IDEgfV0sICd4Jyk7CiAgICAgKiAvLyA9PiBbeyAneCc6IDIgfV0KICAgICAqLwogICAgdmFyIGRpZmZlcmVuY2VCeSA9IGJhc2VSZXN0KGZ1bmN0aW9uKGFycmF5LCB2YWx1ZXMpIHsKICAgICAgdmFyIGl0ZXJhdGVlID0gbGFzdCh2YWx1ZXMpOwogICAgICBpZiAoaXNBcnJheUxpa2VPYmplY3QoaXRlcmF0ZWUpKSB7CiAgICAgICAgaXRlcmF0ZWUgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzQXJyYXlMaWtlT2JqZWN0KGFycmF5KQogICAgICAgID8gYmFzZURpZmZlcmVuY2UoYXJyYXksIGJhc2VGbGF0dGVuKHZhbHVlcywgMSwgaXNBcnJheUxpa2VPYmplY3QsIHRydWUpLCBnZXRJdGVyYXRlZShpdGVyYXRlZSwgMikpCiAgICAgICAgOiBbXTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5kaWZmZXJlbmNlYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBjb21wYXJhdG9yYAogICAgICogd2hpY2ggaXMgaW52b2tlZCB0byBjb21wYXJlIGVsZW1lbnRzIG9mIGBhcnJheWAgdG8gYHZhbHVlc2AuIFRoZSBvcmRlciBhbmQKICAgICAqIHJlZmVyZW5jZXMgb2YgcmVzdWx0IHZhbHVlcyBhcmUgZGV0ZXJtaW5lZCBieSB0aGUgZmlyc3QgYXJyYXkuIFRoZSBjb21wYXJhdG9yCiAgICAgKiBpcyBpbnZva2VkIHdpdGggdHdvIGFyZ3VtZW50czogKGFyclZhbCwgb3RoVmFsKS4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVW5saWtlIGBfLnB1bGxBbGxXaXRoYCwgdGhpcyBtZXRob2QgcmV0dXJucyBhIG5ldyBhcnJheS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW3ZhbHVlc10gVGhlIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NvbXBhcmF0b3JdIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3RzID0gW3sgJ3gnOiAxLCAneSc6IDIgfSwgeyAneCc6IDIsICd5JzogMSB9XTsKICAgICAqCiAgICAgKiBfLmRpZmZlcmVuY2VXaXRoKG9iamVjdHMsIFt7ICd4JzogMSwgJ3knOiAyIH1dLCBfLmlzRXF1YWwpOwogICAgICogLy8gPT4gW3sgJ3gnOiAyLCAneSc6IDEgfV0KICAgICAqLwogICAgdmFyIGRpZmZlcmVuY2VXaXRoID0gYmFzZVJlc3QoZnVuY3Rpb24oYXJyYXksIHZhbHVlcykgewogICAgICB2YXIgY29tcGFyYXRvciA9IGxhc3QodmFsdWVzKTsKICAgICAgaWYgKGlzQXJyYXlMaWtlT2JqZWN0KGNvbXBhcmF0b3IpKSB7CiAgICAgICAgY29tcGFyYXRvciA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICByZXR1cm4gaXNBcnJheUxpa2VPYmplY3QoYXJyYXkpCiAgICAgICAgPyBiYXNlRGlmZmVyZW5jZShhcnJheSwgYmFzZUZsYXR0ZW4odmFsdWVzLCAxLCBpc0FycmF5TGlrZU9iamVjdCwgdHJ1ZSksIHVuZGVmaW5lZCwgY29tcGFyYXRvcikKICAgICAgICA6IFtdOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc2xpY2Ugb2YgYGFycmF5YCB3aXRoIGBuYCBlbGVtZW50cyBkcm9wcGVkIGZyb20gdGhlIGJlZ2lubmluZy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuNS4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbj0xXSBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGRyb3AuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gRW5hYmxlcyB1c2UgYXMgYW4gaXRlcmF0ZWUgZm9yIG1ldGhvZHMgbGlrZSBgXy5tYXBgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBzbGljZSBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmRyb3AoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IFsyLCAzXQogICAgICoKICAgICAqIF8uZHJvcChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzNdCiAgICAgKgogICAgICogXy5kcm9wKFsxLCAyLCAzXSwgNSk7CiAgICAgKiAvLyA9PiBbXQogICAgICoKICAgICAqIF8uZHJvcChbMSwgMiwgM10sIDApOwogICAgICogLy8gPT4gWzEsIDIsIDNdCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRyb3AoYXJyYXksIG4sIGd1YXJkKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKICAgICAgaWYgKCFsZW5ndGgpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgbiA9IChndWFyZCB8fCBuID09PSB1bmRlZmluZWQpID8gMSA6IHRvSW50ZWdlcihuKTsKICAgICAgcmV0dXJuIGJhc2VTbGljZShhcnJheSwgbiA8IDAgPyAwIDogbiwgbGVuZ3RoKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBzbGljZSBvZiBgYXJyYXlgIHdpdGggYG5gIGVsZW1lbnRzIGRyb3BwZWQgZnJvbSB0aGUgZW5kLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtuPTFdIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gZHJvcC4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBFbmFibGVzIHVzZSBhcyBhbiBpdGVyYXRlZSBmb3IgbWV0aG9kcyBsaWtlIGBfLm1hcGAuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHNsaWNlIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZHJvcFJpZ2h0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBbMSwgMl0KICAgICAqCiAgICAgKiBfLmRyb3BSaWdodChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzFdCiAgICAgKgogICAgICogXy5kcm9wUmlnaHQoWzEsIDIsIDNdLCA1KTsKICAgICAqIC8vID0+IFtdCiAgICAgKgogICAgICogXy5kcm9wUmlnaHQoWzEsIDIsIDNdLCAwKTsKICAgICAqIC8vID0+IFsxLCAyLCAzXQogICAgICovCiAgICBmdW5jdGlvbiBkcm9wUmlnaHQoYXJyYXksIG4sIGd1YXJkKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKICAgICAgaWYgKCFsZW5ndGgpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgbiA9IChndWFyZCB8fCBuID09PSB1bmRlZmluZWQpID8gMSA6IHRvSW50ZWdlcihuKTsKICAgICAgbiA9IGxlbmd0aCAtIG47CiAgICAgIHJldHVybiBiYXNlU2xpY2UoYXJyYXksIDAsIG4gPCAwID8gMCA6IG4pOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNsaWNlIG9mIGBhcnJheWAgZXhjbHVkaW5nIGVsZW1lbnRzIGRyb3BwZWQgZnJvbSB0aGUgZW5kLgogICAgICogRWxlbWVudHMgYXJlIGRyb3BwZWQgdW50aWwgYHByZWRpY2F0ZWAgcmV0dXJucyBmYWxzZXkuIFRoZSBwcmVkaWNhdGUgaXMKICAgICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM6ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtwcmVkaWNhdGU9Xy5pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgc2xpY2Ugb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gWwogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICAnYWN0aXZlJzogdHJ1ZSB9LAogICAgICogICB7ICd1c2VyJzogJ2ZyZWQnLCAgICAnYWN0aXZlJzogZmFsc2UgfSwKICAgICAqICAgeyAndXNlcic6ICdwZWJibGVzJywgJ2FjdGl2ZSc6IGZhbHNlIH0KICAgICAqIF07CiAgICAgKgogICAgICogXy5kcm9wUmlnaHRXaGlsZSh1c2VycywgZnVuY3Rpb24obykgeyByZXR1cm4gIW8uYWN0aXZlOyB9KTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFsnYmFybmV5J10KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc2AgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5kcm9wUmlnaHRXaGlsZSh1c2VycywgeyAndXNlcic6ICdwZWJibGVzJywgJ2FjdGl2ZSc6IGZhbHNlIH0pOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgWydiYXJuZXknLCAnZnJlZCddCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNQcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5kcm9wUmlnaHRXaGlsZSh1c2VycywgWydhY3RpdmUnLCBmYWxzZV0pOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgWydiYXJuZXknXQogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5kcm9wUmlnaHRXaGlsZSh1c2VycywgJ2FjdGl2ZScpOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgWydiYXJuZXknLCAnZnJlZCcsICdwZWJibGVzJ10KICAgICAqLwogICAgZnVuY3Rpb24gZHJvcFJpZ2h0V2hpbGUoYXJyYXksIHByZWRpY2F0ZSkgewogICAgICByZXR1cm4gKGFycmF5ICYmIGFycmF5Lmxlbmd0aCkKICAgICAgICA/IGJhc2VXaGlsZShhcnJheSwgZ2V0SXRlcmF0ZWUocHJlZGljYXRlLCAzKSwgdHJ1ZSwgdHJ1ZSkKICAgICAgICA6IFtdOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNsaWNlIG9mIGBhcnJheWAgZXhjbHVkaW5nIGVsZW1lbnRzIGRyb3BwZWQgZnJvbSB0aGUgYmVnaW5uaW5nLgogICAgICogRWxlbWVudHMgYXJlIGRyb3BwZWQgdW50aWwgYHByZWRpY2F0ZWAgcmV0dXJucyBmYWxzZXkuIFRoZSBwcmVkaWNhdGUgaXMKICAgICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM6ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtwcmVkaWNhdGU9Xy5pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgc2xpY2Ugb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gWwogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICAnYWN0aXZlJzogZmFsc2UgfSwKICAgICAqICAgeyAndXNlcic6ICdmcmVkJywgICAgJ2FjdGl2ZSc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ3VzZXInOiAncGViYmxlcycsICdhY3RpdmUnOiB0cnVlIH0KICAgICAqIF07CiAgICAgKgogICAgICogXy5kcm9wV2hpbGUodXNlcnMsIGZ1bmN0aW9uKG8pIHsgcmV0dXJuICFvLmFjdGl2ZTsgfSk7CiAgICAgKiAvLyA9PiBvYmplY3RzIGZvciBbJ3BlYmJsZXMnXQogICAgICoKICAgICAqIC8vIFRoZSBgXy5tYXRjaGVzYCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmRyb3BXaGlsZSh1c2VycywgeyAndXNlcic6ICdiYXJuZXknLCAnYWN0aXZlJzogZmFsc2UgfSk7CiAgICAgKiAvLyA9PiBvYmplY3RzIGZvciBbJ2ZyZWQnLCAncGViYmxlcyddCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNQcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5kcm9wV2hpbGUodXNlcnMsIFsnYWN0aXZlJywgZmFsc2VdKTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFsncGViYmxlcyddCiAgICAgKgogICAgICogLy8gVGhlIGBfLnByb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmRyb3BXaGlsZSh1c2VycywgJ2FjdGl2ZScpOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgWydiYXJuZXknLCAnZnJlZCcsICdwZWJibGVzJ10KICAgICAqLwogICAgZnVuY3Rpb24gZHJvcFdoaWxlKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgICAgcmV0dXJuIChhcnJheSAmJiBhcnJheS5sZW5ndGgpCiAgICAgICAgPyBiYXNlV2hpbGUoYXJyYXksIGdldEl0ZXJhdGVlKHByZWRpY2F0ZSwgMyksIHRydWUpCiAgICAgICAgOiBbXTsKICAgIH0KCiAgICAvKioKICAgICAqIEZpbGxzIGVsZW1lbnRzIG9mIGBhcnJheWAgd2l0aCBgdmFsdWVgIGZyb20gYHN0YXJ0YCB1cCB0bywgYnV0IG5vdAogICAgICogaW5jbHVkaW5nLCBgZW5kYC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgYXJyYXlgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4yLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZpbGwuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBmaWxsIGBhcnJheWAgd2l0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnQ9MF0gVGhlIHN0YXJ0IHBvc2l0aW9uLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtlbmQ9YXJyYXkubGVuZ3RoXSBUaGUgZW5kIHBvc2l0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBhcnJheSA9IFsxLCAyLCAzXTsKICAgICAqCiAgICAgKiBfLmZpbGwoYXJyYXksICdhJyk7CiAgICAgKiBjb25zb2xlLmxvZyhhcnJheSk7CiAgICAgKiAvLyA9PiBbJ2EnLCAnYScsICdhJ10KICAgICAqCiAgICAgKiBfLmZpbGwoQXJyYXkoMyksIDIpOwogICAgICogLy8gPT4gWzIsIDIsIDJdCiAgICAgKgogICAgICogXy5maWxsKFs0LCA2LCA4LCAxMF0sICcqJywgMSwgMyk7CiAgICAgKiAvLyA9PiBbNCwgJyonLCAnKicsIDEwXQogICAgICovCiAgICBmdW5jdGlvbiBmaWxsKGFycmF5LCB2YWx1ZSwgc3RhcnQsIGVuZCkgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CiAgICAgIGlmICghbGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIGlmIChzdGFydCAmJiB0eXBlb2Ygc3RhcnQgIT0gJ251bWJlcicgJiYgaXNJdGVyYXRlZUNhbGwoYXJyYXksIHZhbHVlLCBzdGFydCkpIHsKICAgICAgICBzdGFydCA9IDA7CiAgICAgICAgZW5kID0gbGVuZ3RoOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlRmlsbChhcnJheSwgdmFsdWUsIHN0YXJ0LCBlbmQpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kYCBleGNlcHQgdGhhdCBpdCByZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZmlyc3QKICAgICAqIGVsZW1lbnQgYHByZWRpY2F0ZWAgcmV0dXJucyB0cnV0aHkgZm9yIGluc3RlYWQgb2YgdGhlIGVsZW1lbnQgaXRzZWxmLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMS4xLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZm91bmQgZWxlbWVudCwgZWxzZSBgLTFgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgdXNlcnMgPSBbCiAgICAgKiAgIHsgJ3VzZXInOiAnYmFybmV5JywgICdhY3RpdmUnOiBmYWxzZSB9LAogICAgICogICB7ICd1c2VyJzogJ2ZyZWQnLCAgICAnYWN0aXZlJzogZmFsc2UgfSwKICAgICAqICAgeyAndXNlcic6ICdwZWJibGVzJywgJ2FjdGl2ZSc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLmZpbmRJbmRleCh1c2VycywgZnVuY3Rpb24obykgeyByZXR1cm4gby51c2VyID09ICdiYXJuZXknOyB9KTsKICAgICAqIC8vID0+IDAKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc2AgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5maW5kSW5kZXgodXNlcnMsIHsgJ3VzZXInOiAnZnJlZCcsICdhY3RpdmUnOiBmYWxzZSB9KTsKICAgICAqIC8vID0+IDEKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc1Byb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbmRJbmRleCh1c2VycywgWydhY3RpdmUnLCBmYWxzZV0pOwogICAgICogLy8gPT4gMAogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5maW5kSW5kZXgodXNlcnMsICdhY3RpdmUnKTsKICAgICAqIC8vID0+IDIKICAgICAqLwogICAgZnVuY3Rpb24gZmluZEluZGV4KGFycmF5LCBwcmVkaWNhdGUsIGZyb21JbmRleCkgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CiAgICAgIGlmICghbGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHZhciBpbmRleCA9IGZyb21JbmRleCA9PSBudWxsID8gMCA6IHRvSW50ZWdlcihmcm9tSW5kZXgpOwogICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgaW5kZXggPSBuYXRpdmVNYXgobGVuZ3RoICsgaW5kZXgsIDApOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlRmluZEluZGV4KGFycmF5LCBnZXRJdGVyYXRlZShwcmVkaWNhdGUsIDMpLCBpbmRleCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRJbmRleGAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYGNvbGxlY3Rpb25gIGZyb20gcmlnaHQgdG8gbGVmdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDIuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3ByZWRpY2F0ZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9YXJyYXkubGVuZ3RoLTFdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGAtMWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciB1c2VycyA9IFsKICAgICAqICAgeyAndXNlcic6ICdiYXJuZXknLCAgJ2FjdGl2ZSc6IHRydWUgfSwKICAgICAqICAgeyAndXNlcic6ICdmcmVkJywgICAgJ2FjdGl2ZSc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ3VzZXInOiAncGViYmxlcycsICdhY3RpdmUnOiBmYWxzZSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uZmluZExhc3RJbmRleCh1c2VycywgZnVuY3Rpb24obykgeyByZXR1cm4gby51c2VyID09ICdwZWJibGVzJzsgfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8uZmluZExhc3RJbmRleCh1c2VycywgeyAndXNlcic6ICdiYXJuZXknLCAnYWN0aXZlJzogdHJ1ZSB9KTsKICAgICAqIC8vID0+IDAKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc1Byb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbmRMYXN0SW5kZXgodXNlcnMsIFsnYWN0aXZlJywgZmFsc2VdKTsKICAgICAqIC8vID0+IDIKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8uZmluZExhc3RJbmRleCh1c2VycywgJ2FjdGl2ZScpOwogICAgICogLy8gPT4gMAogICAgICovCiAgICBmdW5jdGlvbiBmaW5kTGFzdEluZGV4KGFycmF5LCBwcmVkaWNhdGUsIGZyb21JbmRleCkgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CiAgICAgIGlmICghbGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHZhciBpbmRleCA9IGxlbmd0aCAtIDE7CiAgICAgIGlmIChmcm9tSW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgICAgIGluZGV4ID0gdG9JbnRlZ2VyKGZyb21JbmRleCk7CiAgICAgICAgaW5kZXggPSBmcm9tSW5kZXggPCAwCiAgICAgICAgICA/IG5hdGl2ZU1heChsZW5ndGggKyBpbmRleCwgMCkKICAgICAgICAgIDogbmF0aXZlTWluKGluZGV4LCBsZW5ndGggLSAxKTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZUZpbmRJbmRleChhcnJheSwgZ2V0SXRlcmF0ZWUocHJlZGljYXRlLCAzKSwgaW5kZXgsIHRydWUpOwogICAgfQoKICAgIC8qKgogICAgICogRmxhdHRlbnMgYGFycmF5YCBhIHNpbmdsZSBsZXZlbCBkZWVwLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZsYXR0ZW4uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmxhdHRlbihbMSwgWzIsIFszLCBbNF1dLCA1XV0pOwogICAgICogLy8gPT4gWzEsIDIsIFszLCBbNF1dLCA1XQogICAgICovCiAgICBmdW5jdGlvbiBmbGF0dGVuKGFycmF5KSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKICAgICAgcmV0dXJuIGxlbmd0aCA/IGJhc2VGbGF0dGVuKGFycmF5LCAxKSA6IFtdOwogICAgfQoKICAgIC8qKgogICAgICogUmVjdXJzaXZlbHkgZmxhdHRlbnMgYGFycmF5YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmbGF0dGVuLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZmxhdHRlbmVkIGFycmF5LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZsYXR0ZW5EZWVwKFsxLCBbMiwgWzMsIFs0XV0sIDVdXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgNCwgNV0KICAgICAqLwogICAgZnVuY3Rpb24gZmxhdHRlbkRlZXAoYXJyYXkpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoOwogICAgICByZXR1cm4gbGVuZ3RoID8gYmFzZUZsYXR0ZW4oYXJyYXksIElORklOSVRZKSA6IFtdOwogICAgfQoKICAgIC8qKgogICAgICogUmVjdXJzaXZlbHkgZmxhdHRlbiBgYXJyYXlgIHVwIHRvIGBkZXB0aGAgdGltZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjQuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gZmxhdHRlbi4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZGVwdGg9MV0gVGhlIG1heGltdW0gcmVjdXJzaW9uIGRlcHRoLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZmxhdHRlbmVkIGFycmF5LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgWzIsIFszLCBbNF1dLCA1XV07CiAgICAgKgogICAgICogXy5mbGF0dGVuRGVwdGgoYXJyYXksIDEpOwogICAgICogLy8gPT4gWzEsIDIsIFszLCBbNF1dLCA1XQogICAgICoKICAgICAqIF8uZmxhdHRlbkRlcHRoKGFycmF5LCAyKTsKICAgICAqIC8vID0+IFsxLCAyLCAzLCBbNF0sIDVdCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZsYXR0ZW5EZXB0aChhcnJheSwgZGVwdGgpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoOwogICAgICBpZiAoIWxlbmd0aCkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICBkZXB0aCA9IGRlcHRoID09PSB1bmRlZmluZWQgPyAxIDogdG9JbnRlZ2VyKGRlcHRoKTsKICAgICAgcmV0dXJuIGJhc2VGbGF0dGVuKGFycmF5LCBkZXB0aCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgaW52ZXJzZSBvZiBgXy50b1BhaXJzYDsgdGhpcyBtZXRob2QgcmV0dXJucyBhbiBvYmplY3QgY29tcG9zZWQKICAgICAqIGZyb20ga2V5LXZhbHVlIGBwYWlyc2AuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBwYWlycyBUaGUga2V5LXZhbHVlIHBhaXJzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mcm9tUGFpcnMoW1snYScsIDFdLCBbJ2InLCAyXV0pOwogICAgICogLy8gPT4geyAnYSc6IDEsICdiJzogMiB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGZyb21QYWlycyhwYWlycykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IHBhaXJzID09IG51bGwgPyAwIDogcGFpcnMubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0ge307CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBwYWlyID0gcGFpcnNbaW5kZXhdOwogICAgICAgIHJlc3VsdFtwYWlyWzBdXSA9IHBhaXJbMV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYGFycmF5YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAYWxpYXMgZmlyc3QKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5oZWFkKFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiAxCiAgICAgKgogICAgICogXy5oZWFkKFtdKTsKICAgICAqIC8vID0+IHVuZGVmaW5lZAogICAgICovCiAgICBmdW5jdGlvbiBoZWFkKGFycmF5KSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKSA/IGFycmF5WzBdIDogdW5kZWZpbmVkOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgYHZhbHVlYCBpcyBmb3VuZCBpbiBgYXJyYXlgCiAgICAgKiB1c2luZyBbYFNhbWVWYWx1ZVplcm9gXShodHRwOi8vZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy1zYW1ldmFsdWV6ZXJvKQogICAgICogZm9yIGVxdWFsaXR5IGNvbXBhcmlzb25zLiBJZiBgZnJvbUluZGV4YCBpcyBuZWdhdGl2ZSwgaXQncyB1c2VkIGFzIHRoZQogICAgICogb2Zmc2V0IGZyb20gdGhlIGVuZCBvZiBgYXJyYXlgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUsIGVsc2UgYC0xYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pbmRleE9mKFsxLCAyLCAxLCAyXSwgMik7CiAgICAgKiAvLyA9PiAxCiAgICAgKgogICAgICogLy8gU2VhcmNoIGZyb20gdGhlIGBmcm9tSW5kZXhgLgogICAgICogXy5pbmRleE9mKFsxLCAyLCAxLCAyXSwgMiwgMik7CiAgICAgKiAvLyA9PiAzCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoOwogICAgICBpZiAoIWxlbmd0aCkgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgICB2YXIgaW5kZXggPSBmcm9tSW5kZXggPT0gbnVsbCA/IDAgOiB0b0ludGVnZXIoZnJvbUluZGV4KTsKICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgIGluZGV4ID0gbmF0aXZlTWF4KGxlbmd0aCArIGluZGV4LCAwKTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZUluZGV4T2YoYXJyYXksIHZhbHVlLCBpbmRleCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIGFsbCBidXQgdGhlIGxhc3QgZWxlbWVudCBvZiBgYXJyYXlgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBzbGljZSBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IFsxLCAyXQogICAgICovCiAgICBmdW5jdGlvbiBpbml0aWFsKGFycmF5KSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKICAgICAgcmV0dXJuIGxlbmd0aCA/IGJhc2VTbGljZShhcnJheSwgMCwgLTEpIDogW107CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMgdGhhdCBhcmUgaW5jbHVkZWQgaW4gYWxsIGdpdmVuIGFycmF5cwogICAgICogdXNpbmcgW2BTYW1lVmFsdWVaZXJvYF0oaHR0cDovL2VjbWEtaW50ZXJuYXRpb25hbC5vcmcvZWNtYS0yNjIvNy4wLyNzZWMtc2FtZXZhbHVlemVybykKICAgICAqIGZvciBlcXVhbGl0eSBjb21wYXJpc29ucy4gVGhlIG9yZGVyIGFuZCByZWZlcmVuY2VzIG9mIHJlc3VsdCB2YWx1ZXMgYXJlCiAgICAgKiBkZXRlcm1pbmVkIGJ5IHRoZSBmaXJzdCBhcnJheS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheXNdIFRoZSBhcnJheXMgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5IG9mIGludGVyc2VjdGluZyB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW50ZXJzZWN0aW9uKFsyLCAxXSwgWzIsIDNdKTsKICAgICAqIC8vID0+IFsyXQogICAgICovCiAgICB2YXIgaW50ZXJzZWN0aW9uID0gYmFzZVJlc3QoZnVuY3Rpb24oYXJyYXlzKSB7CiAgICAgIHZhciBtYXBwZWQgPSBhcnJheU1hcChhcnJheXMsIGNhc3RBcnJheUxpa2VPYmplY3QpOwogICAgICByZXR1cm4gKG1hcHBlZC5sZW5ndGggJiYgbWFwcGVkWzBdID09PSBhcnJheXNbMF0pCiAgICAgICAgPyBiYXNlSW50ZXJzZWN0aW9uKG1hcHBlZCkKICAgICAgICA6IFtdOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmludGVyc2VjdGlvbmAgZXhjZXB0IHRoYXQgaXQgYWNjZXB0cyBgaXRlcmF0ZWVgCiAgICAgKiB3aGljaCBpcyBpbnZva2VkIGZvciBlYWNoIGVsZW1lbnQgb2YgZWFjaCBgYXJyYXlzYCB0byBnZW5lcmF0ZSB0aGUgY3JpdGVyaW9uCiAgICAgKiBieSB3aGljaCB0aGV5J3JlIGNvbXBhcmVkLiBUaGUgb3JkZXIgYW5kIHJlZmVyZW5jZXMgb2YgcmVzdWx0IHZhbHVlcyBhcmUKICAgICAqIGRldGVybWluZWQgYnkgdGhlIGZpcnN0IGFycmF5LiBUaGUgaXRlcmF0ZWUgaXMgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDoKICAgICAqICh2YWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXlzXSBUaGUgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGl0ZXJhdGVlIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBpbnRlcnNlY3RpbmcgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmludGVyc2VjdGlvbkJ5KFsyLjEsIDEuMl0sIFsyLjMsIDMuNF0sIE1hdGguZmxvb3IpOwogICAgICogLy8gPT4gWzIuMV0KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8uaW50ZXJzZWN0aW9uQnkoW3sgJ3gnOiAxIH1dLCBbeyAneCc6IDIgfSwgeyAneCc6IDEgfV0sICd4Jyk7CiAgICAgKiAvLyA9PiBbeyAneCc6IDEgfV0KICAgICAqLwogICAgdmFyIGludGVyc2VjdGlvbkJ5ID0gYmFzZVJlc3QoZnVuY3Rpb24oYXJyYXlzKSB7CiAgICAgIHZhciBpdGVyYXRlZSA9IGxhc3QoYXJyYXlzKSwKICAgICAgICAgIG1hcHBlZCA9IGFycmF5TWFwKGFycmF5cywgY2FzdEFycmF5TGlrZU9iamVjdCk7CgogICAgICBpZiAoaXRlcmF0ZWUgPT09IGxhc3QobWFwcGVkKSkgewogICAgICAgIGl0ZXJhdGVlID0gdW5kZWZpbmVkOwogICAgICB9IGVsc2UgewogICAgICAgIG1hcHBlZC5wb3AoKTsKICAgICAgfQogICAgICByZXR1cm4gKG1hcHBlZC5sZW5ndGggJiYgbWFwcGVkWzBdID09PSBhcnJheXNbMF0pCiAgICAgICAgPyBiYXNlSW50ZXJzZWN0aW9uKG1hcHBlZCwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDIpKQogICAgICAgIDogW107CiAgICB9KTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uaW50ZXJzZWN0aW9uYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBjb21wYXJhdG9yYAogICAgICogd2hpY2ggaXMgaW52b2tlZCB0byBjb21wYXJlIGVsZW1lbnRzIG9mIGBhcnJheXNgLiBUaGUgb3JkZXIgYW5kIHJlZmVyZW5jZXMKICAgICAqIG9mIHJlc3VsdCB2YWx1ZXMgYXJlIGRldGVybWluZWQgYnkgdGhlIGZpcnN0IGFycmF5LiBUaGUgY29tcGFyYXRvciBpcwogICAgICogaW52b2tlZCB3aXRoIHR3byBhcmd1bWVudHM6IChhcnJWYWwsIG90aFZhbCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXlzXSBUaGUgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY29tcGFyYXRvcl0gVGhlIGNvbXBhcmF0b3IgaW52b2tlZCBwZXIgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5IG9mIGludGVyc2VjdGluZyB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3RzID0gW3sgJ3gnOiAxLCAneSc6IDIgfSwgeyAneCc6IDIsICd5JzogMSB9XTsKICAgICAqIHZhciBvdGhlcnMgPSBbeyAneCc6IDEsICd5JzogMSB9LCB7ICd4JzogMSwgJ3knOiAyIH1dOwogICAgICoKICAgICAqIF8uaW50ZXJzZWN0aW9uV2l0aChvYmplY3RzLCBvdGhlcnMsIF8uaXNFcXVhbCk7CiAgICAgKiAvLyA9PiBbeyAneCc6IDEsICd5JzogMiB9XQogICAgICovCiAgICB2YXIgaW50ZXJzZWN0aW9uV2l0aCA9IGJhc2VSZXN0KGZ1bmN0aW9uKGFycmF5cykgewogICAgICB2YXIgY29tcGFyYXRvciA9IGxhc3QoYXJyYXlzKSwKICAgICAgICAgIG1hcHBlZCA9IGFycmF5TWFwKGFycmF5cywgY2FzdEFycmF5TGlrZU9iamVjdCk7CgogICAgICBjb21wYXJhdG9yID0gdHlwZW9mIGNvbXBhcmF0b3IgPT0gJ2Z1bmN0aW9uJyA/IGNvbXBhcmF0b3IgOiB1bmRlZmluZWQ7CiAgICAgIGlmIChjb21wYXJhdG9yKSB7CiAgICAgICAgbWFwcGVkLnBvcCgpOwogICAgICB9CiAgICAgIHJldHVybiAobWFwcGVkLmxlbmd0aCAmJiBtYXBwZWRbMF0gPT09IGFycmF5c1swXSkKICAgICAgICA/IGJhc2VJbnRlcnNlY3Rpb24obWFwcGVkLCB1bmRlZmluZWQsIGNvbXBhcmF0b3IpCiAgICAgICAgOiBbXTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ29udmVydHMgYWxsIGVsZW1lbnRzIGluIGBhcnJheWAgaW50byBhIHN0cmluZyBzZXBhcmF0ZWQgYnkgYHNlcGFyYXRvcmAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29udmVydC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc2VwYXJhdG9yPScsJ10gVGhlIGVsZW1lbnQgc2VwYXJhdG9yLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgam9pbmVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5qb2luKFsnYScsICdiJywgJ2MnXSwgJ34nKTsKICAgICAqIC8vID0+ICdhfmJ+YycKICAgICAqLwogICAgZnVuY3Rpb24gam9pbihhcnJheSwgc2VwYXJhdG9yKSB7CiAgICAgIHJldHVybiBhcnJheSA9PSBudWxsID8gJycgOiBuYXRpdmVKb2luLmNhbGwoYXJyYXksIHNlcGFyYXRvcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBsYXN0IGVsZW1lbnQgb2YgYGFycmF5YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBsYXN0IGVsZW1lbnQgb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5sYXN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiAzCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxhc3QoYXJyYXkpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoOwogICAgICByZXR1cm4gbGVuZ3RoID8gYXJyYXlbbGVuZ3RoIC0gMV0gOiB1bmRlZmluZWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmluZGV4T2ZgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMgb2YKICAgICAqIGBhcnJheWAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9YXJyYXkubGVuZ3RoLTFdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlLCBlbHNlIGAtMWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDEsIDJdLCAyKTsKICAgICAqIC8vID0+IDMKICAgICAqCiAgICAgKiAvLyBTZWFyY2ggZnJvbSB0aGUgYGZyb21JbmRleGAuCiAgICAgKiBfLmxhc3RJbmRleE9mKFsxLCAyLCAxLCAyXSwgMiwgMik7CiAgICAgKiAvLyA9PiAxCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxhc3RJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKICAgICAgaWYgKCFsZW5ndGgpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoOwogICAgICBpZiAoZnJvbUluZGV4ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpbmRleCA9IHRvSW50ZWdlcihmcm9tSW5kZXgpOwogICAgICAgIGluZGV4ID0gaW5kZXggPCAwID8gbmF0aXZlTWF4KGxlbmd0aCArIGluZGV4LCAwKSA6IG5hdGl2ZU1pbihpbmRleCwgbGVuZ3RoIC0gMSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlID09PSB2YWx1ZQogICAgICAgID8gc3RyaWN0TGFzdEluZGV4T2YoYXJyYXksIHZhbHVlLCBpbmRleCkKICAgICAgICA6IGJhc2VGaW5kSW5kZXgoYXJyYXksIGJhc2VJc05hTiwgaW5kZXgsIHRydWUpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgZWxlbWVudCBhdCBpbmRleCBgbmAgb2YgYGFycmF5YC4gSWYgYG5gIGlzIG5lZ2F0aXZlLCB0aGUgbnRoCiAgICAgKiBlbGVtZW50IGZyb20gdGhlIGVuZCBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMTEuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW249MF0gVGhlIGluZGV4IG9mIHRoZSBlbGVtZW50IHRvIHJldHVybi4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBudGggZWxlbWVudCBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbJ2EnLCAnYicsICdjJywgJ2QnXTsKICAgICAqCiAgICAgKiBfLm50aChhcnJheSwgMSk7CiAgICAgKiAvLyA9PiAnYicKICAgICAqCiAgICAgKiBfLm50aChhcnJheSwgLTIpOwogICAgICogLy8gPT4gJ2MnOwogICAgICovCiAgICBmdW5jdGlvbiBudGgoYXJyYXksIG4pIHsKICAgICAgcmV0dXJuIChhcnJheSAmJiBhcnJheS5sZW5ndGgpID8gYmFzZU50aChhcnJheSwgdG9JbnRlZ2VyKG4pKSA6IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZXMgYWxsIGdpdmVuIHZhbHVlcyBmcm9tIGBhcnJheWAgdXNpbmcKICAgICAqIFtgU2FtZVZhbHVlWmVyb2BdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXNhbWV2YWx1ZXplcm8pCiAgICAgKiBmb3IgZXF1YWxpdHkgY29tcGFyaXNvbnMuCiAgICAgKgogICAgICogKipOb3RlOioqIFVubGlrZSBgXy53aXRob3V0YCwgdGhpcyBtZXRob2QgbXV0YXRlcyBgYXJyYXlgLiBVc2UgYF8ucmVtb3ZlYAogICAgICogdG8gcmVtb3ZlIGVsZW1lbnRzIGZyb20gYW4gYXJyYXkgYnkgcHJlZGljYXRlLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMi4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7Li4uKn0gW3ZhbHVlc10gVGhlIHZhbHVlcyB0byByZW1vdmUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGFycmF5ID0gWydhJywgJ2InLCAnYycsICdhJywgJ2InLCAnYyddOwogICAgICoKICAgICAqIF8ucHVsbChhcnJheSwgJ2EnLCAnYycpOwogICAgICogY29uc29sZS5sb2coYXJyYXkpOwogICAgICogLy8gPT4gWydiJywgJ2InXQogICAgICovCiAgICB2YXIgcHVsbCA9IGJhc2VSZXN0KHB1bGxBbGwpOwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5wdWxsYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGFuIGFycmF5IG9mIHZhbHVlcyB0byByZW1vdmUuCiAgICAgKgogICAgICogKipOb3RlOioqIFVubGlrZSBgXy5kaWZmZXJlbmNlYCwgdGhpcyBtZXRob2QgbXV0YXRlcyBgYXJyYXlgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7QXJyYXl9IHZhbHVlcyBUaGUgdmFsdWVzIHRvIHJlbW92ZS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbJ2EnLCAnYicsICdjJywgJ2EnLCAnYicsICdjJ107CiAgICAgKgogICAgICogXy5wdWxsQWxsKGFycmF5LCBbJ2EnLCAnYyddKTsKICAgICAqIGNvbnNvbGUubG9nKGFycmF5KTsKICAgICAqIC8vID0+IFsnYicsICdiJ10KICAgICAqLwogICAgZnVuY3Rpb24gcHVsbEFsbChhcnJheSwgdmFsdWVzKSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoICYmIHZhbHVlcyAmJiB2YWx1ZXMubGVuZ3RoKQogICAgICAgID8gYmFzZVB1bGxBbGwoYXJyYXksIHZhbHVlcykKICAgICAgICA6IGFycmF5OwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5wdWxsQWxsYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBpdGVyYXRlZWAgd2hpY2ggaXMKICAgICAqIGludm9rZWQgZm9yIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgIGFuZCBgdmFsdWVzYCB0byBnZW5lcmF0ZSB0aGUgY3JpdGVyaW9uCiAgICAgKiBieSB3aGljaCB0aGV5J3JlIGNvbXBhcmVkLiBUaGUgaXRlcmF0ZWUgaXMgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDogKHZhbHVlKS4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVW5saWtlIGBfLmRpZmZlcmVuY2VCeWAsIHRoaXMgbWV0aG9kIG11dGF0ZXMgYGFycmF5YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZXMgVGhlIHZhbHVlcyB0byByZW1vdmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGl0ZXJhdGVlIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGFycmF5ID0gW3sgJ3gnOiAxIH0sIHsgJ3gnOiAyIH0sIHsgJ3gnOiAzIH0sIHsgJ3gnOiAxIH1dOwogICAgICoKICAgICAqIF8ucHVsbEFsbEJ5KGFycmF5LCBbeyAneCc6IDEgfSwgeyAneCc6IDMgfV0sICd4Jyk7CiAgICAgKiBjb25zb2xlLmxvZyhhcnJheSk7CiAgICAgKiAvLyA9PiBbeyAneCc6IDIgfV0KICAgICAqLwogICAgZnVuY3Rpb24gcHVsbEFsbEJ5KGFycmF5LCB2YWx1ZXMsIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoICYmIHZhbHVlcyAmJiB2YWx1ZXMubGVuZ3RoKQogICAgICAgID8gYmFzZVB1bGxBbGwoYXJyYXksIHZhbHVlcywgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDIpKQogICAgICAgIDogYXJyYXk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnB1bGxBbGxgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGNvbXBhcmF0b3JgIHdoaWNoCiAgICAgKiBpcyBpbnZva2VkIHRvIGNvbXBhcmUgZWxlbWVudHMgb2YgYGFycmF5YCB0byBgdmFsdWVzYC4gVGhlIGNvbXBhcmF0b3IgaXMKICAgICAqIGludm9rZWQgd2l0aCB0d28gYXJndW1lbnRzOiAoYXJyVmFsLCBvdGhWYWwpLgogICAgICoKICAgICAqICoqTm90ZToqKiBVbmxpa2UgYF8uZGlmZmVyZW5jZVdpdGhgLCB0aGlzIG1ldGhvZCBtdXRhdGVzIGBhcnJheWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjYuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIHtBcnJheX0gdmFsdWVzIFRoZSB2YWx1ZXMgdG8gcmVtb3ZlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NvbXBhcmF0b3JdIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGFycmF5ID0gW3sgJ3gnOiAxLCAneSc6IDIgfSwgeyAneCc6IDMsICd5JzogNCB9LCB7ICd4JzogNSwgJ3knOiA2IH1dOwogICAgICoKICAgICAqIF8ucHVsbEFsbFdpdGgoYXJyYXksIFt7ICd4JzogMywgJ3knOiA0IH1dLCBfLmlzRXF1YWwpOwogICAgICogY29uc29sZS5sb2coYXJyYXkpOwogICAgICogLy8gPT4gW3sgJ3gnOiAxLCAneSc6IDIgfSwgeyAneCc6IDUsICd5JzogNiB9XQogICAgICovCiAgICBmdW5jdGlvbiBwdWxsQWxsV2l0aChhcnJheSwgdmFsdWVzLCBjb21wYXJhdG9yKSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoICYmIHZhbHVlcyAmJiB2YWx1ZXMubGVuZ3RoKQogICAgICAgID8gYmFzZVB1bGxBbGwoYXJyYXksIHZhbHVlcywgdW5kZWZpbmVkLCBjb21wYXJhdG9yKQogICAgICAgIDogYXJyYXk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmVzIGVsZW1lbnRzIGZyb20gYGFycmF5YCBjb3JyZXNwb25kaW5nIHRvIGBpbmRleGVzYCBhbmQgcmV0dXJucyBhbgogICAgICogYXJyYXkgb2YgcmVtb3ZlZCBlbGVtZW50cy4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVW5saWtlIGBfLmF0YCwgdGhpcyBtZXRob2QgbXV0YXRlcyBgYXJyYXlgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7Li4uKG51bWJlcnxudW1iZXJbXSl9IFtpbmRleGVzXSBUaGUgaW5kZXhlcyBvZiBlbGVtZW50cyB0byByZW1vdmUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiByZW1vdmVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbJ2EnLCAnYicsICdjJywgJ2QnXTsKICAgICAqIHZhciBwdWxsZWQgPSBfLnB1bGxBdChhcnJheSwgWzEsIDNdKTsKICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhhcnJheSk7CiAgICAgKiAvLyA9PiBbJ2EnLCAnYyddCiAgICAgKgogICAgICogY29uc29sZS5sb2cocHVsbGVkKTsKICAgICAqIC8vID0+IFsnYicsICdkJ10KICAgICAqLwogICAgdmFyIHB1bGxBdCA9IGZsYXRSZXN0KGZ1bmN0aW9uKGFycmF5LCBpbmRleGVzKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aCwKICAgICAgICAgIHJlc3VsdCA9IGJhc2VBdChhcnJheSwgaW5kZXhlcyk7CgogICAgICBiYXNlUHVsbEF0KGFycmF5LCBhcnJheU1hcChpbmRleGVzLCBmdW5jdGlvbihpbmRleCkgewogICAgICAgIHJldHVybiBpc0luZGV4KGluZGV4LCBsZW5ndGgpID8gK2luZGV4IDogaW5kZXg7CiAgICAgIH0pLnNvcnQoY29tcGFyZUFzY2VuZGluZykpOwoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0pOwoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgZWxlbWVudHMgZnJvbSBgYXJyYXlgIHRoYXQgYHByZWRpY2F0ZWAgcmV0dXJucyB0cnV0aHkgZm9yCiAgICAgKiBhbmQgcmV0dXJucyBhbiBhcnJheSBvZiB0aGUgcmVtb3ZlZCBlbGVtZW50cy4gVGhlIHByZWRpY2F0ZSBpcyBpbnZva2VkCiAgICAgKiB3aXRoIHRocmVlIGFyZ3VtZW50czogKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAgICoKICAgICAqICoqTm90ZToqKiBVbmxpa2UgYF8uZmlsdGVyYCwgdGhpcyBtZXRob2QgbXV0YXRlcyBgYXJyYXlgLiBVc2UgYF8ucHVsbGAKICAgICAqIHRvIHB1bGwgZWxlbWVudHMgZnJvbSBhbiBhcnJheSBieSB2YWx1ZS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDIuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiByZW1vdmVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMiwgMywgNF07CiAgICAgKiB2YXIgZXZlbnMgPSBfLnJlbW92ZShhcnJheSwgZnVuY3Rpb24obikgewogICAgICogICByZXR1cm4gbiAlIDIgPT0gMDsKICAgICAqIH0pOwogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGFycmF5KTsKICAgICAqIC8vID0+IFsxLCAzXQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGV2ZW5zKTsKICAgICAqIC8vID0+IFsyLCA0XQogICAgICovCiAgICBmdW5jdGlvbiByZW1vdmUoYXJyYXksIHByZWRpY2F0ZSkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGlmICghKGFycmF5ICYmIGFycmF5Lmxlbmd0aCkpIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgaW5kZXhlcyA9IFtdLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgICAgcHJlZGljYXRlID0gZ2V0SXRlcmF0ZWUocHJlZGljYXRlLCAzKTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgICAgaW5kZXhlcy5wdXNoKGluZGV4KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYmFzZVB1bGxBdChhcnJheSwgaW5kZXhlcyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXZlcnNlcyBgYXJyYXlgIHNvIHRoYXQgdGhlIGZpcnN0IGVsZW1lbnQgYmVjb21lcyB0aGUgbGFzdCwgdGhlIHNlY29uZAogICAgICogZWxlbWVudCBiZWNvbWVzIHRoZSBzZWNvbmQgdG8gbGFzdCwgYW5kIHNvIG9uLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBtdXRhdGVzIGBhcnJheWAgYW5kIGlzIGJhc2VkIG9uCiAgICAgKiBbYEFycmF5I3JldmVyc2VgXShodHRwczovL21kbi5pby9BcnJheS9yZXZlcnNlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBtb2RpZnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGFycmF5ID0gWzEsIDIsIDNdOwogICAgICoKICAgICAqIF8ucmV2ZXJzZShhcnJheSk7CiAgICAgKiAvLyA9PiBbMywgMiwgMV0KICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhhcnJheSk7CiAgICAgKiAvLyA9PiBbMywgMiwgMV0KICAgICAqLwogICAgZnVuY3Rpb24gcmV2ZXJzZShhcnJheSkgewogICAgICByZXR1cm4gYXJyYXkgPT0gbnVsbCA/IGFycmF5IDogbmF0aXZlUmV2ZXJzZS5jYWxsKGFycmF5KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBzbGljZSBvZiBgYXJyYXlgIGZyb20gYHN0YXJ0YCB1cCB0bywgYnV0IG5vdCBpbmNsdWRpbmcsIGBlbmRgLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBpcyB1c2VkIGluc3RlYWQgb2YKICAgICAqIFtgQXJyYXkjc2xpY2VgXShodHRwczovL21kbi5pby9BcnJheS9zbGljZSkgdG8gZW5zdXJlIGRlbnNlIGFycmF5cyBhcmUKICAgICAqIHJldHVybmVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNsaWNlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydD0wXSBUaGUgc3RhcnQgcG9zaXRpb24uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2VuZD1hcnJheS5sZW5ndGhdIFRoZSBlbmQgcG9zaXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHNsaWNlIG9mIGBhcnJheWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNsaWNlKGFycmF5LCBzdGFydCwgZW5kKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKICAgICAgaWYgKCFsZW5ndGgpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgaWYgKGVuZCAmJiB0eXBlb2YgZW5kICE9ICdudW1iZXInICYmIGlzSXRlcmF0ZWVDYWxsKGFycmF5LCBzdGFydCwgZW5kKSkgewogICAgICAgIHN0YXJ0ID0gMDsKICAgICAgICBlbmQgPSBsZW5ndGg7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgc3RhcnQgPSBzdGFydCA9PSBudWxsID8gMCA6IHRvSW50ZWdlcihzdGFydCk7CiAgICAgICAgZW5kID0gZW5kID09PSB1bmRlZmluZWQgPyBsZW5ndGggOiB0b0ludGVnZXIoZW5kKTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZVNsaWNlKGFycmF5LCBzdGFydCwgZW5kKTsKICAgIH0KCiAgICAvKioKICAgICAqIFVzZXMgYSBiaW5hcnkgc2VhcmNoIHRvIGRldGVybWluZSB0aGUgbG93ZXN0IGluZGV4IGF0IHdoaWNoIGB2YWx1ZWAKICAgICAqIHNob3VsZCBiZSBpbnNlcnRlZCBpbnRvIGBhcnJheWAgaW4gb3JkZXIgdG8gbWFpbnRhaW4gaXRzIHNvcnQgb3JkZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgc29ydGVkIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBldmFsdWF0ZS4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IGF0IHdoaWNoIGB2YWx1ZWAgc2hvdWxkIGJlIGluc2VydGVkCiAgICAgKiAgaW50byBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnNvcnRlZEluZGV4KFszMCwgNTBdLCA0MCk7CiAgICAgKiAvLyA9PiAxCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSkgewogICAgICByZXR1cm4gYmFzZVNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnNvcnRlZEluZGV4YCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBpdGVyYXRlZWAKICAgICAqIHdoaWNoIGlzIGludm9rZWQgZm9yIGB2YWx1ZWAgYW5kIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgIHRvIGNvbXB1dGUgdGhlaXIKICAgICAqIHNvcnQgcmFua2luZy4gVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ6ICh2YWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgc29ydGVkIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBldmFsdWF0ZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgaXRlcmF0ZWUgaW52b2tlZCBwZXIgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IGF0IHdoaWNoIGB2YWx1ZWAgc2hvdWxkIGJlIGluc2VydGVkCiAgICAgKiAgaW50byBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0cyA9IFt7ICd4JzogNCB9LCB7ICd4JzogNSB9XTsKICAgICAqCiAgICAgKiBfLnNvcnRlZEluZGV4Qnkob2JqZWN0cywgeyAneCc6IDQgfSwgZnVuY3Rpb24obykgeyByZXR1cm4gby54OyB9KTsKICAgICAqIC8vID0+IDAKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8uc29ydGVkSW5kZXhCeShvYmplY3RzLCB7ICd4JzogNCB9LCAneCcpOwogICAgICogLy8gPT4gMAogICAgICovCiAgICBmdW5jdGlvbiBzb3J0ZWRJbmRleEJ5KGFycmF5LCB2YWx1ZSwgaXRlcmF0ZWUpIHsKICAgICAgcmV0dXJuIGJhc2VTb3J0ZWRJbmRleEJ5KGFycmF5LCB2YWx1ZSwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDIpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uaW5kZXhPZmAgZXhjZXB0IHRoYXQgaXQgcGVyZm9ybXMgYSBiaW5hcnkKICAgICAqIHNlYXJjaCBvbiBhIHNvcnRlZCBgYXJyYXlgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUsIGVsc2UgYC0xYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb3J0ZWRJbmRleE9mKFs0LCA1LCA1LCA1LCA2XSwgNSk7CiAgICAgKiAvLyA9PiAxCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvcnRlZEluZGV4T2YoYXJyYXksIHZhbHVlKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKICAgICAgaWYgKGxlbmd0aCkgewogICAgICAgIHZhciBpbmRleCA9IGJhc2VTb3J0ZWRJbmRleChhcnJheSwgdmFsdWUpOwogICAgICAgIGlmIChpbmRleCA8IGxlbmd0aCAmJiBlcShhcnJheVtpbmRleF0sIHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnNvcnRlZEluZGV4YCBleGNlcHQgdGhhdCBpdCByZXR1cm5zIHRoZSBoaWdoZXN0CiAgICAgKiBpbmRleCBhdCB3aGljaCBgdmFsdWVgIHNob3VsZCBiZSBpbnNlcnRlZCBpbnRvIGBhcnJheWAgaW4gb3JkZXIgdG8KICAgICAqIG1haW50YWluIGl0cyBzb3J0IG9yZGVyLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIHNvcnRlZCBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBhdCB3aGljaCBgdmFsdWVgIHNob3VsZCBiZSBpbnNlcnRlZAogICAgICogIGludG8gYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb3J0ZWRMYXN0SW5kZXgoWzQsIDUsIDUsIDUsIDZdLCA1KTsKICAgICAqIC8vID0+IDQKICAgICAqLwogICAgZnVuY3Rpb24gc29ydGVkTGFzdEluZGV4KGFycmF5LCB2YWx1ZSkgewogICAgICByZXR1cm4gYmFzZVNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSwgdHJ1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnNvcnRlZExhc3RJbmRleGAgZXhjZXB0IHRoYXQgaXQgYWNjZXB0cyBgaXRlcmF0ZWVgCiAgICAgKiB3aGljaCBpcyBpbnZva2VkIGZvciBgdmFsdWVgIGFuZCBlYWNoIGVsZW1lbnQgb2YgYGFycmF5YCB0byBjb21wdXRlIHRoZWlyCiAgICAgKiBzb3J0IHJhbmtpbmcuIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIHNvcnRlZCBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGl0ZXJhdGVlIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBhdCB3aGljaCBgdmFsdWVgIHNob3VsZCBiZSBpbnNlcnRlZAogICAgICogIGludG8gYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdHMgPSBbeyAneCc6IDQgfSwgeyAneCc6IDUgfV07CiAgICAgKgogICAgICogXy5zb3J0ZWRMYXN0SW5kZXhCeShvYmplY3RzLCB7ICd4JzogNCB9LCBmdW5jdGlvbihvKSB7IHJldHVybiBvLng7IH0pOwogICAgICogLy8gPT4gMQogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5zb3J0ZWRMYXN0SW5kZXhCeShvYmplY3RzLCB7ICd4JzogNCB9LCAneCcpOwogICAgICogLy8gPT4gMQogICAgICovCiAgICBmdW5jdGlvbiBzb3J0ZWRMYXN0SW5kZXhCeShhcnJheSwgdmFsdWUsIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiBiYXNlU29ydGVkSW5kZXhCeShhcnJheSwgdmFsdWUsIGdldEl0ZXJhdGVlKGl0ZXJhdGVlLCAyKSwgdHJ1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmxhc3RJbmRleE9mYCBleGNlcHQgdGhhdCBpdCBwZXJmb3JtcyBhIGJpbmFyeQogICAgICogc2VhcmNoIG9uIGEgc29ydGVkIGBhcnJheWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSwgZWxzZSBgLTFgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnNvcnRlZExhc3RJbmRleE9mKFs0LCA1LCA1LCA1LCA2XSwgNSk7CiAgICAgKiAvLyA9PiAzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvcnRlZExhc3RJbmRleE9mKGFycmF5LCB2YWx1ZSkgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPT0gbnVsbCA/IDAgOiBhcnJheS5sZW5ndGg7CiAgICAgIGlmIChsZW5ndGgpIHsKICAgICAgICB2YXIgaW5kZXggPSBiYXNlU29ydGVkSW5kZXgoYXJyYXksIHZhbHVlLCB0cnVlKSAtIDE7CiAgICAgICAgaWYgKGVxKGFycmF5W2luZGV4XSwgdmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8udW5pcWAgZXhjZXB0IHRoYXQgaXQncyBkZXNpZ25lZCBhbmQgb3B0aW1pemVkCiAgICAgKiBmb3Igc29ydGVkIGFycmF5cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZHVwbGljYXRlIGZyZWUgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc29ydGVkVW5pcShbMSwgMSwgMl0pOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvcnRlZFVuaXEoYXJyYXkpIHsKICAgICAgcmV0dXJuIChhcnJheSAmJiBhcnJheS5sZW5ndGgpCiAgICAgICAgPyBiYXNlU29ydGVkVW5pcShhcnJheSkKICAgICAgICA6IFtdOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy51bmlxQnlgIGV4Y2VwdCB0aGF0IGl0J3MgZGVzaWduZWQgYW5kIG9wdGltaXplZAogICAgICogZm9yIHNvcnRlZCBhcnJheXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZV0gVGhlIGl0ZXJhdGVlIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBkdXBsaWNhdGUgZnJlZSBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb3J0ZWRVbmlxQnkoWzEuMSwgMS4yLCAyLjMsIDIuNF0sIE1hdGguZmxvb3IpOwogICAgICogLy8gPT4gWzEuMSwgMi4zXQogICAgICovCiAgICBmdW5jdGlvbiBzb3J0ZWRVbmlxQnkoYXJyYXksIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKQogICAgICAgID8gYmFzZVNvcnRlZFVuaXEoYXJyYXksIGdldEl0ZXJhdGVlKGl0ZXJhdGVlLCAyKSkKICAgICAgICA6IFtdOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBhbGwgYnV0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGBhcnJheWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHNsaWNlIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udGFpbChbMSwgMiwgM10pOwogICAgICogLy8gPT4gWzIsIDNdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRhaWwoYXJyYXkpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoOwogICAgICByZXR1cm4gbGVuZ3RoID8gYmFzZVNsaWNlKGFycmF5LCAxLCBsZW5ndGgpIDogW107CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc2xpY2Ugb2YgYGFycmF5YCB3aXRoIGBuYCBlbGVtZW50cyB0YWtlbiBmcm9tIHRoZSBiZWdpbm5pbmcuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW249MV0gVGhlIG51bWJlciBvZiBlbGVtZW50cyB0byB0YWtlLgogICAgICogQHBhcmFtLSB7T2JqZWN0fSBbZ3VhcmRdIEVuYWJsZXMgdXNlIGFzIGFuIGl0ZXJhdGVlIGZvciBtZXRob2RzIGxpa2UgYF8ubWFwYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgc2xpY2Ugb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy50YWtlKFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBbMV0KICAgICAqCiAgICAgKiBfLnRha2UoWzEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IFsxLCAyXQogICAgICoKICAgICAqIF8udGFrZShbMSwgMiwgM10sIDUpOwogICAgICogLy8gPT4gWzEsIDIsIDNdCiAgICAgKgogICAgICogXy50YWtlKFsxLCAyLCAzXSwgMCk7CiAgICAgKiAvLyA9PiBbXQogICAgICovCiAgICBmdW5jdGlvbiB0YWtlKGFycmF5LCBuLCBndWFyZCkgewogICAgICBpZiAoIShhcnJheSAmJiBhcnJheS5sZW5ndGgpKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIG4gPSAoZ3VhcmQgfHwgbiA9PT0gdW5kZWZpbmVkKSA/IDEgOiB0b0ludGVnZXIobik7CiAgICAgIHJldHVybiBiYXNlU2xpY2UoYXJyYXksIDAsIG4gPCAwID8gMCA6IG4pOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNsaWNlIG9mIGBhcnJheWAgd2l0aCBgbmAgZWxlbWVudHMgdGFrZW4gZnJvbSB0aGUgZW5kLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtuPTFdIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gdGFrZS4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBFbmFibGVzIHVzZSBhcyBhbiBpdGVyYXRlZSBmb3IgbWV0aG9kcyBsaWtlIGBfLm1hcGAuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHNsaWNlIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udGFrZVJpZ2h0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBbM10KICAgICAqCiAgICAgKiBfLnRha2VSaWdodChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzIsIDNdCiAgICAgKgogICAgICogXy50YWtlUmlnaHQoWzEsIDIsIDNdLCA1KTsKICAgICAqIC8vID0+IFsxLCAyLCAzXQogICAgICoKICAgICAqIF8udGFrZVJpZ2h0KFsxLCAyLCAzXSwgMCk7CiAgICAgKiAvLyA9PiBbXQogICAgICovCiAgICBmdW5jdGlvbiB0YWtlUmlnaHQoYXJyYXksIG4sIGd1YXJkKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA9PSBudWxsID8gMCA6IGFycmF5Lmxlbmd0aDsKICAgICAgaWYgKCFsZW5ndGgpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgbiA9IChndWFyZCB8fCBuID09PSB1bmRlZmluZWQpID8gMSA6IHRvSW50ZWdlcihuKTsKICAgICAgbiA9IGxlbmd0aCAtIG47CiAgICAgIHJldHVybiBiYXNlU2xpY2UoYXJyYXksIG4gPCAwID8gMCA6IG4sIGxlbmd0aCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc2xpY2Ugb2YgYGFycmF5YCB3aXRoIGVsZW1lbnRzIHRha2VuIGZyb20gdGhlIGVuZC4gRWxlbWVudHMgYXJlCiAgICAgKiB0YWtlbiB1bnRpbCBgcHJlZGljYXRlYCByZXR1cm5zIGZhbHNleS4gVGhlIHByZWRpY2F0ZSBpcyBpbnZva2VkIHdpdGgKICAgICAqIHRocmVlIGFyZ3VtZW50czogKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3ByZWRpY2F0ZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBzbGljZSBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgdXNlcnMgPSBbCiAgICAgKiAgIHsgJ3VzZXInOiAnYmFybmV5JywgICdhY3RpdmUnOiB0cnVlIH0sCiAgICAgKiAgIHsgJ3VzZXInOiAnZnJlZCcsICAgICdhY3RpdmUnOiBmYWxzZSB9LAogICAgICogICB7ICd1c2VyJzogJ3BlYmJsZXMnLCAnYWN0aXZlJzogZmFsc2UgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLnRha2VSaWdodFdoaWxlKHVzZXJzLCBmdW5jdGlvbihvKSB7IHJldHVybiAhby5hY3RpdmU7IH0pOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgWydmcmVkJywgJ3BlYmJsZXMnXQogICAgICoKICAgICAqIC8vIFRoZSBgXy5tYXRjaGVzYCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLnRha2VSaWdodFdoaWxlKHVzZXJzLCB7ICd1c2VyJzogJ3BlYmJsZXMnLCAnYWN0aXZlJzogZmFsc2UgfSk7CiAgICAgKiAvLyA9PiBvYmplY3RzIGZvciBbJ3BlYmJsZXMnXQogICAgICoKICAgICAqIC8vIFRoZSBgXy5tYXRjaGVzUHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8udGFrZVJpZ2h0V2hpbGUodXNlcnMsIFsnYWN0aXZlJywgZmFsc2VdKTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFsnZnJlZCcsICdwZWJibGVzJ10KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8udGFrZVJpZ2h0V2hpbGUodXNlcnMsICdhY3RpdmUnKTsKICAgICAqIC8vID0+IFtdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRha2VSaWdodFdoaWxlKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgICAgcmV0dXJuIChhcnJheSAmJiBhcnJheS5sZW5ndGgpCiAgICAgICAgPyBiYXNlV2hpbGUoYXJyYXksIGdldEl0ZXJhdGVlKHByZWRpY2F0ZSwgMyksIGZhbHNlLCB0cnVlKQogICAgICAgIDogW107CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc2xpY2Ugb2YgYGFycmF5YCB3aXRoIGVsZW1lbnRzIHRha2VuIGZyb20gdGhlIGJlZ2lubmluZy4gRWxlbWVudHMKICAgICAqIGFyZSB0YWtlbiB1bnRpbCBgcHJlZGljYXRlYCByZXR1cm5zIGZhbHNleS4gVGhlIHByZWRpY2F0ZSBpcyBpbnZva2VkIHdpdGgKICAgICAqIHRocmVlIGFyZ3VtZW50czogKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3ByZWRpY2F0ZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBzbGljZSBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgdXNlcnMgPSBbCiAgICAgKiAgIHsgJ3VzZXInOiAnYmFybmV5JywgICdhY3RpdmUnOiBmYWxzZSB9LAogICAgICogICB7ICd1c2VyJzogJ2ZyZWQnLCAgICAnYWN0aXZlJzogZmFsc2UgfSwKICAgICAqICAgeyAndXNlcic6ICdwZWJibGVzJywgJ2FjdGl2ZSc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLnRha2VXaGlsZSh1c2VycywgZnVuY3Rpb24obykgeyByZXR1cm4gIW8uYWN0aXZlOyB9KTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFsnYmFybmV5JywgJ2ZyZWQnXQogICAgICoKICAgICAqIC8vIFRoZSBgXy5tYXRjaGVzYCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLnRha2VXaGlsZSh1c2VycywgeyAndXNlcic6ICdiYXJuZXknLCAnYWN0aXZlJzogZmFsc2UgfSk7CiAgICAgKiAvLyA9PiBvYmplY3RzIGZvciBbJ2Jhcm5leSddCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNQcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy50YWtlV2hpbGUodXNlcnMsIFsnYWN0aXZlJywgZmFsc2VdKTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFsnYmFybmV5JywgJ2ZyZWQnXQogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy50YWtlV2hpbGUodXNlcnMsICdhY3RpdmUnKTsKICAgICAqIC8vID0+IFtdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRha2VXaGlsZShhcnJheSwgcHJlZGljYXRlKSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKQogICAgICAgID8gYmFzZVdoaWxlKGFycmF5LCBnZXRJdGVyYXRlZShwcmVkaWNhdGUsIDMpKQogICAgICAgIDogW107CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMsIGluIG9yZGVyLCBmcm9tIGFsbCBnaXZlbiBhcnJheXMgdXNpbmcKICAgICAqIFtgU2FtZVZhbHVlWmVyb2BdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXNhbWV2YWx1ZXplcm8pCiAgICAgKiBmb3IgZXF1YWxpdHkgY29tcGFyaXNvbnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXlzXSBUaGUgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBjb21iaW5lZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pb24oWzJdLCBbMSwgMl0pOwogICAgICogLy8gPT4gWzIsIDFdCiAgICAgKi8KICAgIHZhciB1bmlvbiA9IGJhc2VSZXN0KGZ1bmN0aW9uKGFycmF5cykgewogICAgICByZXR1cm4gYmFzZVVuaXEoYmFzZUZsYXR0ZW4oYXJyYXlzLCAxLCBpc0FycmF5TGlrZU9iamVjdCwgdHJ1ZSkpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnVuaW9uYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBpdGVyYXRlZWAgd2hpY2ggaXMKICAgICAqIGludm9rZWQgZm9yIGVhY2ggZWxlbWVudCBvZiBlYWNoIGBhcnJheXNgIHRvIGdlbmVyYXRlIHRoZSBjcml0ZXJpb24gYnkKICAgICAqIHdoaWNoIHVuaXF1ZW5lc3MgaXMgY29tcHV0ZWQuIFJlc3VsdCB2YWx1ZXMgYXJlIGNob3NlbiBmcm9tIHRoZSBmaXJzdAogICAgICogYXJyYXkgaW4gd2hpY2ggdGhlIHZhbHVlIG9jY3Vycy4gVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ6CiAgICAgKiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW2FycmF5c10gVGhlIGFycmF5cyB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgYXJyYXkgb2YgY29tYmluZWQgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnVuaW9uQnkoWzIuMV0sIFsxLjIsIDIuM10sIE1hdGguZmxvb3IpOwogICAgICogLy8gPT4gWzIuMSwgMS4yXQogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy51bmlvbkJ5KFt7ICd4JzogMSB9XSwgW3sgJ3gnOiAyIH0sIHsgJ3gnOiAxIH1dLCAneCcpOwogICAgICogLy8gPT4gW3sgJ3gnOiAxIH0sIHsgJ3gnOiAyIH1dCiAgICAgKi8KICAgIHZhciB1bmlvbkJ5ID0gYmFzZVJlc3QoZnVuY3Rpb24oYXJyYXlzKSB7CiAgICAgIHZhciBpdGVyYXRlZSA9IGxhc3QoYXJyYXlzKTsKICAgICAgaWYgKGlzQXJyYXlMaWtlT2JqZWN0KGl0ZXJhdGVlKSkgewogICAgICAgIGl0ZXJhdGVlID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlVW5pcShiYXNlRmxhdHRlbihhcnJheXMsIDEsIGlzQXJyYXlMaWtlT2JqZWN0LCB0cnVlKSwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDIpKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy51bmlvbmAgZXhjZXB0IHRoYXQgaXQgYWNjZXB0cyBgY29tcGFyYXRvcmAgd2hpY2gKICAgICAqIGlzIGludm9rZWQgdG8gY29tcGFyZSBlbGVtZW50cyBvZiBgYXJyYXlzYC4gUmVzdWx0IHZhbHVlcyBhcmUgY2hvc2VuIGZyb20KICAgICAqIHRoZSBmaXJzdCBhcnJheSBpbiB3aGljaCB0aGUgdmFsdWUgb2NjdXJzLiBUaGUgY29tcGFyYXRvciBpcyBpbnZva2VkCiAgICAgKiB3aXRoIHR3byBhcmd1bWVudHM6IChhcnJWYWwsIG90aFZhbCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXlzXSBUaGUgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY29tcGFyYXRvcl0gVGhlIGNvbXBhcmF0b3IgaW52b2tlZCBwZXIgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5IG9mIGNvbWJpbmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdHMgPSBbeyAneCc6IDEsICd5JzogMiB9LCB7ICd4JzogMiwgJ3knOiAxIH1dOwogICAgICogdmFyIG90aGVycyA9IFt7ICd4JzogMSwgJ3knOiAxIH0sIHsgJ3gnOiAxLCAneSc6IDIgfV07CiAgICAgKgogICAgICogXy51bmlvbldpdGgob2JqZWN0cywgb3RoZXJzLCBfLmlzRXF1YWwpOwogICAgICogLy8gPT4gW3sgJ3gnOiAxLCAneSc6IDIgfSwgeyAneCc6IDIsICd5JzogMSB9LCB7ICd4JzogMSwgJ3knOiAxIH1dCiAgICAgKi8KICAgIHZhciB1bmlvbldpdGggPSBiYXNlUmVzdChmdW5jdGlvbihhcnJheXMpIHsKICAgICAgdmFyIGNvbXBhcmF0b3IgPSBsYXN0KGFycmF5cyk7CiAgICAgIGNvbXBhcmF0b3IgPSB0eXBlb2YgY29tcGFyYXRvciA9PSAnZnVuY3Rpb24nID8gY29tcGFyYXRvciA6IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIGJhc2VVbmlxKGJhc2VGbGF0dGVuKGFycmF5cywgMSwgaXNBcnJheUxpa2VPYmplY3QsIHRydWUpLCB1bmRlZmluZWQsIGNvbXBhcmF0b3IpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZHVwbGljYXRlLWZyZWUgdmVyc2lvbiBvZiBhbiBhcnJheSwgdXNpbmcKICAgICAqIFtgU2FtZVZhbHVlWmVyb2BdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXNhbWV2YWx1ZXplcm8pCiAgICAgKiBmb3IgZXF1YWxpdHkgY29tcGFyaXNvbnMsIGluIHdoaWNoIG9ubHkgdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgZWFjaCBlbGVtZW50CiAgICAgKiBpcyBrZXB0LiBUaGUgb3JkZXIgb2YgcmVzdWx0IHZhbHVlcyBpcyBkZXRlcm1pbmVkIGJ5IHRoZSBvcmRlciB0aGV5IG9jY3VyCiAgICAgKiBpbiB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGR1cGxpY2F0ZSBmcmVlIGFycmF5LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnVuaXEoWzIsIDEsIDJdKTsKICAgICAqIC8vID0+IFsyLCAxXQogICAgICovCiAgICBmdW5jdGlvbiB1bmlxKGFycmF5KSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKSA/IGJhc2VVbmlxKGFycmF5KSA6IFtdOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy51bmlxYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBpdGVyYXRlZWAgd2hpY2ggaXMKICAgICAqIGludm9rZWQgZm9yIGVhY2ggZWxlbWVudCBpbiBgYXJyYXlgIHRvIGdlbmVyYXRlIHRoZSBjcml0ZXJpb24gYnkgd2hpY2gKICAgICAqIHVuaXF1ZW5lc3MgaXMgY29tcHV0ZWQuIFRoZSBvcmRlciBvZiByZXN1bHQgdmFsdWVzIGlzIGRldGVybWluZWQgYnkgdGhlCiAgICAgKiBvcmRlciB0aGV5IG9jY3VyIGluIHRoZSBhcnJheS4gVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ6CiAgICAgKiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGl0ZXJhdGVlIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBkdXBsaWNhdGUgZnJlZSBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy51bmlxQnkoWzIuMSwgMS4yLCAyLjNdLCBNYXRoLmZsb29yKTsKICAgICAqIC8vID0+IFsyLjEsIDEuMl0KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8udW5pcUJ5KFt7ICd4JzogMSB9LCB7ICd4JzogMiB9LCB7ICd4JzogMSB9XSwgJ3gnKTsKICAgICAqIC8vID0+IFt7ICd4JzogMSB9LCB7ICd4JzogMiB9XQogICAgICovCiAgICBmdW5jdGlvbiB1bmlxQnkoYXJyYXksIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKSA/IGJhc2VVbmlxKGFycmF5LCBnZXRJdGVyYXRlZShpdGVyYXRlZSwgMikpIDogW107CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnVuaXFgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGNvbXBhcmF0b3JgIHdoaWNoCiAgICAgKiBpcyBpbnZva2VkIHRvIGNvbXBhcmUgZWxlbWVudHMgb2YgYGFycmF5YC4gVGhlIG9yZGVyIG9mIHJlc3VsdCB2YWx1ZXMgaXMKICAgICAqIGRldGVybWluZWQgYnkgdGhlIG9yZGVyIHRoZXkgb2NjdXIgaW4gdGhlIGFycmF5LlRoZSBjb21wYXJhdG9yIGlzIGludm9rZWQKICAgICAqIHdpdGggdHdvIGFyZ3VtZW50czogKGFyclZhbCwgb3RoVmFsKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NvbXBhcmF0b3JdIFRoZSBjb21wYXJhdG9yIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBkdXBsaWNhdGUgZnJlZSBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdHMgPSBbeyAneCc6IDEsICd5JzogMiB9LCB7ICd4JzogMiwgJ3knOiAxIH0sIHsgJ3gnOiAxLCAneSc6IDIgfV07CiAgICAgKgogICAgICogXy51bmlxV2l0aChvYmplY3RzLCBfLmlzRXF1YWwpOwogICAgICogLy8gPT4gW3sgJ3gnOiAxLCAneSc6IDIgfSwgeyAneCc6IDIsICd5JzogMSB9XQogICAgICovCiAgICBmdW5jdGlvbiB1bmlxV2l0aChhcnJheSwgY29tcGFyYXRvcikgewogICAgICBjb21wYXJhdG9yID0gdHlwZW9mIGNvbXBhcmF0b3IgPT0gJ2Z1bmN0aW9uJyA/IGNvbXBhcmF0b3IgOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKSA/IGJhc2VVbmlxKGFycmF5LCB1bmRlZmluZWQsIGNvbXBhcmF0b3IpIDogW107CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnppcGAgZXhjZXB0IHRoYXQgaXQgYWNjZXB0cyBhbiBhcnJheSBvZiBncm91cGVkCiAgICAgKiBlbGVtZW50cyBhbmQgY3JlYXRlcyBhbiBhcnJheSByZWdyb3VwaW5nIHRoZSBlbGVtZW50cyB0byB0aGVpciBwcmUtemlwCiAgICAgKiBjb25maWd1cmF0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMS4yLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IG9mIGdyb3VwZWQgZWxlbWVudHMgdG8gcHJvY2Vzcy4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5IG9mIHJlZ3JvdXBlZCBlbGVtZW50cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHppcHBlZCA9IF8uemlwKFsnYScsICdiJ10sIFsxLCAyXSwgW3RydWUsIGZhbHNlXSk7CiAgICAgKiAvLyA9PiBbWydhJywgMSwgdHJ1ZV0sIFsnYicsIDIsIGZhbHNlXV0KICAgICAqCiAgICAgKiBfLnVuemlwKHppcHBlZCk7CiAgICAgKiAvLyA9PiBbWydhJywgJ2InXSwgWzEsIDJdLCBbdHJ1ZSwgZmFsc2VdXQogICAgICovCiAgICBmdW5jdGlvbiB1bnppcChhcnJheSkgewogICAgICBpZiAoIShhcnJheSAmJiBhcnJheS5sZW5ndGgpKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIHZhciBsZW5ndGggPSAwOwogICAgICBhcnJheSA9IGFycmF5RmlsdGVyKGFycmF5LCBmdW5jdGlvbihncm91cCkgewogICAgICAgIGlmIChpc0FycmF5TGlrZU9iamVjdChncm91cCkpIHsKICAgICAgICAgIGxlbmd0aCA9IG5hdGl2ZU1heChncm91cC5sZW5ndGgsIGxlbmd0aCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gYmFzZVRpbWVzKGxlbmd0aCwgZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICByZXR1cm4gYXJyYXlNYXAoYXJyYXksIGJhc2VQcm9wZXJ0eShpbmRleCkpOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8udW56aXBgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGl0ZXJhdGVlYCB0byBzcGVjaWZ5CiAgICAgKiBob3cgcmVncm91cGVkIHZhbHVlcyBzaG91bGQgYmUgY29tYmluZWQuIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggdGhlCiAgICAgKiBlbGVtZW50cyBvZiBlYWNoIGdyb3VwOiAoLi4uZ3JvdXApLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy44LjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IG9mIGdyb3VwZWQgZWxlbWVudHMgdG8gcHJvY2Vzcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gdG8gY29tYmluZQogICAgICogIHJlZ3JvdXBlZCB2YWx1ZXMuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiByZWdyb3VwZWQgZWxlbWVudHMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciB6aXBwZWQgPSBfLnppcChbMSwgMl0sIFsxMCwgMjBdLCBbMTAwLCAyMDBdKTsKICAgICAqIC8vID0+IFtbMSwgMTAsIDEwMF0sIFsyLCAyMCwgMjAwXV0KICAgICAqCiAgICAgKiBfLnVuemlwV2l0aCh6aXBwZWQsIF8uYWRkKTsKICAgICAqIC8vID0+IFszLCAzMCwgMzAwXQogICAgICovCiAgICBmdW5jdGlvbiB1bnppcFdpdGgoYXJyYXksIGl0ZXJhdGVlKSB7CiAgICAgIGlmICghKGFycmF5ICYmIGFycmF5Lmxlbmd0aCkpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHVuemlwKGFycmF5KTsKICAgICAgaWYgKGl0ZXJhdGVlID09IG51bGwpIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJldHVybiBhcnJheU1hcChyZXN1bHQsIGZ1bmN0aW9uKGdyb3VwKSB7CiAgICAgICAgcmV0dXJuIGFwcGx5KGl0ZXJhdGVlLCB1bmRlZmluZWQsIGdyb3VwKTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGV4Y2x1ZGluZyBhbGwgZ2l2ZW4gdmFsdWVzIHVzaW5nCiAgICAgKiBbYFNhbWVWYWx1ZVplcm9gXShodHRwOi8vZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy1zYW1ldmFsdWV6ZXJvKQogICAgICogZm9yIGVxdWFsaXR5IGNvbXBhcmlzb25zLgogICAgICoKICAgICAqICoqTm90ZToqKiBVbmxpa2UgYF8ucHVsbGAsIHRoaXMgbWV0aG9kIHJldHVybnMgYSBuZXcgYXJyYXkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7Li4uKn0gW3ZhbHVlc10gVGhlIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgYXJyYXkgb2YgZmlsdGVyZWQgdmFsdWVzLgogICAgICogQHNlZSBfLmRpZmZlcmVuY2UsIF8ueG9yCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ud2l0aG91dChbMiwgMSwgMiwgM10sIDEsIDIpOwogICAgICogLy8gPT4gWzNdCiAgICAgKi8KICAgIHZhciB3aXRob3V0ID0gYmFzZVJlc3QoZnVuY3Rpb24oYXJyYXksIHZhbHVlcykgewogICAgICByZXR1cm4gaXNBcnJheUxpa2VPYmplY3QoYXJyYXkpCiAgICAgICAgPyBiYXNlRGlmZmVyZW5jZShhcnJheSwgdmFsdWVzKQogICAgICAgIDogW107CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdW5pcXVlIHZhbHVlcyB0aGF0IGlzIHRoZQogICAgICogW3N5bW1ldHJpYyBkaWZmZXJlbmNlXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TeW1tZXRyaWNfZGlmZmVyZW5jZSkKICAgICAqIG9mIHRoZSBnaXZlbiBhcnJheXMuIFRoZSBvcmRlciBvZiByZXN1bHQgdmFsdWVzIGlzIGRldGVybWluZWQgYnkgdGhlIG9yZGVyCiAgICAgKiB0aGV5IG9jY3VyIGluIHRoZSBhcnJheXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAyLjQuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXlzXSBUaGUgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAc2VlIF8uZGlmZmVyZW5jZSwgXy53aXRob3V0CiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ueG9yKFsyLCAxXSwgWzIsIDNdKTsKICAgICAqIC8vID0+IFsxLCAzXQogICAgICovCiAgICB2YXIgeG9yID0gYmFzZVJlc3QoZnVuY3Rpb24oYXJyYXlzKSB7CiAgICAgIHJldHVybiBiYXNlWG9yKGFycmF5RmlsdGVyKGFycmF5cywgaXNBcnJheUxpa2VPYmplY3QpKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy54b3JgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGl0ZXJhdGVlYCB3aGljaCBpcwogICAgICogaW52b2tlZCBmb3IgZWFjaCBlbGVtZW50IG9mIGVhY2ggYGFycmF5c2AgdG8gZ2VuZXJhdGUgdGhlIGNyaXRlcmlvbiBieQogICAgICogd2hpY2ggYnkgd2hpY2ggdGhleSdyZSBjb21wYXJlZC4gVGhlIG9yZGVyIG9mIHJlc3VsdCB2YWx1ZXMgaXMgZGV0ZXJtaW5lZAogICAgICogYnkgdGhlIG9yZGVyIHRoZXkgb2NjdXIgaW4gdGhlIGFycmF5cy4gVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQgd2l0aCBvbmUKICAgICAqIGFyZ3VtZW50OiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBBcnJheQogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW2FycmF5c10gVGhlIGFycmF5cyB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgYXJyYXkgb2YgZmlsdGVyZWQgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnhvckJ5KFsyLjEsIDEuMl0sIFsyLjMsIDMuNF0sIE1hdGguZmxvb3IpOwogICAgICogLy8gPT4gWzEuMiwgMy40XQogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy54b3JCeShbeyAneCc6IDEgfV0sIFt7ICd4JzogMiB9LCB7ICd4JzogMSB9XSwgJ3gnKTsKICAgICAqIC8vID0+IFt7ICd4JzogMiB9XQogICAgICovCiAgICB2YXIgeG9yQnkgPSBiYXNlUmVzdChmdW5jdGlvbihhcnJheXMpIHsKICAgICAgdmFyIGl0ZXJhdGVlID0gbGFzdChhcnJheXMpOwogICAgICBpZiAoaXNBcnJheUxpa2VPYmplY3QoaXRlcmF0ZWUpKSB7CiAgICAgICAgaXRlcmF0ZWUgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGJhc2VYb3IoYXJyYXlGaWx0ZXIoYXJyYXlzLCBpc0FycmF5TGlrZU9iamVjdCksIGdldEl0ZXJhdGVlKGl0ZXJhdGVlLCAyKSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8ueG9yYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBjb21wYXJhdG9yYCB3aGljaCBpcwogICAgICogaW52b2tlZCB0byBjb21wYXJlIGVsZW1lbnRzIG9mIGBhcnJheXNgLiBUaGUgb3JkZXIgb2YgcmVzdWx0IHZhbHVlcyBpcwogICAgICogZGV0ZXJtaW5lZCBieSB0aGUgb3JkZXIgdGhleSBvY2N1ciBpbiB0aGUgYXJyYXlzLiBUaGUgY29tcGFyYXRvciBpcyBpbnZva2VkCiAgICAgKiB3aXRoIHR3byBhcmd1bWVudHM6IChhcnJWYWwsIG90aFZhbCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXlzXSBUaGUgYXJyYXlzIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY29tcGFyYXRvcl0gVGhlIGNvbXBhcmF0b3IgaW52b2tlZCBwZXIgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5IG9mIGZpbHRlcmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdHMgPSBbeyAneCc6IDEsICd5JzogMiB9LCB7ICd4JzogMiwgJ3knOiAxIH1dOwogICAgICogdmFyIG90aGVycyA9IFt7ICd4JzogMSwgJ3knOiAxIH0sIHsgJ3gnOiAxLCAneSc6IDIgfV07CiAgICAgKgogICAgICogXy54b3JXaXRoKG9iamVjdHMsIG90aGVycywgXy5pc0VxdWFsKTsKICAgICAqIC8vID0+IFt7ICd4JzogMiwgJ3knOiAxIH0sIHsgJ3gnOiAxLCAneSc6IDEgfV0KICAgICAqLwogICAgdmFyIHhvcldpdGggPSBiYXNlUmVzdChmdW5jdGlvbihhcnJheXMpIHsKICAgICAgdmFyIGNvbXBhcmF0b3IgPSBsYXN0KGFycmF5cyk7CiAgICAgIGNvbXBhcmF0b3IgPSB0eXBlb2YgY29tcGFyYXRvciA9PSAnZnVuY3Rpb24nID8gY29tcGFyYXRvciA6IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIGJhc2VYb3IoYXJyYXlGaWx0ZXIoYXJyYXlzLCBpc0FycmF5TGlrZU9iamVjdCksIHVuZGVmaW5lZCwgY29tcGFyYXRvcik7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZ3JvdXBlZCBlbGVtZW50cywgdGhlIGZpcnN0IG9mIHdoaWNoIGNvbnRhaW5zIHRoZQogICAgICogZmlyc3QgZWxlbWVudHMgb2YgdGhlIGdpdmVuIGFycmF5cywgdGhlIHNlY29uZCBvZiB3aGljaCBjb250YWlucyB0aGUKICAgICAqIHNlY29uZCBlbGVtZW50cyBvZiB0aGUgZ2l2ZW4gYXJyYXlzLCBhbmQgc28gb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXlzXSBUaGUgYXJyYXlzIHRvIHByb2Nlc3MuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheSBvZiBncm91cGVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnppcChbJ2EnLCAnYiddLCBbMSwgMl0sIFt0cnVlLCBmYWxzZV0pOwogICAgICogLy8gPT4gW1snYScsIDEsIHRydWVdLCBbJ2InLCAyLCBmYWxzZV1dCiAgICAgKi8KICAgIHZhciB6aXAgPSBiYXNlUmVzdCh1bnppcCk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZyb21QYWlyc2AgZXhjZXB0IHRoYXQgaXQgYWNjZXB0cyB0d28gYXJyYXlzLAogICAgICogb25lIG9mIHByb3BlcnR5IGlkZW50aWZpZXJzIGFuZCBvbmUgb2YgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjQuMAogICAgICogQGNhdGVnb3J5IEFycmF5CiAgICAgKiBAcGFyYW0ge0FycmF5fSBbcHJvcHM9W11dIFRoZSBwcm9wZXJ0eSBpZGVudGlmaWVycy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFt2YWx1ZXM9W11dIFRoZSBwcm9wZXJ0eSB2YWx1ZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBuZXcgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnppcE9iamVjdChbJ2EnLCAnYiddLCBbMSwgMl0pOwogICAgICogLy8gPT4geyAnYSc6IDEsICdiJzogMiB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHppcE9iamVjdChwcm9wcywgdmFsdWVzKSB7CiAgICAgIHJldHVybiBiYXNlWmlwT2JqZWN0KHByb3BzIHx8IFtdLCB2YWx1ZXMgfHwgW10sIGFzc2lnblZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uemlwT2JqZWN0YCBleGNlcHQgdGhhdCBpdCBzdXBwb3J0cyBwcm9wZXJ0eSBwYXRocy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7QXJyYXl9IFtwcm9wcz1bXV0gVGhlIHByb3BlcnR5IGlkZW50aWZpZXJzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3ZhbHVlcz1bXV0gVGhlIHByb3BlcnR5IHZhbHVlcy4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uemlwT2JqZWN0RGVlcChbJ2EuYlswXS5jJywgJ2EuYlsxXS5kJ10sIFsxLCAyXSk7CiAgICAgKiAvLyA9PiB7ICdhJzogeyAnYic6IFt7ICdjJzogMSB9LCB7ICdkJzogMiB9XSB9IH0KICAgICAqLwogICAgZnVuY3Rpb24gemlwT2JqZWN0RGVlcChwcm9wcywgdmFsdWVzKSB7CiAgICAgIHJldHVybiBiYXNlWmlwT2JqZWN0KHByb3BzIHx8IFtdLCB2YWx1ZXMgfHwgW10sIGJhc2VTZXQpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy56aXBgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGl0ZXJhdGVlYCB0byBzcGVjaWZ5CiAgICAgKiBob3cgZ3JvdXBlZCB2YWx1ZXMgc2hvdWxkIGJlIGNvbWJpbmVkLiBUaGUgaXRlcmF0ZWUgaXMgaW52b2tlZCB3aXRoIHRoZQogICAgICogZWxlbWVudHMgb2YgZWFjaCBncm91cDogKC4uLmdyb3VwKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuOC4wCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXkKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheXNdIFRoZSBhcnJheXMgdG8gcHJvY2Vzcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gdG8gY29tYmluZQogICAgICogIGdyb3VwZWQgdmFsdWVzLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgYXJyYXkgb2YgZ3JvdXBlZCBlbGVtZW50cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy56aXBXaXRoKFsxLCAyXSwgWzEwLCAyMF0sIFsxMDAsIDIwMF0sIGZ1bmN0aW9uKGEsIGIsIGMpIHsKICAgICAqICAgcmV0dXJuIGEgKyBiICsgYzsKICAgICAqIH0pOwogICAgICogLy8gPT4gWzExMSwgMjIyXQogICAgICovCiAgICB2YXIgemlwV2l0aCA9IGJhc2VSZXN0KGZ1bmN0aW9uKGFycmF5cykgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXlzLmxlbmd0aCwKICAgICAgICAgIGl0ZXJhdGVlID0gbGVuZ3RoID4gMSA/IGFycmF5c1tsZW5ndGggLSAxXSA6IHVuZGVmaW5lZDsKCiAgICAgIGl0ZXJhdGVlID0gdHlwZW9mIGl0ZXJhdGVlID09ICdmdW5jdGlvbicgPyAoYXJyYXlzLnBvcCgpLCBpdGVyYXRlZSkgOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiB1bnppcFdpdGgoYXJyYXlzLCBpdGVyYXRlZSk7CiAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYGxvZGFzaGAgd3JhcHBlciBpbnN0YW5jZSB0aGF0IHdyYXBzIGB2YWx1ZWAgd2l0aCBleHBsaWNpdCBtZXRob2QKICAgICAqIGNoYWluIHNlcXVlbmNlcyBlbmFibGVkLiBUaGUgcmVzdWx0IG9mIHN1Y2ggc2VxdWVuY2VzIG11c3QgYmUgdW53cmFwcGVkCiAgICAgKiB3aXRoIGBfI3ZhbHVlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDEuMy4wCiAgICAgKiBAY2F0ZWdvcnkgU2VxCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IGBsb2Rhc2hgIHdyYXBwZXIgaW5zdGFuY2UuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciB1c2VycyA9IFsKICAgICAqICAgeyAndXNlcic6ICdiYXJuZXknLCAgJ2FnZSc6IDM2IH0sCiAgICAgKiAgIHsgJ3VzZXInOiAnZnJlZCcsICAgICdhZ2UnOiA0MCB9LAogICAgICogICB7ICd1c2VyJzogJ3BlYmJsZXMnLCAnYWdlJzogMSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIHZhciB5b3VuZ2VzdCA9IF8KICAgICAqICAgLmNoYWluKHVzZXJzKQogICAgICogICAuc29ydEJ5KCdhZ2UnKQogICAgICogICAubWFwKGZ1bmN0aW9uKG8pIHsKICAgICAqICAgICByZXR1cm4gby51c2VyICsgJyBpcyAnICsgby5hZ2U7CiAgICAgKiAgIH0pCiAgICAgKiAgIC5oZWFkKCkKICAgICAqICAgLnZhbHVlKCk7CiAgICAgKiAvLyA9PiAncGViYmxlcyBpcyAxJwogICAgICovCiAgICBmdW5jdGlvbiBjaGFpbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gbG9kYXNoKHZhbHVlKTsKICAgICAgcmVzdWx0Ll9fY2hhaW5fXyA9IHRydWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpbnZva2VzIGBpbnRlcmNlcHRvcmAgYW5kIHJldHVybnMgYHZhbHVlYC4gVGhlIGludGVyY2VwdG9yCiAgICAgKiBpcyBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OyAodmFsdWUpLiBUaGUgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0bwogICAgICogInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiBzZXF1ZW5jZSBpbiBvcmRlciB0byBtb2RpZnkgaW50ZXJtZWRpYXRlIHJlc3VsdHMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IFNlcQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcHJvdmlkZSB0byBgaW50ZXJjZXB0b3JgLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW50ZXJjZXB0b3IgVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDNdKQogICAgICogIC50YXAoZnVuY3Rpb24oYXJyYXkpIHsKICAgICAqICAgIC8vIE11dGF0ZSBpbnB1dCBhcnJheS4KICAgICAqICAgIGFycmF5LnBvcCgpOwogICAgICogIH0pCiAgICAgKiAgLnJldmVyc2UoKQogICAgICogIC52YWx1ZSgpOwogICAgICogLy8gPT4gWzIsIDFdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRhcCh2YWx1ZSwgaW50ZXJjZXB0b3IpIHsKICAgICAgaW50ZXJjZXB0b3IodmFsdWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnRhcGAgZXhjZXB0IHRoYXQgaXQgcmV0dXJucyB0aGUgcmVzdWx0IG9mIGBpbnRlcmNlcHRvcmAuCiAgICAgKiBUaGUgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAicGFzcyB0aHJ1IiB2YWx1ZXMgcmVwbGFjaW5nIGludGVybWVkaWF0ZQogICAgICogcmVzdWx0cyBpbiBhIG1ldGhvZCBjaGFpbiBzZXF1ZW5jZS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU2VxCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwcm92aWRlIHRvIGBpbnRlcmNlcHRvcmAuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpbnRlcmNlcHRvciBUaGUgZnVuY3Rpb24gdG8gaW52b2tlLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc3VsdCBvZiBgaW50ZXJjZXB0b3JgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfKCcgIGFiYyAgJykKICAgICAqICAuY2hhaW4oKQogICAgICogIC50cmltKCkKICAgICAqICAudGhydShmdW5jdGlvbih2YWx1ZSkgewogICAgICogICAgcmV0dXJuIFt2YWx1ZV07CiAgICAgKiAgfSkKICAgICAqICAudmFsdWUoKTsKICAgICAqIC8vID0+IFsnYWJjJ10KICAgICAqLwogICAgZnVuY3Rpb24gdGhydSh2YWx1ZSwgaW50ZXJjZXB0b3IpIHsKICAgICAgcmV0dXJuIGludGVyY2VwdG9yKHZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIHRoZSB3cmFwcGVyIHZlcnNpb24gb2YgYF8uYXRgLgogICAgICoKICAgICAqIEBuYW1lIGF0CiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDEuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU2VxCiAgICAgKiBAcGFyYW0gey4uLihzdHJpbmd8c3RyaW5nW10pfSBbcGF0aHNdIFRoZSBwcm9wZXJ0eSBwYXRocyB0byBwaWNrLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IGBsb2Rhc2hgIHdyYXBwZXIgaW5zdGFuY2UuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICdhJzogW3sgJ2InOiB7ICdjJzogMyB9IH0sIDRdIH07CiAgICAgKgogICAgICogXyhvYmplY3QpLmF0KFsnYVswXS5iLmMnLCAnYVsxXSddKS52YWx1ZSgpOwogICAgICogLy8gPT4gWzMsIDRdCiAgICAgKi8KICAgIHZhciB3cmFwcGVyQXQgPSBmbGF0UmVzdChmdW5jdGlvbihwYXRocykgewogICAgICB2YXIgbGVuZ3RoID0gcGF0aHMubGVuZ3RoLAogICAgICAgICAgc3RhcnQgPSBsZW5ndGggPyBwYXRoc1swXSA6IDAsCiAgICAgICAgICB2YWx1ZSA9IHRoaXMuX193cmFwcGVkX18sCiAgICAgICAgICBpbnRlcmNlcHRvciA9IGZ1bmN0aW9uKG9iamVjdCkgeyByZXR1cm4gYmFzZUF0KG9iamVjdCwgcGF0aHMpOyB9OwoKICAgICAgaWYgKGxlbmd0aCA+IDEgfHwgdGhpcy5fX2FjdGlvbnNfXy5sZW5ndGggfHwKICAgICAgICAgICEodmFsdWUgaW5zdGFuY2VvZiBMYXp5V3JhcHBlcikgfHwgIWlzSW5kZXgoc3RhcnQpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudGhydShpbnRlcmNlcHRvcik7CiAgICAgIH0KICAgICAgdmFsdWUgPSB2YWx1ZS5zbGljZShzdGFydCwgK3N0YXJ0ICsgKGxlbmd0aCA/IDEgOiAwKSk7CiAgICAgIHZhbHVlLl9fYWN0aW9uc19fLnB1c2goewogICAgICAgICdmdW5jJzogdGhydSwKICAgICAgICAnYXJncyc6IFtpbnRlcmNlcHRvcl0sCiAgICAgICAgJ3RoaXNBcmcnOiB1bmRlZmluZWQKICAgICAgfSk7CiAgICAgIHJldHVybiBuZXcgTG9kYXNoV3JhcHBlcih2YWx1ZSwgdGhpcy5fX2NoYWluX18pLnRocnUoZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgICBpZiAobGVuZ3RoICYmICFhcnJheS5sZW5ndGgpIHsKICAgICAgICAgIGFycmF5LnB1c2godW5kZWZpbmVkKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9KTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGBsb2Rhc2hgIHdyYXBwZXIgaW5zdGFuY2Ugd2l0aCBleHBsaWNpdCBtZXRob2QgY2hhaW4gc2VxdWVuY2VzIGVuYWJsZWQuCiAgICAgKgogICAgICogQG5hbWUgY2hhaW4KICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBTZXEKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBgbG9kYXNoYCB3cmFwcGVyIGluc3RhbmNlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgdXNlcnMgPSBbCiAgICAgKiAgIHsgJ3VzZXInOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sCiAgICAgKiAgIHsgJ3VzZXInOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gQSBzZXF1ZW5jZSB3aXRob3V0IGV4cGxpY2l0IGNoYWluaW5nLgogICAgICogXyh1c2VycykuaGVhZCgpOwogICAgICogLy8gPT4geyAndXNlcic6ICdiYXJuZXknLCAnYWdlJzogMzYgfQogICAgICoKICAgICAqIC8vIEEgc2VxdWVuY2Ugd2l0aCBleHBsaWNpdCBjaGFpbmluZy4KICAgICAqIF8odXNlcnMpCiAgICAgKiAgIC5jaGFpbigpCiAgICAgKiAgIC5oZWFkKCkKICAgICAqICAgLnBpY2soJ3VzZXInKQogICAgICogICAudmFsdWUoKTsKICAgICAqIC8vID0+IHsgJ3VzZXInOiAnYmFybmV5JyB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJDaGFpbigpIHsKICAgICAgcmV0dXJuIGNoYWluKHRoaXMpOwogICAgfQoKICAgIC8qKgogICAgICogRXhlY3V0ZXMgdGhlIGNoYWluIHNlcXVlbmNlIGFuZCByZXR1cm5zIHRoZSB3cmFwcGVkIHJlc3VsdC4KICAgICAqCiAgICAgKiBAbmFtZSBjb21taXQKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4yLjAKICAgICAqIEBjYXRlZ29yeSBTZXEKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBgbG9kYXNoYCB3cmFwcGVyIGluc3RhbmNlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMl07CiAgICAgKiB2YXIgd3JhcHBlZCA9IF8oYXJyYXkpLnB1c2goMyk7CiAgICAgKgogICAgICogY29uc29sZS5sb2coYXJyYXkpOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogd3JhcHBlZCA9IHdyYXBwZWQuY29tbWl0KCk7CiAgICAgKiBjb25zb2xlLmxvZyhhcnJheSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqCiAgICAgKiB3cmFwcGVkLmxhc3QoKTsKICAgICAqIC8vID0+IDMKICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhhcnJheSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gd3JhcHBlckNvbW1pdCgpIHsKICAgICAgcmV0dXJuIG5ldyBMb2Rhc2hXcmFwcGVyKHRoaXMudmFsdWUoKSwgdGhpcy5fX2NoYWluX18pOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgbmV4dCB2YWx1ZSBvbiBhIHdyYXBwZWQgb2JqZWN0IGZvbGxvd2luZyB0aGUKICAgICAqIFtpdGVyYXRvciBwcm90b2NvbF0oaHR0cHM6Ly9tZG4uaW8vaXRlcmF0aW9uX3Byb3RvY29scyNpdGVyYXRvcikuCiAgICAgKgogICAgICogQG5hbWUgbmV4dAogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IFNlcQogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV4dCBpdGVyYXRvciB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHdyYXBwZWQgPSBfKFsxLCAyXSk7CiAgICAgKgogICAgICogd3JhcHBlZC5uZXh0KCk7CiAgICAgKiAvLyA9PiB7ICdkb25lJzogZmFsc2UsICd2YWx1ZSc6IDEgfQogICAgICoKICAgICAqIHdyYXBwZWQubmV4dCgpOwogICAgICogLy8gPT4geyAnZG9uZSc6IGZhbHNlLCAndmFsdWUnOiAyIH0KICAgICAqCiAgICAgKiB3cmFwcGVkLm5leHQoKTsKICAgICAqIC8vID0+IHsgJ2RvbmUnOiB0cnVlLCAndmFsdWUnOiB1bmRlZmluZWQgfQogICAgICovCiAgICBmdW5jdGlvbiB3cmFwcGVyTmV4dCgpIHsKICAgICAgaWYgKHRoaXMuX192YWx1ZXNfXyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5fX3ZhbHVlc19fID0gdG9BcnJheSh0aGlzLnZhbHVlKCkpOwogICAgICB9CiAgICAgIHZhciBkb25lID0gdGhpcy5fX2luZGV4X18gPj0gdGhpcy5fX3ZhbHVlc19fLmxlbmd0aCwKICAgICAgICAgIHZhbHVlID0gZG9uZSA/IHVuZGVmaW5lZCA6IHRoaXMuX192YWx1ZXNfX1t0aGlzLl9faW5kZXhfXysrXTsKCiAgICAgIHJldHVybiB7ICdkb25lJzogZG9uZSwgJ3ZhbHVlJzogdmFsdWUgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEVuYWJsZXMgdGhlIHdyYXBwZXIgdG8gYmUgaXRlcmFibGUuCiAgICAgKgogICAgICogQG5hbWUgU3ltYm9sLml0ZXJhdG9yCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU2VxCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSB3cmFwcGVyIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHdyYXBwZWQgPSBfKFsxLCAyXSk7CiAgICAgKgogICAgICogd3JhcHBlZFtTeW1ib2wuaXRlcmF0b3JdKCkgPT09IHdyYXBwZWQ7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogQXJyYXkuZnJvbSh3cmFwcGVkKTsKICAgICAqIC8vID0+IFsxLCAyXQogICAgICovCiAgICBmdW5jdGlvbiB3cmFwcGVyVG9JdGVyYXRvcigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgY2xvbmUgb2YgdGhlIGNoYWluIHNlcXVlbmNlIHBsYW50aW5nIGB2YWx1ZWAgYXMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICAgKgogICAgICogQG5hbWUgcGxhbnQKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4yLjAKICAgICAqIEBjYXRlZ29yeSBTZXEKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBsYW50LgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IGBsb2Rhc2hgIHdyYXBwZXIgaW5zdGFuY2UuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIHNxdWFyZShuKSB7CiAgICAgKiAgIHJldHVybiBuICogbjsKICAgICAqIH0KICAgICAqCiAgICAgKiB2YXIgd3JhcHBlZCA9IF8oWzEsIDJdKS5tYXAoc3F1YXJlKTsKICAgICAqIHZhciBvdGhlciA9IHdyYXBwZWQucGxhbnQoWzMsIDRdKTsKICAgICAqCiAgICAgKiBvdGhlci52YWx1ZSgpOwogICAgICogLy8gPT4gWzksIDE2XQogICAgICoKICAgICAqIHdyYXBwZWQudmFsdWUoKTsKICAgICAqIC8vID0+IFsxLCA0XQogICAgICovCiAgICBmdW5jdGlvbiB3cmFwcGVyUGxhbnQodmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCwKICAgICAgICAgIHBhcmVudCA9IHRoaXM7CgogICAgICB3aGlsZSAocGFyZW50IGluc3RhbmNlb2YgYmFzZUxvZGFzaCkgewogICAgICAgIHZhciBjbG9uZSA9IHdyYXBwZXJDbG9uZShwYXJlbnQpOwogICAgICAgIGNsb25lLl9faW5kZXhfXyA9IDA7CiAgICAgICAgY2xvbmUuX192YWx1ZXNfXyA9IHVuZGVmaW5lZDsKICAgICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgICBwcmV2aW91cy5fX3dyYXBwZWRfXyA9IGNsb25lOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQgPSBjbG9uZTsKICAgICAgICB9CiAgICAgICAgdmFyIHByZXZpb3VzID0gY2xvbmU7CiAgICAgICAgcGFyZW50ID0gcGFyZW50Ll9fd3JhcHBlZF9fOwogICAgICB9CiAgICAgIHByZXZpb3VzLl9fd3JhcHBlZF9fID0gdmFsdWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyB0aGUgd3JhcHBlciB2ZXJzaW9uIG9mIGBfLnJldmVyc2VgLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBtdXRhdGVzIHRoZSB3cmFwcGVkIGFycmF5LgogICAgICoKICAgICAqIEBuYW1lIHJldmVyc2UKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBTZXEKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBgbG9kYXNoYCB3cmFwcGVyIGluc3RhbmNlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMiwgM107CiAgICAgKgogICAgICogXyhhcnJheSkucmV2ZXJzZSgpLnZhbHVlKCkKICAgICAqIC8vID0+IFszLCAyLCAxXQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGFycmF5KTsKICAgICAqIC8vID0+IFszLCAyLCAxXQogICAgICovCiAgICBmdW5jdGlvbiB3cmFwcGVyUmV2ZXJzZSgpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5fX3dyYXBwZWRfXzsKICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgTGF6eVdyYXBwZXIpIHsKICAgICAgICB2YXIgd3JhcHBlZCA9IHZhbHVlOwogICAgICAgIGlmICh0aGlzLl9fYWN0aW9uc19fLmxlbmd0aCkgewogICAgICAgICAgd3JhcHBlZCA9IG5ldyBMYXp5V3JhcHBlcih0aGlzKTsKICAgICAgICB9CiAgICAgICAgd3JhcHBlZCA9IHdyYXBwZWQucmV2ZXJzZSgpOwogICAgICAgIHdyYXBwZWQuX19hY3Rpb25zX18ucHVzaCh7CiAgICAgICAgICAnZnVuYyc6IHRocnUsCiAgICAgICAgICAnYXJncyc6IFtyZXZlcnNlXSwKICAgICAgICAgICd0aGlzQXJnJzogdW5kZWZpbmVkCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG5ldyBMb2Rhc2hXcmFwcGVyKHdyYXBwZWQsIHRoaXMuX19jaGFpbl9fKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy50aHJ1KHJldmVyc2UpOwogICAgfQoKICAgIC8qKgogICAgICogRXhlY3V0ZXMgdGhlIGNoYWluIHNlcXVlbmNlIHRvIHJlc29sdmUgdGhlIHVud3JhcHBlZCB2YWx1ZS4KICAgICAqCiAgICAgKiBAbmFtZSB2YWx1ZQogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGFsaWFzIHRvSlNPTiwgdmFsdWVPZgogICAgICogQGNhdGVnb3J5IFNlcQogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHVud3JhcHBlZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXyhbMSwgMiwgM10pLnZhbHVlKCk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gd3JhcHBlclZhbHVlKCkgewogICAgICByZXR1cm4gYmFzZVdyYXBwZXJWYWx1ZSh0aGlzLl9fd3JhcHBlZF9fLCB0aGlzLl9fYWN0aW9uc19fKTsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiBrZXlzIGdlbmVyYXRlZCBmcm9tIHRoZSByZXN1bHRzIG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBvZiBgY29sbGVjdGlvbmAgdGhydSBgaXRlcmF0ZWVgLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZSBvZgogICAgICogZWFjaCBrZXkgaXMgdGhlIG51bWJlciBvZiB0aW1lcyB0aGUga2V5IHdhcyByZXR1cm5lZCBieSBgaXRlcmF0ZWVgLiBUaGUKICAgICAqIGl0ZXJhdGVlIGlzIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ6ICh2YWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjUuMAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb24KICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgaXRlcmF0ZWUgdG8gdHJhbnNmb3JtIGtleXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzYuMSwgNC4yLCA2LjNdLCBNYXRoLmZsb29yKTsKICAgICAqIC8vID0+IHsgJzQnOiAxLCAnNic6IDIgfQogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5jb3VudEJ5KFsnb25lJywgJ3R3bycsICd0aHJlZSddLCAnbGVuZ3RoJyk7CiAgICAgKiAvLyA9PiB7ICczJzogMiwgJzUnOiAxIH0KICAgICAqLwogICAgdmFyIGNvdW50QnkgPSBjcmVhdGVBZ2dyZWdhdG9yKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChyZXN1bHQsIGtleSkpIHsKICAgICAgICArK3Jlc3VsdFtrZXldOwogICAgICB9IGVsc2UgewogICAgICAgIGJhc2VBc3NpZ25WYWx1ZShyZXN1bHQsIGtleSwgMSk7CiAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGBwcmVkaWNhdGVgIHJldHVybnMgdHJ1dGh5IGZvciAqKmFsbCoqIGVsZW1lbnRzIG9mIGBjb2xsZWN0aW9uYC4KICAgICAqIEl0ZXJhdGlvbiBpcyBzdG9wcGVkIG9uY2UgYHByZWRpY2F0ZWAgcmV0dXJucyBmYWxzZXkuIFRoZSBwcmVkaWNhdGUgaXMKICAgICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM6ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgcmV0dXJucyBgdHJ1ZWAgZm9yCiAgICAgKiBbZW1wdHkgY29sbGVjdGlvbnNdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0VtcHR5X3NldCkgYmVjYXVzZQogICAgICogW2V2ZXJ5dGhpbmcgaXMgdHJ1ZV0oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVmFjdW91c190cnV0aCkgb2YKICAgICAqIGVsZW1lbnRzIG9mIGVtcHR5IGNvbGxlY3Rpb25zLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9uCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gRW5hYmxlcyB1c2UgYXMgYW4gaXRlcmF0ZWUgZm9yIG1ldGhvZHMgbGlrZSBgXy5tYXBgLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFsbCBlbGVtZW50cyBwYXNzIHRoZSBwcmVkaWNhdGUgY2hlY2ssCiAgICAgKiAgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmV2ZXJ5KFt0cnVlLCAxLCBudWxsLCAneWVzJ10sIEJvb2xlYW4pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiB2YXIgdXNlcnMgPSBbCiAgICAgKiAgIHsgJ3VzZXInOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAnYWN0aXZlJzogZmFsc2UgfSwKICAgICAqICAgeyAndXNlcic6ICdmcmVkJywgICAnYWdlJzogNDAsICdhY3RpdmUnOiBmYWxzZSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIFRoZSBgXy5tYXRjaGVzYCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmV2ZXJ5KHVzZXJzLCB7ICd1c2VyJzogJ2Jhcm5leScsICdhY3RpdmUnOiBmYWxzZSB9KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNQcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5ldmVyeSh1c2VycywgWydhY3RpdmUnLCBmYWxzZV0pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5ldmVyeSh1c2VycywgJ2FjdGl2ZScpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gZXZlcnkoY29sbGVjdGlvbiwgcHJlZGljYXRlLCBndWFyZCkgewogICAgICB2YXIgZnVuYyA9IGlzQXJyYXkoY29sbGVjdGlvbikgPyBhcnJheUV2ZXJ5IDogYmFzZUV2ZXJ5OwogICAgICBpZiAoZ3VhcmQgJiYgaXNJdGVyYXRlZUNhbGwoY29sbGVjdGlvbiwgcHJlZGljYXRlLCBndWFyZCkpIHsKICAgICAgICBwcmVkaWNhdGUgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmMoY29sbGVjdGlvbiwgZ2V0SXRlcmF0ZWUocHJlZGljYXRlLCAzKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIGVsZW1lbnRzIG9mIGBjb2xsZWN0aW9uYCwgcmV0dXJuaW5nIGFuIGFycmF5IG9mIGFsbCBlbGVtZW50cwogICAgICogYHByZWRpY2F0ZWAgcmV0dXJucyB0cnV0aHkgZm9yLiBUaGUgcHJlZGljYXRlIGlzIGludm9rZWQgd2l0aCB0aHJlZQogICAgICogYXJndW1lbnRzOiAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogKipOb3RlOioqIFVubGlrZSBgXy5yZW1vdmVgLCB0aGlzIG1ldGhvZCByZXR1cm5zIGEgbmV3IGFycmF5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9uCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBmaWx0ZXJlZCBhcnJheS4KICAgICAqIEBzZWUgXy5yZWplY3QKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gWwogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICdhZ2UnOiAzNiwgJ2FjdGl2ZSc6IHRydWUgfSwKICAgICAqICAgeyAndXNlcic6ICdmcmVkJywgICAnYWdlJzogNDAsICdhY3RpdmUnOiBmYWxzZSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uZmlsdGVyKHVzZXJzLCBmdW5jdGlvbihvKSB7IHJldHVybiAhby5hY3RpdmU7IH0pOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgWydmcmVkJ10KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc2AgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5maWx0ZXIodXNlcnMsIHsgJ2FnZSc6IDM2LCAnYWN0aXZlJzogdHJ1ZSB9KTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFsnYmFybmV5J10KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc1Byb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbHRlcih1c2VycywgWydhY3RpdmUnLCBmYWxzZV0pOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgWydmcmVkJ10KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8uZmlsdGVyKHVzZXJzLCAnYWN0aXZlJyk7CiAgICAgKiAvLyA9PiBvYmplY3RzIGZvciBbJ2Jhcm5leSddCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbHRlcihjb2xsZWN0aW9uLCBwcmVkaWNhdGUpIHsKICAgICAgdmFyIGZ1bmMgPSBpc0FycmF5KGNvbGxlY3Rpb24pID8gYXJyYXlGaWx0ZXIgOiBiYXNlRmlsdGVyOwogICAgICByZXR1cm4gZnVuYyhjb2xsZWN0aW9uLCBnZXRJdGVyYXRlZShwcmVkaWNhdGUsIDMpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEl0ZXJhdGVzIG92ZXIgZWxlbWVudHMgb2YgYGNvbGxlY3Rpb25gLCByZXR1cm5pbmcgdGhlIGZpcnN0IGVsZW1lbnQKICAgICAqIGBwcmVkaWNhdGVgIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlIHByZWRpY2F0ZSBpcyBpbnZva2VkIHdpdGggdGhyZWUKICAgICAqIGFyZ3VtZW50czogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9uCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3ByZWRpY2F0ZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG1hdGNoZWQgZWxlbWVudCwgZWxzZSBgdW5kZWZpbmVkYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gWwogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICAnYWdlJzogMzYsICdhY3RpdmUnOiB0cnVlIH0sCiAgICAgKiAgIHsgJ3VzZXInOiAnZnJlZCcsICAgICdhZ2UnOiA0MCwgJ2FjdGl2ZSc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ3VzZXInOiAncGViYmxlcycsICdhZ2UnOiAxLCAgJ2FjdGl2ZSc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLmZpbmQodXNlcnMsIGZ1bmN0aW9uKG8pIHsgcmV0dXJuIG8uYWdlIDwgNDA7IH0pOwogICAgICogLy8gPT4gb2JqZWN0IGZvciAnYmFybmV5JwogICAgICoKICAgICAqIC8vIFRoZSBgXy5tYXRjaGVzYCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbmQodXNlcnMsIHsgJ2FnZSc6IDEsICdhY3RpdmUnOiB0cnVlIH0pOwogICAgICogLy8gPT4gb2JqZWN0IGZvciAncGViYmxlcycKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc1Byb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbmQodXNlcnMsIFsnYWN0aXZlJywgZmFsc2VdKTsKICAgICAqIC8vID0+IG9iamVjdCBmb3IgJ2ZyZWQnCiAgICAgKgogICAgICogLy8gVGhlIGBfLnByb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbmQodXNlcnMsICdhY3RpdmUnKTsKICAgICAqIC8vID0+IG9iamVjdCBmb3IgJ2Jhcm5leScKICAgICAqLwogICAgdmFyIGZpbmQgPSBjcmVhdGVGaW5kKGZpbmRJbmRleCk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMgb2YKICAgICAqIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAyLjAuMAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb24KICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Zyb21JbmRleD1jb2xsZWN0aW9uLmxlbmd0aC0xXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgbWF0Y2hlZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpbmRMYXN0KFsxLCAyLCAzLCA0XSwgZnVuY3Rpb24obikgewogICAgICogICByZXR1cm4gbiAlIDIgPT0gMTsKICAgICAqIH0pOwogICAgICogLy8gPT4gMwogICAgICovCiAgICB2YXIgZmluZExhc3QgPSBjcmVhdGVGaW5kKGZpbmRMYXN0SW5kZXgpOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZsYXR0ZW5lZCBhcnJheSBvZiB2YWx1ZXMgYnkgcnVubmluZyBlYWNoIGVsZW1lbnQgaW4gYGNvbGxlY3Rpb25gCiAgICAgKiB0aHJ1IGBpdGVyYXRlZWAgYW5kIGZsYXR0ZW5pbmcgdGhlIG1hcHBlZCByZXN1bHRzLiBUaGUgaXRlcmF0ZWUgaXMgaW52b2tlZAogICAgICogd2l0aCB0aHJlZSBhcmd1bWVudHM6ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIGR1cGxpY2F0ZShuKSB7CiAgICAgKiAgIHJldHVybiBbbiwgbl07CiAgICAgKiB9CiAgICAgKgogICAgICogXy5mbGF0TWFwKFsxLCAyXSwgZHVwbGljYXRlKTsKICAgICAqIC8vID0+IFsxLCAxLCAyLCAyXQogICAgICovCiAgICBmdW5jdGlvbiBmbGF0TWFwKGNvbGxlY3Rpb24sIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiBiYXNlRmxhdHRlbihtYXAoY29sbGVjdGlvbiwgaXRlcmF0ZWUpLCAxKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZmxhdE1hcGAgZXhjZXB0IHRoYXQgaXQgcmVjdXJzaXZlbHkgZmxhdHRlbnMgdGhlCiAgICAgKiBtYXBwZWQgcmVzdWx0cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuNy4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIGR1cGxpY2F0ZShuKSB7CiAgICAgKiAgIHJldHVybiBbW1tuLCBuXV1dOwogICAgICogfQogICAgICoKICAgICAqIF8uZmxhdE1hcERlZXAoWzEsIDJdLCBkdXBsaWNhdGUpOwogICAgICogLy8gPT4gWzEsIDEsIDIsIDJdCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZsYXRNYXBEZWVwKGNvbGxlY3Rpb24sIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiBiYXNlRmxhdHRlbihtYXAoY29sbGVjdGlvbiwgaXRlcmF0ZWUpLCBJTkZJTklUWSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZsYXRNYXBgIGV4Y2VwdCB0aGF0IGl0IHJlY3Vyc2l2ZWx5IGZsYXR0ZW5zIHRoZQogICAgICogbWFwcGVkIHJlc3VsdHMgdXAgdG8gYGRlcHRoYCB0aW1lcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuNy4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2RlcHRoPTFdIFRoZSBtYXhpbXVtIHJlY3Vyc2lvbiBkZXB0aC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGZsYXR0ZW5lZCBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gZHVwbGljYXRlKG4pIHsKICAgICAqICAgcmV0dXJuIFtbW24sIG5dXV07CiAgICAgKiB9CiAgICAgKgogICAgICogXy5mbGF0TWFwRGVwdGgoWzEsIDJdLCBkdXBsaWNhdGUsIDIpOwogICAgICogLy8gPT4gW1sxLCAxXSwgWzIsIDJdXQogICAgICovCiAgICBmdW5jdGlvbiBmbGF0TWFwRGVwdGgoY29sbGVjdGlvbiwgaXRlcmF0ZWUsIGRlcHRoKSB7CiAgICAgIGRlcHRoID0gZGVwdGggPT09IHVuZGVmaW5lZCA/IDEgOiB0b0ludGVnZXIoZGVwdGgpOwogICAgICByZXR1cm4gYmFzZUZsYXR0ZW4obWFwKGNvbGxlY3Rpb24sIGl0ZXJhdGVlKSwgZGVwdGgpOwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZiBgY29sbGVjdGlvbmAgYW5kIGludm9rZXMgYGl0ZXJhdGVlYCBmb3IgZWFjaCBlbGVtZW50LgogICAgICogVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM6ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqIEl0ZXJhdGVlIGZ1bmN0aW9ucyBtYXkgZXhpdCBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogQXMgd2l0aCBvdGhlciAiQ29sbGVjdGlvbnMiIG1ldGhvZHMsIG9iamVjdHMgd2l0aCBhICJsZW5ndGgiCiAgICAgKiBwcm9wZXJ0eSBhcmUgaXRlcmF0ZWQgbGlrZSBhcnJheXMuIFRvIGF2b2lkIHRoaXMgYmVoYXZpb3IgdXNlIGBfLmZvckluYAogICAgICogb3IgYF8uZm9yT3duYCBmb3Igb2JqZWN0IGl0ZXJhdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAYWxpYXMgZWFjaAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb24KICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fE9iamVjdH0gUmV0dXJucyBgY29sbGVjdGlvbmAuCiAgICAgKiBAc2VlIF8uZm9yRWFjaFJpZ2h0CiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZm9yRWFjaChbMSwgMl0sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKHZhbHVlKTsKICAgICAqIH0pOwogICAgICogLy8gPT4gTG9ncyBgMWAgdGhlbiBgMmAuCiAgICAgKgogICAgICogXy5mb3JFYWNoKHsgJ2EnOiAxLCAnYic6IDIgfSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICogICBjb25zb2xlLmxvZyhrZXkpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBMb2dzICdhJyB0aGVuICdiJyAoaXRlcmF0aW9uIG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKS4KICAgICAqLwogICAgZnVuY3Rpb24gZm9yRWFjaChjb2xsZWN0aW9uLCBpdGVyYXRlZSkgewogICAgICB2YXIgZnVuYyA9IGlzQXJyYXkoY29sbGVjdGlvbikgPyBhcnJheUVhY2ggOiBiYXNlRWFjaDsKICAgICAgcmV0dXJuIGZ1bmMoY29sbGVjdGlvbiwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDMpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9yRWFjaGAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZgogICAgICogYGNvbGxlY3Rpb25gIGZyb20gcmlnaHQgdG8gbGVmdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDIuMC4wCiAgICAgKiBAYWxpYXMgZWFjaFJpZ2h0CiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fSBSZXR1cm5zIGBjb2xsZWN0aW9uYC4KICAgICAqIEBzZWUgXy5mb3JFYWNoCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZm9yRWFjaFJpZ2h0KFsxLCAyXSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAqICAgY29uc29sZS5sb2codmFsdWUpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBMb2dzIGAyYCB0aGVuIGAxYC4KICAgICAqLwogICAgZnVuY3Rpb24gZm9yRWFjaFJpZ2h0KGNvbGxlY3Rpb24sIGl0ZXJhdGVlKSB7CiAgICAgIHZhciBmdW5jID0gaXNBcnJheShjb2xsZWN0aW9uKSA/IGFycmF5RWFjaFJpZ2h0IDogYmFzZUVhY2hSaWdodDsKICAgICAgcmV0dXJuIGZ1bmMoY29sbGVjdGlvbiwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDMpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIGtleXMgZ2VuZXJhdGVkIGZyb20gdGhlIHJlc3VsdHMgb2YgcnVubmluZwogICAgICogZWFjaCBlbGVtZW50IG9mIGBjb2xsZWN0aW9uYCB0aHJ1IGBpdGVyYXRlZWAuIFRoZSBvcmRlciBvZiBncm91cGVkIHZhbHVlcwogICAgICogaXMgZGV0ZXJtaW5lZCBieSB0aGUgb3JkZXIgdGhleSBvY2N1ciBpbiBgY29sbGVjdGlvbmAuIFRoZSBjb3JyZXNwb25kaW5nCiAgICAgKiB2YWx1ZSBvZiBlYWNoIGtleSBpcyBhbiBhcnJheSBvZiBlbGVtZW50cyByZXNwb25zaWJsZSBmb3IgZ2VuZXJhdGluZyB0aGUKICAgICAqIGtleS4gVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ6ICh2YWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb24KICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgaXRlcmF0ZWUgdG8gdHJhbnNmb3JtIGtleXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmdyb3VwQnkoWzYuMSwgNC4yLCA2LjNdLCBNYXRoLmZsb29yKTsKICAgICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjNdIH0KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8uZ3JvdXBCeShbJ29uZScsICd0d28nLCAndGhyZWUnXSwgJ2xlbmd0aCcpOwogICAgICogLy8gPT4geyAnMyc6IFsnb25lJywgJ3R3byddLCAnNSc6IFsndGhyZWUnXSB9CiAgICAgKi8KICAgIHZhciBncm91cEJ5ID0gY3JlYXRlQWdncmVnYXRvcihmdW5jdGlvbihyZXN1bHQsIHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwocmVzdWx0LCBrZXkpKSB7CiAgICAgICAgcmVzdWx0W2tleV0ucHVzaCh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYmFzZUFzc2lnblZhbHVlKHJlc3VsdCwga2V5LCBbdmFsdWVdKTsKICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBpbiBgY29sbGVjdGlvbmAuIElmIGBjb2xsZWN0aW9uYCBpcyBhIHN0cmluZywgaXQncwogICAgICogY2hlY2tlZCBmb3IgYSBzdWJzdHJpbmcgb2YgYHZhbHVlYCwgb3RoZXJ3aXNlCiAgICAgKiBbYFNhbWVWYWx1ZVplcm9gXShodHRwOi8vZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy1zYW1ldmFsdWV6ZXJvKQogICAgICogaXMgdXNlZCBmb3IgZXF1YWxpdHkgY29tcGFyaXNvbnMuIElmIGBmcm9tSW5kZXhgIGlzIG5lZ2F0aXZlLCBpdCdzIHVzZWQgYXMKICAgICAqIHRoZSBvZmZzZXQgZnJvbSB0aGUgZW5kIG9mIGBjb2xsZWN0aW9uYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAgICogQHBhcmFtLSB7T2JqZWN0fSBbZ3VhcmRdIEVuYWJsZXMgdXNlIGFzIGFuIGl0ZXJhdGVlIGZvciBtZXRob2RzIGxpa2UgYF8ucmVkdWNlYC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW5jbHVkZXMoWzEsIDIsIDNdLCAxKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmluY2x1ZGVzKFsxLCAyLCAzXSwgMSwgMik7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaW5jbHVkZXMoeyAnYSc6IDEsICdiJzogMiB9LCAxKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmluY2x1ZGVzKCdhYmNkJywgJ2JjJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluY2x1ZGVzKGNvbGxlY3Rpb24sIHZhbHVlLCBmcm9tSW5kZXgsIGd1YXJkKSB7CiAgICAgIGNvbGxlY3Rpb24gPSBpc0FycmF5TGlrZShjb2xsZWN0aW9uKSA/IGNvbGxlY3Rpb24gOiB2YWx1ZXMoY29sbGVjdGlvbik7CiAgICAgIGZyb21JbmRleCA9IChmcm9tSW5kZXggJiYgIWd1YXJkKSA/IHRvSW50ZWdlcihmcm9tSW5kZXgpIDogMDsKCiAgICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKICAgICAgaWYgKGZyb21JbmRleCA8IDApIHsKICAgICAgICBmcm9tSW5kZXggPSBuYXRpdmVNYXgobGVuZ3RoICsgZnJvbUluZGV4LCAwKTsKICAgICAgfQogICAgICByZXR1cm4gaXNTdHJpbmcoY29sbGVjdGlvbikKICAgICAgICA/IChmcm9tSW5kZXggPD0gbGVuZ3RoICYmIGNvbGxlY3Rpb24uaW5kZXhPZih2YWx1ZSwgZnJvbUluZGV4KSA+IC0xKQogICAgICAgIDogKCEhbGVuZ3RoICYmIGJhc2VJbmRleE9mKGNvbGxlY3Rpb24sIHZhbHVlLCBmcm9tSW5kZXgpID4gLTEpOwogICAgfQoKICAgIC8qKgogICAgICogSW52b2tlcyB0aGUgbWV0aG9kIGF0IGBwYXRoYCBvZiBlYWNoIGVsZW1lbnQgaW4gYGNvbGxlY3Rpb25gLCByZXR1cm5pbmcKICAgICAqIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuIEFueSBhZGRpdGlvbmFsIGFyZ3VtZW50cwogICAgICogYXJlIHByb3ZpZGVkIHRvIGVhY2ggaW52b2tlZCBtZXRob2QuIElmIGBwYXRoYCBpcyBhIGZ1bmN0aW9uLCBpdCdzIGludm9rZWQKICAgICAqIGZvciwgYW5kIGB0aGlzYCBib3VuZCB0bywgZWFjaCBlbGVtZW50IGluIGBjb2xsZWN0aW9uYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbnxzdHJpbmd9IHBhdGggVGhlIHBhdGggb2YgdGhlIG1ldGhvZCB0byBpbnZva2Ugb3IKICAgICAqICB0aGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnc10gVGhlIGFyZ3VtZW50cyB0byBpbnZva2UgZWFjaCBtZXRob2Qgd2l0aC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgYXJyYXkgb2YgcmVzdWx0cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pbnZva2VNYXAoW1s1LCAxLCA3XSwgWzMsIDIsIDFdXSwgJ3NvcnQnKTsKICAgICAqIC8vID0+IFtbMSwgNSwgN10sIFsxLCAyLCAzXV0KICAgICAqCiAgICAgKiBfLmludm9rZU1hcChbMTIzLCA0NTZdLCBTdHJpbmcucHJvdG90eXBlLnNwbGl0LCAnJyk7CiAgICAgKiAvLyA9PiBbWycxJywgJzInLCAnMyddLCBbJzQnLCAnNScsICc2J11dCiAgICAgKi8KICAgIHZhciBpbnZva2VNYXAgPSBiYXNlUmVzdChmdW5jdGlvbihjb2xsZWN0aW9uLCBwYXRoLCBhcmdzKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgaXNGdW5jID0gdHlwZW9mIHBhdGggPT0gJ2Z1bmN0aW9uJywKICAgICAgICAgIHJlc3VsdCA9IGlzQXJyYXlMaWtlKGNvbGxlY3Rpb24pID8gQXJyYXkoY29sbGVjdGlvbi5sZW5ndGgpIDogW107CgogICAgICBiYXNlRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJlc3VsdFsrK2luZGV4XSA9IGlzRnVuYyA/IGFwcGx5KHBhdGgsIHZhbHVlLCBhcmdzKSA6IGJhc2VJbnZva2UodmFsdWUsIHBhdGgsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nCiAgICAgKiBlYWNoIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gIHRocnUgYGl0ZXJhdGVlYC4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgb2YKICAgICAqIGVhY2gga2V5IGlzIHRoZSBsYXN0IGVsZW1lbnQgcmVzcG9uc2libGUgZm9yIGdlbmVyYXRpbmcgdGhlIGtleS4gVGhlCiAgICAgKiBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9uCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGl0ZXJhdGVlIHRvIHRyYW5zZm9ybSBrZXlzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGFycmF5ID0gWwogICAgICogICB7ICdkaXInOiAnbGVmdCcsICdjb2RlJzogOTcgfSwKICAgICAqICAgeyAnZGlyJzogJ3JpZ2h0JywgJ2NvZGUnOiAxMDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLmtleUJ5KGFycmF5LCBmdW5jdGlvbihvKSB7CiAgICAgKiAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKG8uY29kZSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IHsgJ2EnOiB7ICdkaXInOiAnbGVmdCcsICdjb2RlJzogOTcgfSwgJ2QnOiB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9IH0KICAgICAqCiAgICAgKiBfLmtleUJ5KGFycmF5LCAnZGlyJyk7CiAgICAgKiAvLyA9PiB7ICdsZWZ0JzogeyAnZGlyJzogJ2xlZnQnLCAnY29kZSc6IDk3IH0sICdyaWdodCc6IHsgJ2Rpcic6ICdyaWdodCcsICdjb2RlJzogMTAwIH0gfQogICAgICovCiAgICB2YXIga2V5QnkgPSBjcmVhdGVBZ2dyZWdhdG9yKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICBiYXNlQXNzaWduVmFsdWUocmVzdWx0LCBrZXksIHZhbHVlKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB2YWx1ZXMgYnkgcnVubmluZyBlYWNoIGVsZW1lbnQgaW4gYGNvbGxlY3Rpb25gIHRocnUKICAgICAqIGBpdGVyYXRlZWAuIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOgogICAgICogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIE1hbnkgbG9kYXNoIG1ldGhvZHMgYXJlIGd1YXJkZWQgdG8gd29yayBhcyBpdGVyYXRlZXMgZm9yIG1ldGhvZHMgbGlrZQogICAgICogYF8uZXZlcnlgLCBgXy5maWx0ZXJgLCBgXy5tYXBgLCBgXy5tYXBWYWx1ZXNgLCBgXy5yZWplY3RgLCBhbmQgYF8uc29tZWAuCiAgICAgKgogICAgICogVGhlIGd1YXJkZWQgbWV0aG9kcyBhcmU6CiAgICAgKiBgYXJ5YCwgYGNodW5rYCwgYGN1cnJ5YCwgYGN1cnJ5UmlnaHRgLCBgZHJvcGAsIGBkcm9wUmlnaHRgLCBgZXZlcnlgLAogICAgICogYGZpbGxgLCBgaW52ZXJ0YCwgYHBhcnNlSW50YCwgYHJhbmRvbWAsIGByYW5nZWAsIGByYW5nZVJpZ2h0YCwgYHJlcGVhdGAsCiAgICAgKiBgc2FtcGxlU2l6ZWAsIGBzbGljZWAsIGBzb21lYCwgYHNvcnRCeWAsIGBzcGxpdGAsIGB0YWtlYCwgYHRha2VSaWdodGAsCiAgICAgKiBgdGVtcGxhdGVgLCBgdHJpbWAsIGB0cmltRW5kYCwgYHRyaW1TdGFydGAsIGFuZCBgd29yZHNgCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb24KICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgbWFwcGVkIGFycmF5LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBzcXVhcmUobikgewogICAgICogICByZXR1cm4gbiAqIG47CiAgICAgKiB9CiAgICAgKgogICAgICogXy5tYXAoWzQsIDhdLCBzcXVhcmUpOwogICAgICogLy8gPT4gWzE2LCA2NF0KICAgICAqCiAgICAgKiBfLm1hcCh7ICdhJzogNCwgJ2InOiA4IH0sIHNxdWFyZSk7CiAgICAgKiAvLyA9PiBbMTYsIDY0XSAoaXRlcmF0aW9uIG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAgICoKICAgICAqIHZhciB1c2VycyA9IFsKICAgICAqICAgeyAndXNlcic6ICdiYXJuZXknIH0sCiAgICAgKiAgIHsgJ3VzZXInOiAnZnJlZCcgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8ubWFwKHVzZXJzLCAndXNlcicpOwogICAgICogLy8gPT4gWydiYXJuZXknLCAnZnJlZCddCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcChjb2xsZWN0aW9uLCBpdGVyYXRlZSkgewogICAgICB2YXIgZnVuYyA9IGlzQXJyYXkoY29sbGVjdGlvbikgPyBhcnJheU1hcCA6IGJhc2VNYXA7CiAgICAgIHJldHVybiBmdW5jKGNvbGxlY3Rpb24sIGdldEl0ZXJhdGVlKGl0ZXJhdGVlLCAzKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnNvcnRCeWAgZXhjZXB0IHRoYXQgaXQgYWxsb3dzIHNwZWNpZnlpbmcgdGhlIHNvcnQKICAgICAqIG9yZGVycyBvZiB0aGUgaXRlcmF0ZWVzIHRvIHNvcnQgYnkuIElmIGBvcmRlcnNgIGlzIHVuc3BlY2lmaWVkLCBhbGwgdmFsdWVzCiAgICAgKiBhcmUgc29ydGVkIGluIGFzY2VuZGluZyBvcmRlci4gT3RoZXJ3aXNlLCBzcGVjaWZ5IGFuIG9yZGVyIG9mICJkZXNjIiBmb3IKICAgICAqIGRlc2NlbmRpbmcgb3IgImFzYyIgZm9yIGFzY2VuZGluZyBzb3J0IG9yZGVyIG9mIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9uCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0FycmF5W118RnVuY3Rpb25bXXxPYmplY3RbXXxzdHJpbmdbXX0gW2l0ZXJhdGVlcz1bXy5pZGVudGl0eV1dCiAgICAgKiAgVGhlIGl0ZXJhdGVlcyB0byBzb3J0IGJ5LgogICAgICogQHBhcmFtIHtzdHJpbmdbXX0gW29yZGVyc10gVGhlIHNvcnQgb3JkZXJzIG9mIGBpdGVyYXRlZXNgLgogICAgICogQHBhcmFtLSB7T2JqZWN0fSBbZ3VhcmRdIEVuYWJsZXMgdXNlIGFzIGFuIGl0ZXJhdGVlIGZvciBtZXRob2RzIGxpa2UgYF8ucmVkdWNlYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IHNvcnRlZCBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gWwogICAgICogICB7ICd1c2VyJzogJ2ZyZWQnLCAgICdhZ2UnOiA0OCB9LAogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICdhZ2UnOiAzNCB9LAogICAgICogICB7ICd1c2VyJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCB9LAogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIFNvcnQgYnkgYHVzZXJgIGluIGFzY2VuZGluZyBvcmRlciBhbmQgYnkgYGFnZWAgaW4gZGVzY2VuZGluZyBvcmRlci4KICAgICAqIF8ub3JkZXJCeSh1c2VycywgWyd1c2VyJywgJ2FnZSddLCBbJ2FzYycsICdkZXNjJ10pOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgW1snYmFybmV5JywgMzZdLCBbJ2Jhcm5leScsIDM0XSwgWydmcmVkJywgNDhdLCBbJ2ZyZWQnLCA0MF1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9yZGVyQnkoY29sbGVjdGlvbiwgaXRlcmF0ZWVzLCBvcmRlcnMsIGd1YXJkKSB7CiAgICAgIGlmIChjb2xsZWN0aW9uID09IG51bGwpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgaWYgKCFpc0FycmF5KGl0ZXJhdGVlcykpIHsKICAgICAgICBpdGVyYXRlZXMgPSBpdGVyYXRlZXMgPT0gbnVsbCA/IFtdIDogW2l0ZXJhdGVlc107CiAgICAgIH0KICAgICAgb3JkZXJzID0gZ3VhcmQgPyB1bmRlZmluZWQgOiBvcmRlcnM7CiAgICAgIGlmICghaXNBcnJheShvcmRlcnMpKSB7CiAgICAgICAgb3JkZXJzID0gb3JkZXJzID09IG51bGwgPyBbXSA6IFtvcmRlcnNdOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlT3JkZXJCeShjb2xsZWN0aW9uLCBpdGVyYXRlZXMsIG9yZGVycyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGVsZW1lbnRzIHNwbGl0IGludG8gdHdvIGdyb3VwcywgdGhlIGZpcnN0IG9mIHdoaWNoCiAgICAgKiBjb250YWlucyBlbGVtZW50cyBgcHJlZGljYXRlYCByZXR1cm5zIHRydXRoeSBmb3IsIHRoZSBzZWNvbmQgb2Ygd2hpY2gKICAgICAqIGNvbnRhaW5zIGVsZW1lbnRzIGBwcmVkaWNhdGVgIHJldHVybnMgZmFsc2V5IGZvci4gVGhlIHByZWRpY2F0ZSBpcwogICAgICogaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDogKHZhbHVlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3ByZWRpY2F0ZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBhcnJheSBvZiBncm91cGVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgdXNlcnMgPSBbCiAgICAgKiAgIHsgJ3VzZXInOiAnYmFybmV5JywgICdhZ2UnOiAzNiwgJ2FjdGl2ZSc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ3VzZXInOiAnZnJlZCcsICAgICdhZ2UnOiA0MCwgJ2FjdGl2ZSc6IHRydWUgfSwKICAgICAqICAgeyAndXNlcic6ICdwZWJibGVzJywgJ2FnZSc6IDEsICAnYWN0aXZlJzogZmFsc2UgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLnBhcnRpdGlvbih1c2VycywgZnVuY3Rpb24obykgeyByZXR1cm4gby5hY3RpdmU7IH0pOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgW1snZnJlZCddLCBbJ2Jhcm5leScsICdwZWJibGVzJ11dCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8ucGFydGl0aW9uKHVzZXJzLCB7ICdhZ2UnOiAxLCAnYWN0aXZlJzogZmFsc2UgfSk7CiAgICAgKiAvLyA9PiBvYmplY3RzIGZvciBbWydwZWJibGVzJ10sIFsnYmFybmV5JywgJ2ZyZWQnXV0KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc1Byb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLnBhcnRpdGlvbih1c2VycywgWydhY3RpdmUnLCBmYWxzZV0pOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgW1snYmFybmV5JywgJ3BlYmJsZXMnXSwgWydmcmVkJ11dCiAgICAgKgogICAgICogLy8gVGhlIGBfLnByb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLnBhcnRpdGlvbih1c2VycywgJ2FjdGl2ZScpOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgW1snZnJlZCddLCBbJ2Jhcm5leScsICdwZWJibGVzJ11dCiAgICAgKi8KICAgIHZhciBwYXJ0aXRpb24gPSBjcmVhdGVBZ2dyZWdhdG9yKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICByZXN1bHRba2V5ID8gMCA6IDFdLnB1c2godmFsdWUpOwogICAgfSwgZnVuY3Rpb24oKSB7IHJldHVybiBbW10sIFtdXTsgfSk7CgogICAgLyoqCiAgICAgKiBSZWR1Y2VzIGBjb2xsZWN0aW9uYCB0byBhIHZhbHVlIHdoaWNoIGlzIHRoZSBhY2N1bXVsYXRlZCByZXN1bHQgb2YgcnVubmluZwogICAgICogZWFjaCBlbGVtZW50IGluIGBjb2xsZWN0aW9uYCB0aHJ1IGBpdGVyYXRlZWAsIHdoZXJlIGVhY2ggc3VjY2Vzc2l2ZQogICAgICogaW52b2NhdGlvbiBpcyBzdXBwbGllZCB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBwcmV2aW91cy4gSWYgYGFjY3VtdWxhdG9yYAogICAgICogaXMgbm90IGdpdmVuLCB0aGUgZmlyc3QgZWxlbWVudCBvZiBgY29sbGVjdGlvbmAgaXMgdXNlZCBhcyB0aGUgaW5pdGlhbAogICAgICogdmFsdWUuIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggZm91ciBhcmd1bWVudHM6CiAgICAgKiAoYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIE1hbnkgbG9kYXNoIG1ldGhvZHMgYXJlIGd1YXJkZWQgdG8gd29yayBhcyBpdGVyYXRlZXMgZm9yIG1ldGhvZHMgbGlrZQogICAgICogYF8ucmVkdWNlYCwgYF8ucmVkdWNlUmlnaHRgLCBhbmQgYF8udHJhbnNmb3JtYC4KICAgICAqCiAgICAgKiBUaGUgZ3VhcmRlZCBtZXRob2RzIGFyZToKICAgICAqIGBhc3NpZ25gLCBgZGVmYXVsdHNgLCBgZGVmYXVsdHNEZWVwYCwgYGluY2x1ZGVzYCwgYG1lcmdlYCwgYG9yZGVyQnlgLAogICAgICogYW5kIGBzb3J0QnlgCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb24KICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIFRoZSBpbml0aWFsIHZhbHVlLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAgICogQHNlZSBfLnJlZHVjZVJpZ2h0CiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucmVkdWNlKFsxLCAyXSwgZnVuY3Rpb24oc3VtLCBuKSB7CiAgICAgKiAgIHJldHVybiBzdW0gKyBuOwogICAgICogfSwgMCk7CiAgICAgKiAvLyA9PiAzCiAgICAgKgogICAgICogXy5yZWR1Y2UoeyAnYSc6IDEsICdiJzogMiwgJ2MnOiAxIH0sIGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICogICAocmVzdWx0W3ZhbHVlXSB8fCAocmVzdWx0W3ZhbHVlXSA9IFtdKSkucHVzaChrZXkpOwogICAgICogICByZXR1cm4gcmVzdWx0OwogICAgICogfSwge30pOwogICAgICogLy8gPT4geyAnMSc6IFsnYScsICdjJ10sICcyJzogWydiJ10gfSAoaXRlcmF0aW9uIG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAgICovCiAgICBmdW5jdGlvbiByZWR1Y2UoY29sbGVjdGlvbiwgaXRlcmF0ZWUsIGFjY3VtdWxhdG9yKSB7CiAgICAgIHZhciBmdW5jID0gaXNBcnJheShjb2xsZWN0aW9uKSA/IGFycmF5UmVkdWNlIDogYmFzZVJlZHVjZSwKICAgICAgICAgIGluaXRBY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzOwoKICAgICAgcmV0dXJuIGZ1bmMoY29sbGVjdGlvbiwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDQpLCBhY2N1bXVsYXRvciwgaW5pdEFjY3VtLCBiYXNlRWFjaCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnJlZHVjZWAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZgogICAgICogYGNvbGxlY3Rpb25gIGZyb20gcmlnaHQgdG8gbGVmdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFthY2N1bXVsYXRvcl0gVGhlIGluaXRpYWwgdmFsdWUuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICAgKiBAc2VlIF8ucmVkdWNlCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBhcnJheSA9IFtbMCwgMV0sIFsyLCAzXSwgWzQsIDVdXTsKICAgICAqCiAgICAgKiBfLnJlZHVjZVJpZ2h0KGFycmF5LCBmdW5jdGlvbihmbGF0dGVuZWQsIG90aGVyKSB7CiAgICAgKiAgIHJldHVybiBmbGF0dGVuZWQuY29uY2F0KG90aGVyKTsKICAgICAqIH0sIFtdKTsKICAgICAqIC8vID0+IFs0LCA1LCAyLCAzLCAwLCAxXQogICAgICovCiAgICBmdW5jdGlvbiByZWR1Y2VSaWdodChjb2xsZWN0aW9uLCBpdGVyYXRlZSwgYWNjdW11bGF0b3IpIHsKICAgICAgdmFyIGZ1bmMgPSBpc0FycmF5KGNvbGxlY3Rpb24pID8gYXJyYXlSZWR1Y2VSaWdodCA6IGJhc2VSZWR1Y2UsCiAgICAgICAgICBpbml0QWNjdW0gPSBhcmd1bWVudHMubGVuZ3RoIDwgMzsKCiAgICAgIHJldHVybiBmdW5jKGNvbGxlY3Rpb24sIGdldEl0ZXJhdGVlKGl0ZXJhdGVlLCA0KSwgYWNjdW11bGF0b3IsIGluaXRBY2N1bSwgYmFzZUVhY2hSaWdodCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZmlsdGVyYDsgdGhpcyBtZXRob2QgcmV0dXJucyB0aGUgZWxlbWVudHMgb2YgYGNvbGxlY3Rpb25gCiAgICAgKiB0aGF0IGBwcmVkaWNhdGVgIGRvZXMgKipub3QqKiByZXR1cm4gdHJ1dGh5IGZvci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3ByZWRpY2F0ZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZmlsdGVyZWQgYXJyYXkuCiAgICAgKiBAc2VlIF8uZmlsdGVyCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciB1c2VycyA9IFsKICAgICAqICAgeyAndXNlcic6ICdiYXJuZXknLCAnYWdlJzogMzYsICdhY3RpdmUnOiBmYWxzZSB9LAogICAgICogICB7ICd1c2VyJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCwgJ2FjdGl2ZSc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLnJlamVjdCh1c2VycywgZnVuY3Rpb24obykgeyByZXR1cm4gIW8uYWN0aXZlOyB9KTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFsnZnJlZCddCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8ucmVqZWN0KHVzZXJzLCB7ICdhZ2UnOiA0MCwgJ2FjdGl2ZSc6IHRydWUgfSk7CiAgICAgKiAvLyA9PiBvYmplY3RzIGZvciBbJ2Jhcm5leSddCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNQcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5yZWplY3QodXNlcnMsIFsnYWN0aXZlJywgZmFsc2VdKTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFsnZnJlZCddCiAgICAgKgogICAgICogLy8gVGhlIGBfLnByb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLnJlamVjdCh1c2VycywgJ2FjdGl2ZScpOwogICAgICogLy8gPT4gb2JqZWN0cyBmb3IgWydiYXJuZXknXQogICAgICovCiAgICBmdW5jdGlvbiByZWplY3QoY29sbGVjdGlvbiwgcHJlZGljYXRlKSB7CiAgICAgIHZhciBmdW5jID0gaXNBcnJheShjb2xsZWN0aW9uKSA/IGFycmF5RmlsdGVyIDogYmFzZUZpbHRlcjsKICAgICAgcmV0dXJuIGZ1bmMoY29sbGVjdGlvbiwgbmVnYXRlKGdldEl0ZXJhdGVlKHByZWRpY2F0ZSwgMykpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgYSByYW5kb20gZWxlbWVudCBmcm9tIGBjb2xsZWN0aW9uYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDIuMC4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gc2FtcGxlLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJhbmRvbSBlbGVtZW50LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnNhbXBsZShbMSwgMiwgMywgNF0pOwogICAgICogLy8gPT4gMgogICAgICovCiAgICBmdW5jdGlvbiBzYW1wbGUoY29sbGVjdGlvbikgewogICAgICB2YXIgZnVuYyA9IGlzQXJyYXkoY29sbGVjdGlvbikgPyBhcnJheVNhbXBsZSA6IGJhc2VTYW1wbGU7CiAgICAgIHJldHVybiBmdW5jKGNvbGxlY3Rpb24pOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBgbmAgcmFuZG9tIGVsZW1lbnRzIGF0IHVuaXF1ZSBrZXlzIGZyb20gYGNvbGxlY3Rpb25gIHVwIHRvIHRoZQogICAgICogc2l6ZSBvZiBgY29sbGVjdGlvbmAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb24KICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNhbXBsZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbj0xXSBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHNhbXBsZS4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBFbmFibGVzIHVzZSBhcyBhbiBpdGVyYXRlZSBmb3IgbWV0aG9kcyBsaWtlIGBfLm1hcGAuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHJhbmRvbSBlbGVtZW50cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zYW1wbGVTaXplKFsxLCAyLCAzXSwgMik7CiAgICAgKiAvLyA9PiBbMywgMV0KICAgICAqCiAgICAgKiBfLnNhbXBsZVNpemUoWzEsIDIsIDNdLCA0KTsKICAgICAqIC8vID0+IFsyLCAzLCAxXQogICAgICovCiAgICBmdW5jdGlvbiBzYW1wbGVTaXplKGNvbGxlY3Rpb24sIG4sIGd1YXJkKSB7CiAgICAgIGlmICgoZ3VhcmQgPyBpc0l0ZXJhdGVlQ2FsbChjb2xsZWN0aW9uLCBuLCBndWFyZCkgOiBuID09PSB1bmRlZmluZWQpKSB7CiAgICAgICAgbiA9IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbiA9IHRvSW50ZWdlcihuKTsKICAgICAgfQogICAgICB2YXIgZnVuYyA9IGlzQXJyYXkoY29sbGVjdGlvbikgPyBhcnJheVNhbXBsZVNpemUgOiBiYXNlU2FtcGxlU2l6ZTsKICAgICAgcmV0dXJuIGZ1bmMoY29sbGVjdGlvbiwgbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHNodWZmbGVkIHZhbHVlcywgdXNpbmcgYSB2ZXJzaW9uIG9mIHRoZQogICAgICogW0Zpc2hlci1ZYXRlcyBzaHVmZmxlXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GaXNoZXItWWF0ZXNfc2h1ZmZsZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb24KICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNodWZmbGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBzaHVmZmxlZCBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zaHVmZmxlKFsxLCAyLCAzLCA0XSk7CiAgICAgKiAvLyA9PiBbNCwgMSwgMywgMl0KICAgICAqLwogICAgZnVuY3Rpb24gc2h1ZmZsZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBmdW5jID0gaXNBcnJheShjb2xsZWN0aW9uKSA/IGFycmF5U2h1ZmZsZSA6IGJhc2VTaHVmZmxlOwogICAgICByZXR1cm4gZnVuYyhjb2xsZWN0aW9uKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIHNpemUgb2YgYGNvbGxlY3Rpb25gIGJ5IHJldHVybmluZyBpdHMgbGVuZ3RoIGZvciBhcnJheS1saWtlCiAgICAgKiB2YWx1ZXMgb3IgdGhlIG51bWJlciBvZiBvd24gZW51bWVyYWJsZSBzdHJpbmcga2V5ZWQgcHJvcGVydGllcyBmb3Igb2JqZWN0cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBjb2xsZWN0aW9uIHNpemUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc2l6ZShbMSwgMiwgM10pOwogICAgICogLy8gPT4gMwogICAgICoKICAgICAqIF8uc2l6ZSh7ICdhJzogMSwgJ2InOiAyIH0pOwogICAgICogLy8gPT4gMgogICAgICoKICAgICAqIF8uc2l6ZSgncGViYmxlcycpOwogICAgICogLy8gPT4gNwogICAgICovCiAgICBmdW5jdGlvbiBzaXplKGNvbGxlY3Rpb24pIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gPT0gbnVsbCkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGlmIChpc0FycmF5TGlrZShjb2xsZWN0aW9uKSkgewogICAgICAgIHJldHVybiBpc1N0cmluZyhjb2xsZWN0aW9uKSA/IHN0cmluZ1NpemUoY29sbGVjdGlvbikgOiBjb2xsZWN0aW9uLmxlbmd0aDsKICAgICAgfQogICAgICB2YXIgdGFnID0gZ2V0VGFnKGNvbGxlY3Rpb24pOwogICAgICBpZiAodGFnID09IG1hcFRhZyB8fCB0YWcgPT0gc2V0VGFnKSB7CiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb24uc2l6ZTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZUtleXMoY29sbGVjdGlvbikubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGBwcmVkaWNhdGVgIHJldHVybnMgdHJ1dGh5IGZvciAqKmFueSoqIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gLgogICAgICogSXRlcmF0aW9uIGlzIHN0b3BwZWQgb25jZSBgcHJlZGljYXRlYCByZXR1cm5zIHRydXRoeS4gVGhlIHByZWRpY2F0ZSBpcwogICAgICogaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9uCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gRW5hYmxlcyB1c2UgYXMgYW4gaXRlcmF0ZWUgZm9yIG1ldGhvZHMgbGlrZSBgXy5tYXBgLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFueSBlbGVtZW50IHBhc3NlcyB0aGUgcHJlZGljYXRlIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb21lKFtudWxsLCAwLCAneWVzJywgZmFsc2VdLCBCb29sZWFuKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgdXNlcnMgPSBbCiAgICAgKiAgIHsgJ3VzZXInOiAnYmFybmV5JywgJ2FjdGl2ZSc6IHRydWUgfSwKICAgICAqICAgeyAndXNlcic6ICdmcmVkJywgICAnYWN0aXZlJzogZmFsc2UgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc2AgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5zb21lKHVzZXJzLCB7ICd1c2VyJzogJ2Jhcm5leScsICdhY3RpdmUnOiBmYWxzZSB9KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogLy8gVGhlIGBfLm1hdGNoZXNQcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5zb21lKHVzZXJzLCBbJ2FjdGl2ZScsIGZhbHNlXSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogLy8gVGhlIGBfLnByb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLnNvbWUodXNlcnMsICdhY3RpdmUnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gc29tZShjb2xsZWN0aW9uLCBwcmVkaWNhdGUsIGd1YXJkKSB7CiAgICAgIHZhciBmdW5jID0gaXNBcnJheShjb2xsZWN0aW9uKSA/IGFycmF5U29tZSA6IGJhc2VTb21lOwogICAgICBpZiAoZ3VhcmQgJiYgaXNJdGVyYXRlZUNhbGwoY29sbGVjdGlvbiwgcHJlZGljYXRlLCBndWFyZCkpIHsKICAgICAgICBwcmVkaWNhdGUgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmMoY29sbGVjdGlvbiwgZ2V0SXRlcmF0ZWUocHJlZGljYXRlLCAzKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGVsZW1lbnRzLCBzb3J0ZWQgaW4gYXNjZW5kaW5nIG9yZGVyIGJ5IHRoZSByZXN1bHRzIG9mCiAgICAgKiBydW5uaW5nIGVhY2ggZWxlbWVudCBpbiBhIGNvbGxlY3Rpb24gdGhydSBlYWNoIGl0ZXJhdGVlLiBUaGlzIG1ldGhvZAogICAgICogcGVyZm9ybXMgYSBzdGFibGUgc29ydCwgdGhhdCBpcywgaXQgcHJlc2VydmVzIHRoZSBvcmlnaW5hbCBzb3J0IG9yZGVyIG9mCiAgICAgKiBlcXVhbCBlbGVtZW50cy4gVGhlIGl0ZXJhdGVlcyBhcmUgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDogKHZhbHVlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHsuLi4oRnVuY3Rpb258RnVuY3Rpb25bXSl9IFtpdGVyYXRlZXM9W18uaWRlbnRpdHldXQogICAgICogIFRoZSBpdGVyYXRlZXMgdG8gc29ydCBieS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IHNvcnRlZCBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gWwogICAgICogICB7ICd1c2VyJzogJ2ZyZWQnLCAgICdhZ2UnOiA0OCB9LAogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9LAogICAgICogICB7ICd1c2VyJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCB9LAogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICdhZ2UnOiAzNCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uc29ydEJ5KHVzZXJzLCBbZnVuY3Rpb24obykgeyByZXR1cm4gby51c2VyOyB9XSk7CiAgICAgKiAvLyA9PiBvYmplY3RzIGZvciBbWydiYXJuZXknLCAzNl0sIFsnYmFybmV5JywgMzRdLCBbJ2ZyZWQnLCA0OF0sIFsnZnJlZCcsIDQwXV0KICAgICAqCiAgICAgKiBfLnNvcnRCeSh1c2VycywgWyd1c2VyJywgJ2FnZSddKTsKICAgICAqIC8vID0+IG9iamVjdHMgZm9yIFtbJ2Jhcm5leScsIDM0XSwgWydiYXJuZXknLCAzNl0sIFsnZnJlZCcsIDQwXSwgWydmcmVkJywgNDhdXQogICAgICovCiAgICB2YXIgc29ydEJ5ID0gYmFzZVJlc3QoZnVuY3Rpb24oY29sbGVjdGlvbiwgaXRlcmF0ZWVzKSB7CiAgICAgIGlmIChjb2xsZWN0aW9uID09IG51bGwpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgdmFyIGxlbmd0aCA9IGl0ZXJhdGVlcy5sZW5ndGg7CiAgICAgIGlmIChsZW5ndGggPiAxICYmIGlzSXRlcmF0ZWVDYWxsKGNvbGxlY3Rpb24sIGl0ZXJhdGVlc1swXSwgaXRlcmF0ZWVzWzFdKSkgewogICAgICAgIGl0ZXJhdGVlcyA9IFtdOwogICAgICB9IGVsc2UgaWYgKGxlbmd0aCA+IDIgJiYgaXNJdGVyYXRlZUNhbGwoaXRlcmF0ZWVzWzBdLCBpdGVyYXRlZXNbMV0sIGl0ZXJhdGVlc1syXSkpIHsKICAgICAgICBpdGVyYXRlZXMgPSBbaXRlcmF0ZWVzWzBdXTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZU9yZGVyQnkoY29sbGVjdGlvbiwgYmFzZUZsYXR0ZW4oaXRlcmF0ZWVzLCAxKSwgW10pOwogICAgfSk7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogR2V0cyB0aGUgdGltZXN0YW1wIG9mIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoYXQgaGF2ZSBlbGFwc2VkIHNpbmNlCiAgICAgKiB0aGUgVW5peCBlcG9jaCAoMSBKYW51YXJ5IDE5NzAgMDA6MDA6MDAgVVRDKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDIuNC4wCiAgICAgKiBAY2F0ZWdvcnkgRGF0ZQogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgdGltZXN0YW1wLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmRlZmVyKGZ1bmN0aW9uKHN0YW1wKSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKF8ubm93KCkgLSBzdGFtcCk7CiAgICAgKiB9LCBfLm5vdygpKTsKICAgICAqIC8vID0+IExvZ3MgdGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgaXQgdG9vayBmb3IgdGhlIGRlZmVycmVkIGludm9jYXRpb24uCiAgICAgKi8KICAgIHZhciBub3cgPSBjdHhOb3cgfHwgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiByb290LkRhdGUubm93KCk7CiAgICB9OwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5iZWZvcmVgOyB0aGlzIG1ldGhvZCBjcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpbnZva2VzCiAgICAgKiBgZnVuY2Agb25jZSBpdCdzIGNhbGxlZCBgbmAgb3IgbW9yZSB0aW1lcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb24KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgY2FsbHMgYmVmb3JlIGBmdW5jYCBpcyBpbnZva2VkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc2F2ZXMgPSBbJ3Byb2ZpbGUnLCAnc2V0dGluZ3MnXTsKICAgICAqCiAgICAgKiB2YXIgZG9uZSA9IF8uYWZ0ZXIoc2F2ZXMubGVuZ3RoLCBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ2RvbmUgc2F2aW5nIScpOwogICAgICogfSk7CiAgICAgKgogICAgICogXy5mb3JFYWNoKHNhdmVzLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgKiAgIGFzeW5jU2F2ZSh7ICd0eXBlJzogdHlwZSwgJ2NvbXBsZXRlJzogZG9uZSB9KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gTG9ncyAnZG9uZSBzYXZpbmchJyBhZnRlciB0aGUgdHdvIGFzeW5jIHNhdmVzIGhhdmUgY29tcGxldGVkLgogICAgICovCiAgICBmdW5jdGlvbiBhZnRlcihuLCBmdW5jKSB7CiAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihGVU5DX0VSUk9SX1RFWFQpOwogICAgICB9CiAgICAgIG4gPSB0b0ludGVnZXIobik7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoLS1uIDwgMSkgewogICAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpbnZva2VzIGBmdW5jYCwgd2l0aCB1cCB0byBgbmAgYXJndW1lbnRzLAogICAgICogaWdub3JpbmcgYW55IGFkZGl0aW9uYWwgYXJndW1lbnRzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gY2FwIGFyZ3VtZW50cyBmb3IuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW249ZnVuYy5sZW5ndGhdIFRoZSBhcml0eSBjYXAuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gRW5hYmxlcyB1c2UgYXMgYW4gaXRlcmF0ZWUgZm9yIG1ldGhvZHMgbGlrZSBgXy5tYXBgLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY2FwcGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLm1hcChbJzYnLCAnOCcsICcxMCddLCBfLmFyeShwYXJzZUludCwgMSkpOwogICAgICogLy8gPT4gWzYsIDgsIDEwXQogICAgICovCiAgICBmdW5jdGlvbiBhcnkoZnVuYywgbiwgZ3VhcmQpIHsKICAgICAgbiA9IGd1YXJkID8gdW5kZWZpbmVkIDogbjsKICAgICAgbiA9IChmdW5jICYmIG4gPT0gbnVsbCkgPyBmdW5jLmxlbmd0aCA6IG47CiAgICAgIHJldHVybiBjcmVhdGVXcmFwKGZ1bmMsIFdSQVBfQVJZX0ZMQUcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpbnZva2VzIGBmdW5jYCwgd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgYW5kIGFyZ3VtZW50cwogICAgICogb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24sIHdoaWxlIGl0J3MgY2FsbGVkIGxlc3MgdGhhbiBgbmAgdGltZXMuIFN1YnNlcXVlbnQKICAgICAqIGNhbGxzIHRvIHRoZSBjcmVhdGVkIGZ1bmN0aW9uIHJldHVybiB0aGUgcmVzdWx0IG9mIHRoZSBsYXN0IGBmdW5jYCBpbnZvY2F0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gVGhlIG51bWJlciBvZiBjYWxscyBhdCB3aGljaCBgZnVuY2AgaXMgbm8gbG9uZ2VyIGludm9rZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byByZXN0cmljdC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHJlc3RyaWN0ZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGpRdWVyeShlbGVtZW50KS5vbignY2xpY2snLCBfLmJlZm9yZSg1LCBhZGRDb250YWN0VG9MaXN0KSk7CiAgICAgKiAvLyA9PiBBbGxvd3MgYWRkaW5nIHVwIHRvIDQgY29udGFjdHMgdG8gdGhlIGxpc3QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJlZm9yZShuLCBmdW5jKSB7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihGVU5DX0VSUk9SX1RFWFQpOwogICAgICB9CiAgICAgIG4gPSB0b0ludGVnZXIobik7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoLS1uID4gMCkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBpZiAobiA8PSAxKSB7CiAgICAgICAgICBmdW5jID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgaW52b2tlcyBgZnVuY2Agd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgYHRoaXNBcmdgCiAgICAgKiBhbmQgYHBhcnRpYWxzYCBwcmVwZW5kZWQgdG8gdGhlIGFyZ3VtZW50cyBpdCByZWNlaXZlcy4KICAgICAqCiAgICAgKiBUaGUgYF8uYmluZC5wbGFjZWhvbGRlcmAgdmFsdWUsIHdoaWNoIGRlZmF1bHRzIHRvIGBfYCBpbiBtb25vbGl0aGljIGJ1aWxkcywKICAgICAqIG1heSBiZSB1c2VkIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHBhcnRpYWxseSBhcHBsaWVkIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVW5saWtlIG5hdGl2ZSBgRnVuY3Rpb24jYmluZGAsIHRoaXMgbWV0aG9kIGRvZXNuJ3Qgc2V0IHRoZSAibGVuZ3RoIgogICAgICogcHJvcGVydHkgb2YgYm91bmQgZnVuY3Rpb25zLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gYmluZC4KICAgICAqIEBwYXJhbSB7Kn0gdGhpc0FyZyBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAgICogQHBhcmFtIHsuLi4qfSBbcGFydGlhbHNdIFRoZSBhcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gZ3JlZXQoZ3JlZXRpbmcsIHB1bmN0dWF0aW9uKSB7CiAgICAgKiAgIHJldHVybiBncmVldGluZyArICcgJyArIHRoaXMudXNlciArIHB1bmN0dWF0aW9uOwogICAgICogfQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICd1c2VyJzogJ2ZyZWQnIH07CiAgICAgKgogICAgICogdmFyIGJvdW5kID0gXy5iaW5kKGdyZWV0LCBvYmplY3QsICdoaScpOwogICAgICogYm91bmQoJyEnKTsKICAgICAqIC8vID0+ICdoaSBmcmVkIScKICAgICAqCiAgICAgKiAvLyBCb3VuZCB3aXRoIHBsYWNlaG9sZGVycy4KICAgICAqIHZhciBib3VuZCA9IF8uYmluZChncmVldCwgb2JqZWN0LCBfLCAnIScpOwogICAgICogYm91bmQoJ2hpJyk7CiAgICAgKiAvLyA9PiAnaGkgZnJlZCEnCiAgICAgKi8KICAgIHZhciBiaW5kID0gYmFzZVJlc3QoZnVuY3Rpb24oZnVuYywgdGhpc0FyZywgcGFydGlhbHMpIHsKICAgICAgdmFyIGJpdG1hc2sgPSBXUkFQX0JJTkRfRkxBRzsKICAgICAgaWYgKHBhcnRpYWxzLmxlbmd0aCkgewogICAgICAgIHZhciBob2xkZXJzID0gcmVwbGFjZUhvbGRlcnMocGFydGlhbHMsIGdldEhvbGRlcihiaW5kKSk7CiAgICAgICAgYml0bWFzayB8PSBXUkFQX1BBUlRJQUxfRkxBRzsKICAgICAgfQogICAgICByZXR1cm4gY3JlYXRlV3JhcChmdW5jLCBiaXRtYXNrLCB0aGlzQXJnLCBwYXJ0aWFscywgaG9sZGVycyk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGludm9rZXMgdGhlIG1ldGhvZCBhdCBgb2JqZWN0W2tleV1gIHdpdGggYHBhcnRpYWxzYAogICAgICogcHJlcGVuZGVkIHRvIHRoZSBhcmd1bWVudHMgaXQgcmVjZWl2ZXMuCiAgICAgKgogICAgICogVGhpcyBtZXRob2QgZGlmZmVycyBmcm9tIGBfLmJpbmRgIGJ5IGFsbG93aW5nIGJvdW5kIGZ1bmN0aW9ucyB0byByZWZlcmVuY2UKICAgICAqIG1ldGhvZHMgdGhhdCBtYXkgYmUgcmVkZWZpbmVkIG9yIGRvbid0IHlldCBleGlzdC4gU2VlCiAgICAgKiBbUGV0ZXIgTWljaGF1eCdzIGFydGljbGVdKGh0dHA6Ly9wZXRlci5taWNoYXV4LmNhL2FydGljbGVzL2xhenktZnVuY3Rpb24tZGVmaW5pdGlvbi1wYXR0ZXJuKQogICAgICogZm9yIG1vcmUgZGV0YWlscy4KICAgICAqCiAgICAgKiBUaGUgYF8uYmluZEtleS5wbGFjZWhvbGRlcmAgdmFsdWUsIHdoaWNoIGRlZmF1bHRzIHRvIGBfYCBpbiBtb25vbGl0aGljCiAgICAgKiBidWlsZHMsIG1heSBiZSB1c2VkIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHBhcnRpYWxseSBhcHBsaWVkIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMTAuMAogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW52b2tlIHRoZSBtZXRob2Qgb24uCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIG1ldGhvZC4KICAgICAqIEBwYXJhbSB7Li4uKn0gW3BhcnRpYWxzXSBUaGUgYXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgYm91bmQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7CiAgICAgKiAgICd1c2VyJzogJ2ZyZWQnLAogICAgICogICAnZ3JlZXQnOiBmdW5jdGlvbihncmVldGluZywgcHVuY3R1YXRpb24pIHsKICAgICAqICAgICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLnVzZXIgKyBwdW5jdHVhdGlvbjsKICAgICAqICAgfQogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgYm91bmQgPSBfLmJpbmRLZXkob2JqZWN0LCAnZ3JlZXQnLCAnaGknKTsKICAgICAqIGJvdW5kKCchJyk7CiAgICAgKiAvLyA9PiAnaGkgZnJlZCEnCiAgICAgKgogICAgICogb2JqZWN0LmdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcsIHB1bmN0dWF0aW9uKSB7CiAgICAgKiAgIHJldHVybiBncmVldGluZyArICd5YSAnICsgdGhpcy51c2VyICsgcHVuY3R1YXRpb247CiAgICAgKiB9OwogICAgICoKICAgICAqIGJvdW5kKCchJyk7CiAgICAgKiAvLyA9PiAnaGl5YSBmcmVkIScKICAgICAqCiAgICAgKiAvLyBCb3VuZCB3aXRoIHBsYWNlaG9sZGVycy4KICAgICAqIHZhciBib3VuZCA9IF8uYmluZEtleShvYmplY3QsICdncmVldCcsIF8sICchJyk7CiAgICAgKiBib3VuZCgnaGknKTsKICAgICAqIC8vID0+ICdoaXlhIGZyZWQhJwogICAgICovCiAgICB2YXIgYmluZEtleSA9IGJhc2VSZXN0KGZ1bmN0aW9uKG9iamVjdCwga2V5LCBwYXJ0aWFscykgewogICAgICB2YXIgYml0bWFzayA9IFdSQVBfQklORF9GTEFHIHwgV1JBUF9CSU5EX0tFWV9GTEFHOwogICAgICBpZiAocGFydGlhbHMubGVuZ3RoKSB7CiAgICAgICAgdmFyIGhvbGRlcnMgPSByZXBsYWNlSG9sZGVycyhwYXJ0aWFscywgZ2V0SG9sZGVyKGJpbmRLZXkpKTsKICAgICAgICBiaXRtYXNrIHw9IFdSQVBfUEFSVElBTF9GTEFHOwogICAgICB9CiAgICAgIHJldHVybiBjcmVhdGVXcmFwKGtleSwgYml0bWFzaywgb2JqZWN0LCBwYXJ0aWFscywgaG9sZGVycyk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYXJndW1lbnRzIG9mIGBmdW5jYCBhbmQgZWl0aGVyIGludm9rZXMKICAgICAqIGBmdW5jYCByZXR1cm5pbmcgaXRzIHJlc3VsdCwgaWYgYXQgbGVhc3QgYGFyaXR5YCBudW1iZXIgb2YgYXJndW1lbnRzIGhhdmUKICAgICAqIGJlZW4gcHJvdmlkZWQsIG9yIHJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgdGhlIHJlbWFpbmluZyBgZnVuY2AKICAgICAqIGFyZ3VtZW50cywgYW5kIHNvIG9uLiBUaGUgYXJpdHkgb2YgYGZ1bmNgIG1heSBiZSBzcGVjaWZpZWQgaWYgYGZ1bmMubGVuZ3RoYAogICAgICogaXMgbm90IHN1ZmZpY2llbnQuCiAgICAgKgogICAgICogVGhlIGBfLmN1cnJ5LnBsYWNlaG9sZGVyYCB2YWx1ZSwgd2hpY2ggZGVmYXVsdHMgdG8gYF9gIGluIG1vbm9saXRoaWMgYnVpbGRzLAogICAgICogbWF5IGJlIHVzZWQgYXMgYSBwbGFjZWhvbGRlciBmb3IgcHJvdmlkZWQgYXJndW1lbnRzLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBkb2Vzbid0IHNldCB0aGUgImxlbmd0aCIgcHJvcGVydHkgb2YgY3VycmllZCBmdW5jdGlvbnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAyLjAuMAogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBjdXJyeS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHk9ZnVuYy5sZW5ndGhdIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gRW5hYmxlcyB1c2UgYXMgYW4gaXRlcmF0ZWUgZm9yIG1ldGhvZHMgbGlrZSBgXy5tYXBgLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY3VycmllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGFiYyA9IGZ1bmN0aW9uKGEsIGIsIGMpIHsKICAgICAqICAgcmV0dXJuIFthLCBiLCBjXTsKICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGN1cnJpZWQgPSBfLmN1cnJ5KGFiYyk7CiAgICAgKgogICAgICogY3VycmllZCgxKSgyKSgzKTsKICAgICAqIC8vID0+IFsxLCAyLCAzXQogICAgICoKICAgICAqIGN1cnJpZWQoMSwgMikoMyk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqCiAgICAgKiBjdXJyaWVkKDEsIDIsIDMpOwogICAgICogLy8gPT4gWzEsIDIsIDNdCiAgICAgKgogICAgICogLy8gQ3VycmllZCB3aXRoIHBsYWNlaG9sZGVycy4KICAgICAqIGN1cnJpZWQoMSkoXywgMykoMik7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gY3VycnkoZnVuYywgYXJpdHksIGd1YXJkKSB7CiAgICAgIGFyaXR5ID0gZ3VhcmQgPyB1bmRlZmluZWQgOiBhcml0eTsKICAgICAgdmFyIHJlc3VsdCA9IGNyZWF0ZVdyYXAoZnVuYywgV1JBUF9DVVJSWV9GTEFHLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgYXJpdHkpOwogICAgICByZXN1bHQucGxhY2Vob2xkZXIgPSBjdXJyeS5wbGFjZWhvbGRlcjsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uY3VycnlgIGV4Y2VwdCB0aGF0IGFyZ3VtZW50cyBhcmUgYXBwbGllZCB0byBgZnVuY2AKICAgICAqIGluIHRoZSBtYW5uZXIgb2YgYF8ucGFydGlhbFJpZ2h0YCBpbnN0ZWFkIG9mIGBfLnBhcnRpYWxgLgogICAgICoKICAgICAqIFRoZSBgXy5jdXJyeVJpZ2h0LnBsYWNlaG9sZGVyYCB2YWx1ZSwgd2hpY2ggZGVmYXVsdHMgdG8gYF9gIGluIG1vbm9saXRoaWMKICAgICAqIGJ1aWxkcywgbWF5IGJlIHVzZWQgYXMgYSBwbGFjZWhvbGRlciBmb3IgcHJvdmlkZWQgYXJndW1lbnRzLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBkb2Vzbid0IHNldCB0aGUgImxlbmd0aCIgcHJvcGVydHkgb2YgY3VycmllZCBmdW5jdGlvbnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBjdXJyeS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHk9ZnVuYy5sZW5ndGhdIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gRW5hYmxlcyB1c2UgYXMgYW4gaXRlcmF0ZWUgZm9yIG1ldGhvZHMgbGlrZSBgXy5tYXBgLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY3VycmllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGFiYyA9IGZ1bmN0aW9uKGEsIGIsIGMpIHsKICAgICAqICAgcmV0dXJuIFthLCBiLCBjXTsKICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGN1cnJpZWQgPSBfLmN1cnJ5UmlnaHQoYWJjKTsKICAgICAqCiAgICAgKiBjdXJyaWVkKDMpKDIpKDEpOwogICAgICogLy8gPT4gWzEsIDIsIDNdCiAgICAgKgogICAgICogY3VycmllZCgyLCAzKSgxKTsKICAgICAqIC8vID0+IFsxLCAyLCAzXQogICAgICoKICAgICAqIGN1cnJpZWQoMSwgMiwgMyk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqCiAgICAgKiAvLyBDdXJyaWVkIHdpdGggcGxhY2Vob2xkZXJzLgogICAgICogY3VycmllZCgzKSgxLCBfKSgyKTsKICAgICAqIC8vID0+IFsxLCAyLCAzXQogICAgICovCiAgICBmdW5jdGlvbiBjdXJyeVJpZ2h0KGZ1bmMsIGFyaXR5LCBndWFyZCkgewogICAgICBhcml0eSA9IGd1YXJkID8gdW5kZWZpbmVkIDogYXJpdHk7CiAgICAgIHZhciByZXN1bHQgPSBjcmVhdGVXcmFwKGZ1bmMsIFdSQVBfQ1VSUllfUklHSFRfRkxBRywgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGFyaXR5KTsKICAgICAgcmVzdWx0LnBsYWNlaG9sZGVyID0gY3VycnlSaWdodC5wbGFjZWhvbGRlcjsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBkZWJvdW5jZWQgZnVuY3Rpb24gdGhhdCBkZWxheXMgaW52b2tpbmcgYGZ1bmNgIHVudGlsIGFmdGVyIGB3YWl0YAogICAgICogbWlsbGlzZWNvbmRzIGhhdmUgZWxhcHNlZCBzaW5jZSB0aGUgbGFzdCB0aW1lIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24gd2FzCiAgICAgKiBpbnZva2VkLiBUaGUgZGVib3VuY2VkIGZ1bmN0aW9uIGNvbWVzIHdpdGggYSBgY2FuY2VsYCBtZXRob2QgdG8gY2FuY2VsCiAgICAgKiBkZWxheWVkIGBmdW5jYCBpbnZvY2F0aW9ucyBhbmQgYSBgZmx1c2hgIG1ldGhvZCB0byBpbW1lZGlhdGVseSBpbnZva2UgdGhlbS4KICAgICAqIFByb3ZpZGUgYG9wdGlvbnNgIHRvIGluZGljYXRlIHdoZXRoZXIgYGZ1bmNgIHNob3VsZCBiZSBpbnZva2VkIG9uIHRoZQogICAgICogbGVhZGluZyBhbmQvb3IgdHJhaWxpbmcgZWRnZSBvZiB0aGUgYHdhaXRgIHRpbWVvdXQuIFRoZSBgZnVuY2AgaXMgaW52b2tlZAogICAgICogd2l0aCB0aGUgbGFzdCBhcmd1bWVudHMgcHJvdmlkZWQgdG8gdGhlIGRlYm91bmNlZCBmdW5jdGlvbi4gU3Vic2VxdWVudAogICAgICogY2FsbHMgdG8gdGhlIGRlYm91bmNlZCBmdW5jdGlvbiByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AKICAgICAqIGludm9jYXRpb24uCiAgICAgKgogICAgICogKipOb3RlOioqIElmIGBsZWFkaW5nYCBhbmQgYHRyYWlsaW5nYCBvcHRpb25zIGFyZSBgdHJ1ZWAsIGBmdW5jYCBpcwogICAgICogaW52b2tlZCBvbiB0aGUgdHJhaWxpbmcgZWRnZSBvZiB0aGUgdGltZW91dCBvbmx5IGlmIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24KICAgICAqIGlzIGludm9rZWQgbW9yZSB0aGFuIG9uY2UgZHVyaW5nIHRoZSBgd2FpdGAgdGltZW91dC4KICAgICAqCiAgICAgKiBJZiBgd2FpdGAgaXMgYDBgIGFuZCBgbGVhZGluZ2AgaXMgYGZhbHNlYCwgYGZ1bmNgIGludm9jYXRpb24gaXMgZGVmZXJyZWQKICAgICAqIHVudGlsIHRvIHRoZSBuZXh0IHRpY2ssIHNpbWlsYXIgdG8gYHNldFRpbWVvdXRgIHdpdGggYSB0aW1lb3V0IG9mIGAwYC4KICAgICAqCiAgICAgKiBTZWUgW0RhdmlkIENvcmJhY2hvJ3MgYXJ0aWNsZV0oaHR0cHM6Ly9jc3MtdHJpY2tzLmNvbS9kZWJvdW5jaW5nLXRocm90dGxpbmctZXhwbGFpbmVkLWV4YW1wbGVzLykKICAgICAqIGZvciBkZXRhaWxzIG92ZXIgdGhlIGRpZmZlcmVuY2VzIGJldHdlZW4gYF8uZGVib3VuY2VgIGFuZCBgXy50aHJvdHRsZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWJvdW5jZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2FpdD0wXSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBkZWxheS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0gVGhlIG9wdGlvbnMgb2JqZWN0LgogICAgICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy5sZWFkaW5nPWZhbHNlXQogICAgICogIFNwZWNpZnkgaW52b2tpbmcgb24gdGhlIGxlYWRpbmcgZWRnZSBvZiB0aGUgdGltZW91dC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy5tYXhXYWl0XQogICAgICogIFRoZSBtYXhpbXVtIHRpbWUgYGZ1bmNgIGlzIGFsbG93ZWQgdG8gYmUgZGVsYXllZCBiZWZvcmUgaXQncyBpbnZva2VkLgogICAgICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy50cmFpbGluZz10cnVlXQogICAgICogIFNwZWNpZnkgaW52b2tpbmcgb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBkZWJvdW5jZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIC8vIEF2b2lkIGNvc3RseSBjYWxjdWxhdGlvbnMgd2hpbGUgdGhlIHdpbmRvdyBzaXplIGlzIGluIGZsdXguCiAgICAgKiBqUXVlcnkod2luZG93KS5vbigncmVzaXplJywgXy5kZWJvdW5jZShjYWxjdWxhdGVMYXlvdXQsIDE1MCkpOwogICAgICoKICAgICAqIC8vIEludm9rZSBgc2VuZE1haWxgIHdoZW4gY2xpY2tlZCwgZGVib3VuY2luZyBzdWJzZXF1ZW50IGNhbGxzLgogICAgICogalF1ZXJ5KGVsZW1lbnQpLm9uKCdjbGljaycsIF8uZGVib3VuY2Uoc2VuZE1haWwsIDMwMCwgewogICAgICogICAnbGVhZGluZyc6IHRydWUsCiAgICAgKiAgICd0cmFpbGluZyc6IGZhbHNlCiAgICAgKiB9KSk7CiAgICAgKgogICAgICogLy8gRW5zdXJlIGBiYXRjaExvZ2AgaXMgaW52b2tlZCBvbmNlIGFmdGVyIDEgc2Vjb25kIG9mIGRlYm91bmNlZCBjYWxscy4KICAgICAqIHZhciBkZWJvdW5jZWQgPSBfLmRlYm91bmNlKGJhdGNoTG9nLCAyNTAsIHsgJ21heFdhaXQnOiAxMDAwIH0pOwogICAgICogdmFyIHNvdXJjZSA9IG5ldyBFdmVudFNvdXJjZSgnL3N0cmVhbScpOwogICAgICogalF1ZXJ5KHNvdXJjZSkub24oJ21lc3NhZ2UnLCBkZWJvdW5jZWQpOwogICAgICoKICAgICAqIC8vIENhbmNlbCB0aGUgdHJhaWxpbmcgZGVib3VuY2VkIGludm9jYXRpb24uCiAgICAgKiBqUXVlcnkod2luZG93KS5vbigncG9wc3RhdGUnLCBkZWJvdW5jZWQuY2FuY2VsKTsKICAgICAqLwogICAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgICB2YXIgbGFzdEFyZ3MsCiAgICAgICAgICBsYXN0VGhpcywKICAgICAgICAgIG1heFdhaXQsCiAgICAgICAgICByZXN1bHQsCiAgICAgICAgICB0aW1lcklkLAogICAgICAgICAgbGFzdENhbGxUaW1lLAogICAgICAgICAgbGFzdEludm9rZVRpbWUgPSAwLAogICAgICAgICAgbGVhZGluZyA9IGZhbHNlLAogICAgICAgICAgbWF4aW5nID0gZmFsc2UsCiAgICAgICAgICB0cmFpbGluZyA9IHRydWU7CgogICAgICBpZiAodHlwZW9mIGZ1bmMgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoRlVOQ19FUlJPUl9URVhUKTsKICAgICAgfQogICAgICB3YWl0ID0gdG9OdW1iZXIod2FpdCkgfHwgMDsKICAgICAgaWYgKGlzT2JqZWN0KG9wdGlvbnMpKSB7CiAgICAgICAgbGVhZGluZyA9ICEhb3B0aW9ucy5sZWFkaW5nOwogICAgICAgIG1heGluZyA9ICdtYXhXYWl0JyBpbiBvcHRpb25zOwogICAgICAgIG1heFdhaXQgPSBtYXhpbmcgPyBuYXRpdmVNYXgodG9OdW1iZXIob3B0aW9ucy5tYXhXYWl0KSB8fCAwLCB3YWl0KSA6IG1heFdhaXQ7CiAgICAgICAgdHJhaWxpbmcgPSAndHJhaWxpbmcnIGluIG9wdGlvbnMgPyAhIW9wdGlvbnMudHJhaWxpbmcgOiB0cmFpbGluZzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaW52b2tlRnVuYyh0aW1lKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBsYXN0QXJncywKICAgICAgICAgICAgdGhpc0FyZyA9IGxhc3RUaGlzOwoKICAgICAgICBsYXN0QXJncyA9IGxhc3RUaGlzID0gdW5kZWZpbmVkOwogICAgICAgIGxhc3RJbnZva2VUaW1lID0gdGltZTsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGxlYWRpbmdFZGdlKHRpbWUpIHsKICAgICAgICAvLyBSZXNldCBhbnkgYG1heFdhaXRgIHRpbWVyLgogICAgICAgIGxhc3RJbnZva2VUaW1lID0gdGltZTsKICAgICAgICAvLyBTdGFydCB0aGUgdGltZXIgZm9yIHRoZSB0cmFpbGluZyBlZGdlLgogICAgICAgIHRpbWVySWQgPSBzZXRUaW1lb3V0KHRpbWVyRXhwaXJlZCwgd2FpdCk7CiAgICAgICAgLy8gSW52b2tlIHRoZSBsZWFkaW5nIGVkZ2UuCiAgICAgICAgcmV0dXJuIGxlYWRpbmcgPyBpbnZva2VGdW5jKHRpbWUpIDogcmVzdWx0OwogICAgICB9CgogICAgICBmdW5jdGlvbiByZW1haW5pbmdXYWl0KHRpbWUpIHsKICAgICAgICB2YXIgdGltZVNpbmNlTGFzdENhbGwgPSB0aW1lIC0gbGFzdENhbGxUaW1lLAogICAgICAgICAgICB0aW1lU2luY2VMYXN0SW52b2tlID0gdGltZSAtIGxhc3RJbnZva2VUaW1lLAogICAgICAgICAgICB0aW1lV2FpdGluZyA9IHdhaXQgLSB0aW1lU2luY2VMYXN0Q2FsbDsKCiAgICAgICAgcmV0dXJuIG1heGluZwogICAgICAgICAgPyBuYXRpdmVNaW4odGltZVdhaXRpbmcsIG1heFdhaXQgLSB0aW1lU2luY2VMYXN0SW52b2tlKQogICAgICAgICAgOiB0aW1lV2FpdGluZzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gc2hvdWxkSW52b2tlKHRpbWUpIHsKICAgICAgICB2YXIgdGltZVNpbmNlTGFzdENhbGwgPSB0aW1lIC0gbGFzdENhbGxUaW1lLAogICAgICAgICAgICB0aW1lU2luY2VMYXN0SW52b2tlID0gdGltZSAtIGxhc3RJbnZva2VUaW1lOwoKICAgICAgICAvLyBFaXRoZXIgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCwgYWN0aXZpdHkgaGFzIHN0b3BwZWQgYW5kIHdlJ3JlIGF0IHRoZQogICAgICAgIC8vIHRyYWlsaW5nIGVkZ2UsIHRoZSBzeXN0ZW0gdGltZSBoYXMgZ29uZSBiYWNrd2FyZHMgYW5kIHdlJ3JlIHRyZWF0aW5nCiAgICAgICAgLy8gaXQgYXMgdGhlIHRyYWlsaW5nIGVkZ2UsIG9yIHdlJ3ZlIGhpdCB0aGUgYG1heFdhaXRgIGxpbWl0LgogICAgICAgIHJldHVybiAobGFzdENhbGxUaW1lID09PSB1bmRlZmluZWQgfHwgKHRpbWVTaW5jZUxhc3RDYWxsID49IHdhaXQpIHx8CiAgICAgICAgICAodGltZVNpbmNlTGFzdENhbGwgPCAwKSB8fCAobWF4aW5nICYmIHRpbWVTaW5jZUxhc3RJbnZva2UgPj0gbWF4V2FpdCkpOwogICAgICB9CgogICAgICBmdW5jdGlvbiB0aW1lckV4cGlyZWQoKSB7CiAgICAgICAgdmFyIHRpbWUgPSBub3coKTsKICAgICAgICBpZiAoc2hvdWxkSW52b2tlKHRpbWUpKSB7CiAgICAgICAgICByZXR1cm4gdHJhaWxpbmdFZGdlKHRpbWUpOwogICAgICAgIH0KICAgICAgICAvLyBSZXN0YXJ0IHRoZSB0aW1lci4KICAgICAgICB0aW1lcklkID0gc2V0VGltZW91dCh0aW1lckV4cGlyZWQsIHJlbWFpbmluZ1dhaXQodGltZSkpOwogICAgICB9CgogICAgICBmdW5jdGlvbiB0cmFpbGluZ0VkZ2UodGltZSkgewogICAgICAgIHRpbWVySWQgPSB1bmRlZmluZWQ7CgogICAgICAgIC8vIE9ubHkgaW52b2tlIGlmIHdlIGhhdmUgYGxhc3RBcmdzYCB3aGljaCBtZWFucyBgZnVuY2AgaGFzIGJlZW4KICAgICAgICAvLyBkZWJvdW5jZWQgYXQgbGVhc3Qgb25jZS4KICAgICAgICBpZiAodHJhaWxpbmcgJiYgbGFzdEFyZ3MpIHsKICAgICAgICAgIHJldHVybiBpbnZva2VGdW5jKHRpbWUpOwogICAgICAgIH0KICAgICAgICBsYXN0QXJncyA9IGxhc3RUaGlzID0gdW5kZWZpbmVkOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNhbmNlbCgpIHsKICAgICAgICBpZiAodGltZXJJZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJJZCk7CiAgICAgICAgfQogICAgICAgIGxhc3RJbnZva2VUaW1lID0gMDsKICAgICAgICBsYXN0QXJncyA9IGxhc3RDYWxsVGltZSA9IGxhc3RUaGlzID0gdGltZXJJZCA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZmx1c2goKSB7CiAgICAgICAgcmV0dXJuIHRpbWVySWQgPT09IHVuZGVmaW5lZCA/IHJlc3VsdCA6IHRyYWlsaW5nRWRnZShub3coKSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGRlYm91bmNlZCgpIHsKICAgICAgICB2YXIgdGltZSA9IG5vdygpLAogICAgICAgICAgICBpc0ludm9raW5nID0gc2hvdWxkSW52b2tlKHRpbWUpOwoKICAgICAgICBsYXN0QXJncyA9IGFyZ3VtZW50czsKICAgICAgICBsYXN0VGhpcyA9IHRoaXM7CiAgICAgICAgbGFzdENhbGxUaW1lID0gdGltZTsKCiAgICAgICAgaWYgKGlzSW52b2tpbmcpIHsKICAgICAgICAgIGlmICh0aW1lcklkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGxlYWRpbmdFZGdlKGxhc3RDYWxsVGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF4aW5nKSB7CiAgICAgICAgICAgIC8vIEhhbmRsZSBpbnZvY2F0aW9ucyBpbiBhIHRpZ2h0IGxvb3AuCiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcklkKTsKICAgICAgICAgICAgdGltZXJJZCA9IHNldFRpbWVvdXQodGltZXJFeHBpcmVkLCB3YWl0KTsKICAgICAgICAgICAgcmV0dXJuIGludm9rZUZ1bmMobGFzdENhbGxUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRpbWVySWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGltZXJJZCA9IHNldFRpbWVvdXQodGltZXJFeHBpcmVkLCB3YWl0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBkZWJvdW5jZWQuY2FuY2VsID0gY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KCiAgICAvKioKICAgICAqIERlZmVycyBpbnZva2luZyB0aGUgYGZ1bmNgIHVudGlsIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzIGNsZWFyZWQuIEFueQogICAgICogYWRkaXRpb25hbCBhcmd1bWVudHMgYXJlIHByb3ZpZGVkIHRvIGBmdW5jYCB3aGVuIGl0J3MgaW52b2tlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb24KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlZmVyLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnc10gVGhlIGFyZ3VtZW50cyB0byBpbnZva2UgYGZ1bmNgIHdpdGguCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSB0aW1lciBpZC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5kZWZlcihmdW5jdGlvbih0ZXh0KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKHRleHQpOwogICAgICogfSwgJ2RlZmVycmVkJyk7CiAgICAgKiAvLyA9PiBMb2dzICdkZWZlcnJlZCcgYWZ0ZXIgb25lIG1pbGxpc2Vjb25kLgogICAgICovCiAgICB2YXIgZGVmZXIgPSBiYXNlUmVzdChmdW5jdGlvbihmdW5jLCBhcmdzKSB7CiAgICAgIHJldHVybiBiYXNlRGVsYXkoZnVuYywgMSwgYXJncyk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIEludm9rZXMgYGZ1bmNgIGFmdGVyIGB3YWl0YCBtaWxsaXNlY29uZHMuIEFueSBhZGRpdGlvbmFsIGFyZ3VtZW50cyBhcmUKICAgICAqIHByb3ZpZGVkIHRvIGBmdW5jYCB3aGVuIGl0J3MgaW52b2tlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb24KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlbGF5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgaW52b2NhdGlvbi4KICAgICAqIEBwYXJhbSB7Li4uKn0gW2FyZ3NdIFRoZSBhcmd1bWVudHMgdG8gaW52b2tlIGBmdW5jYCB3aXRoLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgdGltZXIgaWQuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZGVsYXkoZnVuY3Rpb24odGV4dCkgewogICAgICogICBjb25zb2xlLmxvZyh0ZXh0KTsKICAgICAqIH0sIDEwMDAsICdsYXRlcicpOwogICAgICogLy8gPT4gTG9ncyAnbGF0ZXInIGFmdGVyIG9uZSBzZWNvbmQuCiAgICAgKi8KICAgIHZhciBkZWxheSA9IGJhc2VSZXN0KGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGFyZ3MpIHsKICAgICAgcmV0dXJuIGJhc2VEZWxheShmdW5jLCB0b051bWJlcih3YWl0KSB8fCAwLCBhcmdzKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgaW52b2tlcyBgZnVuY2Agd2l0aCBhcmd1bWVudHMgcmV2ZXJzZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBmbGlwIGFyZ3VtZW50cyBmb3IuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBmbGlwcGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgZmxpcHBlZCA9IF8uZmxpcChmdW5jdGlvbigpIHsKICAgICAqICAgcmV0dXJuIF8udG9BcnJheShhcmd1bWVudHMpOwogICAgICogfSk7CiAgICAgKgogICAgICogZmxpcHBlZCgnYScsICdiJywgJ2MnLCAnZCcpOwogICAgICogLy8gPT4gWydkJywgJ2MnLCAnYicsICdhJ10KICAgICAqLwogICAgZnVuY3Rpb24gZmxpcChmdW5jKSB7CiAgICAgIHJldHVybiBjcmVhdGVXcmFwKGZ1bmMsIFdSQVBfRkxJUF9GTEFHKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IG1lbW9pemVzIHRoZSByZXN1bHQgb2YgYGZ1bmNgLiBJZiBgcmVzb2x2ZXJgIGlzCiAgICAgKiBwcm92aWRlZCwgaXQgZGV0ZXJtaW5lcyB0aGUgY2FjaGUga2V5IGZvciBzdG9yaW5nIHRoZSByZXN1bHQgYmFzZWQgb24gdGhlCiAgICAgKiBhcmd1bWVudHMgcHJvdmlkZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uLiBCeSBkZWZhdWx0LCB0aGUgZmlyc3QgYXJndW1lbnQKICAgICAqIHByb3ZpZGVkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbiBpcyB1c2VkIGFzIHRoZSBtYXAgY2FjaGUga2V5LiBUaGUgYGZ1bmNgCiAgICAgKiBpcyBpbnZva2VkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhlIGNhY2hlIGlzIGV4cG9zZWQgYXMgdGhlIGBjYWNoZWAgcHJvcGVydHkgb24gdGhlIG1lbW9pemVkCiAgICAgKiBmdW5jdGlvbi4gSXRzIGNyZWF0aW9uIG1heSBiZSBjdXN0b21pemVkIGJ5IHJlcGxhY2luZyB0aGUgYF8ubWVtb2l6ZS5DYWNoZWAKICAgICAqIGNvbnN0cnVjdG9yIHdpdGggb25lIHdob3NlIGluc3RhbmNlcyBpbXBsZW1lbnQgdGhlCiAgICAgKiBbYE1hcGBdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXByb3BlcnRpZXMtb2YtdGhlLW1hcC1wcm90b3R5cGUtb2JqZWN0KQogICAgICogbWV0aG9kIGludGVyZmFjZSBvZiBgY2xlYXJgLCBgZGVsZXRlYCwgYGdldGAsIGBoYXNgLCBhbmQgYHNldGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBoYXZlIGl0cyBvdXRwdXQgbWVtb2l6ZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcmVzb2x2ZXJdIFRoZSBmdW5jdGlvbiB0byByZXNvbHZlIHRoZSBjYWNoZSBrZXkuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBtZW1vaXplZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ2EnOiAxLCAnYic6IDIgfTsKICAgICAqIHZhciBvdGhlciA9IHsgJ2MnOiAzLCAnZCc6IDQgfTsKICAgICAqCiAgICAgKiB2YXIgdmFsdWVzID0gXy5tZW1vaXplKF8udmFsdWVzKTsKICAgICAqIHZhbHVlcyhvYmplY3QpOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogdmFsdWVzKG90aGVyKTsKICAgICAqIC8vID0+IFszLCA0XQogICAgICoKICAgICAqIG9iamVjdC5hID0gMjsKICAgICAqIHZhbHVlcyhvYmplY3QpOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogLy8gTW9kaWZ5IHRoZSByZXN1bHQgY2FjaGUuCiAgICAgKiB2YWx1ZXMuY2FjaGUuc2V0KG9iamVjdCwgWydhJywgJ2InXSk7CiAgICAgKiB2YWx1ZXMob2JqZWN0KTsKICAgICAqIC8vID0+IFsnYScsICdiJ10KICAgICAqCiAgICAgKiAvLyBSZXBsYWNlIGBfLm1lbW9pemUuQ2FjaGVgLgogICAgICogXy5tZW1vaXplLkNhY2hlID0gV2Vha01hcDsKICAgICAqLwogICAgZnVuY3Rpb24gbWVtb2l6ZShmdW5jLCByZXNvbHZlcikgewogICAgICBpZiAodHlwZW9mIGZ1bmMgIT0gJ2Z1bmN0aW9uJyB8fCAocmVzb2x2ZXIgIT0gbnVsbCAmJiB0eXBlb2YgcmVzb2x2ZXIgIT0gJ2Z1bmN0aW9uJykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKEZVTkNfRVJST1JfVEVYVCk7CiAgICAgIH0KICAgICAgdmFyIG1lbW9pemVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICAgIGtleSA9IHJlc29sdmVyID8gcmVzb2x2ZXIuYXBwbHkodGhpcywgYXJncykgOiBhcmdzWzBdLAogICAgICAgICAgICBjYWNoZSA9IG1lbW9pemVkLmNhY2hlOwoKICAgICAgICBpZiAoY2FjaGUuaGFzKGtleSkpIHsKICAgICAgICAgIHJldHVybiBjYWNoZS5nZXQoa2V5KTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgbWVtb2l6ZWQuY2FjaGUgPSBjYWNoZS5zZXQoa2V5LCByZXN1bHQpIHx8IGNhY2hlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG1lbW9pemVkLmNhY2hlID0gbmV3IChtZW1vaXplLkNhY2hlIHx8IE1hcENhY2hlKTsKICAgICAgcmV0dXJuIG1lbW9pemVkOwogICAgfQoKICAgIC8vIEV4cG9zZSBgTWFwQ2FjaGVgLgogICAgbWVtb2l6ZS5DYWNoZSA9IE1hcENhY2hlOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgbmVnYXRlcyB0aGUgcmVzdWx0IG9mIHRoZSBwcmVkaWNhdGUgYGZ1bmNgLiBUaGUKICAgICAqIGBmdW5jYCBwcmVkaWNhdGUgaXMgaW52b2tlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBhbmQgYXJndW1lbnRzIG9mIHRoZQogICAgICogY3JlYXRlZCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb24KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByZWRpY2F0ZSBUaGUgcHJlZGljYXRlIHRvIG5lZ2F0ZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IG5lZ2F0ZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIGlzRXZlbihuKSB7CiAgICAgKiAgIHJldHVybiBuICUgMiA9PSAwOwogICAgICogfQogICAgICoKICAgICAqIF8uZmlsdGVyKFsxLCAyLCAzLCA0LCA1LCA2XSwgXy5uZWdhdGUoaXNFdmVuKSk7CiAgICAgKiAvLyA9PiBbMSwgMywgNV0KICAgICAqLwogICAgZnVuY3Rpb24gbmVnYXRlKHByZWRpY2F0ZSkgewogICAgICBpZiAodHlwZW9mIHByZWRpY2F0ZSAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihGVU5DX0VSUk9SX1RFWFQpOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDA6IHJldHVybiAhcHJlZGljYXRlLmNhbGwodGhpcyk7CiAgICAgICAgICBjYXNlIDE6IHJldHVybiAhcHJlZGljYXRlLmNhbGwodGhpcywgYXJnc1swXSk7CiAgICAgICAgICBjYXNlIDI6IHJldHVybiAhcHJlZGljYXRlLmNhbGwodGhpcywgYXJnc1swXSwgYXJnc1sxXSk7CiAgICAgICAgICBjYXNlIDM6IHJldHVybiAhcHJlZGljYXRlLmNhbGwodGhpcywgYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAhcHJlZGljYXRlLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgaXMgcmVzdHJpY3RlZCB0byBpbnZva2luZyBgZnVuY2Agb25jZS4gUmVwZWF0IGNhbGxzCiAgICAgKiB0byB0aGUgZnVuY3Rpb24gcmV0dXJuIHRoZSB2YWx1ZSBvZiB0aGUgZmlyc3QgaW52b2NhdGlvbi4gVGhlIGBmdW5jYCBpcwogICAgICogaW52b2tlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBhbmQgYXJndW1lbnRzIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgaW5pdGlhbGl6ZSA9IF8ub25jZShjcmVhdGVBcHBsaWNhdGlvbik7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiAvLyA9PiBgY3JlYXRlQXBwbGljYXRpb25gIGlzIGludm9rZWQgb25jZQogICAgICovCiAgICBmdW5jdGlvbiBvbmNlKGZ1bmMpIHsKICAgICAgcmV0dXJuIGJlZm9yZSgyLCBmdW5jKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGludm9rZXMgYGZ1bmNgIHdpdGggaXRzIGFyZ3VtZW50cyB0cmFuc2Zvcm1lZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb24KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHdyYXAuCiAgICAgKiBAcGFyYW0gey4uLihGdW5jdGlvbnxGdW5jdGlvbltdKX0gW3RyYW5zZm9ybXM9W18uaWRlbnRpdHldXQogICAgICogIFRoZSBhcmd1bWVudCB0cmFuc2Zvcm1zLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIGRvdWJsZWQobikgewogICAgICogICByZXR1cm4gbiAqIDI7CiAgICAgKiB9CiAgICAgKgogICAgICogZnVuY3Rpb24gc3F1YXJlKG4pIHsKICAgICAqICAgcmV0dXJuIG4gKiBuOwogICAgICogfQogICAgICoKICAgICAqIHZhciBmdW5jID0gXy5vdmVyQXJncyhmdW5jdGlvbih4LCB5KSB7CiAgICAgKiAgIHJldHVybiBbeCwgeV07CiAgICAgKiB9LCBbc3F1YXJlLCBkb3VibGVkXSk7CiAgICAgKgogICAgICogZnVuYyg5LCAzKTsKICAgICAqIC8vID0+IFs4MSwgNl0KICAgICAqCiAgICAgKiBmdW5jKDEwLCA1KTsKICAgICAqIC8vID0+IFsxMDAsIDEwXQogICAgICovCiAgICB2YXIgb3ZlckFyZ3MgPSBjYXN0UmVzdChmdW5jdGlvbihmdW5jLCB0cmFuc2Zvcm1zKSB7CiAgICAgIHRyYW5zZm9ybXMgPSAodHJhbnNmb3Jtcy5sZW5ndGggPT0gMSAmJiBpc0FycmF5KHRyYW5zZm9ybXNbMF0pKQogICAgICAgID8gYXJyYXlNYXAodHJhbnNmb3Jtc1swXSwgYmFzZVVuYXJ5KGdldEl0ZXJhdGVlKCkpKQogICAgICAgIDogYXJyYXlNYXAoYmFzZUZsYXR0ZW4odHJhbnNmb3JtcywgMSksIGJhc2VVbmFyeShnZXRJdGVyYXRlZSgpKSk7CgogICAgICB2YXIgZnVuY3NMZW5ndGggPSB0cmFuc2Zvcm1zLmxlbmd0aDsKICAgICAgcmV0dXJuIGJhc2VSZXN0KGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgbGVuZ3RoID0gbmF0aXZlTWluKGFyZ3MubGVuZ3RoLCBmdW5jc0xlbmd0aCk7CgogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBhcmdzW2luZGV4XSA9IHRyYW5zZm9ybXNbaW5kZXhdLmNhbGwodGhpcywgYXJnc1tpbmRleF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXBwbHkoZnVuYywgdGhpcywgYXJncyk7CiAgICAgIH0pOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpbnZva2VzIGBmdW5jYCB3aXRoIGBwYXJ0aWFsc2AgcHJlcGVuZGVkIHRvIHRoZQogICAgICogYXJndW1lbnRzIGl0IHJlY2VpdmVzLiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmJpbmRgIGV4Y2VwdCBpdCBkb2VzICoqbm90KioKICAgICAqIGFsdGVyIHRoZSBgdGhpc2AgYmluZGluZy4KICAgICAqCiAgICAgKiBUaGUgYF8ucGFydGlhbC5wbGFjZWhvbGRlcmAgdmFsdWUsIHdoaWNoIGRlZmF1bHRzIHRvIGBfYCBpbiBtb25vbGl0aGljCiAgICAgKiBidWlsZHMsIG1heSBiZSB1c2VkIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHBhcnRpYWxseSBhcHBsaWVkIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgZG9lc24ndCBzZXQgdGhlICJsZW5ndGgiIHByb3BlcnR5IG9mIHBhcnRpYWxseQogICAgICogYXBwbGllZCBmdW5jdGlvbnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjIuMAogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAgICogQHBhcmFtIHsuLi4qfSBbcGFydGlhbHNdIFRoZSBhcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gZ3JlZXQoZ3JlZXRpbmcsIG5hbWUpIHsKICAgICAqICAgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgbmFtZTsKICAgICAqIH0KICAgICAqCiAgICAgKiB2YXIgc2F5SGVsbG9UbyA9IF8ucGFydGlhbChncmVldCwgJ2hlbGxvJyk7CiAgICAgKiBzYXlIZWxsb1RvKCdmcmVkJyk7CiAgICAgKiAvLyA9PiAnaGVsbG8gZnJlZCcKICAgICAqCiAgICAgKiAvLyBQYXJ0aWFsbHkgYXBwbGllZCB3aXRoIHBsYWNlaG9sZGVycy4KICAgICAqIHZhciBncmVldEZyZWQgPSBfLnBhcnRpYWwoZ3JlZXQsIF8sICdmcmVkJyk7CiAgICAgKiBncmVldEZyZWQoJ2hpJyk7CiAgICAgKiAvLyA9PiAnaGkgZnJlZCcKICAgICAqLwogICAgdmFyIHBhcnRpYWwgPSBiYXNlUmVzdChmdW5jdGlvbihmdW5jLCBwYXJ0aWFscykgewogICAgICB2YXIgaG9sZGVycyA9IHJlcGxhY2VIb2xkZXJzKHBhcnRpYWxzLCBnZXRIb2xkZXIocGFydGlhbCkpOwogICAgICByZXR1cm4gY3JlYXRlV3JhcChmdW5jLCBXUkFQX1BBUlRJQUxfRkxBRywgdW5kZWZpbmVkLCBwYXJ0aWFscywgaG9sZGVycyk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8ucGFydGlhbGAgZXhjZXB0IHRoYXQgcGFydGlhbGx5IGFwcGxpZWQgYXJndW1lbnRzCiAgICAgKiBhcmUgYXBwZW5kZWQgdG8gdGhlIGFyZ3VtZW50cyBpdCByZWNlaXZlcy4KICAgICAqCiAgICAgKiBUaGUgYF8ucGFydGlhbFJpZ2h0LnBsYWNlaG9sZGVyYCB2YWx1ZSwgd2hpY2ggZGVmYXVsdHMgdG8gYF9gIGluIG1vbm9saXRoaWMKICAgICAqIGJ1aWxkcywgbWF5IGJlIHVzZWQgYXMgYSBwbGFjZWhvbGRlciBmb3IgcGFydGlhbGx5IGFwcGxpZWQgYXJndW1lbnRzLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBkb2Vzbid0IHNldCB0aGUgImxlbmd0aCIgcHJvcGVydHkgb2YgcGFydGlhbGx5CiAgICAgKiBhcHBsaWVkIGZ1bmN0aW9ucy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDEuMC4wCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb24KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHBhcnRpYWxseSBhcHBseSBhcmd1bWVudHMgdG8uCiAgICAgKiBAcGFyYW0gey4uLip9IFtwYXJ0aWFsc10gVGhlIGFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHBhcnRpYWxseSBhcHBsaWVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBncmVldChncmVldGluZywgbmFtZSkgewogICAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyBuYW1lOwogICAgICogfQogICAgICoKICAgICAqIHZhciBncmVldEZyZWQgPSBfLnBhcnRpYWxSaWdodChncmVldCwgJ2ZyZWQnKTsKICAgICAqIGdyZWV0RnJlZCgnaGknKTsKICAgICAqIC8vID0+ICdoaSBmcmVkJwogICAgICoKICAgICAqIC8vIFBhcnRpYWxseSBhcHBsaWVkIHdpdGggcGxhY2Vob2xkZXJzLgogICAgICogdmFyIHNheUhlbGxvVG8gPSBfLnBhcnRpYWxSaWdodChncmVldCwgJ2hlbGxvJywgXyk7CiAgICAgKiBzYXlIZWxsb1RvKCdmcmVkJyk7CiAgICAgKiAvLyA9PiAnaGVsbG8gZnJlZCcKICAgICAqLwogICAgdmFyIHBhcnRpYWxSaWdodCA9IGJhc2VSZXN0KGZ1bmN0aW9uKGZ1bmMsIHBhcnRpYWxzKSB7CiAgICAgIHZhciBob2xkZXJzID0gcmVwbGFjZUhvbGRlcnMocGFydGlhbHMsIGdldEhvbGRlcihwYXJ0aWFsUmlnaHQpKTsKICAgICAgcmV0dXJuIGNyZWF0ZVdyYXAoZnVuYywgV1JBUF9QQVJUSUFMX1JJR0hUX0ZMQUcsIHVuZGVmaW5lZCwgcGFydGlhbHMsIGhvbGRlcnMpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpbnZva2VzIGBmdW5jYCB3aXRoIGFyZ3VtZW50cyBhcnJhbmdlZCBhY2NvcmRpbmcKICAgICAqIHRvIHRoZSBzcGVjaWZpZWQgYGluZGV4ZXNgIHdoZXJlIHRoZSBhcmd1bWVudCB2YWx1ZSBhdCB0aGUgZmlyc3QgaW5kZXggaXMKICAgICAqIHByb3ZpZGVkIGFzIHRoZSBmaXJzdCBhcmd1bWVudCwgdGhlIGFyZ3VtZW50IHZhbHVlIGF0IHRoZSBzZWNvbmQgaW5kZXggaXMKICAgICAqIHByb3ZpZGVkIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQsIGFuZCBzbyBvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb24KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHJlYXJyYW5nZSBhcmd1bWVudHMgZm9yLgogICAgICogQHBhcmFtIHsuLi4obnVtYmVyfG51bWJlcltdKX0gaW5kZXhlcyBUaGUgYXJyYW5nZWQgYXJndW1lbnQgaW5kZXhlcy4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgcmVhcmdlZCA9IF8ucmVhcmcoZnVuY3Rpb24oYSwgYiwgYykgewogICAgICogICByZXR1cm4gW2EsIGIsIGNdOwogICAgICogfSwgWzIsIDAsIDFdKTsKICAgICAqCiAgICAgKiByZWFyZ2VkKCdiJywgJ2MnLCAnYScpCiAgICAgKiAvLyA9PiBbJ2EnLCAnYicsICdjJ10KICAgICAqLwogICAgdmFyIHJlYXJnID0gZmxhdFJlc3QoZnVuY3Rpb24oZnVuYywgaW5kZXhlcykgewogICAgICByZXR1cm4gY3JlYXRlV3JhcChmdW5jLCBXUkFQX1JFQVJHX0ZMQUcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGluZGV4ZXMpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUKICAgICAqIGNyZWF0ZWQgZnVuY3Rpb24gYW5kIGFyZ3VtZW50cyBmcm9tIGBzdGFydGAgYW5kIGJleW9uZCBwcm92aWRlZCBhcwogICAgICogYW4gYXJyYXkuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIGlzIGJhc2VkIG9uIHRoZQogICAgICogW3Jlc3QgcGFyYW1ldGVyXShodHRwczovL21kbi5pby9yZXN0X3BhcmFtZXRlcnMpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gYXBwbHkgYSByZXN0IHBhcmFtZXRlciB0by4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnQ9ZnVuYy5sZW5ndGgtMV0gVGhlIHN0YXJ0IHBvc2l0aW9uIG9mIHRoZSByZXN0IHBhcmFtZXRlci4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc2F5ID0gXy5yZXN0KGZ1bmN0aW9uKHdoYXQsIG5hbWVzKSB7CiAgICAgKiAgIHJldHVybiB3aGF0ICsgJyAnICsgXy5pbml0aWFsKG5hbWVzKS5qb2luKCcsICcpICsKICAgICAqICAgICAoXy5zaXplKG5hbWVzKSA+IDEgPyAnLCAmICcgOiAnJykgKyBfLmxhc3QobmFtZXMpOwogICAgICogfSk7CiAgICAgKgogICAgICogc2F5KCdoZWxsbycsICdmcmVkJywgJ2Jhcm5leScsICdwZWJibGVzJyk7CiAgICAgKiAvLyA9PiAnaGVsbG8gZnJlZCwgYmFybmV5LCAmIHBlYmJsZXMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlc3QoZnVuYywgc3RhcnQpIHsKICAgICAgaWYgKHR5cGVvZiBmdW5jICE9ICdmdW5jdGlvbicpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKEZVTkNfRVJST1JfVEVYVCk7CiAgICAgIH0KICAgICAgc3RhcnQgPSBzdGFydCA9PT0gdW5kZWZpbmVkID8gc3RhcnQgOiB0b0ludGVnZXIoc3RhcnQpOwogICAgICByZXR1cm4gYmFzZVJlc3QoZnVuYywgc3RhcnQpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgaW52b2tlcyBgZnVuY2Agd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlCiAgICAgKiBjcmVhdGUgZnVuY3Rpb24gYW5kIGFuIGFycmF5IG9mIGFyZ3VtZW50cyBtdWNoIGxpa2UKICAgICAqIFtgRnVuY3Rpb24jYXBwbHlgXShodHRwOi8vd3d3LmVjbWEtaW50ZXJuYXRpb25hbC5vcmcvZWNtYS0yNjIvNy4wLyNzZWMtZnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5KS4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgaXMgYmFzZWQgb24gdGhlCiAgICAgKiBbc3ByZWFkIG9wZXJhdG9yXShodHRwczovL21kbi5pby9zcHJlYWRfb3BlcmF0b3IpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4yLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gc3ByZWFkIGFyZ3VtZW50cyBvdmVyLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydD0wXSBUaGUgc3RhcnQgcG9zaXRpb24gb2YgdGhlIHNwcmVhZC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc2F5ID0gXy5zcHJlYWQoZnVuY3Rpb24od2hvLCB3aGF0KSB7CiAgICAgKiAgIHJldHVybiB3aG8gKyAnIHNheXMgJyArIHdoYXQ7CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBzYXkoWydmcmVkJywgJ2hlbGxvJ10pOwogICAgICogLy8gPT4gJ2ZyZWQgc2F5cyBoZWxsbycKICAgICAqCiAgICAgKiB2YXIgbnVtYmVycyA9IFByb21pc2UuYWxsKFsKICAgICAqICAgUHJvbWlzZS5yZXNvbHZlKDQwKSwKICAgICAqICAgUHJvbWlzZS5yZXNvbHZlKDM2KQogICAgICogXSk7CiAgICAgKgogICAgICogbnVtYmVycy50aGVuKF8uc3ByZWFkKGZ1bmN0aW9uKHgsIHkpIHsKICAgICAqICAgcmV0dXJuIHggKyB5OwogICAgICogfSkpOwogICAgICogLy8gPT4gYSBQcm9taXNlIG9mIDc2CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNwcmVhZChmdW5jLCBzdGFydCkgewogICAgICBpZiAodHlwZW9mIGZ1bmMgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoRlVOQ19FUlJPUl9URVhUKTsKICAgICAgfQogICAgICBzdGFydCA9IHN0YXJ0ID09IG51bGwgPyAwIDogbmF0aXZlTWF4KHRvSW50ZWdlcihzdGFydCksIDApOwogICAgICByZXR1cm4gYmFzZVJlc3QoZnVuY3Rpb24oYXJncykgewogICAgICAgIHZhciBhcnJheSA9IGFyZ3Nbc3RhcnRdLAogICAgICAgICAgICBvdGhlckFyZ3MgPSBjYXN0U2xpY2UoYXJncywgMCwgc3RhcnQpOwoKICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgIGFycmF5UHVzaChvdGhlckFyZ3MsIGFycmF5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFwcGx5KGZ1bmMsIHRoaXMsIG90aGVyQXJncyk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHRocm90dGxlZCBmdW5jdGlvbiB0aGF0IG9ubHkgaW52b2tlcyBgZnVuY2AgYXQgbW9zdCBvbmNlIHBlcgogICAgICogZXZlcnkgYHdhaXRgIG1pbGxpc2Vjb25kcy4gVGhlIHRocm90dGxlZCBmdW5jdGlvbiBjb21lcyB3aXRoIGEgYGNhbmNlbGAKICAgICAqIG1ldGhvZCB0byBjYW5jZWwgZGVsYXllZCBgZnVuY2AgaW52b2NhdGlvbnMgYW5kIGEgYGZsdXNoYCBtZXRob2QgdG8KICAgICAqIGltbWVkaWF0ZWx5IGludm9rZSB0aGVtLiBQcm92aWRlIGBvcHRpb25zYCB0byBpbmRpY2F0ZSB3aGV0aGVyIGBmdW5jYAogICAgICogc2hvdWxkIGJlIGludm9rZWQgb24gdGhlIGxlYWRpbmcgYW5kL29yIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIGB3YWl0YAogICAgICogdGltZW91dC4gVGhlIGBmdW5jYCBpcyBpbnZva2VkIHdpdGggdGhlIGxhc3QgYXJndW1lbnRzIHByb3ZpZGVkIHRvIHRoZQogICAgICogdGhyb3R0bGVkIGZ1bmN0aW9uLiBTdWJzZXF1ZW50IGNhbGxzIHRvIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gcmV0dXJuIHRoZQogICAgICogcmVzdWx0IG9mIHRoZSBsYXN0IGBmdW5jYCBpbnZvY2F0aW9uLgogICAgICoKICAgICAqICoqTm90ZToqKiBJZiBgbGVhZGluZ2AgYW5kIGB0cmFpbGluZ2Agb3B0aW9ucyBhcmUgYHRydWVgLCBgZnVuY2AgaXMKICAgICAqIGludm9rZWQgb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQgb25seSBpZiB0aGUgdGhyb3R0bGVkIGZ1bmN0aW9uCiAgICAgKiBpcyBpbnZva2VkIG1vcmUgdGhhbiBvbmNlIGR1cmluZyB0aGUgYHdhaXRgIHRpbWVvdXQuCiAgICAgKgogICAgICogSWYgYHdhaXRgIGlzIGAwYCBhbmQgYGxlYWRpbmdgIGlzIGBmYWxzZWAsIGBmdW5jYCBpbnZvY2F0aW9uIGlzIGRlZmVycmVkCiAgICAgKiB1bnRpbCB0byB0aGUgbmV4dCB0aWNrLCBzaW1pbGFyIHRvIGBzZXRUaW1lb3V0YCB3aXRoIGEgdGltZW91dCBvZiBgMGAuCiAgICAgKgogICAgICogU2VlIFtEYXZpZCBDb3JiYWNobydzIGFydGljbGVdKGh0dHBzOi8vY3NzLXRyaWNrcy5jb20vZGVib3VuY2luZy10aHJvdHRsaW5nLWV4cGxhaW5lZC1leGFtcGxlcy8pCiAgICAgKiBmb3IgZGV0YWlscyBvdmVyIHRoZSBkaWZmZXJlbmNlcyBiZXR3ZWVuIGBfLnRocm90dGxlYCBhbmQgYF8uZGVib3VuY2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gdGhyb3R0bGUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3dhaXQ9MF0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdGhyb3R0bGUgaW52b2NhdGlvbnMgdG8uCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dIFRoZSBvcHRpb25zIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMubGVhZGluZz10cnVlXQogICAgICogIFNwZWNpZnkgaW52b2tpbmcgb24gdGhlIGxlYWRpbmcgZWRnZSBvZiB0aGUgdGltZW91dC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMudHJhaWxpbmc9dHJ1ZV0KICAgICAqICBTcGVjaWZ5IGludm9raW5nIG9uIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgdGhyb3R0bGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAvLyBBdm9pZCBleGNlc3NpdmVseSB1cGRhdGluZyB0aGUgcG9zaXRpb24gd2hpbGUgc2Nyb2xsaW5nLgogICAgICogalF1ZXJ5KHdpbmRvdykub24oJ3Njcm9sbCcsIF8udGhyb3R0bGUodXBkYXRlUG9zaXRpb24sIDEwMCkpOwogICAgICoKICAgICAqIC8vIEludm9rZSBgcmVuZXdUb2tlbmAgd2hlbiB0aGUgY2xpY2sgZXZlbnQgaXMgZmlyZWQsIGJ1dCBub3QgbW9yZSB0aGFuIG9uY2UgZXZlcnkgNSBtaW51dGVzLgogICAgICogdmFyIHRocm90dGxlZCA9IF8udGhyb3R0bGUocmVuZXdUb2tlbiwgMzAwMDAwLCB7ICd0cmFpbGluZyc6IGZhbHNlIH0pOwogICAgICogalF1ZXJ5KGVsZW1lbnQpLm9uKCdjbGljaycsIHRocm90dGxlZCk7CiAgICAgKgogICAgICogLy8gQ2FuY2VsIHRoZSB0cmFpbGluZyB0aHJvdHRsZWQgaW52b2NhdGlvbi4KICAgICAqIGpRdWVyeSh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRocm90dGxlZC5jYW5jZWwpOwogICAgICovCiAgICBmdW5jdGlvbiB0aHJvdHRsZShmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICAgIHZhciBsZWFkaW5nID0gdHJ1ZSwKICAgICAgICAgIHRyYWlsaW5nID0gdHJ1ZTsKCiAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihGVU5DX0VSUk9SX1RFWFQpOwogICAgICB9CiAgICAgIGlmIChpc09iamVjdChvcHRpb25zKSkgewogICAgICAgIGxlYWRpbmcgPSAnbGVhZGluZycgaW4gb3B0aW9ucyA/ICEhb3B0aW9ucy5sZWFkaW5nIDogbGVhZGluZzsKICAgICAgICB0cmFpbGluZyA9ICd0cmFpbGluZycgaW4gb3B0aW9ucyA/ICEhb3B0aW9ucy50cmFpbGluZyA6IHRyYWlsaW5nOwogICAgICB9CiAgICAgIHJldHVybiBkZWJvdW5jZShmdW5jLCB3YWl0LCB7CiAgICAgICAgJ2xlYWRpbmcnOiBsZWFkaW5nLAogICAgICAgICdtYXhXYWl0Jzogd2FpdCwKICAgICAgICAndHJhaWxpbmcnOiB0cmFpbGluZwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgdXAgdG8gb25lIGFyZ3VtZW50LCBpZ25vcmluZyBhbnkKICAgICAqIGFkZGl0aW9uYWwgYXJndW1lbnRzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gY2FwIGFyZ3VtZW50cyBmb3IuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBjYXBwZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWFwKFsnNicsICc4JywgJzEwJ10sIF8udW5hcnkocGFyc2VJbnQpKTsKICAgICAqIC8vID0+IFs2LCA4LCAxMF0KICAgICAqLwogICAgZnVuY3Rpb24gdW5hcnkoZnVuYykgewogICAgICByZXR1cm4gYXJ5KGZ1bmMsIDEpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcHJvdmlkZXMgYHZhbHVlYCB0byBgd3JhcHBlcmAgYXMgaXRzIGZpcnN0CiAgICAgKiBhcmd1bWVudC4gQW55IGFkZGl0aW9uYWwgYXJndW1lbnRzIHByb3ZpZGVkIHRvIHRoZSBmdW5jdGlvbiBhcmUgYXBwZW5kZWQKICAgICAqIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSBgd3JhcHBlcmAuIFRoZSB3cmFwcGVyIGlzIGludm9rZWQgd2l0aCB0aGUgYHRoaXNgCiAgICAgKiBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd3JhcC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFt3cmFwcGVyPWlkZW50aXR5XSBUaGUgd3JhcHBlciBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgcCA9IF8ud3JhcChfLmVzY2FwZSwgZnVuY3Rpb24oZnVuYywgdGV4dCkgewogICAgICogICByZXR1cm4gJzxwPicgKyBmdW5jKHRleHQpICsgJzwvcD4nOwogICAgICogfSk7CiAgICAgKgogICAgICogcCgnZnJlZCwgYmFybmV5LCAmIHBlYmJsZXMnKTsKICAgICAqIC8vID0+ICc8cD5mcmVkLCBiYXJuZXksICZhbXA7IHBlYmJsZXM8L3A+JwogICAgICovCiAgICBmdW5jdGlvbiB3cmFwKHZhbHVlLCB3cmFwcGVyKSB7CiAgICAgIHJldHVybiBwYXJ0aWFsKGNhc3RGdW5jdGlvbih3cmFwcGVyKSwgdmFsdWUpOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENhc3RzIGB2YWx1ZWAgYXMgYW4gYXJyYXkgaWYgaXQncyBub3Qgb25lLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC40LjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBjYXN0IGFycmF5LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmNhc3RBcnJheSgxKTsKICAgICAqIC8vID0+IFsxXQogICAgICoKICAgICAqIF8uY2FzdEFycmF5KHsgJ2EnOiAxIH0pOwogICAgICogLy8gPT4gW3sgJ2EnOiAxIH1dCiAgICAgKgogICAgICogXy5jYXN0QXJyYXkoJ2FiYycpOwogICAgICogLy8gPT4gWydhYmMnXQogICAgICoKICAgICAqIF8uY2FzdEFycmF5KG51bGwpOwogICAgICogLy8gPT4gW251bGxdCiAgICAgKgogICAgICogXy5jYXN0QXJyYXkodW5kZWZpbmVkKTsKICAgICAqIC8vID0+IFt1bmRlZmluZWRdCiAgICAgKgogICAgICogXy5jYXN0QXJyYXkoKTsKICAgICAqIC8vID0+IFtdCiAgICAgKgogICAgICogdmFyIGFycmF5ID0gWzEsIDIsIDNdOwogICAgICogY29uc29sZS5sb2coXy5jYXN0QXJyYXkoYXJyYXkpID09PSBhcnJheSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhc3RBcnJheSgpIHsKICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIHZhciB2YWx1ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgcmV0dXJuIGlzQXJyYXkodmFsdWUpID8gdmFsdWUgOiBbdmFsdWVdOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYHZhbHVlYC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgaXMgbG9vc2VseSBiYXNlZCBvbiB0aGUKICAgICAqIFtzdHJ1Y3R1cmVkIGNsb25lIGFsZ29yaXRobV0oaHR0cHM6Ly9tZG4uaW8vU3RydWN0dXJlZF9jbG9uZV9hbGdvcml0aG0pCiAgICAgKiBhbmQgc3VwcG9ydHMgY2xvbmluZyBhcnJheXMsIGFycmF5IGJ1ZmZlcnMsIGJvb2xlYW5zLCBkYXRlIG9iamVjdHMsIG1hcHMsCiAgICAgKiBudW1iZXJzLCBgT2JqZWN0YCBvYmplY3RzLCByZWdleGVzLCBzZXRzLCBzdHJpbmdzLCBzeW1ib2xzLCBhbmQgdHlwZWQKICAgICAqIGFycmF5cy4gVGhlIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYGFyZ3VtZW50c2Agb2JqZWN0cyBhcmUgY2xvbmVkCiAgICAgKiBhcyBwbGFpbiBvYmplY3RzLiBBbiBlbXB0eSBvYmplY3QgaXMgcmV0dXJuZWQgZm9yIHVuY2xvbmVhYmxlIHZhbHVlcyBzdWNoCiAgICAgKiBhcyBlcnJvciBvYmplY3RzLCBmdW5jdGlvbnMsIERPTSBub2RlcywgYW5kIFdlYWtNYXBzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKiBAc2VlIF8uY2xvbmVEZWVwCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3RzID0gW3sgJ2EnOiAxIH0sIHsgJ2InOiAyIH1dOwogICAgICoKICAgICAqIHZhciBzaGFsbG93ID0gXy5jbG9uZShvYmplY3RzKTsKICAgICAqIGNvbnNvbGUubG9nKHNoYWxsb3dbMF0gPT09IG9iamVjdHNbMF0pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBjbG9uZSh2YWx1ZSkgewogICAgICByZXR1cm4gYmFzZUNsb25lKHZhbHVlLCBDTE9ORV9TWU1CT0xTX0ZMQUcpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5jbG9uZWAgZXhjZXB0IHRoYXQgaXQgYWNjZXB0cyBgY3VzdG9taXplcmAgd2hpY2gKICAgICAqIGlzIGludm9rZWQgdG8gcHJvZHVjZSB0aGUgY2xvbmVkIHZhbHVlLiBJZiBgY3VzdG9taXplcmAgcmV0dXJucyBgdW5kZWZpbmVkYCwKICAgICAqIGNsb25pbmcgaXMgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBgY3VzdG9taXplcmAgaXMgaW52b2tlZCB3aXRoCiAgICAgKiB1cCB0byBmb3VyIGFyZ3VtZW50czsgKHZhbHVlIFssIGluZGV4fGtleSwgb2JqZWN0LCBzdGFja10pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjdXN0b21pemVyXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNsb25pbmcuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgY2xvbmVkIHZhbHVlLgogICAgICogQHNlZSBfLmNsb25lRGVlcFdpdGgKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gY3VzdG9taXplcih2YWx1ZSkgewogICAgICogICBpZiAoXy5pc0VsZW1lbnQodmFsdWUpKSB7CiAgICAgKiAgICAgcmV0dXJuIHZhbHVlLmNsb25lTm9kZShmYWxzZSk7CiAgICAgKiAgIH0KICAgICAqIH0KICAgICAqCiAgICAgKiB2YXIgZWwgPSBfLmNsb25lV2l0aChkb2N1bWVudC5ib2R5LCBjdXN0b21pemVyKTsKICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhlbCA9PT0gZG9jdW1lbnQuYm9keSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICogY29uc29sZS5sb2coZWwubm9kZU5hbWUpOwogICAgICogLy8gPT4gJ0JPRFknCiAgICAgKiBjb25zb2xlLmxvZyhlbC5jaGlsZE5vZGVzLmxlbmd0aCk7CiAgICAgKiAvLyA9PiAwCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lV2l0aCh2YWx1ZSwgY3VzdG9taXplcikgewogICAgICBjdXN0b21pemVyID0gdHlwZW9mIGN1c3RvbWl6ZXIgPT0gJ2Z1bmN0aW9uJyA/IGN1c3RvbWl6ZXIgOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBiYXNlQ2xvbmUodmFsdWUsIENMT05FX1NZTUJPTFNfRkxBRywgY3VzdG9taXplcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmNsb25lYCBleGNlcHQgdGhhdCBpdCByZWN1cnNpdmVseSBjbG9uZXMgYHZhbHVlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDEuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcmVjdXJzaXZlbHkgY2xvbmUuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZGVlcCBjbG9uZWQgdmFsdWUuCiAgICAgKiBAc2VlIF8uY2xvbmUKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdHMgPSBbeyAnYSc6IDEgfSwgeyAnYic6IDIgfV07CiAgICAgKgogICAgICogdmFyIGRlZXAgPSBfLmNsb25lRGVlcChvYmplY3RzKTsKICAgICAqIGNvbnNvbGUubG9nKGRlZXBbMF0gPT09IG9iamVjdHNbMF0pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gY2xvbmVEZWVwKHZhbHVlKSB7CiAgICAgIHJldHVybiBiYXNlQ2xvbmUodmFsdWUsIENMT05FX0RFRVBfRkxBRyB8IENMT05FX1NZTUJPTFNfRkxBRyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmNsb25lV2l0aGAgZXhjZXB0IHRoYXQgaXQgcmVjdXJzaXZlbHkgY2xvbmVzIGB2YWx1ZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHJlY3Vyc2l2ZWx5IGNsb25lLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2N1c3RvbWl6ZXJdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZy4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBkZWVwIGNsb25lZCB2YWx1ZS4KICAgICAqIEBzZWUgXy5jbG9uZVdpdGgKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gY3VzdG9taXplcih2YWx1ZSkgewogICAgICogICBpZiAoXy5pc0VsZW1lbnQodmFsdWUpKSB7CiAgICAgKiAgICAgcmV0dXJuIHZhbHVlLmNsb25lTm9kZSh0cnVlKTsKICAgICAqICAgfQogICAgICogfQogICAgICoKICAgICAqIHZhciBlbCA9IF8uY2xvbmVEZWVwV2l0aChkb2N1bWVudC5ib2R5LCBjdXN0b21pemVyKTsKICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhlbCA9PT0gZG9jdW1lbnQuYm9keSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICogY29uc29sZS5sb2coZWwubm9kZU5hbWUpOwogICAgICogLy8gPT4gJ0JPRFknCiAgICAgKiBjb25zb2xlLmxvZyhlbC5jaGlsZE5vZGVzLmxlbmd0aCk7CiAgICAgKiAvLyA9PiAyMAogICAgICovCiAgICBmdW5jdGlvbiBjbG9uZURlZXBXaXRoKHZhbHVlLCBjdXN0b21pemVyKSB7CiAgICAgIGN1c3RvbWl6ZXIgPSB0eXBlb2YgY3VzdG9taXplciA9PSAnZnVuY3Rpb24nID8gY3VzdG9taXplciA6IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIGJhc2VDbG9uZSh2YWx1ZSwgQ0xPTkVfREVFUF9GTEFHIHwgQ0xPTkVfU1lNQk9MU19GTEFHLCBjdXN0b21pemVyKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgb2JqZWN0YCBjb25mb3JtcyB0byBgc291cmNlYCBieSBpbnZva2luZyB0aGUgcHJlZGljYXRlCiAgICAgKiBwcm9wZXJ0aWVzIG9mIGBzb3VyY2VgIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdmFsdWVzIG9mIGBvYmplY3RgLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBpcyBlcXVpdmFsZW50IHRvIGBfLmNvbmZvcm1zYCB3aGVuIGBzb3VyY2VgIGlzCiAgICAgKiBwYXJ0aWFsbHkgYXBwbGllZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMTQuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IG9mIHByb3BlcnR5IHByZWRpY2F0ZXMgdG8gY29uZm9ybSB0by4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgb2JqZWN0YCBjb25mb3JtcywgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnYSc6IDEsICdiJzogMiB9OwogICAgICoKICAgICAqIF8uY29uZm9ybXNUbyhvYmplY3QsIHsgJ2InOiBmdW5jdGlvbihuKSB7IHJldHVybiBuID4gMTsgfSB9KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmNvbmZvcm1zVG8ob2JqZWN0LCB7ICdiJzogZnVuY3Rpb24obikgeyByZXR1cm4gbiA+IDI7IH0gfSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBjb25mb3Jtc1RvKG9iamVjdCwgc291cmNlKSB7CiAgICAgIHJldHVybiBzb3VyY2UgPT0gbnVsbCB8fCBiYXNlQ29uZm9ybXNUbyhvYmplY3QsIHNvdXJjZSwga2V5cyhzb3VyY2UpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFBlcmZvcm1zIGEKICAgICAqIFtgU2FtZVZhbHVlWmVyb2BdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXNhbWV2YWx1ZXplcm8pCiAgICAgKiBjb21wYXJpc29uIGJldHdlZW4gdHdvIHZhbHVlcyB0byBkZXRlcm1pbmUgaWYgdGhleSBhcmUgZXF1aXZhbGVudC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gb3RoZXIgVGhlIG90aGVyIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHZhbHVlcyBhcmUgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnYSc6IDEgfTsKICAgICAqIHZhciBvdGhlciA9IHsgJ2EnOiAxIH07CiAgICAgKgogICAgICogXy5lcShvYmplY3QsIG9iamVjdCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5lcShvYmplY3QsIG90aGVyKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5lcSgnYScsICdhJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5lcSgnYScsIE9iamVjdCgnYScpKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5lcShOYU4sIE5hTik7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVxKHZhbHVlLCBvdGhlcikgewogICAgICByZXR1cm4gdmFsdWUgPT09IG90aGVyIHx8ICh2YWx1ZSAhPT0gdmFsdWUgJiYgb3RoZXIgIT09IG90aGVyKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGdyZWF0ZXIgdGhhbiBgb3RoZXJgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy45LjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBvdGhlciBUaGUgb3RoZXIgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGdyZWF0ZXIgdGhhbiBgb3RoZXJgLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBzZWUgXy5sdAogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmd0KDMsIDEpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uZ3QoMywgMyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uZ3QoMSwgMyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICB2YXIgZ3QgPSBjcmVhdGVSZWxhdGlvbmFsT3BlcmF0aW9uKGJhc2VHdCk7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gYG90aGVyYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuOS4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gb3RoZXIgVGhlIG90aGVyIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8KICAgICAqICBgb3RoZXJgLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAc2VlIF8ubHRlCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZ3RlKDMsIDEpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uZ3RlKDMsIDMpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uZ3RlKDEsIDMpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgdmFyIGd0ZSA9IGNyZWF0ZVJlbGF0aW9uYWxPcGVyYXRpb24oZnVuY3Rpb24odmFsdWUsIG90aGVyKSB7CiAgICAgIHJldHVybiB2YWx1ZSA+PSBvdGhlcjsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgbGlrZWx5IGFuIGBhcmd1bWVudHNgIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QsCiAgICAgKiAgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzQXJndW1lbnRzKGZ1bmN0aW9uKCkgeyByZXR1cm4gYXJndW1lbnRzOyB9KCkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNBcmd1bWVudHMoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIHZhciBpc0FyZ3VtZW50cyA9IGJhc2VJc0FyZ3VtZW50cyhmdW5jdGlvbigpIHsgcmV0dXJuIGFyZ3VtZW50czsgfSgpKSA/IGJhc2VJc0FyZ3VtZW50cyA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBpc09iamVjdExpa2UodmFsdWUpICYmIGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdjYWxsZWUnKSAmJgogICAgICAgICFwcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKHZhbHVlLCAnY2FsbGVlJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgY2xhc3NpZmllZCBhcyBhbiBgQXJyYXlgIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhbiBhcnJheSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoZG9jdW1lbnQuYm9keS5jaGlsZHJlbik7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNBcnJheSgnYWJjJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNBcnJheShfLm5vb3ApOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5OwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgY2xhc3NpZmllZCBhcyBhbiBgQXJyYXlCdWZmZXJgIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMy4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhbiBhcnJheSBidWZmZXIsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0FycmF5QnVmZmVyKG5ldyBBcnJheUJ1ZmZlcigyKSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc0FycmF5QnVmZmVyKG5ldyBBcnJheSgyKSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICB2YXIgaXNBcnJheUJ1ZmZlciA9IG5vZGVJc0FycmF5QnVmZmVyID8gYmFzZVVuYXJ5KG5vZGVJc0FycmF5QnVmZmVyKSA6IGJhc2VJc0FycmF5QnVmZmVyOwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYXJyYXktbGlrZS4gQSB2YWx1ZSBpcyBjb25zaWRlcmVkIGFycmF5LWxpa2UgaWYgaXQncwogICAgICogbm90IGEgZnVuY3Rpb24gYW5kIGhhcyBhIGB2YWx1ZS5sZW5ndGhgIHRoYXQncyBhbiBpbnRlZ2VyIGdyZWF0ZXIgdGhhbiBvcgogICAgICogZXF1YWwgdG8gYDBgIGFuZCBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gYE51bWJlci5NQVhfU0FGRV9JTlRFR0VSYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhcnJheS1saWtlLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNBcnJheUxpa2UoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzQXJyYXlMaWtlKGRvY3VtZW50LmJvZHkuY2hpbGRyZW4pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNBcnJheUxpa2UoJ2FiYycpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNBcnJheUxpa2UoXy5ub29wKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlMaWtlKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIGlzTGVuZ3RoKHZhbHVlLmxlbmd0aCkgJiYgIWlzRnVuY3Rpb24odmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5pc0FycmF5TGlrZWAgZXhjZXB0IHRoYXQgaXQgYWxzbyBjaGVja3MgaWYgYHZhbHVlYAogICAgICogaXMgYW4gb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGFuIGFycmF5LWxpa2Ugb2JqZWN0LAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0FycmF5TGlrZU9iamVjdChbMSwgMiwgM10pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNBcnJheUxpa2VPYmplY3QoZG9jdW1lbnQuYm9keS5jaGlsZHJlbik7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc0FycmF5TGlrZU9iamVjdCgnYWJjJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNBcnJheUxpa2VPYmplY3QoXy5ub29wKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlMaWtlT2JqZWN0KHZhbHVlKSB7CiAgICAgIHJldHVybiBpc09iamVjdExpa2UodmFsdWUpICYmIGlzQXJyYXlMaWtlKHZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGNsYXNzaWZpZWQgYXMgYSBib29sZWFuIHByaW1pdGl2ZSBvciBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBib29sZWFuLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNCb29sZWFuKGZhbHNlKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzQm9vbGVhbihudWxsKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQm9vbGVhbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRydWUgfHwgdmFsdWUgPT09IGZhbHNlIHx8CiAgICAgICAgKGlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgYmFzZUdldFRhZyh2YWx1ZSkgPT0gYm9vbFRhZyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGJ1ZmZlci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMy4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIGJ1ZmZlciwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzQnVmZmVyKG5ldyBCdWZmZXIoMikpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNCdWZmZXIobmV3IFVpbnQ4QXJyYXkoMikpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgdmFyIGlzQnVmZmVyID0gbmF0aXZlSXNCdWZmZXIgfHwgc3R1YkZhbHNlOwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgY2xhc3NpZmllZCBhcyBhIGBEYXRlYCBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBkYXRlIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRGF0ZShuZXcgRGF0ZSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc0RhdGUoJ01vbiBBcHJpbCAyMyAyMDEyJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICB2YXIgaXNEYXRlID0gbm9kZUlzRGF0ZSA/IGJhc2VVbmFyeShub2RlSXNEYXRlKSA6IGJhc2VJc0RhdGU7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBsaWtlbHkgYSBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNFbGVtZW50KGRvY3VtZW50LmJvZHkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNFbGVtZW50KCc8Ym9keT4nKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRWxlbWVudCh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlKHZhbHVlKSAmJiB2YWx1ZS5ub2RlVHlwZSA9PT0gMSAmJiAhaXNQbGFpbk9iamVjdCh2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhbiBlbXB0eSBvYmplY3QsIGNvbGxlY3Rpb24sIG1hcCwgb3Igc2V0LgogICAgICoKICAgICAqIE9iamVjdHMgYXJlIGNvbnNpZGVyZWQgZW1wdHkgaWYgdGhleSBoYXZlIG5vIG93biBlbnVtZXJhYmxlIHN0cmluZyBrZXllZAogICAgICogcHJvcGVydGllcy4KICAgICAqCiAgICAgKiBBcnJheS1saWtlIHZhbHVlcyBzdWNoIGFzIGBhcmd1bWVudHNgIG9iamVjdHMsIGFycmF5cywgYnVmZmVycywgc3RyaW5ncywgb3IKICAgICAqIGpRdWVyeS1saWtlIGNvbGxlY3Rpb25zIGFyZSBjb25zaWRlcmVkIGVtcHR5IGlmIHRoZXkgaGF2ZSBhIGBsZW5ndGhgIG9mIGAwYC4KICAgICAqIFNpbWlsYXJseSwgbWFwcyBhbmQgc2V0cyBhcmUgY29uc2lkZXJlZCBlbXB0eSBpZiB0aGV5IGhhdmUgYSBgc2l6ZWAgb2YgYDBgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGVtcHR5LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNFbXB0eShudWxsKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzRW1wdHkodHJ1ZSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc0VtcHR5KDEpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNFbXB0eShbMSwgMiwgM10pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzRW1wdHkoeyAnYSc6IDEgfSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzQXJyYXlMaWtlKHZhbHVlKSAmJgogICAgICAgICAgKGlzQXJyYXkodmFsdWUpIHx8IHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsdWUuc3BsaWNlID09ICdmdW5jdGlvbicgfHwKICAgICAgICAgICAgaXNCdWZmZXIodmFsdWUpIHx8IGlzVHlwZWRBcnJheSh2YWx1ZSkgfHwgaXNBcmd1bWVudHModmFsdWUpKSkgewogICAgICAgIHJldHVybiAhdmFsdWUubGVuZ3RoOwogICAgICB9CiAgICAgIHZhciB0YWcgPSBnZXRUYWcodmFsdWUpOwogICAgICBpZiAodGFnID09IG1hcFRhZyB8fCB0YWcgPT0gc2V0VGFnKSB7CiAgICAgICAgcmV0dXJuICF2YWx1ZS5zaXplOwogICAgICB9CiAgICAgIGlmIChpc1Byb3RvdHlwZSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gIWJhc2VLZXlzKHZhbHVlKS5sZW5ndGg7CiAgICAgIH0KICAgICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBiZXR3ZWVuIHR3byB2YWx1ZXMgdG8gZGV0ZXJtaW5lIGlmIHRoZXkgYXJlCiAgICAgKiBlcXVpdmFsZW50LgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBzdXBwb3J0cyBjb21wYXJpbmcgYXJyYXlzLCBhcnJheSBidWZmZXJzLCBib29sZWFucywKICAgICAqIGRhdGUgb2JqZWN0cywgZXJyb3Igb2JqZWN0cywgbWFwcywgbnVtYmVycywgYE9iamVjdGAgb2JqZWN0cywgcmVnZXhlcywKICAgICAqIHNldHMsIHN0cmluZ3MsIHN5bWJvbHMsIGFuZCB0eXBlZCBhcnJheXMuIGBPYmplY3RgIG9iamVjdHMgYXJlIGNvbXBhcmVkCiAgICAgKiBieSB0aGVpciBvd24sIG5vdCBpbmhlcml0ZWQsIGVudW1lcmFibGUgcHJvcGVydGllcy4gRnVuY3Rpb25zIGFuZCBET00KICAgICAqIG5vZGVzIGFyZSBjb21wYXJlZCBieSBzdHJpY3QgZXF1YWxpdHksIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IG90aGVyIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ2EnOiAxIH07CiAgICAgKiB2YXIgb3RoZXIgPSB7ICdhJzogMSB9OwogICAgICoKICAgICAqIF8uaXNFcXVhbChvYmplY3QsIG90aGVyKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBvYmplY3QgPT09IG90aGVyOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNFcXVhbCh2YWx1ZSwgb3RoZXIpIHsKICAgICAgcmV0dXJuIGJhc2VJc0VxdWFsKHZhbHVlLCBvdGhlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmlzRXF1YWxgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGN1c3RvbWl6ZXJgIHdoaWNoCiAgICAgKiBpcyBpbnZva2VkIHRvIGNvbXBhcmUgdmFsdWVzLiBJZiBgY3VzdG9taXplcmAgcmV0dXJucyBgdW5kZWZpbmVkYCwgY29tcGFyaXNvbnMKICAgICAqIGFyZSBoYW5kbGVkIGJ5IHRoZSBtZXRob2QgaW5zdGVhZC4gVGhlIGBjdXN0b21pemVyYCBpcyBpbnZva2VkIHdpdGggdXAgdG8KICAgICAqIHNpeCBhcmd1bWVudHM6IChvYmpWYWx1ZSwgb3RoVmFsdWUgWywgaW5kZXh8a2V5LCBvYmplY3QsIG90aGVyLCBzdGFja10pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBvdGhlciBUaGUgb3RoZXIgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjdXN0b21pemVyXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmlzb25zLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gaXNHcmVldGluZyh2YWx1ZSkgewogICAgICogICByZXR1cm4gL15oKD86aXxlbGxvKSQvLnRlc3QodmFsdWUpOwogICAgICogfQogICAgICoKICAgICAqIGZ1bmN0aW9uIGN1c3RvbWl6ZXIob2JqVmFsdWUsIG90aFZhbHVlKSB7CiAgICAgKiAgIGlmIChpc0dyZWV0aW5nKG9ialZhbHVlKSAmJiBpc0dyZWV0aW5nKG90aFZhbHVlKSkgewogICAgICogICAgIHJldHVybiB0cnVlOwogICAgICogICB9CiAgICAgKiB9CiAgICAgKgogICAgICogdmFyIGFycmF5ID0gWydoZWxsbycsICdnb29kYnllJ107CiAgICAgKiB2YXIgb3RoZXIgPSBbJ2hpJywgJ2dvb2RieWUnXTsKICAgICAqCiAgICAgKiBfLmlzRXF1YWxXaXRoKGFycmF5LCBvdGhlciwgY3VzdG9taXplcik7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRXF1YWxXaXRoKHZhbHVlLCBvdGhlciwgY3VzdG9taXplcikgewogICAgICBjdXN0b21pemVyID0gdHlwZW9mIGN1c3RvbWl6ZXIgPT0gJ2Z1bmN0aW9uJyA/IGN1c3RvbWl6ZXIgOiB1bmRlZmluZWQ7CiAgICAgIHZhciByZXN1bHQgPSBjdXN0b21pemVyID8gY3VzdG9taXplcih2YWx1ZSwgb3RoZXIpIDogdW5kZWZpbmVkOwogICAgICByZXR1cm4gcmVzdWx0ID09PSB1bmRlZmluZWQgPyBiYXNlSXNFcXVhbCh2YWx1ZSwgb3RoZXIsIHVuZGVmaW5lZCwgY3VzdG9taXplcikgOiAhIXJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGBFcnJvcmAsIGBFdmFsRXJyb3JgLCBgUmFuZ2VFcnJvcmAsIGBSZWZlcmVuY2VFcnJvcmAsCiAgICAgKiBgU3ludGF4RXJyb3JgLCBgVHlwZUVycm9yYCwgb3IgYFVSSUVycm9yYCBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYW4gZXJyb3Igb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNFcnJvcihuZXcgRXJyb3IpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNFcnJvcihFcnJvcik7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0Vycm9yKHZhbHVlKSB7CiAgICAgIGlmICghaXNPYmplY3RMaWtlKHZhbHVlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB2YXIgdGFnID0gYmFzZUdldFRhZyh2YWx1ZSk7CiAgICAgIHJldHVybiB0YWcgPT0gZXJyb3JUYWcgfHwgdGFnID09IGRvbUV4Y1RhZyB8fAogICAgICAgICh0eXBlb2YgdmFsdWUubWVzc2FnZSA9PSAnc3RyaW5nJyAmJiB0eXBlb2YgdmFsdWUubmFtZSA9PSAnc3RyaW5nJyAmJiAhaXNQbGFpbk9iamVjdCh2YWx1ZSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBmaW5pdGUgcHJpbWl0aXZlIG51bWJlci4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgaXMgYmFzZWQgb24KICAgICAqIFtgTnVtYmVyLmlzRmluaXRlYF0oaHR0cHM6Ly9tZG4uaW8vTnVtYmVyL2lzRmluaXRlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIGZpbml0ZSBudW1iZXIsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0Zpbml0ZSgzKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzRmluaXRlKE51bWJlci5NSU5fVkFMVUUpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUoSW5maW5pdHkpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzRmluaXRlKCczJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0Zpbml0ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInICYmIG5hdGl2ZUlzRmluaXRlKHZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGNsYXNzaWZpZWQgYXMgYSBgRnVuY3Rpb25gIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIGZ1bmN0aW9uLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNGdW5jdGlvbihfKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzRnVuY3Rpb24oL2FiYy8pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBUaGUgdXNlIG9mIGBPYmplY3QjdG9TdHJpbmdgIGF2b2lkcyBpc3N1ZXMgd2l0aCB0aGUgYHR5cGVvZmAgb3BlcmF0b3IKICAgICAgLy8gaW4gU2FmYXJpIDkgd2hpY2ggcmV0dXJucyAnb2JqZWN0JyBmb3IgdHlwZWQgYXJyYXlzIGFuZCBvdGhlciBjb25zdHJ1Y3RvcnMuCiAgICAgIHZhciB0YWcgPSBiYXNlR2V0VGFnKHZhbHVlKTsKICAgICAgcmV0dXJuIHRhZyA9PSBmdW5jVGFnIHx8IHRhZyA9PSBnZW5UYWcgfHwgdGFnID09IGFzeW5jVGFnIHx8IHRhZyA9PSBwcm94eVRhZzsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGludGVnZXIuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIGlzIGJhc2VkIG9uCiAgICAgKiBbYE51bWJlci5pc0ludGVnZXJgXShodHRwczovL21kbi5pby9OdW1iZXIvaXNJbnRlZ2VyKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhbiBpbnRlZ2VyLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNJbnRlZ2VyKDMpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNJbnRlZ2VyKE51bWJlci5NSU5fVkFMVUUpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzSW50ZWdlcihJbmZpbml0eSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNJbnRlZ2VyKCczJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0ludGVnZXIodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB2YWx1ZSA9PSB0b0ludGVnZXIodmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSB2YWxpZCBhcnJheS1saWtlIGxlbmd0aC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgaXMgbG9vc2VseSBiYXNlZCBvbgogICAgICogW2BUb0xlbmd0aGBdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXRvbGVuZ3RoKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHZhbGlkIGxlbmd0aCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzTGVuZ3RoKDMpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNMZW5ndGgoTnVtYmVyLk1JTl9WQUxVRSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNMZW5ndGgoSW5maW5pdHkpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzTGVuZ3RoKCczJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0xlbmd0aCh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInICYmCiAgICAgICAgdmFsdWUgPiAtMSAmJiB2YWx1ZSAlIDEgPT0gMCAmJiB2YWx1ZSA8PSBNQVhfU0FGRV9JTlRFR0VSOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgdGhlCiAgICAgKiBbbGFuZ3VhZ2UgdHlwZV0oaHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLWVjbWFzY3JpcHQtbGFuZ3VhZ2UtdHlwZXMpCiAgICAgKiBvZiBgT2JqZWN0YC4gKGUuZy4gYXJyYXlzLCBmdW5jdGlvbnMsIG9iamVjdHMsIHJlZ2V4ZXMsIGBuZXcgTnVtYmVyKDApYCwgYW5kIGBuZXcgU3RyaW5nKCcnKWApCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNPYmplY3Qoe30pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNPYmplY3QoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzT2JqZWN0KF8ubm9vcCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc09iamVjdChudWxsKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAgIHZhciB0eXBlID0gdHlwZW9mIHZhbHVlOwogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiAodHlwZSA9PSAnb2JqZWN0JyB8fCB0eXBlID09ICdmdW5jdGlvbicpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgb2JqZWN0LWxpa2UuIEEgdmFsdWUgaXMgb2JqZWN0LWxpa2UgaWYgaXQncyBub3QgYG51bGxgCiAgICAgKiBhbmQgaGFzIGEgYHR5cGVvZmAgcmVzdWx0IG9mICJvYmplY3QiLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIG9iamVjdC1saWtlLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNPYmplY3RMaWtlKHt9KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzT2JqZWN0TGlrZShbMSwgMiwgM10pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNPYmplY3RMaWtlKF8ubm9vcCk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNPYmplY3RMaWtlKG51bGwpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNPYmplY3RMaWtlKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JzsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGNsYXNzaWZpZWQgYXMgYSBgTWFwYCBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjMuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBtYXAsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc01hcChuZXcgTWFwKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTWFwKG5ldyBXZWFrTWFwKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIHZhciBpc01hcCA9IG5vZGVJc01hcCA/IGJhc2VVbmFyeShub2RlSXNNYXApIDogYmFzZUlzTWFwOwoKICAgIC8qKgogICAgICogUGVyZm9ybXMgYSBwYXJ0aWFsIGRlZXAgY29tcGFyaXNvbiBiZXR3ZWVuIGBvYmplY3RgIGFuZCBgc291cmNlYCB0bwogICAgICogZGV0ZXJtaW5lIGlmIGBvYmplY3RgIGNvbnRhaW5zIGVxdWl2YWxlbnQgcHJvcGVydHkgdmFsdWVzLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBpcyBlcXVpdmFsZW50IHRvIGBfLm1hdGNoZXNgIHdoZW4gYHNvdXJjZWAgaXMKICAgICAqIHBhcnRpYWxseSBhcHBsaWVkLgogICAgICoKICAgICAqIFBhcnRpYWwgY29tcGFyaXNvbnMgd2lsbCBtYXRjaCBlbXB0eSBhcnJheSBhbmQgZW1wdHkgb2JqZWN0IGBzb3VyY2VgCiAgICAgKiB2YWx1ZXMgYWdhaW5zdCBhbnkgYXJyYXkgb3Igb2JqZWN0IHZhbHVlLCByZXNwZWN0aXZlbHkuIFNlZSBgXy5pc0VxdWFsYAogICAgICogZm9yIGEgbGlzdCBvZiBzdXBwb3J0ZWQgdmFsdWUgY29tcGFyaXNvbnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IG9mIHByb3BlcnR5IHZhbHVlcyB0byBtYXRjaC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgb2JqZWN0YCBpcyBhIG1hdGNoLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICdhJzogMSwgJ2InOiAyIH07CiAgICAgKgogICAgICogXy5pc01hdGNoKG9iamVjdCwgeyAnYic6IDIgfSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc01hdGNoKG9iamVjdCwgeyAnYic6IDEgfSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc01hdGNoKG9iamVjdCwgc291cmNlKSB7CiAgICAgIHJldHVybiBvYmplY3QgPT09IHNvdXJjZSB8fCBiYXNlSXNNYXRjaChvYmplY3QsIHNvdXJjZSwgZ2V0TWF0Y2hEYXRhKHNvdXJjZSkpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5pc01hdGNoYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBjdXN0b21pemVyYCB3aGljaAogICAgICogaXMgaW52b2tlZCB0byBjb21wYXJlIHZhbHVlcy4gSWYgYGN1c3RvbWl6ZXJgIHJldHVybnMgYHVuZGVmaW5lZGAsIGNvbXBhcmlzb25zCiAgICAgKiBhcmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBgY3VzdG9taXplcmAgaXMgaW52b2tlZCB3aXRoIGZpdmUKICAgICAqIGFyZ3VtZW50czogKG9ialZhbHVlLCBzcmNWYWx1ZSwgaW5kZXh8a2V5LCBvYmplY3QsIHNvdXJjZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IG9mIHByb3BlcnR5IHZhbHVlcyB0byBtYXRjaC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjdXN0b21pemVyXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmlzb25zLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGBvYmplY3RgIGlzIGEgbWF0Y2gsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gaXNHcmVldGluZyh2YWx1ZSkgewogICAgICogICByZXR1cm4gL15oKD86aXxlbGxvKSQvLnRlc3QodmFsdWUpOwogICAgICogfQogICAgICoKICAgICAqIGZ1bmN0aW9uIGN1c3RvbWl6ZXIob2JqVmFsdWUsIHNyY1ZhbHVlKSB7CiAgICAgKiAgIGlmIChpc0dyZWV0aW5nKG9ialZhbHVlKSAmJiBpc0dyZWV0aW5nKHNyY1ZhbHVlKSkgewogICAgICogICAgIHJldHVybiB0cnVlOwogICAgICogICB9CiAgICAgKiB9CiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ2dyZWV0aW5nJzogJ2hlbGxvJyB9OwogICAgICogdmFyIHNvdXJjZSA9IHsgJ2dyZWV0aW5nJzogJ2hpJyB9OwogICAgICoKICAgICAqIF8uaXNNYXRjaFdpdGgob2JqZWN0LCBzb3VyY2UsIGN1c3RvbWl6ZXIpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc01hdGNoV2l0aChvYmplY3QsIHNvdXJjZSwgY3VzdG9taXplcikgewogICAgICBjdXN0b21pemVyID0gdHlwZW9mIGN1c3RvbWl6ZXIgPT0gJ2Z1bmN0aW9uJyA/IGN1c3RvbWl6ZXIgOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBiYXNlSXNNYXRjaChvYmplY3QsIHNvdXJjZSwgZ2V0TWF0Y2hEYXRhKHNvdXJjZSksIGN1c3RvbWl6ZXIpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYE5hTmAuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIGlzIGJhc2VkIG9uCiAgICAgKiBbYE51bWJlci5pc05hTmBdKGh0dHBzOi8vbWRuLmlvL051bWJlci9pc05hTikgYW5kIGlzIG5vdCB0aGUgc2FtZSBhcwogICAgICogZ2xvYmFsIFtgaXNOYU5gXShodHRwczovL21kbi5pby9pc05hTikgd2hpY2ggcmV0dXJucyBgdHJ1ZWAgZm9yCiAgICAgKiBgdW5kZWZpbmVkYCBhbmQgb3RoZXIgbm9uLW51bWJlciB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYE5hTmAsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc05hTihOYU4pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNOYU4obmV3IE51bWJlcihOYU4pKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBpc05hTih1bmRlZmluZWQpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNOYU4odW5kZWZpbmVkKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzTmFOKHZhbHVlKSB7CiAgICAgIC8vIEFuIGBOYU5gIHByaW1pdGl2ZSBpcyB0aGUgb25seSB2YWx1ZSB0aGF0IGlzIG5vdCBlcXVhbCB0byBpdHNlbGYuCiAgICAgIC8vIFBlcmZvcm0gdGhlIGB0b1N0cmluZ1RhZ2AgY2hlY2sgZmlyc3QgdG8gYXZvaWQgZXJyb3JzIHdpdGggc29tZQogICAgICAvLyBBY3RpdmVYIG9iamVjdHMgaW4gSUUuCiAgICAgIHJldHVybiBpc051bWJlcih2YWx1ZSkgJiYgdmFsdWUgIT0gK3ZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBwcmlzdGluZSBuYXRpdmUgZnVuY3Rpb24uCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIGNhbid0IHJlbGlhYmx5IGRldGVjdCBuYXRpdmUgZnVuY3Rpb25zIGluIHRoZSBwcmVzZW5jZQogICAgICogb2YgdGhlIGNvcmUtanMgcGFja2FnZSBiZWNhdXNlIGNvcmUtanMgY2lyY3VtdmVudHMgdGhpcyBraW5kIG9mIGRldGVjdGlvbi4KICAgICAqIERlc3BpdGUgbXVsdGlwbGUgcmVxdWVzdHMsIHRoZSBjb3JlLWpzIG1haW50YWluZXIgaGFzIG1hZGUgaXQgY2xlYXI6IGFueQogICAgICogYXR0ZW1wdCB0byBmaXggdGhlIGRldGVjdGlvbiB3aWxsIGJlIG9ic3RydWN0ZWQuIEFzIGEgcmVzdWx0LCB3ZSdyZSBsZWZ0CiAgICAgKiB3aXRoIGxpdHRsZSBjaG9pY2UgYnV0IHRvIHRocm93IGFuIGVycm9yLiBVbmZvcnR1bmF0ZWx5LCB0aGlzIGFsc28gYWZmZWN0cwogICAgICogcGFja2FnZXMsIGxpa2UgW2JhYmVsLXBvbHlmaWxsXShodHRwczovL3d3dy5ucG1qcy5jb20vcGFja2FnZS9iYWJlbC1wb2x5ZmlsbCksCiAgICAgKiB3aGljaCByZWx5IG9uIGNvcmUtanMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBuYXRpdmUgZnVuY3Rpb24sCiAgICAgKiAgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzTmF0aXZlKEFycmF5LnByb3RvdHlwZS5wdXNoKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTmF0aXZlKF8pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNOYXRpdmUodmFsdWUpIHsKICAgICAgaWYgKGlzTWFza2FibGUodmFsdWUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKENPUkVfRVJST1JfVEVYVCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGJhc2VJc05hdGl2ZSh2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgbnVsbGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYG51bGxgLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNOdWxsKG51bGwpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNOdWxsKHZvaWQgMCk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc051bGwodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYG51bGxgIG9yIGB1bmRlZmluZWRgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIG51bGxpc2gsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc05pbChudWxsKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTmlsKHZvaWQgMCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc05pbChOYU4pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNOaWwodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09IG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBjbGFzc2lmaWVkIGFzIGEgYE51bWJlcmAgcHJpbWl0aXZlIG9yIG9iamVjdC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVG8gZXhjbHVkZSBgSW5maW5pdHlgLCBgLUluZmluaXR5YCwgYW5kIGBOYU5gLCB3aGljaCBhcmUKICAgICAqIGNsYXNzaWZpZWQgYXMgbnVtYmVycywgdXNlIHRoZSBgXy5pc0Zpbml0ZWAgbWV0aG9kLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgbnVtYmVyLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNOdW1iZXIoMyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc051bWJlcihOdW1iZXIuTUlOX1ZBTFVFKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTnVtYmVyKEluZmluaXR5KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTnVtYmVyKCczJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInIHx8CiAgICAgICAgKGlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgYmFzZUdldFRhZyh2YWx1ZSkgPT0gbnVtYmVyVGFnKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgcGxhaW4gb2JqZWN0LCB0aGF0IGlzLCBhbiBvYmplY3QgY3JlYXRlZCBieSB0aGUKICAgICAqIGBPYmplY3RgIGNvbnN0cnVjdG9yIG9yIG9uZSB3aXRoIGEgYFtbUHJvdG90eXBlXV1gIG9mIGBudWxsYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuOC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHBsYWluIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBGb28oKSB7CiAgICAgKiAgIHRoaXMuYSA9IDE7CiAgICAgKiB9CiAgICAgKgogICAgICogXy5pc1BsYWluT2JqZWN0KG5ldyBGb28pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzUGxhaW5PYmplY3QoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc1BsYWluT2JqZWN0KHsgJ3gnOiAwLCAneSc6IDAgfSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc1BsYWluT2JqZWN0KE9iamVjdC5jcmVhdGUobnVsbCkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICAgIGlmICghaXNPYmplY3RMaWtlKHZhbHVlKSB8fCBiYXNlR2V0VGFnKHZhbHVlKSAhPSBvYmplY3RUYWcpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIHByb3RvID0gZ2V0UHJvdG90eXBlKHZhbHVlKTsKICAgICAgaWYgKHByb3RvID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgdmFyIEN0b3IgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3RvLCAnY29uc3RydWN0b3InKSAmJiBwcm90by5jb25zdHJ1Y3RvcjsKICAgICAgcmV0dXJuIHR5cGVvZiBDdG9yID09ICdmdW5jdGlvbicgJiYgQ3RvciBpbnN0YW5jZW9mIEN0b3IgJiYKICAgICAgICBmdW5jVG9TdHJpbmcuY2FsbChDdG9yKSA9PSBvYmplY3RDdG9yU3RyaW5nOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgY2xhc3NpZmllZCBhcyBhIGBSZWdFeHBgIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHJlZ2V4cCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzUmVnRXhwKC9hYmMvKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzUmVnRXhwKCcvYWJjLycpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgdmFyIGlzUmVnRXhwID0gbm9kZUlzUmVnRXhwID8gYmFzZVVuYXJ5KG5vZGVJc1JlZ0V4cCkgOiBiYXNlSXNSZWdFeHA7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIHNhZmUgaW50ZWdlci4gQW4gaW50ZWdlciBpcyBzYWZlIGlmIGl0J3MgYW4gSUVFRS03NTQKICAgICAqIGRvdWJsZSBwcmVjaXNpb24gbnVtYmVyIHdoaWNoIGlzbid0IHRoZSByZXN1bHQgb2YgYSByb3VuZGVkIHVuc2FmZSBpbnRlZ2VyLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBpcyBiYXNlZCBvbgogICAgICogW2BOdW1iZXIuaXNTYWZlSW50ZWdlcmBdKGh0dHBzOi8vbWRuLmlvL051bWJlci9pc1NhZmVJbnRlZ2VyKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHNhZmUgaW50ZWdlciwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzU2FmZUludGVnZXIoMyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc1NhZmVJbnRlZ2VyKE51bWJlci5NSU5fVkFMVUUpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzU2FmZUludGVnZXIoSW5maW5pdHkpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzU2FmZUludGVnZXIoJzMnKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU2FmZUludGVnZXIodmFsdWUpIHsKICAgICAgcmV0dXJuIGlzSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gLU1BWF9TQUZFX0lOVEVHRVIgJiYgdmFsdWUgPD0gTUFYX1NBRkVfSU5URUdFUjsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGNsYXNzaWZpZWQgYXMgYSBgU2V0YCBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjMuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBzZXQsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc1NldChuZXcgU2V0KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzU2V0KG5ldyBXZWFrU2V0KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIHZhciBpc1NldCA9IG5vZGVJc1NldCA/IGJhc2VVbmFyeShub2RlSXNTZXQpIDogYmFzZUlzU2V0OwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgY2xhc3NpZmllZCBhcyBhIGBTdHJpbmdgIHByaW1pdGl2ZSBvciBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBzdHJpbmcsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc1N0cmluZygnYWJjJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc1N0cmluZygxKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZycgfHwKICAgICAgICAoIWlzQXJyYXkodmFsdWUpICYmIGlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgYmFzZUdldFRhZyh2YWx1ZSkgPT0gc3RyaW5nVGFnKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGNsYXNzaWZpZWQgYXMgYSBgU3ltYm9sYCBwcmltaXRpdmUgb3Igb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgc3ltYm9sLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNTeW1ib2woU3ltYm9sLml0ZXJhdG9yKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzU3ltYm9sKCdhYmMnKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3ltYm9sKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N5bWJvbCcgfHwKICAgICAgICAoaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBiYXNlR2V0VGFnKHZhbHVlKSA9PSBzeW1ib2xUYWcpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgY2xhc3NpZmllZCBhcyBhIHR5cGVkIGFycmF5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgdHlwZWQgYXJyYXksIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc1R5cGVkQXJyYXkobmV3IFVpbnQ4QXJyYXkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNUeXBlZEFycmF5KFtdKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIHZhciBpc1R5cGVkQXJyYXkgPSBub2RlSXNUeXBlZEFycmF5ID8gYmFzZVVuYXJ5KG5vZGVJc1R5cGVkQXJyYXkpIDogYmFzZUlzVHlwZWRBcnJheTsKCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGB1bmRlZmluZWRgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGB1bmRlZmluZWRgLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNVbmRlZmluZWQodm9pZCAwKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzVW5kZWZpbmVkKG51bGwpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBjbGFzc2lmaWVkIGFzIGEgYFdlYWtNYXBgIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMy4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHdlYWsgbWFwLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNXZWFrTWFwKG5ldyBXZWFrTWFwKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzV2Vha01hcChuZXcgTWFwKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzV2Vha01hcCh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBnZXRUYWcodmFsdWUpID09IHdlYWtNYXBUYWc7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBjbGFzc2lmaWVkIGFzIGEgYFdlYWtTZXRgIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMy4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHdlYWsgc2V0LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNXZWFrU2V0KG5ldyBXZWFrU2V0KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzV2Vha1NldChuZXcgU2V0KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzV2Vha1NldCh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBiYXNlR2V0VGFnKHZhbHVlKSA9PSB3ZWFrU2V0VGFnOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgbGVzcyB0aGFuIGBvdGhlcmAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjkuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IG90aGVyIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgbGVzcyB0aGFuIGBvdGhlcmAsCiAgICAgKiAgZWxzZSBgZmFsc2VgLgogICAgICogQHNlZSBfLmd0CiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubHQoMSwgMyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5sdCgzLCAzKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5sdCgzLCAxKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIHZhciBsdCA9IGNyZWF0ZVJlbGF0aW9uYWxPcGVyYXRpb24oYmFzZUx0KTsKCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0byBgb3RoZXJgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy45LjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBvdGhlciBUaGUgb3RoZXIgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0bwogICAgICogIGBvdGhlcmAsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBzZWUgXy5ndGUKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5sdGUoMSwgMyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5sdGUoMywgMyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5sdGUoMywgMSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICB2YXIgbHRlID0gY3JlYXRlUmVsYXRpb25hbE9wZXJhdGlvbihmdW5jdGlvbih2YWx1ZSwgb3RoZXIpIHsKICAgICAgcmV0dXJuIHZhbHVlIDw9IG90aGVyOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBgdmFsdWVgIHRvIGFuIGFycmF5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBjb252ZXJ0ZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udG9BcnJheSh7ICdhJzogMSwgJ2InOiAyIH0pOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogXy50b0FycmF5KCdhYmMnKTsKICAgICAqIC8vID0+IFsnYScsICdiJywgJ2MnXQogICAgICoKICAgICAqIF8udG9BcnJheSgxKTsKICAgICAqIC8vID0+IFtdCiAgICAgKgogICAgICogXy50b0FycmF5KG51bGwpOwogICAgICogLy8gPT4gW10KICAgICAqLwogICAgZnVuY3Rpb24gdG9BcnJheSh2YWx1ZSkgewogICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIGlmIChpc0FycmF5TGlrZSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gc3RyaW5nVG9BcnJheSh2YWx1ZSkgOiBjb3B5QXJyYXkodmFsdWUpOwogICAgICB9CiAgICAgIGlmIChzeW1JdGVyYXRvciAmJiB2YWx1ZVtzeW1JdGVyYXRvcl0pIHsKICAgICAgICByZXR1cm4gaXRlcmF0b3JUb0FycmF5KHZhbHVlW3N5bUl0ZXJhdG9yXSgpKTsKICAgICAgfQogICAgICB2YXIgdGFnID0gZ2V0VGFnKHZhbHVlKSwKICAgICAgICAgIGZ1bmMgPSB0YWcgPT0gbWFwVGFnID8gbWFwVG9BcnJheSA6ICh0YWcgPT0gc2V0VGFnID8gc2V0VG9BcnJheSA6IHZhbHVlcyk7CgogICAgICByZXR1cm4gZnVuYyh2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBgdmFsdWVgIHRvIGEgZmluaXRlIG51bWJlci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMTIuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBjb252ZXJ0ZWQgbnVtYmVyLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnRvRmluaXRlKDMuMik7CiAgICAgKiAvLyA9PiAzLjIKICAgICAqCiAgICAgKiBfLnRvRmluaXRlKE51bWJlci5NSU5fVkFMVUUpOwogICAgICogLy8gPT4gNWUtMzI0CiAgICAgKgogICAgICogXy50b0Zpbml0ZShJbmZpbml0eSk7CiAgICAgKiAvLyA9PiAxLjc5NzY5MzEzNDg2MjMxNTdlKzMwOAogICAgICoKICAgICAqIF8udG9GaW5pdGUoJzMuMicpOwogICAgICogLy8gPT4gMy4yCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvRmluaXRlKHZhbHVlKSB7CiAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09IDAgPyB2YWx1ZSA6IDA7CiAgICAgIH0KICAgICAgdmFsdWUgPSB0b051bWJlcih2YWx1ZSk7CiAgICAgIGlmICh2YWx1ZSA9PT0gSU5GSU5JVFkgfHwgdmFsdWUgPT09IC1JTkZJTklUWSkgewogICAgICAgIHZhciBzaWduID0gKHZhbHVlIDwgMCA/IC0xIDogMSk7CiAgICAgICAgcmV0dXJuIHNpZ24gKiBNQVhfSU5URUdFUjsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlID8gdmFsdWUgOiAwOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgYHZhbHVlYCB0byBhbiBpbnRlZ2VyLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBpcyBsb29zZWx5IGJhc2VkIG9uCiAgICAgKiBbYFRvSW50ZWdlcmBdKGh0dHA6Ly93d3cuZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy10b2ludGVnZXIpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgY29udmVydGVkIGludGVnZXIuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udG9JbnRlZ2VyKDMuMik7CiAgICAgKiAvLyA9PiAzCiAgICAgKgogICAgICogXy50b0ludGVnZXIoTnVtYmVyLk1JTl9WQUxVRSk7CiAgICAgKiAvLyA9PiAwCiAgICAgKgogICAgICogXy50b0ludGVnZXIoSW5maW5pdHkpOwogICAgICogLy8gPT4gMS43OTc2OTMxMzQ4NjIzMTU3ZSszMDgKICAgICAqCiAgICAgKiBfLnRvSW50ZWdlcignMy4yJyk7CiAgICAgKiAvLyA9PiAzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvSW50ZWdlcih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdG9GaW5pdGUodmFsdWUpLAogICAgICAgICAgcmVtYWluZGVyID0gcmVzdWx0ICUgMTsKCiAgICAgIHJldHVybiByZXN1bHQgPT09IHJlc3VsdCA/IChyZW1haW5kZXIgPyByZXN1bHQgLSByZW1haW5kZXIgOiByZXN1bHQpIDogMDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIGB2YWx1ZWAgdG8gYW4gaW50ZWdlciBzdWl0YWJsZSBmb3IgdXNlIGFzIHRoZSBsZW5ndGggb2YgYW4KICAgICAqIGFycmF5LWxpa2Ugb2JqZWN0LgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBpcyBiYXNlZCBvbgogICAgICogW2BUb0xlbmd0aGBdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLXRvbGVuZ3RoKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY29udmVydC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGNvbnZlcnRlZCBpbnRlZ2VyLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnRvTGVuZ3RoKDMuMik7CiAgICAgKiAvLyA9PiAzCiAgICAgKgogICAgICogXy50b0xlbmd0aChOdW1iZXIuTUlOX1ZBTFVFKTsKICAgICAqIC8vID0+IDAKICAgICAqCiAgICAgKiBfLnRvTGVuZ3RoKEluZmluaXR5KTsKICAgICAqIC8vID0+IDQyOTQ5NjcyOTUKICAgICAqCiAgICAgKiBfLnRvTGVuZ3RoKCczLjInKTsKICAgICAqIC8vID0+IDMKICAgICAqLwogICAgZnVuY3Rpb24gdG9MZW5ndGgodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gYmFzZUNsYW1wKHRvSW50ZWdlcih2YWx1ZSksIDAsIE1BWF9BUlJBWV9MRU5HVEgpIDogMDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIGB2YWx1ZWAgdG8gYSBudW1iZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IExhbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHByb2Nlc3MuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBudW1iZXIuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udG9OdW1iZXIoMy4yKTsKICAgICAqIC8vID0+IDMuMgogICAgICoKICAgICAqIF8udG9OdW1iZXIoTnVtYmVyLk1JTl9WQUxVRSk7CiAgICAgKiAvLyA9PiA1ZS0zMjQKICAgICAqCiAgICAgKiBfLnRvTnVtYmVyKEluZmluaXR5KTsKICAgICAqIC8vID0+IEluZmluaXR5CiAgICAgKgogICAgICogXy50b051bWJlcignMy4yJyk7CiAgICAgKiAvLyA9PiAzLjIKICAgICAqLwogICAgZnVuY3Rpb24gdG9OdW1iZXIodmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBpZiAoaXNTeW1ib2wodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIE5BTjsKICAgICAgfQogICAgICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgdmFyIG90aGVyID0gdHlwZW9mIHZhbHVlLnZhbHVlT2YgPT0gJ2Z1bmN0aW9uJyA/IHZhbHVlLnZhbHVlT2YoKSA6IHZhbHVlOwogICAgICAgIHZhbHVlID0gaXNPYmplY3Qob3RoZXIpID8gKG90aGVyICsgJycpIDogb3RoZXI7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gMCA/IHZhbHVlIDogK3ZhbHVlOwogICAgICB9CiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZShyZVRyaW0sICcnKTsKICAgICAgdmFyIGlzQmluYXJ5ID0gcmVJc0JpbmFyeS50ZXN0KHZhbHVlKTsKICAgICAgcmV0dXJuIChpc0JpbmFyeSB8fCByZUlzT2N0YWwudGVzdCh2YWx1ZSkpCiAgICAgICAgPyBmcmVlUGFyc2VJbnQodmFsdWUuc2xpY2UoMiksIGlzQmluYXJ5ID8gMiA6IDgpCiAgICAgICAgOiAocmVJc0JhZEhleC50ZXN0KHZhbHVlKSA/IE5BTiA6ICt2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBgdmFsdWVgIHRvIGEgcGxhaW4gb2JqZWN0IGZsYXR0ZW5pbmcgaW5oZXJpdGVkIGVudW1lcmFibGUgc3RyaW5nCiAgICAgKiBrZXllZCBwcm9wZXJ0aWVzIG9mIGB2YWx1ZWAgdG8gb3duIHByb3BlcnRpZXMgb2YgdGhlIHBsYWluIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTGFuZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY29udmVydC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNvbnZlcnRlZCBwbGFpbiBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIEZvbygpIHsKICAgICAqICAgdGhpcy5iID0gMjsKICAgICAqIH0KICAgICAqCiAgICAgKiBGb28ucHJvdG90eXBlLmMgPSAzOwogICAgICoKICAgICAqIF8uYXNzaWduKHsgJ2EnOiAxIH0sIG5ldyBGb28pOwogICAgICogLy8gPT4geyAnYSc6IDEsICdiJzogMiB9CiAgICAgKgogICAgICogXy5hc3NpZ24oeyAnYSc6IDEgfSwgXy50b1BsYWluT2JqZWN0KG5ldyBGb28pKTsKICAgICAqIC8vID0+IHsgJ2EnOiAxLCAnYic6IDIsICdjJzogMyB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvUGxhaW5PYmplY3QodmFsdWUpIHsKICAgICAgcmV0dXJuIGNvcHlPYmplY3QodmFsdWUsIGtleXNJbih2YWx1ZSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgYHZhbHVlYCB0byBhIHNhZmUgaW50ZWdlci4gQSBzYWZlIGludGVnZXIgY2FuIGJlIGNvbXBhcmVkIGFuZAogICAgICogcmVwcmVzZW50ZWQgY29ycmVjdGx5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgY29udmVydGVkIGludGVnZXIuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udG9TYWZlSW50ZWdlcigzLjIpOwogICAgICogLy8gPT4gMwogICAgICoKICAgICAqIF8udG9TYWZlSW50ZWdlcihOdW1iZXIuTUlOX1ZBTFVFKTsKICAgICAqIC8vID0+IDAKICAgICAqCiAgICAgKiBfLnRvU2FmZUludGVnZXIoSW5maW5pdHkpOwogICAgICogLy8gPT4gOTAwNzE5OTI1NDc0MDk5MQogICAgICoKICAgICAqIF8udG9TYWZlSW50ZWdlcignMy4yJyk7CiAgICAgKiAvLyA9PiAzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvU2FmZUludGVnZXIodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgPyBiYXNlQ2xhbXAodG9JbnRlZ2VyKHZhbHVlKSwgLU1BWF9TQUZFX0lOVEVHRVIsIE1BWF9TQUZFX0lOVEVHRVIpCiAgICAgICAgOiAodmFsdWUgPT09IDAgPyB2YWx1ZSA6IDApOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgYHZhbHVlYCB0byBhIHN0cmluZy4gQW4gZW1wdHkgc3RyaW5nIGlzIHJldHVybmVkIGZvciBgbnVsbGAKICAgICAqIGFuZCBgdW5kZWZpbmVkYCB2YWx1ZXMuIFRoZSBzaWduIG9mIGAtMGAgaXMgcHJlc2VydmVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBMYW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgY29udmVydGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy50b1N0cmluZyhudWxsKTsKICAgICAqIC8vID0+ICcnCiAgICAgKgogICAgICogXy50b1N0cmluZygtMCk7CiAgICAgKiAvLyA9PiAnLTAnCiAgICAgKgogICAgICogXy50b1N0cmluZyhbMSwgMiwgM10pOwogICAgICogLy8gPT4gJzEsMiwzJwogICAgICovCiAgICBmdW5jdGlvbiB0b1N0cmluZyh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICcnIDogYmFzZVRvU3RyaW5nKHZhbHVlKTsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBBc3NpZ25zIG93biBlbnVtZXJhYmxlIHN0cmluZyBrZXllZCBwcm9wZXJ0aWVzIG9mIHNvdXJjZSBvYmplY3RzIHRvIHRoZQogICAgICogZGVzdGluYXRpb24gb2JqZWN0LiBTb3VyY2Ugb2JqZWN0cyBhcmUgYXBwbGllZCBmcm9tIGxlZnQgdG8gcmlnaHQuCiAgICAgKiBTdWJzZXF1ZW50IHNvdXJjZXMgb3ZlcndyaXRlIHByb3BlcnR5IGFzc2lnbm1lbnRzIG9mIHByZXZpb3VzIHNvdXJjZXMuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIG11dGF0ZXMgYG9iamVjdGAgYW5kIGlzIGxvb3NlbHkgYmFzZWQgb24KICAgICAqIFtgT2JqZWN0LmFzc2lnbmBdKGh0dHBzOi8vbWRuLmlvL09iamVjdC9hc3NpZ24pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMC4xMC4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gW3NvdXJjZXNdIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAc2VlIF8uYXNzaWduSW4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRm9vKCkgewogICAgICogICB0aGlzLmEgPSAxOwogICAgICogfQogICAgICoKICAgICAqIGZ1bmN0aW9uIEJhcigpIHsKICAgICAqICAgdGhpcy5jID0gMzsKICAgICAqIH0KICAgICAqCiAgICAgKiBGb28ucHJvdG90eXBlLmIgPSAyOwogICAgICogQmFyLnByb3RvdHlwZS5kID0gNDsKICAgICAqCiAgICAgKiBfLmFzc2lnbih7ICdhJzogMCB9LCBuZXcgRm9vLCBuZXcgQmFyKTsKICAgICAqIC8vID0+IHsgJ2EnOiAxLCAnYyc6IDMgfQogICAgICovCiAgICB2YXIgYXNzaWduID0gY3JlYXRlQXNzaWduZXIoZnVuY3Rpb24ob2JqZWN0LCBzb3VyY2UpIHsKICAgICAgaWYgKGlzUHJvdG90eXBlKHNvdXJjZSkgfHwgaXNBcnJheUxpa2Uoc291cmNlKSkgewogICAgICAgIGNvcHlPYmplY3Qoc291cmNlLCBrZXlzKHNvdXJjZSksIG9iamVjdCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkpIHsKICAgICAgICAgIGFzc2lnblZhbHVlKG9iamVjdCwga2V5LCBzb3VyY2Vba2V5XSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uYXNzaWduYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIG93biBhbmQKICAgICAqIGluaGVyaXRlZCBzb3VyY2UgcHJvcGVydGllcy4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAYWxpYXMgZXh0ZW5kCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gW3NvdXJjZXNdIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAc2VlIF8uYXNzaWduCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIEZvbygpIHsKICAgICAqICAgdGhpcy5hID0gMTsKICAgICAqIH0KICAgICAqCiAgICAgKiBmdW5jdGlvbiBCYXIoKSB7CiAgICAgKiAgIHRoaXMuYyA9IDM7CiAgICAgKiB9CiAgICAgKgogICAgICogRm9vLnByb3RvdHlwZS5iID0gMjsKICAgICAqIEJhci5wcm90b3R5cGUuZCA9IDQ7CiAgICAgKgogICAgICogXy5hc3NpZ25Jbih7ICdhJzogMCB9LCBuZXcgRm9vLCBuZXcgQmFyKTsKICAgICAqIC8vID0+IHsgJ2EnOiAxLCAnYic6IDIsICdjJzogMywgJ2QnOiA0IH0KICAgICAqLwogICAgdmFyIGFzc2lnbkluID0gY3JlYXRlQXNzaWduZXIoZnVuY3Rpb24ob2JqZWN0LCBzb3VyY2UpIHsKICAgICAgY29weU9iamVjdChzb3VyY2UsIGtleXNJbihzb3VyY2UpLCBvYmplY3QpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmFzc2lnbkluYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBjdXN0b21pemVyYAogICAgICogd2hpY2ggaXMgaW52b2tlZCB0byBwcm9kdWNlIHRoZSBhc3NpZ25lZCB2YWx1ZXMuIElmIGBjdXN0b21pemVyYCByZXR1cm5zCiAgICAgKiBgdW5kZWZpbmVkYCwgYXNzaWdubWVudCBpcyBoYW5kbGVkIGJ5IHRoZSBtZXRob2QgaW5zdGVhZC4gVGhlIGBjdXN0b21pemVyYAogICAgICogaXMgaW52b2tlZCB3aXRoIGZpdmUgYXJndW1lbnRzOiAob2JqVmFsdWUsIHNyY1ZhbHVlLCBrZXksIG9iamVjdCwgc291cmNlKS4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAYWxpYXMgZXh0ZW5kV2l0aAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IHNvdXJjZXMgVGhlIHNvdXJjZSBvYmplY3RzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2N1c3RvbWl6ZXJdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgYXNzaWduZWQgdmFsdWVzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBzZWUgXy5hc3NpZ25XaXRoCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIGN1c3RvbWl6ZXIob2JqVmFsdWUsIHNyY1ZhbHVlKSB7CiAgICAgKiAgIHJldHVybiBfLmlzVW5kZWZpbmVkKG9ialZhbHVlKSA/IHNyY1ZhbHVlIDogb2JqVmFsdWU7CiAgICAgKiB9CiAgICAgKgogICAgICogdmFyIGRlZmF1bHRzID0gXy5wYXJ0aWFsUmlnaHQoXy5hc3NpZ25JbldpdGgsIGN1c3RvbWl6ZXIpOwogICAgICoKICAgICAqIGRlZmF1bHRzKHsgJ2EnOiAxIH0sIHsgJ2InOiAyIH0sIHsgJ2EnOiAzIH0pOwogICAgICogLy8gPT4geyAnYSc6IDEsICdiJzogMiB9CiAgICAgKi8KICAgIHZhciBhc3NpZ25JbldpdGggPSBjcmVhdGVBc3NpZ25lcihmdW5jdGlvbihvYmplY3QsIHNvdXJjZSwgc3JjSW5kZXgsIGN1c3RvbWl6ZXIpIHsKICAgICAgY29weU9iamVjdChzb3VyY2UsIGtleXNJbihzb3VyY2UpLCBvYmplY3QsIGN1c3RvbWl6ZXIpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmFzc2lnbmAgZXhjZXB0IHRoYXQgaXQgYWNjZXB0cyBgY3VzdG9taXplcmAKICAgICAqIHdoaWNoIGlzIGludm9rZWQgdG8gcHJvZHVjZSB0aGUgYXNzaWduZWQgdmFsdWVzLiBJZiBgY3VzdG9taXplcmAgcmV0dXJucwogICAgICogYHVuZGVmaW5lZGAsIGFzc2lnbm1lbnQgaXMgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBgY3VzdG9taXplcmAKICAgICAqIGlzIGludm9rZWQgd2l0aCBmaXZlIGFyZ3VtZW50czogKG9ialZhbHVlLCBzcmNWYWx1ZSwga2V5LCBvYmplY3QsIHNvdXJjZSkuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIG11dGF0ZXMgYG9iamVjdGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IHNvdXJjZXMgVGhlIHNvdXJjZSBvYmplY3RzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2N1c3RvbWl6ZXJdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgYXNzaWduZWQgdmFsdWVzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBzZWUgXy5hc3NpZ25JbldpdGgKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gY3VzdG9taXplcihvYmpWYWx1ZSwgc3JjVmFsdWUpIHsKICAgICAqICAgcmV0dXJuIF8uaXNVbmRlZmluZWQob2JqVmFsdWUpID8gc3JjVmFsdWUgOiBvYmpWYWx1ZTsKICAgICAqIH0KICAgICAqCiAgICAgKiB2YXIgZGVmYXVsdHMgPSBfLnBhcnRpYWxSaWdodChfLmFzc2lnbldpdGgsIGN1c3RvbWl6ZXIpOwogICAgICoKICAgICAqIGRlZmF1bHRzKHsgJ2EnOiAxIH0sIHsgJ2InOiAyIH0sIHsgJ2EnOiAzIH0pOwogICAgICogLy8gPT4geyAnYSc6IDEsICdiJzogMiB9CiAgICAgKi8KICAgIHZhciBhc3NpZ25XaXRoID0gY3JlYXRlQXNzaWduZXIoZnVuY3Rpb24ob2JqZWN0LCBzb3VyY2UsIHNyY0luZGV4LCBjdXN0b21pemVyKSB7CiAgICAgIGNvcHlPYmplY3Qoc291cmNlLCBrZXlzKHNvdXJjZSksIG9iamVjdCwgY3VzdG9taXplcik7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdmFsdWVzIGNvcnJlc3BvbmRpbmcgdG8gYHBhdGhzYCBvZiBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDEuMC4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHsuLi4oc3RyaW5nfHN0cmluZ1tdKX0gW3BhdGhzXSBUaGUgcHJvcGVydHkgcGF0aHMgdG8gcGljay4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgcGlja2VkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ2EnOiBbeyAnYic6IHsgJ2MnOiAzIH0gfSwgNF0gfTsKICAgICAqCiAgICAgKiBfLmF0KG9iamVjdCwgWydhWzBdLmIuYycsICdhWzFdJ10pOwogICAgICogLy8gPT4gWzMsIDRdCiAgICAgKi8KICAgIHZhciBhdCA9IGZsYXRSZXN0KGJhc2VBdCk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCB0aGF0IGluaGVyaXRzIGZyb20gdGhlIGBwcm90b3R5cGVgIG9iamVjdC4gSWYgYQogICAgICogYHByb3BlcnRpZXNgIG9iamVjdCBpcyBnaXZlbiwgaXRzIG93biBlbnVtZXJhYmxlIHN0cmluZyBrZXllZCBwcm9wZXJ0aWVzCiAgICAgKiBhcmUgYXNzaWduZWQgdG8gdGhlIGNyZWF0ZWQgb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMi4zLjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcm90b3R5cGUgVGhlIG9iamVjdCB0byBpbmhlcml0IGZyb20uCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW3Byb3BlcnRpZXNdIFRoZSBwcm9wZXJ0aWVzIHRvIGFzc2lnbiB0byB0aGUgb2JqZWN0LgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gU2hhcGUoKSB7CiAgICAgKiAgIHRoaXMueCA9IDA7CiAgICAgKiAgIHRoaXMueSA9IDA7CiAgICAgKiB9CiAgICAgKgogICAgICogZnVuY3Rpb24gQ2lyY2xlKCkgewogICAgICogICBTaGFwZS5jYWxsKHRoaXMpOwogICAgICogfQogICAgICoKICAgICAqIENpcmNsZS5wcm90b3R5cGUgPSBfLmNyZWF0ZShTaGFwZS5wcm90b3R5cGUsIHsKICAgICAqICAgJ2NvbnN0cnVjdG9yJzogQ2lyY2xlCiAgICAgKiB9KTsKICAgICAqCiAgICAgKiB2YXIgY2lyY2xlID0gbmV3IENpcmNsZTsKICAgICAqIGNpcmNsZSBpbnN0YW5jZW9mIENpcmNsZTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBjaXJjbGUgaW5zdGFuY2VvZiBTaGFwZTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlKHByb3RvdHlwZSwgcHJvcGVydGllcykgewogICAgICB2YXIgcmVzdWx0ID0gYmFzZUNyZWF0ZShwcm90b3R5cGUpOwogICAgICByZXR1cm4gcHJvcGVydGllcyA9PSBudWxsID8gcmVzdWx0IDogYmFzZUFzc2lnbihyZXN1bHQsIHByb3BlcnRpZXMpOwogICAgfQoKICAgIC8qKgogICAgICogQXNzaWducyBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHN0cmluZyBrZXllZCBwcm9wZXJ0aWVzIG9mIHNvdXJjZQogICAgICogb2JqZWN0cyB0byB0aGUgZGVzdGluYXRpb24gb2JqZWN0IGZvciBhbGwgZGVzdGluYXRpb24gcHJvcGVydGllcyB0aGF0CiAgICAgKiByZXNvbHZlIHRvIGB1bmRlZmluZWRgLiBTb3VyY2Ugb2JqZWN0cyBhcmUgYXBwbGllZCBmcm9tIGxlZnQgdG8gcmlnaHQuCiAgICAgKiBPbmNlIGEgcHJvcGVydHkgaXMgc2V0LCBhZGRpdGlvbmFsIHZhbHVlcyBvZiB0aGUgc2FtZSBwcm9wZXJ0eSBhcmUgaWdub3JlZC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gW3NvdXJjZXNdIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAc2VlIF8uZGVmYXVsdHNEZWVwCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZGVmYXVsdHMoeyAnYSc6IDEgfSwgeyAnYic6IDIgfSwgeyAnYSc6IDMgfSk7CiAgICAgKiAvLyA9PiB7ICdhJzogMSwgJ2InOiAyIH0KICAgICAqLwogICAgdmFyIGRlZmF1bHRzID0gYmFzZVJlc3QoZnVuY3Rpb24ob2JqZWN0LCBzb3VyY2VzKSB7CiAgICAgIG9iamVjdCA9IE9iamVjdChvYmplY3QpOwoKICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgIHZhciBsZW5ndGggPSBzb3VyY2VzLmxlbmd0aDsKICAgICAgdmFyIGd1YXJkID0gbGVuZ3RoID4gMiA/IHNvdXJjZXNbMl0gOiB1bmRlZmluZWQ7CgogICAgICBpZiAoZ3VhcmQgJiYgaXNJdGVyYXRlZUNhbGwoc291cmNlc1swXSwgc291cmNlc1sxXSwgZ3VhcmQpKSB7CiAgICAgICAgbGVuZ3RoID0gMTsKICAgICAgfQoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgc291cmNlID0gc291cmNlc1tpbmRleF07CiAgICAgICAgdmFyIHByb3BzID0ga2V5c0luKHNvdXJjZSk7CiAgICAgICAgdmFyIHByb3BzSW5kZXggPSAtMTsKICAgICAgICB2YXIgcHJvcHNMZW5ndGggPSBwcm9wcy5sZW5ndGg7CgogICAgICAgIHdoaWxlICgrK3Byb3BzSW5kZXggPCBwcm9wc0xlbmd0aCkgewogICAgICAgICAgdmFyIGtleSA9IHByb3BzW3Byb3BzSW5kZXhdOwogICAgICAgICAgdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgogICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwKICAgICAgICAgICAgICAoZXEodmFsdWUsIG9iamVjdFByb3RvW2tleV0pICYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkpIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9KTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZGVmYXVsdHNgIGV4Y2VwdCB0aGF0IGl0IHJlY3Vyc2l2ZWx5IGFzc2lnbnMKICAgICAqIGRlZmF1bHQgcHJvcGVydGllcy4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMTAuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IFtzb3VyY2VzXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICogQHNlZSBfLmRlZmF1bHRzCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZGVmYXVsdHNEZWVwKHsgJ2EnOiB7ICdiJzogMiB9IH0sIHsgJ2EnOiB7ICdiJzogMSwgJ2MnOiAzIH0gfSk7CiAgICAgKiAvLyA9PiB7ICdhJzogeyAnYic6IDIsICdjJzogMyB9IH0KICAgICAqLwogICAgdmFyIGRlZmF1bHRzRGVlcCA9IGJhc2VSZXN0KGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgYXJncy5wdXNoKHVuZGVmaW5lZCwgY3VzdG9tRGVmYXVsdHNNZXJnZSk7CiAgICAgIHJldHVybiBhcHBseShtZXJnZVdpdGgsIHVuZGVmaW5lZCwgYXJncyk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZmluZGAgZXhjZXB0IHRoYXQgaXQgcmV0dXJucyB0aGUga2V5IG9mIHRoZSBmaXJzdAogICAgICogZWxlbWVudCBgcHJlZGljYXRlYCByZXR1cm5zIHRydXRoeSBmb3IgaW5zdGVhZCBvZiB0aGUgZWxlbWVudCBpdHNlbGYuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAxLjEuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gUmV0dXJucyB0aGUga2V5IG9mIHRoZSBtYXRjaGVkIGVsZW1lbnQsCiAgICAgKiAgZWxzZSBgdW5kZWZpbmVkYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gewogICAgICogICAnYmFybmV5JzogIHsgJ2FnZSc6IDM2LCAnYWN0aXZlJzogdHJ1ZSB9LAogICAgICogICAnZnJlZCc6ICAgIHsgJ2FnZSc6IDQwLCAnYWN0aXZlJzogZmFsc2UgfSwKICAgICAqICAgJ3BlYmJsZXMnOiB7ICdhZ2UnOiAxLCAgJ2FjdGl2ZSc6IHRydWUgfQogICAgICogfTsKICAgICAqCiAgICAgKiBfLmZpbmRLZXkodXNlcnMsIGZ1bmN0aW9uKG8pIHsgcmV0dXJuIG8uYWdlIDwgNDA7IH0pOwogICAgICogLy8gPT4gJ2Jhcm5leScgKGl0ZXJhdGlvbiBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc2AgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5maW5kS2V5KHVzZXJzLCB7ICdhZ2UnOiAxLCAnYWN0aXZlJzogdHJ1ZSB9KTsKICAgICAqIC8vID0+ICdwZWJibGVzJwogICAgICoKICAgICAqIC8vIFRoZSBgXy5tYXRjaGVzUHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8uZmluZEtleSh1c2VycywgWydhY3RpdmUnLCBmYWxzZV0pOwogICAgICogLy8gPT4gJ2ZyZWQnCiAgICAgKgogICAgICogLy8gVGhlIGBfLnByb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbmRLZXkodXNlcnMsICdhY3RpdmUnKTsKICAgICAqIC8vID0+ICdiYXJuZXknCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmRLZXkob2JqZWN0LCBwcmVkaWNhdGUpIHsKICAgICAgcmV0dXJuIGJhc2VGaW5kS2V5KG9iamVjdCwgZ2V0SXRlcmF0ZWUocHJlZGljYXRlLCAzKSwgYmFzZUZvck93bik7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRLZXlgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMgb2YKICAgICAqIGEgY29sbGVjdGlvbiBpbiB0aGUgb3Bwb3NpdGUgb3JkZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAyLjAuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gUmV0dXJucyB0aGUga2V5IG9mIHRoZSBtYXRjaGVkIGVsZW1lbnQsCiAgICAgKiAgZWxzZSBgdW5kZWZpbmVkYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gewogICAgICogICAnYmFybmV5JzogIHsgJ2FnZSc6IDM2LCAnYWN0aXZlJzogdHJ1ZSB9LAogICAgICogICAnZnJlZCc6ICAgIHsgJ2FnZSc6IDQwLCAnYWN0aXZlJzogZmFsc2UgfSwKICAgICAqICAgJ3BlYmJsZXMnOiB7ICdhZ2UnOiAxLCAgJ2FjdGl2ZSc6IHRydWUgfQogICAgICogfTsKICAgICAqCiAgICAgKiBfLmZpbmRMYXN0S2V5KHVzZXJzLCBmdW5jdGlvbihvKSB7IHJldHVybiBvLmFnZSA8IDQwOyB9KTsKICAgICAqIC8vID0+IHJldHVybnMgJ3BlYmJsZXMnIGFzc3VtaW5nIGBfLmZpbmRLZXlgIHJldHVybnMgJ2Jhcm5leScKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc2AgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5maW5kTGFzdEtleSh1c2VycywgeyAnYWdlJzogMzYsICdhY3RpdmUnOiB0cnVlIH0pOwogICAgICogLy8gPT4gJ2Jhcm5leScKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc1Byb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbmRMYXN0S2V5KHVzZXJzLCBbJ2FjdGl2ZScsIGZhbHNlXSk7CiAgICAgKiAvLyA9PiAnZnJlZCcKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8uZmluZExhc3RLZXkodXNlcnMsICdhY3RpdmUnKTsKICAgICAqIC8vID0+ICdwZWJibGVzJwogICAgICovCiAgICBmdW5jdGlvbiBmaW5kTGFzdEtleShvYmplY3QsIHByZWRpY2F0ZSkgewogICAgICByZXR1cm4gYmFzZUZpbmRLZXkob2JqZWN0LCBnZXRJdGVyYXRlZShwcmVkaWNhdGUsIDMpLCBiYXNlRm9yT3duUmlnaHQpOwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHN0cmluZyBrZXllZCBwcm9wZXJ0aWVzIG9mIGFuCiAgICAgKiBvYmplY3QgYW5kIGludm9rZXMgYGl0ZXJhdGVlYCBmb3IgZWFjaCBwcm9wZXJ0eS4gVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQKICAgICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOiAodmFsdWUsIGtleSwgb2JqZWN0KS4gSXRlcmF0ZWUgZnVuY3Rpb25zIG1heSBleGl0CiAgICAgKiBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuMy4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICogQHNlZSBfLmZvckluUmlnaHQKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRm9vKCkgewogICAgICogICB0aGlzLmEgPSAxOwogICAgICogICB0aGlzLmIgPSAyOwogICAgICogfQogICAgICoKICAgICAqIEZvby5wcm90b3R5cGUuYyA9IDM7CiAgICAgKgogICAgICogXy5mb3JJbihuZXcgRm9vLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGtleSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IExvZ3MgJ2EnLCAnYicsIHRoZW4gJ2MnIChpdGVyYXRpb24gb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpLgogICAgICovCiAgICBmdW5jdGlvbiBmb3JJbihvYmplY3QsIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiBvYmplY3QgPT0gbnVsbAogICAgICAgID8gb2JqZWN0CiAgICAgICAgOiBiYXNlRm9yKG9iamVjdCwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDMpLCBrZXlzSW4pOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5mb3JJbmAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBwcm9wZXJ0aWVzIG9mCiAgICAgKiBgb2JqZWN0YCBpbiB0aGUgb3Bwb3NpdGUgb3JkZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAyLjAuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBzZWUgXy5mb3JJbgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBGb28oKSB7CiAgICAgKiAgIHRoaXMuYSA9IDE7CiAgICAgKiAgIHRoaXMuYiA9IDI7CiAgICAgKiB9CiAgICAgKgogICAgICogRm9vLnByb3RvdHlwZS5jID0gMzsKICAgICAqCiAgICAgKiBfLmZvckluUmlnaHQobmV3IEZvbywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICogICBjb25zb2xlLmxvZyhrZXkpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBMb2dzICdjJywgJ2InLCB0aGVuICdhJyBhc3N1bWluZyBgXy5mb3JJbmAgbG9ncyAnYScsICdiJywgdGhlbiAnYycuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckluUmlnaHQob2JqZWN0LCBpdGVyYXRlZSkgewogICAgICByZXR1cm4gb2JqZWN0ID09IG51bGwKICAgICAgICA/IG9iamVjdAogICAgICAgIDogYmFzZUZvclJpZ2h0KG9iamVjdCwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDMpLCBrZXlzSW4pOwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBvd24gZW51bWVyYWJsZSBzdHJpbmcga2V5ZWQgcHJvcGVydGllcyBvZiBhbiBvYmplY3QgYW5kCiAgICAgKiBpbnZva2VzIGBpdGVyYXRlZWAgZm9yIGVhY2ggcHJvcGVydHkuIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggdGhyZWUKICAgICAqIGFyZ3VtZW50czogKHZhbHVlLCBrZXksIG9iamVjdCkuIEl0ZXJhdGVlIGZ1bmN0aW9ucyBtYXkgZXhpdCBpdGVyYXRpb24KICAgICAqIGVhcmx5IGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjMuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBzZWUgXy5mb3JPd25SaWdodAogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBGb28oKSB7CiAgICAgKiAgIHRoaXMuYSA9IDE7CiAgICAgKiAgIHRoaXMuYiA9IDI7CiAgICAgKiB9CiAgICAgKgogICAgICogRm9vLnByb3RvdHlwZS5jID0gMzsKICAgICAqCiAgICAgKiBfLmZvck93bihuZXcgRm9vLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGtleSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IExvZ3MgJ2EnIHRoZW4gJ2InIChpdGVyYXRpb24gb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpLgogICAgICovCiAgICBmdW5jdGlvbiBmb3JPd24ob2JqZWN0LCBpdGVyYXRlZSkgewogICAgICByZXR1cm4gb2JqZWN0ICYmIGJhc2VGb3JPd24ob2JqZWN0LCBnZXRJdGVyYXRlZShpdGVyYXRlZSwgMykpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5mb3JPd25gIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgcHJvcGVydGllcyBvZgogICAgICogYG9iamVjdGAgaW4gdGhlIG9wcG9zaXRlIG9yZGVyLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMi4wLjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAc2VlIF8uZm9yT3duCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIEZvbygpIHsKICAgICAqICAgdGhpcy5hID0gMTsKICAgICAqICAgdGhpcy5iID0gMjsKICAgICAqIH0KICAgICAqCiAgICAgKiBGb28ucHJvdG90eXBlLmMgPSAzOwogICAgICoKICAgICAqIF8uZm9yT3duUmlnaHQobmV3IEZvbywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICogICBjb25zb2xlLmxvZyhrZXkpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBMb2dzICdiJyB0aGVuICdhJyBhc3N1bWluZyBgXy5mb3JPd25gIGxvZ3MgJ2EnIHRoZW4gJ2InLgogICAgICovCiAgICBmdW5jdGlvbiBmb3JPd25SaWdodChvYmplY3QsIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiBvYmplY3QgJiYgYmFzZUZvck93blJpZ2h0KG9iamVjdCwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDMpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZnVuY3Rpb24gcHJvcGVydHkgbmFtZXMgZnJvbSBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzCiAgICAgKiBvZiBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgZnVuY3Rpb24gbmFtZXMuCiAgICAgKiBAc2VlIF8uZnVuY3Rpb25zSW4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRm9vKCkgewogICAgICogICB0aGlzLmEgPSBfLmNvbnN0YW50KCdhJyk7CiAgICAgKiAgIHRoaXMuYiA9IF8uY29uc3RhbnQoJ2InKTsKICAgICAqIH0KICAgICAqCiAgICAgKiBGb28ucHJvdG90eXBlLmMgPSBfLmNvbnN0YW50KCdjJyk7CiAgICAgKgogICAgICogXy5mdW5jdGlvbnMobmV3IEZvbyk7CiAgICAgKiAvLyA9PiBbJ2EnLCAnYiddCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZ1bmN0aW9ucyhvYmplY3QpIHsKICAgICAgcmV0dXJuIG9iamVjdCA9PSBudWxsID8gW10gOiBiYXNlRnVuY3Rpb25zKG9iamVjdCwga2V5cyhvYmplY3QpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZnVuY3Rpb24gcHJvcGVydHkgbmFtZXMgZnJvbSBvd24gYW5kIGluaGVyaXRlZAogICAgICogZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGBvYmplY3RgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBmdW5jdGlvbiBuYW1lcy4KICAgICAqIEBzZWUgXy5mdW5jdGlvbnMKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRm9vKCkgewogICAgICogICB0aGlzLmEgPSBfLmNvbnN0YW50KCdhJyk7CiAgICAgKiAgIHRoaXMuYiA9IF8uY29uc3RhbnQoJ2InKTsKICAgICAqIH0KICAgICAqCiAgICAgKiBGb28ucHJvdG90eXBlLmMgPSBfLmNvbnN0YW50KCdjJyk7CiAgICAgKgogICAgICogXy5mdW5jdGlvbnNJbihuZXcgRm9vKTsKICAgICAqIC8vID0+IFsnYScsICdiJywgJ2MnXQogICAgICovCiAgICBmdW5jdGlvbiBmdW5jdGlvbnNJbihvYmplY3QpIHsKICAgICAgcmV0dXJuIG9iamVjdCA9PSBudWxsID8gW10gOiBiYXNlRnVuY3Rpb25zKG9iamVjdCwga2V5c0luKG9iamVjdCkpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgdmFsdWUgYXQgYHBhdGhgIG9mIGBvYmplY3RgLiBJZiB0aGUgcmVzb2x2ZWQgdmFsdWUgaXMKICAgICAqIGB1bmRlZmluZWRgLCB0aGUgYGRlZmF1bHRWYWx1ZWAgaXMgcmV0dXJuZWQgaW4gaXRzIHBsYWNlLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy43LjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBwYXRoIFRoZSBwYXRoIG9mIHRoZSBwcm9wZXJ0eSB0byBnZXQuCiAgICAgKiBAcGFyYW0geyp9IFtkZWZhdWx0VmFsdWVdIFRoZSB2YWx1ZSByZXR1cm5lZCBmb3IgYHVuZGVmaW5lZGAgcmVzb2x2ZWQgdmFsdWVzLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnYSc6IFt7ICdiJzogeyAnYyc6IDMgfSB9XSB9OwogICAgICoKICAgICAqIF8uZ2V0KG9iamVjdCwgJ2FbMF0uYi5jJyk7CiAgICAgKiAvLyA9PiAzCiAgICAgKgogICAgICogXy5nZXQob2JqZWN0LCBbJ2EnLCAnMCcsICdiJywgJ2MnXSk7CiAgICAgKiAvLyA9PiAzCiAgICAgKgogICAgICogXy5nZXQob2JqZWN0LCAnYS5iLmMnLCAnZGVmYXVsdCcpOwogICAgICogLy8gPT4gJ2RlZmF1bHQnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldChvYmplY3QsIHBhdGgsIGRlZmF1bHRWYWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gb2JqZWN0ID09IG51bGwgPyB1bmRlZmluZWQgOiBiYXNlR2V0KG9iamVjdCwgcGF0aCk7CiAgICAgIHJldHVybiByZXN1bHQgPT09IHVuZGVmaW5lZCA/IGRlZmF1bHRWYWx1ZSA6IHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgcGF0aGAgaXMgYSBkaXJlY3QgcHJvcGVydHkgb2YgYG9iamVjdGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHBhdGggVGhlIHBhdGggdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHBhdGhgIGV4aXN0cywgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnYSc6IHsgJ2InOiAyIH0gfTsKICAgICAqIHZhciBvdGhlciA9IF8uY3JlYXRlKHsgJ2EnOiBfLmNyZWF0ZSh7ICdiJzogMiB9KSB9KTsKICAgICAqCiAgICAgKiBfLmhhcyhvYmplY3QsICdhJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5oYXMob2JqZWN0LCAnYS5iJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5oYXMob2JqZWN0LCBbJ2EnLCAnYiddKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmhhcyhvdGhlciwgJ2EnKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhhcyhvYmplY3QsIHBhdGgpIHsKICAgICAgcmV0dXJuIG9iamVjdCAhPSBudWxsICYmIGhhc1BhdGgob2JqZWN0LCBwYXRoLCBiYXNlSGFzKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgcGF0aGAgaXMgYSBkaXJlY3Qgb3IgaW5oZXJpdGVkIHByb3BlcnR5IG9mIGBvYmplY3RgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBwYXRoIFRoZSBwYXRoIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGBwYXRoYCBleGlzdHMsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IF8uY3JlYXRlKHsgJ2EnOiBfLmNyZWF0ZSh7ICdiJzogMiB9KSB9KTsKICAgICAqCiAgICAgKiBfLmhhc0luKG9iamVjdCwgJ2EnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmhhc0luKG9iamVjdCwgJ2EuYicpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaGFzSW4ob2JqZWN0LCBbJ2EnLCAnYiddKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmhhc0luKG9iamVjdCwgJ2InKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhhc0luKG9iamVjdCwgcGF0aCkgewogICAgICByZXR1cm4gb2JqZWN0ICE9IG51bGwgJiYgaGFzUGF0aChvYmplY3QsIHBhdGgsIGJhc2VIYXNJbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgaW52ZXJ0ZWQga2V5cyBhbmQgdmFsdWVzIG9mIGBvYmplY3RgLgogICAgICogSWYgYG9iamVjdGAgY29udGFpbnMgZHVwbGljYXRlIHZhbHVlcywgc3Vic2VxdWVudCB2YWx1ZXMgb3ZlcndyaXRlCiAgICAgKiBwcm9wZXJ0eSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cyB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjcuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGludmVydC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBpbnZlcnRlZCBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDEgfTsKICAgICAqCiAgICAgKiBfLmludmVydChvYmplY3QpOwogICAgICogLy8gPT4geyAnMSc6ICdjJywgJzInOiAnYicgfQogICAgICovCiAgICB2YXIgaW52ZXJ0ID0gY3JlYXRlSW52ZXJ0ZXIoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmCiAgICAgICAgICB0eXBlb2YgdmFsdWUudG9TdHJpbmcgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhbHVlID0gbmF0aXZlT2JqZWN0VG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICAgIH0KCiAgICAgIHJlc3VsdFt2YWx1ZV0gPSBrZXk7CiAgICB9LCBjb25zdGFudChpZGVudGl0eSkpOwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5pbnZlcnRgIGV4Y2VwdCB0aGF0IHRoZSBpbnZlcnRlZCBvYmplY3QgaXMgZ2VuZXJhdGVkCiAgICAgKiBmcm9tIHRoZSByZXN1bHRzIG9mIHJ1bm5pbmcgZWFjaCBlbGVtZW50IG9mIGBvYmplY3RgIHRocnUgYGl0ZXJhdGVlYC4gVGhlCiAgICAgKiBjb3JyZXNwb25kaW5nIGludmVydGVkIHZhbHVlIG9mIGVhY2ggaW52ZXJ0ZWQga2V5IGlzIGFuIGFycmF5IG9mIGtleXMKICAgICAqIHJlc3BvbnNpYmxlIGZvciBnZW5lcmF0aW5nIHRoZSBpbnZlcnRlZCB2YWx1ZS4gVGhlIGl0ZXJhdGVlIGlzIGludm9rZWQKICAgICAqIHdpdGggb25lIGFyZ3VtZW50OiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4xLjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnZlcnQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGl0ZXJhdGVlIGludm9rZWQgcGVyIGVsZW1lbnQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBuZXcgaW52ZXJ0ZWQgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnYSc6IDEsICdiJzogMiwgJ2MnOiAxIH07CiAgICAgKgogICAgICogXy5pbnZlcnRCeShvYmplY3QpOwogICAgICogLy8gPT4geyAnMSc6IFsnYScsICdjJ10sICcyJzogWydiJ10gfQogICAgICoKICAgICAqIF8uaW52ZXJ0Qnkob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICogICByZXR1cm4gJ2dyb3VwJyArIHZhbHVlOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICdncm91cDEnOiBbJ2EnLCAnYyddLCAnZ3JvdXAyJzogWydiJ10gfQogICAgICovCiAgICB2YXIgaW52ZXJ0QnkgPSBjcmVhdGVJbnZlcnRlcihmdW5jdGlvbihyZXN1bHQsIHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYKICAgICAgICAgIHR5cGVvZiB2YWx1ZS50b1N0cmluZyAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdmFsdWUgPSBuYXRpdmVPYmplY3RUb1N0cmluZy5jYWxsKHZhbHVlKTsKICAgICAgfQoKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwocmVzdWx0LCB2YWx1ZSkpIHsKICAgICAgICByZXN1bHRbdmFsdWVdLnB1c2goa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbdmFsdWVdID0gW2tleV07CiAgICAgIH0KICAgIH0sIGdldEl0ZXJhdGVlKTsKCiAgICAvKioKICAgICAqIEludm9rZXMgdGhlIG1ldGhvZCBhdCBgcGF0aGAgb2YgYG9iamVjdGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHBhdGggVGhlIHBhdGggb2YgdGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmdzXSBUaGUgYXJndW1lbnRzIHRvIGludm9rZSB0aGUgbWV0aG9kIHdpdGguCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgcmVzdWx0IG9mIHRoZSBpbnZva2VkIG1ldGhvZC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ2EnOiBbeyAnYic6IHsgJ2MnOiBbMSwgMiwgMywgNF0gfSB9XSB9OwogICAgICoKICAgICAqIF8uaW52b2tlKG9iamVjdCwgJ2FbMF0uYi5jLnNsaWNlJywgMSwgMyk7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqLwogICAgdmFyIGludm9rZSA9IGJhc2VSZXN0KGJhc2VJbnZva2UpOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB0aGUgb3duIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMgb2YgYG9iamVjdGAuCiAgICAgKgogICAgICogKipOb3RlOioqIE5vbi1vYmplY3QgdmFsdWVzIGFyZSBjb2VyY2VkIHRvIG9iamVjdHMuIFNlZSB0aGUKICAgICAqIFtFUyBzcGVjXShodHRwOi8vZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy1vYmplY3Qua2V5cykKICAgICAqIGZvciBtb3JlIGRldGFpbHMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHF1ZXJ5LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRm9vKCkgewogICAgICogICB0aGlzLmEgPSAxOwogICAgICogICB0aGlzLmIgPSAyOwogICAgICogfQogICAgICoKICAgICAqIEZvby5wcm90b3R5cGUuYyA9IDM7CiAgICAgKgogICAgICogXy5rZXlzKG5ldyBGb28pOwogICAgICogLy8gPT4gWydhJywgJ2InXSAoaXRlcmF0aW9uIG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAgICoKICAgICAqIF8ua2V5cygnaGknKTsKICAgICAqIC8vID0+IFsnMCcsICcxJ10KICAgICAqLwogICAgZnVuY3Rpb24ga2V5cyhvYmplY3QpIHsKICAgICAgcmV0dXJuIGlzQXJyYXlMaWtlKG9iamVjdCkgPyBhcnJheUxpa2VLZXlzKG9iamVjdCkgOiBiYXNlS2V5cyhvYmplY3QpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB0aGUgb3duIGFuZCBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0eSBuYW1lcyBvZiBgb2JqZWN0YC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogTm9uLW9iamVjdCB2YWx1ZXMgYXJlIGNvZXJjZWQgdG8gb2JqZWN0cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBGb28oKSB7CiAgICAgKiAgIHRoaXMuYSA9IDE7CiAgICAgKiAgIHRoaXMuYiA9IDI7CiAgICAgKiB9CiAgICAgKgogICAgICogRm9vLnByb3RvdHlwZS5jID0gMzsKICAgICAqCiAgICAgKiBfLmtleXNJbihuZXcgRm9vKTsKICAgICAqIC8vID0+IFsnYScsICdiJywgJ2MnXSAoaXRlcmF0aW9uIG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAgICovCiAgICBmdW5jdGlvbiBrZXlzSW4ob2JqZWN0KSB7CiAgICAgIHJldHVybiBpc0FycmF5TGlrZShvYmplY3QpID8gYXJyYXlMaWtlS2V5cyhvYmplY3QsIHRydWUpIDogYmFzZUtleXNJbihvYmplY3QpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIG9wcG9zaXRlIG9mIGBfLm1hcFZhbHVlc2A7IHRoaXMgbWV0aG9kIGNyZWF0ZXMgYW4gb2JqZWN0IHdpdGggdGhlCiAgICAgKiBzYW1lIHZhbHVlcyBhcyBgb2JqZWN0YCBhbmQga2V5cyBnZW5lcmF0ZWQgYnkgcnVubmluZyBlYWNoIG93biBlbnVtZXJhYmxlCiAgICAgKiBzdHJpbmcga2V5ZWQgcHJvcGVydHkgb2YgYG9iamVjdGAgdGhydSBgaXRlcmF0ZWVgLiBUaGUgaXRlcmF0ZWUgaXMgaW52b2tlZAogICAgICogd2l0aCB0aHJlZSBhcmd1bWVudHM6ICh2YWx1ZSwga2V5LCBvYmplY3QpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy44LjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBtYXBwZWQgb2JqZWN0LgogICAgICogQHNlZSBfLm1hcFZhbHVlcwogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLm1hcEtleXMoeyAnYSc6IDEsICdiJzogMiB9LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIHJldHVybiBrZXkgKyB2YWx1ZTsKICAgICAqIH0pOwogICAgICogLy8gPT4geyAnYTEnOiAxLCAnYjInOiAyIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWFwS2V5cyhvYmplY3QsIGl0ZXJhdGVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaXRlcmF0ZWUgPSBnZXRJdGVyYXRlZShpdGVyYXRlZSwgMyk7CgogICAgICBiYXNlRm9yT3duKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgICAgYmFzZUFzc2lnblZhbHVlKHJlc3VsdCwgaXRlcmF0ZWUodmFsdWUsIGtleSwgb2JqZWN0KSwgdmFsdWUpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IHdpdGggdGhlIHNhbWUga2V5cyBhcyBgb2JqZWN0YCBhbmQgdmFsdWVzIGdlbmVyYXRlZAogICAgICogYnkgcnVubmluZyBlYWNoIG93biBlbnVtZXJhYmxlIHN0cmluZyBrZXllZCBwcm9wZXJ0eSBvZiBgb2JqZWN0YCB0aHJ1CiAgICAgKiBgaXRlcmF0ZWVgLiBUaGUgaXRlcmF0ZWUgaXMgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czoKICAgICAqICh2YWx1ZSwga2V5LCBvYmplY3QpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMi40LjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXRlcmF0ZWU9Xy5pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBtYXBwZWQgb2JqZWN0LgogICAgICogQHNlZSBfLm1hcEtleXMKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gewogICAgICogICAnZnJlZCc6ICAgIHsgJ3VzZXInOiAnZnJlZCcsICAgICdhZ2UnOiA0MCB9LAogICAgICogICAncGViYmxlcyc6IHsgJ3VzZXInOiAncGViYmxlcycsICdhZ2UnOiAxIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5tYXBWYWx1ZXModXNlcnMsIGZ1bmN0aW9uKG8pIHsgcmV0dXJuIG8uYWdlOyB9KTsKICAgICAqIC8vID0+IHsgJ2ZyZWQnOiA0MCwgJ3BlYmJsZXMnOiAxIH0gKGl0ZXJhdGlvbiBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8ubWFwVmFsdWVzKHVzZXJzLCAnYWdlJyk7CiAgICAgKiAvLyA9PiB7ICdmcmVkJzogNDAsICdwZWJibGVzJzogMSB9IChpdGVyYXRpb24gb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcFZhbHVlcyhvYmplY3QsIGl0ZXJhdGVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaXRlcmF0ZWUgPSBnZXRJdGVyYXRlZShpdGVyYXRlZSwgMyk7CgogICAgICBiYXNlRm9yT3duKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgICAgYmFzZUFzc2lnblZhbHVlKHJlc3VsdCwga2V5LCBpdGVyYXRlZSh2YWx1ZSwga2V5LCBvYmplY3QpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmFzc2lnbmAgZXhjZXB0IHRoYXQgaXQgcmVjdXJzaXZlbHkgbWVyZ2VzIG93biBhbmQKICAgICAqIGluaGVyaXRlZCBlbnVtZXJhYmxlIHN0cmluZyBrZXllZCBwcm9wZXJ0aWVzIG9mIHNvdXJjZSBvYmplY3RzIGludG8gdGhlCiAgICAgKiBkZXN0aW5hdGlvbiBvYmplY3QuIFNvdXJjZSBwcm9wZXJ0aWVzIHRoYXQgcmVzb2x2ZSB0byBgdW5kZWZpbmVkYCBhcmUKICAgICAqIHNraXBwZWQgaWYgYSBkZXN0aW5hdGlvbiB2YWx1ZSBleGlzdHMuIEFycmF5IGFuZCBwbGFpbiBvYmplY3QgcHJvcGVydGllcwogICAgICogYXJlIG1lcmdlZCByZWN1cnNpdmVseS4gT3RoZXIgb2JqZWN0cyBhbmQgdmFsdWUgdHlwZXMgYXJlIG92ZXJyaWRkZW4gYnkKICAgICAqIGFzc2lnbm1lbnQuIFNvdXJjZSBvYmplY3RzIGFyZSBhcHBsaWVkIGZyb20gbGVmdCB0byByaWdodC4gU3Vic2VxdWVudAogICAgICogc291cmNlcyBvdmVyd3JpdGUgcHJvcGVydHkgYXNzaWdubWVudHMgb2YgcHJldmlvdXMgc291cmNlcy4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuNS4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gW3NvdXJjZXNdIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7CiAgICAgKiAgICdhJzogW3sgJ2InOiAyIH0sIHsgJ2QnOiA0IH1dCiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBvdGhlciA9IHsKICAgICAqICAgJ2EnOiBbeyAnYyc6IDMgfSwgeyAnZSc6IDUgfV0KICAgICAqIH07CiAgICAgKgogICAgICogXy5tZXJnZShvYmplY3QsIG90aGVyKTsKICAgICAqIC8vID0+IHsgJ2EnOiBbeyAnYic6IDIsICdjJzogMyB9LCB7ICdkJzogNCwgJ2UnOiA1IH1dIH0KICAgICAqLwogICAgdmFyIG1lcmdlID0gY3JlYXRlQXNzaWduZXIoZnVuY3Rpb24ob2JqZWN0LCBzb3VyY2UsIHNyY0luZGV4KSB7CiAgICAgIGJhc2VNZXJnZShvYmplY3QsIHNvdXJjZSwgc3JjSW5kZXgpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLm1lcmdlYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBjdXN0b21pemVyYCB3aGljaAogICAgICogaXMgaW52b2tlZCB0byBwcm9kdWNlIHRoZSBtZXJnZWQgdmFsdWVzIG9mIHRoZSBkZXN0aW5hdGlvbiBhbmQgc291cmNlCiAgICAgKiBwcm9wZXJ0aWVzLiBJZiBgY3VzdG9taXplcmAgcmV0dXJucyBgdW5kZWZpbmVkYCwgbWVyZ2luZyBpcyBoYW5kbGVkIGJ5IHRoZQogICAgICogbWV0aG9kIGluc3RlYWQuIFRoZSBgY3VzdG9taXplcmAgaXMgaW52b2tlZCB3aXRoIHNpeCBhcmd1bWVudHM6CiAgICAgKiAob2JqVmFsdWUsIHNyY1ZhbHVlLCBrZXksIG9iamVjdCwgc291cmNlLCBzdGFjaykuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIG11dGF0ZXMgYG9iamVjdGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IHNvdXJjZXMgVGhlIHNvdXJjZSBvYmplY3RzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY3VzdG9taXplciBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGFzc2lnbmVkIHZhbHVlcy4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIGN1c3RvbWl6ZXIob2JqVmFsdWUsIHNyY1ZhbHVlKSB7CiAgICAgKiAgIGlmIChfLmlzQXJyYXkob2JqVmFsdWUpKSB7CiAgICAgKiAgICAgcmV0dXJuIG9ialZhbHVlLmNvbmNhdChzcmNWYWx1ZSk7CiAgICAgKiAgIH0KICAgICAqIH0KICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnYSc6IFsxXSwgJ2InOiBbMl0gfTsKICAgICAqIHZhciBvdGhlciA9IHsgJ2EnOiBbM10sICdiJzogWzRdIH07CiAgICAgKgogICAgICogXy5tZXJnZVdpdGgob2JqZWN0LCBvdGhlciwgY3VzdG9taXplcik7CiAgICAgKiAvLyA9PiB7ICdhJzogWzEsIDNdLCAnYic6IFsyLCA0XSB9CiAgICAgKi8KICAgIHZhciBtZXJnZVdpdGggPSBjcmVhdGVBc3NpZ25lcihmdW5jdGlvbihvYmplY3QsIHNvdXJjZSwgc3JjSW5kZXgsIGN1c3RvbWl6ZXIpIHsKICAgICAgYmFzZU1lcmdlKG9iamVjdCwgc291cmNlLCBzcmNJbmRleCwgY3VzdG9taXplcik7CiAgICB9KTsKCiAgICAvKioKICAgICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5waWNrYDsgdGhpcyBtZXRob2QgY3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlCiAgICAgKiBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnR5IHBhdGhzIG9mIGBvYmplY3RgIHRoYXQgYXJlIG5vdCBvbWl0dGVkLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBpcyBjb25zaWRlcmFibHkgc2xvd2VyIHRoYW4gYF8ucGlja2AuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uKHN0cmluZ3xzdHJpbmdbXSl9IFtwYXRoc10gVGhlIHByb3BlcnR5IHBhdGhzIHRvIG9taXQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBuZXcgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnYSc6IDEsICdiJzogJzInLCAnYyc6IDMgfTsKICAgICAqCiAgICAgKiBfLm9taXQob2JqZWN0LCBbJ2EnLCAnYyddKTsKICAgICAqIC8vID0+IHsgJ2InOiAnMicgfQogICAgICovCiAgICB2YXIgb21pdCA9IGZsYXRSZXN0KGZ1bmN0aW9uKG9iamVjdCwgcGF0aHMpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICBpZiAob2JqZWN0ID09IG51bGwpIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHZhciBpc0RlZXAgPSBmYWxzZTsKICAgICAgcGF0aHMgPSBhcnJheU1hcChwYXRocywgZnVuY3Rpb24ocGF0aCkgewogICAgICAgIHBhdGggPSBjYXN0UGF0aChwYXRoLCBvYmplY3QpOwogICAgICAgIGlzRGVlcCB8fCAoaXNEZWVwID0gcGF0aC5sZW5ndGggPiAxKTsKICAgICAgICByZXR1cm4gcGF0aDsKICAgICAgfSk7CiAgICAgIGNvcHlPYmplY3Qob2JqZWN0LCBnZXRBbGxLZXlzSW4ob2JqZWN0KSwgcmVzdWx0KTsKICAgICAgaWYgKGlzRGVlcCkgewogICAgICAgIHJlc3VsdCA9IGJhc2VDbG9uZShyZXN1bHQsIENMT05FX0RFRVBfRkxBRyB8IENMT05FX0ZMQVRfRkxBRyB8IENMT05FX1NZTUJPTFNfRkxBRywgY3VzdG9tT21pdENsb25lKTsKICAgICAgfQogICAgICB2YXIgbGVuZ3RoID0gcGF0aHMubGVuZ3RoOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBiYXNlVW5zZXQocmVzdWx0LCBwYXRoc1tsZW5ndGhdKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSk7CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8ucGlja0J5YDsgdGhpcyBtZXRob2QgY3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2YKICAgICAqIHRoZSBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHN0cmluZyBrZXllZCBwcm9wZXJ0aWVzIG9mIGBvYmplY3RgIHRoYXQKICAgICAqIGBwcmVkaWNhdGVgIGRvZXNuJ3QgcmV0dXJuIHRydXRoeSBmb3IuIFRoZSBwcmVkaWNhdGUgaXMgaW52b2tlZCB3aXRoIHR3bwogICAgICogYXJndW1lbnRzOiAodmFsdWUsIGtleSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtwcmVkaWNhdGU9Xy5pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIHByb3BlcnR5LgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgbmV3IG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ2EnOiAxLCAnYic6ICcyJywgJ2MnOiAzIH07CiAgICAgKgogICAgICogXy5vbWl0Qnkob2JqZWN0LCBfLmlzTnVtYmVyKTsKICAgICAqIC8vID0+IHsgJ2InOiAnMicgfQogICAgICovCiAgICBmdW5jdGlvbiBvbWl0Qnkob2JqZWN0LCBwcmVkaWNhdGUpIHsKICAgICAgcmV0dXJuIHBpY2tCeShvYmplY3QsIG5lZ2F0ZShnZXRJdGVyYXRlZShwcmVkaWNhdGUpKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgcGlja2VkIGBvYmplY3RgIHByb3BlcnRpZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uKHN0cmluZ3xzdHJpbmdbXSl9IFtwYXRoc10gVGhlIHByb3BlcnR5IHBhdGhzIHRvIHBpY2suCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBuZXcgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnYSc6IDEsICdiJzogJzInLCAnYyc6IDMgfTsKICAgICAqCiAgICAgKiBfLnBpY2sob2JqZWN0LCBbJ2EnLCAnYyddKTsKICAgICAqIC8vID0+IHsgJ2EnOiAxLCAnYyc6IDMgfQogICAgICovCiAgICB2YXIgcGljayA9IGZsYXRSZXN0KGZ1bmN0aW9uKG9iamVjdCwgcGF0aHMpIHsKICAgICAgcmV0dXJuIG9iamVjdCA9PSBudWxsID8ge30gOiBiYXNlUGljayhvYmplY3QsIHBhdGhzKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIGBvYmplY3RgIHByb3BlcnRpZXMgYHByZWRpY2F0ZWAgcmV0dXJucwogICAgICogdHJ1dGh5IGZvci4gVGhlIHByZWRpY2F0ZSBpcyBpbnZva2VkIHdpdGggdHdvIGFyZ3VtZW50czogKHZhbHVlLCBrZXkpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIHNvdXJjZSBvYmplY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZGljYXRlPV8uaWRlbnRpdHldIFRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBwcm9wZXJ0eS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICdhJzogMSwgJ2InOiAnMicsICdjJzogMyB9OwogICAgICoKICAgICAqIF8ucGlja0J5KG9iamVjdCwgXy5pc051bWJlcik7CiAgICAgKiAvLyA9PiB7ICdhJzogMSwgJ2MnOiAzIH0KICAgICAqLwogICAgZnVuY3Rpb24gcGlja0J5KG9iamVjdCwgcHJlZGljYXRlKSB7CiAgICAgIGlmIChvYmplY3QgPT0gbnVsbCkgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgICB2YXIgcHJvcHMgPSBhcnJheU1hcChnZXRBbGxLZXlzSW4ob2JqZWN0KSwgZnVuY3Rpb24ocHJvcCkgewogICAgICAgIHJldHVybiBbcHJvcF07CiAgICAgIH0pOwogICAgICBwcmVkaWNhdGUgPSBnZXRJdGVyYXRlZShwcmVkaWNhdGUpOwogICAgICByZXR1cm4gYmFzZVBpY2tCeShvYmplY3QsIHByb3BzLCBmdW5jdGlvbih2YWx1ZSwgcGF0aCkgewogICAgICAgIHJldHVybiBwcmVkaWNhdGUodmFsdWUsIHBhdGhbMF0pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZ2V0YCBleGNlcHQgdGhhdCBpZiB0aGUgcmVzb2x2ZWQgdmFsdWUgaXMgYQogICAgICogZnVuY3Rpb24gaXQncyBpbnZva2VkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIGl0cyBwYXJlbnQgb2JqZWN0IGFuZAogICAgICogaXRzIHJlc3VsdCBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgcHJvcGVydHkgdG8gcmVzb2x2ZS4KICAgICAqIEBwYXJhbSB7Kn0gW2RlZmF1bHRWYWx1ZV0gVGhlIHZhbHVlIHJldHVybmVkIGZvciBgdW5kZWZpbmVkYCByZXNvbHZlZCB2YWx1ZXMuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgcmVzb2x2ZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICdhJzogW3sgJ2InOiB7ICdjMSc6IDMsICdjMic6IF8uY29uc3RhbnQoNCkgfSB9XSB9OwogICAgICoKICAgICAqIF8ucmVzdWx0KG9iamVjdCwgJ2FbMF0uYi5jMScpOwogICAgICogLy8gPT4gMwogICAgICoKICAgICAqIF8ucmVzdWx0KG9iamVjdCwgJ2FbMF0uYi5jMicpOwogICAgICogLy8gPT4gNAogICAgICoKICAgICAqIF8ucmVzdWx0KG9iamVjdCwgJ2FbMF0uYi5jMycsICdkZWZhdWx0Jyk7CiAgICAgKiAvLyA9PiAnZGVmYXVsdCcKICAgICAqCiAgICAgKiBfLnJlc3VsdChvYmplY3QsICdhWzBdLmIuYzMnLCBfLmNvbnN0YW50KCdkZWZhdWx0JykpOwogICAgICogLy8gPT4gJ2RlZmF1bHQnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlc3VsdChvYmplY3QsIHBhdGgsIGRlZmF1bHRWYWx1ZSkgewogICAgICBwYXRoID0gY2FzdFBhdGgocGF0aCwgb2JqZWN0KTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgogICAgICAvLyBFbnN1cmUgdGhlIGxvb3AgaXMgZW50ZXJlZCB3aGVuIHBhdGggaXMgZW1wdHkuCiAgICAgIGlmICghbGVuZ3RoKSB7CiAgICAgICAgbGVuZ3RoID0gMTsKICAgICAgICBvYmplY3QgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBvYmplY3QgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IG9iamVjdFt0b0tleShwYXRoW2luZGV4XSldOwogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBpbmRleCA9IGxlbmd0aDsKICAgICAgICAgIHZhbHVlID0gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgICBvYmplY3QgPSBpc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlLmNhbGwob2JqZWN0KSA6IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSB2YWx1ZSBhdCBgcGF0aGAgb2YgYG9iamVjdGAuIElmIGEgcG9ydGlvbiBvZiBgcGF0aGAgZG9lc24ndCBleGlzdCwKICAgICAqIGl0J3MgY3JlYXRlZC4gQXJyYXlzIGFyZSBjcmVhdGVkIGZvciBtaXNzaW5nIGluZGV4IHByb3BlcnRpZXMgd2hpbGUgb2JqZWN0cwogICAgICogYXJlIGNyZWF0ZWQgZm9yIGFsbCBvdGhlciBtaXNzaW5nIHByb3BlcnRpZXMuIFVzZSBgXy5zZXRXaXRoYCB0byBjdXN0b21pemUKICAgICAqIGBwYXRoYCBjcmVhdGlvbi4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuNy4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHBhdGggVGhlIHBhdGggb2YgdGhlIHByb3BlcnR5IHRvIHNldC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICdhJzogW3sgJ2InOiB7ICdjJzogMyB9IH1dIH07CiAgICAgKgogICAgICogXy5zZXQob2JqZWN0LCAnYVswXS5iLmMnLCA0KTsKICAgICAqIGNvbnNvbGUubG9nKG9iamVjdC5hWzBdLmIuYyk7CiAgICAgKiAvLyA9PiA0CiAgICAgKgogICAgICogXy5zZXQob2JqZWN0LCBbJ3gnLCAnMCcsICd5JywgJ3onXSwgNSk7CiAgICAgKiBjb25zb2xlLmxvZyhvYmplY3QueFswXS55LnopOwogICAgICogLy8gPT4gNQogICAgICovCiAgICBmdW5jdGlvbiBzZXQob2JqZWN0LCBwYXRoLCB2YWx1ZSkgewogICAgICByZXR1cm4gb2JqZWN0ID09IG51bGwgPyBvYmplY3QgOiBiYXNlU2V0KG9iamVjdCwgcGF0aCwgdmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5zZXRgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGN1c3RvbWl6ZXJgIHdoaWNoIGlzCiAgICAgKiBpbnZva2VkIHRvIHByb2R1Y2UgdGhlIG9iamVjdHMgb2YgYHBhdGhgLiAgSWYgYGN1c3RvbWl6ZXJgIHJldHVybnMgYHVuZGVmaW5lZGAKICAgICAqIHBhdGggY3JlYXRpb24gaXMgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBgY3VzdG9taXplcmAgaXMgaW52b2tlZAogICAgICogd2l0aCB0aHJlZSBhcmd1bWVudHM6IChuc1ZhbHVlLCBrZXksIG5zT2JqZWN0KS4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHBhdGggVGhlIHBhdGggb2YgdGhlIHByb3BlcnR5IHRvIHNldC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjdXN0b21pemVyXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGFzc2lnbmVkIHZhbHVlcy4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7fTsKICAgICAqCiAgICAgKiBfLnNldFdpdGgob2JqZWN0LCAnWzBdWzFdJywgJ2EnLCBPYmplY3QpOwogICAgICogLy8gPT4geyAnMCc6IHsgJzEnOiAnYScgfSB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldFdpdGgob2JqZWN0LCBwYXRoLCB2YWx1ZSwgY3VzdG9taXplcikgewogICAgICBjdXN0b21pemVyID0gdHlwZW9mIGN1c3RvbWl6ZXIgPT0gJ2Z1bmN0aW9uJyA/IGN1c3RvbWl6ZXIgOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBvYmplY3QgPT0gbnVsbCA/IG9iamVjdCA6IGJhc2VTZXQob2JqZWN0LCBwYXRoLCB2YWx1ZSwgY3VzdG9taXplcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIG93biBlbnVtZXJhYmxlIHN0cmluZyBrZXllZC12YWx1ZSBwYWlycyBmb3IgYG9iamVjdGAKICAgICAqIHdoaWNoIGNhbiBiZSBjb25zdW1lZCBieSBgXy5mcm9tUGFpcnNgLiBJZiBgb2JqZWN0YCBpcyBhIG1hcCBvciBzZXQsIGl0cwogICAgICogZW50cmllcyBhcmUgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGFsaWFzIGVudHJpZXMKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUga2V5LXZhbHVlIHBhaXJzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBGb28oKSB7CiAgICAgKiAgIHRoaXMuYSA9IDE7CiAgICAgKiAgIHRoaXMuYiA9IDI7CiAgICAgKiB9CiAgICAgKgogICAgICogRm9vLnByb3RvdHlwZS5jID0gMzsKICAgICAqCiAgICAgKiBfLnRvUGFpcnMobmV3IEZvbyk7CiAgICAgKiAvLyA9PiBbWydhJywgMV0sIFsnYicsIDJdXSAoaXRlcmF0aW9uIG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAgICovCiAgICB2YXIgdG9QYWlycyA9IGNyZWF0ZVRvUGFpcnMoa2V5cyk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIG93biBhbmQgaW5oZXJpdGVkIGVudW1lcmFibGUgc3RyaW5nIGtleWVkLXZhbHVlIHBhaXJzCiAgICAgKiBmb3IgYG9iamVjdGAgd2hpY2ggY2FuIGJlIGNvbnN1bWVkIGJ5IGBfLmZyb21QYWlyc2AuIElmIGBvYmplY3RgIGlzIGEgbWFwCiAgICAgKiBvciBzZXQsIGl0cyBlbnRyaWVzIGFyZSByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAYWxpYXMgZW50cmllc0luCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGtleS12YWx1ZSBwYWlycy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRm9vKCkgewogICAgICogICB0aGlzLmEgPSAxOwogICAgICogICB0aGlzLmIgPSAyOwogICAgICogfQogICAgICoKICAgICAqIEZvby5wcm90b3R5cGUuYyA9IDM7CiAgICAgKgogICAgICogXy50b1BhaXJzSW4obmV3IEZvbyk7CiAgICAgKiAvLyA9PiBbWydhJywgMV0sIFsnYicsIDJdLCBbJ2MnLCAzXV0gKGl0ZXJhdGlvbiBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgICAqLwogICAgdmFyIHRvUGFpcnNJbiA9IGNyZWF0ZVRvUGFpcnMoa2V5c0luKTsKCiAgICAvKioKICAgICAqIEFuIGFsdGVybmF0aXZlIHRvIGBfLnJlZHVjZWA7IHRoaXMgbWV0aG9kIHRyYW5zZm9ybXMgYG9iamVjdGAgdG8gYSBuZXcKICAgICAqIGBhY2N1bXVsYXRvcmAgb2JqZWN0IHdoaWNoIGlzIHRoZSByZXN1bHQgb2YgcnVubmluZyBlYWNoIG9mIGl0cyBvd24KICAgICAqIGVudW1lcmFibGUgc3RyaW5nIGtleWVkIHByb3BlcnRpZXMgdGhydSBgaXRlcmF0ZWVgLCB3aXRoIGVhY2ggaW52b2NhdGlvbgogICAgICogcG90ZW50aWFsbHkgbXV0YXRpbmcgdGhlIGBhY2N1bXVsYXRvcmAgb2JqZWN0LiBJZiBgYWNjdW11bGF0b3JgIGlzIG5vdAogICAgICogcHJvdmlkZWQsIGEgbmV3IG9iamVjdCB3aXRoIHRoZSBzYW1lIGBbW1Byb3RvdHlwZV1dYCB3aWxsIGJlIHVzZWQuIFRoZQogICAgICogaXRlcmF0ZWUgaXMgaW52b2tlZCB3aXRoIGZvdXIgYXJndW1lbnRzOiAoYWNjdW11bGF0b3IsIHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICAgKiBJdGVyYXRlZSBmdW5jdGlvbnMgbWF5IGV4aXQgaXRlcmF0aW9uIGVhcmx5IGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAxLjMuMAogICAgICogQGNhdGVnb3J5IE9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIFRoZSBjdXN0b20gYWNjdW11bGF0b3IgdmFsdWUuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udHJhbnNmb3JtKFsyLCAzLCA0XSwgZnVuY3Rpb24ocmVzdWx0LCBuKSB7CiAgICAgKiAgIHJlc3VsdC5wdXNoKG4gKj0gbik7CiAgICAgKiAgIHJldHVybiBuICUgMiA9PSAwOwogICAgICogfSwgW10pOwogICAgICogLy8gPT4gWzQsIDldCiAgICAgKgogICAgICogXy50cmFuc2Zvcm0oeyAnYSc6IDEsICdiJzogMiwgJ2MnOiAxIH0sIGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICogICAocmVzdWx0W3ZhbHVlXSB8fCAocmVzdWx0W3ZhbHVlXSA9IFtdKSkucHVzaChrZXkpOwogICAgICogfSwge30pOwogICAgICogLy8gPT4geyAnMSc6IFsnYScsICdjJ10sICcyJzogWydiJ10gfQogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2Zvcm0ob2JqZWN0LCBpdGVyYXRlZSwgYWNjdW11bGF0b3IpIHsKICAgICAgdmFyIGlzQXJyID0gaXNBcnJheShvYmplY3QpLAogICAgICAgICAgaXNBcnJMaWtlID0gaXNBcnIgfHwgaXNCdWZmZXIob2JqZWN0KSB8fCBpc1R5cGVkQXJyYXkob2JqZWN0KTsKCiAgICAgIGl0ZXJhdGVlID0gZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDQpOwogICAgICBpZiAoYWNjdW11bGF0b3IgPT0gbnVsbCkgewogICAgICAgIHZhciBDdG9yID0gb2JqZWN0ICYmIG9iamVjdC5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoaXNBcnJMaWtlKSB7CiAgICAgICAgICBhY2N1bXVsYXRvciA9IGlzQXJyID8gbmV3IEN0b3IgOiBbXTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBpc0Z1bmN0aW9uKEN0b3IpID8gYmFzZUNyZWF0ZShnZXRQcm90b3R5cGUob2JqZWN0KSkgOiB7fTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBhY2N1bXVsYXRvciA9IHt9OwogICAgICAgIH0KICAgICAgfQogICAgICAoaXNBcnJMaWtlID8gYXJyYXlFYWNoIDogYmFzZUZvck93bikob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICAgIHJldHVybiBpdGVyYXRlZShhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBvYmplY3QpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyB0aGUgcHJvcGVydHkgYXQgYHBhdGhgIG9mIGBvYmplY3RgLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBtdXRhdGVzIGBvYmplY3RgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgcHJvcGVydHkgdG8gdW5zZXQuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHByb3BlcnR5IGlzIGRlbGV0ZWQsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ2EnOiBbeyAnYic6IHsgJ2MnOiA3IH0gfV0gfTsKICAgICAqIF8udW5zZXQob2JqZWN0LCAnYVswXS5iLmMnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhvYmplY3QpOwogICAgICogLy8gPT4geyAnYSc6IFt7ICdiJzoge30gfV0gfTsKICAgICAqCiAgICAgKiBfLnVuc2V0KG9iamVjdCwgWydhJywgJzAnLCAnYicsICdjJ10pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKG9iamVjdCk7CiAgICAgKiAvLyA9PiB7ICdhJzogW3sgJ2InOiB7fSB9XSB9OwogICAgICovCiAgICBmdW5jdGlvbiB1bnNldChvYmplY3QsIHBhdGgpIHsKICAgICAgcmV0dXJuIG9iamVjdCA9PSBudWxsID8gdHJ1ZSA6IGJhc2VVbnNldChvYmplY3QsIHBhdGgpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5zZXRgIGV4Y2VwdCB0aGF0IGFjY2VwdHMgYHVwZGF0ZXJgIHRvIHByb2R1Y2UgdGhlCiAgICAgKiB2YWx1ZSB0byBzZXQuIFVzZSBgXy51cGRhdGVXaXRoYCB0byBjdXN0b21pemUgYHBhdGhgIGNyZWF0aW9uLiBUaGUgYHVwZGF0ZXJgCiAgICAgKiBpcyBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OiAodmFsdWUpLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBtdXRhdGVzIGBvYmplY3RgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC42LjAKICAgICAqIEBjYXRlZ29yeSBPYmplY3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBtb2RpZnkuCiAgICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgcHJvcGVydHkgdG8gc2V0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gdXBkYXRlciBUaGUgZnVuY3Rpb24gdG8gcHJvZHVjZSB0aGUgdXBkYXRlZCB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICdhJzogW3sgJ2InOiB7ICdjJzogMyB9IH1dIH07CiAgICAgKgogICAgICogXy51cGRhdGUob2JqZWN0LCAnYVswXS5iLmMnLCBmdW5jdGlvbihuKSB7IHJldHVybiBuICogbjsgfSk7CiAgICAgKiBjb25zb2xlLmxvZyhvYmplY3QuYVswXS5iLmMpOwogICAgICogLy8gPT4gOQogICAgICoKICAgICAqIF8udXBkYXRlKG9iamVjdCwgJ3hbMF0ueS56JywgZnVuY3Rpb24obikgeyByZXR1cm4gbiA/IG4gKyAxIDogMDsgfSk7CiAgICAgKiBjb25zb2xlLmxvZyhvYmplY3QueFswXS55LnopOwogICAgICogLy8gPT4gMAogICAgICovCiAgICBmdW5jdGlvbiB1cGRhdGUob2JqZWN0LCBwYXRoLCB1cGRhdGVyKSB7CiAgICAgIHJldHVybiBvYmplY3QgPT0gbnVsbCA/IG9iamVjdCA6IGJhc2VVcGRhdGUob2JqZWN0LCBwYXRoLCBjYXN0RnVuY3Rpb24odXBkYXRlcikpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy51cGRhdGVgIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGN1c3RvbWl6ZXJgIHdoaWNoIGlzCiAgICAgKiBpbnZva2VkIHRvIHByb2R1Y2UgdGhlIG9iamVjdHMgb2YgYHBhdGhgLiAgSWYgYGN1c3RvbWl6ZXJgIHJldHVybnMgYHVuZGVmaW5lZGAKICAgICAqIHBhdGggY3JlYXRpb24gaXMgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBgY3VzdG9taXplcmAgaXMgaW52b2tlZAogICAgICogd2l0aCB0aHJlZSBhcmd1bWVudHM6IChuc1ZhbHVlLCBrZXksIG5zT2JqZWN0KS4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgbXV0YXRlcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuNi4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHBhdGggVGhlIHBhdGggb2YgdGhlIHByb3BlcnR5IHRvIHNldC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHVwZGF0ZXIgVGhlIGZ1bmN0aW9uIHRvIHByb2R1Y2UgdGhlIHVwZGF0ZWQgdmFsdWUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY3VzdG9taXplcl0gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBhc3NpZ25lZCB2YWx1ZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0ge307CiAgICAgKgogICAgICogXy51cGRhdGVXaXRoKG9iamVjdCwgJ1swXVsxXScsIF8uY29uc3RhbnQoJ2EnKSwgT2JqZWN0KTsKICAgICAqIC8vID0+IHsgJzAnOiB7ICcxJzogJ2EnIH0gfQogICAgICovCiAgICBmdW5jdGlvbiB1cGRhdGVXaXRoKG9iamVjdCwgcGF0aCwgdXBkYXRlciwgY3VzdG9taXplcikgewogICAgICBjdXN0b21pemVyID0gdHlwZW9mIGN1c3RvbWl6ZXIgPT0gJ2Z1bmN0aW9uJyA/IGN1c3RvbWl6ZXIgOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBvYmplY3QgPT0gbnVsbCA/IG9iamVjdCA6IGJhc2VVcGRhdGUob2JqZWN0LCBwYXRoLCBjYXN0RnVuY3Rpb24odXBkYXRlciksIGN1c3RvbWl6ZXIpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB0aGUgb3duIGVudW1lcmFibGUgc3RyaW5nIGtleWVkIHByb3BlcnR5IHZhbHVlcyBvZiBgb2JqZWN0YC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogTm9uLW9iamVjdCB2YWx1ZXMgYXJlIGNvZXJjZWQgdG8gb2JqZWN0cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGFycmF5IG9mIHByb3BlcnR5IHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRm9vKCkgewogICAgICogICB0aGlzLmEgPSAxOwogICAgICogICB0aGlzLmIgPSAyOwogICAgICogfQogICAgICoKICAgICAqIEZvby5wcm90b3R5cGUuYyA9IDM7CiAgICAgKgogICAgICogXy52YWx1ZXMobmV3IEZvbyk7CiAgICAgKiAvLyA9PiBbMSwgMl0gKGl0ZXJhdGlvbiBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgICAqCiAgICAgKiBfLnZhbHVlcygnaGknKTsKICAgICAqIC8vID0+IFsnaCcsICdpJ10KICAgICAqLwogICAgZnVuY3Rpb24gdmFsdWVzKG9iamVjdCkgewogICAgICByZXR1cm4gb2JqZWN0ID09IG51bGwgPyBbXSA6IGJhc2VWYWx1ZXMob2JqZWN0LCBrZXlzKG9iamVjdCkpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB0aGUgb3duIGFuZCBpbmhlcml0ZWQgZW51bWVyYWJsZSBzdHJpbmcga2V5ZWQgcHJvcGVydHkKICAgICAqIHZhbHVlcyBvZiBgb2JqZWN0YC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogTm9uLW9iamVjdCB2YWx1ZXMgYXJlIGNvZXJjZWQgdG8gb2JqZWN0cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGFycmF5IG9mIHByb3BlcnR5IHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRm9vKCkgewogICAgICogICB0aGlzLmEgPSAxOwogICAgICogICB0aGlzLmIgPSAyOwogICAgICogfQogICAgICoKICAgICAqIEZvby5wcm90b3R5cGUuYyA9IDM7CiAgICAgKgogICAgICogXy52YWx1ZXNJbihuZXcgRm9vKTsKICAgICAqIC8vID0+IFsxLCAyLCAzXSAoaXRlcmF0aW9uIG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAgICovCiAgICBmdW5jdGlvbiB2YWx1ZXNJbihvYmplY3QpIHsKICAgICAgcmV0dXJuIG9iamVjdCA9PSBudWxsID8gW10gOiBiYXNlVmFsdWVzKG9iamVjdCwga2V5c0luKG9iamVjdCkpOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENsYW1wcyBgbnVtYmVyYCB3aXRoaW4gdGhlIGluY2x1c2l2ZSBgbG93ZXJgIGFuZCBgdXBwZXJgIGJvdW5kcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTnVtYmVyCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbnVtYmVyIFRoZSBudW1iZXIgdG8gY2xhbXAuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xvd2VyXSBUaGUgbG93ZXIgYm91bmQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdXBwZXIgVGhlIHVwcGVyIGJvdW5kLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgY2xhbXBlZCBudW1iZXIuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY2xhbXAoLTEwLCAtNSwgNSk7CiAgICAgKiAvLyA9PiAtNQogICAgICoKICAgICAqIF8uY2xhbXAoMTAsIC01LCA1KTsKICAgICAqIC8vID0+IDUKICAgICAqLwogICAgZnVuY3Rpb24gY2xhbXAobnVtYmVyLCBsb3dlciwgdXBwZXIpIHsKICAgICAgaWYgKHVwcGVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICB1cHBlciA9IGxvd2VyOwogICAgICAgIGxvd2VyID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGlmICh1cHBlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdXBwZXIgPSB0b051bWJlcih1cHBlcik7CiAgICAgICAgdXBwZXIgPSB1cHBlciA9PT0gdXBwZXIgPyB1cHBlciA6IDA7CiAgICAgIH0KICAgICAgaWYgKGxvd2VyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBsb3dlciA9IHRvTnVtYmVyKGxvd2VyKTsKICAgICAgICBsb3dlciA9IGxvd2VyID09PSBsb3dlciA/IGxvd2VyIDogMDsKICAgICAgfQogICAgICByZXR1cm4gYmFzZUNsYW1wKHRvTnVtYmVyKG51bWJlciksIGxvd2VyLCB1cHBlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYG5gIGlzIGJldHdlZW4gYHN0YXJ0YCBhbmQgdXAgdG8sIGJ1dCBub3QgaW5jbHVkaW5nLCBgZW5kYC4gSWYKICAgICAqIGBlbmRgIGlzIG5vdCBzcGVjaWZpZWQsIGl0J3Mgc2V0IHRvIGBzdGFydGAgd2l0aCBgc3RhcnRgIHRoZW4gc2V0IHRvIGAwYC4KICAgICAqIElmIGBzdGFydGAgaXMgZ3JlYXRlciB0aGFuIGBlbmRgIHRoZSBwYXJhbXMgYXJlIHN3YXBwZWQgdG8gc3VwcG9ydAogICAgICogbmVnYXRpdmUgcmFuZ2VzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4zLjAKICAgICAqIEBjYXRlZ29yeSBOdW1iZXIKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW1iZXIgVGhlIG51bWJlciB0byBjaGVjay4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnQ9MF0gVGhlIHN0YXJ0IG9mIHRoZSByYW5nZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgVGhlIGVuZCBvZiB0aGUgcmFuZ2UuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYG51bWJlcmAgaXMgaW4gdGhlIHJhbmdlLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAc2VlIF8ucmFuZ2UsIF8ucmFuZ2VSaWdodAogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmluUmFuZ2UoMywgMiwgNCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pblJhbmdlKDQsIDgpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaW5SYW5nZSg0LCAyKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pblJhbmdlKDIsIDIpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmluUmFuZ2UoMS4yLCAyKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmluUmFuZ2UoNS4yLCA0KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pblJhbmdlKC0zLCAtMiwgLTYpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpblJhbmdlKG51bWJlciwgc3RhcnQsIGVuZCkgewogICAgICBzdGFydCA9IHRvRmluaXRlKHN0YXJ0KTsKICAgICAgaWYgKGVuZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIGVuZCA9IHRvRmluaXRlKGVuZCk7CiAgICAgIH0KICAgICAgbnVtYmVyID0gdG9OdW1iZXIobnVtYmVyKTsKICAgICAgcmV0dXJuIGJhc2VJblJhbmdlKG51bWJlciwgc3RhcnQsIGVuZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBQcm9kdWNlcyBhIHJhbmRvbSBudW1iZXIgYmV0d2VlbiB0aGUgaW5jbHVzaXZlIGBsb3dlcmAgYW5kIGB1cHBlcmAgYm91bmRzLgogICAgICogSWYgb25seSBvbmUgYXJndW1lbnQgaXMgcHJvdmlkZWQgYSBudW1iZXIgYmV0d2VlbiBgMGAgYW5kIHRoZSBnaXZlbiBudW1iZXIKICAgICAqIGlzIHJldHVybmVkLiBJZiBgZmxvYXRpbmdgIGlzIGB0cnVlYCwgb3IgZWl0aGVyIGBsb3dlcmAgb3IgYHVwcGVyYCBhcmUKICAgICAqIGZsb2F0cywgYSBmbG9hdGluZy1wb2ludCBudW1iZXIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiBhbiBpbnRlZ2VyLgogICAgICoKICAgICAqICoqTm90ZToqKiBKYXZhU2NyaXB0IGZvbGxvd3MgdGhlIElFRUUtNzU0IHN0YW5kYXJkIGZvciByZXNvbHZpbmcKICAgICAqIGZsb2F0aW5nLXBvaW50IHZhbHVlcyB3aGljaCBjYW4gcHJvZHVjZSB1bmV4cGVjdGVkIHJlc3VsdHMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAwLjcuMAogICAgICogQGNhdGVnb3J5IE51bWJlcgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtsb3dlcj0wXSBUaGUgbG93ZXIgYm91bmQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3VwcGVyPTFdIFRoZSB1cHBlciBib3VuZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2Zsb2F0aW5nXSBTcGVjaWZ5IHJldHVybmluZyBhIGZsb2F0aW5nLXBvaW50IG51bWJlci4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIHJhbmRvbSBudW1iZXIuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucmFuZG9tKDAsIDUpOwogICAgICogLy8gPT4gYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDUKICAgICAqCiAgICAgKiBfLnJhbmRvbSg1KTsKICAgICAqIC8vID0+IGFsc28gYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDUKICAgICAqCiAgICAgKiBfLnJhbmRvbSg1LCB0cnVlKTsKICAgICAqIC8vID0+IGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyIGJldHdlZW4gMCBhbmQgNQogICAgICoKICAgICAqIF8ucmFuZG9tKDEuMiwgNS4yKTsKICAgICAqIC8vID0+IGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyIGJldHdlZW4gMS4yIGFuZCA1LjIKICAgICAqLwogICAgZnVuY3Rpb24gcmFuZG9tKGxvd2VyLCB1cHBlciwgZmxvYXRpbmcpIHsKICAgICAgaWYgKGZsb2F0aW5nICYmIHR5cGVvZiBmbG9hdGluZyAhPSAnYm9vbGVhbicgJiYgaXNJdGVyYXRlZUNhbGwobG93ZXIsIHVwcGVyLCBmbG9hdGluZykpIHsKICAgICAgICB1cHBlciA9IGZsb2F0aW5nID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGlmIChmbG9hdGluZyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKHR5cGVvZiB1cHBlciA9PSAnYm9vbGVhbicpIHsKICAgICAgICAgIGZsb2F0aW5nID0gdXBwZXI7CiAgICAgICAgICB1cHBlciA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIGxvd2VyID09ICdib29sZWFuJykgewogICAgICAgICAgZmxvYXRpbmcgPSBsb3dlcjsKICAgICAgICAgIGxvd2VyID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobG93ZXIgPT09IHVuZGVmaW5lZCAmJiB1cHBlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbG93ZXIgPSAwOwogICAgICAgIHVwcGVyID0gMTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBsb3dlciA9IHRvRmluaXRlKGxvd2VyKTsKICAgICAgICBpZiAodXBwZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdXBwZXIgPSBsb3dlcjsKICAgICAgICAgIGxvd2VyID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdXBwZXIgPSB0b0Zpbml0ZSh1cHBlcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChsb3dlciA+IHVwcGVyKSB7CiAgICAgICAgdmFyIHRlbXAgPSBsb3dlcjsKICAgICAgICBsb3dlciA9IHVwcGVyOwogICAgICAgIHVwcGVyID0gdGVtcDsKICAgICAgfQogICAgICBpZiAoZmxvYXRpbmcgfHwgbG93ZXIgJSAxIHx8IHVwcGVyICUgMSkgewogICAgICAgIHZhciByYW5kID0gbmF0aXZlUmFuZG9tKCk7CiAgICAgICAgcmV0dXJuIG5hdGl2ZU1pbihsb3dlciArIChyYW5kICogKHVwcGVyIC0gbG93ZXIgKyBmcmVlUGFyc2VGbG9hdCgnMWUtJyArICgocmFuZCArICcnKS5sZW5ndGggLSAxKSkpKSwgdXBwZXIpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlUmFuZG9tKGxvd2VyLCB1cHBlcik7CiAgICB9CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ29udmVydHMgYHN0cmluZ2AgdG8gW2NhbWVsIGNhc2VdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NhbWVsQ2FzZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gY29udmVydC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGNhbWVsIGNhc2VkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5jYW1lbENhc2UoJ0ZvbyBCYXInKTsKICAgICAqIC8vID0+ICdmb29CYXInCiAgICAgKgogICAgICogXy5jYW1lbENhc2UoJy0tZm9vLWJhci0tJyk7CiAgICAgKiAvLyA9PiAnZm9vQmFyJwogICAgICoKICAgICAqIF8uY2FtZWxDYXNlKCdfX0ZPT19CQVJfXycpOwogICAgICogLy8gPT4gJ2Zvb0JhcicKICAgICAqLwogICAgdmFyIGNhbWVsQ2FzZSA9IGNyZWF0ZUNvbXBvdW5kZXIoZnVuY3Rpb24ocmVzdWx0LCB3b3JkLCBpbmRleCkgewogICAgICB3b3JkID0gd29yZC50b0xvd2VyQ2FzZSgpOwogICAgICByZXR1cm4gcmVzdWx0ICsgKGluZGV4ID8gY2FwaXRhbGl6ZSh3b3JkKSA6IHdvcmQpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0aGUgZmlyc3QgY2hhcmFjdGVyIG9mIGBzdHJpbmdgIHRvIHVwcGVyIGNhc2UgYW5kIHRoZSByZW1haW5pbmcKICAgICAqIHRvIGxvd2VyIGNhc2UuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gY2FwaXRhbGl6ZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGNhcGl0YWxpemVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5jYXBpdGFsaXplKCdGUkVEJyk7CiAgICAgKiAvLyA9PiAnRnJlZCcKICAgICAqLwogICAgZnVuY3Rpb24gY2FwaXRhbGl6ZShzdHJpbmcpIHsKICAgICAgcmV0dXJuIHVwcGVyRmlyc3QodG9TdHJpbmcoc3RyaW5nKS50b0xvd2VyQ2FzZSgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIERlYnVycnMgYHN0cmluZ2AgYnkgY29udmVydGluZwogICAgICogW0xhdGluLTEgU3VwcGxlbWVudF0oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTGF0aW4tMV9TdXBwbGVtZW50XyhVbmljb2RlX2Jsb2NrKSNDaGFyYWN0ZXJfdGFibGUpCiAgICAgKiBhbmQgW0xhdGluIEV4dGVuZGVkLUFdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0xhdGluX0V4dGVuZGVkLUEpCiAgICAgKiBsZXR0ZXJzIHRvIGJhc2ljIExhdGluIGxldHRlcnMgYW5kIHJlbW92aW5nCiAgICAgKiBbY29tYmluaW5nIGRpYWNyaXRpY2FsIG1hcmtzXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db21iaW5pbmdfRGlhY3JpdGljYWxfTWFya3MpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBTdHJpbmcKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc3RyaW5nPScnXSBUaGUgc3RyaW5nIHRvIGRlYnVyci4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGRlYnVycmVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5kZWJ1cnIoJ2TDqWrDoCB2dScpOwogICAgICogLy8gPT4gJ2RlamEgdnUnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlYnVycihzdHJpbmcpIHsKICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgcmV0dXJuIHN0cmluZyAmJiBzdHJpbmcucmVwbGFjZShyZUxhdGluLCBkZWJ1cnJMZXR0ZXIpLnJlcGxhY2UocmVDb21ib01hcmssICcnKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgc3RyaW5nYCBlbmRzIHdpdGggdGhlIGdpdmVuIHRhcmdldCBzdHJpbmcuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdGFyZ2V0XSBUaGUgc3RyaW5nIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3Bvc2l0aW9uPXN0cmluZy5sZW5ndGhdIFRoZSBwb3NpdGlvbiB0byBzZWFyY2ggdXAgdG8uCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHN0cmluZ2AgZW5kcyB3aXRoIGB0YXJnZXRgLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5lbmRzV2l0aCgnYWJjJywgJ2MnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmVuZHNXaXRoKCdhYmMnLCAnYicpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmVuZHNXaXRoKCdhYmMnLCAnYicsIDIpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBlbmRzV2l0aChzdHJpbmcsIHRhcmdldCwgcG9zaXRpb24pIHsKICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgdGFyZ2V0ID0gYmFzZVRvU3RyaW5nKHRhcmdldCk7CgogICAgICB2YXIgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aDsKICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbiA9PT0gdW5kZWZpbmVkCiAgICAgICAgPyBsZW5ndGgKICAgICAgICA6IGJhc2VDbGFtcCh0b0ludGVnZXIocG9zaXRpb24pLCAwLCBsZW5ndGgpOwoKICAgICAgdmFyIGVuZCA9IHBvc2l0aW9uOwogICAgICBwb3NpdGlvbiAtPSB0YXJnZXQubGVuZ3RoOwogICAgICByZXR1cm4gcG9zaXRpb24gPj0gMCAmJiBzdHJpbmcuc2xpY2UocG9zaXRpb24sIGVuZCkgPT0gdGFyZ2V0OwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgdGhlIGNoYXJhY3RlcnMgIiYiLCAiPCIsICI+IiwgJyInLCBhbmQgIiciIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICAgKiBjb3JyZXNwb25kaW5nIEhUTUwgZW50aXRpZXMuCiAgICAgKgogICAgICogKipOb3RlOioqIE5vIG90aGVyIGNoYXJhY3RlcnMgYXJlIGVzY2FwZWQuIFRvIGVzY2FwZSBhZGRpdGlvbmFsCiAgICAgKiBjaGFyYWN0ZXJzIHVzZSBhIHRoaXJkLXBhcnR5IGxpYnJhcnkgbGlrZSBbX2hlX10oaHR0cHM6Ly9tdGhzLmJlL2hlKS4KICAgICAqCiAgICAgKiBUaG91Z2ggdGhlICI+IiBjaGFyYWN0ZXIgaXMgZXNjYXBlZCBmb3Igc3ltbWV0cnksIGNoYXJhY3RlcnMgbGlrZQogICAgICogIj4iIGFuZCAiLyIgZG9uJ3QgbmVlZCBlc2NhcGluZyBpbiBIVE1MIGFuZCBoYXZlIG5vIHNwZWNpYWwgbWVhbmluZwogICAgICogdW5sZXNzIHRoZXkncmUgcGFydCBvZiBhIHRhZyBvciB1bnF1b3RlZCBhdHRyaWJ1dGUgdmFsdWUuIFNlZQogICAgICogW01hdGhpYXMgQnluZW5zJ3MgYXJ0aWNsZV0oaHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2FtYmlndW91cy1hbXBlcnNhbmRzKQogICAgICogKHVuZGVyICJzZW1pLXJlbGF0ZWQgZnVuIGZhY3QiKSBmb3IgbW9yZSBkZXRhaWxzLgogICAgICoKICAgICAqIFdoZW4gd29ya2luZyB3aXRoIEhUTUwgeW91IHNob3VsZCBhbHdheXMKICAgICAqIFtxdW90ZSBhdHRyaWJ1dGUgdmFsdWVzXShodHRwOi8vd29ua28uY29tL3Bvc3QvaHRtbC1lc2NhcGluZykgdG8gcmVkdWNlCiAgICAgKiBYU1MgdmVjdG9ycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byBlc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5lc2NhcGUoJ2ZyZWQsIGJhcm5leSwgJiBwZWJibGVzJyk7CiAgICAgKiAvLyA9PiAnZnJlZCwgYmFybmV5LCAmYW1wOyBwZWJibGVzJwogICAgICovCiAgICBmdW5jdGlvbiBlc2NhcGUoc3RyaW5nKSB7CiAgICAgIHN0cmluZyA9IHRvU3RyaW5nKHN0cmluZyk7CiAgICAgIHJldHVybiAoc3RyaW5nICYmIHJlSGFzVW5lc2NhcGVkSHRtbC50ZXN0KHN0cmluZykpCiAgICAgICAgPyBzdHJpbmcucmVwbGFjZShyZVVuZXNjYXBlZEh0bWwsIGVzY2FwZUh0bWxDaGFyKQogICAgICAgIDogc3RyaW5nOwogICAgfQoKICAgIC8qKgogICAgICogRXNjYXBlcyB0aGUgYFJlZ0V4cGAgc3BlY2lhbCBjaGFyYWN0ZXJzICJeIiwgIiQiLCAiXCIsICIuIiwgIioiLCAiKyIsCiAgICAgKiAiPyIsICIoIiwgIikiLCAiWyIsICJdIiwgInsiLCAifSIsIGFuZCAifCIgaW4gYHN0cmluZ2AuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gZXNjYXBlLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBzdHJpbmcuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZXNjYXBlUmVnRXhwKCdbbG9kYXNoXShodHRwczovL2xvZGFzaC5jb20vKScpOwogICAgICogLy8gPT4gJ1xbbG9kYXNoXF1cKGh0dHBzOi8vbG9kYXNoXC5jb20vXCknCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHJpbmcpIHsKICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgcmV0dXJuIChzdHJpbmcgJiYgcmVIYXNSZWdFeHBDaGFyLnRlc3Qoc3RyaW5nKSkKICAgICAgICA/IHN0cmluZy5yZXBsYWNlKHJlUmVnRXhwQ2hhciwgJ1xcJCYnKQogICAgICAgIDogc3RyaW5nOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgYHN0cmluZ2AgdG8KICAgICAqIFtrZWJhYiBjYXNlXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9MZXR0ZXJfY2FzZSNTcGVjaWFsX2Nhc2Vfc3R5bGVzKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUga2ViYWIgY2FzZWQgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmtlYmFiQ2FzZSgnRm9vIEJhcicpOwogICAgICogLy8gPT4gJ2Zvby1iYXInCiAgICAgKgogICAgICogXy5rZWJhYkNhc2UoJ2Zvb0JhcicpOwogICAgICogLy8gPT4gJ2Zvby1iYXInCiAgICAgKgogICAgICogXy5rZWJhYkNhc2UoJ19fRk9PX0JBUl9fJyk7CiAgICAgKiAvLyA9PiAnZm9vLWJhcicKICAgICAqLwogICAgdmFyIGtlYmFiQ2FzZSA9IGNyZWF0ZUNvbXBvdW5kZXIoZnVuY3Rpb24ocmVzdWx0LCB3b3JkLCBpbmRleCkgewogICAgICByZXR1cm4gcmVzdWx0ICsgKGluZGV4ID8gJy0nIDogJycpICsgd29yZC50b0xvd2VyQ2FzZSgpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBgc3RyaW5nYCwgYXMgc3BhY2Ugc2VwYXJhdGVkIHdvcmRzLCB0byBsb3dlciBjYXNlLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBTdHJpbmcKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc3RyaW5nPScnXSBUaGUgc3RyaW5nIHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBsb3dlciBjYXNlZCBzdHJpbmcuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubG93ZXJDYXNlKCctLUZvby1CYXItLScpOwogICAgICogLy8gPT4gJ2ZvbyBiYXInCiAgICAgKgogICAgICogXy5sb3dlckNhc2UoJ2Zvb0JhcicpOwogICAgICogLy8gPT4gJ2ZvbyBiYXInCiAgICAgKgogICAgICogXy5sb3dlckNhc2UoJ19fRk9PX0JBUl9fJyk7CiAgICAgKiAvLyA9PiAnZm9vIGJhcicKICAgICAqLwogICAgdmFyIGxvd2VyQ2FzZSA9IGNyZWF0ZUNvbXBvdW5kZXIoZnVuY3Rpb24ocmVzdWx0LCB3b3JkLCBpbmRleCkgewogICAgICByZXR1cm4gcmVzdWx0ICsgKGluZGV4ID8gJyAnIDogJycpICsgd29yZC50b0xvd2VyQ2FzZSgpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0aGUgZmlyc3QgY2hhcmFjdGVyIG9mIGBzdHJpbmdgIHRvIGxvd2VyIGNhc2UuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gY29udmVydC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGNvbnZlcnRlZCBzdHJpbmcuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubG93ZXJGaXJzdCgnRnJlZCcpOwogICAgICogLy8gPT4gJ2ZyZWQnCiAgICAgKgogICAgICogXy5sb3dlckZpcnN0KCdGUkVEJyk7CiAgICAgKiAvLyA9PiAnZlJFRCcKICAgICAqLwogICAgdmFyIGxvd2VyRmlyc3QgPSBjcmVhdGVDYXNlRmlyc3QoJ3RvTG93ZXJDYXNlJyk7CgogICAgLyoqCiAgICAgKiBQYWRzIGBzdHJpbmdgIG9uIHRoZSBsZWZ0IGFuZCByaWdodCBzaWRlcyBpZiBpdCdzIHNob3J0ZXIgdGhhbiBgbGVuZ3RoYC4KICAgICAqIFBhZGRpbmcgY2hhcmFjdGVycyBhcmUgdHJ1bmNhdGVkIGlmIHRoZXkgY2FuJ3QgYmUgZXZlbmx5IGRpdmlkZWQgYnkgYGxlbmd0aGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gcGFkLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtsZW5ndGg9MF0gVGhlIHBhZGRpbmcgbGVuZ3RoLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjaGFycz0nICddIFRoZSBzdHJpbmcgdXNlZCBhcyBwYWRkaW5nLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgcGFkZGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5wYWQoJ2FiYycsIDgpOwogICAgICogLy8gPT4gJyAgYWJjICAgJwogICAgICoKICAgICAqIF8ucGFkKCdhYmMnLCA4LCAnXy0nKTsKICAgICAqIC8vID0+ICdfLWFiY18tXycKICAgICAqCiAgICAgKiBfLnBhZCgnYWJjJywgMyk7CiAgICAgKiAvLyA9PiAnYWJjJwogICAgICovCiAgICBmdW5jdGlvbiBwYWQoc3RyaW5nLCBsZW5ndGgsIGNoYXJzKSB7CiAgICAgIHN0cmluZyA9IHRvU3RyaW5nKHN0cmluZyk7CiAgICAgIGxlbmd0aCA9IHRvSW50ZWdlcihsZW5ndGgpOwoKICAgICAgdmFyIHN0ckxlbmd0aCA9IGxlbmd0aCA/IHN0cmluZ1NpemUoc3RyaW5nKSA6IDA7CiAgICAgIGlmICghbGVuZ3RoIHx8IHN0ckxlbmd0aCA+PSBsZW5ndGgpIHsKICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICB9CiAgICAgIHZhciBtaWQgPSAobGVuZ3RoIC0gc3RyTGVuZ3RoKSAvIDI7CiAgICAgIHJldHVybiAoCiAgICAgICAgY3JlYXRlUGFkZGluZyhuYXRpdmVGbG9vcihtaWQpLCBjaGFycykgKwogICAgICAgIHN0cmluZyArCiAgICAgICAgY3JlYXRlUGFkZGluZyhuYXRpdmVDZWlsKG1pZCksIGNoYXJzKQogICAgICApOwogICAgfQoKICAgIC8qKgogICAgICogUGFkcyBgc3RyaW5nYCBvbiB0aGUgcmlnaHQgc2lkZSBpZiBpdCdzIHNob3J0ZXIgdGhhbiBgbGVuZ3RoYC4gUGFkZGluZwogICAgICogY2hhcmFjdGVycyBhcmUgdHJ1bmNhdGVkIGlmIHRoZXkgZXhjZWVkIGBsZW5ndGhgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBTdHJpbmcKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc3RyaW5nPScnXSBUaGUgc3RyaW5nIHRvIHBhZC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbGVuZ3RoPTBdIFRoZSBwYWRkaW5nIGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY2hhcnM9JyAnXSBUaGUgc3RyaW5nIHVzZWQgYXMgcGFkZGluZy4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHBhZGRlZCBzdHJpbmcuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGFkRW5kKCdhYmMnLCA2KTsKICAgICAqIC8vID0+ICdhYmMgICAnCiAgICAgKgogICAgICogXy5wYWRFbmQoJ2FiYycsIDYsICdfLScpOwogICAgICogLy8gPT4gJ2FiY18tXycKICAgICAqCiAgICAgKiBfLnBhZEVuZCgnYWJjJywgMyk7CiAgICAgKiAvLyA9PiAnYWJjJwogICAgICovCiAgICBmdW5jdGlvbiBwYWRFbmQoc3RyaW5nLCBsZW5ndGgsIGNoYXJzKSB7CiAgICAgIHN0cmluZyA9IHRvU3RyaW5nKHN0cmluZyk7CiAgICAgIGxlbmd0aCA9IHRvSW50ZWdlcihsZW5ndGgpOwoKICAgICAgdmFyIHN0ckxlbmd0aCA9IGxlbmd0aCA/IHN0cmluZ1NpemUoc3RyaW5nKSA6IDA7CiAgICAgIHJldHVybiAobGVuZ3RoICYmIHN0ckxlbmd0aCA8IGxlbmd0aCkKICAgICAgICA/IChzdHJpbmcgKyBjcmVhdGVQYWRkaW5nKGxlbmd0aCAtIHN0ckxlbmd0aCwgY2hhcnMpKQogICAgICAgIDogc3RyaW5nOwogICAgfQoKICAgIC8qKgogICAgICogUGFkcyBgc3RyaW5nYCBvbiB0aGUgbGVmdCBzaWRlIGlmIGl0J3Mgc2hvcnRlciB0aGFuIGBsZW5ndGhgLiBQYWRkaW5nCiAgICAgKiBjaGFyYWN0ZXJzIGFyZSB0cnVuY2F0ZWQgaWYgdGhleSBleGNlZWQgYGxlbmd0aGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gcGFkLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtsZW5ndGg9MF0gVGhlIHBhZGRpbmcgbGVuZ3RoLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjaGFycz0nICddIFRoZSBzdHJpbmcgdXNlZCBhcyBwYWRkaW5nLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgcGFkZGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5wYWRTdGFydCgnYWJjJywgNik7CiAgICAgKiAvLyA9PiAnICAgYWJjJwogICAgICoKICAgICAqIF8ucGFkU3RhcnQoJ2FiYycsIDYsICdfLScpOwogICAgICogLy8gPT4gJ18tX2FiYycKICAgICAqCiAgICAgKiBfLnBhZFN0YXJ0KCdhYmMnLCAzKTsKICAgICAqIC8vID0+ICdhYmMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhZFN0YXJ0KHN0cmluZywgbGVuZ3RoLCBjaGFycykgewogICAgICBzdHJpbmcgPSB0b1N0cmluZyhzdHJpbmcpOwogICAgICBsZW5ndGggPSB0b0ludGVnZXIobGVuZ3RoKTsKCiAgICAgIHZhciBzdHJMZW5ndGggPSBsZW5ndGggPyBzdHJpbmdTaXplKHN0cmluZykgOiAwOwogICAgICByZXR1cm4gKGxlbmd0aCAmJiBzdHJMZW5ndGggPCBsZW5ndGgpCiAgICAgICAgPyAoY3JlYXRlUGFkZGluZyhsZW5ndGggLSBzdHJMZW5ndGgsIGNoYXJzKSArIHN0cmluZykKICAgICAgICA6IHN0cmluZzsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIGBzdHJpbmdgIHRvIGFuIGludGVnZXIgb2YgdGhlIHNwZWNpZmllZCByYWRpeC4gSWYgYHJhZGl4YCBpcwogICAgICogYHVuZGVmaW5lZGAgb3IgYDBgLCBhIGByYWRpeGAgb2YgYDEwYCBpcyB1c2VkIHVubGVzcyBgdmFsdWVgIGlzIGEKICAgICAqIGhleGFkZWNpbWFsLCBpbiB3aGljaCBjYXNlIGEgYHJhZGl4YCBvZiBgMTZgIGlzIHVzZWQuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIGFsaWducyB3aXRoIHRoZQogICAgICogW0VTNSBpbXBsZW1lbnRhdGlvbl0oaHR0cHM6Ly9lczUuZ2l0aHViLmlvLyN4MTUuMS4yLjIpIG9mIGBwYXJzZUludGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAxLjEuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBUaGUgc3RyaW5nIHRvIGNvbnZlcnQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl4PTEwXSBUaGUgcmFkaXggdG8gaW50ZXJwcmV0IGB2YWx1ZWAgYnkuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gRW5hYmxlcyB1c2UgYXMgYW4gaXRlcmF0ZWUgZm9yIG1ldGhvZHMgbGlrZSBgXy5tYXBgLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgY29udmVydGVkIGludGVnZXIuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGFyc2VJbnQoJzA4Jyk7CiAgICAgKiAvLyA9PiA4CiAgICAgKgogICAgICogXy5tYXAoWyc2JywgJzA4JywgJzEwJ10sIF8ucGFyc2VJbnQpOwogICAgICogLy8gPT4gWzYsIDgsIDEwXQogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUludChzdHJpbmcsIHJhZGl4LCBndWFyZCkgewogICAgICBpZiAoZ3VhcmQgfHwgcmFkaXggPT0gbnVsbCkgewogICAgICAgIHJhZGl4ID0gMDsKICAgICAgfSBlbHNlIGlmIChyYWRpeCkgewogICAgICAgIHJhZGl4ID0gK3JhZGl4OwogICAgICB9CiAgICAgIHJldHVybiBuYXRpdmVQYXJzZUludCh0b1N0cmluZyhzdHJpbmcpLnJlcGxhY2UocmVUcmltU3RhcnQsICcnKSwgcmFkaXggfHwgMCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXBlYXRzIHRoZSBnaXZlbiBzdHJpbmcgYG5gIHRpbWVzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBTdHJpbmcKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc3RyaW5nPScnXSBUaGUgc3RyaW5nIHRvIHJlcGVhdC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbj0xXSBUaGUgbnVtYmVyIG9mIHRpbWVzIHRvIHJlcGVhdCB0aGUgc3RyaW5nLgogICAgICogQHBhcmFtLSB7T2JqZWN0fSBbZ3VhcmRdIEVuYWJsZXMgdXNlIGFzIGFuIGl0ZXJhdGVlIGZvciBtZXRob2RzIGxpa2UgYF8ubWFwYC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHJlcGVhdGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yZXBlYXQoJyonLCAzKTsKICAgICAqIC8vID0+ICcqKionCiAgICAgKgogICAgICogXy5yZXBlYXQoJ2FiYycsIDIpOwogICAgICogLy8gPT4gJ2FiY2FiYycKICAgICAqCiAgICAgKiBfLnJlcGVhdCgnYWJjJywgMCk7CiAgICAgKiAvLyA9PiAnJwogICAgICovCiAgICBmdW5jdGlvbiByZXBlYXQoc3RyaW5nLCBuLCBndWFyZCkgewogICAgICBpZiAoKGd1YXJkID8gaXNJdGVyYXRlZUNhbGwoc3RyaW5nLCBuLCBndWFyZCkgOiBuID09PSB1bmRlZmluZWQpKSB7CiAgICAgICAgbiA9IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbiA9IHRvSW50ZWdlcihuKTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZVJlcGVhdCh0b1N0cmluZyhzdHJpbmcpLCBuKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlcGxhY2VzIG1hdGNoZXMgZm9yIGBwYXR0ZXJuYCBpbiBgc3RyaW5nYCB3aXRoIGByZXBsYWNlbWVudGAuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIGlzIGJhc2VkIG9uCiAgICAgKiBbYFN0cmluZyNyZXBsYWNlYF0oaHR0cHM6Ly9tZG4uaW8vU3RyaW5nL3JlcGxhY2UpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBTdHJpbmcKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc3RyaW5nPScnXSBUaGUgc3RyaW5nIHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7UmVnRXhwfHN0cmluZ30gcGF0dGVybiBUaGUgcGF0dGVybiB0byByZXBsYWNlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IHJlcGxhY2VtZW50IFRoZSBtYXRjaCByZXBsYWNlbWVudC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIG1vZGlmaWVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yZXBsYWNlKCdIaSBGcmVkJywgJ0ZyZWQnLCAnQmFybmV5Jyk7CiAgICAgKiAvLyA9PiAnSGkgQmFybmV5JwogICAgICovCiAgICBmdW5jdGlvbiByZXBsYWNlKCkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgIHN0cmluZyA9IHRvU3RyaW5nKGFyZ3NbMF0pOwoKICAgICAgcmV0dXJuIGFyZ3MubGVuZ3RoIDwgMyA/IHN0cmluZyA6IHN0cmluZy5yZXBsYWNlKGFyZ3NbMV0sIGFyZ3NbMl0pOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgYHN0cmluZ2AgdG8KICAgICAqIFtzbmFrZSBjYXNlXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TbmFrZV9jYXNlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc25ha2UgY2FzZWQgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnNuYWtlQ2FzZSgnRm9vIEJhcicpOwogICAgICogLy8gPT4gJ2Zvb19iYXInCiAgICAgKgogICAgICogXy5zbmFrZUNhc2UoJ2Zvb0JhcicpOwogICAgICogLy8gPT4gJ2Zvb19iYXInCiAgICAgKgogICAgICogXy5zbmFrZUNhc2UoJy0tRk9PLUJBUi0tJyk7CiAgICAgKiAvLyA9PiAnZm9vX2JhcicKICAgICAqLwogICAgdmFyIHNuYWtlQ2FzZSA9IGNyZWF0ZUNvbXBvdW5kZXIoZnVuY3Rpb24ocmVzdWx0LCB3b3JkLCBpbmRleCkgewogICAgICByZXR1cm4gcmVzdWx0ICsgKGluZGV4ID8gJ18nIDogJycpICsgd29yZC50b0xvd2VyQ2FzZSgpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBTcGxpdHMgYHN0cmluZ2AgYnkgYHNlcGFyYXRvcmAuCiAgICAgKgogICAgICogKipOb3RlOioqIFRoaXMgbWV0aG9kIGlzIGJhc2VkIG9uCiAgICAgKiBbYFN0cmluZyNzcGxpdGBdKGh0dHBzOi8vbWRuLmlvL1N0cmluZy9zcGxpdCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gc3BsaXQuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cHxzdHJpbmd9IHNlcGFyYXRvciBUaGUgc2VwYXJhdG9yIHBhdHRlcm4gdG8gc3BsaXQgYnkuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xpbWl0XSBUaGUgbGVuZ3RoIHRvIHRydW5jYXRlIHJlc3VsdHMgdG8uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHN0cmluZyBzZWdtZW50cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zcGxpdCgnYS1iLWMnLCAnLScsIDIpOwogICAgICogLy8gPT4gWydhJywgJ2InXQogICAgICovCiAgICBmdW5jdGlvbiBzcGxpdChzdHJpbmcsIHNlcGFyYXRvciwgbGltaXQpIHsKICAgICAgaWYgKGxpbWl0ICYmIHR5cGVvZiBsaW1pdCAhPSAnbnVtYmVyJyAmJiBpc0l0ZXJhdGVlQ2FsbChzdHJpbmcsIHNlcGFyYXRvciwgbGltaXQpKSB7CiAgICAgICAgc2VwYXJhdG9yID0gbGltaXQgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgbGltaXQgPSBsaW1pdCA9PT0gdW5kZWZpbmVkID8gTUFYX0FSUkFZX0xFTkdUSCA6IGxpbWl0ID4+PiAwOwogICAgICBpZiAoIWxpbWl0KSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIHN0cmluZyA9IHRvU3RyaW5nKHN0cmluZyk7CiAgICAgIGlmIChzdHJpbmcgJiYgKAogICAgICAgICAgICB0eXBlb2Ygc2VwYXJhdG9yID09ICdzdHJpbmcnIHx8CiAgICAgICAgICAgIChzZXBhcmF0b3IgIT0gbnVsbCAmJiAhaXNSZWdFeHAoc2VwYXJhdG9yKSkKICAgICAgICAgICkpIHsKICAgICAgICBzZXBhcmF0b3IgPSBiYXNlVG9TdHJpbmcoc2VwYXJhdG9yKTsKICAgICAgICBpZiAoIXNlcGFyYXRvciAmJiBoYXNVbmljb2RlKHN0cmluZykpIHsKICAgICAgICAgIHJldHVybiBjYXN0U2xpY2Uoc3RyaW5nVG9BcnJheShzdHJpbmcpLCAwLCBsaW1pdCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzdHJpbmcuc3BsaXQoc2VwYXJhdG9yLCBsaW1pdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBgc3RyaW5nYCB0bwogICAgICogW3N0YXJ0IGNhc2VdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0xldHRlcl9jYXNlI1N0eWxpc3RpY19vcl9zcGVjaWFsaXNlZF91c2FnZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjEuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gY29udmVydC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHN0YXJ0IGNhc2VkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zdGFydENhc2UoJy0tZm9vLWJhci0tJyk7CiAgICAgKiAvLyA9PiAnRm9vIEJhcicKICAgICAqCiAgICAgKiBfLnN0YXJ0Q2FzZSgnZm9vQmFyJyk7CiAgICAgKiAvLyA9PiAnRm9vIEJhcicKICAgICAqCiAgICAgKiBfLnN0YXJ0Q2FzZSgnX19GT09fQkFSX18nKTsKICAgICAqIC8vID0+ICdGT08gQkFSJwogICAgICovCiAgICB2YXIgc3RhcnRDYXNlID0gY3JlYXRlQ29tcG91bmRlcihmdW5jdGlvbihyZXN1bHQsIHdvcmQsIGluZGV4KSB7CiAgICAgIHJldHVybiByZXN1bHQgKyAoaW5kZXggPyAnICcgOiAnJykgKyB1cHBlckZpcnN0KHdvcmQpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHN0cmluZ2Agc3RhcnRzIHdpdGggdGhlIGdpdmVuIHRhcmdldCBzdHJpbmcuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdGFyZ2V0XSBUaGUgc3RyaW5nIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3Bvc2l0aW9uPTBdIFRoZSBwb3NpdGlvbiB0byBzZWFyY2ggZnJvbS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgc3RyaW5nYCBzdGFydHMgd2l0aCBgdGFyZ2V0YCwKICAgICAqICBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc3RhcnRzV2l0aCgnYWJjJywgJ2EnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLnN0YXJ0c1dpdGgoJ2FiYycsICdiJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uc3RhcnRzV2l0aCgnYWJjJywgJ2InLCAxKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRzV2l0aChzdHJpbmcsIHRhcmdldCwgcG9zaXRpb24pIHsKICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbiA9PSBudWxsCiAgICAgICAgPyAwCiAgICAgICAgOiBiYXNlQ2xhbXAodG9JbnRlZ2VyKHBvc2l0aW9uKSwgMCwgc3RyaW5nLmxlbmd0aCk7CgogICAgICB0YXJnZXQgPSBiYXNlVG9TdHJpbmcodGFyZ2V0KTsKICAgICAgcmV0dXJuIHN0cmluZy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyB0YXJnZXQubGVuZ3RoKSA9PSB0YXJnZXQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgY29tcGlsZWQgdGVtcGxhdGUgZnVuY3Rpb24gdGhhdCBjYW4gaW50ZXJwb2xhdGUgZGF0YSBwcm9wZXJ0aWVzCiAgICAgKiBpbiAiaW50ZXJwb2xhdGUiIGRlbGltaXRlcnMsIEhUTUwtZXNjYXBlIGludGVycG9sYXRlZCBkYXRhIHByb3BlcnRpZXMgaW4KICAgICAqICJlc2NhcGUiIGRlbGltaXRlcnMsIGFuZCBleGVjdXRlIEphdmFTY3JpcHQgaW4gImV2YWx1YXRlIiBkZWxpbWl0ZXJzLiBEYXRhCiAgICAgKiBwcm9wZXJ0aWVzIG1heSBiZSBhY2Nlc3NlZCBhcyBmcmVlIHZhcmlhYmxlcyBpbiB0aGUgdGVtcGxhdGUuIElmIGEgc2V0dGluZwogICAgICogb2JqZWN0IGlzIGdpdmVuLCBpdCB0YWtlcyBwcmVjZWRlbmNlIG92ZXIgYF8udGVtcGxhdGVTZXR0aW5nc2AgdmFsdWVzLgogICAgICoKICAgICAqICoqTm90ZToqKiBJbiB0aGUgZGV2ZWxvcG1lbnQgYnVpbGQgYF8udGVtcGxhdGVgIHV0aWxpemVzCiAgICAgKiBbc291cmNlVVJMc10oaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybCkKICAgICAqIGZvciBlYXNpZXIgZGVidWdnaW5nLgogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHByZWNvbXBpbGluZyB0ZW1wbGF0ZXMgc2VlCiAgICAgKiBbbG9kYXNoJ3MgY3VzdG9tIGJ1aWxkcyBkb2N1bWVudGF0aW9uXShodHRwczovL2xvZGFzaC5jb20vY3VzdG9tLWJ1aWxkcykuCiAgICAgKgogICAgICogRm9yIG1vcmUgaW5mb3JtYXRpb24gb24gQ2hyb21lIGV4dGVuc2lvbiBzYW5kYm94ZXMgc2VlCiAgICAgKiBbQ2hyb21lJ3MgZXh0ZW5zaW9ucyBkb2N1bWVudGF0aW9uXShodHRwczovL2RldmVsb3Blci5jaHJvbWUuY29tL2V4dGVuc2lvbnMvc2FuZGJveGluZ0V2YWwpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBTdHJpbmcKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc3RyaW5nPScnXSBUaGUgdGVtcGxhdGUgc3RyaW5nLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XSBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cH0gW29wdGlvbnMuZXNjYXBlPV8udGVtcGxhdGVTZXR0aW5ncy5lc2NhcGVdCiAgICAgKiAgVGhlIEhUTUwgImVzY2FwZSIgZGVsaW1pdGVyLgogICAgICogQHBhcmFtIHtSZWdFeHB9IFtvcHRpb25zLmV2YWx1YXRlPV8udGVtcGxhdGVTZXR0aW5ncy5ldmFsdWF0ZV0KICAgICAqICBUaGUgImV2YWx1YXRlIiBkZWxpbWl0ZXIuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMuaW1wb3J0cz1fLnRlbXBsYXRlU2V0dGluZ3MuaW1wb3J0c10KICAgICAqICBBbiBvYmplY3QgdG8gaW1wb3J0IGludG8gdGhlIHRlbXBsYXRlIGFzIGZyZWUgdmFyaWFibGVzLgogICAgICogQHBhcmFtIHtSZWdFeHB9IFtvcHRpb25zLmludGVycG9sYXRlPV8udGVtcGxhdGVTZXR0aW5ncy5pbnRlcnBvbGF0ZV0KICAgICAqICBUaGUgImludGVycG9sYXRlIiBkZWxpbWl0ZXIuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW29wdGlvbnMuc291cmNlVVJMPSdsb2Rhc2gudGVtcGxhdGVTb3VyY2VzW25dJ10KICAgICAqICBUaGUgc291cmNlVVJMIG9mIHRoZSBjb21waWxlZCB0ZW1wbGF0ZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy52YXJpYWJsZT0nb2JqJ10KICAgICAqICBUaGUgZGF0YSBvYmplY3QgdmFyaWFibGUgbmFtZS4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBFbmFibGVzIHVzZSBhcyBhbiBpdGVyYXRlZSBmb3IgbWV0aG9kcyBsaWtlIGBfLm1hcGAuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGNvbXBpbGVkIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAvLyBVc2UgdGhlICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyIHRvIGNyZWF0ZSBhIGNvbXBpbGVkIHRlbXBsYXRlLgogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IHVzZXIgJT4hJyk7CiAgICAgKiBjb21waWxlZCh7ICd1c2VyJzogJ2ZyZWQnIH0pOwogICAgICogLy8gPT4gJ2hlbGxvIGZyZWQhJwogICAgICoKICAgICAqIC8vIFVzZSB0aGUgSFRNTCAiZXNjYXBlIiBkZWxpbWl0ZXIgdG8gZXNjYXBlIGRhdGEgcHJvcGVydHkgdmFsdWVzLgogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnPGI+PCUtIHZhbHVlICU+PC9iPicpOwogICAgICogY29tcGlsZWQoeyAndmFsdWUnOiAnPHNjcmlwdD4nIH0pOwogICAgICogLy8gPT4gJzxiPiZsdDtzY3JpcHQmZ3Q7PC9iPicKICAgICAqCiAgICAgKiAvLyBVc2UgdGhlICJldmFsdWF0ZSIgZGVsaW1pdGVyIHRvIGV4ZWN1dGUgSmF2YVNjcmlwdCBhbmQgZ2VuZXJhdGUgSFRNTC4KICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJzwlIF8uZm9yRWFjaCh1c2VycywgZnVuY3Rpb24odXNlcikgeyAlPjxsaT48JS0gdXNlciAlPjwvbGk+PCUgfSk7ICU+Jyk7CiAgICAgKiBjb21waWxlZCh7ICd1c2Vycyc6IFsnZnJlZCcsICdiYXJuZXknXSB9KTsKICAgICAqIC8vID0+ICc8bGk+ZnJlZDwvbGk+PGxpPmJhcm5leTwvbGk+JwogICAgICoKICAgICAqIC8vIFVzZSB0aGUgaW50ZXJuYWwgYHByaW50YCBmdW5jdGlvbiBpbiAiZXZhbHVhdGUiIGRlbGltaXRlcnMuCiAgICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCc8JSBwcmludCgiaGVsbG8gIiArIHVzZXIpOyAlPiEnKTsKICAgICAqIGNvbXBpbGVkKHsgJ3VzZXInOiAnYmFybmV5JyB9KTsKICAgICAqIC8vID0+ICdoZWxsbyBiYXJuZXkhJwogICAgICoKICAgICAqIC8vIFVzZSB0aGUgRVMgdGVtcGxhdGUgbGl0ZXJhbCBkZWxpbWl0ZXIgYXMgYW4gImludGVycG9sYXRlIiBkZWxpbWl0ZXIuCiAgICAgKiAvLyBEaXNhYmxlIHN1cHBvcnQgYnkgcmVwbGFjaW5nIHRoZSAiaW50ZXJwb2xhdGUiIGRlbGltaXRlci4KICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvICR7IHVzZXIgfSEnKTsKICAgICAqIGNvbXBpbGVkKHsgJ3VzZXInOiAncGViYmxlcycgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gcGViYmxlcyEnCiAgICAgKgogICAgICogLy8gVXNlIGJhY2tzbGFzaGVzIHRvIHRyZWF0IGRlbGltaXRlcnMgYXMgcGxhaW4gdGV4dC4KICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJzwlPSAiXFw8JS0gdmFsdWUgJVxcPiIgJT4nKTsKICAgICAqIGNvbXBpbGVkKHsgJ3ZhbHVlJzogJ2lnbm9yZWQnIH0pOwogICAgICogLy8gPT4gJzwlLSB2YWx1ZSAlPicKICAgICAqCiAgICAgKiAvLyBVc2UgdGhlIGBpbXBvcnRzYCBvcHRpb24gdG8gaW1wb3J0IGBqUXVlcnlgIGFzIGBqcWAuCiAgICAgKiB2YXIgdGV4dCA9ICc8JSBqcS5lYWNoKHVzZXJzLCBmdW5jdGlvbih1c2VyKSB7ICU+PGxpPjwlLSB1c2VyICU+PC9saT48JSB9KTsgJT4nOwogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSh0ZXh0LCB7ICdpbXBvcnRzJzogeyAnanEnOiBqUXVlcnkgfSB9KTsKICAgICAqIGNvbXBpbGVkKHsgJ3VzZXJzJzogWydmcmVkJywgJ2Jhcm5leSddIH0pOwogICAgICogLy8gPT4gJzxsaT5mcmVkPC9saT48bGk+YmFybmV5PC9saT4nCiAgICAgKgogICAgICogLy8gVXNlIHRoZSBgc291cmNlVVJMYCBvcHRpb24gdG8gc3BlY2lmeSBhIGN1c3RvbSBzb3VyY2VVUkwgZm9yIHRoZSB0ZW1wbGF0ZS4KICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvIDwlPSB1c2VyICU+IScsIHsgJ3NvdXJjZVVSTCc6ICcvYmFzaWMvZ3JlZXRpbmcuanN0JyB9KTsKICAgICAqIGNvbXBpbGVkKGRhdGEpOwogICAgICogLy8gPT4gRmluZCB0aGUgc291cmNlIG9mICJncmVldGluZy5qc3QiIHVuZGVyIHRoZSBTb3VyY2VzIHRhYiBvciBSZXNvdXJjZXMgcGFuZWwgb2YgdGhlIHdlYiBpbnNwZWN0b3IuCiAgICAgKgogICAgICogLy8gVXNlIHRoZSBgdmFyaWFibGVgIG9wdGlvbiB0byBlbnN1cmUgYSB3aXRoLXN0YXRlbWVudCBpc24ndCB1c2VkIGluIHRoZSBjb21waWxlZCB0ZW1wbGF0ZS4KICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hpIDwlPSBkYXRhLnVzZXIgJT4hJywgeyAndmFyaWFibGUnOiAnZGF0YScgfSk7CiAgICAgKiBjb21waWxlZC5zb3VyY2U7CiAgICAgKiAvLyA9PiBmdW5jdGlvbihkYXRhKSB7CiAgICAgKiAvLyAgIHZhciBfX3QsIF9fcCA9ICcnOwogICAgICogLy8gICBfX3AgKz0gJ2hpICcgKyAoKF9fdCA9ICggZGF0YS51c2VyICkpID09IG51bGwgPyAnJyA6IF9fdCkgKyAnISc7CiAgICAgKiAvLyAgIHJldHVybiBfX3A7CiAgICAgKiAvLyB9CiAgICAgKgogICAgICogLy8gVXNlIGN1c3RvbSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLgogICAgICogXy50ZW1wbGF0ZVNldHRpbmdzLmludGVycG9sYXRlID0gL3t7KFtcc1xTXSs/KX19L2c7CiAgICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoZWxsbyB7eyB1c2VyIH19IScpOwogICAgICogY29tcGlsZWQoeyAndXNlcic6ICdtdXN0YWNoZScgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gbXVzdGFjaGUhJwogICAgICoKICAgICAqIC8vIFVzZSB0aGUgYHNvdXJjZWAgcHJvcGVydHkgdG8gaW5saW5lIGNvbXBpbGVkIHRlbXBsYXRlcyBmb3IgbWVhbmluZ2Z1bAogICAgICogLy8gbGluZSBudW1iZXJzIGluIGVycm9yIG1lc3NhZ2VzIGFuZCBzdGFjayB0cmFjZXMuCiAgICAgKiBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnanN0LmpzJyksICdcCiAgICAgKiAgIHZhciBKU1QgPSB7XAogICAgICogICAgICJtYWluIjogJyArIF8udGVtcGxhdGUobWFpblRleHQpLnNvdXJjZSArICdcCiAgICAgKiAgIH07XAogICAgICogJyk7CiAgICAgKi8KICAgIGZ1bmN0aW9uIHRlbXBsYXRlKHN0cmluZywgb3B0aW9ucywgZ3VhcmQpIHsKICAgICAgLy8gQmFzZWQgb24gSm9obiBSZXNpZydzIGB0bXBsYCBpbXBsZW1lbnRhdGlvbgogICAgICAvLyAoaHR0cDovL2Vqb2huLm9yZy9ibG9nL2phdmFzY3JpcHQtbWljcm8tdGVtcGxhdGluZy8pCiAgICAgIC8vIGFuZCBMYXVyYSBEb2t0b3JvdmEncyBkb1QuanMgKGh0dHBzOi8vZ2l0aHViLmNvbS9vbGFkby9kb1QpLgogICAgICB2YXIgc2V0dGluZ3MgPSBsb2Rhc2gudGVtcGxhdGVTZXR0aW5nczsKCiAgICAgIGlmIChndWFyZCAmJiBpc0l0ZXJhdGVlQ2FsbChzdHJpbmcsIG9wdGlvbnMsIGd1YXJkKSkgewogICAgICAgIG9wdGlvbnMgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgb3B0aW9ucyA9IGFzc2lnbkluV2l0aCh7fSwgb3B0aW9ucywgc2V0dGluZ3MsIGN1c3RvbURlZmF1bHRzQXNzaWduSW4pOwoKICAgICAgdmFyIGltcG9ydHMgPSBhc3NpZ25JbldpdGgoe30sIG9wdGlvbnMuaW1wb3J0cywgc2V0dGluZ3MuaW1wb3J0cywgY3VzdG9tRGVmYXVsdHNBc3NpZ25JbiksCiAgICAgICAgICBpbXBvcnRzS2V5cyA9IGtleXMoaW1wb3J0cyksCiAgICAgICAgICBpbXBvcnRzVmFsdWVzID0gYmFzZVZhbHVlcyhpbXBvcnRzLCBpbXBvcnRzS2V5cyk7CgogICAgICB2YXIgaXNFc2NhcGluZywKICAgICAgICAgIGlzRXZhbHVhdGluZywKICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgIGludGVycG9sYXRlID0gb3B0aW9ucy5pbnRlcnBvbGF0ZSB8fCByZU5vTWF0Y2gsCiAgICAgICAgICBzb3VyY2UgPSAiX19wICs9ICciOwoKICAgICAgLy8gQ29tcGlsZSB0aGUgcmVnZXhwIHRvIG1hdGNoIGVhY2ggZGVsaW1pdGVyLgogICAgICB2YXIgcmVEZWxpbWl0ZXJzID0gUmVnRXhwKAogICAgICAgIChvcHRpb25zLmVzY2FwZSB8fCByZU5vTWF0Y2gpLnNvdXJjZSArICd8JyArCiAgICAgICAgaW50ZXJwb2xhdGUuc291cmNlICsgJ3wnICsKICAgICAgICAoaW50ZXJwb2xhdGUgPT09IHJlSW50ZXJwb2xhdGUgPyByZUVzVGVtcGxhdGUgOiByZU5vTWF0Y2gpLnNvdXJjZSArICd8JyArCiAgICAgICAgKG9wdGlvbnMuZXZhbHVhdGUgfHwgcmVOb01hdGNoKS5zb3VyY2UgKyAnfCQnCiAgICAgICwgJ2cnKTsKCiAgICAgIC8vIFVzZSBhIHNvdXJjZVVSTCBmb3IgZWFzaWVyIGRlYnVnZ2luZy4KICAgICAgLy8gVGhlIHNvdXJjZVVSTCBnZXRzIGluamVjdGVkIGludG8gdGhlIHNvdXJjZSB0aGF0J3MgZXZhbC1lZCwgc28gYmUgY2FyZWZ1bAogICAgICAvLyB3aXRoIGxvb2t1cCAoaW4gY2FzZSBvZiBlLmcuIHByb3RvdHlwZSBwb2xsdXRpb24pLCBhbmQgc3RyaXAgbmV3bGluZXMgaWYgYW55LgogICAgICAvLyBBIG5ld2xpbmUgd291bGRuJ3QgYmUgYSB2YWxpZCBzb3VyY2VVUkwgYW55d2F5LCBhbmQgaXQnZCBlbmFibGUgY29kZSBpbmplY3Rpb24uCiAgICAgIHZhciBzb3VyY2VVUkwgPSAnLy8jIHNvdXJjZVVSTD0nICsKICAgICAgICAoaGFzT3duUHJvcGVydHkuY2FsbChvcHRpb25zLCAnc291cmNlVVJMJykKICAgICAgICAgID8gKG9wdGlvbnMuc291cmNlVVJMICsgJycpLnJlcGxhY2UoL1tcclxuXS9nLCAnICcpCiAgICAgICAgICA6ICgnbG9kYXNoLnRlbXBsYXRlU291cmNlc1snICsgKCsrdGVtcGxhdGVDb3VudGVyKSArICddJykKICAgICAgICApICsgJ1xuJzsKCiAgICAgIHN0cmluZy5yZXBsYWNlKHJlRGVsaW1pdGVycywgZnVuY3Rpb24obWF0Y2gsIGVzY2FwZVZhbHVlLCBpbnRlcnBvbGF0ZVZhbHVlLCBlc1RlbXBsYXRlVmFsdWUsIGV2YWx1YXRlVmFsdWUsIG9mZnNldCkgewogICAgICAgIGludGVycG9sYXRlVmFsdWUgfHwgKGludGVycG9sYXRlVmFsdWUgPSBlc1RlbXBsYXRlVmFsdWUpOwoKICAgICAgICAvLyBFc2NhcGUgY2hhcmFjdGVycyB0aGF0IGNhbid0IGJlIGluY2x1ZGVkIGluIHN0cmluZyBsaXRlcmFscy4KICAgICAgICBzb3VyY2UgKz0gc3RyaW5nLnNsaWNlKGluZGV4LCBvZmZzZXQpLnJlcGxhY2UocmVVbmVzY2FwZWRTdHJpbmcsIGVzY2FwZVN0cmluZ0NoYXIpOwoKICAgICAgICAvLyBSZXBsYWNlIGRlbGltaXRlcnMgd2l0aCBzbmlwcGV0cy4KICAgICAgICBpZiAoZXNjYXBlVmFsdWUpIHsKICAgICAgICAgIGlzRXNjYXBpbmcgPSB0cnVlOwogICAgICAgICAgc291cmNlICs9ICInICtcbl9fZSgiICsgZXNjYXBlVmFsdWUgKyAiKSArXG4nIjsKICAgICAgICB9CiAgICAgICAgaWYgKGV2YWx1YXRlVmFsdWUpIHsKICAgICAgICAgIGlzRXZhbHVhdGluZyA9IHRydWU7CiAgICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGVWYWx1ZSArICI7XG5fX3AgKz0gJyI7CiAgICAgICAgfQogICAgICAgIGlmIChpbnRlcnBvbGF0ZVZhbHVlKSB7CiAgICAgICAgICBzb3VyY2UgKz0gIicgK1xuKChfX3QgPSAoIiArIGludGVycG9sYXRlVmFsdWUgKyAiKSkgPT0gbnVsbCA/ICcnIDogX190KSArXG4nIjsKICAgICAgICB9CiAgICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CgogICAgICAgIC8vIFRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgcHJvZHVjdHMgbmVlZHMgYG1hdGNoYCByZXR1cm5lZCBpbgogICAgICAgIC8vIG9yZGVyIHRvIHByb2R1Y2UgdGhlIGNvcnJlY3QgYG9mZnNldGAgdmFsdWUuCiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICB9KTsKCiAgICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgICAvLyBJZiBgdmFyaWFibGVgIGlzIG5vdCBzcGVjaWZpZWQgd3JhcCBhIHdpdGgtc3RhdGVtZW50IGFyb3VuZCB0aGUgZ2VuZXJhdGVkCiAgICAgIC8vIGNvZGUgdG8gYWRkIHRoZSBkYXRhIG9iamVjdCB0byB0aGUgdG9wIG9mIHRoZSBzY29wZSBjaGFpbi4KICAgICAgLy8gTGlrZSB3aXRoIHNvdXJjZVVSTCwgd2UgdGFrZSBjYXJlIHRvIG5vdCBjaGVjayB0aGUgb3B0aW9uJ3MgcHJvdG90eXBlLAogICAgICAvLyBhcyB0aGlzIGNvbmZpZ3VyYXRpb24gaXMgYSBjb2RlIGluamVjdGlvbiB2ZWN0b3IuCiAgICAgIHZhciB2YXJpYWJsZSA9IGhhc093blByb3BlcnR5LmNhbGwob3B0aW9ucywgJ3ZhcmlhYmxlJykgJiYgb3B0aW9ucy52YXJpYWJsZTsKICAgICAgaWYgKCF2YXJpYWJsZSkgewogICAgICAgIHNvdXJjZSA9ICd3aXRoIChvYmopIHtcbicgKyBzb3VyY2UgKyAnXG59XG4nOwogICAgICB9CiAgICAgIC8vIENsZWFudXAgY29kZSBieSBzdHJpcHBpbmcgZW1wdHkgc3RyaW5ncy4KICAgICAgc291cmNlID0gKGlzRXZhbHVhdGluZyA/IHNvdXJjZS5yZXBsYWNlKHJlRW1wdHlTdHJpbmdMZWFkaW5nLCAnJykgOiBzb3VyY2UpCiAgICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ01pZGRsZSwgJyQxJykKICAgICAgICAucmVwbGFjZShyZUVtcHR5U3RyaW5nVHJhaWxpbmcsICckMTsnKTsKCiAgICAgIC8vIEZyYW1lIGNvZGUgYXMgdGhlIGZ1bmN0aW9uIGJvZHkuCiAgICAgIHNvdXJjZSA9ICdmdW5jdGlvbignICsgKHZhcmlhYmxlIHx8ICdvYmonKSArICcpIHtcbicgKwogICAgICAgICh2YXJpYWJsZQogICAgICAgICAgPyAnJwogICAgICAgICAgOiAnb2JqIHx8IChvYmogPSB7fSk7XG4nCiAgICAgICAgKSArCiAgICAgICAgInZhciBfX3QsIF9fcCA9ICcnIiArCiAgICAgICAgKGlzRXNjYXBpbmcKICAgICAgICAgICA/ICcsIF9fZSA9IF8uZXNjYXBlJwogICAgICAgICAgIDogJycKICAgICAgICApICsKICAgICAgICAoaXNFdmFsdWF0aW5nCiAgICAgICAgICA/ICcsIF9faiA9IEFycmF5LnByb3RvdHlwZS5qb2luO1xuJyArCiAgICAgICAgICAgICJmdW5jdGlvbiBwcmludCgpIHsgX19wICs9IF9fai5jYWxsKGFyZ3VtZW50cywgJycpIH1cbiIKICAgICAgICAgIDogJztcbicKICAgICAgICApICsKICAgICAgICBzb3VyY2UgKwogICAgICAgICdyZXR1cm4gX19wXG59JzsKCiAgICAgIHZhciByZXN1bHQgPSBhdHRlbXB0KGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBGdW5jdGlvbihpbXBvcnRzS2V5cywgc291cmNlVVJMICsgJ3JldHVybiAnICsgc291cmNlKQogICAgICAgICAgLmFwcGx5KHVuZGVmaW5lZCwgaW1wb3J0c1ZhbHVlcyk7CiAgICAgIH0pOwoKICAgICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24ncyBzb3VyY2UgYnkgaXRzIGB0b1N0cmluZ2AgbWV0aG9kIG9yCiAgICAgIC8vIHRoZSBgc291cmNlYCBwcm9wZXJ0eSBhcyBhIGNvbnZlbmllbmNlIGZvciBpbmxpbmluZyBjb21waWxlZCB0ZW1wbGF0ZXMuCiAgICAgIHJlc3VsdC5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIGlmIChpc0Vycm9yKHJlc3VsdCkpIHsKICAgICAgICB0aHJvdyByZXN1bHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIGBzdHJpbmdgLCBhcyBhIHdob2xlLCB0byBsb3dlciBjYXNlIGp1c3QgbGlrZQogICAgICogW1N0cmluZyN0b0xvd2VyQ2FzZV0oaHR0cHM6Ly9tZG4uaW8vdG9Mb3dlckNhc2UpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBTdHJpbmcKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc3RyaW5nPScnXSBUaGUgc3RyaW5nIHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBsb3dlciBjYXNlZCBzdHJpbmcuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udG9Mb3dlcignLS1Gb28tQmFyLS0nKTsKICAgICAqIC8vID0+ICctLWZvby1iYXItLScKICAgICAqCiAgICAgKiBfLnRvTG93ZXIoJ2Zvb0JhcicpOwogICAgICogLy8gPT4gJ2Zvb2JhcicKICAgICAqCiAgICAgKiBfLnRvTG93ZXIoJ19fRk9PX0JBUl9fJyk7CiAgICAgKiAvLyA9PiAnX19mb29fYmFyX18nCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvTG93ZXIodmFsdWUpIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nKHZhbHVlKS50b0xvd2VyQ2FzZSgpOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgYHN0cmluZ2AsIGFzIGEgd2hvbGUsIHRvIHVwcGVyIGNhc2UganVzdCBsaWtlCiAgICAgKiBbU3RyaW5nI3RvVXBwZXJDYXNlXShodHRwczovL21kbi5pby90b1VwcGVyQ2FzZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gY29udmVydC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHVwcGVyIGNhc2VkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy50b1VwcGVyKCctLWZvby1iYXItLScpOwogICAgICogLy8gPT4gJy0tRk9PLUJBUi0tJwogICAgICoKICAgICAqIF8udG9VcHBlcignZm9vQmFyJyk7CiAgICAgKiAvLyA9PiAnRk9PQkFSJwogICAgICoKICAgICAqIF8udG9VcHBlcignX19mb29fYmFyX18nKTsKICAgICAqIC8vID0+ICdfX0ZPT19CQVJfXycKICAgICAqLwogICAgZnVuY3Rpb24gdG9VcHBlcih2YWx1ZSkgewogICAgICByZXR1cm4gdG9TdHJpbmcodmFsdWUpLnRvVXBwZXJDYXNlKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmVzIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHdoaXRlc3BhY2Ugb3Igc3BlY2lmaWVkIGNoYXJhY3RlcnMgZnJvbSBgc3RyaW5nYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byB0cmltLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjaGFycz13aGl0ZXNwYWNlXSBUaGUgY2hhcmFjdGVycyB0byB0cmltLgogICAgICogQHBhcmFtLSB7T2JqZWN0fSBbZ3VhcmRdIEVuYWJsZXMgdXNlIGFzIGFuIGl0ZXJhdGVlIGZvciBtZXRob2RzIGxpa2UgYF8ubWFwYC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHRyaW1tZWQgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnRyaW0oJyAgYWJjICAnKTsKICAgICAqIC8vID0+ICdhYmMnCiAgICAgKgogICAgICogXy50cmltKCctXy1hYmMtXy0nLCAnXy0nKTsKICAgICAqIC8vID0+ICdhYmMnCiAgICAgKgogICAgICogXy5tYXAoWycgIGZvbyAgJywgJyAgYmFyICAnXSwgXy50cmltKTsKICAgICAqIC8vID0+IFsnZm9vJywgJ2JhciddCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyaW0oc3RyaW5nLCBjaGFycywgZ3VhcmQpIHsKICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgaWYgKHN0cmluZyAmJiAoZ3VhcmQgfHwgY2hhcnMgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UocmVUcmltLCAnJyk7CiAgICAgIH0KICAgICAgaWYgKCFzdHJpbmcgfHwgIShjaGFycyA9IGJhc2VUb1N0cmluZyhjaGFycykpKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgfQogICAgICB2YXIgc3RyU3ltYm9scyA9IHN0cmluZ1RvQXJyYXkoc3RyaW5nKSwKICAgICAgICAgIGNoclN5bWJvbHMgPSBzdHJpbmdUb0FycmF5KGNoYXJzKSwKICAgICAgICAgIHN0YXJ0ID0gY2hhcnNTdGFydEluZGV4KHN0clN5bWJvbHMsIGNoclN5bWJvbHMpLAogICAgICAgICAgZW5kID0gY2hhcnNFbmRJbmRleChzdHJTeW1ib2xzLCBjaHJTeW1ib2xzKSArIDE7CgogICAgICByZXR1cm4gY2FzdFNsaWNlKHN0clN5bWJvbHMsIHN0YXJ0LCBlbmQpLmpvaW4oJycpOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyB0cmFpbGluZyB3aGl0ZXNwYWNlIG9yIHNwZWNpZmllZCBjaGFyYWN0ZXJzIGZyb20gYHN0cmluZ2AuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gdHJpbS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY2hhcnM9d2hpdGVzcGFjZV0gVGhlIGNoYXJhY3RlcnMgdG8gdHJpbS4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBFbmFibGVzIHVzZSBhcyBhbiBpdGVyYXRlZSBmb3IgbWV0aG9kcyBsaWtlIGBfLm1hcGAuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB0cmltbWVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy50cmltRW5kKCcgIGFiYyAgJyk7CiAgICAgKiAvLyA9PiAnICBhYmMnCiAgICAgKgogICAgICogXy50cmltRW5kKCctXy1hYmMtXy0nLCAnXy0nKTsKICAgICAqIC8vID0+ICctXy1hYmMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyaW1FbmQoc3RyaW5nLCBjaGFycywgZ3VhcmQpIHsKICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgaWYgKHN0cmluZyAmJiAoZ3VhcmQgfHwgY2hhcnMgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UocmVUcmltRW5kLCAnJyk7CiAgICAgIH0KICAgICAgaWYgKCFzdHJpbmcgfHwgIShjaGFycyA9IGJhc2VUb1N0cmluZyhjaGFycykpKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgfQogICAgICB2YXIgc3RyU3ltYm9scyA9IHN0cmluZ1RvQXJyYXkoc3RyaW5nKSwKICAgICAgICAgIGVuZCA9IGNoYXJzRW5kSW5kZXgoc3RyU3ltYm9scywgc3RyaW5nVG9BcnJheShjaGFycykpICsgMTsKCiAgICAgIHJldHVybiBjYXN0U2xpY2Uoc3RyU3ltYm9scywgMCwgZW5kKS5qb2luKCcnKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZXMgbGVhZGluZyB3aGl0ZXNwYWNlIG9yIHNwZWNpZmllZCBjaGFyYWN0ZXJzIGZyb20gYHN0cmluZ2AuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjAuMAogICAgICogQGNhdGVnb3J5IFN0cmluZwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJpbmc9JyddIFRoZSBzdHJpbmcgdG8gdHJpbS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY2hhcnM9d2hpdGVzcGFjZV0gVGhlIGNoYXJhY3RlcnMgdG8gdHJpbS4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBFbmFibGVzIHVzZSBhcyBhbiBpdGVyYXRlZSBmb3IgbWV0aG9kcyBsaWtlIGBfLm1hcGAuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB0cmltbWVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy50cmltU3RhcnQoJyAgYWJjICAnKTsKICAgICAqIC8vID0+ICdhYmMgICcKICAgICAqCiAgICAgKiBfLnRyaW1TdGFydCgnLV8tYWJjLV8tJywgJ18tJyk7CiAgICAgKiAvLyA9PiAnYWJjLV8tJwogICAgICovCiAgICBmdW5jdGlvbiB0cmltU3RhcnQoc3RyaW5nLCBjaGFycywgZ3VhcmQpIHsKICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgaWYgKHN0cmluZyAmJiAoZ3VhcmQgfHwgY2hhcnMgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UocmVUcmltU3RhcnQsICcnKTsKICAgICAgfQogICAgICBpZiAoIXN0cmluZyB8fCAhKGNoYXJzID0gYmFzZVRvU3RyaW5nKGNoYXJzKSkpIHsKICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICB9CiAgICAgIHZhciBzdHJTeW1ib2xzID0gc3RyaW5nVG9BcnJheShzdHJpbmcpLAogICAgICAgICAgc3RhcnQgPSBjaGFyc1N0YXJ0SW5kZXgoc3RyU3ltYm9scywgc3RyaW5nVG9BcnJheShjaGFycykpOwoKICAgICAgcmV0dXJuIGNhc3RTbGljZShzdHJTeW1ib2xzLCBzdGFydCkuam9pbignJyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUcnVuY2F0ZXMgYHN0cmluZ2AgaWYgaXQncyBsb25nZXIgdGhhbiB0aGUgZ2l2ZW4gbWF4aW11bSBzdHJpbmcgbGVuZ3RoLgogICAgICogVGhlIGxhc3QgY2hhcmFjdGVycyBvZiB0aGUgdHJ1bmNhdGVkIHN0cmluZyBhcmUgcmVwbGFjZWQgd2l0aCB0aGUgb21pc3Npb24KICAgICAqIHN0cmluZyB3aGljaCBkZWZhdWx0cyB0byAiLi4uIi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byB0cnVuY2F0ZS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0gVGhlIG9wdGlvbnMgb2JqZWN0LgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLmxlbmd0aD0zMF0gVGhlIG1heGltdW0gc3RyaW5nIGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy5vbWlzc2lvbj0nLi4uJ10gVGhlIHN0cmluZyB0byBpbmRpY2F0ZSB0ZXh0IGlzIG9taXR0ZWQuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cHxzdHJpbmd9IFtvcHRpb25zLnNlcGFyYXRvcl0gVGhlIHNlcGFyYXRvciBwYXR0ZXJuIHRvIHRydW5jYXRlIHRvLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgdHJ1bmNhdGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy50cnVuY2F0ZSgnaGktZGlkZGx5LWhvIHRoZXJlLCBuZWlnaGJvcmlubycpOwogICAgICogLy8gPT4gJ2hpLWRpZGRseS1obyB0aGVyZSwgbmVpZ2hiby4uLicKICAgICAqCiAgICAgKiBfLnRydW5jYXRlKCdoaS1kaWRkbHktaG8gdGhlcmUsIG5laWdoYm9yaW5vJywgewogICAgICogICAnbGVuZ3RoJzogMjQsCiAgICAgKiAgICdzZXBhcmF0b3InOiAnICcKICAgICAqIH0pOwogICAgICogLy8gPT4gJ2hpLWRpZGRseS1obyB0aGVyZSwuLi4nCiAgICAgKgogICAgICogXy50cnVuY2F0ZSgnaGktZGlkZGx5LWhvIHRoZXJlLCBuZWlnaGJvcmlubycsIHsKICAgICAqICAgJ2xlbmd0aCc6IDI0LAogICAgICogICAnc2VwYXJhdG9yJzogLyw/ICsvCiAgICAgKiB9KTsKICAgICAqIC8vID0+ICdoaS1kaWRkbHktaG8gdGhlcmUuLi4nCiAgICAgKgogICAgICogXy50cnVuY2F0ZSgnaGktZGlkZGx5LWhvIHRoZXJlLCBuZWlnaGJvcmlubycsIHsKICAgICAqICAgJ29taXNzaW9uJzogJyBbLi4uXScKICAgICAqIH0pOwogICAgICogLy8gPT4gJ2hpLWRpZGRseS1obyB0aGVyZSwgbmVpZyBbLi4uXScKICAgICAqLwogICAgZnVuY3Rpb24gdHJ1bmNhdGUoc3RyaW5nLCBvcHRpb25zKSB7CiAgICAgIHZhciBsZW5ndGggPSBERUZBVUxUX1RSVU5DX0xFTkdUSCwKICAgICAgICAgIG9taXNzaW9uID0gREVGQVVMVF9UUlVOQ19PTUlTU0lPTjsKCiAgICAgIGlmIChpc09iamVjdChvcHRpb25zKSkgewogICAgICAgIHZhciBzZXBhcmF0b3IgPSAnc2VwYXJhdG9yJyBpbiBvcHRpb25zID8gb3B0aW9ucy5zZXBhcmF0b3IgOiBzZXBhcmF0b3I7CiAgICAgICAgbGVuZ3RoID0gJ2xlbmd0aCcgaW4gb3B0aW9ucyA/IHRvSW50ZWdlcihvcHRpb25zLmxlbmd0aCkgOiBsZW5ndGg7CiAgICAgICAgb21pc3Npb24gPSAnb21pc3Npb24nIGluIG9wdGlvbnMgPyBiYXNlVG9TdHJpbmcob3B0aW9ucy5vbWlzc2lvbikgOiBvbWlzc2lvbjsKICAgICAgfQogICAgICBzdHJpbmcgPSB0b1N0cmluZyhzdHJpbmcpOwoKICAgICAgdmFyIHN0ckxlbmd0aCA9IHN0cmluZy5sZW5ndGg7CiAgICAgIGlmIChoYXNVbmljb2RlKHN0cmluZykpIHsKICAgICAgICB2YXIgc3RyU3ltYm9scyA9IHN0cmluZ1RvQXJyYXkoc3RyaW5nKTsKICAgICAgICBzdHJMZW5ndGggPSBzdHJTeW1ib2xzLmxlbmd0aDsKICAgICAgfQogICAgICBpZiAobGVuZ3RoID49IHN0ckxlbmd0aCkgewogICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgIH0KICAgICAgdmFyIGVuZCA9IGxlbmd0aCAtIHN0cmluZ1NpemUob21pc3Npb24pOwogICAgICBpZiAoZW5kIDwgMSkgewogICAgICAgIHJldHVybiBvbWlzc2lvbjsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gc3RyU3ltYm9scwogICAgICAgID8gY2FzdFNsaWNlKHN0clN5bWJvbHMsIDAsIGVuZCkuam9pbignJykKICAgICAgICA6IHN0cmluZy5zbGljZSgwLCBlbmQpOwoKICAgICAgaWYgKHNlcGFyYXRvciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdCArIG9taXNzaW9uOwogICAgICB9CiAgICAgIGlmIChzdHJTeW1ib2xzKSB7CiAgICAgICAgZW5kICs9IChyZXN1bHQubGVuZ3RoIC0gZW5kKTsKICAgICAgfQogICAgICBpZiAoaXNSZWdFeHAoc2VwYXJhdG9yKSkgewogICAgICAgIGlmIChzdHJpbmcuc2xpY2UoZW5kKS5zZWFyY2goc2VwYXJhdG9yKSkgewogICAgICAgICAgdmFyIG1hdGNoLAogICAgICAgICAgICAgIHN1YnN0cmluZyA9IHJlc3VsdDsKCiAgICAgICAgICBpZiAoIXNlcGFyYXRvci5nbG9iYWwpIHsKICAgICAgICAgICAgc2VwYXJhdG9yID0gUmVnRXhwKHNlcGFyYXRvci5zb3VyY2UsIHRvU3RyaW5nKHJlRmxhZ3MuZXhlYyhzZXBhcmF0b3IpKSArICdnJyk7CiAgICAgICAgICB9CiAgICAgICAgICBzZXBhcmF0b3IubGFzdEluZGV4ID0gMDsKICAgICAgICAgIHdoaWxlICgobWF0Y2ggPSBzZXBhcmF0b3IuZXhlYyhzdWJzdHJpbmcpKSkgewogICAgICAgICAgICB2YXIgbmV3RW5kID0gbWF0Y2guaW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgbmV3RW5kID09PSB1bmRlZmluZWQgPyBlbmQgOiBuZXdFbmQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzdHJpbmcuaW5kZXhPZihiYXNlVG9TdHJpbmcoc2VwYXJhdG9yKSwgZW5kKSAhPSBlbmQpIHsKICAgICAgICB2YXIgaW5kZXggPSByZXN1bHQubGFzdEluZGV4T2Yoc2VwYXJhdG9yKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnNsaWNlKDAsIGluZGV4KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdCArIG9taXNzaW9uOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGludmVyc2Ugb2YgYF8uZXNjYXBlYDsgdGhpcyBtZXRob2QgY29udmVydHMgdGhlIEhUTUwgZW50aXRpZXMKICAgICAqIGAmYW1wO2AsIGAmbHQ7YCwgYCZndDtgLCBgJnF1b3Q7YCwgYW5kIGAmIzM5O2AgaW4gYHN0cmluZ2AgdG8KICAgICAqIHRoZWlyIGNvcnJlc3BvbmRpbmcgY2hhcmFjdGVycy4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogTm8gb3RoZXIgSFRNTCBlbnRpdGllcyBhcmUgdW5lc2NhcGVkLiBUbyB1bmVzY2FwZSBhZGRpdGlvbmFsCiAgICAgKiBIVE1MIGVudGl0aWVzIHVzZSBhIHRoaXJkLXBhcnR5IGxpYnJhcnkgbGlrZSBbX2hlX10oaHR0cHM6Ly9tdGhzLmJlL2hlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDAuNi4wCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byB1bmVzY2FwZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHVuZXNjYXBlZCBzdHJpbmcuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5lc2NhcGUoJ2ZyZWQsIGJhcm5leSwgJmFtcDsgcGViYmxlcycpOwogICAgICogLy8gPT4gJ2ZyZWQsIGJhcm5leSwgJiBwZWJibGVzJwogICAgICovCiAgICBmdW5jdGlvbiB1bmVzY2FwZShzdHJpbmcpIHsKICAgICAgc3RyaW5nID0gdG9TdHJpbmcoc3RyaW5nKTsKICAgICAgcmV0dXJuIChzdHJpbmcgJiYgcmVIYXNFc2NhcGVkSHRtbC50ZXN0KHN0cmluZykpCiAgICAgICAgPyBzdHJpbmcucmVwbGFjZShyZUVzY2FwZWRIdG1sLCB1bmVzY2FwZUh0bWxDaGFyKQogICAgICAgIDogc3RyaW5nOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgYHN0cmluZ2AsIGFzIHNwYWNlIHNlcGFyYXRlZCB3b3JkcywgdG8gdXBwZXIgY2FzZS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgdXBwZXIgY2FzZWQgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnVwcGVyQ2FzZSgnLS1mb28tYmFyJyk7CiAgICAgKiAvLyA9PiAnRk9PIEJBUicKICAgICAqCiAgICAgKiBfLnVwcGVyQ2FzZSgnZm9vQmFyJyk7CiAgICAgKiAvLyA9PiAnRk9PIEJBUicKICAgICAqCiAgICAgKiBfLnVwcGVyQ2FzZSgnX19mb29fYmFyX18nKTsKICAgICAqIC8vID0+ICdGT08gQkFSJwogICAgICovCiAgICB2YXIgdXBwZXJDYXNlID0gY3JlYXRlQ29tcG91bmRlcihmdW5jdGlvbihyZXN1bHQsIHdvcmQsIGluZGV4KSB7CiAgICAgIHJldHVybiByZXN1bHQgKyAoaW5kZXggPyAnICcgOiAnJykgKyB3b3JkLnRvVXBwZXJDYXNlKCk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENvbnZlcnRzIHRoZSBmaXJzdCBjaGFyYWN0ZXIgb2YgYHN0cmluZ2AgdG8gdXBwZXIgY2FzZS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgY29udmVydGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy51cHBlckZpcnN0KCdmcmVkJyk7CiAgICAgKiAvLyA9PiAnRnJlZCcKICAgICAqCiAgICAgKiBfLnVwcGVyRmlyc3QoJ0ZSRUQnKTsKICAgICAqIC8vID0+ICdGUkVEJwogICAgICovCiAgICB2YXIgdXBwZXJGaXJzdCA9IGNyZWF0ZUNhc2VGaXJzdCgndG9VcHBlckNhc2UnKTsKCiAgICAvKioKICAgICAqIFNwbGl0cyBgc3RyaW5nYCBpbnRvIGFuIGFycmF5IG9mIGl0cyB3b3Jkcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAY2F0ZWdvcnkgU3RyaW5nCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3N0cmluZz0nJ10gVGhlIHN0cmluZyB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtSZWdFeHB8c3RyaW5nfSBbcGF0dGVybl0gVGhlIHBhdHRlcm4gdG8gbWF0Y2ggd29yZHMuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gRW5hYmxlcyB1c2UgYXMgYW4gaXRlcmF0ZWUgZm9yIG1ldGhvZHMgbGlrZSBgXy5tYXBgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSB3b3JkcyBvZiBgc3RyaW5nYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy53b3JkcygnZnJlZCwgYmFybmV5LCAmIHBlYmJsZXMnKTsKICAgICAqIC8vID0+IFsnZnJlZCcsICdiYXJuZXknLCAncGViYmxlcyddCiAgICAgKgogICAgICogXy53b3JkcygnZnJlZCwgYmFybmV5LCAmIHBlYmJsZXMnLCAvW14sIF0rL2cpOwogICAgICogLy8gPT4gWydmcmVkJywgJ2Jhcm5leScsICcmJywgJ3BlYmJsZXMnXQogICAgICovCiAgICBmdW5jdGlvbiB3b3JkcyhzdHJpbmcsIHBhdHRlcm4sIGd1YXJkKSB7CiAgICAgIHN0cmluZyA9IHRvU3RyaW5nKHN0cmluZyk7CiAgICAgIHBhdHRlcm4gPSBndWFyZCA/IHVuZGVmaW5lZCA6IHBhdHRlcm47CgogICAgICBpZiAocGF0dGVybiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIGhhc1VuaWNvZGVXb3JkKHN0cmluZykgPyB1bmljb2RlV29yZHMoc3RyaW5nKSA6IGFzY2lpV29yZHMoc3RyaW5nKTsKICAgICAgfQogICAgICByZXR1cm4gc3RyaW5nLm1hdGNoKHBhdHRlcm4pIHx8IFtdOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIEF0dGVtcHRzIHRvIGludm9rZSBgZnVuY2AsIHJldHVybmluZyBlaXRoZXIgdGhlIHJlc3VsdCBvciB0aGUgY2F1Z2h0IGVycm9yCiAgICAgKiBvYmplY3QuIEFueSBhZGRpdGlvbmFsIGFyZ3VtZW50cyBhcmUgcHJvdmlkZWQgdG8gYGZ1bmNgIHdoZW4gaXQncyBpbnZva2VkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4wLjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBhdHRlbXB0LgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnc10gVGhlIGFyZ3VtZW50cyB0byBpbnZva2UgYGZ1bmNgIHdpdGguCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgYGZ1bmNgIHJlc3VsdCBvciBlcnJvciBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIC8vIEF2b2lkIHRocm93aW5nIGVycm9ycyBmb3IgaW52YWxpZCBzZWxlY3RvcnMuCiAgICAgKiB2YXIgZWxlbWVudHMgPSBfLmF0dGVtcHQoZnVuY3Rpb24oc2VsZWN0b3IpIHsKICAgICAqICAgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogICAgICogfSwgJz5fPicpOwogICAgICoKICAgICAqIGlmIChfLmlzRXJyb3IoZWxlbWVudHMpKSB7CiAgICAgKiAgIGVsZW1lbnRzID0gW107CiAgICAgKiB9CiAgICAgKi8KICAgIHZhciBhdHRlbXB0ID0gYmFzZVJlc3QoZnVuY3Rpb24oZnVuYywgYXJncykgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBhcHBseShmdW5jLCB1bmRlZmluZWQsIGFyZ3MpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIGlzRXJyb3IoZSkgPyBlIDogbmV3IEVycm9yKGUpOwogICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEJpbmRzIG1ldGhvZHMgb2YgYW4gb2JqZWN0IHRvIHRoZSBvYmplY3QgaXRzZWxmLCBvdmVyd3JpdGluZyB0aGUgZXhpc3RpbmcKICAgICAqIG1ldGhvZC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgZG9lc24ndCBzZXQgdGhlICJsZW5ndGgiIHByb3BlcnR5IG9mIGJvdW5kIGZ1bmN0aW9ucy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGJpbmQgYW5kIGFzc2lnbiB0aGUgYm91bmQgbWV0aG9kcyB0by4KICAgICAqIEBwYXJhbSB7Li4uKHN0cmluZ3xzdHJpbmdbXSl9IG1ldGhvZE5hbWVzIFRoZSBvYmplY3QgbWV0aG9kIG5hbWVzIHRvIGJpbmQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgdmlldyA9IHsKICAgICAqICAgJ2xhYmVsJzogJ2RvY3MnLAogICAgICogICAnY2xpY2snOiBmdW5jdGlvbigpIHsKICAgICAqICAgICBjb25zb2xlLmxvZygnY2xpY2tlZCAnICsgdGhpcy5sYWJlbCk7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5iaW5kQWxsKHZpZXcsIFsnY2xpY2snXSk7CiAgICAgKiBqUXVlcnkoZWxlbWVudCkub24oJ2NsaWNrJywgdmlldy5jbGljayk7CiAgICAgKiAvLyA9PiBMb2dzICdjbGlja2VkIGRvY3MnIHdoZW4gY2xpY2tlZC4KICAgICAqLwogICAgdmFyIGJpbmRBbGwgPSBmbGF0UmVzdChmdW5jdGlvbihvYmplY3QsIG1ldGhvZE5hbWVzKSB7CiAgICAgIGFycmF5RWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAga2V5ID0gdG9LZXkoa2V5KTsKICAgICAgICBiYXNlQXNzaWduVmFsdWUob2JqZWN0LCBrZXksIGJpbmQob2JqZWN0W2tleV0sIG9iamVjdCkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgaXRlcmF0ZXMgb3ZlciBgcGFpcnNgIGFuZCBpbnZva2VzIHRoZSBjb3JyZXNwb25kaW5nCiAgICAgKiBmdW5jdGlvbiBvZiB0aGUgZmlyc3QgcHJlZGljYXRlIHRvIHJldHVybiB0cnV0aHkuIFRoZSBwcmVkaWNhdGUtZnVuY3Rpb24KICAgICAqIHBhaXJzIGFyZSBpbnZva2VkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIGFuZCBhcmd1bWVudHMgb2YgdGhlIGNyZWF0ZWQKICAgICAqIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0ge0FycmF5fSBwYWlycyBUaGUgcHJlZGljYXRlLWZ1bmN0aW9uIHBhaXJzLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY29tcG9zaXRlIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgZnVuYyA9IF8uY29uZChbCiAgICAgKiAgIFtfLm1hdGNoZXMoeyAnYSc6IDEgfSksICAgICAgICAgICBfLmNvbnN0YW50KCdtYXRjaGVzIEEnKV0sCiAgICAgKiAgIFtfLmNvbmZvcm1zKHsgJ2InOiBfLmlzTnVtYmVyIH0pLCBfLmNvbnN0YW50KCdtYXRjaGVzIEInKV0sCiAgICAgKiAgIFtfLnN0dWJUcnVlLCAgICAgICAgICAgICAgICAgICAgICBfLmNvbnN0YW50KCdubyBtYXRjaCcpXQogICAgICogXSk7CiAgICAgKgogICAgICogZnVuYyh7ICdhJzogMSwgJ2InOiAyIH0pOwogICAgICogLy8gPT4gJ21hdGNoZXMgQScKICAgICAqCiAgICAgKiBmdW5jKHsgJ2EnOiAwLCAnYic6IDEgfSk7CiAgICAgKiAvLyA9PiAnbWF0Y2hlcyBCJwogICAgICoKICAgICAqIGZ1bmMoeyAnYSc6ICcxJywgJ2InOiAnMicgfSk7CiAgICAgKiAvLyA9PiAnbm8gbWF0Y2gnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbmQocGFpcnMpIHsKICAgICAgdmFyIGxlbmd0aCA9IHBhaXJzID09IG51bGwgPyAwIDogcGFpcnMubGVuZ3RoLAogICAgICAgICAgdG9JdGVyYXRlZSA9IGdldEl0ZXJhdGVlKCk7CgogICAgICBwYWlycyA9ICFsZW5ndGggPyBbXSA6IGFycmF5TWFwKHBhaXJzLCBmdW5jdGlvbihwYWlyKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwYWlyWzFdICE9ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoRlVOQ19FUlJPUl9URVhUKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFt0b0l0ZXJhdGVlKHBhaXJbMF0pLCBwYWlyWzFdXTsKICAgICAgfSk7CgogICAgICByZXR1cm4gYmFzZVJlc3QoZnVuY3Rpb24oYXJncykgewogICAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIgcGFpciA9IHBhaXJzW2luZGV4XTsKICAgICAgICAgIGlmIChhcHBseShwYWlyWzBdLCB0aGlzLCBhcmdzKSkgewogICAgICAgICAgICByZXR1cm4gYXBwbHkocGFpclsxXSwgdGhpcywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGludm9rZXMgdGhlIHByZWRpY2F0ZSBwcm9wZXJ0aWVzIG9mIGBzb3VyY2VgIHdpdGgKICAgICAqIHRoZSBjb3JyZXNwb25kaW5nIHByb3BlcnR5IHZhbHVlcyBvZiBhIGdpdmVuIG9iamVjdCwgcmV0dXJuaW5nIGB0cnVlYCBpZgogICAgICogYWxsIHByZWRpY2F0ZXMgcmV0dXJuIHRydXRoeSwgZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGUgY3JlYXRlZCBmdW5jdGlvbiBpcyBlcXVpdmFsZW50IHRvIGBfLmNvbmZvcm1zVG9gIHdpdGgKICAgICAqIGBzb3VyY2VgIHBhcnRpYWxseSBhcHBsaWVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBvYmplY3Qgb2YgcHJvcGVydHkgcHJlZGljYXRlcyB0byBjb25mb3JtIHRvLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgc3BlYyBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdHMgPSBbCiAgICAgKiAgIHsgJ2EnOiAyLCAnYic6IDEgfSwKICAgICAqICAgeyAnYSc6IDEsICdiJzogMiB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uZmlsdGVyKG9iamVjdHMsIF8uY29uZm9ybXMoeyAnYic6IGZ1bmN0aW9uKG4pIHsgcmV0dXJuIG4gPiAxOyB9IH0pKTsKICAgICAqIC8vID0+IFt7ICdhJzogMSwgJ2InOiAyIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbmZvcm1zKHNvdXJjZSkgewogICAgICByZXR1cm4gYmFzZUNvbmZvcm1zKGJhc2VDbG9uZShzb3VyY2UsIENMT05FX0RFRVBfRkxBRykpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBgdmFsdWVgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMi40LjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byByZXR1cm4gZnJvbSB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY29uc3RhbnQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3RzID0gXy50aW1lcygyLCBfLmNvbnN0YW50KHsgJ2EnOiAxIH0pKTsKICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhvYmplY3RzKTsKICAgICAqIC8vID0+IFt7ICdhJzogMSB9LCB7ICdhJzogMSB9XQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKG9iamVjdHNbMF0gPT09IG9iamVjdHNbMV0pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBjb25zdGFudCh2YWx1ZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGB2YWx1ZWAgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgYSBkZWZhdWx0IHZhbHVlIHNob3VsZCBiZSByZXR1cm5lZCBpbgogICAgICogaXRzIHBsYWNlLiBUaGUgYGRlZmF1bHRWYWx1ZWAgaXMgcmV0dXJuZWQgaWYgYHZhbHVlYCBpcyBgTmFOYCwgYG51bGxgLAogICAgICogb3IgYHVuZGVmaW5lZGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSA0LjE0LjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEBwYXJhbSB7Kn0gZGVmYXVsdFZhbHVlIFRoZSBkZWZhdWx0IHZhbHVlLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmRlZmF1bHRUbygxLCAxMCk7CiAgICAgKiAvLyA9PiAxCiAgICAgKgogICAgICogXy5kZWZhdWx0VG8odW5kZWZpbmVkLCAxMCk7CiAgICAgKiAvLyA9PiAxMAogICAgICovCiAgICBmdW5jdGlvbiBkZWZhdWx0VG8odmFsdWUsIGRlZmF1bHRWYWx1ZSkgewogICAgICByZXR1cm4gKHZhbHVlID09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlKSA/IGRlZmF1bHRWYWx1ZSA6IHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgcmVzdWx0IG9mIGludm9raW5nIHRoZSBnaXZlbiBmdW5jdGlvbnMKICAgICAqIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLCB3aGVyZSBlYWNoIHN1Y2Nlc3NpdmUKICAgICAqIGludm9jYXRpb24gaXMgc3VwcGxpZWQgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgcHJldmlvdXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7Li4uKEZ1bmN0aW9ufEZ1bmN0aW9uW10pfSBbZnVuY3NdIFRoZSBmdW5jdGlvbnMgdG8gaW52b2tlLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY29tcG9zaXRlIGZ1bmN0aW9uLgogICAgICogQHNlZSBfLmZsb3dSaWdodAogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBzcXVhcmUobikgewogICAgICogICByZXR1cm4gbiAqIG47CiAgICAgKiB9CiAgICAgKgogICAgICogdmFyIGFkZFNxdWFyZSA9IF8uZmxvdyhbXy5hZGQsIHNxdWFyZV0pOwogICAgICogYWRkU3F1YXJlKDEsIDIpOwogICAgICogLy8gPT4gOQogICAgICovCiAgICB2YXIgZmxvdyA9IGNyZWF0ZUZsb3coKTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZmxvd2AgZXhjZXB0IHRoYXQgaXQgY3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQKICAgICAqIGludm9rZXMgdGhlIGdpdmVuIGZ1bmN0aW9ucyBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQHNpbmNlIDMuMC4wCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7Li4uKEZ1bmN0aW9ufEZ1bmN0aW9uW10pfSBbZnVuY3NdIFRoZSBmdW5jdGlvbnMgdG8gaW52b2tlLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY29tcG9zaXRlIGZ1bmN0aW9uLgogICAgICogQHNlZSBfLmZsb3cKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gc3F1YXJlKG4pIHsKICAgICAqICAgcmV0dXJuIG4gKiBuOwogICAgICogfQogICAgICoKICAgICAqIHZhciBhZGRTcXVhcmUgPSBfLmZsb3dSaWdodChbc3F1YXJlLCBfLmFkZF0pOwogICAgICogYWRkU3F1YXJlKDEsIDIpOwogICAgICogLy8gPT4gOQogICAgICovCiAgICB2YXIgZmxvd1JpZ2h0ID0gY3JlYXRlRmxvdyh0cnVlKTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIHJldHVybnMgdGhlIGZpcnN0IGFyZ3VtZW50IGl0IHJlY2VpdmVzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIEFueSB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICdhJzogMSB9OwogICAgICoKICAgICAqIGNvbnNvbGUubG9nKF8uaWRlbnRpdHkob2JqZWN0KSA9PT0gb2JqZWN0KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaWRlbnRpdHkodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgaW52b2tlcyBgZnVuY2Agd2l0aCB0aGUgYXJndW1lbnRzIG9mIHRoZSBjcmVhdGVkCiAgICAgKiBmdW5jdGlvbi4gSWYgYGZ1bmNgIGlzIGEgcHJvcGVydHkgbmFtZSwgdGhlIGNyZWF0ZWQgZnVuY3Rpb24gcmV0dXJucyB0aGUKICAgICAqIHByb3BlcnR5IHZhbHVlIGZvciBhIGdpdmVuIGVsZW1lbnQuIElmIGBmdW5jYCBpcyBhbiBhcnJheSBvciBvYmplY3QsIHRoZQogICAgICogY3JlYXRlZCBmdW5jdGlvbiByZXR1cm5zIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBjb250YWluIHRoZSBlcXVpdmFsZW50CiAgICAgKiBzb3VyY2UgcHJvcGVydGllcywgb3RoZXJ3aXNlIGl0IHJldHVybnMgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHBhcmFtIHsqfSBbZnVuYz1fLmlkZW50aXR5XSBUaGUgdmFsdWUgdG8gY29udmVydCB0byBhIGNhbGxiYWNrLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBjYWxsYmFjay4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHVzZXJzID0gWwogICAgICogICB7ICd1c2VyJzogJ2Jhcm5leScsICdhZ2UnOiAzNiwgJ2FjdGl2ZSc6IHRydWUgfSwKICAgICAqICAgeyAndXNlcic6ICdmcmVkJywgICAnYWdlJzogNDAsICdhY3RpdmUnOiBmYWxzZSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIFRoZSBgXy5tYXRjaGVzYCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbHRlcih1c2VycywgXy5pdGVyYXRlZSh7ICd1c2VyJzogJ2Jhcm5leScsICdhY3RpdmUnOiB0cnVlIH0pKTsKICAgICAqIC8vID0+IFt7ICd1c2VyJzogJ2Jhcm5leScsICdhZ2UnOiAzNiwgJ2FjdGl2ZSc6IHRydWUgfV0KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ubWF0Y2hlc1Byb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLmZpbHRlcih1c2VycywgXy5pdGVyYXRlZShbJ3VzZXInLCAnZnJlZCddKSk7CiAgICAgKiAvLyA9PiBbeyAndXNlcic6ICdmcmVkJywgJ2FnZSc6IDQwIH1dCiAgICAgKgogICAgICogLy8gVGhlIGBfLnByb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLm1hcCh1c2VycywgXy5pdGVyYXRlZSgndXNlcicpKTsKICAgICAqIC8vID0+IFsnYmFybmV5JywgJ2ZyZWQnXQogICAgICoKICAgICAqIC8vIENyZWF0ZSBjdXN0b20gaXRlcmF0ZWUgc2hvcnRoYW5kcy4KICAgICAqIF8uaXRlcmF0ZWUgPSBfLndyYXAoXy5pdGVyYXRlZSwgZnVuY3Rpb24oaXRlcmF0ZWUsIGZ1bmMpIHsKICAgICAqICAgcmV0dXJuICFfLmlzUmVnRXhwKGZ1bmMpID8gaXRlcmF0ZWUoZnVuYykgOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAqICAgICByZXR1cm4gZnVuYy50ZXN0KHN0cmluZyk7CiAgICAgKiAgIH07CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBfLmZpbHRlcihbJ2FiYycsICdkZWYnXSwgL2VmLyk7CiAgICAgKiAvLyA9PiBbJ2RlZiddCiAgICAgKi8KICAgIGZ1bmN0aW9uIGl0ZXJhdGVlKGZ1bmMpIHsKICAgICAgcmV0dXJuIGJhc2VJdGVyYXRlZSh0eXBlb2YgZnVuYyA9PSAnZnVuY3Rpb24nID8gZnVuYyA6IGJhc2VDbG9uZShmdW5jLCBDTE9ORV9ERUVQX0ZMQUcpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIGEgcGFydGlhbCBkZWVwIGNvbXBhcmlzb24gYmV0d2VlbiBhIGdpdmVuCiAgICAgKiBvYmplY3QgYW5kIGBzb3VyY2VgLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBnaXZlbiBvYmplY3QgaGFzIGVxdWl2YWxlbnQKICAgICAqIHByb3BlcnR5IHZhbHVlcywgZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqICoqTm90ZToqKiBUaGUgY3JlYXRlZCBmdW5jdGlvbiBpcyBlcXVpdmFsZW50IHRvIGBfLmlzTWF0Y2hgIHdpdGggYHNvdXJjZWAKICAgICAqIHBhcnRpYWxseSBhcHBsaWVkLgogICAgICoKICAgICAqIFBhcnRpYWwgY29tcGFyaXNvbnMgd2lsbCBtYXRjaCBlbXB0eSBhcnJheSBhbmQgZW1wdHkgb2JqZWN0IGBzb3VyY2VgCiAgICAgKiB2YWx1ZXMgYWdhaW5zdCBhbnkgYXJyYXkgb3Igb2JqZWN0IHZhbHVlLCByZXNwZWN0aXZlbHkuIFNlZSBgXy5pc0VxdWFsYAogICAgICogZm9yIGEgbGlzdCBvZiBzdXBwb3J0ZWQgdmFsdWUgY29tcGFyaXNvbnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UgVGhlIG9iamVjdCBvZiBwcm9wZXJ0eSB2YWx1ZXMgdG8gbWF0Y2guCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBzcGVjIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0cyA9IFsKICAgICAqICAgeyAnYSc6IDEsICdiJzogMiwgJ2MnOiAzIH0sCiAgICAgKiAgIHsgJ2EnOiA0LCAnYic6IDUsICdjJzogNiB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uZmlsdGVyKG9iamVjdHMsIF8ubWF0Y2hlcyh7ICdhJzogNCwgJ2MnOiA2IH0pKTsKICAgICAqIC8vID0+IFt7ICdhJzogNCwgJ2InOiA1LCAnYyc6IDYgfV0KICAgICAqLwogICAgZnVuY3Rpb24gbWF0Y2hlcyhzb3VyY2UpIHsKICAgICAgcmV0dXJuIGJhc2VNYXRjaGVzKGJhc2VDbG9uZShzb3VyY2UsIENMT05FX0RFRVBfRkxBRykpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgYSBwYXJ0aWFsIGRlZXAgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZQogICAgICogdmFsdWUgYXQgYHBhdGhgIG9mIGEgZ2l2ZW4gb2JqZWN0IHRvIGBzcmNWYWx1ZWAsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlCiAgICAgKiBvYmplY3QgdmFsdWUgaXMgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqICoqTm90ZToqKiBQYXJ0aWFsIGNvbXBhcmlzb25zIHdpbGwgbWF0Y2ggZW1wdHkgYXJyYXkgYW5kIGVtcHR5IG9iamVjdAogICAgICogYHNyY1ZhbHVlYCB2YWx1ZXMgYWdhaW5zdCBhbnkgYXJyYXkgb3Igb2JqZWN0IHZhbHVlLCByZXNwZWN0aXZlbHkuIFNlZQogICAgICogYF8uaXNFcXVhbGAgZm9yIGEgbGlzdCBvZiBzdXBwb3J0ZWQgdmFsdWUgY29tcGFyaXNvbnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjIuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBwYXRoIFRoZSBwYXRoIG9mIHRoZSBwcm9wZXJ0eSB0byBnZXQuCiAgICAgKiBAcGFyYW0geyp9IHNyY1ZhbHVlIFRoZSB2YWx1ZSB0byBtYXRjaC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHNwZWMgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3RzID0gWwogICAgICogICB7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwKICAgICAqICAgeyAnYSc6IDQsICdiJzogNSwgJ2MnOiA2IH0KICAgICAqIF07CiAgICAgKgogICAgICogXy5maW5kKG9iamVjdHMsIF8ubWF0Y2hlc1Byb3BlcnR5KCdhJywgNCkpOwogICAgICogLy8gPT4geyAnYSc6IDQsICdiJzogNSwgJ2MnOiA2IH0KICAgICAqLwogICAgZnVuY3Rpb24gbWF0Y2hlc1Byb3BlcnR5KHBhdGgsIHNyY1ZhbHVlKSB7CiAgICAgIHJldHVybiBiYXNlTWF0Y2hlc1Byb3BlcnR5KHBhdGgsIGJhc2VDbG9uZShzcmNWYWx1ZSwgQ0xPTkVfREVFUF9GTEFHKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpbnZva2VzIHRoZSBtZXRob2QgYXQgYHBhdGhgIG9mIGEgZ2l2ZW4gb2JqZWN0LgogICAgICogQW55IGFkZGl0aW9uYWwgYXJndW1lbnRzIGFyZSBwcm92aWRlZCB0byB0aGUgaW52b2tlZCBtZXRob2QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjcuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBwYXRoIFRoZSBwYXRoIG9mIHRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnc10gVGhlIGFyZ3VtZW50cyB0byBpbnZva2UgdGhlIG1ldGhvZCB3aXRoLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgaW52b2tlciBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdHMgPSBbCiAgICAgKiAgIHsgJ2EnOiB7ICdiJzogXy5jb25zdGFudCgyKSB9IH0sCiAgICAgKiAgIHsgJ2EnOiB7ICdiJzogXy5jb25zdGFudCgxKSB9IH0KICAgICAqIF07CiAgICAgKgogICAgICogXy5tYXAob2JqZWN0cywgXy5tZXRob2QoJ2EuYicpKTsKICAgICAqIC8vID0+IFsyLCAxXQogICAgICoKICAgICAqIF8ubWFwKG9iamVjdHMsIF8ubWV0aG9kKFsnYScsICdiJ10pKTsKICAgICAqIC8vID0+IFsyLCAxXQogICAgICovCiAgICB2YXIgbWV0aG9kID0gYmFzZVJlc3QoZnVuY3Rpb24ocGF0aCwgYXJncykgewogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGJhc2VJbnZva2Uob2JqZWN0LCBwYXRoLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVGhlIG9wcG9zaXRlIG9mIGBfLm1ldGhvZGA7IHRoaXMgbWV0aG9kIGNyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGludm9rZXMKICAgICAqIHRoZSBtZXRob2QgYXQgYSBnaXZlbiBwYXRoIG9mIGBvYmplY3RgLiBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgYXJlCiAgICAgKiBwcm92aWRlZCB0byB0aGUgaW52b2tlZCBtZXRob2QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjcuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7Li4uKn0gW2FyZ3NdIFRoZSBhcmd1bWVudHMgdG8gaW52b2tlIHRoZSBtZXRob2Qgd2l0aC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGludm9rZXIgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBhcnJheSA9IF8udGltZXMoMywgXy5jb25zdGFudCksCiAgICAgKiAgICAgb2JqZWN0ID0geyAnYSc6IGFycmF5LCAnYic6IGFycmF5LCAnYyc6IGFycmF5IH07CiAgICAgKgogICAgICogXy5tYXAoWydhWzJdJywgJ2NbMF0nXSwgXy5tZXRob2RPZihvYmplY3QpKTsKICAgICAqIC8vID0+IFsyLCAwXQogICAgICoKICAgICAqIF8ubWFwKFtbJ2EnLCAnMiddLCBbJ2MnLCAnMCddXSwgXy5tZXRob2RPZihvYmplY3QpKTsKICAgICAqIC8vID0+IFsyLCAwXQogICAgICovCiAgICB2YXIgbWV0aG9kT2YgPSBiYXNlUmVzdChmdW5jdGlvbihvYmplY3QsIGFyZ3MpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICByZXR1cm4gYmFzZUludm9rZShvYmplY3QsIHBhdGgsIGFyZ3MpOwogICAgICB9OwogICAgfSk7CgogICAgLyoqCiAgICAgKiBBZGRzIGFsbCBvd24gZW51bWVyYWJsZSBzdHJpbmcga2V5ZWQgZnVuY3Rpb24gcHJvcGVydGllcyBvZiBhIHNvdXJjZQogICAgICogb2JqZWN0IHRvIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuIElmIGBvYmplY3RgIGlzIGEgZnVuY3Rpb24sIHRoZW4gbWV0aG9kcwogICAgICogYXJlIGFkZGVkIHRvIGl0cyBwcm90b3R5cGUgYXMgd2VsbC4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogVXNlIGBfLnJ1bkluQ29udGV4dGAgdG8gY3JlYXRlIGEgcHJpc3RpbmUgYGxvZGFzaGAgZnVuY3Rpb24gdG8KICAgICAqIGF2b2lkIGNvbmZsaWN0cyBjYXVzZWQgYnkgbW9kaWZ5aW5nIHRoZSBvcmlnaW5hbC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R9IFtvYmplY3Q9bG9kYXNoXSBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IG9mIGZ1bmN0aW9ucyB0byBhZGQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dIFRoZSBvcHRpb25zIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMuY2hhaW49dHJ1ZV0gU3BlY2lmeSB3aGV0aGVyIG1peGlucyBhcmUgY2hhaW5hYmxlLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufE9iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gdm93ZWxzKHN0cmluZykgewogICAgICogICByZXR1cm4gXy5maWx0ZXIoc3RyaW5nLCBmdW5jdGlvbih2KSB7CiAgICAgKiAgICAgcmV0dXJuIC9bYWVpb3VdL2kudGVzdCh2KTsKICAgICAqICAgfSk7CiAgICAgKiB9CiAgICAgKgogICAgICogXy5taXhpbih7ICd2b3dlbHMnOiB2b3dlbHMgfSk7CiAgICAgKiBfLnZvd2VscygnZnJlZCcpOwogICAgICogLy8gPT4gWydlJ10KICAgICAqCiAgICAgKiBfKCdmcmVkJykudm93ZWxzKCkudmFsdWUoKTsKICAgICAqIC8vID0+IFsnZSddCiAgICAgKgogICAgICogXy5taXhpbih7ICd2b3dlbHMnOiB2b3dlbHMgfSwgeyAnY2hhaW4nOiBmYWxzZSB9KTsKICAgICAqIF8oJ2ZyZWQnKS52b3dlbHMoKTsKICAgICAqIC8vID0+IFsnZSddCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1peGluKG9iamVjdCwgc291cmNlLCBvcHRpb25zKSB7CiAgICAgIHZhciBwcm9wcyA9IGtleXMoc291cmNlKSwKICAgICAgICAgIG1ldGhvZE5hbWVzID0gYmFzZUZ1bmN0aW9ucyhzb3VyY2UsIHByb3BzKTsKCiAgICAgIGlmIChvcHRpb25zID09IG51bGwgJiYKICAgICAgICAgICEoaXNPYmplY3Qoc291cmNlKSAmJiAobWV0aG9kTmFtZXMubGVuZ3RoIHx8ICFwcm9wcy5sZW5ndGgpKSkgewogICAgICAgIG9wdGlvbnMgPSBzb3VyY2U7CiAgICAgICAgc291cmNlID0gb2JqZWN0OwogICAgICAgIG9iamVjdCA9IHRoaXM7CiAgICAgICAgbWV0aG9kTmFtZXMgPSBiYXNlRnVuY3Rpb25zKHNvdXJjZSwga2V5cyhzb3VyY2UpKTsKICAgICAgfQogICAgICB2YXIgY2hhaW4gPSAhKGlzT2JqZWN0KG9wdGlvbnMpICYmICdjaGFpbicgaW4gb3B0aW9ucykgfHwgISFvcHRpb25zLmNoYWluLAogICAgICAgICAgaXNGdW5jID0gaXNGdW5jdGlvbihvYmplY3QpOwoKICAgICAgYXJyYXlFYWNoKG1ldGhvZE5hbWVzLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgICAgdmFyIGZ1bmMgPSBzb3VyY2VbbWV0aG9kTmFtZV07CiAgICAgICAgb2JqZWN0W21ldGhvZE5hbWVdID0gZnVuYzsKICAgICAgICBpZiAoaXNGdW5jKSB7CiAgICAgICAgICBvYmplY3QucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjaGFpbkFsbCA9IHRoaXMuX19jaGFpbl9fOwogICAgICAgICAgICBpZiAoY2hhaW4gfHwgY2hhaW5BbGwpIHsKICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gb2JqZWN0KHRoaXMuX193cmFwcGVkX18pLAogICAgICAgICAgICAgICAgICBhY3Rpb25zID0gcmVzdWx0Ll9fYWN0aW9uc19fID0gY29weUFycmF5KHRoaXMuX19hY3Rpb25zX18pOwoKICAgICAgICAgICAgICBhY3Rpb25zLnB1c2goeyAnZnVuYyc6IGZ1bmMsICdhcmdzJzogYXJndW1lbnRzLCAndGhpc0FyZyc6IG9iamVjdCB9KTsKICAgICAgICAgICAgICByZXN1bHQuX19jaGFpbl9fID0gY2hhaW5BbGw7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnVuYy5hcHBseShvYmplY3QsIGFycmF5UHVzaChbdGhpcy52YWx1ZSgpXSwgYXJndW1lbnRzKSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qKgogICAgICogUmV2ZXJ0cyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cyBwcmV2aW91cyB2YWx1ZSBhbmQgcmV0dXJucyBhIHJlZmVyZW5jZSB0bwogICAgICogdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgbG9kYXNoID0gXy5ub0NvbmZsaWN0KCk7CiAgICAgKi8KICAgIGZ1bmN0aW9uIG5vQ29uZmxpY3QoKSB7CiAgICAgIGlmIChyb290Ll8gPT09IHRoaXMpIHsKICAgICAgICByb290Ll8gPSBvbGREYXNoOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgcmV0dXJucyBgdW5kZWZpbmVkYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDIuMy4wCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnRpbWVzKDIsIF8ubm9vcCk7CiAgICAgKiAvLyA9PiBbdW5kZWZpbmVkLCB1bmRlZmluZWRdCiAgICAgKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICAgIC8vIE5vIG9wZXJhdGlvbiBwZXJmb3JtZWQuCiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBnZXRzIHRoZSBhcmd1bWVudCBhdCBpbmRleCBgbmAuIElmIGBuYCBpcyBuZWdhdGl2ZSwKICAgICAqIHRoZSBudGggYXJndW1lbnQgZnJvbSB0aGUgZW5kIGlzIHJldHVybmVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW249MF0gVGhlIGluZGV4IG9mIHRoZSBhcmd1bWVudCB0byByZXR1cm4uCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXNzLXRocnUgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBmdW5jID0gXy5udGhBcmcoMSk7CiAgICAgKiBmdW5jKCdhJywgJ2InLCAnYycsICdkJyk7CiAgICAgKiAvLyA9PiAnYicKICAgICAqCiAgICAgKiB2YXIgZnVuYyA9IF8ubnRoQXJnKC0yKTsKICAgICAqIGZ1bmMoJ2EnLCAnYicsICdjJywgJ2QnKTsKICAgICAqIC8vID0+ICdjJwogICAgICovCiAgICBmdW5jdGlvbiBudGhBcmcobikgewogICAgICBuID0gdG9JbnRlZ2VyKG4pOwogICAgICByZXR1cm4gYmFzZVJlc3QoZnVuY3Rpb24oYXJncykgewogICAgICAgIHJldHVybiBiYXNlTnRoKGFyZ3MsIG4pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGludm9rZXMgYGl0ZXJhdGVlc2Agd2l0aCB0aGUgYXJndW1lbnRzIGl0IHJlY2VpdmVzCiAgICAgKiBhbmQgcmV0dXJucyB0aGVpciByZXN1bHRzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0gey4uLihGdW5jdGlvbnxGdW5jdGlvbltdKX0gW2l0ZXJhdGVlcz1bXy5pZGVudGl0eV1dCiAgICAgKiAgVGhlIGl0ZXJhdGVlcyB0byBpbnZva2UuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBfLm92ZXIoW01hdGgubWF4LCBNYXRoLm1pbl0pOwogICAgICoKICAgICAqIGZ1bmMoMSwgMiwgMywgNCk7CiAgICAgKiAvLyA9PiBbNCwgMV0KICAgICAqLwogICAgdmFyIG92ZXIgPSBjcmVhdGVPdmVyKGFycmF5TWFwKTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGNoZWNrcyBpZiAqKmFsbCoqIG9mIHRoZSBgcHJlZGljYXRlc2AgcmV0dXJuCiAgICAgKiB0cnV0aHkgd2hlbiBpbnZva2VkIHdpdGggdGhlIGFyZ3VtZW50cyBpdCByZWNlaXZlcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHBhcmFtIHsuLi4oRnVuY3Rpb258RnVuY3Rpb25bXSl9IFtwcmVkaWNhdGVzPVtfLmlkZW50aXR5XV0KICAgICAqICBUaGUgcHJlZGljYXRlcyB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgZnVuYyA9IF8ub3ZlckV2ZXJ5KFtCb29sZWFuLCBpc0Zpbml0ZV0pOwogICAgICoKICAgICAqIGZ1bmMoJzEnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBmdW5jKG51bGwpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBmdW5jKE5hTik7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICB2YXIgb3ZlckV2ZXJ5ID0gY3JlYXRlT3ZlcihhcnJheUV2ZXJ5KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGNoZWNrcyBpZiAqKmFueSoqIG9mIHRoZSBgcHJlZGljYXRlc2AgcmV0dXJuCiAgICAgKiB0cnV0aHkgd2hlbiBpbnZva2VkIHdpdGggdGhlIGFyZ3VtZW50cyBpdCByZWNlaXZlcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHBhcmFtIHsuLi4oRnVuY3Rpb258RnVuY3Rpb25bXSl9IFtwcmVkaWNhdGVzPVtfLmlkZW50aXR5XV0KICAgICAqICBUaGUgcHJlZGljYXRlcyB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgZnVuYyA9IF8ub3ZlclNvbWUoW0Jvb2xlYW4sIGlzRmluaXRlXSk7CiAgICAgKgogICAgICogZnVuYygnMScpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIGZ1bmMobnVsbCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogZnVuYyhOYU4pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgdmFyIG92ZXJTb21lID0gY3JlYXRlT3ZlcihhcnJheVNvbWUpOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgdmFsdWUgYXQgYHBhdGhgIG9mIGEgZ2l2ZW4gb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMi40LjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgcHJvcGVydHkgdG8gZ2V0LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgYWNjZXNzb3IgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3RzID0gWwogICAgICogICB7ICdhJzogeyAnYic6IDIgfSB9LAogICAgICogICB7ICdhJzogeyAnYic6IDEgfSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8ubWFwKG9iamVjdHMsIF8ucHJvcGVydHkoJ2EuYicpKTsKICAgICAqIC8vID0+IFsyLCAxXQogICAgICoKICAgICAqIF8ubWFwKF8uc29ydEJ5KG9iamVjdHMsIF8ucHJvcGVydHkoWydhJywgJ2InXSkpLCAnYS5iJyk7CiAgICAgKiAvLyA9PiBbMSwgMl0KICAgICAqLwogICAgZnVuY3Rpb24gcHJvcGVydHkocGF0aCkgewogICAgICByZXR1cm4gaXNLZXkocGF0aCkgPyBiYXNlUHJvcGVydHkodG9LZXkocGF0aCkpIDogYmFzZVByb3BlcnR5RGVlcChwYXRoKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5wcm9wZXJ0eWA7IHRoaXMgbWV0aG9kIGNyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMKICAgICAqIHRoZSB2YWx1ZSBhdCBhIGdpdmVuIHBhdGggb2YgYG9iamVjdGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBzaW5jZSAzLjAuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGFjY2Vzc29yIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMCwgMSwgMl0sCiAgICAgKiAgICAgb2JqZWN0ID0geyAnYSc6IGFycmF5LCAnYic6IGFycmF5LCAnYyc6IGFycmF5IH07CiAgICAgKgogICAgICogXy5tYXAoWydhWzJdJywgJ2NbMF0nXSwgXy5wcm9wZXJ0eU9mKG9iamVjdCkpOwogICAgICogLy8gPT4gWzIsIDBdCiAgICAgKgogICAgICogXy5tYXAoW1snYScsICcyJ10sIFsnYycsICcwJ11dLCBfLnByb3BlcnR5T2Yob2JqZWN0KSk7CiAgICAgKiAvLyA9PiBbMiwgMF0KICAgICAqLwogICAgZnVuY3Rpb24gcHJvcGVydHlPZihvYmplY3QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICByZXR1cm4gb2JqZWN0ID09IG51bGwgPyB1bmRlZmluZWQgOiBiYXNlR2V0KG9iamVjdCwgcGF0aCk7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIG51bWJlcnMgKHBvc2l0aXZlIGFuZC9vciBuZWdhdGl2ZSkgcHJvZ3Jlc3NpbmcgZnJvbQogICAgICogYHN0YXJ0YCB1cCB0bywgYnV0IG5vdCBpbmNsdWRpbmcsIGBlbmRgLiBBIHN0ZXAgb2YgYC0xYCBpcyB1c2VkIGlmIGEgbmVnYXRpdmUKICAgICAqIGBzdGFydGAgaXMgc3BlY2lmaWVkIHdpdGhvdXQgYW4gYGVuZGAgb3IgYHN0ZXBgLiBJZiBgZW5kYCBpcyBub3Qgc3BlY2lmaWVkLAogICAgICogaXQncyBzZXQgdG8gYHN0YXJ0YCB3aXRoIGBzdGFydGAgdGhlbiBzZXQgdG8gYDBgLgogICAgICoKICAgICAqICoqTm90ZToqKiBKYXZhU2NyaXB0IGZvbGxvd3MgdGhlIElFRUUtNzU0IHN0YW5kYXJkIGZvciByZXNvbHZpbmcKICAgICAqIGZsb2F0aW5nLXBvaW50IHZhbHVlcyB3aGljaCBjYW4gcHJvZHVjZSB1bmV4cGVjdGVkIHJlc3VsdHMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnQ9MF0gVGhlIHN0YXJ0IG9mIHRoZSByYW5nZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgVGhlIGVuZCBvZiB0aGUgcmFuZ2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3N0ZXA9MV0gVGhlIHZhbHVlIHRvIGluY3JlbWVudCBvciBkZWNyZW1lbnQgYnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIHJhbmdlIG9mIG51bWJlcnMuCiAgICAgKiBAc2VlIF8uaW5SYW5nZSwgXy5yYW5nZVJpZ2h0CiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucmFuZ2UoNCk7CiAgICAgKiAvLyA9PiBbMCwgMSwgMiwgM10KICAgICAqCiAgICAgKiBfLnJhbmdlKC00KTsKICAgICAqIC8vID0+IFswLCAtMSwgLTIsIC0zXQogICAgICoKICAgICAqIF8ucmFuZ2UoMSwgNSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgNF0KICAgICAqCiAgICAgKiBfLnJhbmdlKDAsIDIwLCA1KTsKICAgICAqIC8vID0+IFswLCA1LCAxMCwgMTVdCiAgICAgKgogICAgICogXy5yYW5nZSgwLCAtNCwgLTEpOwogICAgICogLy8gPT4gWzAsIC0xLCAtMiwgLTNdCiAgICAgKgogICAgICogXy5yYW5nZSgxLCA0LCAwKTsKICAgICAqIC8vID0+IFsxLCAxLCAxXQogICAgICoKICAgICAqIF8ucmFuZ2UoMCk7CiAgICAgKiAvLyA9PiBbXQogICAgICovCiAgICB2YXIgcmFuZ2UgPSBjcmVhdGVSYW5nZSgpOwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5yYW5nZWAgZXhjZXB0IHRoYXQgaXQgcG9wdWxhdGVzIHZhbHVlcyBpbgogICAgICogZGVzY2VuZGluZyBvcmRlci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydD0wXSBUaGUgc3RhcnQgb2YgdGhlIHJhbmdlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGVuZCBUaGUgZW5kIG9mIHRoZSByYW5nZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RlcD0xXSBUaGUgdmFsdWUgdG8gaW5jcmVtZW50IG9yIGRlY3JlbWVudCBieS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgcmFuZ2Ugb2YgbnVtYmVycy4KICAgICAqIEBzZWUgXy5pblJhbmdlLCBfLnJhbmdlCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucmFuZ2VSaWdodCg0KTsKICAgICAqIC8vID0+IFszLCAyLCAxLCAwXQogICAgICoKICAgICAqIF8ucmFuZ2VSaWdodCgtNCk7CiAgICAgKiAvLyA9PiBbLTMsIC0yLCAtMSwgMF0KICAgICAqCiAgICAgKiBfLnJhbmdlUmlnaHQoMSwgNSk7CiAgICAgKiAvLyA9PiBbNCwgMywgMiwgMV0KICAgICAqCiAgICAgKiBfLnJhbmdlUmlnaHQoMCwgMjAsIDUpOwogICAgICogLy8gPT4gWzE1LCAxMCwgNSwgMF0KICAgICAqCiAgICAgKiBfLnJhbmdlUmlnaHQoMCwgLTQsIC0xKTsKICAgICAqIC8vID0+IFstMywgLTIsIC0xLCAwXQogICAgICoKICAgICAqIF8ucmFuZ2VSaWdodCgxLCA0LCAwKTsKICAgICAqIC8vID0+IFsxLCAxLCAxXQogICAgICoKICAgICAqIF8ucmFuZ2VSaWdodCgwKTsKICAgICAqIC8vID0+IFtdCiAgICAgKi8KICAgIHZhciByYW5nZVJpZ2h0ID0gY3JlYXRlUmFuZ2UodHJ1ZSk7CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCByZXR1cm5zIGEgbmV3IGVtcHR5IGFycmF5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4xMy4wCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgZW1wdHkgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBhcnJheXMgPSBfLnRpbWVzKDIsIF8uc3R1YkFycmF5KTsKICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhhcnJheXMpOwogICAgICogLy8gPT4gW1tdLCBbXV0KICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhhcnJheXNbMF0gPT09IGFycmF5c1sxXSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBzdHViQXJyYXkoKSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIHJldHVybnMgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMTMuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udGltZXMoMiwgXy5zdHViRmFsc2UpOwogICAgICogLy8gPT4gW2ZhbHNlLCBmYWxzZV0KICAgICAqLwogICAgZnVuY3Rpb24gc3R1YkZhbHNlKCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCByZXR1cm5zIGEgbmV3IGVtcHR5IG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMTMuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBlbXB0eSBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3RzID0gXy50aW1lcygyLCBfLnN0dWJPYmplY3QpOwogICAgICoKICAgICAqIGNvbnNvbGUubG9nKG9iamVjdHMpOwogICAgICogLy8gPT4gW3t9LCB7fV0KICAgICAqCiAgICAgKiBjb25zb2xlLmxvZyhvYmplY3RzWzBdID09PSBvYmplY3RzWzFdKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0dWJPYmplY3QoKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4xMy4wCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgZW1wdHkgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnRpbWVzKDIsIF8uc3R1YlN0cmluZyk7CiAgICAgKiAvLyA9PiBbJycsICcnXQogICAgICovCiAgICBmdW5jdGlvbiBzdHViU3RyaW5nKCkgewogICAgICByZXR1cm4gJyc7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCByZXR1cm5zIGB0cnVlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMTMuMAogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy50aW1lcygyLCBfLnN0dWJUcnVlKTsKICAgICAqIC8vID0+IFt0cnVlLCB0cnVlXQogICAgICovCiAgICBmdW5jdGlvbiBzdHViVHJ1ZSgpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnZva2VzIHRoZSBpdGVyYXRlZSBgbmAgdGltZXMsIHJldHVybmluZyBhbiBhcnJheSBvZiB0aGUgcmVzdWx0cyBvZgogICAgICogZWFjaCBpbnZvY2F0aW9uLiBUaGUgaXRlcmF0ZWUgaXMgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDsgKGluZGV4KS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbAogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0byBpbnZva2UgYGl0ZXJhdGVlYC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBhcnJheSBvZiByZXN1bHRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnRpbWVzKDMsIFN0cmluZyk7CiAgICAgKiAvLyA9PiBbJzAnLCAnMScsICcyJ10KICAgICAqCiAgICAgKiAgXy50aW1lcyg0LCBfLmNvbnN0YW50KDApKTsKICAgICAqIC8vID0+IFswLCAwLCAwLCAwXQogICAgICovCiAgICBmdW5jdGlvbiB0aW1lcyhuLCBpdGVyYXRlZSkgewogICAgICBuID0gdG9JbnRlZ2VyKG4pOwogICAgICBpZiAobiA8IDEgfHwgbiA+IE1BWF9TQUZFX0lOVEVHRVIpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gTUFYX0FSUkFZX0xFTkdUSCwKICAgICAgICAgIGxlbmd0aCA9IG5hdGl2ZU1pbihuLCBNQVhfQVJSQVlfTEVOR1RIKTsKCiAgICAgIGl0ZXJhdGVlID0gZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUpOwogICAgICBuIC09IE1BWF9BUlJBWV9MRU5HVEg7CgogICAgICB2YXIgcmVzdWx0ID0gYmFzZVRpbWVzKGxlbmd0aCwgaXRlcmF0ZWUpOwogICAgICB3aGlsZSAoKytpbmRleCA8IG4pIHsKICAgICAgICBpdGVyYXRlZShpbmRleCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIGB2YWx1ZWAgdG8gYSBwcm9wZXJ0eSBwYXRoIGFycmF5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBVdGlsCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb252ZXJ0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgcHJvcGVydHkgcGF0aCBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy50b1BhdGgoJ2EuYi5jJyk7CiAgICAgKiAvLyA9PiBbJ2EnLCAnYicsICdjJ10KICAgICAqCiAgICAgKiBfLnRvUGF0aCgnYVswXS5iLmMnKTsKICAgICAqIC8vID0+IFsnYScsICcwJywgJ2InLCAnYyddCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvUGF0aCh2YWx1ZSkgewogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gYXJyYXlNYXAodmFsdWUsIHRvS2V5KTsKICAgICAgfQogICAgICByZXR1cm4gaXNTeW1ib2wodmFsdWUpID8gW3ZhbHVlXSA6IGNvcHlBcnJheShzdHJpbmdUb1BhdGgodG9TdHJpbmcodmFsdWUpKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZW5lcmF0ZXMgYSB1bmlxdWUgSUQuIElmIGBwcmVmaXhgIGlzIGdpdmVuLCB0aGUgSUQgaXMgYXBwZW5kZWQgdG8gaXQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQHNpbmNlIDAuMS4wCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbcHJlZml4PScnXSBUaGUgdmFsdWUgdG8gcHJlZml4IHRoZSBJRCB3aXRoLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgdW5pcXVlIElELgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnVuaXF1ZUlkKCdjb250YWN0XycpOwogICAgICogLy8gPT4gJ2NvbnRhY3RfMTA0JwogICAgICoKICAgICAqIF8udW5pcXVlSWQoKTsKICAgICAqIC8vID0+ICcxMDUnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVuaXF1ZUlkKHByZWZpeCkgewogICAgICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICAgICAgcmV0dXJuIHRvU3RyaW5nKHByZWZpeCkgKyBpZDsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBBZGRzIHR3byBudW1iZXJzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy40LjAKICAgICAqIEBjYXRlZ29yeSBNYXRoCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYXVnZW5kIFRoZSBmaXJzdCBudW1iZXIgaW4gYW4gYWRkaXRpb24uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYWRkZW5kIFRoZSBzZWNvbmQgbnVtYmVyIGluIGFuIGFkZGl0aW9uLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgdG90YWwuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uYWRkKDYsIDQpOwogICAgICogLy8gPT4gMTAKICAgICAqLwogICAgdmFyIGFkZCA9IGNyZWF0ZU1hdGhPcGVyYXRpb24oZnVuY3Rpb24oYXVnZW5kLCBhZGRlbmQpIHsKICAgICAgcmV0dXJuIGF1Z2VuZCArIGFkZGVuZDsKICAgIH0sIDApOwoKICAgIC8qKgogICAgICogQ29tcHV0ZXMgYG51bWJlcmAgcm91bmRlZCB1cCB0byBgcHJlY2lzaW9uYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDMuMTAuMAogICAgICogQGNhdGVnb3J5IE1hdGgKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW1iZXIgVGhlIG51bWJlciB0byByb3VuZCB1cC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcHJlY2lzaW9uPTBdIFRoZSBwcmVjaXNpb24gdG8gcm91bmQgdXAgdG8uCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSByb3VuZGVkIHVwIG51bWJlci4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5jZWlsKDQuMDA2KTsKICAgICAqIC8vID0+IDUKICAgICAqCiAgICAgKiBfLmNlaWwoNi4wMDQsIDIpOwogICAgICogLy8gPT4gNi4wMQogICAgICoKICAgICAqIF8uY2VpbCg2MDQwLCAtMik7CiAgICAgKiAvLyA9PiA2MTAwCiAgICAgKi8KICAgIHZhciBjZWlsID0gY3JlYXRlUm91bmQoJ2NlaWwnKTsKCiAgICAvKioKICAgICAqIERpdmlkZSB0d28gbnVtYmVycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuNy4wCiAgICAgKiBAY2F0ZWdvcnkgTWF0aAogICAgICogQHBhcmFtIHtudW1iZXJ9IGRpdmlkZW5kIFRoZSBmaXJzdCBudW1iZXIgaW4gYSBkaXZpc2lvbi4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBkaXZpc29yIFRoZSBzZWNvbmQgbnVtYmVyIGluIGEgZGl2aXNpb24uCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBxdW90aWVudC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5kaXZpZGUoNiwgNCk7CiAgICAgKiAvLyA9PiAxLjUKICAgICAqLwogICAgdmFyIGRpdmlkZSA9IGNyZWF0ZU1hdGhPcGVyYXRpb24oZnVuY3Rpb24oZGl2aWRlbmQsIGRpdmlzb3IpIHsKICAgICAgcmV0dXJuIGRpdmlkZW5kIC8gZGl2aXNvcjsKICAgIH0sIDEpOwoKICAgIC8qKgogICAgICogQ29tcHV0ZXMgYG51bWJlcmAgcm91bmRlZCBkb3duIHRvIGBwcmVjaXNpb25gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4xMC4wCiAgICAgKiBAY2F0ZWdvcnkgTWF0aAogICAgICogQHBhcmFtIHtudW1iZXJ9IG51bWJlciBUaGUgbnVtYmVyIHRvIHJvdW5kIGRvd24uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3ByZWNpc2lvbj0wXSBUaGUgcHJlY2lzaW9uIHRvIHJvdW5kIGRvd24gdG8uCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSByb3VuZGVkIGRvd24gbnVtYmVyLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZsb29yKDQuMDA2KTsKICAgICAqIC8vID0+IDQKICAgICAqCiAgICAgKiBfLmZsb29yKDAuMDQ2LCAyKTsKICAgICAqIC8vID0+IDAuMDQKICAgICAqCiAgICAgKiBfLmZsb29yKDQwNjAsIC0yKTsKICAgICAqIC8vID0+IDQwMDAKICAgICAqLwogICAgdmFyIGZsb29yID0gY3JlYXRlUm91bmQoJ2Zsb29yJyk7CgogICAgLyoqCiAgICAgKiBDb21wdXRlcyB0aGUgbWF4aW11bSB2YWx1ZSBvZiBgYXJyYXlgLiBJZiBgYXJyYXlgIGlzIGVtcHR5IG9yIGZhbHNleSwKICAgICAqIGB1bmRlZmluZWRgIGlzIHJldHVybmVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaW5jZSAwLjEuMAogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBNYXRoCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG1heGltdW0gdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWF4KFs0LCAyLCA4LCA2XSk7CiAgICAgKiAvLyA9PiA4CiAgICAgKgogICAgICogXy5tYXgoW10pOwogICAgICogLy8gPT4gdW5kZWZpbmVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1heChhcnJheSkgewogICAgICByZXR1cm4gKGFycmF5ICYmIGFycmF5Lmxlbmd0aCkKICAgICAgICA/IGJhc2VFeHRyZW11bShhcnJheSwgaWRlbnRpdHksIGJhc2VHdCkKICAgICAgICA6IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8ubWF4YCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBpdGVyYXRlZWAgd2hpY2ggaXMKICAgICAqIGludm9rZWQgZm9yIGVhY2ggZWxlbWVudCBpbiBgYXJyYXlgIHRvIGdlbmVyYXRlIHRoZSBjcml0ZXJpb24gYnkgd2hpY2gKICAgICAqIHRoZSB2YWx1ZSBpcyByYW5rZWQuIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBNYXRoCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG1heGltdW0gdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3RzID0gW3sgJ24nOiAxIH0sIHsgJ24nOiAyIH1dOwogICAgICoKICAgICAqIF8ubWF4Qnkob2JqZWN0cywgZnVuY3Rpb24obykgeyByZXR1cm4gby5uOyB9KTsKICAgICAqIC8vID0+IHsgJ24nOiAyIH0KICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8ubWF4Qnkob2JqZWN0cywgJ24nKTsKICAgICAqIC8vID0+IHsgJ24nOiAyIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWF4QnkoYXJyYXksIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKQogICAgICAgID8gYmFzZUV4dHJlbXVtKGFycmF5LCBnZXRJdGVyYXRlZShpdGVyYXRlZSwgMiksIGJhc2VHdCkKICAgICAgICA6IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbXB1dGVzIHRoZSBtZWFuIG9mIHRoZSB2YWx1ZXMgaW4gYGFycmF5YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTWF0aAogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIG1lYW4uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWVhbihbNCwgMiwgOCwgNl0pOwogICAgICogLy8gPT4gNQogICAgICovCiAgICBmdW5jdGlvbiBtZWFuKGFycmF5KSB7CiAgICAgIHJldHVybiBiYXNlTWVhbihhcnJheSwgaWRlbnRpdHkpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5tZWFuYCBleGNlcHQgdGhhdCBpdCBhY2NlcHRzIGBpdGVyYXRlZWAgd2hpY2ggaXMKICAgICAqIGludm9rZWQgZm9yIGVhY2ggZWxlbWVudCBpbiBgYXJyYXlgIHRvIGdlbmVyYXRlIHRoZSB2YWx1ZSB0byBiZSBhdmVyYWdlZC4KICAgICAqIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC43LjAKICAgICAqIEBjYXRlZ29yeSBNYXRoCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgbWVhbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdHMgPSBbeyAnbic6IDQgfSwgeyAnbic6IDIgfSwgeyAnbic6IDggfSwgeyAnbic6IDYgfV07CiAgICAgKgogICAgICogXy5tZWFuQnkob2JqZWN0cywgZnVuY3Rpb24obykgeyByZXR1cm4gby5uOyB9KTsKICAgICAqIC8vID0+IDUKICAgICAqCiAgICAgKiAvLyBUaGUgYF8ucHJvcGVydHlgIGl0ZXJhdGVlIHNob3J0aGFuZC4KICAgICAqIF8ubWVhbkJ5KG9iamVjdHMsICduJyk7CiAgICAgKiAvLyA9PiA1CiAgICAgKi8KICAgIGZ1bmN0aW9uIG1lYW5CeShhcnJheSwgaXRlcmF0ZWUpIHsKICAgICAgcmV0dXJuIGJhc2VNZWFuKGFycmF5LCBnZXRJdGVyYXRlZShpdGVyYXRlZSwgMikpOwogICAgfQoKICAgIC8qKgogICAgICogQ29tcHV0ZXMgdGhlIG1pbmltdW0gdmFsdWUgb2YgYGFycmF5YC4gSWYgYGFycmF5YCBpcyBlbXB0eSBvciBmYWxzZXksCiAgICAgKiBgdW5kZWZpbmVkYCBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2luY2UgMC4xLjAKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgTWF0aAogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBtaW5pbXVtIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLm1pbihbNCwgMiwgOCwgNl0pOwogICAgICogLy8gPT4gMgogICAgICoKICAgICAqIF8ubWluKFtdKTsKICAgICAqIC8vID0+IHVuZGVmaW5lZAogICAgICovCiAgICBmdW5jdGlvbiBtaW4oYXJyYXkpIHsKICAgICAgcmV0dXJuIChhcnJheSAmJiBhcnJheS5sZW5ndGgpCiAgICAgICAgPyBiYXNlRXh0cmVtdW0oYXJyYXksIGlkZW50aXR5LCBiYXNlTHQpCiAgICAgICAgOiB1bmRlZmluZWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLm1pbmAgZXhjZXB0IHRoYXQgaXQgYWNjZXB0cyBgaXRlcmF0ZWVgIHdoaWNoIGlzCiAgICAgKiBpbnZva2VkIGZvciBlYWNoIGVsZW1lbnQgaW4gYGFycmF5YCB0byBnZW5lcmF0ZSB0aGUgY3JpdGVyaW9uIGJ5IHdoaWNoCiAgICAgKiB0aGUgdmFsdWUgaXMgcmFua2VkLiBUaGUgaXRlcmF0ZWUgaXMgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDogKHZhbHVlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTWF0aAogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpdGVyYXRlZT1fLmlkZW50aXR5XSBUaGUgaXRlcmF0ZWUgaW52b2tlZCBwZXIgZWxlbWVudC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBtaW5pbXVtIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0cyA9IFt7ICduJzogMSB9LCB7ICduJzogMiB9XTsKICAgICAqCiAgICAgKiBfLm1pbkJ5KG9iamVjdHMsIGZ1bmN0aW9uKG8pIHsgcmV0dXJuIG8ubjsgfSk7CiAgICAgKiAvLyA9PiB7ICduJzogMSB9CiAgICAgKgogICAgICogLy8gVGhlIGBfLnByb3BlcnR5YCBpdGVyYXRlZSBzaG9ydGhhbmQuCiAgICAgKiBfLm1pbkJ5KG9iamVjdHMsICduJyk7CiAgICAgKiAvLyA9PiB7ICduJzogMSB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIG1pbkJ5KGFycmF5LCBpdGVyYXRlZSkgewogICAgICByZXR1cm4gKGFycmF5ICYmIGFycmF5Lmxlbmd0aCkKICAgICAgICA/IGJhc2VFeHRyZW11bShhcnJheSwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDIpLCBiYXNlTHQpCiAgICAgICAgOiB1bmRlZmluZWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBNdWx0aXBseSB0d28gbnVtYmVycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuNy4wCiAgICAgKiBAY2F0ZWdvcnkgTWF0aAogICAgICogQHBhcmFtIHtudW1iZXJ9IG11bHRpcGxpZXIgVGhlIGZpcnN0IG51bWJlciBpbiBhIG11bHRpcGxpY2F0aW9uLgogICAgICogQHBhcmFtIHtudW1iZXJ9IG11bHRpcGxpY2FuZCBUaGUgc2Vjb25kIG51bWJlciBpbiBhIG11bHRpcGxpY2F0aW9uLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgcHJvZHVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5tdWx0aXBseSg2LCA0KTsKICAgICAqIC8vID0+IDI0CiAgICAgKi8KICAgIHZhciBtdWx0aXBseSA9IGNyZWF0ZU1hdGhPcGVyYXRpb24oZnVuY3Rpb24obXVsdGlwbGllciwgbXVsdGlwbGljYW5kKSB7CiAgICAgIHJldHVybiBtdWx0aXBsaWVyICogbXVsdGlwbGljYW5kOwogICAgfSwgMSk7CgogICAgLyoqCiAgICAgKiBDb21wdXRlcyBgbnVtYmVyYCByb3VuZGVkIHRvIGBwcmVjaXNpb25gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy4xMC4wCiAgICAgKiBAY2F0ZWdvcnkgTWF0aAogICAgICogQHBhcmFtIHtudW1iZXJ9IG51bWJlciBUaGUgbnVtYmVyIHRvIHJvdW5kLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwcmVjaXNpb249MF0gVGhlIHByZWNpc2lvbiB0byByb3VuZCB0by4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIHJvdW5kZWQgbnVtYmVyLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnJvdW5kKDQuMDA2KTsKICAgICAqIC8vID0+IDQKICAgICAqCiAgICAgKiBfLnJvdW5kKDQuMDA2LCAyKTsKICAgICAqIC8vID0+IDQuMDEKICAgICAqCiAgICAgKiBfLnJvdW5kKDQwNjAsIC0yKTsKICAgICAqIC8vID0+IDQxMDAKICAgICAqLwogICAgdmFyIHJvdW5kID0gY3JlYXRlUm91bmQoJ3JvdW5kJyk7CgogICAgLyoqCiAgICAgKiBTdWJ0cmFjdCB0d28gbnVtYmVycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHNpbmNlIDQuMC4wCiAgICAgKiBAY2F0ZWdvcnkgTWF0aAogICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbnVlbmQgVGhlIGZpcnN0IG51bWJlciBpbiBhIHN1YnRyYWN0aW9uLgogICAgICogQHBhcmFtIHtudW1iZXJ9IHN1YnRyYWhlbmQgVGhlIHNlY29uZCBudW1iZXIgaW4gYSBzdWJ0cmFjdGlvbi4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGRpZmZlcmVuY2UuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc3VidHJhY3QoNiwgNCk7CiAgICAgKiAvLyA9PiAyCiAgICAgKi8KICAgIHZhciBzdWJ0cmFjdCA9IGNyZWF0ZU1hdGhPcGVyYXRpb24oZnVuY3Rpb24obWludWVuZCwgc3VidHJhaGVuZCkgewogICAgICByZXR1cm4gbWludWVuZCAtIHN1YnRyYWhlbmQ7CiAgICB9LCAwKTsKCiAgICAvKioKICAgICAqIENvbXB1dGVzIHRoZSBzdW0gb2YgdGhlIHZhbHVlcyBpbiBgYXJyYXlgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgMy40LjAKICAgICAqIEBjYXRlZ29yeSBNYXRoCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgc3VtLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnN1bShbNCwgMiwgOCwgNl0pOwogICAgICogLy8gPT4gMjAKICAgICAqLwogICAgZnVuY3Rpb24gc3VtKGFycmF5KSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKQogICAgICAgID8gYmFzZVN1bShhcnJheSwgaWRlbnRpdHkpCiAgICAgICAgOiAwOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5zdW1gIGV4Y2VwdCB0aGF0IGl0IGFjY2VwdHMgYGl0ZXJhdGVlYCB3aGljaCBpcwogICAgICogaW52b2tlZCBmb3IgZWFjaCBlbGVtZW50IGluIGBhcnJheWAgdG8gZ2VuZXJhdGUgdGhlIHZhbHVlIHRvIGJlIHN1bW1lZC4KICAgICAqIFRoZSBpdGVyYXRlZSBpcyBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OiAodmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAc2luY2UgNC4wLjAKICAgICAqIEBjYXRlZ29yeSBNYXRoCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2l0ZXJhdGVlPV8uaWRlbnRpdHldIFRoZSBpdGVyYXRlZSBpbnZva2VkIHBlciBlbGVtZW50LgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgc3VtLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0cyA9IFt7ICduJzogNCB9LCB7ICduJzogMiB9LCB7ICduJzogOCB9LCB7ICduJzogNiB9XTsKICAgICAqCiAgICAgKiBfLnN1bUJ5KG9iamVjdHMsIGZ1bmN0aW9uKG8pIHsgcmV0dXJuIG8ubjsgfSk7CiAgICAgKiAvLyA9PiAyMAogICAgICoKICAgICAqIC8vIFRoZSBgXy5wcm9wZXJ0eWAgaXRlcmF0ZWUgc2hvcnRoYW5kLgogICAgICogXy5zdW1CeShvYmplY3RzLCAnbicpOwogICAgICogLy8gPT4gMjAKICAgICAqLwogICAgZnVuY3Rpb24gc3VtQnkoYXJyYXksIGl0ZXJhdGVlKSB7CiAgICAgIHJldHVybiAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKQogICAgICAgID8gYmFzZVN1bShhcnJheSwgZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDIpKQogICAgICAgIDogMDsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLy8gQWRkIG1ldGhvZHMgdGhhdCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgaW4gY2hhaW4gc2VxdWVuY2VzLgogICAgbG9kYXNoLmFmdGVyID0gYWZ0ZXI7CiAgICBsb2Rhc2guYXJ5ID0gYXJ5OwogICAgbG9kYXNoLmFzc2lnbiA9IGFzc2lnbjsKICAgIGxvZGFzaC5hc3NpZ25JbiA9IGFzc2lnbkluOwogICAgbG9kYXNoLmFzc2lnbkluV2l0aCA9IGFzc2lnbkluV2l0aDsKICAgIGxvZGFzaC5hc3NpZ25XaXRoID0gYXNzaWduV2l0aDsKICAgIGxvZGFzaC5hdCA9IGF0OwogICAgbG9kYXNoLmJlZm9yZSA9IGJlZm9yZTsKICAgIGxvZGFzaC5iaW5kID0gYmluZDsKICAgIGxvZGFzaC5iaW5kQWxsID0gYmluZEFsbDsKICAgIGxvZGFzaC5iaW5kS2V5ID0gYmluZEtleTsKICAgIGxvZGFzaC5jYXN0QXJyYXkgPSBjYXN0QXJyYXk7CiAgICBsb2Rhc2guY2hhaW4gPSBjaGFpbjsKICAgIGxvZGFzaC5jaHVuayA9IGNodW5rOwogICAgbG9kYXNoLmNvbXBhY3QgPSBjb21wYWN0OwogICAgbG9kYXNoLmNvbmNhdCA9IGNvbmNhdDsKICAgIGxvZGFzaC5jb25kID0gY29uZDsKICAgIGxvZGFzaC5jb25mb3JtcyA9IGNvbmZvcm1zOwogICAgbG9kYXNoLmNvbnN0YW50ID0gY29uc3RhbnQ7CiAgICBsb2Rhc2guY291bnRCeSA9IGNvdW50Qnk7CiAgICBsb2Rhc2guY3JlYXRlID0gY3JlYXRlOwogICAgbG9kYXNoLmN1cnJ5ID0gY3Vycnk7CiAgICBsb2Rhc2guY3VycnlSaWdodCA9IGN1cnJ5UmlnaHQ7CiAgICBsb2Rhc2guZGVib3VuY2UgPSBkZWJvdW5jZTsKICAgIGxvZGFzaC5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgbG9kYXNoLmRlZmF1bHRzRGVlcCA9IGRlZmF1bHRzRGVlcDsKICAgIGxvZGFzaC5kZWZlciA9IGRlZmVyOwogICAgbG9kYXNoLmRlbGF5ID0gZGVsYXk7CiAgICBsb2Rhc2guZGlmZmVyZW5jZSA9IGRpZmZlcmVuY2U7CiAgICBsb2Rhc2guZGlmZmVyZW5jZUJ5ID0gZGlmZmVyZW5jZUJ5OwogICAgbG9kYXNoLmRpZmZlcmVuY2VXaXRoID0gZGlmZmVyZW5jZVdpdGg7CiAgICBsb2Rhc2guZHJvcCA9IGRyb3A7CiAgICBsb2Rhc2guZHJvcFJpZ2h0ID0gZHJvcFJpZ2h0OwogICAgbG9kYXNoLmRyb3BSaWdodFdoaWxlID0gZHJvcFJpZ2h0V2hpbGU7CiAgICBsb2Rhc2guZHJvcFdoaWxlID0gZHJvcFdoaWxlOwogICAgbG9kYXNoLmZpbGwgPSBmaWxsOwogICAgbG9kYXNoLmZpbHRlciA9IGZpbHRlcjsKICAgIGxvZGFzaC5mbGF0TWFwID0gZmxhdE1hcDsKICAgIGxvZGFzaC5mbGF0TWFwRGVlcCA9IGZsYXRNYXBEZWVwOwogICAgbG9kYXNoLmZsYXRNYXBEZXB0aCA9IGZsYXRNYXBEZXB0aDsKICAgIGxvZGFzaC5mbGF0dGVuID0gZmxhdHRlbjsKICAgIGxvZGFzaC5mbGF0dGVuRGVlcCA9IGZsYXR0ZW5EZWVwOwogICAgbG9kYXNoLmZsYXR0ZW5EZXB0aCA9IGZsYXR0ZW5EZXB0aDsKICAgIGxvZGFzaC5mbGlwID0gZmxpcDsKICAgIGxvZGFzaC5mbG93ID0gZmxvdzsKICAgIGxvZGFzaC5mbG93UmlnaHQgPSBmbG93UmlnaHQ7CiAgICBsb2Rhc2guZnJvbVBhaXJzID0gZnJvbVBhaXJzOwogICAgbG9kYXNoLmZ1bmN0aW9ucyA9IGZ1bmN0aW9uczsKICAgIGxvZGFzaC5mdW5jdGlvbnNJbiA9IGZ1bmN0aW9uc0luOwogICAgbG9kYXNoLmdyb3VwQnkgPSBncm91cEJ5OwogICAgbG9kYXNoLmluaXRpYWwgPSBpbml0aWFsOwogICAgbG9kYXNoLmludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvbjsKICAgIGxvZGFzaC5pbnRlcnNlY3Rpb25CeSA9IGludGVyc2VjdGlvbkJ5OwogICAgbG9kYXNoLmludGVyc2VjdGlvbldpdGggPSBpbnRlcnNlY3Rpb25XaXRoOwogICAgbG9kYXNoLmludmVydCA9IGludmVydDsKICAgIGxvZGFzaC5pbnZlcnRCeSA9IGludmVydEJ5OwogICAgbG9kYXNoLmludm9rZU1hcCA9IGludm9rZU1hcDsKICAgIGxvZGFzaC5pdGVyYXRlZSA9IGl0ZXJhdGVlOwogICAgbG9kYXNoLmtleUJ5ID0ga2V5Qnk7CiAgICBsb2Rhc2gua2V5cyA9IGtleXM7CiAgICBsb2Rhc2gua2V5c0luID0ga2V5c0luOwogICAgbG9kYXNoLm1hcCA9IG1hcDsKICAgIGxvZGFzaC5tYXBLZXlzID0gbWFwS2V5czsKICAgIGxvZGFzaC5tYXBWYWx1ZXMgPSBtYXBWYWx1ZXM7CiAgICBsb2Rhc2gubWF0Y2hlcyA9IG1hdGNoZXM7CiAgICBsb2Rhc2gubWF0Y2hlc1Byb3BlcnR5ID0gbWF0Y2hlc1Byb3BlcnR5OwogICAgbG9kYXNoLm1lbW9pemUgPSBtZW1vaXplOwogICAgbG9kYXNoLm1lcmdlID0gbWVyZ2U7CiAgICBsb2Rhc2gubWVyZ2VXaXRoID0gbWVyZ2VXaXRoOwogICAgbG9kYXNoLm1ldGhvZCA9IG1ldGhvZDsKICAgIGxvZGFzaC5tZXRob2RPZiA9IG1ldGhvZE9mOwogICAgbG9kYXNoLm1peGluID0gbWl4aW47CiAgICBsb2Rhc2gubmVnYXRlID0gbmVnYXRlOwogICAgbG9kYXNoLm50aEFyZyA9IG50aEFyZzsKICAgIGxvZGFzaC5vbWl0ID0gb21pdDsKICAgIGxvZGFzaC5vbWl0QnkgPSBvbWl0Qnk7CiAgICBsb2Rhc2gub25jZSA9IG9uY2U7CiAgICBsb2Rhc2gub3JkZXJCeSA9IG9yZGVyQnk7CiAgICBsb2Rhc2gub3ZlciA9IG92ZXI7CiAgICBsb2Rhc2gub3ZlckFyZ3MgPSBvdmVyQXJnczsKICAgIGxvZGFzaC5vdmVyRXZlcnkgPSBvdmVyRXZlcnk7CiAgICBsb2Rhc2gub3ZlclNvbWUgPSBvdmVyU29tZTsKICAgIGxvZGFzaC5wYXJ0aWFsID0gcGFydGlhbDsKICAgIGxvZGFzaC5wYXJ0aWFsUmlnaHQgPSBwYXJ0aWFsUmlnaHQ7CiAgICBsb2Rhc2gucGFydGl0aW9uID0gcGFydGl0aW9uOwogICAgbG9kYXNoLnBpY2sgPSBwaWNrOwogICAgbG9kYXNoLnBpY2tCeSA9IHBpY2tCeTsKICAgIGxvZGFzaC5wcm9wZXJ0eSA9IHByb3BlcnR5OwogICAgbG9kYXNoLnByb3BlcnR5T2YgPSBwcm9wZXJ0eU9mOwogICAgbG9kYXNoLnB1bGwgPSBwdWxsOwogICAgbG9kYXNoLnB1bGxBbGwgPSBwdWxsQWxsOwogICAgbG9kYXNoLnB1bGxBbGxCeSA9IHB1bGxBbGxCeTsKICAgIGxvZGFzaC5wdWxsQWxsV2l0aCA9IHB1bGxBbGxXaXRoOwogICAgbG9kYXNoLnB1bGxBdCA9IHB1bGxBdDsKICAgIGxvZGFzaC5yYW5nZSA9IHJhbmdlOwogICAgbG9kYXNoLnJhbmdlUmlnaHQgPSByYW5nZVJpZ2h0OwogICAgbG9kYXNoLnJlYXJnID0gcmVhcmc7CiAgICBsb2Rhc2gucmVqZWN0ID0gcmVqZWN0OwogICAgbG9kYXNoLnJlbW92ZSA9IHJlbW92ZTsKICAgIGxvZGFzaC5yZXN0ID0gcmVzdDsKICAgIGxvZGFzaC5yZXZlcnNlID0gcmV2ZXJzZTsKICAgIGxvZGFzaC5zYW1wbGVTaXplID0gc2FtcGxlU2l6ZTsKICAgIGxvZGFzaC5zZXQgPSBzZXQ7CiAgICBsb2Rhc2guc2V0V2l0aCA9IHNldFdpdGg7CiAgICBsb2Rhc2guc2h1ZmZsZSA9IHNodWZmbGU7CiAgICBsb2Rhc2guc2xpY2UgPSBzbGljZTsKICAgIGxvZGFzaC5zb3J0QnkgPSBzb3J0Qnk7CiAgICBsb2Rhc2guc29ydGVkVW5pcSA9IHNvcnRlZFVuaXE7CiAgICBsb2Rhc2guc29ydGVkVW5pcUJ5ID0gc29ydGVkVW5pcUJ5OwogICAgbG9kYXNoLnNwbGl0ID0gc3BsaXQ7CiAgICBsb2Rhc2guc3ByZWFkID0gc3ByZWFkOwogICAgbG9kYXNoLnRhaWwgPSB0YWlsOwogICAgbG9kYXNoLnRha2UgPSB0YWtlOwogICAgbG9kYXNoLnRha2VSaWdodCA9IHRha2VSaWdodDsKICAgIGxvZGFzaC50YWtlUmlnaHRXaGlsZSA9IHRha2VSaWdodFdoaWxlOwogICAgbG9kYXNoLnRha2VXaGlsZSA9IHRha2VXaGlsZTsKICAgIGxvZGFzaC50YXAgPSB0YXA7CiAgICBsb2Rhc2gudGhyb3R0bGUgPSB0aHJvdHRsZTsKICAgIGxvZGFzaC50aHJ1ID0gdGhydTsKICAgIGxvZGFzaC50b0FycmF5ID0gdG9BcnJheTsKICAgIGxvZGFzaC50b1BhaXJzID0gdG9QYWlyczsKICAgIGxvZGFzaC50b1BhaXJzSW4gPSB0b1BhaXJzSW47CiAgICBsb2Rhc2gudG9QYXRoID0gdG9QYXRoOwogICAgbG9kYXNoLnRvUGxhaW5PYmplY3QgPSB0b1BsYWluT2JqZWN0OwogICAgbG9kYXNoLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTsKICAgIGxvZGFzaC51bmFyeSA9IHVuYXJ5OwogICAgbG9kYXNoLnVuaW9uID0gdW5pb247CiAgICBsb2Rhc2gudW5pb25CeSA9IHVuaW9uQnk7CiAgICBsb2Rhc2gudW5pb25XaXRoID0gdW5pb25XaXRoOwogICAgbG9kYXNoLnVuaXEgPSB1bmlxOwogICAgbG9kYXNoLnVuaXFCeSA9IHVuaXFCeTsKICAgIGxvZGFzaC51bmlxV2l0aCA9IHVuaXFXaXRoOwogICAgbG9kYXNoLnVuc2V0ID0gdW5zZXQ7CiAgICBsb2Rhc2gudW56aXAgPSB1bnppcDsKICAgIGxvZGFzaC51bnppcFdpdGggPSB1bnppcFdpdGg7CiAgICBsb2Rhc2gudXBkYXRlID0gdXBkYXRlOwogICAgbG9kYXNoLnVwZGF0ZVdpdGggPSB1cGRhdGVXaXRoOwogICAgbG9kYXNoLnZhbHVlcyA9IHZhbHVlczsKICAgIGxvZGFzaC52YWx1ZXNJbiA9IHZhbHVlc0luOwogICAgbG9kYXNoLndpdGhvdXQgPSB3aXRob3V0OwogICAgbG9kYXNoLndvcmRzID0gd29yZHM7CiAgICBsb2Rhc2gud3JhcCA9IHdyYXA7CiAgICBsb2Rhc2gueG9yID0geG9yOwogICAgbG9kYXNoLnhvckJ5ID0geG9yQnk7CiAgICBsb2Rhc2gueG9yV2l0aCA9IHhvcldpdGg7CiAgICBsb2Rhc2guemlwID0gemlwOwogICAgbG9kYXNoLnppcE9iamVjdCA9IHppcE9iamVjdDsKICAgIGxvZGFzaC56aXBPYmplY3REZWVwID0gemlwT2JqZWN0RGVlcDsKICAgIGxvZGFzaC56aXBXaXRoID0gemlwV2l0aDsKCiAgICAvLyBBZGQgYWxpYXNlcy4KICAgIGxvZGFzaC5lbnRyaWVzID0gdG9QYWlyczsKICAgIGxvZGFzaC5lbnRyaWVzSW4gPSB0b1BhaXJzSW47CiAgICBsb2Rhc2guZXh0ZW5kID0gYXNzaWduSW47CiAgICBsb2Rhc2guZXh0ZW5kV2l0aCA9IGFzc2lnbkluV2l0aDsKCiAgICAvLyBBZGQgbWV0aG9kcyB0byBgbG9kYXNoLnByb3RvdHlwZWAuCiAgICBtaXhpbihsb2Rhc2gsIGxvZGFzaCk7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIEFkZCBtZXRob2RzIHRoYXQgcmV0dXJuIHVud3JhcHBlZCB2YWx1ZXMgaW4gY2hhaW4gc2VxdWVuY2VzLgogICAgbG9kYXNoLmFkZCA9IGFkZDsKICAgIGxvZGFzaC5hdHRlbXB0ID0gYXR0ZW1wdDsKICAgIGxvZGFzaC5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgICBsb2Rhc2guY2FwaXRhbGl6ZSA9IGNhcGl0YWxpemU7CiAgICBsb2Rhc2guY2VpbCA9IGNlaWw7CiAgICBsb2Rhc2guY2xhbXAgPSBjbGFtcDsKICAgIGxvZGFzaC5jbG9uZSA9IGNsb25lOwogICAgbG9kYXNoLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICAgIGxvZGFzaC5jbG9uZURlZXBXaXRoID0gY2xvbmVEZWVwV2l0aDsKICAgIGxvZGFzaC5jbG9uZVdpdGggPSBjbG9uZVdpdGg7CiAgICBsb2Rhc2guY29uZm9ybXNUbyA9IGNvbmZvcm1zVG87CiAgICBsb2Rhc2guZGVidXJyID0gZGVidXJyOwogICAgbG9kYXNoLmRlZmF1bHRUbyA9IGRlZmF1bHRUbzsKICAgIGxvZGFzaC5kaXZpZGUgPSBkaXZpZGU7CiAgICBsb2Rhc2guZW5kc1dpdGggPSBlbmRzV2l0aDsKICAgIGxvZGFzaC5lcSA9IGVxOwogICAgbG9kYXNoLmVzY2FwZSA9IGVzY2FwZTsKICAgIGxvZGFzaC5lc2NhcGVSZWdFeHAgPSBlc2NhcGVSZWdFeHA7CiAgICBsb2Rhc2guZXZlcnkgPSBldmVyeTsKICAgIGxvZGFzaC5maW5kID0gZmluZDsKICAgIGxvZGFzaC5maW5kSW5kZXggPSBmaW5kSW5kZXg7CiAgICBsb2Rhc2guZmluZEtleSA9IGZpbmRLZXk7CiAgICBsb2Rhc2guZmluZExhc3QgPSBmaW5kTGFzdDsKICAgIGxvZGFzaC5maW5kTGFzdEluZGV4ID0gZmluZExhc3RJbmRleDsKICAgIGxvZGFzaC5maW5kTGFzdEtleSA9IGZpbmRMYXN0S2V5OwogICAgbG9kYXNoLmZsb29yID0gZmxvb3I7CiAgICBsb2Rhc2guZm9yRWFjaCA9IGZvckVhY2g7CiAgICBsb2Rhc2guZm9yRWFjaFJpZ2h0ID0gZm9yRWFjaFJpZ2h0OwogICAgbG9kYXNoLmZvckluID0gZm9ySW47CiAgICBsb2Rhc2guZm9ySW5SaWdodCA9IGZvckluUmlnaHQ7CiAgICBsb2Rhc2guZm9yT3duID0gZm9yT3duOwogICAgbG9kYXNoLmZvck93blJpZ2h0ID0gZm9yT3duUmlnaHQ7CiAgICBsb2Rhc2guZ2V0ID0gZ2V0OwogICAgbG9kYXNoLmd0ID0gZ3Q7CiAgICBsb2Rhc2guZ3RlID0gZ3RlOwogICAgbG9kYXNoLmhhcyA9IGhhczsKICAgIGxvZGFzaC5oYXNJbiA9IGhhc0luOwogICAgbG9kYXNoLmhlYWQgPSBoZWFkOwogICAgbG9kYXNoLmlkZW50aXR5ID0gaWRlbnRpdHk7CiAgICBsb2Rhc2guaW5jbHVkZXMgPSBpbmNsdWRlczsKICAgIGxvZGFzaC5pbmRleE9mID0gaW5kZXhPZjsKICAgIGxvZGFzaC5pblJhbmdlID0gaW5SYW5nZTsKICAgIGxvZGFzaC5pbnZva2UgPSBpbnZva2U7CiAgICBsb2Rhc2guaXNBcmd1bWVudHMgPSBpc0FyZ3VtZW50czsKICAgIGxvZGFzaC5pc0FycmF5ID0gaXNBcnJheTsKICAgIGxvZGFzaC5pc0FycmF5QnVmZmVyID0gaXNBcnJheUJ1ZmZlcjsKICAgIGxvZGFzaC5pc0FycmF5TGlrZSA9IGlzQXJyYXlMaWtlOwogICAgbG9kYXNoLmlzQXJyYXlMaWtlT2JqZWN0ID0gaXNBcnJheUxpa2VPYmplY3Q7CiAgICBsb2Rhc2guaXNCb29sZWFuID0gaXNCb29sZWFuOwogICAgbG9kYXNoLmlzQnVmZmVyID0gaXNCdWZmZXI7CiAgICBsb2Rhc2guaXNEYXRlID0gaXNEYXRlOwogICAgbG9kYXNoLmlzRWxlbWVudCA9IGlzRWxlbWVudDsKICAgIGxvZGFzaC5pc0VtcHR5ID0gaXNFbXB0eTsKICAgIGxvZGFzaC5pc0VxdWFsID0gaXNFcXVhbDsKICAgIGxvZGFzaC5pc0VxdWFsV2l0aCA9IGlzRXF1YWxXaXRoOwogICAgbG9kYXNoLmlzRXJyb3IgPSBpc0Vycm9yOwogICAgbG9kYXNoLmlzRmluaXRlID0gaXNGaW5pdGU7CiAgICBsb2Rhc2guaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CiAgICBsb2Rhc2guaXNJbnRlZ2VyID0gaXNJbnRlZ2VyOwogICAgbG9kYXNoLmlzTGVuZ3RoID0gaXNMZW5ndGg7CiAgICBsb2Rhc2guaXNNYXAgPSBpc01hcDsKICAgIGxvZGFzaC5pc01hdGNoID0gaXNNYXRjaDsKICAgIGxvZGFzaC5pc01hdGNoV2l0aCA9IGlzTWF0Y2hXaXRoOwogICAgbG9kYXNoLmlzTmFOID0gaXNOYU47CiAgICBsb2Rhc2guaXNOYXRpdmUgPSBpc05hdGl2ZTsKICAgIGxvZGFzaC5pc05pbCA9IGlzTmlsOwogICAgbG9kYXNoLmlzTnVsbCA9IGlzTnVsbDsKICAgIGxvZGFzaC5pc051bWJlciA9IGlzTnVtYmVyOwogICAgbG9kYXNoLmlzT2JqZWN0ID0gaXNPYmplY3Q7CiAgICBsb2Rhc2guaXNPYmplY3RMaWtlID0gaXNPYmplY3RMaWtlOwogICAgbG9kYXNoLmlzUGxhaW5PYmplY3QgPSBpc1BsYWluT2JqZWN0OwogICAgbG9kYXNoLmlzUmVnRXhwID0gaXNSZWdFeHA7CiAgICBsb2Rhc2guaXNTYWZlSW50ZWdlciA9IGlzU2FmZUludGVnZXI7CiAgICBsb2Rhc2guaXNTZXQgPSBpc1NldDsKICAgIGxvZGFzaC5pc1N0cmluZyA9IGlzU3RyaW5nOwogICAgbG9kYXNoLmlzU3ltYm9sID0gaXNTeW1ib2w7CiAgICBsb2Rhc2guaXNUeXBlZEFycmF5ID0gaXNUeXBlZEFycmF5OwogICAgbG9kYXNoLmlzVW5kZWZpbmVkID0gaXNVbmRlZmluZWQ7CiAgICBsb2Rhc2guaXNXZWFrTWFwID0gaXNXZWFrTWFwOwogICAgbG9kYXNoLmlzV2Vha1NldCA9IGlzV2Vha1NldDsKICAgIGxvZGFzaC5qb2luID0gam9pbjsKICAgIGxvZGFzaC5rZWJhYkNhc2UgPSBrZWJhYkNhc2U7CiAgICBsb2Rhc2gubGFzdCA9IGxhc3Q7CiAgICBsb2Rhc2gubGFzdEluZGV4T2YgPSBsYXN0SW5kZXhPZjsKICAgIGxvZGFzaC5sb3dlckNhc2UgPSBsb3dlckNhc2U7CiAgICBsb2Rhc2gubG93ZXJGaXJzdCA9IGxvd2VyRmlyc3Q7CiAgICBsb2Rhc2gubHQgPSBsdDsKICAgIGxvZGFzaC5sdGUgPSBsdGU7CiAgICBsb2Rhc2gubWF4ID0gbWF4OwogICAgbG9kYXNoLm1heEJ5ID0gbWF4Qnk7CiAgICBsb2Rhc2gubWVhbiA9IG1lYW47CiAgICBsb2Rhc2gubWVhbkJ5ID0gbWVhbkJ5OwogICAgbG9kYXNoLm1pbiA9IG1pbjsKICAgIGxvZGFzaC5taW5CeSA9IG1pbkJ5OwogICAgbG9kYXNoLnN0dWJBcnJheSA9IHN0dWJBcnJheTsKICAgIGxvZGFzaC5zdHViRmFsc2UgPSBzdHViRmFsc2U7CiAgICBsb2Rhc2guc3R1Yk9iamVjdCA9IHN0dWJPYmplY3Q7CiAgICBsb2Rhc2guc3R1YlN0cmluZyA9IHN0dWJTdHJpbmc7CiAgICBsb2Rhc2guc3R1YlRydWUgPSBzdHViVHJ1ZTsKICAgIGxvZGFzaC5tdWx0aXBseSA9IG11bHRpcGx5OwogICAgbG9kYXNoLm50aCA9IG50aDsKICAgIGxvZGFzaC5ub0NvbmZsaWN0ID0gbm9Db25mbGljdDsKICAgIGxvZGFzaC5ub29wID0gbm9vcDsKICAgIGxvZGFzaC5ub3cgPSBub3c7CiAgICBsb2Rhc2gucGFkID0gcGFkOwogICAgbG9kYXNoLnBhZEVuZCA9IHBhZEVuZDsKICAgIGxvZGFzaC5wYWRTdGFydCA9IHBhZFN0YXJ0OwogICAgbG9kYXNoLnBhcnNlSW50ID0gcGFyc2VJbnQ7CiAgICBsb2Rhc2gucmFuZG9tID0gcmFuZG9tOwogICAgbG9kYXNoLnJlZHVjZSA9IHJlZHVjZTsKICAgIGxvZGFzaC5yZWR1Y2VSaWdodCA9IHJlZHVjZVJpZ2h0OwogICAgbG9kYXNoLnJlcGVhdCA9IHJlcGVhdDsKICAgIGxvZGFzaC5yZXBsYWNlID0gcmVwbGFjZTsKICAgIGxvZGFzaC5yZXN1bHQgPSByZXN1bHQ7CiAgICBsb2Rhc2gucm91bmQgPSByb3VuZDsKICAgIGxvZGFzaC5ydW5JbkNvbnRleHQgPSBydW5JbkNvbnRleHQ7CiAgICBsb2Rhc2guc2FtcGxlID0gc2FtcGxlOwogICAgbG9kYXNoLnNpemUgPSBzaXplOwogICAgbG9kYXNoLnNuYWtlQ2FzZSA9IHNuYWtlQ2FzZTsKICAgIGxvZGFzaC5zb21lID0gc29tZTsKICAgIGxvZGFzaC5zb3J0ZWRJbmRleCA9IHNvcnRlZEluZGV4OwogICAgbG9kYXNoLnNvcnRlZEluZGV4QnkgPSBzb3J0ZWRJbmRleEJ5OwogICAgbG9kYXNoLnNvcnRlZEluZGV4T2YgPSBzb3J0ZWRJbmRleE9mOwogICAgbG9kYXNoLnNvcnRlZExhc3RJbmRleCA9IHNvcnRlZExhc3RJbmRleDsKICAgIGxvZGFzaC5zb3J0ZWRMYXN0SW5kZXhCeSA9IHNvcnRlZExhc3RJbmRleEJ5OwogICAgbG9kYXNoLnNvcnRlZExhc3RJbmRleE9mID0gc29ydGVkTGFzdEluZGV4T2Y7CiAgICBsb2Rhc2guc3RhcnRDYXNlID0gc3RhcnRDYXNlOwogICAgbG9kYXNoLnN0YXJ0c1dpdGggPSBzdGFydHNXaXRoOwogICAgbG9kYXNoLnN1YnRyYWN0ID0gc3VidHJhY3Q7CiAgICBsb2Rhc2guc3VtID0gc3VtOwogICAgbG9kYXNoLnN1bUJ5ID0gc3VtQnk7CiAgICBsb2Rhc2gudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgIGxvZGFzaC50aW1lcyA9IHRpbWVzOwogICAgbG9kYXNoLnRvRmluaXRlID0gdG9GaW5pdGU7CiAgICBsb2Rhc2gudG9JbnRlZ2VyID0gdG9JbnRlZ2VyOwogICAgbG9kYXNoLnRvTGVuZ3RoID0gdG9MZW5ndGg7CiAgICBsb2Rhc2gudG9Mb3dlciA9IHRvTG93ZXI7CiAgICBsb2Rhc2gudG9OdW1iZXIgPSB0b051bWJlcjsKICAgIGxvZGFzaC50b1NhZmVJbnRlZ2VyID0gdG9TYWZlSW50ZWdlcjsKICAgIGxvZGFzaC50b1N0cmluZyA9IHRvU3RyaW5nOwogICAgbG9kYXNoLnRvVXBwZXIgPSB0b1VwcGVyOwogICAgbG9kYXNoLnRyaW0gPSB0cmltOwogICAgbG9kYXNoLnRyaW1FbmQgPSB0cmltRW5kOwogICAgbG9kYXNoLnRyaW1TdGFydCA9IHRyaW1TdGFydDsKICAgIGxvZGFzaC50cnVuY2F0ZSA9IHRydW5jYXRlOwogICAgbG9kYXNoLnVuZXNjYXBlID0gdW5lc2NhcGU7CiAgICBsb2Rhc2gudW5pcXVlSWQgPSB1bmlxdWVJZDsKICAgIGxvZGFzaC51cHBlckNhc2UgPSB1cHBlckNhc2U7CiAgICBsb2Rhc2gudXBwZXJGaXJzdCA9IHVwcGVyRmlyc3Q7CgogICAgLy8gQWRkIGFsaWFzZXMuCiAgICBsb2Rhc2guZWFjaCA9IGZvckVhY2g7CiAgICBsb2Rhc2guZWFjaFJpZ2h0ID0gZm9yRWFjaFJpZ2h0OwogICAgbG9kYXNoLmZpcnN0ID0gaGVhZDsKCiAgICBtaXhpbihsb2Rhc2gsIChmdW5jdGlvbigpIHsKICAgICAgdmFyIHNvdXJjZSA9IHt9OwogICAgICBiYXNlRm9yT3duKGxvZGFzaCwgZnVuY3Rpb24oZnVuYywgbWV0aG9kTmFtZSkgewogICAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChsb2Rhc2gucHJvdG90eXBlLCBtZXRob2ROYW1lKSkgewogICAgICAgICAgc291cmNlW21ldGhvZE5hbWVdID0gZnVuYzsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gc291cmNlOwogICAgfSgpKSwgeyAnY2hhaW4nOiBmYWxzZSB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBUaGUgc2VtYW50aWMgdmVyc2lvbiBudW1iZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgKi8KICAgIGxvZGFzaC5WRVJTSU9OID0gVkVSU0lPTjsKCiAgICAvLyBBc3NpZ24gZGVmYXVsdCBwbGFjZWhvbGRlcnMuCiAgICBhcnJheUVhY2goWydiaW5kJywgJ2JpbmRLZXknLCAnY3VycnknLCAnY3VycnlSaWdodCcsICdwYXJ0aWFsJywgJ3BhcnRpYWxSaWdodCddLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgIGxvZGFzaFttZXRob2ROYW1lXS5wbGFjZWhvbGRlciA9IGxvZGFzaDsKICAgIH0pOwoKICAgIC8vIEFkZCBgTGF6eVdyYXBwZXJgIG1ldGhvZHMgZm9yIGBfLmRyb3BgIGFuZCBgXy50YWtlYCB2YXJpYW50cy4KICAgIGFycmF5RWFjaChbJ2Ryb3AnLCAndGFrZSddLCBmdW5jdGlvbihtZXRob2ROYW1lLCBpbmRleCkgewogICAgICBMYXp5V3JhcHBlci5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbihuKSB7CiAgICAgICAgbiA9IG4gPT09IHVuZGVmaW5lZCA/IDEgOiBuYXRpdmVNYXgodG9JbnRlZ2VyKG4pLCAwKTsKCiAgICAgICAgdmFyIHJlc3VsdCA9ICh0aGlzLl9fZmlsdGVyZWRfXyAmJiAhaW5kZXgpCiAgICAgICAgICA/IG5ldyBMYXp5V3JhcHBlcih0aGlzKQogICAgICAgICAgOiB0aGlzLmNsb25lKCk7CgogICAgICAgIGlmIChyZXN1bHQuX19maWx0ZXJlZF9fKSB7CiAgICAgICAgICByZXN1bHQuX190YWtlQ291bnRfXyA9IG5hdGl2ZU1pbihuLCByZXN1bHQuX190YWtlQ291bnRfXyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5fX3ZpZXdzX18ucHVzaCh7CiAgICAgICAgICAgICdzaXplJzogbmF0aXZlTWluKG4sIE1BWF9BUlJBWV9MRU5HVEgpLAogICAgICAgICAgICAndHlwZSc6IG1ldGhvZE5hbWUgKyAocmVzdWx0Ll9fZGlyX18gPCAwID8gJ1JpZ2h0JyA6ICcnKQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CgogICAgICBMYXp5V3JhcHBlci5wcm90b3R5cGVbbWV0aG9kTmFtZSArICdSaWdodCddID0gZnVuY3Rpb24obikgewogICAgICAgIHJldHVybiB0aGlzLnJldmVyc2UoKVttZXRob2ROYW1lXShuKS5yZXZlcnNlKCk7CiAgICAgIH07CiAgICB9KTsKCiAgICAvLyBBZGQgYExhenlXcmFwcGVyYCBtZXRob2RzIHRoYXQgYWNjZXB0IGFuIGBpdGVyYXRlZWAgdmFsdWUuCiAgICBhcnJheUVhY2goWydmaWx0ZXInLCAnbWFwJywgJ3Rha2VXaGlsZSddLCBmdW5jdGlvbihtZXRob2ROYW1lLCBpbmRleCkgewogICAgICB2YXIgdHlwZSA9IGluZGV4ICsgMSwKICAgICAgICAgIGlzRmlsdGVyID0gdHlwZSA9PSBMQVpZX0ZJTFRFUl9GTEFHIHx8IHR5cGUgPT0gTEFaWV9XSElMRV9GTEFHOwoKICAgICAgTGF6eVdyYXBwZXIucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oaXRlcmF0ZWUpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5jbG9uZSgpOwogICAgICAgIHJlc3VsdC5fX2l0ZXJhdGVlc19fLnB1c2goewogICAgICAgICAgJ2l0ZXJhdGVlJzogZ2V0SXRlcmF0ZWUoaXRlcmF0ZWUsIDMpLAogICAgICAgICAgJ3R5cGUnOiB0eXBlCiAgICAgICAgfSk7CiAgICAgICAgcmVzdWx0Ll9fZmlsdGVyZWRfXyA9IHJlc3VsdC5fX2ZpbHRlcmVkX18gfHwgaXNGaWx0ZXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0pOwoKICAgIC8vIEFkZCBgTGF6eVdyYXBwZXJgIG1ldGhvZHMgZm9yIGBfLmhlYWRgIGFuZCBgXy5sYXN0YC4KICAgIGFycmF5RWFjaChbJ2hlYWQnLCAnbGFzdCddLCBmdW5jdGlvbihtZXRob2ROYW1lLCBpbmRleCkgewogICAgICB2YXIgdGFrZU5hbWUgPSAndGFrZScgKyAoaW5kZXggPyAnUmlnaHQnIDogJycpOwoKICAgICAgTGF6eVdyYXBwZXIucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbdGFrZU5hbWVdKDEpLnZhbHVlKClbMF07CiAgICAgIH07CiAgICB9KTsKCiAgICAvLyBBZGQgYExhenlXcmFwcGVyYCBtZXRob2RzIGZvciBgXy5pbml0aWFsYCBhbmQgYF8udGFpbGAuCiAgICBhcnJheUVhY2goWydpbml0aWFsJywgJ3RhaWwnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSwgaW5kZXgpIHsKICAgICAgdmFyIGRyb3BOYW1lID0gJ2Ryb3AnICsgKGluZGV4ID8gJycgOiAnUmlnaHQnKTsKCiAgICAgIExhenlXcmFwcGVyLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9fZmlsdGVyZWRfXyA/IG5ldyBMYXp5V3JhcHBlcih0aGlzKSA6IHRoaXNbZHJvcE5hbWVdKDEpOwogICAgICB9OwogICAgfSk7CgogICAgTGF6eVdyYXBwZXIucHJvdG90eXBlLmNvbXBhY3QgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGlkZW50aXR5KTsKICAgIH07CgogICAgTGF6eVdyYXBwZXIucHJvdG90eXBlLmZpbmQgPSBmdW5jdGlvbihwcmVkaWNhdGUpIHsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKHByZWRpY2F0ZSkuaGVhZCgpOwogICAgfTsKCiAgICBMYXp5V3JhcHBlci5wcm90b3R5cGUuZmluZExhc3QgPSBmdW5jdGlvbihwcmVkaWNhdGUpIHsKICAgICAgcmV0dXJuIHRoaXMucmV2ZXJzZSgpLmZpbmQocHJlZGljYXRlKTsKICAgIH07CgogICAgTGF6eVdyYXBwZXIucHJvdG90eXBlLmludm9rZU1hcCA9IGJhc2VSZXN0KGZ1bmN0aW9uKHBhdGgsIGFyZ3MpIHsKICAgICAgaWYgKHR5cGVvZiBwYXRoID09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gbmV3IExhenlXcmFwcGVyKHRoaXMpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBiYXNlSW52b2tlKHZhbHVlLCBwYXRoLCBhcmdzKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBMYXp5V3JhcHBlci5wcm90b3R5cGUucmVqZWN0ID0gZnVuY3Rpb24ocHJlZGljYXRlKSB7CiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihuZWdhdGUoZ2V0SXRlcmF0ZWUocHJlZGljYXRlKSkpOwogICAgfTsKCiAgICBMYXp5V3JhcHBlci5wcm90b3R5cGUuc2xpY2UgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgIHN0YXJ0ID0gdG9JbnRlZ2VyKHN0YXJ0KTsKCiAgICAgIHZhciByZXN1bHQgPSB0aGlzOwogICAgICBpZiAocmVzdWx0Ll9fZmlsdGVyZWRfXyAmJiAoc3RhcnQgPiAwIHx8IGVuZCA8IDApKSB7CiAgICAgICAgcmV0dXJuIG5ldyBMYXp5V3JhcHBlcihyZXN1bHQpOwogICAgICB9CiAgICAgIGlmIChzdGFydCA8IDApIHsKICAgICAgICByZXN1bHQgPSByZXN1bHQudGFrZVJpZ2h0KC1zdGFydCk7CiAgICAgIH0gZWxzZSBpZiAoc3RhcnQpIHsKICAgICAgICByZXN1bHQgPSByZXN1bHQuZHJvcChzdGFydCk7CiAgICAgIH0KICAgICAgaWYgKGVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZW5kID0gdG9JbnRlZ2VyKGVuZCk7CiAgICAgICAgcmVzdWx0ID0gZW5kIDwgMCA/IHJlc3VsdC5kcm9wUmlnaHQoLWVuZCkgOiByZXN1bHQudGFrZShlbmQgLSBzdGFydCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CgogICAgTGF6eVdyYXBwZXIucHJvdG90eXBlLnRha2VSaWdodFdoaWxlID0gZnVuY3Rpb24ocHJlZGljYXRlKSB7CiAgICAgIHJldHVybiB0aGlzLnJldmVyc2UoKS50YWtlV2hpbGUocHJlZGljYXRlKS5yZXZlcnNlKCk7CiAgICB9OwoKICAgIExhenlXcmFwcGVyLnByb3RvdHlwZS50b0FycmF5ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnRha2UoTUFYX0FSUkFZX0xFTkdUSCk7CiAgICB9OwoKICAgIC8vIEFkZCBgTGF6eVdyYXBwZXJgIG1ldGhvZHMgdG8gYGxvZGFzaC5wcm90b3R5cGVgLgogICAgYmFzZUZvck93bihMYXp5V3JhcHBlci5wcm90b3R5cGUsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGNoZWNrSXRlcmF0ZWUgPSAvXig/OmZpbHRlcnxmaW5kfG1hcHxyZWplY3QpfFdoaWxlJC8udGVzdChtZXRob2ROYW1lKSwKICAgICAgICAgIGlzVGFrZXIgPSAvXig/OmhlYWR8bGFzdCkkLy50ZXN0KG1ldGhvZE5hbWUpLAogICAgICAgICAgbG9kYXNoRnVuYyA9IGxvZGFzaFtpc1Rha2VyID8gKCd0YWtlJyArIChtZXRob2ROYW1lID09ICdsYXN0JyA/ICdSaWdodCcgOiAnJykpIDogbWV0aG9kTmFtZV0sCiAgICAgICAgICByZXRVbndyYXBwZWQgPSBpc1Rha2VyIHx8IC9eZmluZC8udGVzdChtZXRob2ROYW1lKTsKCiAgICAgIGlmICghbG9kYXNoRnVuYykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fX3dyYXBwZWRfXywKICAgICAgICAgICAgYXJncyA9IGlzVGFrZXIgPyBbMV0gOiBhcmd1bWVudHMsCiAgICAgICAgICAgIGlzTGF6eSA9IHZhbHVlIGluc3RhbmNlb2YgTGF6eVdyYXBwZXIsCiAgICAgICAgICAgIGl0ZXJhdGVlID0gYXJnc1swXSwKICAgICAgICAgICAgdXNlTGF6eSA9IGlzTGF6eSB8fCBpc0FycmF5KHZhbHVlKTsKCiAgICAgICAgdmFyIGludGVyY2VwdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBsb2Rhc2hGdW5jLmFwcGx5KGxvZGFzaCwgYXJyYXlQdXNoKFt2YWx1ZV0sIGFyZ3MpKTsKICAgICAgICAgIHJldHVybiAoaXNUYWtlciAmJiBjaGFpbkFsbCkgPyByZXN1bHRbMF0gOiByZXN1bHQ7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKHVzZUxhenkgJiYgY2hlY2tJdGVyYXRlZSAmJiB0eXBlb2YgaXRlcmF0ZWUgPT0gJ2Z1bmN0aW9uJyAmJiBpdGVyYXRlZS5sZW5ndGggIT0gMSkgewogICAgICAgICAgLy8gQXZvaWQgbGF6eSB1c2UgaWYgdGhlIGl0ZXJhdGVlIGhhcyBhICJsZW5ndGgiIHZhbHVlIG90aGVyIHRoYW4gYDFgLgogICAgICAgICAgaXNMYXp5ID0gdXNlTGF6eSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgY2hhaW5BbGwgPSB0aGlzLl9fY2hhaW5fXywKICAgICAgICAgICAgaXNIeWJyaWQgPSAhIXRoaXMuX19hY3Rpb25zX18ubGVuZ3RoLAogICAgICAgICAgICBpc1Vud3JhcHBlZCA9IHJldFVud3JhcHBlZCAmJiAhY2hhaW5BbGwsCiAgICAgICAgICAgIG9ubHlMYXp5ID0gaXNMYXp5ICYmICFpc0h5YnJpZDsKCiAgICAgICAgaWYgKCFyZXRVbndyYXBwZWQgJiYgdXNlTGF6eSkgewogICAgICAgICAgdmFsdWUgPSBvbmx5TGF6eSA/IHZhbHVlIDogbmV3IExhenlXcmFwcGVyKHRoaXMpOwogICAgICAgICAgdmFyIHJlc3VsdCA9IGZ1bmMuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgICAgICAgcmVzdWx0Ll9fYWN0aW9uc19fLnB1c2goeyAnZnVuYyc6IHRocnUsICdhcmdzJzogW2ludGVyY2VwdG9yXSwgJ3RoaXNBcmcnOiB1bmRlZmluZWQgfSk7CiAgICAgICAgICByZXR1cm4gbmV3IExvZGFzaFdyYXBwZXIocmVzdWx0LCBjaGFpbkFsbCk7CiAgICAgICAgfQogICAgICAgIGlmIChpc1Vud3JhcHBlZCAmJiBvbmx5TGF6eSkgewogICAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9IHRoaXMudGhydShpbnRlcmNlcHRvcik7CiAgICAgICAgcmV0dXJuIGlzVW53cmFwcGVkID8gKGlzVGFrZXIgPyByZXN1bHQudmFsdWUoKVswXSA6IHJlc3VsdC52YWx1ZSgpKSA6IHJlc3VsdDsKICAgICAgfTsKICAgIH0pOwoKICAgIC8vIEFkZCBgQXJyYXlgIG1ldGhvZHMgdG8gYGxvZGFzaC5wcm90b3R5cGVgLgogICAgYXJyYXlFYWNoKFsncG9wJywgJ3B1c2gnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCddLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgIHZhciBmdW5jID0gYXJyYXlQcm90b1ttZXRob2ROYW1lXSwKICAgICAgICAgIGNoYWluTmFtZSA9IC9eKD86cHVzaHxzb3J0fHVuc2hpZnQpJC8udGVzdChtZXRob2ROYW1lKSA/ICd0YXAnIDogJ3RocnUnLAogICAgICAgICAgcmV0VW53cmFwcGVkID0gL14oPzpwb3B8c2hpZnQpJC8udGVzdChtZXRob2ROYW1lKTsKCiAgICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICBpZiAocmV0VW53cmFwcGVkICYmICF0aGlzLl9fY2hhaW5fXykgewogICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy52YWx1ZSgpOwogICAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IFtdLCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXNbY2hhaW5OYW1lXShmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IFtdLCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0pOwoKICAgIC8vIE1hcCBtaW5pZmllZCBtZXRob2QgbmFtZXMgdG8gdGhlaXIgcmVhbCBuYW1lcy4KICAgIGJhc2VGb3JPd24oTGF6eVdyYXBwZXIucHJvdG90eXBlLCBmdW5jdGlvbihmdW5jLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBsb2Rhc2hGdW5jID0gbG9kYXNoW21ldGhvZE5hbWVdOwogICAgICBpZiAobG9kYXNoRnVuYykgewogICAgICAgIHZhciBrZXkgPSBsb2Rhc2hGdW5jLm5hbWUgKyAnJzsKICAgICAgICBpZiAoIWhhc093blByb3BlcnR5LmNhbGwocmVhbE5hbWVzLCBrZXkpKSB7CiAgICAgICAgICByZWFsTmFtZXNba2V5XSA9IFtdOwogICAgICAgIH0KICAgICAgICByZWFsTmFtZXNba2V5XS5wdXNoKHsgJ25hbWUnOiBtZXRob2ROYW1lLCAnZnVuYyc6IGxvZGFzaEZ1bmMgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJlYWxOYW1lc1tjcmVhdGVIeWJyaWQodW5kZWZpbmVkLCBXUkFQX0JJTkRfS0VZX0ZMQUcpLm5hbWVdID0gW3sKICAgICAgJ25hbWUnOiAnd3JhcHBlcicsCiAgICAgICdmdW5jJzogdW5kZWZpbmVkCiAgICB9XTsKCiAgICAvLyBBZGQgbWV0aG9kcyB0byBgTGF6eVdyYXBwZXJgLgogICAgTGF6eVdyYXBwZXIucHJvdG90eXBlLmNsb25lID0gbGF6eUNsb25lOwogICAgTGF6eVdyYXBwZXIucHJvdG90eXBlLnJldmVyc2UgPSBsYXp5UmV2ZXJzZTsKICAgIExhenlXcmFwcGVyLnByb3RvdHlwZS52YWx1ZSA9IGxhenlWYWx1ZTsKCiAgICAvLyBBZGQgY2hhaW4gc2VxdWVuY2UgbWV0aG9kcyB0byB0aGUgYGxvZGFzaGAgd3JhcHBlci4KICAgIGxvZGFzaC5wcm90b3R5cGUuYXQgPSB3cmFwcGVyQXQ7CiAgICBsb2Rhc2gucHJvdG90eXBlLmNoYWluID0gd3JhcHBlckNoYWluOwogICAgbG9kYXNoLnByb3RvdHlwZS5jb21taXQgPSB3cmFwcGVyQ29tbWl0OwogICAgbG9kYXNoLnByb3RvdHlwZS5uZXh0ID0gd3JhcHBlck5leHQ7CiAgICBsb2Rhc2gucHJvdG90eXBlLnBsYW50ID0gd3JhcHBlclBsYW50OwogICAgbG9kYXNoLnByb3RvdHlwZS5yZXZlcnNlID0gd3JhcHBlclJldmVyc2U7CiAgICBsb2Rhc2gucHJvdG90eXBlLnRvSlNPTiA9IGxvZGFzaC5wcm90b3R5cGUudmFsdWVPZiA9IGxvZGFzaC5wcm90b3R5cGUudmFsdWUgPSB3cmFwcGVyVmFsdWU7CgogICAgLy8gQWRkIGxhenkgYWxpYXNlcy4KICAgIGxvZGFzaC5wcm90b3R5cGUuZmlyc3QgPSBsb2Rhc2gucHJvdG90eXBlLmhlYWQ7CgogICAgaWYgKHN5bUl0ZXJhdG9yKSB7CiAgICAgIGxvZGFzaC5wcm90b3R5cGVbc3ltSXRlcmF0b3JdID0gd3JhcHBlclRvSXRlcmF0b3I7CiAgICB9CiAgICByZXR1cm4gbG9kYXNoOwogIH0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gRXhwb3J0IGxvZGFzaC4KICB2YXIgXyA9IHJ1bkluQ29udGV4dCgpOwoKICAvLyBTb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBjb25kaXRpb24gcGF0dGVybnMgbGlrZToKICBpZiAodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBkZWZpbmUuYW1kID09ICdvYmplY3QnICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEV4cG9zZSBMb2Rhc2ggb24gdGhlIGdsb2JhbCBvYmplY3QgdG8gcHJldmVudCBlcnJvcnMgd2hlbiBMb2Rhc2ggaXMKICAgIC8vIGxvYWRlZCBieSBhIHNjcmlwdCB0YWcgaW4gdGhlIHByZXNlbmNlIG9mIGFuIEFNRCBsb2FkZXIuCiAgICAvLyBTZWUgaHR0cDovL3JlcXVpcmVqcy5vcmcvZG9jcy9lcnJvcnMuaHRtbCNtaXNtYXRjaCBmb3IgbW9yZSBkZXRhaWxzLgogICAgLy8gVXNlIGBfLm5vQ29uZmxpY3RgIHRvIHJlbW92ZSBMb2Rhc2ggZnJvbSB0aGUgZ2xvYmFsIG9iamVjdC4KICAgIHJvb3QuXyA9IF87CgogICAgLy8gRGVmaW5lIGFzIGFuIGFub255bW91cyBtb2R1bGUgc28sIHRocm91Z2ggcGF0aCBtYXBwaW5nLCBpdCBjYW4gYmUKICAgIC8vIHJlZmVyZW5jZWQgYXMgdGhlICJ1bmRlcnNjb3JlIiBtb2R1bGUuCiAgICBkZWZpbmUoZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfOwogICAgfSk7CiAgfQogIC8vIENoZWNrIGZvciBgZXhwb3J0c2AgYWZ0ZXIgYGRlZmluZWAgaW4gY2FzZSBhIGJ1aWxkIG9wdGltaXplciBhZGRzIGl0LgogIGVsc2UgaWYgKGZyZWVNb2R1bGUpIHsKICAgIC8vIEV4cG9ydCBmb3IgTm9kZS5qcy4KICAgIChmcmVlTW9kdWxlLmV4cG9ydHMgPSBfKS5fID0gXzsKICAgIC8vIEV4cG9ydCBmb3IgQ29tbW9uSlMgc3VwcG9ydC4KICAgIGZyZWVFeHBvcnRzLl8gPSBfOwogIH0KICBlbHNlIHsKICAgIC8vIEV4cG9ydCB0byB0aGUgZ2xvYmFsIG9iamVjdC4KICAgIHJvb3QuXyA9IF87CiAgfQp9LmNhbGwodGhpcykpOwo=',
  /* moment-2.24.0 */ 'Ly8hIG1vbWVudC5qcwoKOyhmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6CiAgICB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoZmFjdG9yeSkgOgogICAgZ2xvYmFsLm1vbWVudCA9IGZhY3RvcnkoKQp9KHRoaXMsIChmdW5jdGlvbiAoKSB7ICd1c2Ugc3RyaWN0JzsKCiAgICB2YXIgaG9va0NhbGxiYWNrOwoKICAgIGZ1bmN0aW9uIGhvb2tzICgpIHsKICAgICAgICByZXR1cm4gaG9va0NhbGxiYWNrLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICB9CgogICAgLy8gVGhpcyBpcyBkb25lIHRvIHJlZ2lzdGVyIHRoZSBtZXRob2QgY2FsbGVkIHdpdGggbW9tZW50KCkKICAgIC8vIHdpdGhvdXQgY3JlYXRpbmcgY2lyY3VsYXIgZGVwZW5kZW5jaWVzLgogICAgZnVuY3Rpb24gc2V0SG9va0NhbGxiYWNrIChjYWxsYmFjaykgewogICAgICAgIGhvb2tDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQXJyYXkoaW5wdXQpIHsKICAgICAgICByZXR1cm4gaW5wdXQgaW5zdGFuY2VvZiBBcnJheSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBBcnJheV0nOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzT2JqZWN0KGlucHV0KSB7CiAgICAgICAgLy8gSUU4IHdpbGwgdHJlYXQgdW5kZWZpbmVkIGFuZCBudWxsIGFzIG9iamVjdCBpZiBpdCB3YXNuJ3QgZm9yCiAgICAgICAgLy8gaW5wdXQgIT0gbnVsbAogICAgICAgIHJldHVybiBpbnB1dCAhPSBudWxsICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpbnB1dCkgPT09ICdbb2JqZWN0IE9iamVjdF0nOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzT2JqZWN0RW1wdHkob2JqKSB7CiAgICAgICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKSB7CiAgICAgICAgICAgIHJldHVybiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKS5sZW5ndGggPT09IDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBrOwogICAgICAgICAgICBmb3IgKGsgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1VuZGVmaW5lZChpbnB1dCkgewogICAgICAgIHJldHVybiBpbnB1dCA9PT0gdm9pZCAwOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTnVtYmVyKGlucHV0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBpbnB1dCA9PT0gJ251bWJlcicgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgTnVtYmVyXSc7CiAgICB9CgogICAgZnVuY3Rpb24gaXNEYXRlKGlucHV0KSB7CiAgICAgICAgcmV0dXJuIGlucHV0IGluc3RhbmNlb2YgRGF0ZSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBEYXRlXSc7CiAgICB9CgogICAgZnVuY3Rpb24gbWFwKGFyciwgZm4pIHsKICAgICAgICB2YXIgcmVzID0gW10sIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICByZXMucHVzaChmbihhcnJbaV0sIGkpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBoYXNPd25Qcm9wKGEsIGIpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIGIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7CiAgICAgICAgZm9yICh2YXIgaSBpbiBiKSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wKGIsIGkpKSB7CiAgICAgICAgICAgICAgICBhW2ldID0gYltpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGhhc093blByb3AoYiwgJ3RvU3RyaW5nJykpIHsKICAgICAgICAgICAgYS50b1N0cmluZyA9IGIudG9TdHJpbmc7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFzT3duUHJvcChiLCAndmFsdWVPZicpKSB7CiAgICAgICAgICAgIGEudmFsdWVPZiA9IGIudmFsdWVPZjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVVUQyAoaW5wdXQsIGZvcm1hdCwgbG9jYWxlLCBzdHJpY3QpIHsKICAgICAgICByZXR1cm4gY3JlYXRlTG9jYWxPclVUQyhpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCwgdHJ1ZSkudXRjKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZGVmYXVsdFBhcnNpbmdGbGFncygpIHsKICAgICAgICAvLyBXZSBuZWVkIHRvIGRlZXAgY2xvbmUgdGhpcyBvYmplY3QuCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZW1wdHkgICAgICAgICAgIDogZmFsc2UsCiAgICAgICAgICAgIHVudXNlZFRva2VucyAgICA6IFtdLAogICAgICAgICAgICB1bnVzZWRJbnB1dCAgICAgOiBbXSwKICAgICAgICAgICAgb3ZlcmZsb3cgICAgICAgIDogLTIsCiAgICAgICAgICAgIGNoYXJzTGVmdE92ZXIgICA6IDAsCiAgICAgICAgICAgIG51bGxJbnB1dCAgICAgICA6IGZhbHNlLAogICAgICAgICAgICBpbnZhbGlkTW9udGggICAgOiBudWxsLAogICAgICAgICAgICBpbnZhbGlkRm9ybWF0ICAgOiBmYWxzZSwKICAgICAgICAgICAgdXNlckludmFsaWRhdGVkIDogZmFsc2UsCiAgICAgICAgICAgIGlzbyAgICAgICAgICAgICA6IGZhbHNlLAogICAgICAgICAgICBwYXJzZWREYXRlUGFydHMgOiBbXSwKICAgICAgICAgICAgbWVyaWRpZW0gICAgICAgIDogbnVsbCwKICAgICAgICAgICAgcmZjMjgyMiAgICAgICAgIDogZmFsc2UsCiAgICAgICAgICAgIHdlZWtkYXlNaXNtYXRjaCA6IGZhbHNlCiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRQYXJzaW5nRmxhZ3MobSkgewogICAgICAgIGlmIChtLl9wZiA9PSBudWxsKSB7CiAgICAgICAgICAgIG0uX3BmID0gZGVmYXVsdFBhcnNpbmdGbGFncygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbS5fcGY7CiAgICB9CgogICAgdmFyIHNvbWU7CiAgICBpZiAoQXJyYXkucHJvdG90eXBlLnNvbWUpIHsKICAgICAgICBzb21lID0gQXJyYXkucHJvdG90eXBlLnNvbWU7CiAgICB9IGVsc2UgewogICAgICAgIHNvbWUgPSBmdW5jdGlvbiAoZnVuKSB7CiAgICAgICAgICAgIHZhciB0ID0gT2JqZWN0KHRoaXMpOwogICAgICAgICAgICB2YXIgbGVuID0gdC5sZW5ndGggPj4+IDA7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaSBpbiB0ICYmIGZ1bi5jYWxsKHRoaXMsIHRbaV0sIGksIHQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGlzVmFsaWQobSkgewogICAgICAgIGlmIChtLl9pc1ZhbGlkID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZsYWdzID0gZ2V0UGFyc2luZ0ZsYWdzKG0pOwogICAgICAgICAgICB2YXIgcGFyc2VkUGFydHMgPSBzb21lLmNhbGwoZmxhZ3MucGFyc2VkRGF0ZVBhcnRzLCBmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGkgIT0gbnVsbDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBpc05vd1ZhbGlkID0gIWlzTmFOKG0uX2QuZ2V0VGltZSgpKSAmJgogICAgICAgICAgICAgICAgZmxhZ3Mub3ZlcmZsb3cgPCAwICYmCiAgICAgICAgICAgICAgICAhZmxhZ3MuZW1wdHkgJiYKICAgICAgICAgICAgICAgICFmbGFncy5pbnZhbGlkTW9udGggJiYKICAgICAgICAgICAgICAgICFmbGFncy5pbnZhbGlkV2Vla2RheSAmJgogICAgICAgICAgICAgICAgIWZsYWdzLndlZWtkYXlNaXNtYXRjaCAmJgogICAgICAgICAgICAgICAgIWZsYWdzLm51bGxJbnB1dCAmJgogICAgICAgICAgICAgICAgIWZsYWdzLmludmFsaWRGb3JtYXQgJiYKICAgICAgICAgICAgICAgICFmbGFncy51c2VySW52YWxpZGF0ZWQgJiYKICAgICAgICAgICAgICAgICghZmxhZ3MubWVyaWRpZW0gfHwgKGZsYWdzLm1lcmlkaWVtICYmIHBhcnNlZFBhcnRzKSk7CgogICAgICAgICAgICBpZiAobS5fc3RyaWN0KSB7CiAgICAgICAgICAgICAgICBpc05vd1ZhbGlkID0gaXNOb3dWYWxpZCAmJgogICAgICAgICAgICAgICAgICAgIGZsYWdzLmNoYXJzTGVmdE92ZXIgPT09IDAgJiYKICAgICAgICAgICAgICAgICAgICBmbGFncy51bnVzZWRUb2tlbnMubGVuZ3RoID09PSAwICYmCiAgICAgICAgICAgICAgICAgICAgZmxhZ3MuYmlnSG91ciA9PT0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoT2JqZWN0LmlzRnJvemVuID09IG51bGwgfHwgIU9iamVjdC5pc0Zyb3plbihtKSkgewogICAgICAgICAgICAgICAgbS5faXNWYWxpZCA9IGlzTm93VmFsaWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOb3dWYWxpZDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbS5faXNWYWxpZDsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVJbnZhbGlkIChmbGFncykgewogICAgICAgIHZhciBtID0gY3JlYXRlVVRDKE5hTik7CiAgICAgICAgaWYgKGZsYWdzICE9IG51bGwpIHsKICAgICAgICAgICAgZXh0ZW5kKGdldFBhcnNpbmdGbGFncyhtKSwgZmxhZ3MpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKG0pLnVzZXJJbnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbTsKICAgIH0KCiAgICAvLyBQbHVnaW5zIHRoYXQgYWRkIHByb3BlcnRpZXMgc2hvdWxkIGFsc28gYWRkIHRoZSBrZXkgaGVyZSAobnVsbCB2YWx1ZSksCiAgICAvLyBzbyB3ZSBjYW4gcHJvcGVybHkgY2xvbmUgb3Vyc2VsdmVzLgogICAgdmFyIG1vbWVudFByb3BlcnRpZXMgPSBob29rcy5tb21lbnRQcm9wZXJ0aWVzID0gW107CgogICAgZnVuY3Rpb24gY29weUNvbmZpZyh0bywgZnJvbSkgewogICAgICAgIHZhciBpLCBwcm9wLCB2YWw7CgogICAgICAgIGlmICghaXNVbmRlZmluZWQoZnJvbS5faXNBTW9tZW50T2JqZWN0KSkgewogICAgICAgICAgICB0by5faXNBTW9tZW50T2JqZWN0ID0gZnJvbS5faXNBTW9tZW50T2JqZWN0OwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX2kpKSB7CiAgICAgICAgICAgIHRvLl9pID0gZnJvbS5faTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc1VuZGVmaW5lZChmcm9tLl9mKSkgewogICAgICAgICAgICB0by5fZiA9IGZyb20uX2Y7CiAgICAgICAgfQogICAgICAgIGlmICghaXNVbmRlZmluZWQoZnJvbS5fbCkpIHsKICAgICAgICAgICAgdG8uX2wgPSBmcm9tLl9sOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX3N0cmljdCkpIHsKICAgICAgICAgICAgdG8uX3N0cmljdCA9IGZyb20uX3N0cmljdDsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc1VuZGVmaW5lZChmcm9tLl90em0pKSB7CiAgICAgICAgICAgIHRvLl90em0gPSBmcm9tLl90em07CiAgICAgICAgfQogICAgICAgIGlmICghaXNVbmRlZmluZWQoZnJvbS5faXNVVEMpKSB7CiAgICAgICAgICAgIHRvLl9pc1VUQyA9IGZyb20uX2lzVVRDOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX29mZnNldCkpIHsKICAgICAgICAgICAgdG8uX29mZnNldCA9IGZyb20uX29mZnNldDsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc1VuZGVmaW5lZChmcm9tLl9wZikpIHsKICAgICAgICAgICAgdG8uX3BmID0gZ2V0UGFyc2luZ0ZsYWdzKGZyb20pOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX2xvY2FsZSkpIHsKICAgICAgICAgICAgdG8uX2xvY2FsZSA9IGZyb20uX2xvY2FsZTsKICAgICAgICB9CgogICAgICAgIGlmIChtb21lbnRQcm9wZXJ0aWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG1vbWVudFByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHByb3AgPSBtb21lbnRQcm9wZXJ0aWVzW2ldOwogICAgICAgICAgICAgICAgdmFsID0gZnJvbVtwcm9wXTsKICAgICAgICAgICAgICAgIGlmICghaXNVbmRlZmluZWQodmFsKSkgewogICAgICAgICAgICAgICAgICAgIHRvW3Byb3BdID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdG87CiAgICB9CgogICAgdmFyIHVwZGF0ZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCiAgICAvLyBNb21lbnQgcHJvdG90eXBlIG9iamVjdAogICAgZnVuY3Rpb24gTW9tZW50KGNvbmZpZykgewogICAgICAgIGNvcHlDb25maWcodGhpcywgY29uZmlnKTsKICAgICAgICB0aGlzLl9kID0gbmV3IERhdGUoY29uZmlnLl9kICE9IG51bGwgPyBjb25maWcuX2QuZ2V0VGltZSgpIDogTmFOKTsKICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHRoaXMuX2QgPSBuZXcgRGF0ZShOYU4pOwogICAgICAgIH0KICAgICAgICAvLyBQcmV2ZW50IGluZmluaXRlIGxvb3AgaW4gY2FzZSB1cGRhdGVPZmZzZXQgY3JlYXRlcyBuZXcgbW9tZW50CiAgICAgICAgLy8gb2JqZWN0cy4KICAgICAgICBpZiAodXBkYXRlSW5Qcm9ncmVzcyA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgdXBkYXRlSW5Qcm9ncmVzcyA9IHRydWU7CiAgICAgICAgICAgIGhvb2tzLnVwZGF0ZU9mZnNldCh0aGlzKTsKICAgICAgICAgICAgdXBkYXRlSW5Qcm9ncmVzcyA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc01vbWVudCAob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIE1vbWVudCB8fCAob2JqICE9IG51bGwgJiYgb2JqLl9pc0FNb21lbnRPYmplY3QgIT0gbnVsbCk7CiAgICB9CgogICAgZnVuY3Rpb24gYWJzRmxvb3IgKG51bWJlcikgewogICAgICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgICAgICAgIC8vIC0wIC0+IDAKICAgICAgICAgICAgcmV0dXJuIE1hdGguY2VpbChudW1iZXIpIHx8IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IobnVtYmVyKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdG9JbnQoYXJndW1lbnRGb3JDb2VyY2lvbikgewogICAgICAgIHZhciBjb2VyY2VkTnVtYmVyID0gK2FyZ3VtZW50Rm9yQ29lcmNpb24sCiAgICAgICAgICAgIHZhbHVlID0gMDsKCiAgICAgICAgaWYgKGNvZXJjZWROdW1iZXIgIT09IDAgJiYgaXNGaW5pdGUoY29lcmNlZE51bWJlcikpIHsKICAgICAgICAgICAgdmFsdWUgPSBhYnNGbG9vcihjb2VyY2VkTnVtYmVyKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvLyBjb21wYXJlIHR3byBhcnJheXMsIHJldHVybiB0aGUgbnVtYmVyIG9mIGRpZmZlcmVuY2VzCiAgICBmdW5jdGlvbiBjb21wYXJlQXJyYXlzKGFycmF5MSwgYXJyYXkyLCBkb250Q29udmVydCkgewogICAgICAgIHZhciBsZW4gPSBNYXRoLm1pbihhcnJheTEubGVuZ3RoLCBhcnJheTIubGVuZ3RoKSwKICAgICAgICAgICAgbGVuZ3RoRGlmZiA9IE1hdGguYWJzKGFycmF5MS5sZW5ndGggLSBhcnJheTIubGVuZ3RoKSwKICAgICAgICAgICAgZGlmZnMgPSAwLAogICAgICAgICAgICBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZiAoKGRvbnRDb252ZXJ0ICYmIGFycmF5MVtpXSAhPT0gYXJyYXkyW2ldKSB8fAogICAgICAgICAgICAgICAgKCFkb250Q29udmVydCAmJiB0b0ludChhcnJheTFbaV0pICE9PSB0b0ludChhcnJheTJbaV0pKSkgewogICAgICAgICAgICAgICAgZGlmZnMrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGlmZnMgKyBsZW5ndGhEaWZmOwogICAgfQoKICAgIGZ1bmN0aW9uIHdhcm4obXNnKSB7CiAgICAgICAgaWYgKGhvb2tzLnN1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5ncyA9PT0gZmFsc2UgJiYKICAgICAgICAgICAgICAgICh0eXBlb2YgY29uc29sZSAhPT0gICd1bmRlZmluZWQnKSAmJiBjb25zb2xlLndhcm4pIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdEZXByZWNhdGlvbiB3YXJuaW5nOiAnICsgbXNnKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZGVwcmVjYXRlKG1zZywgZm4pIHsKICAgICAgICB2YXIgZmlyc3RUaW1lID0gdHJ1ZTsKCiAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChob29rcy5kZXByZWNhdGlvbkhhbmRsZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaG9va3MuZGVwcmVjYXRpb25IYW5kbGVyKG51bGwsIG1zZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpcnN0VGltZSkgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgIHZhciBhcmc7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFyZyA9ICcnOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzW2ldID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICBhcmcgKz0gJ1xuWycgKyBpICsgJ10gJzsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGFyZ3VtZW50c1swXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnICs9IGtleSArICc6ICcgKyBhcmd1bWVudHNbMF1ba2V5XSArICcsICc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYXJnID0gYXJnLnNsaWNlKDAsIC0yKTsgLy8gUmVtb3ZlIHRyYWlsaW5nIGNvbW1hIGFuZCBzcGFjZQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZyA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3YXJuKG1zZyArICdcbkFyZ3VtZW50czogJyArIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3MpLmpvaW4oJycpICsgJ1xuJyArIChuZXcgRXJyb3IoKSkuc3RhY2spOwogICAgICAgICAgICAgICAgZmlyc3RUaW1lID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwgZm4pOwogICAgfQoKICAgIHZhciBkZXByZWNhdGlvbnMgPSB7fTsKCiAgICBmdW5jdGlvbiBkZXByZWNhdGVTaW1wbGUobmFtZSwgbXNnKSB7CiAgICAgICAgaWYgKGhvb2tzLmRlcHJlY2F0aW9uSGFuZGxlciAhPSBudWxsKSB7CiAgICAgICAgICAgIGhvb2tzLmRlcHJlY2F0aW9uSGFuZGxlcihuYW1lLCBtc2cpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlcHJlY2F0aW9uc1tuYW1lXSkgewogICAgICAgICAgICB3YXJuKG1zZyk7CiAgICAgICAgICAgIGRlcHJlY2F0aW9uc1tuYW1lXSA9IHRydWU7CiAgICAgICAgfQogICAgfQoKICAgIGhvb2tzLnN1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5ncyA9IGZhbHNlOwogICAgaG9va3MuZGVwcmVjYXRpb25IYW5kbGVyID0gbnVsbDsKCiAgICBmdW5jdGlvbiBpc0Z1bmN0aW9uKGlucHV0KSB7CiAgICAgICAgcmV0dXJuIGlucHV0IGluc3RhbmNlb2YgRnVuY3Rpb24gfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgRnVuY3Rpb25dJzsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXQgKGNvbmZpZykgewogICAgICAgIHZhciBwcm9wLCBpOwogICAgICAgIGZvciAoaSBpbiBjb25maWcpIHsKICAgICAgICAgICAgcHJvcCA9IGNvbmZpZ1tpXTsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvcCkpIHsKICAgICAgICAgICAgICAgIHRoaXNbaV0gPSBwcm9wOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc1snXycgKyBpXSA9IHByb3A7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5fY29uZmlnID0gY29uZmlnOwogICAgICAgIC8vIExlbmllbnQgb3JkaW5hbCBwYXJzaW5nIGFjY2VwdHMganVzdCBhIG51bWJlciBpbiBhZGRpdGlvbiB0bwogICAgICAgIC8vIG51bWJlciArIChwb3NzaWJseSkgc3R1ZmYgY29taW5nIGZyb20gX2RheU9mTW9udGhPcmRpbmFsUGFyc2UuCiAgICAgICAgLy8gVE9ETzogUmVtb3ZlICJvcmRpbmFsUGFyc2UiIGZhbGxiYWNrIGluIG5leHQgbWFqb3IgcmVsZWFzZS4KICAgICAgICB0aGlzLl9kYXlPZk1vbnRoT3JkaW5hbFBhcnNlTGVuaWVudCA9IG5ldyBSZWdFeHAoCiAgICAgICAgICAgICh0aGlzLl9kYXlPZk1vbnRoT3JkaW5hbFBhcnNlLnNvdXJjZSB8fCB0aGlzLl9vcmRpbmFsUGFyc2Uuc291cmNlKSArCiAgICAgICAgICAgICAgICAnfCcgKyAoL1xkezEsMn0vKS5zb3VyY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIG1lcmdlQ29uZmlncyhwYXJlbnRDb25maWcsIGNoaWxkQ29uZmlnKSB7CiAgICAgICAgdmFyIHJlcyA9IGV4dGVuZCh7fSwgcGFyZW50Q29uZmlnKSwgcHJvcDsKICAgICAgICBmb3IgKHByb3AgaW4gY2hpbGRDb25maWcpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3AoY2hpbGRDb25maWcsIHByb3ApKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QocGFyZW50Q29uZmlnW3Byb3BdKSAmJiBpc09iamVjdChjaGlsZENvbmZpZ1twcm9wXSkpIHsKICAgICAgICAgICAgICAgICAgICByZXNbcHJvcF0gPSB7fTsKICAgICAgICAgICAgICAgICAgICBleHRlbmQocmVzW3Byb3BdLCBwYXJlbnRDb25maWdbcHJvcF0pOwogICAgICAgICAgICAgICAgICAgIGV4dGVuZChyZXNbcHJvcF0sIGNoaWxkQ29uZmlnW3Byb3BdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRDb25maWdbcHJvcF0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJlc1twcm9wXSA9IGNoaWxkQ29uZmlnW3Byb3BdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgcmVzW3Byb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAocHJvcCBpbiBwYXJlbnRDb25maWcpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3AocGFyZW50Q29uZmlnLCBwcm9wKSAmJgogICAgICAgICAgICAgICAgICAgICFoYXNPd25Qcm9wKGNoaWxkQ29uZmlnLCBwcm9wKSAmJgogICAgICAgICAgICAgICAgICAgIGlzT2JqZWN0KHBhcmVudENvbmZpZ1twcm9wXSkpIHsKICAgICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSBjaGFuZ2VzIHRvIHByb3BlcnRpZXMgZG9uJ3QgbW9kaWZ5IHBhcmVudCBjb25maWcKICAgICAgICAgICAgICAgIHJlc1twcm9wXSA9IGV4dGVuZCh7fSwgcmVzW3Byb3BdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIGZ1bmN0aW9uIExvY2FsZShjb25maWcpIHsKICAgICAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5zZXQoY29uZmlnKTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIGtleXM7CgogICAgaWYgKE9iamVjdC5rZXlzKSB7CiAgICAgICAga2V5cyA9IE9iamVjdC5rZXlzOwogICAgfSBlbHNlIHsKICAgICAgICBrZXlzID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICB2YXIgaSwgcmVzID0gW107CiAgICAgICAgICAgIGZvciAoaSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wKG9iaiwgaSkpIHsKICAgICAgICAgICAgICAgICAgICByZXMucHVzaChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIGRlZmF1bHRDYWxlbmRhciA9IHsKICAgICAgICBzYW1lRGF5IDogJ1tUb2RheSBhdF0gTFQnLAogICAgICAgIG5leHREYXkgOiAnW1RvbW9ycm93IGF0XSBMVCcsCiAgICAgICAgbmV4dFdlZWsgOiAnZGRkZCBbYXRdIExUJywKICAgICAgICBsYXN0RGF5IDogJ1tZZXN0ZXJkYXkgYXRdIExUJywKICAgICAgICBsYXN0V2VlayA6ICdbTGFzdF0gZGRkZCBbYXRdIExUJywKICAgICAgICBzYW1lRWxzZSA6ICdMJwogICAgfTsKCiAgICBmdW5jdGlvbiBjYWxlbmRhciAoa2V5LCBtb20sIG5vdykgewogICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLl9jYWxlbmRhcltrZXldIHx8IHRoaXMuX2NhbGVuZGFyWydzYW1lRWxzZSddOwogICAgICAgIHJldHVybiBpc0Z1bmN0aW9uKG91dHB1dCkgPyBvdXRwdXQuY2FsbChtb20sIG5vdykgOiBvdXRwdXQ7CiAgICB9CgogICAgdmFyIGRlZmF1bHRMb25nRGF0ZUZvcm1hdCA9IHsKICAgICAgICBMVFMgIDogJ2g6bW06c3MgQScsCiAgICAgICAgTFQgICA6ICdoOm1tIEEnLAogICAgICAgIEwgICAgOiAnTU0vREQvWVlZWScsCiAgICAgICAgTEwgICA6ICdNTU1NIEQsIFlZWVknLAogICAgICAgIExMTCAgOiAnTU1NTSBELCBZWVlZIGg6bW0gQScsCiAgICAgICAgTExMTCA6ICdkZGRkLCBNTU1NIEQsIFlZWVkgaDptbSBBJwogICAgfTsKCiAgICBmdW5jdGlvbiBsb25nRGF0ZUZvcm1hdCAoa2V5KSB7CiAgICAgICAgdmFyIGZvcm1hdCA9IHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleV0sCiAgICAgICAgICAgIGZvcm1hdFVwcGVyID0gdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5LnRvVXBwZXJDYXNlKCldOwoKICAgICAgICBpZiAoZm9ybWF0IHx8ICFmb3JtYXRVcHBlcikgewogICAgICAgICAgICByZXR1cm4gZm9ybWF0OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5XSA9IGZvcm1hdFVwcGVyLnJlcGxhY2UoL01NTU18TU18RER8ZGRkZC9nLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgIHJldHVybiB2YWwuc2xpY2UoMSk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXldOwogICAgfQoKICAgIHZhciBkZWZhdWx0SW52YWxpZERhdGUgPSAnSW52YWxpZCBkYXRlJzsKCiAgICBmdW5jdGlvbiBpbnZhbGlkRGF0ZSAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ludmFsaWREYXRlOwogICAgfQoKICAgIHZhciBkZWZhdWx0T3JkaW5hbCA9ICclZCc7CiAgICB2YXIgZGVmYXVsdERheU9mTW9udGhPcmRpbmFsUGFyc2UgPSAvXGR7MSwyfS87CgogICAgZnVuY3Rpb24gb3JkaW5hbCAobnVtYmVyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX29yZGluYWwucmVwbGFjZSgnJWQnLCBudW1iZXIpOwogICAgfQoKICAgIHZhciBkZWZhdWx0UmVsYXRpdmVUaW1lID0gewogICAgICAgIGZ1dHVyZSA6ICdpbiAlcycsCiAgICAgICAgcGFzdCAgIDogJyVzIGFnbycsCiAgICAgICAgcyAgOiAnYSBmZXcgc2Vjb25kcycsCiAgICAgICAgc3MgOiAnJWQgc2Vjb25kcycsCiAgICAgICAgbSAgOiAnYSBtaW51dGUnLAogICAgICAgIG1tIDogJyVkIG1pbnV0ZXMnLAogICAgICAgIGggIDogJ2FuIGhvdXInLAogICAgICAgIGhoIDogJyVkIGhvdXJzJywKICAgICAgICBkICA6ICdhIGRheScsCiAgICAgICAgZGQgOiAnJWQgZGF5cycsCiAgICAgICAgTSAgOiAnYSBtb250aCcsCiAgICAgICAgTU0gOiAnJWQgbW9udGhzJywKICAgICAgICB5ICA6ICdhIHllYXInLAogICAgICAgIHl5IDogJyVkIHllYXJzJwogICAgfTsKCiAgICBmdW5jdGlvbiByZWxhdGl2ZVRpbWUgKG51bWJlciwgd2l0aG91dFN1ZmZpeCwgc3RyaW5nLCBpc0Z1dHVyZSkgewogICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLl9yZWxhdGl2ZVRpbWVbc3RyaW5nXTsKICAgICAgICByZXR1cm4gKGlzRnVuY3Rpb24ob3V0cHV0KSkgPwogICAgICAgICAgICBvdXRwdXQobnVtYmVyLCB3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKSA6CiAgICAgICAgICAgIG91dHB1dC5yZXBsYWNlKC8lZC9pLCBudW1iZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhc3RGdXR1cmUgKGRpZmYsIG91dHB1dCkgewogICAgICAgIHZhciBmb3JtYXQgPSB0aGlzLl9yZWxhdGl2ZVRpbWVbZGlmZiA+IDAgPyAnZnV0dXJlJyA6ICdwYXN0J107CiAgICAgICAgcmV0dXJuIGlzRnVuY3Rpb24oZm9ybWF0KSA/IGZvcm1hdChvdXRwdXQpIDogZm9ybWF0LnJlcGxhY2UoLyVzL2ksIG91dHB1dCk7CiAgICB9CgogICAgdmFyIGFsaWFzZXMgPSB7fTsKCiAgICBmdW5jdGlvbiBhZGRVbml0QWxpYXMgKHVuaXQsIHNob3J0aGFuZCkgewogICAgICAgIHZhciBsb3dlckNhc2UgPSB1bml0LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgYWxpYXNlc1tsb3dlckNhc2VdID0gYWxpYXNlc1tsb3dlckNhc2UgKyAncyddID0gYWxpYXNlc1tzaG9ydGhhbmRdID0gdW5pdDsKICAgIH0KCiAgICBmdW5jdGlvbiBub3JtYWxpemVVbml0cyh1bml0cykgewogICAgICAgIHJldHVybiB0eXBlb2YgdW5pdHMgPT09ICdzdHJpbmcnID8gYWxpYXNlc1t1bml0c10gfHwgYWxpYXNlc1t1bml0cy50b0xvd2VyQ2FzZSgpXSA6IHVuZGVmaW5lZDsKICAgIH0KCiAgICBmdW5jdGlvbiBub3JtYWxpemVPYmplY3RVbml0cyhpbnB1dE9iamVjdCkgewogICAgICAgIHZhciBub3JtYWxpemVkSW5wdXQgPSB7fSwKICAgICAgICAgICAgbm9ybWFsaXplZFByb3AsCiAgICAgICAgICAgIHByb3A7CgogICAgICAgIGZvciAocHJvcCBpbiBpbnB1dE9iamVjdCkgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcChpbnB1dE9iamVjdCwgcHJvcCkpIHsKICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRQcm9wID0gbm9ybWFsaXplVW5pdHMocHJvcCk7CiAgICAgICAgICAgICAgICBpZiAobm9ybWFsaXplZFByb3ApIHsKICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkSW5wdXRbbm9ybWFsaXplZFByb3BdID0gaW5wdXRPYmplY3RbcHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBub3JtYWxpemVkSW5wdXQ7CiAgICB9CgogICAgdmFyIHByaW9yaXRpZXMgPSB7fTsKCiAgICBmdW5jdGlvbiBhZGRVbml0UHJpb3JpdHkodW5pdCwgcHJpb3JpdHkpIHsKICAgICAgICBwcmlvcml0aWVzW3VuaXRdID0gcHJpb3JpdHk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UHJpb3JpdGl6ZWRVbml0cyh1bml0c09iaikgewogICAgICAgIHZhciB1bml0cyA9IFtdOwogICAgICAgIGZvciAodmFyIHUgaW4gdW5pdHNPYmopIHsKICAgICAgICAgICAgdW5pdHMucHVzaCh7dW5pdDogdSwgcHJpb3JpdHk6IHByaW9yaXRpZXNbdV19KTsKICAgICAgICB9CiAgICAgICAgdW5pdHMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICByZXR1cm4gYS5wcmlvcml0eSAtIGIucHJpb3JpdHk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHVuaXRzOwogICAgfQoKICAgIGZ1bmN0aW9uIHplcm9GaWxsKG51bWJlciwgdGFyZ2V0TGVuZ3RoLCBmb3JjZVNpZ24pIHsKICAgICAgICB2YXIgYWJzTnVtYmVyID0gJycgKyBNYXRoLmFicyhudW1iZXIpLAogICAgICAgICAgICB6ZXJvc1RvRmlsbCA9IHRhcmdldExlbmd0aCAtIGFic051bWJlci5sZW5ndGgsCiAgICAgICAgICAgIHNpZ24gPSBudW1iZXIgPj0gMDsKICAgICAgICByZXR1cm4gKHNpZ24gPyAoZm9yY2VTaWduID8gJysnIDogJycpIDogJy0nKSArCiAgICAgICAgICAgIE1hdGgucG93KDEwLCBNYXRoLm1heCgwLCB6ZXJvc1RvRmlsbCkpLnRvU3RyaW5nKCkuc3Vic3RyKDEpICsgYWJzTnVtYmVyOwogICAgfQoKICAgIHZhciBmb3JtYXR0aW5nVG9rZW5zID0gLyhcW1teXFtdKlxdKXwoXFwpPyhbSGhdbW0oc3MpP3xNb3xNTT9NP00/fERvfERERG98REQ/RD9EP3xkZGQ/ZD98ZG8/fHdbb3x3XT98V1tvfFddP3xRbz98WVlZWVlZfFlZWVlZfFlZWVl8WVl8Z2coZ2dnPyk/fEdHKEdHRz8pP3xlfEV8YXxBfGhoP3xISD98a2s/fG1tP3xzcz98U3sxLDl9fHh8WHx6ej98Wlo/fC4pL2c7CgogICAgdmFyIGxvY2FsRm9ybWF0dGluZ1Rva2VucyA9IC8oXFtbXlxbXSpcXSl8KFxcKT8oTFRTfExUfExMP0w/TD98bHsxLDR9KS9nOwoKICAgIHZhciBmb3JtYXRGdW5jdGlvbnMgPSB7fTsKCiAgICB2YXIgZm9ybWF0VG9rZW5GdW5jdGlvbnMgPSB7fTsKCiAgICAvLyB0b2tlbjogICAgJ00nCiAgICAvLyBwYWRkZWQ6ICAgWydNTScsIDJdCiAgICAvLyBvcmRpbmFsOiAgJ01vJwogICAgLy8gY2FsbGJhY2s6IGZ1bmN0aW9uICgpIHsgdGhpcy5tb250aCgpICsgMSB9CiAgICBmdW5jdGlvbiBhZGRGb3JtYXRUb2tlbiAodG9rZW4sIHBhZGRlZCwgb3JkaW5hbCwgY2FsbGJhY2spIHsKICAgICAgICB2YXIgZnVuYyA9IGNhbGxiYWNrOwogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tjYWxsYmFja10oKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuKSB7CiAgICAgICAgICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zW3Rva2VuXSA9IGZ1bmM7CiAgICAgICAgfQogICAgICAgIGlmIChwYWRkZWQpIHsKICAgICAgICAgICAgZm9ybWF0VG9rZW5GdW5jdGlvbnNbcGFkZGVkWzBdXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB6ZXJvRmlsbChmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksIHBhZGRlZFsxXSwgcGFkZGVkWzJdKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKG9yZGluYWwpIHsKICAgICAgICAgICAgZm9ybWF0VG9rZW5GdW5jdGlvbnNbb3JkaW5hbF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkub3JkaW5hbChmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksIHRva2VuKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcmVtb3ZlRm9ybWF0dGluZ1Rva2VucyhpbnB1dCkgewogICAgICAgIGlmIChpbnB1dC5tYXRjaCgvXFtbXHNcU10vKSkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvXlxbfFxdJC9nLCAnJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnB1dC5yZXBsYWNlKC9cXC9nLCAnJyk7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZUZvcm1hdEZ1bmN0aW9uKGZvcm1hdCkgewogICAgICAgIHZhciBhcnJheSA9IGZvcm1hdC5tYXRjaChmb3JtYXR0aW5nVG9rZW5zKSwgaSwgbGVuZ3RoOwoKICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoZm9ybWF0VG9rZW5GdW5jdGlvbnNbYXJyYXlbaV1dKSB7CiAgICAgICAgICAgICAgICBhcnJheVtpXSA9IGZvcm1hdFRva2VuRnVuY3Rpb25zW2FycmF5W2ldXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFycmF5W2ldID0gcmVtb3ZlRm9ybWF0dGluZ1Rva2VucyhhcnJheVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAobW9tKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSAnJywgaTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvdXRwdXQgKz0gaXNGdW5jdGlvbihhcnJheVtpXSkgPyBhcnJheVtpXS5jYWxsKG1vbSwgZm9ybWF0KSA6IGFycmF5W2ldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfTsKICAgIH0KCiAgICAvLyBmb3JtYXQgZGF0ZSB1c2luZyBuYXRpdmUgZGF0ZSBvYmplY3QKICAgIGZ1bmN0aW9uIGZvcm1hdE1vbWVudChtLCBmb3JtYXQpIHsKICAgICAgICBpZiAoIW0uaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBtLmxvY2FsZURhdGEoKS5pbnZhbGlkRGF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgZm9ybWF0ID0gZXhwYW5kRm9ybWF0KGZvcm1hdCwgbS5sb2NhbGVEYXRhKCkpOwogICAgICAgIGZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdID0gZm9ybWF0RnVuY3Rpb25zW2Zvcm1hdF0gfHwgbWFrZUZvcm1hdEZ1bmN0aW9uKGZvcm1hdCk7CgogICAgICAgIHJldHVybiBmb3JtYXRGdW5jdGlvbnNbZm9ybWF0XShtKTsKICAgIH0KCiAgICBmdW5jdGlvbiBleHBhbmRGb3JtYXQoZm9ybWF0LCBsb2NhbGUpIHsKICAgICAgICB2YXIgaSA9IDU7CgogICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VMb25nRGF0ZUZvcm1hdFRva2VucyhpbnB1dCkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxlLmxvbmdEYXRlRm9ybWF0KGlucHV0KSB8fCBpbnB1dDsKICAgICAgICB9CgogICAgICAgIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy5sYXN0SW5kZXggPSAwOwogICAgICAgIHdoaWxlIChpID49IDAgJiYgbG9jYWxGb3JtYXR0aW5nVG9rZW5zLnRlc3QoZm9ybWF0KSkgewogICAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQucmVwbGFjZShsb2NhbEZvcm1hdHRpbmdUb2tlbnMsIHJlcGxhY2VMb25nRGF0ZUZvcm1hdFRva2Vucyk7CiAgICAgICAgICAgIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy5sYXN0SW5kZXggPSAwOwogICAgICAgICAgICBpIC09IDE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZm9ybWF0OwogICAgfQoKICAgIHZhciBtYXRjaDEgICAgICAgICA9IC9cZC87ICAgICAgICAgICAgLy8gICAgICAgMCAtIDkKICAgIHZhciBtYXRjaDIgICAgICAgICA9IC9cZFxkLzsgICAgICAgICAgLy8gICAgICAwMCAtIDk5CiAgICB2YXIgbWF0Y2gzICAgICAgICAgPSAvXGR7M30vOyAgICAgICAgIC8vICAgICAwMDAgLSA5OTkKICAgIHZhciBtYXRjaDQgICAgICAgICA9IC9cZHs0fS87ICAgICAgICAgLy8gICAgMDAwMCAtIDk5OTkKICAgIHZhciBtYXRjaDYgICAgICAgICA9IC9bKy1dP1xkezZ9LzsgICAgLy8gLTk5OTk5OSAtIDk5OTk5OQogICAgdmFyIG1hdGNoMXRvMiAgICAgID0gL1xkXGQ/LzsgICAgICAgICAvLyAgICAgICAwIC0gOTkKICAgIHZhciBtYXRjaDN0bzQgICAgICA9IC9cZFxkXGRcZD8vOyAgICAgLy8gICAgIDk5OSAtIDk5OTkKICAgIHZhciBtYXRjaDV0bzYgICAgICA9IC9cZFxkXGRcZFxkXGQ/LzsgLy8gICA5OTk5OSAtIDk5OTk5OQogICAgdmFyIG1hdGNoMXRvMyAgICAgID0gL1xkezEsM30vOyAgICAgICAvLyAgICAgICAwIC0gOTk5CiAgICB2YXIgbWF0Y2gxdG80ICAgICAgPSAvXGR7MSw0fS87ICAgICAgIC8vICAgICAgIDAgLSA5OTk5CiAgICB2YXIgbWF0Y2gxdG82ICAgICAgPSAvWystXT9cZHsxLDZ9LzsgIC8vIC05OTk5OTkgLSA5OTk5OTkKCiAgICB2YXIgbWF0Y2hVbnNpZ25lZCAgPSAvXGQrLzsgICAgICAgICAgIC8vICAgICAgIDAgLSBpbmYKICAgIHZhciBtYXRjaFNpZ25lZCAgICA9IC9bKy1dP1xkKy87ICAgICAgLy8gICAgLWluZiAtIGluZgoKICAgIHZhciBtYXRjaE9mZnNldCAgICA9IC9afFsrLV1cZFxkOj9cZFxkL2dpOyAvLyArMDA6MDAgLTAwOjAwICswMDAwIC0wMDAwIG9yIFoKICAgIHZhciBtYXRjaFNob3J0T2Zmc2V0ID0gL1p8WystXVxkXGQoPzo6P1xkXGQpPy9naTsgLy8gKzAwIC0wMCArMDA6MDAgLTAwOjAwICswMDAwIC0wMDAwIG9yIFoKCiAgICB2YXIgbWF0Y2hUaW1lc3RhbXAgPSAvWystXT9cZCsoXC5cZHsxLDN9KT8vOyAvLyAxMjM0NTY3ODkgMTIzNDU2Nzg5LjEyMwoKICAgIC8vIGFueSB3b3JkIChvciB0d28pIGNoYXJhY3RlcnMgb3IgbnVtYmVycyBpbmNsdWRpbmcgdHdvL3RocmVlIHdvcmQgbW9udGggaW4gYXJhYmljLgogICAgLy8gaW5jbHVkZXMgc2NvdHRpc2ggZ2FlbGljIHR3byB3b3JkIGFuZCBoeXBoZW5hdGVkIG1vbnRocwogICAgdmFyIG1hdGNoV29yZCA9IC9bMC05XXswLDI1Nn1bJ2Etelx1MDBBMC1cdTA1RkZcdTA3MDAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGMDdcdUZGMTAtXHVGRkVGXXsxLDI1Nn18W1x1MDYwMC1cdTA2RkZcL117MSwyNTZ9KFxzKj9bXHUwNjAwLVx1MDZGRl17MSwyNTZ9KXsxLDJ9L2k7CgogICAgdmFyIHJlZ2V4ZXMgPSB7fTsKCiAgICBmdW5jdGlvbiBhZGRSZWdleFRva2VuICh0b2tlbiwgcmVnZXgsIHN0cmljdFJlZ2V4KSB7CiAgICAgICAgcmVnZXhlc1t0b2tlbl0gPSBpc0Z1bmN0aW9uKHJlZ2V4KSA/IHJlZ2V4IDogZnVuY3Rpb24gKGlzU3RyaWN0LCBsb2NhbGVEYXRhKSB7CiAgICAgICAgICAgIHJldHVybiAoaXNTdHJpY3QgJiYgc3RyaWN0UmVnZXgpID8gc3RyaWN0UmVnZXggOiByZWdleDsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFBhcnNlUmVnZXhGb3JUb2tlbiAodG9rZW4sIGNvbmZpZykgewogICAgICAgIGlmICghaGFzT3duUHJvcChyZWdleGVzLCB0b2tlbikpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAodW5lc2NhcGVGb3JtYXQodG9rZW4pKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZWdleGVzW3Rva2VuXShjb25maWcuX3N0cmljdCwgY29uZmlnLl9sb2NhbGUpOwogICAgfQoKICAgIC8vIENvZGUgZnJvbSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM1NjE0OTMvaXMtdGhlcmUtYS1yZWdleHAtZXNjYXBlLWZ1bmN0aW9uLWluLWphdmFzY3JpcHQKICAgIGZ1bmN0aW9uIHVuZXNjYXBlRm9ybWF0KHMpIHsKICAgICAgICByZXR1cm4gcmVnZXhFc2NhcGUocy5yZXBsYWNlKCdcXCcsICcnKS5yZXBsYWNlKC9cXChcWyl8XFwoXF0pfFxbKFteXF1cW10qKVxdfFxcKC4pL2csIGZ1bmN0aW9uIChtYXRjaGVkLCBwMSwgcDIsIHAzLCBwNCkgewogICAgICAgICAgICByZXR1cm4gcDEgfHwgcDIgfHwgcDMgfHwgcDQ7CiAgICAgICAgfSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlZ2V4RXNjYXBlKHMpIHsKICAgICAgICByZXR1cm4gcy5yZXBsYWNlKC9bLVwvXFxeJCorPy4oKXxbXF17fV0vZywgJ1xcJCYnKTsKICAgIH0KCiAgICB2YXIgdG9rZW5zID0ge307CgogICAgZnVuY3Rpb24gYWRkUGFyc2VUb2tlbiAodG9rZW4sIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIGksIGZ1bmMgPSBjYWxsYmFjazsKICAgICAgICBpZiAodHlwZW9mIHRva2VuID09PSAnc3RyaW5nJykgewogICAgICAgICAgICB0b2tlbiA9IFt0b2tlbl07CiAgICAgICAgfQogICAgICAgIGlmIChpc051bWJlcihjYWxsYmFjaykpIHsKICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChpbnB1dCwgYXJyYXkpIHsKICAgICAgICAgICAgICAgIGFycmF5W2NhbGxiYWNrXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRva2VuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRva2Vuc1t0b2tlbltpXV0gPSBmdW5jOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhZGRXZWVrUGFyc2VUb2tlbiAodG9rZW4sIGNhbGxiYWNrKSB7CiAgICAgICAgYWRkUGFyc2VUb2tlbih0b2tlbiwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnLCB0b2tlbikgewogICAgICAgICAgICBjb25maWcuX3cgPSBjb25maWcuX3cgfHwge307CiAgICAgICAgICAgIGNhbGxiYWNrKGlucHV0LCBjb25maWcuX3csIGNvbmZpZywgdG9rZW4pOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZFRpbWVUb0FycmF5RnJvbVRva2VuKHRva2VuLCBpbnB1dCwgY29uZmlnKSB7CiAgICAgICAgaWYgKGlucHV0ICE9IG51bGwgJiYgaGFzT3duUHJvcCh0b2tlbnMsIHRva2VuKSkgewogICAgICAgICAgICB0b2tlbnNbdG9rZW5dKGlucHV0LCBjb25maWcuX2EsIGNvbmZpZywgdG9rZW4pOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgWUVBUiA9IDA7CiAgICB2YXIgTU9OVEggPSAxOwogICAgdmFyIERBVEUgPSAyOwogICAgdmFyIEhPVVIgPSAzOwogICAgdmFyIE1JTlVURSA9IDQ7CiAgICB2YXIgU0VDT05EID0gNTsKICAgIHZhciBNSUxMSVNFQ09ORCA9IDY7CiAgICB2YXIgV0VFSyA9IDc7CiAgICB2YXIgV0VFS0RBWSA9IDg7CgogICAgLy8gRk9STUFUVElORwoKICAgIGFkZEZvcm1hdFRva2VuKCdZJywgMCwgMCwgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB5ID0gdGhpcy55ZWFyKCk7CiAgICAgICAgcmV0dXJuIHkgPD0gOTk5OSA/ICcnICsgeSA6ICcrJyArIHk7CiAgICB9KTsKCiAgICBhZGRGb3JtYXRUb2tlbigwLCBbJ1lZJywgMl0sIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55ZWFyKCkgJSAxMDA7CiAgICB9KTsKCiAgICBhZGRGb3JtYXRUb2tlbigwLCBbJ1lZWVknLCAgIDRdLCAgICAgICAwLCAneWVhcicpOwogICAgYWRkRm9ybWF0VG9rZW4oMCwgWydZWVlZWScsICA1XSwgICAgICAgMCwgJ3llYXInKTsKICAgIGFkZEZvcm1hdFRva2VuKDAsIFsnWVlZWVlZJywgNiwgdHJ1ZV0sIDAsICd5ZWFyJyk7CgogICAgLy8gQUxJQVNFUwoKICAgIGFkZFVuaXRBbGlhcygneWVhcicsICd5Jyk7CgogICAgLy8gUFJJT1JJVElFUwoKICAgIGFkZFVuaXRQcmlvcml0eSgneWVhcicsIDEpOwoKICAgIC8vIFBBUlNJTkcKCiAgICBhZGRSZWdleFRva2VuKCdZJywgICAgICBtYXRjaFNpZ25lZCk7CiAgICBhZGRSZWdleFRva2VuKCdZWScsICAgICBtYXRjaDF0bzIsIG1hdGNoMik7CiAgICBhZGRSZWdleFRva2VuKCdZWVlZJywgICBtYXRjaDF0bzQsIG1hdGNoNCk7CiAgICBhZGRSZWdleFRva2VuKCdZWVlZWScsICBtYXRjaDF0bzYsIG1hdGNoNik7CiAgICBhZGRSZWdleFRva2VuKCdZWVlZWVknLCBtYXRjaDF0bzYsIG1hdGNoNik7CgogICAgYWRkUGFyc2VUb2tlbihbJ1lZWVlZJywgJ1lZWVlZWSddLCBZRUFSKTsKICAgIGFkZFBhcnNlVG9rZW4oJ1lZWVknLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICAgICAgYXJyYXlbWUVBUl0gPSBpbnB1dC5sZW5ndGggPT09IDIgPyBob29rcy5wYXJzZVR3b0RpZ2l0WWVhcihpbnB1dCkgOiB0b0ludChpbnB1dCk7CiAgICB9KTsKICAgIGFkZFBhcnNlVG9rZW4oJ1lZJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSkgewogICAgICAgIGFycmF5W1lFQVJdID0gaG9va3MucGFyc2VUd29EaWdpdFllYXIoaW5wdXQpOwogICAgfSk7CiAgICBhZGRQYXJzZVRva2VuKCdZJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSkgewogICAgICAgIGFycmF5W1lFQVJdID0gcGFyc2VJbnQoaW5wdXQsIDEwKTsKICAgIH0pOwoKICAgIC8vIEhFTFBFUlMKCiAgICBmdW5jdGlvbiBkYXlzSW5ZZWFyKHllYXIpIHsKICAgICAgICByZXR1cm4gaXNMZWFwWWVhcih5ZWFyKSA/IDM2NiA6IDM2NTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0xlYXBZZWFyKHllYXIpIHsKICAgICAgICByZXR1cm4gKHllYXIgJSA0ID09PSAwICYmIHllYXIgJSAxMDAgIT09IDApIHx8IHllYXIgJSA0MDAgPT09IDA7CiAgICB9CgogICAgLy8gSE9PS1MKCiAgICBob29rcy5wYXJzZVR3b0RpZ2l0WWVhciA9IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHJldHVybiB0b0ludChpbnB1dCkgKyAodG9JbnQoaW5wdXQpID4gNjggPyAxOTAwIDogMjAwMCk7CiAgICB9OwoKICAgIC8vIE1PTUVOVFMKCiAgICB2YXIgZ2V0U2V0WWVhciA9IG1ha2VHZXRTZXQoJ0Z1bGxZZWFyJywgdHJ1ZSk7CgogICAgZnVuY3Rpb24gZ2V0SXNMZWFwWWVhciAoKSB7CiAgICAgICAgcmV0dXJuIGlzTGVhcFllYXIodGhpcy55ZWFyKCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VHZXRTZXQgKHVuaXQsIGtlZXBUaW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0JDEodGhpcywgdW5pdCwgdmFsdWUpOwogICAgICAgICAgICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMsIGtlZXBUaW1lKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGdldCh0aGlzLCB1bml0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0IChtb20sIHVuaXQpIHsKICAgICAgICByZXR1cm4gbW9tLmlzVmFsaWQoKSA/CiAgICAgICAgICAgIG1vbS5fZFsnZ2V0JyArIChtb20uX2lzVVRDID8gJ1VUQycgOiAnJykgKyB1bml0XSgpIDogTmFOOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldCQxIChtb20sIHVuaXQsIHZhbHVlKSB7CiAgICAgICAgaWYgKG1vbS5pc1ZhbGlkKCkgJiYgIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICBpZiAodW5pdCA9PT0gJ0Z1bGxZZWFyJyAmJiBpc0xlYXBZZWFyKG1vbS55ZWFyKCkpICYmIG1vbS5tb250aCgpID09PSAxICYmIG1vbS5kYXRlKCkgPT09IDI5KSB7CiAgICAgICAgICAgICAgICBtb20uX2RbJ3NldCcgKyAobW9tLl9pc1VUQyA/ICdVVEMnIDogJycpICsgdW5pdF0odmFsdWUsIG1vbS5tb250aCgpLCBkYXlzSW5Nb250aCh2YWx1ZSwgbW9tLm1vbnRoKCkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG1vbS5fZFsnc2V0JyArIChtb20uX2lzVVRDID8gJ1VUQycgOiAnJykgKyB1bml0XSh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gTU9NRU5UUwoKICAgIGZ1bmN0aW9uIHN0cmluZ0dldCAodW5pdHMpIHsKICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICBpZiAoaXNGdW5jdGlvbih0aGlzW3VuaXRzXSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbdW5pdHNdKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQoKCiAgICBmdW5jdGlvbiBzdHJpbmdTZXQgKHVuaXRzLCB2YWx1ZSkgewogICAgICAgIGlmICh0eXBlb2YgdW5pdHMgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplT2JqZWN0VW5pdHModW5pdHMpOwogICAgICAgICAgICB2YXIgcHJpb3JpdGl6ZWQgPSBnZXRQcmlvcml0aXplZFVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmlvcml0aXplZC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdGhpc1twcmlvcml0aXplZFtpXS51bml0XSh1bml0c1twcmlvcml0aXplZFtpXS51bml0XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24odGhpc1t1bml0c10pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1t1bml0c10odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGZ1bmN0aW9uIG1vZChuLCB4KSB7CiAgICAgICAgcmV0dXJuICgobiAlIHgpICsgeCkgJSB4OwogICAgfQoKICAgIHZhciBpbmRleE9mOwoKICAgIGlmIChBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewogICAgICAgIGluZGV4T2YgPSBBcnJheS5wcm90b3R5cGUuaW5kZXhPZjsKICAgIH0gZWxzZSB7CiAgICAgICAgaW5kZXhPZiA9IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgICAgIC8vIEkga25vdwogICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzW2ldID09PSBvKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZGF5c0luTW9udGgoeWVhciwgbW9udGgpIHsKICAgICAgICBpZiAoaXNOYU4oeWVhcikgfHwgaXNOYU4obW9udGgpKSB7CiAgICAgICAgICAgIHJldHVybiBOYU47CiAgICAgICAgfQogICAgICAgIHZhciBtb2RNb250aCA9IG1vZChtb250aCwgMTIpOwogICAgICAgIHllYXIgKz0gKG1vbnRoIC0gbW9kTW9udGgpIC8gMTI7CiAgICAgICAgcmV0dXJuIG1vZE1vbnRoID09PSAxID8gKGlzTGVhcFllYXIoeWVhcikgPyAyOSA6IDI4KSA6ICgzMSAtIG1vZE1vbnRoICUgNyAlIDIpOwogICAgfQoKICAgIC8vIEZPUk1BVFRJTkcKCiAgICBhZGRGb3JtYXRUb2tlbignTScsIFsnTU0nLCAyXSwgJ01vJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLm1vbnRoKCkgKyAxOwogICAgfSk7CgogICAgYWRkRm9ybWF0VG9rZW4oJ01NTScsIDAsIDAsIGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkubW9udGhzU2hvcnQodGhpcywgZm9ybWF0KTsKICAgIH0pOwoKICAgIGFkZEZvcm1hdFRva2VuKCdNTU1NJywgMCwgMCwgZnVuY3Rpb24gKGZvcm1hdCkgewogICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5tb250aHModGhpcywgZm9ybWF0KTsKICAgIH0pOwoKICAgIC8vIEFMSUFTRVMKCiAgICBhZGRVbml0QWxpYXMoJ21vbnRoJywgJ00nKTsKCiAgICAvLyBQUklPUklUWQoKICAgIGFkZFVuaXRQcmlvcml0eSgnbW9udGgnLCA4KTsKCiAgICAvLyBQQVJTSU5HCgogICAgYWRkUmVnZXhUb2tlbignTScsICAgIG1hdGNoMXRvMik7CiAgICBhZGRSZWdleFRva2VuKCdNTScsICAgbWF0Y2gxdG8yLCBtYXRjaDIpOwogICAgYWRkUmVnZXhUb2tlbignTU1NJywgIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICAgICAgcmV0dXJuIGxvY2FsZS5tb250aHNTaG9ydFJlZ2V4KGlzU3RyaWN0KTsKICAgIH0pOwogICAgYWRkUmVnZXhUb2tlbignTU1NTScsIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICAgICAgcmV0dXJuIGxvY2FsZS5tb250aHNSZWdleChpc1N0cmljdCk7CiAgICB9KTsKCiAgICBhZGRQYXJzZVRva2VuKFsnTScsICdNTSddLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICAgICAgYXJyYXlbTU9OVEhdID0gdG9JbnQoaW5wdXQpIC0gMTsKICAgIH0pOwoKICAgIGFkZFBhcnNlVG9rZW4oWydNTU0nLCAnTU1NTSddLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcsIHRva2VuKSB7CiAgICAgICAgdmFyIG1vbnRoID0gY29uZmlnLl9sb2NhbGUubW9udGhzUGFyc2UoaW5wdXQsIHRva2VuLCBjb25maWcuX3N0cmljdCk7CiAgICAgICAgLy8gaWYgd2UgZGlkbid0IGZpbmQgYSBtb250aCBuYW1lLCBtYXJrIHRoZSBkYXRlIGFzIGludmFsaWQuCiAgICAgICAgaWYgKG1vbnRoICE9IG51bGwpIHsKICAgICAgICAgICAgYXJyYXlbTU9OVEhdID0gbW9udGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuaW52YWxpZE1vbnRoID0gaW5wdXQ7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gTE9DQUxFUwoKICAgIHZhciBNT05USFNfSU5fRk9STUFUID0gL0Rbb0RdPyhcW1teXFtcXV0qXF18XHMpK01NTU0/LzsKICAgIHZhciBkZWZhdWx0TG9jYWxlTW9udGhzID0gJ0phbnVhcnlfRmVicnVhcnlfTWFyY2hfQXByaWxfTWF5X0p1bmVfSnVseV9BdWd1c3RfU2VwdGVtYmVyX09jdG9iZXJfTm92ZW1iZXJfRGVjZW1iZXInLnNwbGl0KCdfJyk7CiAgICBmdW5jdGlvbiBsb2NhbGVNb250aHMgKG0sIGZvcm1hdCkgewogICAgICAgIGlmICghbSkgewogICAgICAgICAgICByZXR1cm4gaXNBcnJheSh0aGlzLl9tb250aHMpID8gdGhpcy5fbW9udGhzIDoKICAgICAgICAgICAgICAgIHRoaXMuX21vbnRoc1snc3RhbmRhbG9uZSddOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNBcnJheSh0aGlzLl9tb250aHMpID8gdGhpcy5fbW9udGhzW20ubW9udGgoKV0gOgogICAgICAgICAgICB0aGlzLl9tb250aHNbKHRoaXMuX21vbnRocy5pc0Zvcm1hdCB8fCBNT05USFNfSU5fRk9STUFUKS50ZXN0KGZvcm1hdCkgPyAnZm9ybWF0JyA6ICdzdGFuZGFsb25lJ11bbS5tb250aCgpXTsKICAgIH0KCiAgICB2YXIgZGVmYXVsdExvY2FsZU1vbnRoc1Nob3J0ID0gJ0phbl9GZWJfTWFyX0Fwcl9NYXlfSnVuX0p1bF9BdWdfU2VwX09jdF9Ob3ZfRGVjJy5zcGxpdCgnXycpOwogICAgZnVuY3Rpb24gbG9jYWxlTW9udGhzU2hvcnQgKG0sIGZvcm1hdCkgewogICAgICAgIGlmICghbSkgewogICAgICAgICAgICByZXR1cm4gaXNBcnJheSh0aGlzLl9tb250aHNTaG9ydCkgPyB0aGlzLl9tb250aHNTaG9ydCA6CiAgICAgICAgICAgICAgICB0aGlzLl9tb250aHNTaG9ydFsnc3RhbmRhbG9uZSddOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNBcnJheSh0aGlzLl9tb250aHNTaG9ydCkgPyB0aGlzLl9tb250aHNTaG9ydFttLm1vbnRoKCldIDoKICAgICAgICAgICAgdGhpcy5fbW9udGhzU2hvcnRbTU9OVEhTX0lOX0ZPUk1BVC50ZXN0KGZvcm1hdCkgPyAnZm9ybWF0JyA6ICdzdGFuZGFsb25lJ11bbS5tb250aCgpXTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVTdHJpY3RQYXJzZShtb250aE5hbWUsIGZvcm1hdCwgc3RyaWN0KSB7CiAgICAgICAgdmFyIGksIGlpLCBtb20sIGxsYyA9IG1vbnRoTmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgICAgIGlmICghdGhpcy5fbW9udGhzUGFyc2UpIHsKICAgICAgICAgICAgLy8gdGhpcyBpcyBub3QgdXNlZAogICAgICAgICAgICB0aGlzLl9tb250aHNQYXJzZSA9IFtdOwogICAgICAgICAgICB0aGlzLl9sb25nTW9udGhzUGFyc2UgPSBbXTsKICAgICAgICAgICAgdGhpcy5fc2hvcnRNb250aHNQYXJzZSA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMTI7ICsraSkgewogICAgICAgICAgICAgICAgbW9tID0gY3JlYXRlVVRDKFsyMDAwLCBpXSk7CiAgICAgICAgICAgICAgICB0aGlzLl9zaG9ydE1vbnRoc1BhcnNlW2ldID0gdGhpcy5tb250aHNTaG9ydChtb20sICcnKS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fbG9uZ01vbnRoc1BhcnNlW2ldID0gdGhpcy5tb250aHMobW9tLCAnJykudG9Mb2NhbGVMb3dlckNhc2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHN0cmljdCkgewogICAgICAgICAgICBpZiAoZm9ybWF0ID09PSAnTU1NJykgewogICAgICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRNb250aHNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9sb25nTW9udGhzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGZvcm1hdCA9PT0gJ01NTScpIHsKICAgICAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX3Nob3J0TW9udGhzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgICAgICBpZiAoaWkgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fbG9uZ01vbnRoc1BhcnNlLCBsbGMpOwogICAgICAgICAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX2xvbmdNb250aHNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgICAgIGlmIChpaSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9zaG9ydE1vbnRoc1BhcnNlLCBsbGMpOwogICAgICAgICAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBsb2NhbGVNb250aHNQYXJzZSAobW9udGhOYW1lLCBmb3JtYXQsIHN0cmljdCkgewogICAgICAgIHZhciBpLCBtb20sIHJlZ2V4OwoKICAgICAgICBpZiAodGhpcy5fbW9udGhzUGFyc2VFeGFjdCkgewogICAgICAgICAgICByZXR1cm4gaGFuZGxlU3RyaWN0UGFyc2UuY2FsbCh0aGlzLCBtb250aE5hbWUsIGZvcm1hdCwgc3RyaWN0KTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5fbW9udGhzUGFyc2UpIHsKICAgICAgICAgICAgdGhpcy5fbW9udGhzUGFyc2UgPSBbXTsKICAgICAgICAgICAgdGhpcy5fbG9uZ01vbnRoc1BhcnNlID0gW107CiAgICAgICAgICAgIHRoaXMuX3Nob3J0TW9udGhzUGFyc2UgPSBbXTsKICAgICAgICB9CgogICAgICAgIC8vIFRPRE86IGFkZCBzb3J0aW5nCiAgICAgICAgLy8gU29ydGluZyBtYWtlcyBzdXJlIGlmIG9uZSBtb250aCAob3IgYWJicikgaXMgYSBwcmVmaXggb2YgYW5vdGhlcgogICAgICAgIC8vIHNlZSBzb3J0aW5nIGluIGNvbXB1dGVNb250aHNQYXJzZQogICAgICAgIGZvciAoaSA9IDA7IGkgPCAxMjsgaSsrKSB7CiAgICAgICAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQogICAgICAgICAgICBtb20gPSBjcmVhdGVVVEMoWzIwMDAsIGldKTsKICAgICAgICAgICAgaWYgKHN0cmljdCAmJiAhdGhpcy5fbG9uZ01vbnRoc1BhcnNlW2ldKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9sb25nTW9udGhzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKCdeJyArIHRoaXMubW9udGhzKG1vbSwgJycpLnJlcGxhY2UoJy4nLCAnJykgKyAnJCcsICdpJyk7CiAgICAgICAgICAgICAgICB0aGlzLl9zaG9ydE1vbnRoc1BhcnNlW2ldID0gbmV3IFJlZ0V4cCgnXicgKyB0aGlzLm1vbnRoc1Nob3J0KG1vbSwgJycpLnJlcGxhY2UoJy4nLCAnJykgKyAnJCcsICdpJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFzdHJpY3QgJiYgIXRoaXMuX21vbnRoc1BhcnNlW2ldKSB7CiAgICAgICAgICAgICAgICByZWdleCA9ICdeJyArIHRoaXMubW9udGhzKG1vbSwgJycpICsgJ3xeJyArIHRoaXMubW9udGhzU2hvcnQobW9tLCAnJyk7CiAgICAgICAgICAgICAgICB0aGlzLl9tb250aHNQYXJzZVtpXSA9IG5ldyBSZWdFeHAocmVnZXgucmVwbGFjZSgnLicsICcnKSwgJ2knKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB0ZXN0IHRoZSByZWdleAogICAgICAgICAgICBpZiAoc3RyaWN0ICYmIGZvcm1hdCA9PT0gJ01NTU0nICYmIHRoaXMuX2xvbmdNb250aHNQYXJzZVtpXS50ZXN0KG1vbnRoTmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmljdCAmJiBmb3JtYXQgPT09ICdNTU0nICYmIHRoaXMuX3Nob3J0TW9udGhzUGFyc2VbaV0udGVzdChtb250aE5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgfSBlbHNlIGlmICghc3RyaWN0ICYmIHRoaXMuX21vbnRoc1BhcnNlW2ldLnRlc3QobW9udGhOYW1lKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gTU9NRU5UUwoKICAgIGZ1bmN0aW9uIHNldE1vbnRoIChtb20sIHZhbHVlKSB7CiAgICAgICAgdmFyIGRheU9mTW9udGg7CgogICAgICAgIGlmICghbW9tLmlzVmFsaWQoKSkgewogICAgICAgICAgICAvLyBObyBvcAogICAgICAgICAgICByZXR1cm4gbW9tOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgaWYgKC9eXGQrJC8udGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gdG9JbnQodmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFsdWUgPSBtb20ubG9jYWxlRGF0YSgpLm1vbnRoc1BhcnNlKHZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIFRPRE86IEFub3RoZXIgc2lsZW50IGZhaWx1cmU/CiAgICAgICAgICAgICAgICBpZiAoIWlzTnVtYmVyKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtb207CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRheU9mTW9udGggPSBNYXRoLm1pbihtb20uZGF0ZSgpLCBkYXlzSW5Nb250aChtb20ueWVhcigpLCB2YWx1ZSkpOwogICAgICAgIG1vbS5fZFsnc2V0JyArIChtb20uX2lzVVRDID8gJ1VUQycgOiAnJykgKyAnTW9udGgnXSh2YWx1ZSwgZGF5T2ZNb250aCk7CiAgICAgICAgcmV0dXJuIG1vbTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRTZXRNb250aCAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBzZXRNb250aCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgICAgIGhvb2tzLnVwZGF0ZU9mZnNldCh0aGlzLCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGdldCh0aGlzLCAnTW9udGgnKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RGF5c0luTW9udGggKCkgewogICAgICAgIHJldHVybiBkYXlzSW5Nb250aCh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpKTsKICAgIH0KCiAgICB2YXIgZGVmYXVsdE1vbnRoc1Nob3J0UmVnZXggPSBtYXRjaFdvcmQ7CiAgICBmdW5jdGlvbiBtb250aHNTaG9ydFJlZ2V4IChpc1N0cmljdCkgewogICAgICAgIGlmICh0aGlzLl9tb250aHNQYXJzZUV4YWN0KSB7CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX21vbnRoc1JlZ2V4JykpIHsKICAgICAgICAgICAgICAgIGNvbXB1dGVNb250aHNQYXJzZS5jYWxsKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1N0cmljdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1Nob3J0U3RyaWN0UmVnZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzU2hvcnRSZWdleDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX21vbnRoc1Nob3J0UmVnZXgnKSkgewogICAgICAgICAgICAgICAgdGhpcy5fbW9udGhzU2hvcnRSZWdleCA9IGRlZmF1bHRNb250aHNTaG9ydFJlZ2V4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb250aHNTaG9ydFN0cmljdFJlZ2V4ICYmIGlzU3RyaWN0ID8KICAgICAgICAgICAgICAgIHRoaXMuX21vbnRoc1Nob3J0U3RyaWN0UmVnZXggOiB0aGlzLl9tb250aHNTaG9ydFJlZ2V4OwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgZGVmYXVsdE1vbnRoc1JlZ2V4ID0gbWF0Y2hXb3JkOwogICAgZnVuY3Rpb24gbW9udGhzUmVnZXggKGlzU3RyaWN0KSB7CiAgICAgICAgaWYgKHRoaXMuX21vbnRoc1BhcnNlRXhhY3QpIHsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfbW9udGhzUmVnZXgnKSkgewogICAgICAgICAgICAgICAgY29tcHV0ZU1vbnRoc1BhcnNlLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzU3RyaWN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzU3RyaWN0UmVnZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzUmVnZXg7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIWhhc093blByb3AodGhpcywgJ19tb250aHNSZWdleCcpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tb250aHNSZWdleCA9IGRlZmF1bHRNb250aHNSZWdleDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzU3RyaWN0UmVnZXggJiYgaXNTdHJpY3QgPwogICAgICAgICAgICAgICAgdGhpcy5fbW9udGhzU3RyaWN0UmVnZXggOiB0aGlzLl9tb250aHNSZWdleDsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY29tcHV0ZU1vbnRoc1BhcnNlICgpIHsKICAgICAgICBmdW5jdGlvbiBjbXBMZW5SZXYoYSwgYikgewogICAgICAgICAgICByZXR1cm4gYi5sZW5ndGggLSBhLmxlbmd0aDsKICAgICAgICB9CgogICAgICAgIHZhciBzaG9ydFBpZWNlcyA9IFtdLCBsb25nUGllY2VzID0gW10sIG1peGVkUGllY2VzID0gW10sCiAgICAgICAgICAgIGksIG1vbTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICAgICAgICAvLyBtYWtlIHRoZSByZWdleCBpZiB3ZSBkb24ndCBoYXZlIGl0IGFscmVhZHkKICAgICAgICAgICAgbW9tID0gY3JlYXRlVVRDKFsyMDAwLCBpXSk7CiAgICAgICAgICAgIHNob3J0UGllY2VzLnB1c2godGhpcy5tb250aHNTaG9ydChtb20sICcnKSk7CiAgICAgICAgICAgIGxvbmdQaWVjZXMucHVzaCh0aGlzLm1vbnRocyhtb20sICcnKSk7CiAgICAgICAgICAgIG1peGVkUGllY2VzLnB1c2godGhpcy5tb250aHMobW9tLCAnJykpOwogICAgICAgICAgICBtaXhlZFBpZWNlcy5wdXNoKHRoaXMubW9udGhzU2hvcnQobW9tLCAnJykpOwogICAgICAgIH0KICAgICAgICAvLyBTb3J0aW5nIG1ha2VzIHN1cmUgaWYgb25lIG1vbnRoIChvciBhYmJyKSBpcyBhIHByZWZpeCBvZiBhbm90aGVyIGl0CiAgICAgICAgLy8gd2lsbCBtYXRjaCB0aGUgbG9uZ2VyIHBpZWNlLgogICAgICAgIHNob3J0UGllY2VzLnNvcnQoY21wTGVuUmV2KTsKICAgICAgICBsb25nUGllY2VzLnNvcnQoY21wTGVuUmV2KTsKICAgICAgICBtaXhlZFBpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDEyOyBpKyspIHsKICAgICAgICAgICAgc2hvcnRQaWVjZXNbaV0gPSByZWdleEVzY2FwZShzaG9ydFBpZWNlc1tpXSk7CiAgICAgICAgICAgIGxvbmdQaWVjZXNbaV0gPSByZWdleEVzY2FwZShsb25nUGllY2VzW2ldKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDI0OyBpKyspIHsKICAgICAgICAgICAgbWl4ZWRQaWVjZXNbaV0gPSByZWdleEVzY2FwZShtaXhlZFBpZWNlc1tpXSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9tb250aHNSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIG1peGVkUGllY2VzLmpvaW4oJ3wnKSArICcpJywgJ2knKTsKICAgICAgICB0aGlzLl9tb250aHNTaG9ydFJlZ2V4ID0gdGhpcy5fbW9udGhzUmVnZXg7CiAgICAgICAgdGhpcy5fbW9udGhzU3RyaWN0UmVnZXggPSBuZXcgUmVnRXhwKCdeKCcgKyBsb25nUGllY2VzLmpvaW4oJ3wnKSArICcpJywgJ2knKTsKICAgICAgICB0aGlzLl9tb250aHNTaG9ydFN0cmljdFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgc2hvcnRQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZURhdGUgKHksIG0sIGQsIGgsIE0sIHMsIG1zKSB7CiAgICAgICAgLy8gY2FuJ3QganVzdCBhcHBseSgpIHRvIGNyZWF0ZSBhIGRhdGU6CiAgICAgICAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xLzE4MTM0OAogICAgICAgIHZhciBkYXRlOwogICAgICAgIC8vIHRoZSBkYXRlIGNvbnN0cnVjdG9yIHJlbWFwcyB5ZWFycyAwLTk5IHRvIDE5MDAtMTk5OQogICAgICAgIGlmICh5IDwgMTAwICYmIHkgPj0gMCkgewogICAgICAgICAgICAvLyBwcmVzZXJ2ZSBsZWFwIHllYXJzIHVzaW5nIGEgZnVsbCA0MDAgeWVhciBjeWNsZSwgdGhlbiByZXNldAogICAgICAgICAgICBkYXRlID0gbmV3IERhdGUoeSArIDQwMCwgbSwgZCwgaCwgTSwgcywgbXMpOwogICAgICAgICAgICBpZiAoaXNGaW5pdGUoZGF0ZS5nZXRGdWxsWWVhcigpKSkgewogICAgICAgICAgICAgICAgZGF0ZS5zZXRGdWxsWWVhcih5KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZSh5LCBtLCBkLCBoLCBNLCBzLCBtcyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVVVENEYXRlICh5KSB7CiAgICAgICAgdmFyIGRhdGU7CiAgICAgICAgLy8gdGhlIERhdGUuVVRDIGZ1bmN0aW9uIHJlbWFwcyB5ZWFycyAwLTk5IHRvIDE5MDAtMTk5OQogICAgICAgIGlmICh5IDwgMTAwICYmIHkgPj0gMCkgewogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIC8vIHByZXNlcnZlIGxlYXAgeWVhcnMgdXNpbmcgYSBmdWxsIDQwMCB5ZWFyIGN5Y2xlLCB0aGVuIHJlc2V0CiAgICAgICAgICAgIGFyZ3NbMF0gPSB5ICsgNDAwOwogICAgICAgICAgICBkYXRlID0gbmV3IERhdGUoRGF0ZS5VVEMuYXBwbHkobnVsbCwgYXJncykpOwogICAgICAgICAgICBpZiAoaXNGaW5pdGUoZGF0ZS5nZXRVVENGdWxsWWVhcigpKSkgewogICAgICAgICAgICAgICAgZGF0ZS5zZXRVVENGdWxsWWVhcih5KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZShEYXRlLlVUQy5hcHBseShudWxsLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRlOwogICAgfQoKICAgIC8vIHN0YXJ0LW9mLWZpcnN0LXdlZWsgLSBzdGFydC1vZi15ZWFyCiAgICBmdW5jdGlvbiBmaXJzdFdlZWtPZmZzZXQoeWVhciwgZG93LCBkb3kpIHsKICAgICAgICB2YXIgLy8gZmlyc3Qtd2VlayBkYXkgLS0gd2hpY2ggamFudWFyeSBpcyBhbHdheXMgaW4gdGhlIGZpcnN0IHdlZWsgKDQgZm9yIGlzbywgMSBmb3Igb3RoZXIpCiAgICAgICAgICAgIGZ3ZCA9IDcgKyBkb3cgLSBkb3ksCiAgICAgICAgICAgIC8vIGZpcnN0LXdlZWsgZGF5IGxvY2FsIHdlZWtkYXkgLS0gd2hpY2ggbG9jYWwgd2Vla2RheSBpcyBmd2QKICAgICAgICAgICAgZndkbHcgPSAoNyArIGNyZWF0ZVVUQ0RhdGUoeWVhciwgMCwgZndkKS5nZXRVVENEYXkoKSAtIGRvdykgJSA3OwoKICAgICAgICByZXR1cm4gLWZ3ZGx3ICsgZndkIC0gMTsKICAgIH0KCiAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9JU09fd2Vla19kYXRlI0NhbGN1bGF0aW5nX2FfZGF0ZV9naXZlbl90aGVfeWVhci4yQ193ZWVrX251bWJlcl9hbmRfd2Vla2RheQogICAgZnVuY3Rpb24gZGF5T2ZZZWFyRnJvbVdlZWtzKHllYXIsIHdlZWssIHdlZWtkYXksIGRvdywgZG95KSB7CiAgICAgICAgdmFyIGxvY2FsV2Vla2RheSA9ICg3ICsgd2Vla2RheSAtIGRvdykgJSA3LAogICAgICAgICAgICB3ZWVrT2Zmc2V0ID0gZmlyc3RXZWVrT2Zmc2V0KHllYXIsIGRvdywgZG95KSwKICAgICAgICAgICAgZGF5T2ZZZWFyID0gMSArIDcgKiAod2VlayAtIDEpICsgbG9jYWxXZWVrZGF5ICsgd2Vla09mZnNldCwKICAgICAgICAgICAgcmVzWWVhciwgcmVzRGF5T2ZZZWFyOwoKICAgICAgICBpZiAoZGF5T2ZZZWFyIDw9IDApIHsKICAgICAgICAgICAgcmVzWWVhciA9IHllYXIgLSAxOwogICAgICAgICAgICByZXNEYXlPZlllYXIgPSBkYXlzSW5ZZWFyKHJlc1llYXIpICsgZGF5T2ZZZWFyOwogICAgICAgIH0gZWxzZSBpZiAoZGF5T2ZZZWFyID4gZGF5c0luWWVhcih5ZWFyKSkgewogICAgICAgICAgICByZXNZZWFyID0geWVhciArIDE7CiAgICAgICAgICAgIHJlc0RheU9mWWVhciA9IGRheU9mWWVhciAtIGRheXNJblllYXIoeWVhcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzWWVhciA9IHllYXI7CiAgICAgICAgICAgIHJlc0RheU9mWWVhciA9IGRheU9mWWVhcjsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHllYXI6IHJlc1llYXIsCiAgICAgICAgICAgIGRheU9mWWVhcjogcmVzRGF5T2ZZZWFyCiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiB3ZWVrT2ZZZWFyKG1vbSwgZG93LCBkb3kpIHsKICAgICAgICB2YXIgd2Vla09mZnNldCA9IGZpcnN0V2Vla09mZnNldChtb20ueWVhcigpLCBkb3csIGRveSksCiAgICAgICAgICAgIHdlZWsgPSBNYXRoLmZsb29yKChtb20uZGF5T2ZZZWFyKCkgLSB3ZWVrT2Zmc2V0IC0gMSkgLyA3KSArIDEsCiAgICAgICAgICAgIHJlc1dlZWssIHJlc1llYXI7CgogICAgICAgIGlmICh3ZWVrIDwgMSkgewogICAgICAgICAgICByZXNZZWFyID0gbW9tLnllYXIoKSAtIDE7CiAgICAgICAgICAgIHJlc1dlZWsgPSB3ZWVrICsgd2Vla3NJblllYXIocmVzWWVhciwgZG93LCBkb3kpOwogICAgICAgIH0gZWxzZSBpZiAod2VlayA+IHdlZWtzSW5ZZWFyKG1vbS55ZWFyKCksIGRvdywgZG95KSkgewogICAgICAgICAgICByZXNXZWVrID0gd2VlayAtIHdlZWtzSW5ZZWFyKG1vbS55ZWFyKCksIGRvdywgZG95KTsKICAgICAgICAgICAgcmVzWWVhciA9IG1vbS55ZWFyKCkgKyAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc1llYXIgPSBtb20ueWVhcigpOwogICAgICAgICAgICByZXNXZWVrID0gd2VlazsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHdlZWs6IHJlc1dlZWssCiAgICAgICAgICAgIHllYXI6IHJlc1llYXIKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHdlZWtzSW5ZZWFyKHllYXIsIGRvdywgZG95KSB7CiAgICAgICAgdmFyIHdlZWtPZmZzZXQgPSBmaXJzdFdlZWtPZmZzZXQoeWVhciwgZG93LCBkb3kpLAogICAgICAgICAgICB3ZWVrT2Zmc2V0TmV4dCA9IGZpcnN0V2Vla09mZnNldCh5ZWFyICsgMSwgZG93LCBkb3kpOwogICAgICAgIHJldHVybiAoZGF5c0luWWVhcih5ZWFyKSAtIHdlZWtPZmZzZXQgKyB3ZWVrT2Zmc2V0TmV4dCkgLyA3OwogICAgfQoKICAgIC8vIEZPUk1BVFRJTkcKCiAgICBhZGRGb3JtYXRUb2tlbigndycsIFsnd3cnLCAyXSwgJ3dvJywgJ3dlZWsnKTsKICAgIGFkZEZvcm1hdFRva2VuKCdXJywgWydXVycsIDJdLCAnV28nLCAnaXNvV2VlaycpOwoKICAgIC8vIEFMSUFTRVMKCiAgICBhZGRVbml0QWxpYXMoJ3dlZWsnLCAndycpOwogICAgYWRkVW5pdEFsaWFzKCdpc29XZWVrJywgJ1cnKTsKCiAgICAvLyBQUklPUklUSUVTCgogICAgYWRkVW5pdFByaW9yaXR5KCd3ZWVrJywgNSk7CiAgICBhZGRVbml0UHJpb3JpdHkoJ2lzb1dlZWsnLCA1KTsKCiAgICAvLyBQQVJTSU5HCgogICAgYWRkUmVnZXhUb2tlbigndycsICBtYXRjaDF0bzIpOwogICAgYWRkUmVnZXhUb2tlbignd3cnLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgICBhZGRSZWdleFRva2VuKCdXJywgIG1hdGNoMXRvMik7CiAgICBhZGRSZWdleFRva2VuKCdXVycsIG1hdGNoMXRvMiwgbWF0Y2gyKTsKCiAgICBhZGRXZWVrUGFyc2VUb2tlbihbJ3cnLCAnd3cnLCAnVycsICdXVyddLCBmdW5jdGlvbiAoaW5wdXQsIHdlZWssIGNvbmZpZywgdG9rZW4pIHsKICAgICAgICB3ZWVrW3Rva2VuLnN1YnN0cigwLCAxKV0gPSB0b0ludChpbnB1dCk7CiAgICB9KTsKCiAgICAvLyBIRUxQRVJTCgogICAgLy8gTE9DQUxFUwoKICAgIGZ1bmN0aW9uIGxvY2FsZVdlZWsgKG1vbSkgewogICAgICAgIHJldHVybiB3ZWVrT2ZZZWFyKG1vbSwgdGhpcy5fd2Vlay5kb3csIHRoaXMuX3dlZWsuZG95KS53ZWVrOwogICAgfQoKICAgIHZhciBkZWZhdWx0TG9jYWxlV2VlayA9IHsKICAgICAgICBkb3cgOiAwLCAvLyBTdW5kYXkgaXMgdGhlIGZpcnN0IGRheSBvZiB0aGUgd2Vlay4KICAgICAgICBkb3kgOiA2ICAvLyBUaGUgd2VlayB0aGF0IGNvbnRhaW5zIEphbiA2dGggaXMgdGhlIGZpcnN0IHdlZWsgb2YgdGhlIHllYXIuCiAgICB9OwoKICAgIGZ1bmN0aW9uIGxvY2FsZUZpcnN0RGF5T2ZXZWVrICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fd2Vlay5kb3c7CiAgICB9CgogICAgZnVuY3Rpb24gbG9jYWxlRmlyc3REYXlPZlllYXIgKCkgewogICAgICAgIHJldHVybiB0aGlzLl93ZWVrLmRveTsKICAgIH0KCiAgICAvLyBNT01FTlRTCgogICAgZnVuY3Rpb24gZ2V0U2V0V2VlayAoaW5wdXQpIHsKICAgICAgICB2YXIgd2VlayA9IHRoaXMubG9jYWxlRGF0YSgpLndlZWsodGhpcyk7CiAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrIDogdGhpcy5hZGQoKGlucHV0IC0gd2VlaykgKiA3LCAnZCcpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFNldElTT1dlZWsgKGlucHV0KSB7CiAgICAgICAgdmFyIHdlZWsgPSB3ZWVrT2ZZZWFyKHRoaXMsIDEsIDQpLndlZWs7CiAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrIDogdGhpcy5hZGQoKGlucHV0IC0gd2VlaykgKiA3LCAnZCcpOwogICAgfQoKICAgIC8vIEZPUk1BVFRJTkcKCiAgICBhZGRGb3JtYXRUb2tlbignZCcsIDAsICdkbycsICdkYXknKTsKCiAgICBhZGRGb3JtYXRUb2tlbignZGQnLCAwLCAwLCBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLndlZWtkYXlzTWluKHRoaXMsIGZvcm1hdCk7CiAgICB9KTsKCiAgICBhZGRGb3JtYXRUb2tlbignZGRkJywgMCwgMCwgZnVuY3Rpb24gKGZvcm1hdCkgewogICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS53ZWVrZGF5c1Nob3J0KHRoaXMsIGZvcm1hdCk7CiAgICB9KTsKCiAgICBhZGRGb3JtYXRUb2tlbignZGRkZCcsIDAsIDAsIGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkud2Vla2RheXModGhpcywgZm9ybWF0KTsKICAgIH0pOwoKICAgIGFkZEZvcm1hdFRva2VuKCdlJywgMCwgMCwgJ3dlZWtkYXknKTsKICAgIGFkZEZvcm1hdFRva2VuKCdFJywgMCwgMCwgJ2lzb1dlZWtkYXknKTsKCiAgICAvLyBBTElBU0VTCgogICAgYWRkVW5pdEFsaWFzKCdkYXknLCAnZCcpOwogICAgYWRkVW5pdEFsaWFzKCd3ZWVrZGF5JywgJ2UnKTsKICAgIGFkZFVuaXRBbGlhcygnaXNvV2Vla2RheScsICdFJyk7CgogICAgLy8gUFJJT1JJVFkKICAgIGFkZFVuaXRQcmlvcml0eSgnZGF5JywgMTEpOwogICAgYWRkVW5pdFByaW9yaXR5KCd3ZWVrZGF5JywgMTEpOwogICAgYWRkVW5pdFByaW9yaXR5KCdpc29XZWVrZGF5JywgMTEpOwoKICAgIC8vIFBBUlNJTkcKCiAgICBhZGRSZWdleFRva2VuKCdkJywgICAgbWF0Y2gxdG8yKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ2UnLCAgICBtYXRjaDF0bzIpOwogICAgYWRkUmVnZXhUb2tlbignRScsICAgIG1hdGNoMXRvMik7CiAgICBhZGRSZWdleFRva2VuKCdkZCcsICAgZnVuY3Rpb24gKGlzU3RyaWN0LCBsb2NhbGUpIHsKICAgICAgICByZXR1cm4gbG9jYWxlLndlZWtkYXlzTWluUmVnZXgoaXNTdHJpY3QpOwogICAgfSk7CiAgICBhZGRSZWdleFRva2VuKCdkZGQnLCAgIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICAgICAgcmV0dXJuIGxvY2FsZS53ZWVrZGF5c1Nob3J0UmVnZXgoaXNTdHJpY3QpOwogICAgfSk7CiAgICBhZGRSZWdleFRva2VuKCdkZGRkJywgICBmdW5jdGlvbiAoaXNTdHJpY3QsIGxvY2FsZSkgewogICAgICAgIHJldHVybiBsb2NhbGUud2Vla2RheXNSZWdleChpc1N0cmljdCk7CiAgICB9KTsKCiAgICBhZGRXZWVrUGFyc2VUb2tlbihbJ2RkJywgJ2RkZCcsICdkZGRkJ10sIGZ1bmN0aW9uIChpbnB1dCwgd2VlaywgY29uZmlnLCB0b2tlbikgewogICAgICAgIHZhciB3ZWVrZGF5ID0gY29uZmlnLl9sb2NhbGUud2Vla2RheXNQYXJzZShpbnB1dCwgdG9rZW4sIGNvbmZpZy5fc3RyaWN0KTsKICAgICAgICAvLyBpZiB3ZSBkaWRuJ3QgZ2V0IGEgd2Vla2RheSBuYW1lLCBtYXJrIHRoZSBkYXRlIGFzIGludmFsaWQKICAgICAgICBpZiAod2Vla2RheSAhPSBudWxsKSB7CiAgICAgICAgICAgIHdlZWsuZCA9IHdlZWtkYXk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuaW52YWxpZFdlZWtkYXkgPSBpbnB1dDsKICAgICAgICB9CiAgICB9KTsKCiAgICBhZGRXZWVrUGFyc2VUb2tlbihbJ2QnLCAnZScsICdFJ10sIGZ1bmN0aW9uIChpbnB1dCwgd2VlaywgY29uZmlnLCB0b2tlbikgewogICAgICAgIHdlZWtbdG9rZW5dID0gdG9JbnQoaW5wdXQpOwogICAgfSk7CgogICAgLy8gSEVMUEVSUwoKICAgIGZ1bmN0aW9uIHBhcnNlV2Vla2RheShpbnB1dCwgbG9jYWxlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0OwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpc05hTihpbnB1dCkpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KGlucHV0LCAxMCk7CiAgICAgICAgfQoKICAgICAgICBpbnB1dCA9IGxvY2FsZS53ZWVrZGF5c1BhcnNlKGlucHV0KTsKICAgICAgICBpZiAodHlwZW9mIGlucHV0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICByZXR1cm4gaW5wdXQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZUlzb1dlZWtkYXkoaW5wdXQsIGxvY2FsZSkgewogICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbGUud2Vla2RheXNQYXJzZShpbnB1dCkgJSA3IHx8IDc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc05hTihpbnB1dCkgPyBudWxsIDogaW5wdXQ7CiAgICB9CgogICAgLy8gTE9DQUxFUwogICAgZnVuY3Rpb24gc2hpZnRXZWVrZGF5cyAod3MsIG4pIHsKICAgICAgICByZXR1cm4gd3Muc2xpY2UobiwgNykuY29uY2F0KHdzLnNsaWNlKDAsIG4pKTsKICAgIH0KCiAgICB2YXIgZGVmYXVsdExvY2FsZVdlZWtkYXlzID0gJ1N1bmRheV9Nb25kYXlfVHVlc2RheV9XZWRuZXNkYXlfVGh1cnNkYXlfRnJpZGF5X1NhdHVyZGF5Jy5zcGxpdCgnXycpOwogICAgZnVuY3Rpb24gbG9jYWxlV2Vla2RheXMgKG0sIGZvcm1hdCkgewogICAgICAgIHZhciB3ZWVrZGF5cyA9IGlzQXJyYXkodGhpcy5fd2Vla2RheXMpID8gdGhpcy5fd2Vla2RheXMgOgogICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1sobSAmJiBtICE9PSB0cnVlICYmIHRoaXMuX3dlZWtkYXlzLmlzRm9ybWF0LnRlc3QoZm9ybWF0KSkgPyAnZm9ybWF0JyA6ICdzdGFuZGFsb25lJ107CiAgICAgICAgcmV0dXJuIChtID09PSB0cnVlKSA/IHNoaWZ0V2Vla2RheXMod2Vla2RheXMsIHRoaXMuX3dlZWsuZG93KQogICAgICAgICAgICA6IChtKSA/IHdlZWtkYXlzW20uZGF5KCldIDogd2Vla2RheXM7CiAgICB9CgogICAgdmFyIGRlZmF1bHRMb2NhbGVXZWVrZGF5c1Nob3J0ID0gJ1N1bl9Nb25fVHVlX1dlZF9UaHVfRnJpX1NhdCcuc3BsaXQoJ18nKTsKICAgIGZ1bmN0aW9uIGxvY2FsZVdlZWtkYXlzU2hvcnQgKG0pIHsKICAgICAgICByZXR1cm4gKG0gPT09IHRydWUpID8gc2hpZnRXZWVrZGF5cyh0aGlzLl93ZWVrZGF5c1Nob3J0LCB0aGlzLl93ZWVrLmRvdykKICAgICAgICAgICAgOiAobSkgPyB0aGlzLl93ZWVrZGF5c1Nob3J0W20uZGF5KCldIDogdGhpcy5fd2Vla2RheXNTaG9ydDsKICAgIH0KCiAgICB2YXIgZGVmYXVsdExvY2FsZVdlZWtkYXlzTWluID0gJ1N1X01vX1R1X1dlX1RoX0ZyX1NhJy5zcGxpdCgnXycpOwogICAgZnVuY3Rpb24gbG9jYWxlV2Vla2RheXNNaW4gKG0pIHsKICAgICAgICByZXR1cm4gKG0gPT09IHRydWUpID8gc2hpZnRXZWVrZGF5cyh0aGlzLl93ZWVrZGF5c01pbiwgdGhpcy5fd2Vlay5kb3cpCiAgICAgICAgICAgIDogKG0pID8gdGhpcy5fd2Vla2RheXNNaW5bbS5kYXkoKV0gOiB0aGlzLl93ZWVrZGF5c01pbjsKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVTdHJpY3RQYXJzZSQxKHdlZWtkYXlOYW1lLCBmb3JtYXQsIHN0cmljdCkgewogICAgICAgIHZhciBpLCBpaSwgbW9tLCBsbGMgPSB3ZWVrZGF5TmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgICAgIGlmICghdGhpcy5fd2Vla2RheXNQYXJzZSkgewogICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgICAgIHRoaXMuX3Nob3J0V2Vla2RheXNQYXJzZSA9IFtdOwogICAgICAgICAgICB0aGlzLl9taW5XZWVrZGF5c1BhcnNlID0gW107CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNzsgKytpKSB7CiAgICAgICAgICAgICAgICBtb20gPSBjcmVhdGVVVEMoWzIwMDAsIDFdKS5kYXkoaSk7CiAgICAgICAgICAgICAgICB0aGlzLl9taW5XZWVrZGF5c1BhcnNlW2ldID0gdGhpcy53ZWVrZGF5c01pbihtb20sICcnKS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlW2ldID0gdGhpcy53ZWVrZGF5c1Nob3J0KG1vbSwgJycpLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1BhcnNlW2ldID0gdGhpcy53ZWVrZGF5cyhtb20sICcnKS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoc3RyaWN0KSB7CiAgICAgICAgICAgIGlmIChmb3JtYXQgPT09ICdkZGRkJykgewogICAgICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fd2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZm9ybWF0ID09PSAnZGRkJykgewogICAgICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgICAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX21pbldlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGZvcm1hdCA9PT0gJ2RkZGQnKSB7CiAgICAgICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl93ZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgICAgICAgICAgaWYgKGlpICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX3Nob3J0V2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgICAgIGlmIChpaSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9taW5XZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgICAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgICAgICAgfSBlbHNlIGlmIChmb3JtYXQgPT09ICdkZGQnKSB7CiAgICAgICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9zaG9ydFdlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgICAgICBpZiAoaWkgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fd2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgICAgIGlmIChpaSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9taW5XZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgICAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX21pbldlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgICAgICBpZiAoaWkgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fd2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgICAgIGlmIChpaSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9zaG9ydFdlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGxvY2FsZVdlZWtkYXlzUGFyc2UgKHdlZWtkYXlOYW1lLCBmb3JtYXQsIHN0cmljdCkgewogICAgICAgIHZhciBpLCBtb20sIHJlZ2V4OwoKICAgICAgICBpZiAodGhpcy5fd2Vla2RheXNQYXJzZUV4YWN0KSB7CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVTdHJpY3RQYXJzZSQxLmNhbGwodGhpcywgd2Vla2RheU5hbWUsIGZvcm1hdCwgc3RyaWN0KTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5fd2Vla2RheXNQYXJzZSkgewogICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgICAgIHRoaXMuX21pbldlZWtkYXlzUGFyc2UgPSBbXTsKICAgICAgICAgICAgdGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgICAgIHRoaXMuX2Z1bGxXZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNzsgaSsrKSB7CiAgICAgICAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQoKICAgICAgICAgICAgbW9tID0gY3JlYXRlVVRDKFsyMDAwLCAxXSkuZGF5KGkpOwogICAgICAgICAgICBpZiAoc3RyaWN0ICYmICF0aGlzLl9mdWxsV2Vla2RheXNQYXJzZVtpXSkgewogICAgICAgICAgICAgICAgdGhpcy5fZnVsbFdlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKCdeJyArIHRoaXMud2Vla2RheXMobW9tLCAnJykucmVwbGFjZSgnLicsICdcXC4/JykgKyAnJCcsICdpJyk7CiAgICAgICAgICAgICAgICB0aGlzLl9zaG9ydFdlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKCdeJyArIHRoaXMud2Vla2RheXNTaG9ydChtb20sICcnKS5yZXBsYWNlKCcuJywgJ1xcLj8nKSArICckJywgJ2knKTsKICAgICAgICAgICAgICAgIHRoaXMuX21pbldlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKCdeJyArIHRoaXMud2Vla2RheXNNaW4obW9tLCAnJykucmVwbGFjZSgnLicsICdcXC4/JykgKyAnJCcsICdpJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLl93ZWVrZGF5c1BhcnNlW2ldKSB7CiAgICAgICAgICAgICAgICByZWdleCA9ICdeJyArIHRoaXMud2Vla2RheXMobW9tLCAnJykgKyAnfF4nICsgdGhpcy53ZWVrZGF5c1Nob3J0KG1vbSwgJycpICsgJ3xeJyArIHRoaXMud2Vla2RheXNNaW4obW9tLCAnJyk7CiAgICAgICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1BhcnNlW2ldID0gbmV3IFJlZ0V4cChyZWdleC5yZXBsYWNlKCcuJywgJycpLCAnaScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHRlc3QgdGhlIHJlZ2V4CiAgICAgICAgICAgIGlmIChzdHJpY3QgJiYgZm9ybWF0ID09PSAnZGRkZCcgJiYgdGhpcy5fZnVsbFdlZWtkYXlzUGFyc2VbaV0udGVzdCh3ZWVrZGF5TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmljdCAmJiBmb3JtYXQgPT09ICdkZGQnICYmIHRoaXMuX3Nob3J0V2Vla2RheXNQYXJzZVtpXS50ZXN0KHdlZWtkYXlOYW1lKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyaWN0ICYmIGZvcm1hdCA9PT0gJ2RkJyAmJiB0aGlzLl9taW5XZWVrZGF5c1BhcnNlW2ldLnRlc3Qod2Vla2RheU5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgfSBlbHNlIGlmICghc3RyaWN0ICYmIHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0udGVzdCh3ZWVrZGF5TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIE1PTUVOVFMKCiAgICBmdW5jdGlvbiBnZXRTZXREYXlPZldlZWsgKGlucHV0KSB7CiAgICAgICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCA/IHRoaXMgOiBOYU47CiAgICAgICAgfQogICAgICAgIHZhciBkYXkgPSB0aGlzLl9pc1VUQyA/IHRoaXMuX2QuZ2V0VVRDRGF5KCkgOiB0aGlzLl9kLmdldERheSgpOwogICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlucHV0ID0gcGFyc2VXZWVrZGF5KGlucHV0LCB0aGlzLmxvY2FsZURhdGEoKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZChpbnB1dCAtIGRheSwgJ2QnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZGF5OwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRTZXRMb2NhbGVEYXlPZldlZWsgKGlucHV0KSB7CiAgICAgICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCA/IHRoaXMgOiBOYU47CiAgICAgICAgfQogICAgICAgIHZhciB3ZWVrZGF5ID0gKHRoaXMuZGF5KCkgKyA3IC0gdGhpcy5sb2NhbGVEYXRhKCkuX3dlZWsuZG93KSAlIDc7CiAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrZGF5IDogdGhpcy5hZGQoaW5wdXQgLSB3ZWVrZGF5LCAnZCcpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFNldElTT0RheU9mV2VlayAoaW5wdXQpIHsKICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCAhPSBudWxsID8gdGhpcyA6IE5hTjsKICAgICAgICB9CgogICAgICAgIC8vIGJlaGF2ZXMgdGhlIHNhbWUgYXMgbW9tZW50I2RheSBleGNlcHQKICAgICAgICAvLyBhcyBhIGdldHRlciwgcmV0dXJucyA3IGluc3RlYWQgb2YgMCAoMS03IHJhbmdlIGluc3RlYWQgb2YgMC02KQogICAgICAgIC8vIGFzIGEgc2V0dGVyLCBzdW5kYXkgc2hvdWxkIGJlbG9uZyB0byB0aGUgcHJldmlvdXMgd2Vlay4KCiAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIHdlZWtkYXkgPSBwYXJzZUlzb1dlZWtkYXkoaW5wdXQsIHRoaXMubG9jYWxlRGF0YSgpKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF5KHRoaXMuZGF5KCkgJSA3ID8gd2Vla2RheSA6IHdlZWtkYXkgLSA3KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kYXkoKSB8fCA3OwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgZGVmYXVsdFdlZWtkYXlzUmVnZXggPSBtYXRjaFdvcmQ7CiAgICBmdW5jdGlvbiB3ZWVrZGF5c1JlZ2V4IChpc1N0cmljdCkgewogICAgICAgIGlmICh0aGlzLl93ZWVrZGF5c1BhcnNlRXhhY3QpIHsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfd2Vla2RheXNSZWdleCcpKSB7CiAgICAgICAgICAgICAgICBjb21wdXRlV2Vla2RheXNQYXJzZS5jYWxsKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1N0cmljdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzU3RyaWN0UmVnZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNSZWdleDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX3dlZWtkYXlzUmVnZXgnKSkgewogICAgICAgICAgICAgICAgdGhpcy5fd2Vla2RheXNSZWdleCA9IGRlZmF1bHRXZWVrZGF5c1JlZ2V4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1N0cmljdFJlZ2V4ICYmIGlzU3RyaWN0ID8KICAgICAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzU3RyaWN0UmVnZXggOiB0aGlzLl93ZWVrZGF5c1JlZ2V4OwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgZGVmYXVsdFdlZWtkYXlzU2hvcnRSZWdleCA9IG1hdGNoV29yZDsKICAgIGZ1bmN0aW9uIHdlZWtkYXlzU2hvcnRSZWdleCAoaXNTdHJpY3QpIHsKICAgICAgICBpZiAodGhpcy5fd2Vla2RheXNQYXJzZUV4YWN0KSB7CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX3dlZWtkYXlzUmVnZXgnKSkgewogICAgICAgICAgICAgICAgY29tcHV0ZVdlZWtkYXlzUGFyc2UuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNTdHJpY3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1Nob3J0U3RyaWN0UmVnZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNTaG9ydFJlZ2V4OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfd2Vla2RheXNTaG9ydFJlZ2V4JykpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzU2hvcnRSZWdleCA9IGRlZmF1bHRXZWVrZGF5c1Nob3J0UmVnZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzU2hvcnRTdHJpY3RSZWdleCAmJiBpc1N0cmljdCA/CiAgICAgICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1Nob3J0U3RyaWN0UmVnZXggOiB0aGlzLl93ZWVrZGF5c1Nob3J0UmVnZXg7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBkZWZhdWx0V2Vla2RheXNNaW5SZWdleCA9IG1hdGNoV29yZDsKICAgIGZ1bmN0aW9uIHdlZWtkYXlzTWluUmVnZXggKGlzU3RyaWN0KSB7CiAgICAgICAgaWYgKHRoaXMuX3dlZWtkYXlzUGFyc2VFeGFjdCkgewogICAgICAgICAgICBpZiAoIWhhc093blByb3AodGhpcywgJ193ZWVrZGF5c1JlZ2V4JykpIHsKICAgICAgICAgICAgICAgIGNvbXB1dGVXZWVrZGF5c1BhcnNlLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzU3RyaWN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNNaW5TdHJpY3RSZWdleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c01pblJlZ2V4OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfd2Vla2RheXNNaW5SZWdleCcpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl93ZWVrZGF5c01pblJlZ2V4ID0gZGVmYXVsdFdlZWtkYXlzTWluUmVnZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzTWluU3RyaWN0UmVnZXggJiYgaXNTdHJpY3QgPwogICAgICAgICAgICAgICAgdGhpcy5fd2Vla2RheXNNaW5TdHJpY3RSZWdleCA6IHRoaXMuX3dlZWtkYXlzTWluUmVnZXg7CiAgICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiBjb21wdXRlV2Vla2RheXNQYXJzZSAoKSB7CiAgICAgICAgZnVuY3Rpb24gY21wTGVuUmV2KGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIubGVuZ3RoIC0gYS5sZW5ndGg7CiAgICAgICAgfQoKICAgICAgICB2YXIgbWluUGllY2VzID0gW10sIHNob3J0UGllY2VzID0gW10sIGxvbmdQaWVjZXMgPSBbXSwgbWl4ZWRQaWVjZXMgPSBbXSwKICAgICAgICAgICAgaSwgbW9tLCBtaW5wLCBzaG9ydHAsIGxvbmdwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCA3OyBpKyspIHsKICAgICAgICAgICAgLy8gbWFrZSB0aGUgcmVnZXggaWYgd2UgZG9uJ3QgaGF2ZSBpdCBhbHJlYWR5CiAgICAgICAgICAgIG1vbSA9IGNyZWF0ZVVUQyhbMjAwMCwgMV0pLmRheShpKTsKICAgICAgICAgICAgbWlucCA9IHRoaXMud2Vla2RheXNNaW4obW9tLCAnJyk7CiAgICAgICAgICAgIHNob3J0cCA9IHRoaXMud2Vla2RheXNTaG9ydChtb20sICcnKTsKICAgICAgICAgICAgbG9uZ3AgPSB0aGlzLndlZWtkYXlzKG1vbSwgJycpOwogICAgICAgICAgICBtaW5QaWVjZXMucHVzaChtaW5wKTsKICAgICAgICAgICAgc2hvcnRQaWVjZXMucHVzaChzaG9ydHApOwogICAgICAgICAgICBsb25nUGllY2VzLnB1c2gobG9uZ3ApOwogICAgICAgICAgICBtaXhlZFBpZWNlcy5wdXNoKG1pbnApOwogICAgICAgICAgICBtaXhlZFBpZWNlcy5wdXNoKHNob3J0cCk7CiAgICAgICAgICAgIG1peGVkUGllY2VzLnB1c2gobG9uZ3ApOwogICAgICAgIH0KICAgICAgICAvLyBTb3J0aW5nIG1ha2VzIHN1cmUgaWYgb25lIHdlZWtkYXkgKG9yIGFiYnIpIGlzIGEgcHJlZml4IG9mIGFub3RoZXIgaXQKICAgICAgICAvLyB3aWxsIG1hdGNoIHRoZSBsb25nZXIgcGllY2UuCiAgICAgICAgbWluUGllY2VzLnNvcnQoY21wTGVuUmV2KTsKICAgICAgICBzaG9ydFBpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICAgICAgbG9uZ1BpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICAgICAgbWl4ZWRQaWVjZXMuc29ydChjbXBMZW5SZXYpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCA3OyBpKyspIHsKICAgICAgICAgICAgc2hvcnRQaWVjZXNbaV0gPSByZWdleEVzY2FwZShzaG9ydFBpZWNlc1tpXSk7CiAgICAgICAgICAgIGxvbmdQaWVjZXNbaV0gPSByZWdleEVzY2FwZShsb25nUGllY2VzW2ldKTsKICAgICAgICAgICAgbWl4ZWRQaWVjZXNbaV0gPSByZWdleEVzY2FwZShtaXhlZFBpZWNlc1tpXSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl93ZWVrZGF5c1JlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgbWl4ZWRQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogICAgICAgIHRoaXMuX3dlZWtkYXlzU2hvcnRSZWdleCA9IHRoaXMuX3dlZWtkYXlzUmVnZXg7CiAgICAgICAgdGhpcy5fd2Vla2RheXNNaW5SZWdleCA9IHRoaXMuX3dlZWtkYXlzUmVnZXg7CgogICAgICAgIHRoaXMuX3dlZWtkYXlzU3RyaWN0UmVnZXggPSBuZXcgUmVnRXhwKCdeKCcgKyBsb25nUGllY2VzLmpvaW4oJ3wnKSArICcpJywgJ2knKTsKICAgICAgICB0aGlzLl93ZWVrZGF5c1Nob3J0U3RyaWN0UmVnZXggPSBuZXcgUmVnRXhwKCdeKCcgKyBzaG9ydFBpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7CiAgICAgICAgdGhpcy5fd2Vla2RheXNNaW5TdHJpY3RSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIG1pblBpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7CiAgICB9CgogICAgLy8gRk9STUFUVElORwoKICAgIGZ1bmN0aW9uIGhGb3JtYXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaG91cnMoKSAlIDEyIHx8IDEyOwogICAgfQoKICAgIGZ1bmN0aW9uIGtGb3JtYXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaG91cnMoKSB8fCAyNDsKICAgIH0KCiAgICBhZGRGb3JtYXRUb2tlbignSCcsIFsnSEgnLCAyXSwgMCwgJ2hvdXInKTsKICAgIGFkZEZvcm1hdFRva2VuKCdoJywgWydoaCcsIDJdLCAwLCBoRm9ybWF0KTsKICAgIGFkZEZvcm1hdFRva2VuKCdrJywgWydraycsIDJdLCAwLCBrRm9ybWF0KTsKCiAgICBhZGRGb3JtYXRUb2tlbignaG1tJywgMCwgMCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAnJyArIGhGb3JtYXQuYXBwbHkodGhpcykgKyB6ZXJvRmlsbCh0aGlzLm1pbnV0ZXMoKSwgMik7CiAgICB9KTsKCiAgICBhZGRGb3JtYXRUb2tlbignaG1tc3MnLCAwLCAwLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICcnICsgaEZvcm1hdC5hcHBseSh0aGlzKSArIHplcm9GaWxsKHRoaXMubWludXRlcygpLCAyKSArCiAgICAgICAgICAgIHplcm9GaWxsKHRoaXMuc2Vjb25kcygpLCAyKTsKICAgIH0pOwoKICAgIGFkZEZvcm1hdFRva2VuKCdIbW0nLCAwLCAwLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICcnICsgdGhpcy5ob3VycygpICsgemVyb0ZpbGwodGhpcy5taW51dGVzKCksIDIpOwogICAgfSk7CgogICAgYWRkRm9ybWF0VG9rZW4oJ0htbXNzJywgMCwgMCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAnJyArIHRoaXMuaG91cnMoKSArIHplcm9GaWxsKHRoaXMubWludXRlcygpLCAyKSArCiAgICAgICAgICAgIHplcm9GaWxsKHRoaXMuc2Vjb25kcygpLCAyKTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIG1lcmlkaWVtICh0b2tlbiwgbG93ZXJjYXNlKSB7CiAgICAgICAgYWRkRm9ybWF0VG9rZW4odG9rZW4sIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLm1lcmlkaWVtKHRoaXMuaG91cnMoKSwgdGhpcy5taW51dGVzKCksIGxvd2VyY2FzZSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgbWVyaWRpZW0oJ2EnLCB0cnVlKTsKICAgIG1lcmlkaWVtKCdBJywgZmFsc2UpOwoKICAgIC8vIEFMSUFTRVMKCiAgICBhZGRVbml0QWxpYXMoJ2hvdXInLCAnaCcpOwoKICAgIC8vIFBSSU9SSVRZCiAgICBhZGRVbml0UHJpb3JpdHkoJ2hvdXInLCAxMyk7CgogICAgLy8gUEFSU0lORwoKICAgIGZ1bmN0aW9uIG1hdGNoTWVyaWRpZW0gKGlzU3RyaWN0LCBsb2NhbGUpIHsKICAgICAgICByZXR1cm4gbG9jYWxlLl9tZXJpZGllbVBhcnNlOwogICAgfQoKICAgIGFkZFJlZ2V4VG9rZW4oJ2EnLCAgbWF0Y2hNZXJpZGllbSk7CiAgICBhZGRSZWdleFRva2VuKCdBJywgIG1hdGNoTWVyaWRpZW0pOwogICAgYWRkUmVnZXhUb2tlbignSCcsICBtYXRjaDF0bzIpOwogICAgYWRkUmVnZXhUb2tlbignaCcsICBtYXRjaDF0bzIpOwogICAgYWRkUmVnZXhUb2tlbignaycsICBtYXRjaDF0bzIpOwogICAgYWRkUmVnZXhUb2tlbignSEgnLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgICBhZGRSZWdleFRva2VuKCdoaCcsIG1hdGNoMXRvMiwgbWF0Y2gyKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ2trJywgbWF0Y2gxdG8yLCBtYXRjaDIpOwoKICAgIGFkZFJlZ2V4VG9rZW4oJ2htbScsIG1hdGNoM3RvNCk7CiAgICBhZGRSZWdleFRva2VuKCdobW1zcycsIG1hdGNoNXRvNik7CiAgICBhZGRSZWdleFRva2VuKCdIbW0nLCBtYXRjaDN0bzQpOwogICAgYWRkUmVnZXhUb2tlbignSG1tc3MnLCBtYXRjaDV0bzYpOwoKICAgIGFkZFBhcnNlVG9rZW4oWydIJywgJ0hIJ10sIEhPVVIpOwogICAgYWRkUGFyc2VUb2tlbihbJ2snLCAna2snXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICAgICAgdmFyIGtJbnB1dCA9IHRvSW50KGlucHV0KTsKICAgICAgICBhcnJheVtIT1VSXSA9IGtJbnB1dCA9PT0gMjQgPyAwIDoga0lucHV0OwogICAgfSk7CiAgICBhZGRQYXJzZVRva2VuKFsnYScsICdBJ10sIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgICAgIGNvbmZpZy5faXNQbSA9IGNvbmZpZy5fbG9jYWxlLmlzUE0oaW5wdXQpOwogICAgICAgIGNvbmZpZy5fbWVyaWRpZW0gPSBpbnB1dDsKICAgIH0pOwogICAgYWRkUGFyc2VUb2tlbihbJ2gnLCAnaGgnXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICAgICAgYXJyYXlbSE9VUl0gPSB0b0ludChpbnB1dCk7CiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuYmlnSG91ciA9IHRydWU7CiAgICB9KTsKICAgIGFkZFBhcnNlVG9rZW4oJ2htbScsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgICAgIHZhciBwb3MgPSBpbnB1dC5sZW5ndGggLSAyOwogICAgICAgIGFycmF5W0hPVVJdID0gdG9JbnQoaW5wdXQuc3Vic3RyKDAsIHBvcykpOwogICAgICAgIGFycmF5W01JTlVURV0gPSB0b0ludChpbnB1dC5zdWJzdHIocG9zKSk7CiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuYmlnSG91ciA9IHRydWU7CiAgICB9KTsKICAgIGFkZFBhcnNlVG9rZW4oJ2htbXNzJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBvczEgPSBpbnB1dC5sZW5ndGggLSA0OwogICAgICAgIHZhciBwb3MyID0gaW5wdXQubGVuZ3RoIC0gMjsKICAgICAgICBhcnJheVtIT1VSXSA9IHRvSW50KGlucHV0LnN1YnN0cigwLCBwb3MxKSk7CiAgICAgICAgYXJyYXlbTUlOVVRFXSA9IHRvSW50KGlucHV0LnN1YnN0cihwb3MxLCAyKSk7CiAgICAgICAgYXJyYXlbU0VDT05EXSA9IHRvSW50KGlucHV0LnN1YnN0cihwb3MyKSk7CiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuYmlnSG91ciA9IHRydWU7CiAgICB9KTsKICAgIGFkZFBhcnNlVG9rZW4oJ0htbScsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgICAgIHZhciBwb3MgPSBpbnB1dC5sZW5ndGggLSAyOwogICAgICAgIGFycmF5W0hPVVJdID0gdG9JbnQoaW5wdXQuc3Vic3RyKDAsIHBvcykpOwogICAgICAgIGFycmF5W01JTlVURV0gPSB0b0ludChpbnB1dC5zdWJzdHIocG9zKSk7CiAgICB9KTsKICAgIGFkZFBhcnNlVG9rZW4oJ0htbXNzJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBvczEgPSBpbnB1dC5sZW5ndGggLSA0OwogICAgICAgIHZhciBwb3MyID0gaW5wdXQubGVuZ3RoIC0gMjsKICAgICAgICBhcnJheVtIT1VSXSA9IHRvSW50KGlucHV0LnN1YnN0cigwLCBwb3MxKSk7CiAgICAgICAgYXJyYXlbTUlOVVRFXSA9IHRvSW50KGlucHV0LnN1YnN0cihwb3MxLCAyKSk7CiAgICAgICAgYXJyYXlbU0VDT05EXSA9IHRvSW50KGlucHV0LnN1YnN0cihwb3MyKSk7CiAgICB9KTsKCiAgICAvLyBMT0NBTEVTCgogICAgZnVuY3Rpb24gbG9jYWxlSXNQTSAoaW5wdXQpIHsKICAgICAgICAvLyBJRTggUXVpcmtzIE1vZGUgJiBJRTcgU3RhbmRhcmRzIE1vZGUgZG8gbm90IGFsbG93IGFjY2Vzc2luZyBzdHJpbmdzIGxpa2UgYXJyYXlzCiAgICAgICAgLy8gVXNpbmcgY2hhckF0IHNob3VsZCBiZSBtb3JlIGNvbXBhdGlibGUuCiAgICAgICAgcmV0dXJuICgoaW5wdXQgKyAnJykudG9Mb3dlckNhc2UoKS5jaGFyQXQoMCkgPT09ICdwJyk7CiAgICB9CgogICAgdmFyIGRlZmF1bHRMb2NhbGVNZXJpZGllbVBhcnNlID0gL1thcF1cLj9tP1wuPy9pOwogICAgZnVuY3Rpb24gbG9jYWxlTWVyaWRpZW0gKGhvdXJzLCBtaW51dGVzLCBpc0xvd2VyKSB7CiAgICAgICAgaWYgKGhvdXJzID4gMTEpIHsKICAgICAgICAgICAgcmV0dXJuIGlzTG93ZXIgPyAncG0nIDogJ1BNJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gaXNMb3dlciA/ICdhbScgOiAnQU0nOwogICAgICAgIH0KICAgIH0KCgogICAgLy8gTU9NRU5UUwoKICAgIC8vIFNldHRpbmcgdGhlIGhvdXIgc2hvdWxkIGtlZXAgdGhlIHRpbWUsIGJlY2F1c2UgdGhlIHVzZXIgZXhwbGljaXRseQogICAgLy8gc3BlY2lmaWVkIHdoaWNoIGhvdXIgdGhleSB3YW50LiBTbyB0cnlpbmcgdG8gbWFpbnRhaW4gdGhlIHNhbWUgaG91ciAoaW4KICAgIC8vIGEgbmV3IHRpbWV6b25lKSBtYWtlcyBzZW5zZS4gQWRkaW5nL3N1YnRyYWN0aW5nIGhvdXJzIGRvZXMgbm90IGZvbGxvdwogICAgLy8gdGhpcyBydWxlLgogICAgdmFyIGdldFNldEhvdXIgPSBtYWtlR2V0U2V0KCdIb3VycycsIHRydWUpOwoKICAgIHZhciBiYXNlQ29uZmlnID0gewogICAgICAgIGNhbGVuZGFyOiBkZWZhdWx0Q2FsZW5kYXIsCiAgICAgICAgbG9uZ0RhdGVGb3JtYXQ6IGRlZmF1bHRMb25nRGF0ZUZvcm1hdCwKICAgICAgICBpbnZhbGlkRGF0ZTogZGVmYXVsdEludmFsaWREYXRlLAogICAgICAgIG9yZGluYWw6IGRlZmF1bHRPcmRpbmFsLAogICAgICAgIGRheU9mTW9udGhPcmRpbmFsUGFyc2U6IGRlZmF1bHREYXlPZk1vbnRoT3JkaW5hbFBhcnNlLAogICAgICAgIHJlbGF0aXZlVGltZTogZGVmYXVsdFJlbGF0aXZlVGltZSwKCiAgICAgICAgbW9udGhzOiBkZWZhdWx0TG9jYWxlTW9udGhzLAogICAgICAgIG1vbnRoc1Nob3J0OiBkZWZhdWx0TG9jYWxlTW9udGhzU2hvcnQsCgogICAgICAgIHdlZWs6IGRlZmF1bHRMb2NhbGVXZWVrLAoKICAgICAgICB3ZWVrZGF5czogZGVmYXVsdExvY2FsZVdlZWtkYXlzLAogICAgICAgIHdlZWtkYXlzTWluOiBkZWZhdWx0TG9jYWxlV2Vla2RheXNNaW4sCiAgICAgICAgd2Vla2RheXNTaG9ydDogZGVmYXVsdExvY2FsZVdlZWtkYXlzU2hvcnQsCgogICAgICAgIG1lcmlkaWVtUGFyc2U6IGRlZmF1bHRMb2NhbGVNZXJpZGllbVBhcnNlCiAgICB9OwoKICAgIC8vIGludGVybmFsIHN0b3JhZ2UgZm9yIGxvY2FsZSBjb25maWcgZmlsZXMKICAgIHZhciBsb2NhbGVzID0ge307CiAgICB2YXIgbG9jYWxlRmFtaWxpZXMgPSB7fTsKICAgIHZhciBnbG9iYWxMb2NhbGU7CgogICAgZnVuY3Rpb24gbm9ybWFsaXplTG9jYWxlKGtleSkgewogICAgICAgIHJldHVybiBrZXkgPyBrZXkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKCdfJywgJy0nKSA6IGtleTsKICAgIH0KCiAgICAvLyBwaWNrIHRoZSBsb2NhbGUgZnJvbSB0aGUgYXJyYXkKICAgIC8vIHRyeSBbJ2VuLWF1JywgJ2VuLWdiJ10gYXMgJ2VuLWF1JywgJ2VuLWdiJywgJ2VuJywgYXMgaW4gbW92ZSB0aHJvdWdoIHRoZSBsaXN0IHRyeWluZyBlYWNoCiAgICAvLyBzdWJzdHJpbmcgZnJvbSBtb3N0IHNwZWNpZmljIHRvIGxlYXN0LCBidXQgbW92ZSB0byB0aGUgbmV4dCBhcnJheSBpdGVtIGlmIGl0J3MgYSBtb3JlIHNwZWNpZmljIHZhcmlhbnQgdGhhbiB0aGUgY3VycmVudCByb290CiAgICBmdW5jdGlvbiBjaG9vc2VMb2NhbGUobmFtZXMpIHsKICAgICAgICB2YXIgaSA9IDAsIGosIG5leHQsIGxvY2FsZSwgc3BsaXQ7CgogICAgICAgIHdoaWxlIChpIDwgbmFtZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHNwbGl0ID0gbm9ybWFsaXplTG9jYWxlKG5hbWVzW2ldKS5zcGxpdCgnLScpOwogICAgICAgICAgICBqID0gc3BsaXQubGVuZ3RoOwogICAgICAgICAgICBuZXh0ID0gbm9ybWFsaXplTG9jYWxlKG5hbWVzW2kgKyAxXSk7CiAgICAgICAgICAgIG5leHQgPSBuZXh0ID8gbmV4dC5zcGxpdCgnLScpIDogbnVsbDsKICAgICAgICAgICAgd2hpbGUgKGogPiAwKSB7CiAgICAgICAgICAgICAgICBsb2NhbGUgPSBsb2FkTG9jYWxlKHNwbGl0LnNsaWNlKDAsIGopLmpvaW4oJy0nKSk7CiAgICAgICAgICAgICAgICBpZiAobG9jYWxlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvY2FsZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChuZXh0ICYmIG5leHQubGVuZ3RoID49IGogJiYgY29tcGFyZUFycmF5cyhzcGxpdCwgbmV4dCwgdHJ1ZSkgPj0gaiAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAvL3RoZSBuZXh0IGFycmF5IGl0ZW0gaXMgYmV0dGVyIHRoYW4gYSBzaGFsbG93ZXIgc3Vic3RyaW5nIG9mIHRoaXMgb25lCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBqLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2xvYmFsTG9jYWxlOwogICAgfQoKICAgIGZ1bmN0aW9uIGxvYWRMb2NhbGUobmFtZSkgewogICAgICAgIHZhciBvbGRMb2NhbGUgPSBudWxsOwogICAgICAgIC8vIFRPRE86IEZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlZ2lzdGVyIGFuZCBsb2FkIGFsbCB0aGUgbG9jYWxlcyBpbiBOb2RlCiAgICAgICAgaWYgKCFsb2NhbGVzW25hbWVdICYmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgJiYKICAgICAgICAgICAgICAgIG1vZHVsZSAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgb2xkTG9jYWxlID0gZ2xvYmFsTG9jYWxlLl9hYmJyOwogICAgICAgICAgICAgICAgdmFyIGFsaWFzZWRSZXF1aXJlID0gcmVxdWlyZTsKICAgICAgICAgICAgICAgIGFsaWFzZWRSZXF1aXJlKCcuL2xvY2FsZS8nICsgbmFtZSk7CiAgICAgICAgICAgICAgICBnZXRTZXRHbG9iYWxMb2NhbGUob2xkTG9jYWxlKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxvY2FsZXNbbmFtZV07CiAgICB9CgogICAgLy8gVGhpcyBmdW5jdGlvbiB3aWxsIGxvYWQgbG9jYWxlIGFuZCB0aGVuIHNldCB0aGUgZ2xvYmFsIGxvY2FsZS4gIElmCiAgICAvLyBubyBhcmd1bWVudHMgYXJlIHBhc3NlZCBpbiwgaXQgd2lsbCBzaW1wbHkgcmV0dXJuIHRoZSBjdXJyZW50IGdsb2JhbAogICAgLy8gbG9jYWxlIGtleS4KICAgIGZ1bmN0aW9uIGdldFNldEdsb2JhbExvY2FsZSAoa2V5LCB2YWx1ZXMpIHsKICAgICAgICB2YXIgZGF0YTsKICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZXMpKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gZ2V0TG9jYWxlKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBkYXRhID0gZGVmaW5lTG9jYWxlKGtleSwgdmFsdWVzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgICAgIC8vIG1vbWVudC5kdXJhdGlvbi5fbG9jYWxlID0gbW9tZW50Ll9sb2NhbGUgPSBkYXRhOwogICAgICAgICAgICAgICAgZ2xvYmFsTG9jYWxlID0gZGF0YTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICgodHlwZW9mIGNvbnNvbGUgIT09ICAndW5kZWZpbmVkJykgJiYgY29uc29sZS53YXJuKSB7CiAgICAgICAgICAgICAgICAgICAgLy93YXJuIHVzZXIgaWYgYXJndW1lbnRzIGFyZSBwYXNzZWQgYnV0IHRoZSBsb2NhbGUgY291bGQgbm90IGJlIHNldAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignTG9jYWxlICcgKyBrZXkgKyAgJyBub3QgZm91bmQuIERpZCB5b3UgZm9yZ2V0IHRvIGxvYWQgaXQ/Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBnbG9iYWxMb2NhbGUuX2FiYnI7CiAgICB9CgogICAgZnVuY3Rpb24gZGVmaW5lTG9jYWxlIChuYW1lLCBjb25maWcpIHsKICAgICAgICBpZiAoY29uZmlnICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBsb2NhbGUsIHBhcmVudENvbmZpZyA9IGJhc2VDb25maWc7CiAgICAgICAgICAgIGNvbmZpZy5hYmJyID0gbmFtZTsKICAgICAgICAgICAgaWYgKGxvY2FsZXNbbmFtZV0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGVwcmVjYXRlU2ltcGxlKCdkZWZpbmVMb2NhbGVPdmVycmlkZScsCiAgICAgICAgICAgICAgICAgICAgICAgICd1c2UgbW9tZW50LnVwZGF0ZUxvY2FsZShsb2NhbGVOYW1lLCBjb25maWcpIHRvIGNoYW5nZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgJ2FuIGV4aXN0aW5nIGxvY2FsZS4gbW9tZW50LmRlZmluZUxvY2FsZShsb2NhbGVOYW1lLCAnICsKICAgICAgICAgICAgICAgICAgICAgICAgJ2NvbmZpZykgc2hvdWxkIG9ubHkgYmUgdXNlZCBmb3IgY3JlYXRpbmcgYSBuZXcgbG9jYWxlICcgKwogICAgICAgICAgICAgICAgICAgICAgICAnU2VlIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvZGVmaW5lLWxvY2FsZS8gZm9yIG1vcmUgaW5mby4nKTsKICAgICAgICAgICAgICAgIHBhcmVudENvbmZpZyA9IGxvY2FsZXNbbmFtZV0uX2NvbmZpZzsKICAgICAgICAgICAgfSBlbHNlIGlmIChjb25maWcucGFyZW50TG9jYWxlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChsb2NhbGVzW2NvbmZpZy5wYXJlbnRMb2NhbGVdICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRDb25maWcgPSBsb2NhbGVzW2NvbmZpZy5wYXJlbnRMb2NhbGVdLl9jb25maWc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxvY2FsZSA9IGxvYWRMb2NhbGUoY29uZmlnLnBhcmVudExvY2FsZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvY2FsZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudENvbmZpZyA9IGxvY2FsZS5fY29uZmlnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbG9jYWxlRmFtaWxpZXNbY29uZmlnLnBhcmVudExvY2FsZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsZUZhbWlsaWVzW2NvbmZpZy5wYXJlbnRMb2NhbGVdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxlRmFtaWxpZXNbY29uZmlnLnBhcmVudExvY2FsZV0ucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnOiBjb25maWcKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBsb2NhbGVzW25hbWVdID0gbmV3IExvY2FsZShtZXJnZUNvbmZpZ3MocGFyZW50Q29uZmlnLCBjb25maWcpKTsKCiAgICAgICAgICAgIGlmIChsb2NhbGVGYW1pbGllc1tuYW1lXSkgewogICAgICAgICAgICAgICAgbG9jYWxlRmFtaWxpZXNbbmFtZV0uZm9yRWFjaChmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIGRlZmluZUxvY2FsZSh4Lm5hbWUsIHguY29uZmlnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiYWNrd2FyZHMgY29tcGF0IGZvciBub3c6IGFsc28gc2V0IHRoZSBsb2NhbGUKICAgICAgICAgICAgLy8gbWFrZSBzdXJlIHdlIHNldCB0aGUgbG9jYWxlIEFGVEVSIGFsbCBjaGlsZCBsb2NhbGVzIGhhdmUgYmVlbgogICAgICAgICAgICAvLyBjcmVhdGVkLCBzbyB3ZSB3b24ndCBlbmQgdXAgd2l0aCB0aGUgY2hpbGQgbG9jYWxlIHNldC4KICAgICAgICAgICAgZ2V0U2V0R2xvYmFsTG9jYWxlKG5hbWUpOwoKCiAgICAgICAgICAgIHJldHVybiBsb2NhbGVzW25hbWVdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHVzZWZ1bCBmb3IgdGVzdGluZwogICAgICAgICAgICBkZWxldGUgbG9jYWxlc1tuYW1lXTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUxvY2FsZShuYW1lLCBjb25maWcpIHsKICAgICAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIGxvY2FsZSwgdG1wTG9jYWxlLCBwYXJlbnRDb25maWcgPSBiYXNlQ29uZmlnOwogICAgICAgICAgICAvLyBNRVJHRQogICAgICAgICAgICB0bXBMb2NhbGUgPSBsb2FkTG9jYWxlKG5hbWUpOwogICAgICAgICAgICBpZiAodG1wTG9jYWxlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHBhcmVudENvbmZpZyA9IHRtcExvY2FsZS5fY29uZmlnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbmZpZyA9IG1lcmdlQ29uZmlncyhwYXJlbnRDb25maWcsIGNvbmZpZyk7CiAgICAgICAgICAgIGxvY2FsZSA9IG5ldyBMb2NhbGUoY29uZmlnKTsKICAgICAgICAgICAgbG9jYWxlLnBhcmVudExvY2FsZSA9IGxvY2FsZXNbbmFtZV07CiAgICAgICAgICAgIGxvY2FsZXNbbmFtZV0gPSBsb2NhbGU7CgogICAgICAgICAgICAvLyBiYWNrd2FyZHMgY29tcGF0IGZvciBub3c6IGFsc28gc2V0IHRoZSBsb2NhbGUKICAgICAgICAgICAgZ2V0U2V0R2xvYmFsTG9jYWxlKG5hbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHBhc3MgbnVsbCBmb3IgY29uZmlnIHRvIHVudXBkYXRlLCB1c2VmdWwgZm9yIHRlc3RzCiAgICAgICAgICAgIGlmIChsb2NhbGVzW25hbWVdICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChsb2NhbGVzW25hbWVdLnBhcmVudExvY2FsZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbG9jYWxlc1tuYW1lXSA9IGxvY2FsZXNbbmFtZV0ucGFyZW50TG9jYWxlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsb2NhbGVzW25hbWVdICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgbG9jYWxlc1tuYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbG9jYWxlc1tuYW1lXTsKICAgIH0KCiAgICAvLyByZXR1cm5zIGxvY2FsZSBkYXRhCiAgICBmdW5jdGlvbiBnZXRMb2NhbGUgKGtleSkgewogICAgICAgIHZhciBsb2NhbGU7CgogICAgICAgIGlmIChrZXkgJiYga2V5Ll9sb2NhbGUgJiYga2V5Ll9sb2NhbGUuX2FiYnIpIHsKICAgICAgICAgICAga2V5ID0ga2V5Ll9sb2NhbGUuX2FiYnI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWtleSkgewogICAgICAgICAgICByZXR1cm4gZ2xvYmFsTG9jYWxlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpc0FycmF5KGtleSkpIHsKICAgICAgICAgICAgLy9zaG9ydC1jaXJjdWl0IGV2ZXJ5dGhpbmcgZWxzZQogICAgICAgICAgICBsb2NhbGUgPSBsb2FkTG9jYWxlKGtleSk7CiAgICAgICAgICAgIGlmIChsb2NhbGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5ID0gW2tleV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2hvb3NlTG9jYWxlKGtleSk7CiAgICB9CgogICAgZnVuY3Rpb24gbGlzdExvY2FsZXMoKSB7CiAgICAgICAgcmV0dXJuIGtleXMobG9jYWxlcyk7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tPdmVyZmxvdyAobSkgewogICAgICAgIHZhciBvdmVyZmxvdzsKICAgICAgICB2YXIgYSA9IG0uX2E7CgogICAgICAgIGlmIChhICYmIGdldFBhcnNpbmdGbGFncyhtKS5vdmVyZmxvdyA9PT0gLTIpIHsKICAgICAgICAgICAgb3ZlcmZsb3cgPQogICAgICAgICAgICAgICAgYVtNT05USF0gICAgICAgPCAwIHx8IGFbTU9OVEhdICAgICAgID4gMTEgID8gTU9OVEggOgogICAgICAgICAgICAgICAgYVtEQVRFXSAgICAgICAgPCAxIHx8IGFbREFURV0gICAgICAgID4gZGF5c0luTW9udGgoYVtZRUFSXSwgYVtNT05USF0pID8gREFURSA6CiAgICAgICAgICAgICAgICBhW0hPVVJdICAgICAgICA8IDAgfHwgYVtIT1VSXSAgICAgICAgPiAyNCB8fCAoYVtIT1VSXSA9PT0gMjQgJiYgKGFbTUlOVVRFXSAhPT0gMCB8fCBhW1NFQ09ORF0gIT09IDAgfHwgYVtNSUxMSVNFQ09ORF0gIT09IDApKSA/IEhPVVIgOgogICAgICAgICAgICAgICAgYVtNSU5VVEVdICAgICAgPCAwIHx8IGFbTUlOVVRFXSAgICAgID4gNTkgID8gTUlOVVRFIDoKICAgICAgICAgICAgICAgIGFbU0VDT05EXSAgICAgIDwgMCB8fCBhW1NFQ09ORF0gICAgICA+IDU5ICA/IFNFQ09ORCA6CiAgICAgICAgICAgICAgICBhW01JTExJU0VDT05EXSA8IDAgfHwgYVtNSUxMSVNFQ09ORF0gPiA5OTkgPyBNSUxMSVNFQ09ORCA6CiAgICAgICAgICAgICAgICAtMTsKCiAgICAgICAgICAgIGlmIChnZXRQYXJzaW5nRmxhZ3MobSkuX292ZXJmbG93RGF5T2ZZZWFyICYmIChvdmVyZmxvdyA8IFlFQVIgfHwgb3ZlcmZsb3cgPiBEQVRFKSkgewogICAgICAgICAgICAgICAgb3ZlcmZsb3cgPSBEQVRFOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRQYXJzaW5nRmxhZ3MobSkuX292ZXJmbG93V2Vla3MgJiYgb3ZlcmZsb3cgPT09IC0xKSB7CiAgICAgICAgICAgICAgICBvdmVyZmxvdyA9IFdFRUs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldFBhcnNpbmdGbGFncyhtKS5fb3ZlcmZsb3dXZWVrZGF5ICYmIG92ZXJmbG93ID09PSAtMSkgewogICAgICAgICAgICAgICAgb3ZlcmZsb3cgPSBXRUVLREFZOwogICAgICAgICAgICB9CgogICAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3MobSkub3ZlcmZsb3cgPSBvdmVyZmxvdzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBtOwogICAgfQoKICAgIC8vIFBpY2sgdGhlIGZpcnN0IGRlZmluZWQgb2YgdHdvIG9yIHRocmVlIGFyZ3VtZW50cy4KICAgIGZ1bmN0aW9uIGRlZmF1bHRzKGEsIGIsIGMpIHsKICAgICAgICBpZiAoYSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgIH0KICAgICAgICBpZiAoYiAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBiOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYzsKICAgIH0KCiAgICBmdW5jdGlvbiBjdXJyZW50RGF0ZUFycmF5KGNvbmZpZykgewogICAgICAgIC8vIGhvb2tzIGlzIGFjdHVhbGx5IHRoZSBleHBvcnRlZCBtb21lbnQgb2JqZWN0CiAgICAgICAgdmFyIG5vd1ZhbHVlID0gbmV3IERhdGUoaG9va3Mubm93KCkpOwogICAgICAgIGlmIChjb25maWcuX3VzZVVUQykgewogICAgICAgICAgICByZXR1cm4gW25vd1ZhbHVlLmdldFVUQ0Z1bGxZZWFyKCksIG5vd1ZhbHVlLmdldFVUQ01vbnRoKCksIG5vd1ZhbHVlLmdldFVUQ0RhdGUoKV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBbbm93VmFsdWUuZ2V0RnVsbFllYXIoKSwgbm93VmFsdWUuZ2V0TW9udGgoKSwgbm93VmFsdWUuZ2V0RGF0ZSgpXTsKICAgIH0KCiAgICAvLyBjb252ZXJ0IGFuIGFycmF5IHRvIGEgZGF0ZS4KICAgIC8vIHRoZSBhcnJheSBzaG91bGQgbWlycm9yIHRoZSBwYXJhbWV0ZXJzIGJlbG93CiAgICAvLyBub3RlOiBhbGwgdmFsdWVzIHBhc3QgdGhlIHllYXIgYXJlIG9wdGlvbmFsIGFuZCB3aWxsIGRlZmF1bHQgdG8gdGhlIGxvd2VzdCBwb3NzaWJsZSB2YWx1ZS4KICAgIC8vIFt5ZWFyLCBtb250aCwgZGF5ICwgaG91ciwgbWludXRlLCBzZWNvbmQsIG1pbGxpc2Vjb25kXQogICAgZnVuY3Rpb24gY29uZmlnRnJvbUFycmF5IChjb25maWcpIHsKICAgICAgICB2YXIgaSwgZGF0ZSwgaW5wdXQgPSBbXSwgY3VycmVudERhdGUsIGV4cGVjdGVkV2Vla2RheSwgeWVhclRvVXNlOwoKICAgICAgICBpZiAoY29uZmlnLl9kKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGN1cnJlbnREYXRlID0gY3VycmVudERhdGVBcnJheShjb25maWcpOwoKICAgICAgICAvL2NvbXB1dGUgZGF5IG9mIHRoZSB5ZWFyIGZyb20gd2Vla3MgYW5kIHdlZWtkYXlzCiAgICAgICAgaWYgKGNvbmZpZy5fdyAmJiBjb25maWcuX2FbREFURV0gPT0gbnVsbCAmJiBjb25maWcuX2FbTU9OVEhdID09IG51bGwpIHsKICAgICAgICAgICAgZGF5T2ZZZWFyRnJvbVdlZWtJbmZvKGNvbmZpZyk7CiAgICAgICAgfQoKICAgICAgICAvL2lmIHRoZSBkYXkgb2YgdGhlIHllYXIgaXMgc2V0LCBmaWd1cmUgb3V0IHdoYXQgaXQgaXMKICAgICAgICBpZiAoY29uZmlnLl9kYXlPZlllYXIgIT0gbnVsbCkgewogICAgICAgICAgICB5ZWFyVG9Vc2UgPSBkZWZhdWx0cyhjb25maWcuX2FbWUVBUl0sIGN1cnJlbnREYXRlW1lFQVJdKTsKCiAgICAgICAgICAgIGlmIChjb25maWcuX2RheU9mWWVhciA+IGRheXNJblllYXIoeWVhclRvVXNlKSB8fCBjb25maWcuX2RheU9mWWVhciA9PT0gMCkgewogICAgICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuX292ZXJmbG93RGF5T2ZZZWFyID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGF0ZSA9IGNyZWF0ZVVUQ0RhdGUoeWVhclRvVXNlLCAwLCBjb25maWcuX2RheU9mWWVhcik7CiAgICAgICAgICAgIGNvbmZpZy5fYVtNT05USF0gPSBkYXRlLmdldFVUQ01vbnRoKCk7CiAgICAgICAgICAgIGNvbmZpZy5fYVtEQVRFXSA9IGRhdGUuZ2V0VVRDRGF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gRGVmYXVsdCB0byBjdXJyZW50IGRhdGUuCiAgICAgICAgLy8gKiBpZiBubyB5ZWFyLCBtb250aCwgZGF5IG9mIG1vbnRoIGFyZSBnaXZlbiwgZGVmYXVsdCB0byB0b2RheQogICAgICAgIC8vICogaWYgZGF5IG9mIG1vbnRoIGlzIGdpdmVuLCBkZWZhdWx0IG1vbnRoIGFuZCB5ZWFyCiAgICAgICAgLy8gKiBpZiBtb250aCBpcyBnaXZlbiwgZGVmYXVsdCBvbmx5IHllYXIKICAgICAgICAvLyAqIGlmIHllYXIgaXMgZ2l2ZW4sIGRvbid0IGRlZmF1bHQgYW55dGhpbmcKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMyAmJiBjb25maWcuX2FbaV0gPT0gbnVsbDsgKytpKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYVtpXSA9IGlucHV0W2ldID0gY3VycmVudERhdGVbaV07CiAgICAgICAgfQoKICAgICAgICAvLyBaZXJvIG91dCB3aGF0ZXZlciB3YXMgbm90IGRlZmF1bHRlZCwgaW5jbHVkaW5nIHRpbWUKICAgICAgICBmb3IgKDsgaSA8IDc7IGkrKykgewogICAgICAgICAgICBjb25maWcuX2FbaV0gPSBpbnB1dFtpXSA9IChjb25maWcuX2FbaV0gPT0gbnVsbCkgPyAoaSA9PT0gMiA/IDEgOiAwKSA6IGNvbmZpZy5fYVtpXTsKICAgICAgICB9CgogICAgICAgIC8vIENoZWNrIGZvciAyNDowMDowMC4wMDAKICAgICAgICBpZiAoY29uZmlnLl9hW0hPVVJdID09PSAyNCAmJgogICAgICAgICAgICAgICAgY29uZmlnLl9hW01JTlVURV0gPT09IDAgJiYKICAgICAgICAgICAgICAgIGNvbmZpZy5fYVtTRUNPTkRdID09PSAwICYmCiAgICAgICAgICAgICAgICBjb25maWcuX2FbTUlMTElTRUNPTkRdID09PSAwKSB7CiAgICAgICAgICAgIGNvbmZpZy5fbmV4dERheSA9IHRydWU7CiAgICAgICAgICAgIGNvbmZpZy5fYVtIT1VSXSA9IDA7CiAgICAgICAgfQoKICAgICAgICBjb25maWcuX2QgPSAoY29uZmlnLl91c2VVVEMgPyBjcmVhdGVVVENEYXRlIDogY3JlYXRlRGF0ZSkuYXBwbHkobnVsbCwgaW5wdXQpOwogICAgICAgIGV4cGVjdGVkV2Vla2RheSA9IGNvbmZpZy5fdXNlVVRDID8gY29uZmlnLl9kLmdldFVUQ0RheSgpIDogY29uZmlnLl9kLmdldERheSgpOwoKICAgICAgICAvLyBBcHBseSB0aW1lem9uZSBvZmZzZXQgZnJvbSBpbnB1dC4gVGhlIGFjdHVhbCB1dGNPZmZzZXQgY2FuIGJlIGNoYW5nZWQKICAgICAgICAvLyB3aXRoIHBhcnNlWm9uZS4KICAgICAgICBpZiAoY29uZmlnLl90em0gIT0gbnVsbCkgewogICAgICAgICAgICBjb25maWcuX2Quc2V0VVRDTWludXRlcyhjb25maWcuX2QuZ2V0VVRDTWludXRlcygpIC0gY29uZmlnLl90em0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZy5fbmV4dERheSkgewogICAgICAgICAgICBjb25maWcuX2FbSE9VUl0gPSAyNDsKICAgICAgICB9CgogICAgICAgIC8vIGNoZWNrIGZvciBtaXNtYXRjaGluZyBkYXkgb2Ygd2VlawogICAgICAgIGlmIChjb25maWcuX3cgJiYgdHlwZW9mIGNvbmZpZy5fdy5kICE9PSAndW5kZWZpbmVkJyAmJiBjb25maWcuX3cuZCAhPT0gZXhwZWN0ZWRXZWVrZGF5KSB7CiAgICAgICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLndlZWtkYXlNaXNtYXRjaCA9IHRydWU7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRheU9mWWVhckZyb21XZWVrSW5mbyhjb25maWcpIHsKICAgICAgICB2YXIgdywgd2Vla1llYXIsIHdlZWssIHdlZWtkYXksIGRvdywgZG95LCB0ZW1wLCB3ZWVrZGF5T3ZlcmZsb3c7CgogICAgICAgIHcgPSBjb25maWcuX3c7CiAgICAgICAgaWYgKHcuR0cgIT0gbnVsbCB8fCB3LlcgIT0gbnVsbCB8fCB3LkUgIT0gbnVsbCkgewogICAgICAgICAgICBkb3cgPSAxOwogICAgICAgICAgICBkb3kgPSA0OwoKICAgICAgICAgICAgLy8gVE9ETzogV2UgbmVlZCB0byB0YWtlIHRoZSBjdXJyZW50IGlzb1dlZWtZZWFyLCBidXQgdGhhdCBkZXBlbmRzIG9uCiAgICAgICAgICAgIC8vIGhvdyB3ZSBpbnRlcnByZXQgbm93IChsb2NhbCwgdXRjLCBmaXhlZCBvZmZzZXQpLiBTbyBjcmVhdGUKICAgICAgICAgICAgLy8gYSBub3cgdmVyc2lvbiBvZiBjdXJyZW50IGNvbmZpZyAodGFrZSBsb2NhbC91dGMvb2Zmc2V0IGZsYWdzLCBhbmQKICAgICAgICAgICAgLy8gY3JlYXRlIG5vdykuCiAgICAgICAgICAgIHdlZWtZZWFyID0gZGVmYXVsdHMody5HRywgY29uZmlnLl9hW1lFQVJdLCB3ZWVrT2ZZZWFyKGNyZWF0ZUxvY2FsKCksIDEsIDQpLnllYXIpOwogICAgICAgICAgICB3ZWVrID0gZGVmYXVsdHMody5XLCAxKTsKICAgICAgICAgICAgd2Vla2RheSA9IGRlZmF1bHRzKHcuRSwgMSk7CiAgICAgICAgICAgIGlmICh3ZWVrZGF5IDwgMSB8fCB3ZWVrZGF5ID4gNykgewogICAgICAgICAgICAgICAgd2Vla2RheU92ZXJmbG93ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvdyA9IGNvbmZpZy5fbG9jYWxlLl93ZWVrLmRvdzsKICAgICAgICAgICAgZG95ID0gY29uZmlnLl9sb2NhbGUuX3dlZWsuZG95OwoKICAgICAgICAgICAgdmFyIGN1cldlZWsgPSB3ZWVrT2ZZZWFyKGNyZWF0ZUxvY2FsKCksIGRvdywgZG95KTsKCiAgICAgICAgICAgIHdlZWtZZWFyID0gZGVmYXVsdHMody5nZywgY29uZmlnLl9hW1lFQVJdLCBjdXJXZWVrLnllYXIpOwoKICAgICAgICAgICAgLy8gRGVmYXVsdCB0byBjdXJyZW50IHdlZWsuCiAgICAgICAgICAgIHdlZWsgPSBkZWZhdWx0cyh3LncsIGN1cldlZWsud2Vlayk7CgogICAgICAgICAgICBpZiAody5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIHdlZWtkYXkgLS0gbG93IGRheSBudW1iZXJzIGFyZSBjb25zaWRlcmVkIG5leHQgd2VlawogICAgICAgICAgICAgICAgd2Vla2RheSA9IHcuZDsKICAgICAgICAgICAgICAgIGlmICh3ZWVrZGF5IDwgMCB8fCB3ZWVrZGF5ID4gNikgewogICAgICAgICAgICAgICAgICAgIHdlZWtkYXlPdmVyZmxvdyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAody5lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIGxvY2FsIHdlZWtkYXkgLS0gY291bnRpbmcgc3RhcnRzIGZyb20gYmVnaW5uaW5nIG9mIHdlZWsKICAgICAgICAgICAgICAgIHdlZWtkYXkgPSB3LmUgKyBkb3c7CiAgICAgICAgICAgICAgICBpZiAody5lIDwgMCB8fCB3LmUgPiA2KSB7CiAgICAgICAgICAgICAgICAgICAgd2Vla2RheU92ZXJmbG93ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGRlZmF1bHQgdG8gYmVnaW5uaW5nIG9mIHdlZWsKICAgICAgICAgICAgICAgIHdlZWtkYXkgPSBkb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHdlZWsgPCAxIHx8IHdlZWsgPiB3ZWVrc0luWWVhcih3ZWVrWWVhciwgZG93LCBkb3kpKSB7CiAgICAgICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLl9vdmVyZmxvd1dlZWtzID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKHdlZWtkYXlPdmVyZmxvdyAhPSBudWxsKSB7CiAgICAgICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLl9vdmVyZmxvd1dlZWtkYXkgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRlbXAgPSBkYXlPZlllYXJGcm9tV2Vla3Mod2Vla1llYXIsIHdlZWssIHdlZWtkYXksIGRvdywgZG95KTsKICAgICAgICAgICAgY29uZmlnLl9hW1lFQVJdID0gdGVtcC55ZWFyOwogICAgICAgICAgICBjb25maWcuX2RheU9mWWVhciA9IHRlbXAuZGF5T2ZZZWFyOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBpc28gODYwMSByZWdleAogICAgLy8gMDAwMC0wMC0wMCAwMDAwLVcwMCBvciAwMDAwLVcwMC0wICsgVCArIDAwIG9yIDAwOjAwIG9yIDAwOjAwOjAwIG9yIDAwOjAwOjAwLjAwMCArICswMDowMCBvciArMDAwMCBvciArMDApCiAgICB2YXIgZXh0ZW5kZWRJc29SZWdleCA9IC9eXHMqKCg/OlsrLV1cZHs2fXxcZHs0fSktKD86XGRcZC1cZFxkfFdcZFxkLVxkfFdcZFxkfFxkXGRcZHxcZFxkKSkoPzooVHwgKShcZFxkKD86OlxkXGQoPzo6XGRcZCg/OlsuLF1cZCspPyk/KT8pKFtcK1wtXVxkXGQoPzo6P1xkXGQpP3xccypaKT8pPyQvOwogICAgdmFyIGJhc2ljSXNvUmVnZXggPSAvXlxzKigoPzpbKy1dXGR7Nn18XGR7NH0pKD86XGRcZFxkXGR8V1xkXGRcZHxXXGRcZHxcZFxkXGR8XGRcZCkpKD86KFR8ICkoXGRcZCg/OlxkXGQoPzpcZFxkKD86Wy4sXVxkKyk/KT8pPykoW1wrXC1dXGRcZCg/Ojo/XGRcZCk/fFxzKlopPyk/JC87CgogICAgdmFyIHR6UmVnZXggPSAvWnxbKy1dXGRcZCg/Ojo/XGRcZCk/LzsKCiAgICB2YXIgaXNvRGF0ZXMgPSBbCiAgICAgICAgWydZWVlZWVktTU0tREQnLCAvWystXVxkezZ9LVxkXGQtXGRcZC9dLAogICAgICAgIFsnWVlZWS1NTS1ERCcsIC9cZHs0fS1cZFxkLVxkXGQvXSwKICAgICAgICBbJ0dHR0ctW1ddV1ctRScsIC9cZHs0fS1XXGRcZC1cZC9dLAogICAgICAgIFsnR0dHRy1bV11XVycsIC9cZHs0fS1XXGRcZC8sIGZhbHNlXSwKICAgICAgICBbJ1lZWVktREREJywgL1xkezR9LVxkezN9L10sCiAgICAgICAgWydZWVlZLU1NJywgL1xkezR9LVxkXGQvLCBmYWxzZV0sCiAgICAgICAgWydZWVlZWVlNTUREJywgL1srLV1cZHsxMH0vXSwKICAgICAgICBbJ1lZWVlNTUREJywgL1xkezh9L10sCiAgICAgICAgLy8gWVlZWU1NIGlzIE5PVCBhbGxvd2VkIGJ5IHRoZSBzdGFuZGFyZAogICAgICAgIFsnR0dHR1tXXVdXRScsIC9cZHs0fVdcZHszfS9dLAogICAgICAgIFsnR0dHR1tXXVdXJywgL1xkezR9V1xkezJ9LywgZmFsc2VdLAogICAgICAgIFsnWVlZWURERCcsIC9cZHs3fS9dCiAgICBdOwoKICAgIC8vIGlzbyB0aW1lIGZvcm1hdHMgYW5kIHJlZ2V4ZXMKICAgIHZhciBpc29UaW1lcyA9IFsKICAgICAgICBbJ0hIOm1tOnNzLlNTU1MnLCAvXGRcZDpcZFxkOlxkXGRcLlxkKy9dLAogICAgICAgIFsnSEg6bW06c3MsU1NTUycsIC9cZFxkOlxkXGQ6XGRcZCxcZCsvXSwKICAgICAgICBbJ0hIOm1tOnNzJywgL1xkXGQ6XGRcZDpcZFxkL10sCiAgICAgICAgWydISDptbScsIC9cZFxkOlxkXGQvXSwKICAgICAgICBbJ0hIbW1zcy5TU1NTJywgL1xkXGRcZFxkXGRcZFwuXGQrL10sCiAgICAgICAgWydISG1tc3MsU1NTUycsIC9cZFxkXGRcZFxkXGQsXGQrL10sCiAgICAgICAgWydISG1tc3MnLCAvXGRcZFxkXGRcZFxkL10sCiAgICAgICAgWydISG1tJywgL1xkXGRcZFxkL10sCiAgICAgICAgWydISCcsIC9cZFxkL10KICAgIF07CgogICAgdmFyIGFzcE5ldEpzb25SZWdleCA9IC9eXC8/RGF0ZVwoKFwtP1xkKykvaTsKCiAgICAvLyBkYXRlIGZyb20gaXNvIGZvcm1hdAogICAgZnVuY3Rpb24gY29uZmlnRnJvbUlTTyhjb25maWcpIHsKICAgICAgICB2YXIgaSwgbCwKICAgICAgICAgICAgc3RyaW5nID0gY29uZmlnLl9pLAogICAgICAgICAgICBtYXRjaCA9IGV4dGVuZGVkSXNvUmVnZXguZXhlYyhzdHJpbmcpIHx8IGJhc2ljSXNvUmVnZXguZXhlYyhzdHJpbmcpLAogICAgICAgICAgICBhbGxvd1RpbWUsIGRhdGVGb3JtYXQsIHRpbWVGb3JtYXQsIHR6Rm9ybWF0OwoKICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuaXNvID0gdHJ1ZTsKCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBpc29EYXRlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChpc29EYXRlc1tpXVsxXS5leGVjKG1hdGNoWzFdKSkgewogICAgICAgICAgICAgICAgICAgIGRhdGVGb3JtYXQgPSBpc29EYXRlc1tpXVswXTsKICAgICAgICAgICAgICAgICAgICBhbGxvd1RpbWUgPSBpc29EYXRlc1tpXVsyXSAhPT0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRhdGVGb3JtYXQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29uZmlnLl9pc1ZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1hdGNoWzNdKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gaXNvVGltZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzb1RpbWVzW2ldWzFdLmV4ZWMobWF0Y2hbM10pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1hdGNoWzJdIHNob3VsZCBiZSAnVCcgb3Igc3BhY2UKICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZvcm1hdCA9IChtYXRjaFsyXSB8fCAnICcpICsgaXNvVGltZXNbaV1bMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aW1lRm9ybWF0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcuX2lzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFhbGxvd1RpbWUgJiYgdGltZUZvcm1hdCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBjb25maWcuX2lzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWF0Y2hbNF0pIHsKICAgICAgICAgICAgICAgIGlmICh0elJlZ2V4LmV4ZWMobWF0Y2hbNF0pKSB7CiAgICAgICAgICAgICAgICAgICAgdHpGb3JtYXQgPSAnWic7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25maWcuX2YgPSBkYXRlRm9ybWF0ICsgKHRpbWVGb3JtYXQgfHwgJycpICsgKHR6Rm9ybWF0IHx8ICcnKTsKICAgICAgICAgICAgY29uZmlnRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBSRkMgMjgyMiByZWdleDogRm9yIGRldGFpbHMgc2VlIGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMyODIyI3NlY3Rpb24tMy4zCiAgICB2YXIgcmZjMjgyMiA9IC9eKD86KE1vbnxUdWV8V2VkfFRodXxGcml8U2F0fFN1biksP1xzKT8oXGR7MSwyfSlccyhKYW58RmVifE1hcnxBcHJ8TWF5fEp1bnxKdWx8QXVnfFNlcHxPY3R8Tm92fERlYylccyhcZHsyLDR9KVxzKFxkXGQpOihcZFxkKSg/OjooXGRcZCkpP1xzKD86KFVUfEdNVHxbRUNNUF1bU0RdVCl8KFtael0pfChbKy1dXGR7NH0pKSQvOwoKICAgIGZ1bmN0aW9uIGV4dHJhY3RGcm9tUkZDMjgyMlN0cmluZ3MoeWVhclN0ciwgbW9udGhTdHIsIGRheVN0ciwgaG91clN0ciwgbWludXRlU3RyLCBzZWNvbmRTdHIpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gWwogICAgICAgICAgICB1bnRydW5jYXRlWWVhcih5ZWFyU3RyKSwKICAgICAgICAgICAgZGVmYXVsdExvY2FsZU1vbnRoc1Nob3J0LmluZGV4T2YobW9udGhTdHIpLAogICAgICAgICAgICBwYXJzZUludChkYXlTdHIsIDEwKSwKICAgICAgICAgICAgcGFyc2VJbnQoaG91clN0ciwgMTApLAogICAgICAgICAgICBwYXJzZUludChtaW51dGVTdHIsIDEwKQogICAgICAgIF07CgogICAgICAgIGlmIChzZWNvbmRTdHIpIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2gocGFyc2VJbnQoc2Vjb25kU3RyLCAxMCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiB1bnRydW5jYXRlWWVhcih5ZWFyU3RyKSB7CiAgICAgICAgdmFyIHllYXIgPSBwYXJzZUludCh5ZWFyU3RyLCAxMCk7CiAgICAgICAgaWYgKHllYXIgPD0gNDkpIHsKICAgICAgICAgICAgcmV0dXJuIDIwMDAgKyB5ZWFyOwogICAgICAgIH0gZWxzZSBpZiAoeWVhciA8PSA5OTkpIHsKICAgICAgICAgICAgcmV0dXJuIDE5MDAgKyB5ZWFyOwogICAgICAgIH0KICAgICAgICByZXR1cm4geWVhcjsKICAgIH0KCiAgICBmdW5jdGlvbiBwcmVwcm9jZXNzUkZDMjgyMihzKSB7CiAgICAgICAgLy8gUmVtb3ZlIGNvbW1lbnRzIGFuZCBmb2xkaW5nIHdoaXRlc3BhY2UgYW5kIHJlcGxhY2UgbXVsdGlwbGUtc3BhY2VzIHdpdGggYSBzaW5nbGUgc3BhY2UKICAgICAgICByZXR1cm4gcy5yZXBsYWNlKC9cKFteKV0qXCl8W1xuXHRdL2csICcgJykucmVwbGFjZSgvKFxzXHMrKS9nLCAnICcpLnJlcGxhY2UoL15cc1xzKi8sICcnKS5yZXBsYWNlKC9cc1xzKiQvLCAnJyk7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tXZWVrZGF5KHdlZWtkYXlTdHIsIHBhcnNlZElucHV0LCBjb25maWcpIHsKICAgICAgICBpZiAod2Vla2RheVN0cikgewogICAgICAgICAgICAvLyBUT0RPOiBSZXBsYWNlIHRoZSB2YW5pbGxhIEpTIERhdGUgb2JqZWN0IHdpdGggYW4gaW5kZXBlbnRlbnQgZGF5LW9mLXdlZWsgY2hlY2suCiAgICAgICAgICAgIHZhciB3ZWVrZGF5UHJvdmlkZWQgPSBkZWZhdWx0TG9jYWxlV2Vla2RheXNTaG9ydC5pbmRleE9mKHdlZWtkYXlTdHIpLAogICAgICAgICAgICAgICAgd2Vla2RheUFjdHVhbCA9IG5ldyBEYXRlKHBhcnNlZElucHV0WzBdLCBwYXJzZWRJbnB1dFsxXSwgcGFyc2VkSW5wdXRbMl0pLmdldERheSgpOwogICAgICAgICAgICBpZiAod2Vla2RheVByb3ZpZGVkICE9PSB3ZWVrZGF5QWN0dWFsKSB7CiAgICAgICAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS53ZWVrZGF5TWlzbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgICAgY29uZmlnLl9pc1ZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgdmFyIG9ic09mZnNldHMgPSB7CiAgICAgICAgVVQ6IDAsCiAgICAgICAgR01UOiAwLAogICAgICAgIEVEVDogLTQgKiA2MCwKICAgICAgICBFU1Q6IC01ICogNjAsCiAgICAgICAgQ0RUOiAtNSAqIDYwLAogICAgICAgIENTVDogLTYgKiA2MCwKICAgICAgICBNRFQ6IC02ICogNjAsCiAgICAgICAgTVNUOiAtNyAqIDYwLAogICAgICAgIFBEVDogLTcgKiA2MCwKICAgICAgICBQU1Q6IC04ICogNjAKICAgIH07CgogICAgZnVuY3Rpb24gY2FsY3VsYXRlT2Zmc2V0KG9ic09mZnNldCwgbWlsaXRhcnlPZmZzZXQsIG51bU9mZnNldCkgewogICAgICAgIGlmIChvYnNPZmZzZXQpIHsKICAgICAgICAgICAgcmV0dXJuIG9ic09mZnNldHNbb2JzT2Zmc2V0XTsKICAgICAgICB9IGVsc2UgaWYgKG1pbGl0YXJ5T2Zmc2V0KSB7CiAgICAgICAgICAgIC8vIHRoZSBvbmx5IGFsbG93ZWQgbWlsaXRhcnkgdHogaXMgWgogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaG0gPSBwYXJzZUludChudW1PZmZzZXQsIDEwKTsKICAgICAgICAgICAgdmFyIG0gPSBobSAlIDEwMCwgaCA9IChobSAtIG0pIC8gMTAwOwogICAgICAgICAgICByZXR1cm4gaCAqIDYwICsgbTsKICAgICAgICB9CiAgICB9CgogICAgLy8gZGF0ZSBhbmQgdGltZSBmcm9tIHJlZiAyODIyIGZvcm1hdAogICAgZnVuY3Rpb24gY29uZmlnRnJvbVJGQzI4MjIoY29uZmlnKSB7CiAgICAgICAgdmFyIG1hdGNoID0gcmZjMjgyMi5leGVjKHByZXByb2Nlc3NSRkMyODIyKGNvbmZpZy5faSkpOwogICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICB2YXIgcGFyc2VkQXJyYXkgPSBleHRyYWN0RnJvbVJGQzI4MjJTdHJpbmdzKG1hdGNoWzRdLCBtYXRjaFszXSwgbWF0Y2hbMl0sIG1hdGNoWzVdLCBtYXRjaFs2XSwgbWF0Y2hbN10pOwogICAgICAgICAgICBpZiAoIWNoZWNrV2Vla2RheShtYXRjaFsxXSwgcGFyc2VkQXJyYXksIGNvbmZpZykpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uZmlnLl9hID0gcGFyc2VkQXJyYXk7CiAgICAgICAgICAgIGNvbmZpZy5fdHptID0gY2FsY3VsYXRlT2Zmc2V0KG1hdGNoWzhdLCBtYXRjaFs5XSwgbWF0Y2hbMTBdKTsKCiAgICAgICAgICAgIGNvbmZpZy5fZCA9IGNyZWF0ZVVUQ0RhdGUuYXBwbHkobnVsbCwgY29uZmlnLl9hKTsKICAgICAgICAgICAgY29uZmlnLl9kLnNldFVUQ01pbnV0ZXMoY29uZmlnLl9kLmdldFVUQ01pbnV0ZXMoKSAtIGNvbmZpZy5fdHptKTsKCiAgICAgICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLnJmYzI4MjIgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBkYXRlIGZyb20gaXNvIGZvcm1hdCBvciBmYWxsYmFjawogICAgZnVuY3Rpb24gY29uZmlnRnJvbVN0cmluZyhjb25maWcpIHsKICAgICAgICB2YXIgbWF0Y2hlZCA9IGFzcE5ldEpzb25SZWdleC5leGVjKGNvbmZpZy5faSk7CgogICAgICAgIGlmIChtYXRjaGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKCttYXRjaGVkWzFdKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uZmlnRnJvbUlTTyhjb25maWcpOwogICAgICAgIGlmIChjb25maWcuX2lzVmFsaWQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGRlbGV0ZSBjb25maWcuX2lzVmFsaWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uZmlnRnJvbVJGQzI4MjIoY29uZmlnKTsKICAgICAgICBpZiAoY29uZmlnLl9pc1ZhbGlkID09PSBmYWxzZSkgewogICAgICAgICAgICBkZWxldGUgY29uZmlnLl9pc1ZhbGlkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIEZpbmFsIGF0dGVtcHQsIHVzZSBJbnB1dCBGYWxsYmFjawogICAgICAgIGhvb2tzLmNyZWF0ZUZyb21JbnB1dEZhbGxiYWNrKGNvbmZpZyk7CiAgICB9CgogICAgaG9va3MuY3JlYXRlRnJvbUlucHV0RmFsbGJhY2sgPSBkZXByZWNhdGUoCiAgICAgICAgJ3ZhbHVlIHByb3ZpZGVkIGlzIG5vdCBpbiBhIHJlY29nbml6ZWQgUkZDMjgyMiBvciBJU08gZm9ybWF0LiBtb21lbnQgY29uc3RydWN0aW9uIGZhbGxzIGJhY2sgdG8ganMgRGF0ZSgpLCAnICsKICAgICAgICAnd2hpY2ggaXMgbm90IHJlbGlhYmxlIGFjcm9zcyBhbGwgYnJvd3NlcnMgYW5kIHZlcnNpb25zLiBOb24gUkZDMjgyMi9JU08gZGF0ZSBmb3JtYXRzIGFyZSAnICsKICAgICAgICAnZGlzY291cmFnZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhbiB1cGNvbWluZyBtYWpvciByZWxlYXNlLiBQbGVhc2UgcmVmZXIgdG8gJyArCiAgICAgICAgJ2h0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvanMtZGF0ZS8gZm9yIG1vcmUgaW5mby4nLAogICAgICAgIGZ1bmN0aW9uIChjb25maWcpIHsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoY29uZmlnLl9pICsgKGNvbmZpZy5fdXNlVVRDID8gJyBVVEMnIDogJycpKTsKICAgICAgICB9CiAgICApOwoKICAgIC8vIGNvbnN0YW50IHRoYXQgcmVmZXJzIHRvIHRoZSBJU08gc3RhbmRhcmQKICAgIGhvb2tzLklTT184NjAxID0gZnVuY3Rpb24gKCkge307CgogICAgLy8gY29uc3RhbnQgdGhhdCByZWZlcnMgdG8gdGhlIFJGQyAyODIyIGZvcm0KICAgIGhvb2tzLlJGQ18yODIyID0gZnVuY3Rpb24gKCkge307CgogICAgLy8gZGF0ZSBmcm9tIHN0cmluZyBhbmQgZm9ybWF0IHN0cmluZwogICAgZnVuY3Rpb24gY29uZmlnRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpIHsKICAgICAgICAvLyBUT0RPOiBNb3ZlIHRoaXMgdG8gYW5vdGhlciBwYXJ0IG9mIHRoZSBjcmVhdGlvbiBmbG93IHRvIHByZXZlbnQgY2lyY3VsYXIgZGVwcwogICAgICAgIGlmIChjb25maWcuX2YgPT09IGhvb2tzLklTT184NjAxKSB7CiAgICAgICAgICAgIGNvbmZpZ0Zyb21JU08oY29uZmlnKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoY29uZmlnLl9mID09PSBob29rcy5SRkNfMjgyMikgewogICAgICAgICAgICBjb25maWdGcm9tUkZDMjgyMihjb25maWcpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbmZpZy5fYSA9IFtdOwogICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLmVtcHR5ID0gdHJ1ZTsKCiAgICAgICAgLy8gVGhpcyBhcnJheSBpcyB1c2VkIHRvIG1ha2UgYSBEYXRlLCBlaXRoZXIgd2l0aCBgbmV3IERhdGVgIG9yIGBEYXRlLlVUQ2AKICAgICAgICB2YXIgc3RyaW5nID0gJycgKyBjb25maWcuX2ksCiAgICAgICAgICAgIGksIHBhcnNlZElucHV0LCB0b2tlbnMsIHRva2VuLCBza2lwcGVkLAogICAgICAgICAgICBzdHJpbmdMZW5ndGggPSBzdHJpbmcubGVuZ3RoLAogICAgICAgICAgICB0b3RhbFBhcnNlZElucHV0TGVuZ3RoID0gMDsKCiAgICAgICAgdG9rZW5zID0gZXhwYW5kRm9ybWF0KGNvbmZpZy5fZiwgY29uZmlnLl9sb2NhbGUpLm1hdGNoKGZvcm1hdHRpbmdUb2tlbnMpIHx8IFtdOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRva2VuID0gdG9rZW5zW2ldOwogICAgICAgICAgICBwYXJzZWRJbnB1dCA9IChzdHJpbmcubWF0Y2goZ2V0UGFyc2VSZWdleEZvclRva2VuKHRva2VuLCBjb25maWcpKSB8fCBbXSlbMF07CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCd0b2tlbicsIHRva2VuLCAncGFyc2VkSW5wdXQnLCBwYXJzZWRJbnB1dCwKICAgICAgICAgICAgLy8gICAgICAgICAncmVnZXgnLCBnZXRQYXJzZVJlZ2V4Rm9yVG9rZW4odG9rZW4sIGNvbmZpZykpOwogICAgICAgICAgICBpZiAocGFyc2VkSW5wdXQpIHsKICAgICAgICAgICAgICAgIHNraXBwZWQgPSBzdHJpbmcuc3Vic3RyKDAsIHN0cmluZy5pbmRleE9mKHBhcnNlZElucHV0KSk7CiAgICAgICAgICAgICAgICBpZiAoc2tpcHBlZC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykudW51c2VkSW5wdXQucHVzaChza2lwcGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zbGljZShzdHJpbmcuaW5kZXhPZihwYXJzZWRJbnB1dCkgKyBwYXJzZWRJbnB1dC5sZW5ndGgpOwogICAgICAgICAgICAgICAgdG90YWxQYXJzZWRJbnB1dExlbmd0aCArPSBwYXJzZWRJbnB1dC5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gZG9uJ3QgcGFyc2UgaWYgaXQncyBub3QgYSBrbm93biB0b2tlbgogICAgICAgICAgICBpZiAoZm9ybWF0VG9rZW5GdW5jdGlvbnNbdG9rZW5dKSB7CiAgICAgICAgICAgICAgICBpZiAocGFyc2VkSW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5lbXB0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykudW51c2VkVG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWRkVGltZVRvQXJyYXlGcm9tVG9rZW4odG9rZW4sIHBhcnNlZElucHV0LCBjb25maWcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGNvbmZpZy5fc3RyaWN0ICYmICFwYXJzZWRJbnB1dCkgewogICAgICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykudW51c2VkVG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBhZGQgcmVtYWluaW5nIHVucGFyc2VkIGlucHV0IGxlbmd0aCB0byB0aGUgc3RyaW5nCiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuY2hhcnNMZWZ0T3ZlciA9IHN0cmluZ0xlbmd0aCAtIHRvdGFsUGFyc2VkSW5wdXRMZW5ndGg7CiAgICAgICAgaWYgKHN0cmluZy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLnVudXNlZElucHV0LnB1c2goc3RyaW5nKTsKICAgICAgICB9CgogICAgICAgIC8vIGNsZWFyIF8xMmggZmxhZyBpZiBob3VyIGlzIDw9IDEyCiAgICAgICAgaWYgKGNvbmZpZy5fYVtIT1VSXSA8PSAxMiAmJgogICAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5iaWdIb3VyID09PSB0cnVlICYmCiAgICAgICAgICAgIGNvbmZpZy5fYVtIT1VSXSA+IDApIHsKICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuYmlnSG91ciA9IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLnBhcnNlZERhdGVQYXJ0cyA9IGNvbmZpZy5fYS5zbGljZSgwKTsKICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5tZXJpZGllbSA9IGNvbmZpZy5fbWVyaWRpZW07CiAgICAgICAgLy8gaGFuZGxlIG1lcmlkaWVtCiAgICAgICAgY29uZmlnLl9hW0hPVVJdID0gbWVyaWRpZW1GaXhXcmFwKGNvbmZpZy5fbG9jYWxlLCBjb25maWcuX2FbSE9VUl0sIGNvbmZpZy5fbWVyaWRpZW0pOwoKICAgICAgICBjb25maWdGcm9tQXJyYXkoY29uZmlnKTsKICAgICAgICBjaGVja092ZXJmbG93KGNvbmZpZyk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1lcmlkaWVtRml4V3JhcCAobG9jYWxlLCBob3VyLCBtZXJpZGllbSkgewogICAgICAgIHZhciBpc1BtOwoKICAgICAgICBpZiAobWVyaWRpZW0gPT0gbnVsbCkgewogICAgICAgICAgICAvLyBub3RoaW5nIHRvIGRvCiAgICAgICAgICAgIHJldHVybiBob3VyOwogICAgICAgIH0KICAgICAgICBpZiAobG9jYWxlLm1lcmlkaWVtSG91ciAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbGUubWVyaWRpZW1Ib3VyKGhvdXIsIG1lcmlkaWVtKTsKICAgICAgICB9IGVsc2UgaWYgKGxvY2FsZS5pc1BNICE9IG51bGwpIHsKICAgICAgICAgICAgLy8gRmFsbGJhY2sKICAgICAgICAgICAgaXNQbSA9IGxvY2FsZS5pc1BNKG1lcmlkaWVtKTsKICAgICAgICAgICAgaWYgKGlzUG0gJiYgaG91ciA8IDEyKSB7CiAgICAgICAgICAgICAgICBob3VyICs9IDEyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNQbSAmJiBob3VyID09PSAxMikgewogICAgICAgICAgICAgICAgaG91ciA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGhvdXI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdGhpcyBpcyBub3Qgc3VwcG9zZWQgdG8gaGFwcGVuCiAgICAgICAgICAgIHJldHVybiBob3VyOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBkYXRlIGZyb20gc3RyaW5nIGFuZCBhcnJheSBvZiBmb3JtYXQgc3RyaW5ncwogICAgZnVuY3Rpb24gY29uZmlnRnJvbVN0cmluZ0FuZEFycmF5KGNvbmZpZykgewogICAgICAgIHZhciB0ZW1wQ29uZmlnLAogICAgICAgICAgICBiZXN0TW9tZW50LAoKICAgICAgICAgICAgc2NvcmVUb0JlYXQsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGN1cnJlbnRTY29yZTsKCiAgICAgICAgaWYgKGNvbmZpZy5fZi5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuaW52YWxpZEZvcm1hdCA9IHRydWU7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKE5hTik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb25maWcuX2YubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY3VycmVudFNjb3JlID0gMDsKICAgICAgICAgICAgdGVtcENvbmZpZyA9IGNvcHlDb25maWcoe30sIGNvbmZpZyk7CiAgICAgICAgICAgIGlmIChjb25maWcuX3VzZVVUQyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZW1wQ29uZmlnLl91c2VVVEMgPSBjb25maWcuX3VzZVVUQzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0ZW1wQ29uZmlnLl9mID0gY29uZmlnLl9mW2ldOwogICAgICAgICAgICBjb25maWdGcm9tU3RyaW5nQW5kRm9ybWF0KHRlbXBDb25maWcpOwoKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKHRlbXBDb25maWcpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdGhlcmUgaXMgYW55IGlucHV0IHRoYXQgd2FzIG5vdCBwYXJzZWQgYWRkIGEgcGVuYWx0eSBmb3IgdGhhdCBmb3JtYXQKICAgICAgICAgICAgY3VycmVudFNjb3JlICs9IGdldFBhcnNpbmdGbGFncyh0ZW1wQ29uZmlnKS5jaGFyc0xlZnRPdmVyOwoKICAgICAgICAgICAgLy9vciB0b2tlbnMKICAgICAgICAgICAgY3VycmVudFNjb3JlICs9IGdldFBhcnNpbmdGbGFncyh0ZW1wQ29uZmlnKS51bnVzZWRUb2tlbnMubGVuZ3RoICogMTA7CgogICAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3ModGVtcENvbmZpZykuc2NvcmUgPSBjdXJyZW50U2NvcmU7CgogICAgICAgICAgICBpZiAoc2NvcmVUb0JlYXQgPT0gbnVsbCB8fCBjdXJyZW50U2NvcmUgPCBzY29yZVRvQmVhdCkgewogICAgICAgICAgICAgICAgc2NvcmVUb0JlYXQgPSBjdXJyZW50U2NvcmU7CiAgICAgICAgICAgICAgICBiZXN0TW9tZW50ID0gdGVtcENvbmZpZzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZXh0ZW5kKGNvbmZpZywgYmVzdE1vbWVudCB8fCB0ZW1wQ29uZmlnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjb25maWdGcm9tT2JqZWN0KGNvbmZpZykgewogICAgICAgIGlmIChjb25maWcuX2QpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGkgPSBub3JtYWxpemVPYmplY3RVbml0cyhjb25maWcuX2kpOwogICAgICAgIGNvbmZpZy5fYSA9IG1hcChbaS55ZWFyLCBpLm1vbnRoLCBpLmRheSB8fCBpLmRhdGUsIGkuaG91ciwgaS5taW51dGUsIGkuc2Vjb25kLCBpLm1pbGxpc2Vjb25kXSwgZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIHBhcnNlSW50KG9iaiwgMTApOwogICAgICAgIH0pOwoKICAgICAgICBjb25maWdGcm9tQXJyYXkoY29uZmlnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVGcm9tQ29uZmlnIChjb25maWcpIHsKICAgICAgICB2YXIgcmVzID0gbmV3IE1vbWVudChjaGVja092ZXJmbG93KHByZXBhcmVDb25maWcoY29uZmlnKSkpOwogICAgICAgIGlmIChyZXMuX25leHREYXkpIHsKICAgICAgICAgICAgLy8gQWRkaW5nIGlzIHNtYXJ0IGVub3VnaCBhcm91bmQgRFNUCiAgICAgICAgICAgIHJlcy5hZGQoMSwgJ2QnKTsKICAgICAgICAgICAgcmVzLl9uZXh0RGF5ID0gdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBwcmVwYXJlQ29uZmlnIChjb25maWcpIHsKICAgICAgICB2YXIgaW5wdXQgPSBjb25maWcuX2ksCiAgICAgICAgICAgIGZvcm1hdCA9IGNvbmZpZy5fZjsKCiAgICAgICAgY29uZmlnLl9sb2NhbGUgPSBjb25maWcuX2xvY2FsZSB8fCBnZXRMb2NhbGUoY29uZmlnLl9sKTsKCiAgICAgICAgaWYgKGlucHV0ID09PSBudWxsIHx8IChmb3JtYXQgPT09IHVuZGVmaW5lZCAmJiBpbnB1dCA9PT0gJycpKSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVJbnZhbGlkKHtudWxsSW5wdXQ6IHRydWV9KTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbmZpZy5faSA9IGlucHV0ID0gY29uZmlnLl9sb2NhbGUucHJlcGFyc2UoaW5wdXQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzTW9tZW50KGlucHV0KSkgewogICAgICAgICAgICByZXR1cm4gbmV3IE1vbWVudChjaGVja092ZXJmbG93KGlucHV0KSk7CiAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUoaW5wdXQpKSB7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IGlucHV0OwogICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShmb3JtYXQpKSB7CiAgICAgICAgICAgIGNvbmZpZ0Zyb21TdHJpbmdBbmRBcnJheShjb25maWcpOwogICAgICAgIH0gZWxzZSBpZiAoZm9ybWF0KSB7CiAgICAgICAgICAgIGNvbmZpZ0Zyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKTsKICAgICAgICB9ICBlbHNlIHsKICAgICAgICAgICAgY29uZmlnRnJvbUlucHV0KGNvbmZpZyk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWlzVmFsaWQoY29uZmlnKSkgewogICAgICAgICAgICBjb25maWcuX2QgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNvbmZpZzsKICAgIH0KCiAgICBmdW5jdGlvbiBjb25maWdGcm9tSW5wdXQoY29uZmlnKSB7CiAgICAgICAgdmFyIGlucHV0ID0gY29uZmlnLl9pOwogICAgICAgIGlmIChpc1VuZGVmaW5lZChpbnB1dCkpIHsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoaG9va3Mubm93KCkpOwogICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKGlucHV0KSkgewogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShpbnB1dC52YWx1ZU9mKCkpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25maWdGcm9tU3RyaW5nKGNvbmZpZyk7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGlucHV0KSkgewogICAgICAgICAgICBjb25maWcuX2EgPSBtYXAoaW5wdXQuc2xpY2UoMCksIGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUludChvYmosIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbmZpZ0Zyb21BcnJheShjb25maWcpOwogICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoaW5wdXQpKSB7CiAgICAgICAgICAgIGNvbmZpZ0Zyb21PYmplY3QoY29uZmlnKTsKICAgICAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKGlucHV0KSkgewogICAgICAgICAgICAvLyBmcm9tIG1pbGxpc2Vjb25kcwogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShpbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaG9va3MuY3JlYXRlRnJvbUlucHV0RmFsbGJhY2soY29uZmlnKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlTG9jYWxPclVUQyAoaW5wdXQsIGZvcm1hdCwgbG9jYWxlLCBzdHJpY3QsIGlzVVRDKSB7CiAgICAgICAgdmFyIGMgPSB7fTsKCiAgICAgICAgaWYgKGxvY2FsZSA9PT0gdHJ1ZSB8fCBsb2NhbGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHN0cmljdCA9IGxvY2FsZTsKICAgICAgICAgICAgbG9jYWxlID0gdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgICAgaWYgKChpc09iamVjdChpbnB1dCkgJiYgaXNPYmplY3RFbXB0eShpbnB1dCkpIHx8CiAgICAgICAgICAgICAgICAoaXNBcnJheShpbnB1dCkgJiYgaW5wdXQubGVuZ3RoID09PSAwKSkgewogICAgICAgICAgICBpbnB1dCA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgLy8gb2JqZWN0IGNvbnN0cnVjdGlvbiBtdXN0IGJlIGRvbmUgdGhpcyB3YXkuCiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzE0MjMKICAgICAgICBjLl9pc0FNb21lbnRPYmplY3QgPSB0cnVlOwogICAgICAgIGMuX3VzZVVUQyA9IGMuX2lzVVRDID0gaXNVVEM7CiAgICAgICAgYy5fbCA9IGxvY2FsZTsKICAgICAgICBjLl9pID0gaW5wdXQ7CiAgICAgICAgYy5fZiA9IGZvcm1hdDsKICAgICAgICBjLl9zdHJpY3QgPSBzdHJpY3Q7CgogICAgICAgIHJldHVybiBjcmVhdGVGcm9tQ29uZmlnKGMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUxvY2FsIChpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCkgewogICAgICAgIHJldHVybiBjcmVhdGVMb2NhbE9yVVRDKGlucHV0LCBmb3JtYXQsIGxvY2FsZSwgc3RyaWN0LCBmYWxzZSk7CiAgICB9CgogICAgdmFyIHByb3RvdHlwZU1pbiA9IGRlcHJlY2F0ZSgKICAgICAgICAnbW9tZW50KCkubWluIGlzIGRlcHJlY2F0ZWQsIHVzZSBtb21lbnQubWF4IGluc3RlYWQuIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvbWluLW1heC8nLAogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG90aGVyID0gY3JlYXRlTG9jYWwuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNWYWxpZCgpICYmIG90aGVyLmlzVmFsaWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG90aGVyIDwgdGhpcyA/IHRoaXMgOiBvdGhlcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVJbnZhbGlkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICApOwoKICAgIHZhciBwcm90b3R5cGVNYXggPSBkZXByZWNhdGUoCiAgICAgICAgJ21vbWVudCgpLm1heCBpcyBkZXByZWNhdGVkLCB1c2UgbW9tZW50Lm1pbiBpbnN0ZWFkLiBodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL21pbi1tYXgvJywKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBvdGhlciA9IGNyZWF0ZUxvY2FsLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmICh0aGlzLmlzVmFsaWQoKSAmJiBvdGhlci5pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvdGhlciA+IHRoaXMgPyB0aGlzIDogb3RoZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlSW52YWxpZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgKTsKCiAgICAvLyBQaWNrIGEgbW9tZW50IG0gZnJvbSBtb21lbnRzIHNvIHRoYXQgbVtmbl0ob3RoZXIpIGlzIHRydWUgZm9yIGFsbAogICAgLy8gb3RoZXIuIFRoaXMgcmVsaWVzIG9uIHRoZSBmdW5jdGlvbiBmbiB0byBiZSB0cmFuc2l0aXZlLgogICAgLy8KICAgIC8vIG1vbWVudHMgc2hvdWxkIGVpdGhlciBiZSBhbiBhcnJheSBvZiBtb21lbnQgb2JqZWN0cyBvciBhbiBhcnJheSwgd2hvc2UKICAgIC8vIGZpcnN0IGVsZW1lbnQgaXMgYW4gYXJyYXkgb2YgbW9tZW50IG9iamVjdHMuCiAgICBmdW5jdGlvbiBwaWNrQnkoZm4sIG1vbWVudHMpIHsKICAgICAgICB2YXIgcmVzLCBpOwogICAgICAgIGlmIChtb21lbnRzLmxlbmd0aCA9PT0gMSAmJiBpc0FycmF5KG1vbWVudHNbMF0pKSB7CiAgICAgICAgICAgIG1vbWVudHMgPSBtb21lbnRzWzBdOwogICAgICAgIH0KICAgICAgICBpZiAoIW1vbWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVMb2NhbCgpOwogICAgICAgIH0KICAgICAgICByZXMgPSBtb21lbnRzWzBdOwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBtb21lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmICghbW9tZW50c1tpXS5pc1ZhbGlkKCkgfHwgbW9tZW50c1tpXVtmbl0ocmVzKSkgewogICAgICAgICAgICAgICAgcmVzID0gbW9tZW50c1tpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIC8vIFRPRE86IFVzZSBbXS5zb3J0IGluc3RlYWQ/CiAgICBmdW5jdGlvbiBtaW4gKCkgewogICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwoKICAgICAgICByZXR1cm4gcGlja0J5KCdpc0JlZm9yZScsIGFyZ3MpOwogICAgfQoKICAgIGZ1bmN0aW9uIG1heCAoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CgogICAgICAgIHJldHVybiBwaWNrQnkoJ2lzQWZ0ZXInLCBhcmdzKTsKICAgIH0KCiAgICB2YXIgbm93ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBEYXRlLm5vdyA/IERhdGUubm93KCkgOiArKG5ldyBEYXRlKCkpOwogICAgfTsKCiAgICB2YXIgb3JkZXJpbmcgPSBbJ3llYXInLCAncXVhcnRlcicsICdtb250aCcsICd3ZWVrJywgJ2RheScsICdob3VyJywgJ21pbnV0ZScsICdzZWNvbmQnLCAnbWlsbGlzZWNvbmQnXTsKCiAgICBmdW5jdGlvbiBpc0R1cmF0aW9uVmFsaWQobSkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBtKSB7CiAgICAgICAgICAgIGlmICghKGluZGV4T2YuY2FsbChvcmRlcmluZywga2V5KSAhPT0gLTEgJiYgKG1ba2V5XSA9PSBudWxsIHx8ICFpc05hTihtW2tleV0pKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHVuaXRIYXNEZWNpbWFsID0gZmFsc2U7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvcmRlcmluZy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAobVtvcmRlcmluZ1tpXV0pIHsKICAgICAgICAgICAgICAgIGlmICh1bml0SGFzRGVjaW1hbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gb25seSBhbGxvdyBub24taW50ZWdlcnMgZm9yIHNtYWxsZXN0IHVuaXQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwYXJzZUZsb2F0KG1bb3JkZXJpbmdbaV1dKSAhPT0gdG9JbnQobVtvcmRlcmluZ1tpXV0pKSB7CiAgICAgICAgICAgICAgICAgICAgdW5pdEhhc0RlY2ltYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc1ZhbGlkJDEoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2lzVmFsaWQ7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlSW52YWxpZCQxKCkgewogICAgICAgIHJldHVybiBjcmVhdGVEdXJhdGlvbihOYU4pOwogICAgfQoKICAgIGZ1bmN0aW9uIER1cmF0aW9uIChkdXJhdGlvbikgewogICAgICAgIHZhciBub3JtYWxpemVkSW5wdXQgPSBub3JtYWxpemVPYmplY3RVbml0cyhkdXJhdGlvbiksCiAgICAgICAgICAgIHllYXJzID0gbm9ybWFsaXplZElucHV0LnllYXIgfHwgMCwKICAgICAgICAgICAgcXVhcnRlcnMgPSBub3JtYWxpemVkSW5wdXQucXVhcnRlciB8fCAwLAogICAgICAgICAgICBtb250aHMgPSBub3JtYWxpemVkSW5wdXQubW9udGggfHwgMCwKICAgICAgICAgICAgd2Vla3MgPSBub3JtYWxpemVkSW5wdXQud2VlayB8fCBub3JtYWxpemVkSW5wdXQuaXNvV2VlayB8fCAwLAogICAgICAgICAgICBkYXlzID0gbm9ybWFsaXplZElucHV0LmRheSB8fCAwLAogICAgICAgICAgICBob3VycyA9IG5vcm1hbGl6ZWRJbnB1dC5ob3VyIHx8IDAsCiAgICAgICAgICAgIG1pbnV0ZXMgPSBub3JtYWxpemVkSW5wdXQubWludXRlIHx8IDAsCiAgICAgICAgICAgIHNlY29uZHMgPSBub3JtYWxpemVkSW5wdXQuc2Vjb25kIHx8IDAsCiAgICAgICAgICAgIG1pbGxpc2Vjb25kcyA9IG5vcm1hbGl6ZWRJbnB1dC5taWxsaXNlY29uZCB8fCAwOwoKICAgICAgICB0aGlzLl9pc1ZhbGlkID0gaXNEdXJhdGlvblZhbGlkKG5vcm1hbGl6ZWRJbnB1dCk7CgogICAgICAgIC8vIHJlcHJlc2VudGF0aW9uIGZvciBkYXRlQWRkUmVtb3ZlCiAgICAgICAgdGhpcy5fbWlsbGlzZWNvbmRzID0gK21pbGxpc2Vjb25kcyArCiAgICAgICAgICAgIHNlY29uZHMgKiAxZTMgKyAvLyAxMDAwCiAgICAgICAgICAgIG1pbnV0ZXMgKiA2ZTQgKyAvLyAxMDAwICogNjAKICAgICAgICAgICAgaG91cnMgKiAxMDAwICogNjAgKiA2MDsgLy91c2luZyAxMDAwICogNjAgKiA2MCBpbnN0ZWFkIG9mIDM2ZTUgdG8gYXZvaWQgZmxvYXRpbmcgcG9pbnQgcm91bmRpbmcgZXJyb3JzIGh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnQvbW9tZW50L2lzc3Vlcy8yOTc4CiAgICAgICAgLy8gQmVjYXVzZSBvZiBkYXRlQWRkUmVtb3ZlIHRyZWF0cyAyNCBob3VycyBhcyBkaWZmZXJlbnQgZnJvbSBhCiAgICAgICAgLy8gZGF5IHdoZW4gd29ya2luZyBhcm91bmQgRFNULCB3ZSBuZWVkIHRvIHN0b3JlIHRoZW0gc2VwYXJhdGVseQogICAgICAgIHRoaXMuX2RheXMgPSArZGF5cyArCiAgICAgICAgICAgIHdlZWtzICogNzsKICAgICAgICAvLyBJdCBpcyBpbXBvc3NpYmxlIHRvIHRyYW5zbGF0ZSBtb250aHMgaW50byBkYXlzIHdpdGhvdXQga25vd2luZwogICAgICAgIC8vIHdoaWNoIG1vbnRocyB5b3UgYXJlIGFyZSB0YWxraW5nIGFib3V0LCBzbyB3ZSBoYXZlIHRvIHN0b3JlCiAgICAgICAgLy8gaXQgc2VwYXJhdGVseS4KICAgICAgICB0aGlzLl9tb250aHMgPSArbW9udGhzICsKICAgICAgICAgICAgcXVhcnRlcnMgKiAzICsKICAgICAgICAgICAgeWVhcnMgKiAxMjsKCiAgICAgICAgdGhpcy5fZGF0YSA9IHt9OwoKICAgICAgICB0aGlzLl9sb2NhbGUgPSBnZXRMb2NhbGUoKTsKCiAgICAgICAgdGhpcy5fYnViYmxlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNEdXJhdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIER1cmF0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGFic1JvdW5kIChudW1iZXIpIHsKICAgICAgICBpZiAobnVtYmVyIDwgMCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCgtMSAqIG51bWJlcikgKiAtMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChudW1iZXIpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBGT1JNQVRUSU5HCgogICAgZnVuY3Rpb24gb2Zmc2V0ICh0b2tlbiwgc2VwYXJhdG9yKSB7CiAgICAgICAgYWRkRm9ybWF0VG9rZW4odG9rZW4sIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG9mZnNldCA9IHRoaXMudXRjT2Zmc2V0KCk7CiAgICAgICAgICAgIHZhciBzaWduID0gJysnOwogICAgICAgICAgICBpZiAob2Zmc2V0IDwgMCkgewogICAgICAgICAgICAgICAgb2Zmc2V0ID0gLW9mZnNldDsKICAgICAgICAgICAgICAgIHNpZ24gPSAnLSc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNpZ24gKyB6ZXJvRmlsbCh+fihvZmZzZXQgLyA2MCksIDIpICsgc2VwYXJhdG9yICsgemVyb0ZpbGwofn4ob2Zmc2V0KSAlIDYwLCAyKTsKICAgICAgICB9KTsKICAgIH0KCiAgICBvZmZzZXQoJ1onLCAnOicpOwogICAgb2Zmc2V0KCdaWicsICcnKTsKCiAgICAvLyBQQVJTSU5HCgogICAgYWRkUmVnZXhUb2tlbignWicsICBtYXRjaFNob3J0T2Zmc2V0KTsKICAgIGFkZFJlZ2V4VG9rZW4oJ1paJywgbWF0Y2hTaG9ydE9mZnNldCk7CiAgICBhZGRQYXJzZVRva2VuKFsnWicsICdaWiddLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcpIHsKICAgICAgICBjb25maWcuX3VzZVVUQyA9IHRydWU7CiAgICAgICAgY29uZmlnLl90em0gPSBvZmZzZXRGcm9tU3RyaW5nKG1hdGNoU2hvcnRPZmZzZXQsIGlucHV0KTsKICAgIH0pOwoKICAgIC8vIEhFTFBFUlMKCiAgICAvLyB0aW1lem9uZSBjaHVua2VyCiAgICAvLyAnKzEwOjAwJyA+IFsnMTAnLCAgJzAwJ10KICAgIC8vICctMTUzMCcgID4gWyctMTUnLCAnMzAnXQogICAgdmFyIGNodW5rT2Zmc2V0ID0gLyhbXCtcLV18XGRcZCkvZ2k7CgogICAgZnVuY3Rpb24gb2Zmc2V0RnJvbVN0cmluZyhtYXRjaGVyLCBzdHJpbmcpIHsKICAgICAgICB2YXIgbWF0Y2hlcyA9IChzdHJpbmcgfHwgJycpLm1hdGNoKG1hdGNoZXIpOwoKICAgICAgICBpZiAobWF0Y2hlcyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciBjaHVuayAgID0gbWF0Y2hlc1ttYXRjaGVzLmxlbmd0aCAtIDFdIHx8IFtdOwogICAgICAgIHZhciBwYXJ0cyAgID0gKGNodW5rICsgJycpLm1hdGNoKGNodW5rT2Zmc2V0KSB8fCBbJy0nLCAwLCAwXTsKICAgICAgICB2YXIgbWludXRlcyA9ICsocGFydHNbMV0gKiA2MCkgKyB0b0ludChwYXJ0c1syXSk7CgogICAgICAgIHJldHVybiBtaW51dGVzID09PSAwID8KICAgICAgICAgIDAgOgogICAgICAgICAgcGFydHNbMF0gPT09ICcrJyA/IG1pbnV0ZXMgOiAtbWludXRlczsKICAgIH0KCiAgICAvLyBSZXR1cm4gYSBtb21lbnQgZnJvbSBpbnB1dCwgdGhhdCBpcyBsb2NhbC91dGMvem9uZSBlcXVpdmFsZW50IHRvIG1vZGVsLgogICAgZnVuY3Rpb24gY2xvbmVXaXRoT2Zmc2V0KGlucHV0LCBtb2RlbCkgewogICAgICAgIHZhciByZXMsIGRpZmY7CiAgICAgICAgaWYgKG1vZGVsLl9pc1VUQykgewogICAgICAgICAgICByZXMgPSBtb2RlbC5jbG9uZSgpOwogICAgICAgICAgICBkaWZmID0gKGlzTW9tZW50KGlucHV0KSB8fCBpc0RhdGUoaW5wdXQpID8gaW5wdXQudmFsdWVPZigpIDogY3JlYXRlTG9jYWwoaW5wdXQpLnZhbHVlT2YoKSkgLSByZXMudmFsdWVPZigpOwogICAgICAgICAgICAvLyBVc2UgbG93LWxldmVsIGFwaSwgYmVjYXVzZSB0aGlzIGZuIGlzIGxvdy1sZXZlbCBhcGkuCiAgICAgICAgICAgIHJlcy5fZC5zZXRUaW1lKHJlcy5fZC52YWx1ZU9mKCkgKyBkaWZmKTsKICAgICAgICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHJlcywgZmFsc2UpOwogICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVMb2NhbChpbnB1dCkubG9jYWwoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RGF0ZU9mZnNldCAobSkgewogICAgICAgIC8vIE9uIEZpcmVmb3guMjQgRGF0ZSNnZXRUaW1lem9uZU9mZnNldCByZXR1cm5zIGEgZmxvYXRpbmcgcG9pbnQuCiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvcHVsbC8xODcxCiAgICAgICAgcmV0dXJuIC1NYXRoLnJvdW5kKG0uX2QuZ2V0VGltZXpvbmVPZmZzZXQoKSAvIDE1KSAqIDE1OwogICAgfQoKICAgIC8vIEhPT0tTCgogICAgLy8gVGhpcyBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBhIG1vbWVudCBpcyBtdXRhdGVkLgogICAgLy8gSXQgaXMgaW50ZW5kZWQgdG8ga2VlcCB0aGUgb2Zmc2V0IGluIHN5bmMgd2l0aCB0aGUgdGltZXpvbmUuCiAgICBob29rcy51cGRhdGVPZmZzZXQgPSBmdW5jdGlvbiAoKSB7fTsKCiAgICAvLyBNT01FTlRTCgogICAgLy8ga2VlcExvY2FsVGltZSA9IHRydWUgbWVhbnMgb25seSBjaGFuZ2UgdGhlIHRpbWV6b25lLCB3aXRob3V0CiAgICAvLyBhZmZlY3RpbmcgdGhlIGxvY2FsIGhvdXIuIFNvIDU6MzE6MjYgKzAzMDAgLS1bdXRjT2Zmc2V0KDIsIHRydWUpXS0tPgogICAgLy8gNTozMToyNiArMDIwMCBJdCBpcyBwb3NzaWJsZSB0aGF0IDU6MzE6MjYgZG9lc24ndCBleGlzdCB3aXRoIG9mZnNldAogICAgLy8gKzAyMDAsIHNvIHdlIGFkanVzdCB0aGUgdGltZSBhcyBuZWVkZWQsIHRvIGJlIHZhbGlkLgogICAgLy8KICAgIC8vIEtlZXBpbmcgdGhlIHRpbWUgYWN0dWFsbHkgYWRkcy9zdWJ0cmFjdHMgKG9uZSBob3VyKQogICAgLy8gZnJvbSB0aGUgYWN0dWFsIHJlcHJlc2VudGVkIHRpbWUuIFRoYXQgaXMgd2h5IHdlIGNhbGwgdXBkYXRlT2Zmc2V0CiAgICAvLyBhIHNlY29uZCB0aW1lLiBJbiBjYXNlIGl0IHdhbnRzIHVzIHRvIGNoYW5nZSB0aGUgb2Zmc2V0IGFnYWluCiAgICAvLyBfY2hhbmdlSW5Qcm9ncmVzcyA9PSB0cnVlIGNhc2UsIHRoZW4gd2UgaGF2ZSB0byBhZGp1c3QsIGJlY2F1c2UKICAgIC8vIHRoZXJlIGlzIG5vIHN1Y2ggdGltZSBpbiB0aGUgZ2l2ZW4gdGltZXpvbmUuCiAgICBmdW5jdGlvbiBnZXRTZXRPZmZzZXQgKGlucHV0LCBrZWVwTG9jYWxUaW1lLCBrZWVwTWludXRlcykgewogICAgICAgIHZhciBvZmZzZXQgPSB0aGlzLl9vZmZzZXQgfHwgMCwKICAgICAgICAgICAgbG9jYWxBZGp1c3Q7CiAgICAgICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCA/IHRoaXMgOiBOYU47CiAgICAgICAgfQogICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IG9mZnNldEZyb21TdHJpbmcobWF0Y2hTaG9ydE9mZnNldCwgaW5wdXQpOwogICAgICAgICAgICAgICAgaWYgKGlucHV0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoTWF0aC5hYnMoaW5wdXQpIDwgMTYgJiYgIWtlZXBNaW51dGVzKSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IGlucHV0ICogNjA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLl9pc1VUQyAmJiBrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgICAgICAgICBsb2NhbEFkanVzdCA9IGdldERhdGVPZmZzZXQodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fb2Zmc2V0ID0gaW5wdXQ7CiAgICAgICAgICAgIHRoaXMuX2lzVVRDID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGxvY2FsQWRqdXN0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWRkKGxvY2FsQWRqdXN0LCAnbScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvZmZzZXQgIT09IGlucHV0KSB7CiAgICAgICAgICAgICAgICBpZiAoIWtlZXBMb2NhbFRpbWUgfHwgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgIGFkZFN1YnRyYWN0KHRoaXMsIGNyZWF0ZUR1cmF0aW9uKGlucHV0IC0gb2Zmc2V0LCAnbScpLCAxLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9jaGFuZ2VJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZUluUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc1VUQyA/IG9mZnNldCA6IGdldERhdGVPZmZzZXQodGhpcyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldFNldFpvbmUgKGlucHV0LCBrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gLWlucHV0OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnV0Y09mZnNldChpbnB1dCwga2VlcExvY2FsVGltZSk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gLXRoaXMudXRjT2Zmc2V0KCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldE9mZnNldFRvVVRDIChrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudXRjT2Zmc2V0KDAsIGtlZXBMb2NhbFRpbWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldE9mZnNldFRvTG9jYWwgKGtlZXBMb2NhbFRpbWUpIHsKICAgICAgICBpZiAodGhpcy5faXNVVEMpIHsKICAgICAgICAgICAgdGhpcy51dGNPZmZzZXQoMCwga2VlcExvY2FsVGltZSk7CiAgICAgICAgICAgIHRoaXMuX2lzVVRDID0gZmFsc2U7CgogICAgICAgICAgICBpZiAoa2VlcExvY2FsVGltZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdWJ0cmFjdChnZXREYXRlT2Zmc2V0KHRoaXMpLCAnbScpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldE9mZnNldFRvUGFyc2VkT2Zmc2V0ICgpIHsKICAgICAgICBpZiAodGhpcy5fdHptICE9IG51bGwpIHsKICAgICAgICAgICAgdGhpcy51dGNPZmZzZXQodGhpcy5fdHptLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhpcy5faSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgdmFyIHRab25lID0gb2Zmc2V0RnJvbVN0cmluZyhtYXRjaE9mZnNldCwgdGhpcy5faSk7CiAgICAgICAgICAgIGlmICh0Wm9uZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnV0Y09mZnNldCh0Wm9uZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnV0Y09mZnNldCgwLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICBmdW5jdGlvbiBoYXNBbGlnbmVkSG91ck9mZnNldCAoaW5wdXQpIHsKICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaW5wdXQgPSBpbnB1dCA/IGNyZWF0ZUxvY2FsKGlucHV0KS51dGNPZmZzZXQoKSA6IDA7CgogICAgICAgIHJldHVybiAodGhpcy51dGNPZmZzZXQoKSAtIGlucHV0KSAlIDYwID09PSAwOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzRGF5bGlnaHRTYXZpbmdUaW1lICgpIHsKICAgICAgICByZXR1cm4gKAogICAgICAgICAgICB0aGlzLnV0Y09mZnNldCgpID4gdGhpcy5jbG9uZSgpLm1vbnRoKDApLnV0Y09mZnNldCgpIHx8CiAgICAgICAgICAgIHRoaXMudXRjT2Zmc2V0KCkgPiB0aGlzLmNsb25lKCkubW9udGgoNSkudXRjT2Zmc2V0KCkKICAgICAgICApOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzRGF5bGlnaHRTYXZpbmdUaW1lU2hpZnRlZCAoKSB7CiAgICAgICAgaWYgKCFpc1VuZGVmaW5lZCh0aGlzLl9pc0RTVFNoaWZ0ZWQpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc0RTVFNoaWZ0ZWQ7CiAgICAgICAgfQoKICAgICAgICB2YXIgYyA9IHt9OwoKICAgICAgICBjb3B5Q29uZmlnKGMsIHRoaXMpOwogICAgICAgIGMgPSBwcmVwYXJlQ29uZmlnKGMpOwoKICAgICAgICBpZiAoYy5fYSkgewogICAgICAgICAgICB2YXIgb3RoZXIgPSBjLl9pc1VUQyA/IGNyZWF0ZVVUQyhjLl9hKSA6IGNyZWF0ZUxvY2FsKGMuX2EpOwogICAgICAgICAgICB0aGlzLl9pc0RTVFNoaWZ0ZWQgPSB0aGlzLmlzVmFsaWQoKSAmJgogICAgICAgICAgICAgICAgY29tcGFyZUFycmF5cyhjLl9hLCBvdGhlci50b0FycmF5KCkpID4gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9pc0RTVFNoaWZ0ZWQgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLl9pc0RTVFNoaWZ0ZWQ7CiAgICB9CgogICAgZnVuY3Rpb24gaXNMb2NhbCAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaXNWYWxpZCgpID8gIXRoaXMuX2lzVVRDIDogZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gaXNVdGNPZmZzZXQgKCkgewogICAgICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSA/IHRoaXMuX2lzVVRDIDogZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gaXNVdGMgKCkgewogICAgICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSA/IHRoaXMuX2lzVVRDICYmIHRoaXMuX29mZnNldCA9PT0gMCA6IGZhbHNlOwogICAgfQoKICAgIC8vIEFTUC5ORVQganNvbiBkYXRlIGZvcm1hdCByZWdleAogICAgdmFyIGFzcE5ldFJlZ2V4ID0gL14oXC18XCspPyg/OihcZCopWy4gXSk/KFxkKylcOihcZCspKD86XDooXGQrKShcLlxkKik/KT8kLzsKCiAgICAvLyBmcm9tIGh0dHA6Ly9kb2NzLmNsb3N1cmUtbGlicmFyeS5nb29nbGVjb2RlLmNvbS9naXQvY2xvc3VyZV9nb29nX2RhdGVfZGF0ZS5qcy5zb3VyY2UuaHRtbAogICAgLy8gc29tZXdoYXQgbW9yZSBpbiBsaW5lIHdpdGggNC40LjMuMiAyMDA0IHNwZWMsIGJ1dCBhbGxvd3MgZGVjaW1hbCBhbnl3aGVyZQogICAgLy8gYW5kIGZ1cnRoZXIgbW9kaWZpZWQgdG8gYWxsb3cgZm9yIHN0cmluZ3MgY29udGFpbmluZyBib3RoIHdlZWsgYW5kIGRheQogICAgdmFyIGlzb1JlZ2V4ID0gL14oLXxcKyk/UCg/OihbLStdP1swLTksLl0qKVkpPyg/OihbLStdP1swLTksLl0qKU0pPyg/OihbLStdP1swLTksLl0qKVcpPyg/OihbLStdP1swLTksLl0qKUQpPyg/OlQoPzooWy0rXT9bMC05LC5dKilIKT8oPzooWy0rXT9bMC05LC5dKilNKT8oPzooWy0rXT9bMC05LC5dKilTKT8pPyQvOwoKICAgIGZ1bmN0aW9uIGNyZWF0ZUR1cmF0aW9uIChpbnB1dCwga2V5KSB7CiAgICAgICAgdmFyIGR1cmF0aW9uID0gaW5wdXQsCiAgICAgICAgICAgIC8vIG1hdGNoaW5nIGFnYWluc3QgcmVnZXhwIGlzIGV4cGVuc2l2ZSwgZG8gaXQgb24gZGVtYW5kCiAgICAgICAgICAgIG1hdGNoID0gbnVsbCwKICAgICAgICAgICAgc2lnbiwKICAgICAgICAgICAgcmV0LAogICAgICAgICAgICBkaWZmUmVzOwoKICAgICAgICBpZiAoaXNEdXJhdGlvbihpbnB1dCkpIHsKICAgICAgICAgICAgZHVyYXRpb24gPSB7CiAgICAgICAgICAgICAgICBtcyA6IGlucHV0Ll9taWxsaXNlY29uZHMsCiAgICAgICAgICAgICAgICBkICA6IGlucHV0Ll9kYXlzLAogICAgICAgICAgICAgICAgTSAgOiBpbnB1dC5fbW9udGhzCiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmIChpc051bWJlcihpbnB1dCkpIHsKICAgICAgICAgICAgZHVyYXRpb24gPSB7fTsKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZHVyYXRpb25ba2V5XSA9IGlucHV0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZHVyYXRpb24ubWlsbGlzZWNvbmRzID0gaW5wdXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCEhKG1hdGNoID0gYXNwTmV0UmVnZXguZXhlYyhpbnB1dCkpKSB7CiAgICAgICAgICAgIHNpZ24gPSAobWF0Y2hbMV0gPT09ICctJykgPyAtMSA6IDE7CiAgICAgICAgICAgIGR1cmF0aW9uID0gewogICAgICAgICAgICAgICAgeSAgOiAwLAogICAgICAgICAgICAgICAgZCAgOiB0b0ludChtYXRjaFtEQVRFXSkgICAgICAgICAgICAgICAgICAgICAgICAgKiBzaWduLAogICAgICAgICAgICAgICAgaCAgOiB0b0ludChtYXRjaFtIT1VSXSkgICAgICAgICAgICAgICAgICAgICAgICAgKiBzaWduLAogICAgICAgICAgICAgICAgbSAgOiB0b0ludChtYXRjaFtNSU5VVEVdKSAgICAgICAgICAgICAgICAgICAgICAgKiBzaWduLAogICAgICAgICAgICAgICAgcyAgOiB0b0ludChtYXRjaFtTRUNPTkRdKSAgICAgICAgICAgICAgICAgICAgICAgKiBzaWduLAogICAgICAgICAgICAgICAgbXMgOiB0b0ludChhYnNSb3VuZChtYXRjaFtNSUxMSVNFQ09ORF0gKiAxMDAwKSkgKiBzaWduIC8vIHRoZSBtaWxsaXNlY29uZCBkZWNpbWFsIHBvaW50IGlzIGluY2x1ZGVkIGluIHRoZSBtYXRjaAogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAoISEobWF0Y2ggPSBpc29SZWdleC5leGVjKGlucHV0KSkpIHsKICAgICAgICAgICAgc2lnbiA9IChtYXRjaFsxXSA9PT0gJy0nKSA/IC0xIDogMTsKICAgICAgICAgICAgZHVyYXRpb24gPSB7CiAgICAgICAgICAgICAgICB5IDogcGFyc2VJc28obWF0Y2hbMl0sIHNpZ24pLAogICAgICAgICAgICAgICAgTSA6IHBhcnNlSXNvKG1hdGNoWzNdLCBzaWduKSwKICAgICAgICAgICAgICAgIHcgOiBwYXJzZUlzbyhtYXRjaFs0XSwgc2lnbiksCiAgICAgICAgICAgICAgICBkIDogcGFyc2VJc28obWF0Y2hbNV0sIHNpZ24pLAogICAgICAgICAgICAgICAgaCA6IHBhcnNlSXNvKG1hdGNoWzZdLCBzaWduKSwKICAgICAgICAgICAgICAgIG0gOiBwYXJzZUlzbyhtYXRjaFs3XSwgc2lnbiksCiAgICAgICAgICAgICAgICBzIDogcGFyc2VJc28obWF0Y2hbOF0sIHNpZ24pCiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmIChkdXJhdGlvbiA9PSBudWxsKSB7Ly8gY2hlY2tzIGZvciBudWxsIG9yIHVuZGVmaW5lZAogICAgICAgICAgICBkdXJhdGlvbiA9IHt9OwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAnb2JqZWN0JyAmJiAoJ2Zyb20nIGluIGR1cmF0aW9uIHx8ICd0bycgaW4gZHVyYXRpb24pKSB7CiAgICAgICAgICAgIGRpZmZSZXMgPSBtb21lbnRzRGlmZmVyZW5jZShjcmVhdGVMb2NhbChkdXJhdGlvbi5mcm9tKSwgY3JlYXRlTG9jYWwoZHVyYXRpb24udG8pKTsKCiAgICAgICAgICAgIGR1cmF0aW9uID0ge307CiAgICAgICAgICAgIGR1cmF0aW9uLm1zID0gZGlmZlJlcy5taWxsaXNlY29uZHM7CiAgICAgICAgICAgIGR1cmF0aW9uLk0gPSBkaWZmUmVzLm1vbnRoczsKICAgICAgICB9CgogICAgICAgIHJldCA9IG5ldyBEdXJhdGlvbihkdXJhdGlvbik7CgogICAgICAgIGlmIChpc0R1cmF0aW9uKGlucHV0KSAmJiBoYXNPd25Qcm9wKGlucHV0LCAnX2xvY2FsZScpKSB7CiAgICAgICAgICAgIHJldC5fbG9jYWxlID0gaW5wdXQuX2xvY2FsZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgY3JlYXRlRHVyYXRpb24uZm4gPSBEdXJhdGlvbi5wcm90b3R5cGU7CiAgICBjcmVhdGVEdXJhdGlvbi5pbnZhbGlkID0gY3JlYXRlSW52YWxpZCQxOwoKICAgIGZ1bmN0aW9uIHBhcnNlSXNvIChpbnAsIHNpZ24pIHsKICAgICAgICAvLyBXZSdkIG5vcm1hbGx5IHVzZSB+fmlucCBmb3IgdGhpcywgYnV0IHVuZm9ydHVuYXRlbHkgaXQgYWxzbwogICAgICAgIC8vIGNvbnZlcnRzIGZsb2F0cyB0byBpbnRzLgogICAgICAgIC8vIGlucCBtYXkgYmUgdW5kZWZpbmVkLCBzbyBjYXJlZnVsIGNhbGxpbmcgcmVwbGFjZSBvbiBpdC4KICAgICAgICB2YXIgcmVzID0gaW5wICYmIHBhcnNlRmxvYXQoaW5wLnJlcGxhY2UoJywnLCAnLicpKTsKICAgICAgICAvLyBhcHBseSBzaWduIHdoaWxlIHdlJ3JlIGF0IGl0CiAgICAgICAgcmV0dXJuIChpc05hTihyZXMpID8gMCA6IHJlcykgKiBzaWduOwogICAgfQoKICAgIGZ1bmN0aW9uIHBvc2l0aXZlTW9tZW50c0RpZmZlcmVuY2UoYmFzZSwgb3RoZXIpIHsKICAgICAgICB2YXIgcmVzID0ge307CgogICAgICAgIHJlcy5tb250aHMgPSBvdGhlci5tb250aCgpIC0gYmFzZS5tb250aCgpICsKICAgICAgICAgICAgKG90aGVyLnllYXIoKSAtIGJhc2UueWVhcigpKSAqIDEyOwogICAgICAgIGlmIChiYXNlLmNsb25lKCkuYWRkKHJlcy5tb250aHMsICdNJykuaXNBZnRlcihvdGhlcikpIHsKICAgICAgICAgICAgLS1yZXMubW9udGhzOwogICAgICAgIH0KCiAgICAgICAgcmVzLm1pbGxpc2Vjb25kcyA9ICtvdGhlciAtICsoYmFzZS5jbG9uZSgpLmFkZChyZXMubW9udGhzLCAnTScpKTsKCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBtb21lbnRzRGlmZmVyZW5jZShiYXNlLCBvdGhlcikgewogICAgICAgIHZhciByZXM7CiAgICAgICAgaWYgKCEoYmFzZS5pc1ZhbGlkKCkgJiYgb3RoZXIuaXNWYWxpZCgpKSkgewogICAgICAgICAgICByZXR1cm4ge21pbGxpc2Vjb25kczogMCwgbW9udGhzOiAwfTsKICAgICAgICB9CgogICAgICAgIG90aGVyID0gY2xvbmVXaXRoT2Zmc2V0KG90aGVyLCBiYXNlKTsKICAgICAgICBpZiAoYmFzZS5pc0JlZm9yZShvdGhlcikpIHsKICAgICAgICAgICAgcmVzID0gcG9zaXRpdmVNb21lbnRzRGlmZmVyZW5jZShiYXNlLCBvdGhlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzID0gcG9zaXRpdmVNb21lbnRzRGlmZmVyZW5jZShvdGhlciwgYmFzZSk7CiAgICAgICAgICAgIHJlcy5taWxsaXNlY29uZHMgPSAtcmVzLm1pbGxpc2Vjb25kczsKICAgICAgICAgICAgcmVzLm1vbnRocyA9IC1yZXMubW9udGhzOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICAvLyBUT0RPOiByZW1vdmUgJ25hbWUnIGFyZyBhZnRlciBkZXByZWNhdGlvbiBpcyByZW1vdmVkCiAgICBmdW5jdGlvbiBjcmVhdGVBZGRlcihkaXJlY3Rpb24sIG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbCwgcGVyaW9kKSB7CiAgICAgICAgICAgIHZhciBkdXIsIHRtcDsKICAgICAgICAgICAgLy9pbnZlcnQgdGhlIGFyZ3VtZW50cywgYnV0IGNvbXBsYWluIGFib3V0IGl0CiAgICAgICAgICAgIGlmIChwZXJpb2QgIT09IG51bGwgJiYgIWlzTmFOKCtwZXJpb2QpKSB7CiAgICAgICAgICAgICAgICBkZXByZWNhdGVTaW1wbGUobmFtZSwgJ21vbWVudCgpLicgKyBuYW1lICArICcocGVyaW9kLCBudW1iZXIpIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgbW9tZW50KCkuJyArIG5hbWUgKyAnKG51bWJlciwgcGVyaW9kKS4gJyArCiAgICAgICAgICAgICAgICAnU2VlIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvYWRkLWludmVydGVkLXBhcmFtLyBmb3IgbW9yZSBpbmZvLicpOwogICAgICAgICAgICAgICAgdG1wID0gdmFsOyB2YWwgPSBwZXJpb2Q7IHBlcmlvZCA9IHRtcDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFsID0gdHlwZW9mIHZhbCA9PT0gJ3N0cmluZycgPyArdmFsIDogdmFsOwogICAgICAgICAgICBkdXIgPSBjcmVhdGVEdXJhdGlvbih2YWwsIHBlcmlvZCk7CiAgICAgICAgICAgIGFkZFN1YnRyYWN0KHRoaXMsIGR1ciwgZGlyZWN0aW9uKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRTdWJ0cmFjdCAobW9tLCBkdXJhdGlvbiwgaXNBZGRpbmcsIHVwZGF0ZU9mZnNldCkgewogICAgICAgIHZhciBtaWxsaXNlY29uZHMgPSBkdXJhdGlvbi5fbWlsbGlzZWNvbmRzLAogICAgICAgICAgICBkYXlzID0gYWJzUm91bmQoZHVyYXRpb24uX2RheXMpLAogICAgICAgICAgICBtb250aHMgPSBhYnNSb3VuZChkdXJhdGlvbi5fbW9udGhzKTsKCiAgICAgICAgaWYgKCFtb20uaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIC8vIE5vIG9wCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZU9mZnNldCA9IHVwZGF0ZU9mZnNldCA9PSBudWxsID8gdHJ1ZSA6IHVwZGF0ZU9mZnNldDsKCiAgICAgICAgaWYgKG1vbnRocykgewogICAgICAgICAgICBzZXRNb250aChtb20sIGdldChtb20sICdNb250aCcpICsgbW9udGhzICogaXNBZGRpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAoZGF5cykgewogICAgICAgICAgICBzZXQkMShtb20sICdEYXRlJywgZ2V0KG1vbSwgJ0RhdGUnKSArIGRheXMgKiBpc0FkZGluZyk7CiAgICAgICAgfQogICAgICAgIGlmIChtaWxsaXNlY29uZHMpIHsKICAgICAgICAgICAgbW9tLl9kLnNldFRpbWUobW9tLl9kLnZhbHVlT2YoKSArIG1pbGxpc2Vjb25kcyAqIGlzQWRkaW5nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHVwZGF0ZU9mZnNldCkgewogICAgICAgICAgICBob29rcy51cGRhdGVPZmZzZXQobW9tLCBkYXlzIHx8IG1vbnRocyk7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBhZGQgICAgICA9IGNyZWF0ZUFkZGVyKDEsICdhZGQnKTsKICAgIHZhciBzdWJ0cmFjdCA9IGNyZWF0ZUFkZGVyKC0xLCAnc3VidHJhY3QnKTsKCiAgICBmdW5jdGlvbiBnZXRDYWxlbmRhckZvcm1hdChteU1vbWVudCwgbm93KSB7CiAgICAgICAgdmFyIGRpZmYgPSBteU1vbWVudC5kaWZmKG5vdywgJ2RheXMnLCB0cnVlKTsKICAgICAgICByZXR1cm4gZGlmZiA8IC02ID8gJ3NhbWVFbHNlJyA6CiAgICAgICAgICAgICAgICBkaWZmIDwgLTEgPyAnbGFzdFdlZWsnIDoKICAgICAgICAgICAgICAgIGRpZmYgPCAwID8gJ2xhc3REYXknIDoKICAgICAgICAgICAgICAgIGRpZmYgPCAxID8gJ3NhbWVEYXknIDoKICAgICAgICAgICAgICAgIGRpZmYgPCAyID8gJ25leHREYXknIDoKICAgICAgICAgICAgICAgIGRpZmYgPCA3ID8gJ25leHRXZWVrJyA6ICdzYW1lRWxzZSc7CiAgICB9CgogICAgZnVuY3Rpb24gY2FsZW5kYXIkMSAodGltZSwgZm9ybWF0cykgewogICAgICAgIC8vIFdlIHdhbnQgdG8gY29tcGFyZSB0aGUgc3RhcnQgb2YgdG9kYXksIHZzIHRoaXMuCiAgICAgICAgLy8gR2V0dGluZyBzdGFydC1vZi10b2RheSBkZXBlbmRzIG9uIHdoZXRoZXIgd2UncmUgbG9jYWwvdXRjL29mZnNldCBvciBub3QuCiAgICAgICAgdmFyIG5vdyA9IHRpbWUgfHwgY3JlYXRlTG9jYWwoKSwKICAgICAgICAgICAgc29kID0gY2xvbmVXaXRoT2Zmc2V0KG5vdywgdGhpcykuc3RhcnRPZignZGF5JyksCiAgICAgICAgICAgIGZvcm1hdCA9IGhvb2tzLmNhbGVuZGFyRm9ybWF0KHRoaXMsIHNvZCkgfHwgJ3NhbWVFbHNlJzsKCiAgICAgICAgdmFyIG91dHB1dCA9IGZvcm1hdHMgJiYgKGlzRnVuY3Rpb24oZm9ybWF0c1tmb3JtYXRdKSA/IGZvcm1hdHNbZm9ybWF0XS5jYWxsKHRoaXMsIG5vdykgOiBmb3JtYXRzW2Zvcm1hdF0pOwoKICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQob3V0cHV0IHx8IHRoaXMubG9jYWxlRGF0YSgpLmNhbGVuZGFyKGZvcm1hdCwgdGhpcywgY3JlYXRlTG9jYWwobm93KSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsb25lICgpIHsKICAgICAgICByZXR1cm4gbmV3IE1vbWVudCh0aGlzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0FmdGVyIChpbnB1dCwgdW5pdHMpIHsKICAgICAgICB2YXIgbG9jYWxJbnB1dCA9IGlzTW9tZW50KGlucHV0KSA/IGlucHV0IDogY3JlYXRlTG9jYWwoaW5wdXQpOwogICAgICAgIGlmICghKHRoaXMuaXNWYWxpZCgpICYmIGxvY2FsSW5wdXQuaXNWYWxpZCgpKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpIHx8ICdtaWxsaXNlY29uZCc7CiAgICAgICAgaWYgKHVuaXRzID09PSAnbWlsbGlzZWNvbmQnKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKSA+IGxvY2FsSW5wdXQudmFsdWVPZigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbElucHV0LnZhbHVlT2YoKSA8IHRoaXMuY2xvbmUoKS5zdGFydE9mKHVuaXRzKS52YWx1ZU9mKCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGlzQmVmb3JlIChpbnB1dCwgdW5pdHMpIHsKICAgICAgICB2YXIgbG9jYWxJbnB1dCA9IGlzTW9tZW50KGlucHV0KSA/IGlucHV0IDogY3JlYXRlTG9jYWwoaW5wdXQpOwogICAgICAgIGlmICghKHRoaXMuaXNWYWxpZCgpICYmIGxvY2FsSW5wdXQuaXNWYWxpZCgpKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpIHx8ICdtaWxsaXNlY29uZCc7CiAgICAgICAgaWYgKHVuaXRzID09PSAnbWlsbGlzZWNvbmQnKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKSA8IGxvY2FsSW5wdXQudmFsdWVPZigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb25lKCkuZW5kT2YodW5pdHMpLnZhbHVlT2YoKSA8IGxvY2FsSW5wdXQudmFsdWVPZigpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc0JldHdlZW4gKGZyb20sIHRvLCB1bml0cywgaW5jbHVzaXZpdHkpIHsKICAgICAgICB2YXIgbG9jYWxGcm9tID0gaXNNb21lbnQoZnJvbSkgPyBmcm9tIDogY3JlYXRlTG9jYWwoZnJvbSksCiAgICAgICAgICAgIGxvY2FsVG8gPSBpc01vbWVudCh0bykgPyB0byA6IGNyZWF0ZUxvY2FsKHRvKTsKICAgICAgICBpZiAoISh0aGlzLmlzVmFsaWQoKSAmJiBsb2NhbEZyb20uaXNWYWxpZCgpICYmIGxvY2FsVG8uaXNWYWxpZCgpKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGluY2x1c2l2aXR5ID0gaW5jbHVzaXZpdHkgfHwgJygpJzsKICAgICAgICByZXR1cm4gKGluY2x1c2l2aXR5WzBdID09PSAnKCcgPyB0aGlzLmlzQWZ0ZXIobG9jYWxGcm9tLCB1bml0cykgOiAhdGhpcy5pc0JlZm9yZShsb2NhbEZyb20sIHVuaXRzKSkgJiYKICAgICAgICAgICAgKGluY2x1c2l2aXR5WzFdID09PSAnKScgPyB0aGlzLmlzQmVmb3JlKGxvY2FsVG8sIHVuaXRzKSA6ICF0aGlzLmlzQWZ0ZXIobG9jYWxUbywgdW5pdHMpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc1NhbWUgKGlucHV0LCB1bml0cykgewogICAgICAgIHZhciBsb2NhbElucHV0ID0gaXNNb21lbnQoaW5wdXQpID8gaW5wdXQgOiBjcmVhdGVMb2NhbChpbnB1dCksCiAgICAgICAgICAgIGlucHV0TXM7CiAgICAgICAgaWYgKCEodGhpcy5pc1ZhbGlkKCkgJiYgbG9jYWxJbnB1dC5pc1ZhbGlkKCkpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cykgfHwgJ21pbGxpc2Vjb25kJzsKICAgICAgICBpZiAodW5pdHMgPT09ICdtaWxsaXNlY29uZCcpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVPZigpID09PSBsb2NhbElucHV0LnZhbHVlT2YoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbnB1dE1zID0gbG9jYWxJbnB1dC52YWx1ZU9mKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb25lKCkuc3RhcnRPZih1bml0cykudmFsdWVPZigpIDw9IGlucHV0TXMgJiYgaW5wdXRNcyA8PSB0aGlzLmNsb25lKCkuZW5kT2YodW5pdHMpLnZhbHVlT2YoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaXNTYW1lT3JBZnRlciAoaW5wdXQsIHVuaXRzKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaXNTYW1lKGlucHV0LCB1bml0cykgfHwgdGhpcy5pc0FmdGVyKGlucHV0LCB1bml0cyk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNTYW1lT3JCZWZvcmUgKGlucHV0LCB1bml0cykgewogICAgICAgIHJldHVybiB0aGlzLmlzU2FtZShpbnB1dCwgdW5pdHMpIHx8IHRoaXMuaXNCZWZvcmUoaW5wdXQsIHVuaXRzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkaWZmIChpbnB1dCwgdW5pdHMsIGFzRmxvYXQpIHsKICAgICAgICB2YXIgdGhhdCwKICAgICAgICAgICAgem9uZURlbHRhLAogICAgICAgICAgICBvdXRwdXQ7CgogICAgICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgcmV0dXJuIE5hTjsKICAgICAgICB9CgogICAgICAgIHRoYXQgPSBjbG9uZVdpdGhPZmZzZXQoaW5wdXQsIHRoaXMpOwoKICAgICAgICBpZiAoIXRoYXQuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBOYU47CiAgICAgICAgfQoKICAgICAgICB6b25lRGVsdGEgPSAodGhhdC51dGNPZmZzZXQoKSAtIHRoaXMudXRjT2Zmc2V0KCkpICogNmU0OwoKICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKCiAgICAgICAgc3dpdGNoICh1bml0cykgewogICAgICAgICAgICBjYXNlICd5ZWFyJzogb3V0cHV0ID0gbW9udGhEaWZmKHRoaXMsIHRoYXQpIC8gMTI7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdtb250aCc6IG91dHB1dCA9IG1vbnRoRGlmZih0aGlzLCB0aGF0KTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3F1YXJ0ZXInOiBvdXRwdXQgPSBtb250aERpZmYodGhpcywgdGhhdCkgLyAzOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnc2Vjb25kJzogb3V0cHV0ID0gKHRoaXMgLSB0aGF0KSAvIDFlMzsgYnJlYWs7IC8vIDEwMDAKICAgICAgICAgICAgY2FzZSAnbWludXRlJzogb3V0cHV0ID0gKHRoaXMgLSB0aGF0KSAvIDZlNDsgYnJlYWs7IC8vIDEwMDAgKiA2MAogICAgICAgICAgICBjYXNlICdob3VyJzogb3V0cHV0ID0gKHRoaXMgLSB0aGF0KSAvIDM2ZTU7IGJyZWFrOyAvLyAxMDAwICogNjAgKiA2MAogICAgICAgICAgICBjYXNlICdkYXknOiBvdXRwdXQgPSAodGhpcyAtIHRoYXQgLSB6b25lRGVsdGEpIC8gODY0ZTU7IGJyZWFrOyAvLyAxMDAwICogNjAgKiA2MCAqIDI0LCBuZWdhdGUgZHN0CiAgICAgICAgICAgIGNhc2UgJ3dlZWsnOiBvdXRwdXQgPSAodGhpcyAtIHRoYXQgLSB6b25lRGVsdGEpIC8gNjA0OGU1OyBicmVhazsgLy8gMTAwMCAqIDYwICogNjAgKiAyNCAqIDcsIG5lZ2F0ZSBkc3QKICAgICAgICAgICAgZGVmYXVsdDogb3V0cHV0ID0gdGhpcyAtIHRoYXQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYXNGbG9hdCA/IG91dHB1dCA6IGFic0Zsb29yKG91dHB1dCk7CiAgICB9CgogICAgZnVuY3Rpb24gbW9udGhEaWZmIChhLCBiKSB7CiAgICAgICAgLy8gZGlmZmVyZW5jZSBpbiBtb250aHMKICAgICAgICB2YXIgd2hvbGVNb250aERpZmYgPSAoKGIueWVhcigpIC0gYS55ZWFyKCkpICogMTIpICsgKGIubW9udGgoKSAtIGEubW9udGgoKSksCiAgICAgICAgICAgIC8vIGIgaXMgaW4gKGFuY2hvciAtIDEgbW9udGgsIGFuY2hvciArIDEgbW9udGgpCiAgICAgICAgICAgIGFuY2hvciA9IGEuY2xvbmUoKS5hZGQod2hvbGVNb250aERpZmYsICdtb250aHMnKSwKICAgICAgICAgICAgYW5jaG9yMiwgYWRqdXN0OwoKICAgICAgICBpZiAoYiAtIGFuY2hvciA8IDApIHsKICAgICAgICAgICAgYW5jaG9yMiA9IGEuY2xvbmUoKS5hZGQod2hvbGVNb250aERpZmYgLSAxLCAnbW9udGhzJyk7CiAgICAgICAgICAgIC8vIGxpbmVhciBhY3Jvc3MgdGhlIG1vbnRoCiAgICAgICAgICAgIGFkanVzdCA9IChiIC0gYW5jaG9yKSAvIChhbmNob3IgLSBhbmNob3IyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhbmNob3IyID0gYS5jbG9uZSgpLmFkZCh3aG9sZU1vbnRoRGlmZiArIDEsICdtb250aHMnKTsKICAgICAgICAgICAgLy8gbGluZWFyIGFjcm9zcyB0aGUgbW9udGgKICAgICAgICAgICAgYWRqdXN0ID0gKGIgLSBhbmNob3IpIC8gKGFuY2hvcjIgLSBhbmNob3IpOwogICAgICAgIH0KCiAgICAgICAgLy9jaGVjayBmb3IgbmVnYXRpdmUgemVybywgcmV0dXJuIHplcm8gaWYgbmVnYXRpdmUgemVybwogICAgICAgIHJldHVybiAtKHdob2xlTW9udGhEaWZmICsgYWRqdXN0KSB8fCAwOwogICAgfQoKICAgIGhvb2tzLmRlZmF1bHRGb3JtYXQgPSAnWVlZWS1NTS1ERFRISDptbTpzc1onOwogICAgaG9va3MuZGVmYXVsdEZvcm1hdFV0YyA9ICdZWVlZLU1NLUREVEhIOm1tOnNzW1pdJzsKCiAgICBmdW5jdGlvbiB0b1N0cmluZyAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5sb2NhbGUoJ2VuJykuZm9ybWF0KCdkZGQgTU1NIEREIFlZWVkgSEg6bW06c3MgW0dNVF1aWicpOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvSVNPU3RyaW5nKGtlZXBPZmZzZXQpIHsKICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgdXRjID0ga2VlcE9mZnNldCAhPT0gdHJ1ZTsKICAgICAgICB2YXIgbSA9IHV0YyA/IHRoaXMuY2xvbmUoKS51dGMoKSA6IHRoaXM7CiAgICAgICAgaWYgKG0ueWVhcigpIDwgMCB8fCBtLnllYXIoKSA+IDk5OTkpIHsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE1vbWVudChtLCB1dGMgPyAnWVlZWVlZLU1NLUREW1RdSEg6bW06c3MuU1NTW1pdJyA6ICdZWVlZWVktTU0tRERbVF1ISDptbTpzcy5TU1NaJyk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0Z1bmN0aW9uKERhdGUucHJvdG90eXBlLnRvSVNPU3RyaW5nKSkgewogICAgICAgICAgICAvLyBuYXRpdmUgaW1wbGVtZW50YXRpb24gaXMgfjUweCBmYXN0ZXIsIHVzZSBpdCB3aGVuIHdlIGNhbgogICAgICAgICAgICBpZiAodXRjKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50b0RhdGUoKS50b0lTT1N0cmluZygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMudmFsdWVPZigpICsgdGhpcy51dGNPZmZzZXQoKSAqIDYwICogMTAwMCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKCdaJywgZm9ybWF0TW9tZW50KG0sICdaJykpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmb3JtYXRNb21lbnQobSwgdXRjID8gJ1lZWVktTU0tRERbVF1ISDptbTpzcy5TU1NbWl0nIDogJ1lZWVktTU0tRERbVF1ISDptbTpzcy5TU1NaJyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBodW1hbiByZWFkYWJsZSByZXByZXNlbnRhdGlvbiBvZiBhIG1vbWVudCB0aGF0IGNhbgogICAgICogYWxzbyBiZSBldmFsdWF0ZWQgdG8gZ2V0IGEgbmV3IG1vbWVudCB3aGljaCBpcyB0aGUgc2FtZQogICAgICoKICAgICAqIEBsaW5rIGh0dHBzOi8vbm9kZWpzLm9yZy9kaXN0L2xhdGVzdC9kb2NzL2FwaS91dGlsLmh0bWwjdXRpbF9jdXN0b21faW5zcGVjdF9mdW5jdGlvbl9vbl9vYmplY3RzCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluc3BlY3QgKCkgewogICAgICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgcmV0dXJuICdtb21lbnQuaW52YWxpZCgvKiAnICsgdGhpcy5faSArICcgKi8pJzsKICAgICAgICB9CiAgICAgICAgdmFyIGZ1bmMgPSAnbW9tZW50JzsKICAgICAgICB2YXIgem9uZSA9ICcnOwogICAgICAgIGlmICghdGhpcy5pc0xvY2FsKCkpIHsKICAgICAgICAgICAgZnVuYyA9IHRoaXMudXRjT2Zmc2V0KCkgPT09IDAgPyAnbW9tZW50LnV0YycgOiAnbW9tZW50LnBhcnNlWm9uZSc7CiAgICAgICAgICAgIHpvbmUgPSAnWic7CiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXggPSAnWycgKyBmdW5jICsgJygiXSc7CiAgICAgICAgdmFyIHllYXIgPSAoMCA8PSB0aGlzLnllYXIoKSAmJiB0aGlzLnllYXIoKSA8PSA5OTk5KSA/ICdZWVlZJyA6ICdZWVlZWVknOwogICAgICAgIHZhciBkYXRldGltZSA9ICctTU0tRERbVF1ISDptbTpzcy5TU1MnOwogICAgICAgIHZhciBzdWZmaXggPSB6b25lICsgJ1siKV0nOwoKICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQocHJlZml4ICsgeWVhciArIGRhdGV0aW1lICsgc3VmZml4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBmb3JtYXQgKGlucHV0U3RyaW5nKSB7CiAgICAgICAgaWYgKCFpbnB1dFN0cmluZykgewogICAgICAgICAgICBpbnB1dFN0cmluZyA9IHRoaXMuaXNVdGMoKSA/IGhvb2tzLmRlZmF1bHRGb3JtYXRVdGMgOiBob29rcy5kZWZhdWx0Rm9ybWF0OwogICAgICAgIH0KICAgICAgICB2YXIgb3V0cHV0ID0gZm9ybWF0TW9tZW50KHRoaXMsIGlucHV0U3RyaW5nKTsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkucG9zdGZvcm1hdChvdXRwdXQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZyb20gKHRpbWUsIHdpdGhvdXRTdWZmaXgpIHsKICAgICAgICBpZiAodGhpcy5pc1ZhbGlkKCkgJiYKICAgICAgICAgICAgICAgICgoaXNNb21lbnQodGltZSkgJiYgdGltZS5pc1ZhbGlkKCkpIHx8CiAgICAgICAgICAgICAgICAgY3JlYXRlTG9jYWwodGltZSkuaXNWYWxpZCgpKSkgewogICAgICAgICAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24oe3RvOiB0aGlzLCBmcm9tOiB0aW1lfSkubG9jYWxlKHRoaXMubG9jYWxlKCkpLmh1bWFuaXplKCF3aXRob3V0U3VmZml4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkuaW52YWxpZERhdGUoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZnJvbU5vdyAod2l0aG91dFN1ZmZpeCkgewogICAgICAgIHJldHVybiB0aGlzLmZyb20oY3JlYXRlTG9jYWwoKSwgd2l0aG91dFN1ZmZpeCk7CiAgICB9CgogICAgZnVuY3Rpb24gdG8gKHRpbWUsIHdpdGhvdXRTdWZmaXgpIHsKICAgICAgICBpZiAodGhpcy5pc1ZhbGlkKCkgJiYKICAgICAgICAgICAgICAgICgoaXNNb21lbnQodGltZSkgJiYgdGltZS5pc1ZhbGlkKCkpIHx8CiAgICAgICAgICAgICAgICAgY3JlYXRlTG9jYWwodGltZSkuaXNWYWxpZCgpKSkgewogICAgICAgICAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24oe2Zyb206IHRoaXMsIHRvOiB0aW1lfSkubG9jYWxlKHRoaXMubG9jYWxlKCkpLmh1bWFuaXplKCF3aXRob3V0U3VmZml4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkuaW52YWxpZERhdGUoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdG9Ob3cgKHdpdGhvdXRTdWZmaXgpIHsKICAgICAgICByZXR1cm4gdGhpcy50byhjcmVhdGVMb2NhbCgpLCB3aXRob3V0U3VmZml4KTsKICAgIH0KCiAgICAvLyBJZiBwYXNzZWQgYSBsb2NhbGUga2V5LCBpdCB3aWxsIHNldCB0aGUgbG9jYWxlIGZvciB0aGlzCiAgICAvLyBpbnN0YW5jZS4gIE90aGVyd2lzZSwgaXQgd2lsbCByZXR1cm4gdGhlIGxvY2FsZSBjb25maWd1cmF0aW9uCiAgICAvLyB2YXJpYWJsZXMgZm9yIHRoaXMgaW5zdGFuY2UuCiAgICBmdW5jdGlvbiBsb2NhbGUgKGtleSkgewogICAgICAgIHZhciBuZXdMb2NhbGVEYXRhOwoKICAgICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xvY2FsZS5fYWJicjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdMb2NhbGVEYXRhID0gZ2V0TG9jYWxlKGtleSk7CiAgICAgICAgICAgIGlmIChuZXdMb2NhbGVEYXRhICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2xvY2FsZSA9IG5ld0xvY2FsZURhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBsYW5nID0gZGVwcmVjYXRlKAogICAgICAgICdtb21lbnQoKS5sYW5nKCkgaXMgZGVwcmVjYXRlZC4gSW5zdGVhZCwgdXNlIG1vbWVudCgpLmxvY2FsZURhdGEoKSB0byBnZXQgdGhlIGxhbmd1YWdlIGNvbmZpZ3VyYXRpb24uIFVzZSBtb21lbnQoKS5sb2NhbGUoKSB0byBjaGFuZ2UgbGFuZ3VhZ2VzLicsCiAgICAgICAgZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZShrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgKTsKCiAgICBmdW5jdGlvbiBsb2NhbGVEYXRhICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbG9jYWxlOwogICAgfQoKICAgIHZhciBNU19QRVJfU0VDT05EID0gMTAwMDsKICAgIHZhciBNU19QRVJfTUlOVVRFID0gNjAgKiBNU19QRVJfU0VDT05EOwogICAgdmFyIE1TX1BFUl9IT1VSID0gNjAgKiBNU19QRVJfTUlOVVRFOwogICAgdmFyIE1TX1BFUl80MDBfWUVBUlMgPSAoMzY1ICogNDAwICsgOTcpICogMjQgKiBNU19QRVJfSE9VUjsKCiAgICAvLyBhY3R1YWwgbW9kdWxvIC0gaGFuZGxlcyBuZWdhdGl2ZSBudW1iZXJzIChmb3IgZGF0ZXMgYmVmb3JlIDE5NzApOgogICAgZnVuY3Rpb24gbW9kJDEoZGl2aWRlbmQsIGRpdmlzb3IpIHsKICAgICAgICByZXR1cm4gKGRpdmlkZW5kICUgZGl2aXNvciArIGRpdmlzb3IpICUgZGl2aXNvcjsKICAgIH0KCiAgICBmdW5jdGlvbiBsb2NhbFN0YXJ0T2ZEYXRlKHksIG0sIGQpIHsKICAgICAgICAvLyB0aGUgZGF0ZSBjb25zdHJ1Y3RvciByZW1hcHMgeWVhcnMgMC05OSB0byAxOTAwLTE5OTkKICAgICAgICBpZiAoeSA8IDEwMCAmJiB5ID49IDApIHsKICAgICAgICAgICAgLy8gcHJlc2VydmUgbGVhcCB5ZWFycyB1c2luZyBhIGZ1bGwgNDAwIHllYXIgY3ljbGUsIHRoZW4gcmVzZXQKICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHkgKyA0MDAsIG0sIGQpIC0gTVNfUEVSXzQwMF9ZRUFSUzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoeSwgbSwgZCkudmFsdWVPZigpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB1dGNTdGFydE9mRGF0ZSh5LCBtLCBkKSB7CiAgICAgICAgLy8gRGF0ZS5VVEMgcmVtYXBzIHllYXJzIDAtOTkgdG8gMTkwMC0xOTk5CiAgICAgICAgaWYgKHkgPCAxMDAgJiYgeSA+PSAwKSB7CiAgICAgICAgICAgIC8vIHByZXNlcnZlIGxlYXAgeWVhcnMgdXNpbmcgYSBmdWxsIDQwMCB5ZWFyIGN5Y2xlLCB0aGVuIHJlc2V0CiAgICAgICAgICAgIHJldHVybiBEYXRlLlVUQyh5ICsgNDAwLCBtLCBkKSAtIE1TX1BFUl80MDBfWUVBUlM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIERhdGUuVVRDKHksIG0sIGQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzdGFydE9mICh1bml0cykgewogICAgICAgIHZhciB0aW1lOwogICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgIGlmICh1bml0cyA9PT0gdW5kZWZpbmVkIHx8IHVuaXRzID09PSAnbWlsbGlzZWNvbmQnIHx8ICF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIHZhciBzdGFydE9mRGF0ZSA9IHRoaXMuX2lzVVRDID8gdXRjU3RhcnRPZkRhdGUgOiBsb2NhbFN0YXJ0T2ZEYXRlOwoKICAgICAgICBzd2l0Y2ggKHVuaXRzKSB7CiAgICAgICAgICAgIGNhc2UgJ3llYXInOgogICAgICAgICAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCAwLCAxKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdxdWFydGVyJzoKICAgICAgICAgICAgICAgIHRpbWUgPSBzdGFydE9mRGF0ZSh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpIC0gdGhpcy5tb250aCgpICUgMywgMSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnbW9udGgnOgogICAgICAgICAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIDEpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3dlZWsnOgogICAgICAgICAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIHRoaXMuZGF0ZSgpIC0gdGhpcy53ZWVrZGF5KCkpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2lzb1dlZWsnOgogICAgICAgICAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIHRoaXMuZGF0ZSgpIC0gKHRoaXMuaXNvV2Vla2RheSgpIC0gMSkpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2RheSc6CiAgICAgICAgICAgIGNhc2UgJ2RhdGUnOgogICAgICAgICAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIHRoaXMuZGF0ZSgpKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdob3VyJzoKICAgICAgICAgICAgICAgIHRpbWUgPSB0aGlzLl9kLnZhbHVlT2YoKTsKICAgICAgICAgICAgICAgIHRpbWUgLT0gbW9kJDEodGltZSArICh0aGlzLl9pc1VUQyA/IDAgOiB0aGlzLnV0Y09mZnNldCgpICogTVNfUEVSX01JTlVURSksIE1TX1BFUl9IT1VSKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdtaW51dGUnOgogICAgICAgICAgICAgICAgdGltZSA9IHRoaXMuX2QudmFsdWVPZigpOwogICAgICAgICAgICAgICAgdGltZSAtPSBtb2QkMSh0aW1lLCBNU19QRVJfTUlOVVRFKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdzZWNvbmQnOgogICAgICAgICAgICAgICAgdGltZSA9IHRoaXMuX2QudmFsdWVPZigpOwogICAgICAgICAgICAgICAgdGltZSAtPSBtb2QkMSh0aW1lLCBNU19QRVJfU0VDT05EKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fZC5zZXRUaW1lKHRpbWUpOwogICAgICAgIGhvb2tzLnVwZGF0ZU9mZnNldCh0aGlzLCB0cnVlKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICBmdW5jdGlvbiBlbmRPZiAodW5pdHMpIHsKICAgICAgICB2YXIgdGltZTsKICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICBpZiAodW5pdHMgPT09IHVuZGVmaW5lZCB8fCB1bml0cyA9PT0gJ21pbGxpc2Vjb25kJyB8fCAhdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhcnRPZkRhdGUgPSB0aGlzLl9pc1VUQyA/IHV0Y1N0YXJ0T2ZEYXRlIDogbG9jYWxTdGFydE9mRGF0ZTsKCiAgICAgICAgc3dpdGNoICh1bml0cykgewogICAgICAgICAgICBjYXNlICd5ZWFyJzoKICAgICAgICAgICAgICAgIHRpbWUgPSBzdGFydE9mRGF0ZSh0aGlzLnllYXIoKSArIDEsIDAsIDEpIC0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdxdWFydGVyJzoKICAgICAgICAgICAgICAgIHRpbWUgPSBzdGFydE9mRGF0ZSh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpIC0gdGhpcy5tb250aCgpICUgMyArIDMsIDEpIC0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdtb250aCc6CiAgICAgICAgICAgICAgICB0aW1lID0gc3RhcnRPZkRhdGUodGhpcy55ZWFyKCksIHRoaXMubW9udGgoKSArIDEsIDEpIC0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICd3ZWVrJzoKICAgICAgICAgICAgICAgIHRpbWUgPSBzdGFydE9mRGF0ZSh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpLCB0aGlzLmRhdGUoKSAtIHRoaXMud2Vla2RheSgpICsgNykgLSAxOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2lzb1dlZWsnOgogICAgICAgICAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIHRoaXMuZGF0ZSgpIC0gKHRoaXMuaXNvV2Vla2RheSgpIC0gMSkgKyA3KSAtIDE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnZGF5JzoKICAgICAgICAgICAgY2FzZSAnZGF0ZSc6CiAgICAgICAgICAgICAgICB0aW1lID0gc3RhcnRPZkRhdGUodGhpcy55ZWFyKCksIHRoaXMubW9udGgoKSwgdGhpcy5kYXRlKCkgKyAxKSAtIDE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnaG91cic6CiAgICAgICAgICAgICAgICB0aW1lID0gdGhpcy5fZC52YWx1ZU9mKCk7CiAgICAgICAgICAgICAgICB0aW1lICs9IE1TX1BFUl9IT1VSIC0gbW9kJDEodGltZSArICh0aGlzLl9pc1VUQyA/IDAgOiB0aGlzLnV0Y09mZnNldCgpICogTVNfUEVSX01JTlVURSksIE1TX1BFUl9IT1VSKSAtIDE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnbWludXRlJzoKICAgICAgICAgICAgICAgIHRpbWUgPSB0aGlzLl9kLnZhbHVlT2YoKTsKICAgICAgICAgICAgICAgIHRpbWUgKz0gTVNfUEVSX01JTlVURSAtIG1vZCQxKHRpbWUsIE1TX1BFUl9NSU5VVEUpIC0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdzZWNvbmQnOgogICAgICAgICAgICAgICAgdGltZSA9IHRoaXMuX2QudmFsdWVPZigpOwogICAgICAgICAgICAgICAgdGltZSArPSBNU19QRVJfU0VDT05EIC0gbW9kJDEodGltZSwgTVNfUEVSX1NFQ09ORCkgLSAxOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9kLnNldFRpbWUodGltZSk7CiAgICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMsIHRydWUpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGZ1bmN0aW9uIHZhbHVlT2YgKCkgewogICAgICAgIHJldHVybiB0aGlzLl9kLnZhbHVlT2YoKSAtICgodGhpcy5fb2Zmc2V0IHx8IDApICogNjAwMDApOwogICAgfQoKICAgIGZ1bmN0aW9uIHVuaXggKCkgewogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMudmFsdWVPZigpIC8gMTAwMCk7CiAgICB9CgogICAgZnVuY3Rpb24gdG9EYXRlICgpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUodGhpcy52YWx1ZU9mKCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvQXJyYXkgKCkgewogICAgICAgIHZhciBtID0gdGhpczsKICAgICAgICByZXR1cm4gW20ueWVhcigpLCBtLm1vbnRoKCksIG0uZGF0ZSgpLCBtLmhvdXIoKSwgbS5taW51dGUoKSwgbS5zZWNvbmQoKSwgbS5taWxsaXNlY29uZCgpXTsKICAgIH0KCiAgICBmdW5jdGlvbiB0b09iamVjdCAoKSB7CiAgICAgICAgdmFyIG0gPSB0aGlzOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHllYXJzOiBtLnllYXIoKSwKICAgICAgICAgICAgbW9udGhzOiBtLm1vbnRoKCksCiAgICAgICAgICAgIGRhdGU6IG0uZGF0ZSgpLAogICAgICAgICAgICBob3VyczogbS5ob3VycygpLAogICAgICAgICAgICBtaW51dGVzOiBtLm1pbnV0ZXMoKSwKICAgICAgICAgICAgc2Vjb25kczogbS5zZWNvbmRzKCksCiAgICAgICAgICAgIG1pbGxpc2Vjb25kczogbS5taWxsaXNlY29uZHMoKQogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gdG9KU09OICgpIHsKICAgICAgICAvLyBuZXcgRGF0ZShOYU4pLnRvSlNPTigpID09PSBudWxsCiAgICAgICAgcmV0dXJuIHRoaXMuaXNWYWxpZCgpID8gdGhpcy50b0lTT1N0cmluZygpIDogbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBpc1ZhbGlkJDIgKCkgewogICAgICAgIHJldHVybiBpc1ZhbGlkKHRoaXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhcnNpbmdGbGFncyAoKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZCh7fSwgZ2V0UGFyc2luZ0ZsYWdzKHRoaXMpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZhbGlkQXQgKCkgewogICAgICAgIHJldHVybiBnZXRQYXJzaW5nRmxhZ3ModGhpcykub3ZlcmZsb3c7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRpb25EYXRhKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlucHV0OiB0aGlzLl9pLAogICAgICAgICAgICBmb3JtYXQ6IHRoaXMuX2YsCiAgICAgICAgICAgIGxvY2FsZTogdGhpcy5fbG9jYWxlLAogICAgICAgICAgICBpc1VUQzogdGhpcy5faXNVVEMsCiAgICAgICAgICAgIHN0cmljdDogdGhpcy5fc3RyaWN0CiAgICAgICAgfTsKICAgIH0KCiAgICAvLyBGT1JNQVRUSU5HCgogICAgYWRkRm9ybWF0VG9rZW4oMCwgWydnZycsIDJdLCAwLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMud2Vla1llYXIoKSAlIDEwMDsKICAgIH0pOwoKICAgIGFkZEZvcm1hdFRva2VuKDAsIFsnR0cnLCAyXSwgMCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmlzb1dlZWtZZWFyKCkgJSAxMDA7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBhZGRXZWVrWWVhckZvcm1hdFRva2VuICh0b2tlbiwgZ2V0dGVyKSB7CiAgICAgICAgYWRkRm9ybWF0VG9rZW4oMCwgW3Rva2VuLCB0b2tlbi5sZW5ndGhdLCAwLCBnZXR0ZXIpOwogICAgfQoKICAgIGFkZFdlZWtZZWFyRm9ybWF0VG9rZW4oJ2dnZ2cnLCAgICAgJ3dlZWtZZWFyJyk7CiAgICBhZGRXZWVrWWVhckZvcm1hdFRva2VuKCdnZ2dnZycsICAgICd3ZWVrWWVhcicpOwogICAgYWRkV2Vla1llYXJGb3JtYXRUb2tlbignR0dHRycsICAnaXNvV2Vla1llYXInKTsKICAgIGFkZFdlZWtZZWFyRm9ybWF0VG9rZW4oJ0dHR0dHJywgJ2lzb1dlZWtZZWFyJyk7CgogICAgLy8gQUxJQVNFUwoKICAgIGFkZFVuaXRBbGlhcygnd2Vla1llYXInLCAnZ2cnKTsKICAgIGFkZFVuaXRBbGlhcygnaXNvV2Vla1llYXInLCAnR0cnKTsKCiAgICAvLyBQUklPUklUWQoKICAgIGFkZFVuaXRQcmlvcml0eSgnd2Vla1llYXInLCAxKTsKICAgIGFkZFVuaXRQcmlvcml0eSgnaXNvV2Vla1llYXInLCAxKTsKCgogICAgLy8gUEFSU0lORwoKICAgIGFkZFJlZ2V4VG9rZW4oJ0cnLCAgICAgIG1hdGNoU2lnbmVkKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ2cnLCAgICAgIG1hdGNoU2lnbmVkKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ0dHJywgICAgIG1hdGNoMXRvMiwgbWF0Y2gyKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ2dnJywgICAgIG1hdGNoMXRvMiwgbWF0Y2gyKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ0dHR0cnLCAgIG1hdGNoMXRvNCwgbWF0Y2g0KTsKICAgIGFkZFJlZ2V4VG9rZW4oJ2dnZ2cnLCAgIG1hdGNoMXRvNCwgbWF0Y2g0KTsKICAgIGFkZFJlZ2V4VG9rZW4oJ0dHR0dHJywgIG1hdGNoMXRvNiwgbWF0Y2g2KTsKICAgIGFkZFJlZ2V4VG9rZW4oJ2dnZ2dnJywgIG1hdGNoMXRvNiwgbWF0Y2g2KTsKCiAgICBhZGRXZWVrUGFyc2VUb2tlbihbJ2dnZ2cnLCAnZ2dnZ2cnLCAnR0dHRycsICdHR0dHRyddLCBmdW5jdGlvbiAoaW5wdXQsIHdlZWssIGNvbmZpZywgdG9rZW4pIHsKICAgICAgICB3ZWVrW3Rva2VuLnN1YnN0cigwLCAyKV0gPSB0b0ludChpbnB1dCk7CiAgICB9KTsKCiAgICBhZGRXZWVrUGFyc2VUb2tlbihbJ2dnJywgJ0dHJ10sIGZ1bmN0aW9uIChpbnB1dCwgd2VlaywgY29uZmlnLCB0b2tlbikgewogICAgICAgIHdlZWtbdG9rZW5dID0gaG9va3MucGFyc2VUd29EaWdpdFllYXIoaW5wdXQpOwogICAgfSk7CgogICAgLy8gTU9NRU5UUwoKICAgIGZ1bmN0aW9uIGdldFNldFdlZWtZZWFyIChpbnB1dCkgewogICAgICAgIHJldHVybiBnZXRTZXRXZWVrWWVhckhlbHBlci5jYWxsKHRoaXMsCiAgICAgICAgICAgICAgICBpbnB1dCwKICAgICAgICAgICAgICAgIHRoaXMud2VlaygpLAogICAgICAgICAgICAgICAgdGhpcy53ZWVrZGF5KCksCiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZURhdGEoKS5fd2Vlay5kb3csCiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZURhdGEoKS5fd2Vlay5kb3kpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFNldElTT1dlZWtZZWFyIChpbnB1dCkgewogICAgICAgIHJldHVybiBnZXRTZXRXZWVrWWVhckhlbHBlci5jYWxsKHRoaXMsCiAgICAgICAgICAgICAgICBpbnB1dCwgdGhpcy5pc29XZWVrKCksIHRoaXMuaXNvV2Vla2RheSgpLCAxLCA0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRJU09XZWVrc0luWWVhciAoKSB7CiAgICAgICAgcmV0dXJuIHdlZWtzSW5ZZWFyKHRoaXMueWVhcigpLCAxLCA0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRXZWVrc0luWWVhciAoKSB7CiAgICAgICAgdmFyIHdlZWtJbmZvID0gdGhpcy5sb2NhbGVEYXRhKCkuX3dlZWs7CiAgICAgICAgcmV0dXJuIHdlZWtzSW5ZZWFyKHRoaXMueWVhcigpLCB3ZWVrSW5mby5kb3csIHdlZWtJbmZvLmRveSk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0U2V0V2Vla1llYXJIZWxwZXIoaW5wdXQsIHdlZWssIHdlZWtkYXksIGRvdywgZG95KSB7CiAgICAgICAgdmFyIHdlZWtzVGFyZ2V0OwogICAgICAgIGlmIChpbnB1dCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB3ZWVrT2ZZZWFyKHRoaXMsIGRvdywgZG95KS55ZWFyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdlZWtzVGFyZ2V0ID0gd2Vla3NJblllYXIoaW5wdXQsIGRvdywgZG95KTsKICAgICAgICAgICAgaWYgKHdlZWsgPiB3ZWVrc1RhcmdldCkgewogICAgICAgICAgICAgICAgd2VlayA9IHdlZWtzVGFyZ2V0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzZXRXZWVrQWxsLmNhbGwodGhpcywgaW5wdXQsIHdlZWssIHdlZWtkYXksIGRvdywgZG95KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2V0V2Vla0FsbCh3ZWVrWWVhciwgd2Vlaywgd2Vla2RheSwgZG93LCBkb3kpIHsKICAgICAgICB2YXIgZGF5T2ZZZWFyRGF0YSA9IGRheU9mWWVhckZyb21XZWVrcyh3ZWVrWWVhciwgd2Vlaywgd2Vla2RheSwgZG93LCBkb3kpLAogICAgICAgICAgICBkYXRlID0gY3JlYXRlVVRDRGF0ZShkYXlPZlllYXJEYXRhLnllYXIsIDAsIGRheU9mWWVhckRhdGEuZGF5T2ZZZWFyKTsKCiAgICAgICAgdGhpcy55ZWFyKGRhdGUuZ2V0VVRDRnVsbFllYXIoKSk7CiAgICAgICAgdGhpcy5tb250aChkYXRlLmdldFVUQ01vbnRoKCkpOwogICAgICAgIHRoaXMuZGF0ZShkYXRlLmdldFVUQ0RhdGUoKSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLy8gRk9STUFUVElORwoKICAgIGFkZEZvcm1hdFRva2VuKCdRJywgMCwgJ1FvJywgJ3F1YXJ0ZXInKTsKCiAgICAvLyBBTElBU0VTCgogICAgYWRkVW5pdEFsaWFzKCdxdWFydGVyJywgJ1EnKTsKCiAgICAvLyBQUklPUklUWQoKICAgIGFkZFVuaXRQcmlvcml0eSgncXVhcnRlcicsIDcpOwoKICAgIC8vIFBBUlNJTkcKCiAgICBhZGRSZWdleFRva2VuKCdRJywgbWF0Y2gxKTsKICAgIGFkZFBhcnNlVG9rZW4oJ1EnLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICAgICAgYXJyYXlbTU9OVEhdID0gKHRvSW50KGlucHV0KSAtIDEpICogMzsKICAgIH0pOwoKICAgIC8vIE1PTUVOVFMKCiAgICBmdW5jdGlvbiBnZXRTZXRRdWFydGVyIChpbnB1dCkgewogICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gTWF0aC5jZWlsKCh0aGlzLm1vbnRoKCkgKyAxKSAvIDMpIDogdGhpcy5tb250aCgoaW5wdXQgLSAxKSAqIDMgKyB0aGlzLm1vbnRoKCkgJSAzKTsKICAgIH0KCiAgICAvLyBGT1JNQVRUSU5HCgogICAgYWRkRm9ybWF0VG9rZW4oJ0QnLCBbJ0REJywgMl0sICdEbycsICdkYXRlJyk7CgogICAgLy8gQUxJQVNFUwoKICAgIGFkZFVuaXRBbGlhcygnZGF0ZScsICdEJyk7CgogICAgLy8gUFJJT1JJVFkKICAgIGFkZFVuaXRQcmlvcml0eSgnZGF0ZScsIDkpOwoKICAgIC8vIFBBUlNJTkcKCiAgICBhZGRSZWdleFRva2VuKCdEJywgIG1hdGNoMXRvMik7CiAgICBhZGRSZWdleFRva2VuKCdERCcsIG1hdGNoMXRvMiwgbWF0Y2gyKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ0RvJywgZnVuY3Rpb24gKGlzU3RyaWN0LCBsb2NhbGUpIHsKICAgICAgICAvLyBUT0RPOiBSZW1vdmUgIm9yZGluYWxQYXJzZSIgZmFsbGJhY2sgaW4gbmV4dCBtYWpvciByZWxlYXNlLgogICAgICAgIHJldHVybiBpc1N0cmljdCA/CiAgICAgICAgICAobG9jYWxlLl9kYXlPZk1vbnRoT3JkaW5hbFBhcnNlIHx8IGxvY2FsZS5fb3JkaW5hbFBhcnNlKSA6CiAgICAgICAgICBsb2NhbGUuX2RheU9mTW9udGhPcmRpbmFsUGFyc2VMZW5pZW50OwogICAgfSk7CgogICAgYWRkUGFyc2VUb2tlbihbJ0QnLCAnREQnXSwgREFURSk7CiAgICBhZGRQYXJzZVRva2VuKCdEbycsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXkpIHsKICAgICAgICBhcnJheVtEQVRFXSA9IHRvSW50KGlucHV0Lm1hdGNoKG1hdGNoMXRvMilbMF0pOwogICAgfSk7CgogICAgLy8gTU9NRU5UUwoKICAgIHZhciBnZXRTZXREYXlPZk1vbnRoID0gbWFrZUdldFNldCgnRGF0ZScsIHRydWUpOwoKICAgIC8vIEZPUk1BVFRJTkcKCiAgICBhZGRGb3JtYXRUb2tlbignREREJywgWydEREREJywgM10sICdERERvJywgJ2RheU9mWWVhcicpOwoKICAgIC8vIEFMSUFTRVMKCiAgICBhZGRVbml0QWxpYXMoJ2RheU9mWWVhcicsICdEREQnKTsKCiAgICAvLyBQUklPUklUWQogICAgYWRkVW5pdFByaW9yaXR5KCdkYXlPZlllYXInLCA0KTsKCiAgICAvLyBQQVJTSU5HCgogICAgYWRkUmVnZXhUb2tlbignREREJywgIG1hdGNoMXRvMyk7CiAgICBhZGRSZWdleFRva2VuKCdEREREJywgbWF0Y2gzKTsKICAgIGFkZFBhcnNlVG9rZW4oWydEREQnLCAnRERERCddLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcpIHsKICAgICAgICBjb25maWcuX2RheU9mWWVhciA9IHRvSW50KGlucHV0KTsKICAgIH0pOwoKICAgIC8vIEhFTFBFUlMKCiAgICAvLyBNT01FTlRTCgogICAgZnVuY3Rpb24gZ2V0U2V0RGF5T2ZZZWFyIChpbnB1dCkgewogICAgICAgIHZhciBkYXlPZlllYXIgPSBNYXRoLnJvdW5kKCh0aGlzLmNsb25lKCkuc3RhcnRPZignZGF5JykgLSB0aGlzLmNsb25lKCkuc3RhcnRPZigneWVhcicpKSAvIDg2NGU1KSArIDE7CiAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyBkYXlPZlllYXIgOiB0aGlzLmFkZCgoaW5wdXQgLSBkYXlPZlllYXIpLCAnZCcpOwogICAgfQoKICAgIC8vIEZPUk1BVFRJTkcKCiAgICBhZGRGb3JtYXRUb2tlbignbScsIFsnbW0nLCAyXSwgMCwgJ21pbnV0ZScpOwoKICAgIC8vIEFMSUFTRVMKCiAgICBhZGRVbml0QWxpYXMoJ21pbnV0ZScsICdtJyk7CgogICAgLy8gUFJJT1JJVFkKCiAgICBhZGRVbml0UHJpb3JpdHkoJ21pbnV0ZScsIDE0KTsKCiAgICAvLyBQQVJTSU5HCgogICAgYWRkUmVnZXhUb2tlbignbScsICBtYXRjaDF0bzIpOwogICAgYWRkUmVnZXhUb2tlbignbW0nLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgICBhZGRQYXJzZVRva2VuKFsnbScsICdtbSddLCBNSU5VVEUpOwoKICAgIC8vIE1PTUVOVFMKCiAgICB2YXIgZ2V0U2V0TWludXRlID0gbWFrZUdldFNldCgnTWludXRlcycsIGZhbHNlKTsKCiAgICAvLyBGT1JNQVRUSU5HCgogICAgYWRkRm9ybWF0VG9rZW4oJ3MnLCBbJ3NzJywgMl0sIDAsICdzZWNvbmQnKTsKCiAgICAvLyBBTElBU0VTCgogICAgYWRkVW5pdEFsaWFzKCdzZWNvbmQnLCAncycpOwoKICAgIC8vIFBSSU9SSVRZCgogICAgYWRkVW5pdFByaW9yaXR5KCdzZWNvbmQnLCAxNSk7CgogICAgLy8gUEFSU0lORwoKICAgIGFkZFJlZ2V4VG9rZW4oJ3MnLCAgbWF0Y2gxdG8yKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ3NzJywgbWF0Y2gxdG8yLCBtYXRjaDIpOwogICAgYWRkUGFyc2VUb2tlbihbJ3MnLCAnc3MnXSwgU0VDT05EKTsKCiAgICAvLyBNT01FTlRTCgogICAgdmFyIGdldFNldFNlY29uZCA9IG1ha2VHZXRTZXQoJ1NlY29uZHMnLCBmYWxzZSk7CgogICAgLy8gRk9STUFUVElORwoKICAgIGFkZEZvcm1hdFRva2VuKCdTJywgMCwgMCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB+fih0aGlzLm1pbGxpc2Vjb25kKCkgLyAxMDApOwogICAgfSk7CgogICAgYWRkRm9ybWF0VG9rZW4oMCwgWydTUycsIDJdLCAwLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIH5+KHRoaXMubWlsbGlzZWNvbmQoKSAvIDEwKTsKICAgIH0pOwoKICAgIGFkZEZvcm1hdFRva2VuKDAsIFsnU1NTJywgM10sIDAsICdtaWxsaXNlY29uZCcpOwogICAgYWRkRm9ybWF0VG9rZW4oMCwgWydTU1NTJywgNF0sIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTA7CiAgICB9KTsKICAgIGFkZEZvcm1hdFRva2VuKDAsIFsnU1NTU1MnLCA1XSwgMCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLm1pbGxpc2Vjb25kKCkgKiAxMDA7CiAgICB9KTsKICAgIGFkZEZvcm1hdFRva2VuKDAsIFsnU1NTU1NTJywgNl0sIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTAwMDsKICAgIH0pOwogICAgYWRkRm9ybWF0VG9rZW4oMCwgWydTU1NTU1NTJywgN10sIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTAwMDA7CiAgICB9KTsKICAgIGFkZEZvcm1hdFRva2VuKDAsIFsnU1NTU1NTU1MnLCA4XSwgMCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLm1pbGxpc2Vjb25kKCkgKiAxMDAwMDA7CiAgICB9KTsKICAgIGFkZEZvcm1hdFRva2VuKDAsIFsnU1NTU1NTU1NTJywgOV0sIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTAwMDAwMDsKICAgIH0pOwoKCiAgICAvLyBBTElBU0VTCgogICAgYWRkVW5pdEFsaWFzKCdtaWxsaXNlY29uZCcsICdtcycpOwoKICAgIC8vIFBSSU9SSVRZCgogICAgYWRkVW5pdFByaW9yaXR5KCdtaWxsaXNlY29uZCcsIDE2KTsKCiAgICAvLyBQQVJTSU5HCgogICAgYWRkUmVnZXhUb2tlbignUycsICAgIG1hdGNoMXRvMywgbWF0Y2gxKTsKICAgIGFkZFJlZ2V4VG9rZW4oJ1NTJywgICBtYXRjaDF0bzMsIG1hdGNoMik7CiAgICBhZGRSZWdleFRva2VuKCdTU1MnLCAgbWF0Y2gxdG8zLCBtYXRjaDMpOwoKICAgIHZhciB0b2tlbjsKICAgIGZvciAodG9rZW4gPSAnU1NTUyc7IHRva2VuLmxlbmd0aCA8PSA5OyB0b2tlbiArPSAnUycpIHsKICAgICAgICBhZGRSZWdleFRva2VuKHRva2VuLCBtYXRjaFVuc2lnbmVkKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZU1zKGlucHV0LCBhcnJheSkgewogICAgICAgIGFycmF5W01JTExJU0VDT05EXSA9IHRvSW50KCgnMC4nICsgaW5wdXQpICogMTAwMCk7CiAgICB9CgogICAgZm9yICh0b2tlbiA9ICdTJzsgdG9rZW4ubGVuZ3RoIDw9IDk7IHRva2VuICs9ICdTJykgewogICAgICAgIGFkZFBhcnNlVG9rZW4odG9rZW4sIHBhcnNlTXMpOwogICAgfQogICAgLy8gTU9NRU5UUwoKICAgIHZhciBnZXRTZXRNaWxsaXNlY29uZCA9IG1ha2VHZXRTZXQoJ01pbGxpc2Vjb25kcycsIGZhbHNlKTsKCiAgICAvLyBGT1JNQVRUSU5HCgogICAgYWRkRm9ybWF0VG9rZW4oJ3onLCAgMCwgMCwgJ3pvbmVBYmJyJyk7CiAgICBhZGRGb3JtYXRUb2tlbignenonLCAwLCAwLCAnem9uZU5hbWUnKTsKCiAgICAvLyBNT01FTlRTCgogICAgZnVuY3Rpb24gZ2V0Wm9uZUFiYnIgKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICdVVEMnIDogJyc7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Wm9uZU5hbWUgKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICdDb29yZGluYXRlZCBVbml2ZXJzYWwgVGltZScgOiAnJzsKICAgIH0KCiAgICB2YXIgcHJvdG8gPSBNb21lbnQucHJvdG90eXBlOwoKICAgIHByb3RvLmFkZCAgICAgICAgICAgICAgID0gYWRkOwogICAgcHJvdG8uY2FsZW5kYXIgICAgICAgICAgPSBjYWxlbmRhciQxOwogICAgcHJvdG8uY2xvbmUgICAgICAgICAgICAgPSBjbG9uZTsKICAgIHByb3RvLmRpZmYgICAgICAgICAgICAgID0gZGlmZjsKICAgIHByb3RvLmVuZE9mICAgICAgICAgICAgID0gZW5kT2Y7CiAgICBwcm90by5mb3JtYXQgICAgICAgICAgICA9IGZvcm1hdDsKICAgIHByb3RvLmZyb20gICAgICAgICAgICAgID0gZnJvbTsKICAgIHByb3RvLmZyb21Ob3cgICAgICAgICAgID0gZnJvbU5vdzsKICAgIHByb3RvLnRvICAgICAgICAgICAgICAgID0gdG87CiAgICBwcm90by50b05vdyAgICAgICAgICAgICA9IHRvTm93OwogICAgcHJvdG8uZ2V0ICAgICAgICAgICAgICAgPSBzdHJpbmdHZXQ7CiAgICBwcm90by5pbnZhbGlkQXQgICAgICAgICA9IGludmFsaWRBdDsKICAgIHByb3RvLmlzQWZ0ZXIgICAgICAgICAgID0gaXNBZnRlcjsKICAgIHByb3RvLmlzQmVmb3JlICAgICAgICAgID0gaXNCZWZvcmU7CiAgICBwcm90by5pc0JldHdlZW4gICAgICAgICA9IGlzQmV0d2VlbjsKICAgIHByb3RvLmlzU2FtZSAgICAgICAgICAgID0gaXNTYW1lOwogICAgcHJvdG8uaXNTYW1lT3JBZnRlciAgICAgPSBpc1NhbWVPckFmdGVyOwogICAgcHJvdG8uaXNTYW1lT3JCZWZvcmUgICAgPSBpc1NhbWVPckJlZm9yZTsKICAgIHByb3RvLmlzVmFsaWQgICAgICAgICAgID0gaXNWYWxpZCQyOwogICAgcHJvdG8ubGFuZyAgICAgICAgICAgICAgPSBsYW5nOwogICAgcHJvdG8ubG9jYWxlICAgICAgICAgICAgPSBsb2NhbGU7CiAgICBwcm90by5sb2NhbGVEYXRhICAgICAgICA9IGxvY2FsZURhdGE7CiAgICBwcm90by5tYXggICAgICAgICAgICAgICA9IHByb3RvdHlwZU1heDsKICAgIHByb3RvLm1pbiAgICAgICAgICAgICAgID0gcHJvdG90eXBlTWluOwogICAgcHJvdG8ucGFyc2luZ0ZsYWdzICAgICAgPSBwYXJzaW5nRmxhZ3M7CiAgICBwcm90by5zZXQgICAgICAgICAgICAgICA9IHN0cmluZ1NldDsKICAgIHByb3RvLnN0YXJ0T2YgICAgICAgICAgID0gc3RhcnRPZjsKICAgIHByb3RvLnN1YnRyYWN0ICAgICAgICAgID0gc3VidHJhY3Q7CiAgICBwcm90by50b0FycmF5ICAgICAgICAgICA9IHRvQXJyYXk7CiAgICBwcm90by50b09iamVjdCAgICAgICAgICA9IHRvT2JqZWN0OwogICAgcHJvdG8udG9EYXRlICAgICAgICAgICAgPSB0b0RhdGU7CiAgICBwcm90by50b0lTT1N0cmluZyAgICAgICA9IHRvSVNPU3RyaW5nOwogICAgcHJvdG8uaW5zcGVjdCAgICAgICAgICAgPSBpbnNwZWN0OwogICAgcHJvdG8udG9KU09OICAgICAgICAgICAgPSB0b0pTT047CiAgICBwcm90by50b1N0cmluZyAgICAgICAgICA9IHRvU3RyaW5nOwogICAgcHJvdG8udW5peCAgICAgICAgICAgICAgPSB1bml4OwogICAgcHJvdG8udmFsdWVPZiAgICAgICAgICAgPSB2YWx1ZU9mOwogICAgcHJvdG8uY3JlYXRpb25EYXRhICAgICAgPSBjcmVhdGlvbkRhdGE7CiAgICBwcm90by55ZWFyICAgICAgID0gZ2V0U2V0WWVhcjsKICAgIHByb3RvLmlzTGVhcFllYXIgPSBnZXRJc0xlYXBZZWFyOwogICAgcHJvdG8ud2Vla1llYXIgICAgPSBnZXRTZXRXZWVrWWVhcjsKICAgIHByb3RvLmlzb1dlZWtZZWFyID0gZ2V0U2V0SVNPV2Vla1llYXI7CiAgICBwcm90by5xdWFydGVyID0gcHJvdG8ucXVhcnRlcnMgPSBnZXRTZXRRdWFydGVyOwogICAgcHJvdG8ubW9udGggICAgICAgPSBnZXRTZXRNb250aDsKICAgIHByb3RvLmRheXNJbk1vbnRoID0gZ2V0RGF5c0luTW9udGg7CiAgICBwcm90by53ZWVrICAgICAgICAgICA9IHByb3RvLndlZWtzICAgICAgICA9IGdldFNldFdlZWs7CiAgICBwcm90by5pc29XZWVrICAgICAgICA9IHByb3RvLmlzb1dlZWtzICAgICA9IGdldFNldElTT1dlZWs7CiAgICBwcm90by53ZWVrc0luWWVhciAgICA9IGdldFdlZWtzSW5ZZWFyOwogICAgcHJvdG8uaXNvV2Vla3NJblllYXIgPSBnZXRJU09XZWVrc0luWWVhcjsKICAgIHByb3RvLmRhdGUgICAgICAgPSBnZXRTZXREYXlPZk1vbnRoOwogICAgcHJvdG8uZGF5ICAgICAgICA9IHByb3RvLmRheXMgICAgICAgICAgICAgPSBnZXRTZXREYXlPZldlZWs7CiAgICBwcm90by53ZWVrZGF5ICAgID0gZ2V0U2V0TG9jYWxlRGF5T2ZXZWVrOwogICAgcHJvdG8uaXNvV2Vla2RheSA9IGdldFNldElTT0RheU9mV2VlazsKICAgIHByb3RvLmRheU9mWWVhciAgPSBnZXRTZXREYXlPZlllYXI7CiAgICBwcm90by5ob3VyID0gcHJvdG8uaG91cnMgPSBnZXRTZXRIb3VyOwogICAgcHJvdG8ubWludXRlID0gcHJvdG8ubWludXRlcyA9IGdldFNldE1pbnV0ZTsKICAgIHByb3RvLnNlY29uZCA9IHByb3RvLnNlY29uZHMgPSBnZXRTZXRTZWNvbmQ7CiAgICBwcm90by5taWxsaXNlY29uZCA9IHByb3RvLm1pbGxpc2Vjb25kcyA9IGdldFNldE1pbGxpc2Vjb25kOwogICAgcHJvdG8udXRjT2Zmc2V0ICAgICAgICAgICAgPSBnZXRTZXRPZmZzZXQ7CiAgICBwcm90by51dGMgICAgICAgICAgICAgICAgICA9IHNldE9mZnNldFRvVVRDOwogICAgcHJvdG8ubG9jYWwgICAgICAgICAgICAgICAgPSBzZXRPZmZzZXRUb0xvY2FsOwogICAgcHJvdG8ucGFyc2Vab25lICAgICAgICAgICAgPSBzZXRPZmZzZXRUb1BhcnNlZE9mZnNldDsKICAgIHByb3RvLmhhc0FsaWduZWRIb3VyT2Zmc2V0ID0gaGFzQWxpZ25lZEhvdXJPZmZzZXQ7CiAgICBwcm90by5pc0RTVCAgICAgICAgICAgICAgICA9IGlzRGF5bGlnaHRTYXZpbmdUaW1lOwogICAgcHJvdG8uaXNMb2NhbCAgICAgICAgICAgICAgPSBpc0xvY2FsOwogICAgcHJvdG8uaXNVdGNPZmZzZXQgICAgICAgICAgPSBpc1V0Y09mZnNldDsKICAgIHByb3RvLmlzVXRjICAgICAgICAgICAgICAgID0gaXNVdGM7CiAgICBwcm90by5pc1VUQyAgICAgICAgICAgICAgICA9IGlzVXRjOwogICAgcHJvdG8uem9uZUFiYnIgPSBnZXRab25lQWJicjsKICAgIHByb3RvLnpvbmVOYW1lID0gZ2V0Wm9uZU5hbWU7CiAgICBwcm90by5kYXRlcyAgPSBkZXByZWNhdGUoJ2RhdGVzIGFjY2Vzc29yIGlzIGRlcHJlY2F0ZWQuIFVzZSBkYXRlIGluc3RlYWQuJywgZ2V0U2V0RGF5T2ZNb250aCk7CiAgICBwcm90by5tb250aHMgPSBkZXByZWNhdGUoJ21vbnRocyBhY2Nlc3NvciBpcyBkZXByZWNhdGVkLiBVc2UgbW9udGggaW5zdGVhZCcsIGdldFNldE1vbnRoKTsKICAgIHByb3RvLnllYXJzICA9IGRlcHJlY2F0ZSgneWVhcnMgYWNjZXNzb3IgaXMgZGVwcmVjYXRlZC4gVXNlIHllYXIgaW5zdGVhZCcsIGdldFNldFllYXIpOwogICAgcHJvdG8uem9uZSAgID0gZGVwcmVjYXRlKCdtb21lbnQoKS56b25lIGlzIGRlcHJlY2F0ZWQsIHVzZSBtb21lbnQoKS51dGNPZmZzZXQgaW5zdGVhZC4gaHR0cDovL21vbWVudGpzLmNvbS9ndWlkZXMvIy93YXJuaW5ncy96b25lLycsIGdldFNldFpvbmUpOwogICAgcHJvdG8uaXNEU1RTaGlmdGVkID0gZGVwcmVjYXRlKCdpc0RTVFNoaWZ0ZWQgaXMgZGVwcmVjYXRlZC4gU2VlIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvZHN0LXNoaWZ0ZWQvIGZvciBtb3JlIGluZm9ybWF0aW9uJywgaXNEYXlsaWdodFNhdmluZ1RpbWVTaGlmdGVkKTsKCiAgICBmdW5jdGlvbiBjcmVhdGVVbml4IChpbnB1dCkgewogICAgICAgIHJldHVybiBjcmVhdGVMb2NhbChpbnB1dCAqIDEwMDApOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUluWm9uZSAoKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUxvY2FsLmFwcGx5KG51bGwsIGFyZ3VtZW50cykucGFyc2Vab25lKCk7CiAgICB9CgogICAgZnVuY3Rpb24gcHJlUGFyc2VQb3N0Rm9ybWF0IChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgfQoKICAgIHZhciBwcm90byQxID0gTG9jYWxlLnByb3RvdHlwZTsKCiAgICBwcm90byQxLmNhbGVuZGFyICAgICAgICA9IGNhbGVuZGFyOwogICAgcHJvdG8kMS5sb25nRGF0ZUZvcm1hdCAgPSBsb25nRGF0ZUZvcm1hdDsKICAgIHByb3RvJDEuaW52YWxpZERhdGUgICAgID0gaW52YWxpZERhdGU7CiAgICBwcm90byQxLm9yZGluYWwgICAgICAgICA9IG9yZGluYWw7CiAgICBwcm90byQxLnByZXBhcnNlICAgICAgICA9IHByZVBhcnNlUG9zdEZvcm1hdDsKICAgIHByb3RvJDEucG9zdGZvcm1hdCAgICAgID0gcHJlUGFyc2VQb3N0Rm9ybWF0OwogICAgcHJvdG8kMS5yZWxhdGl2ZVRpbWUgICAgPSByZWxhdGl2ZVRpbWU7CiAgICBwcm90byQxLnBhc3RGdXR1cmUgICAgICA9IHBhc3RGdXR1cmU7CiAgICBwcm90byQxLnNldCAgICAgICAgICAgICA9IHNldDsKCiAgICBwcm90byQxLm1vbnRocyAgICAgICAgICAgID0gICAgICAgIGxvY2FsZU1vbnRoczsKICAgIHByb3RvJDEubW9udGhzU2hvcnQgICAgICAgPSAgICAgICAgbG9jYWxlTW9udGhzU2hvcnQ7CiAgICBwcm90byQxLm1vbnRoc1BhcnNlICAgICAgID0gICAgICAgIGxvY2FsZU1vbnRoc1BhcnNlOwogICAgcHJvdG8kMS5tb250aHNSZWdleCAgICAgICA9IG1vbnRoc1JlZ2V4OwogICAgcHJvdG8kMS5tb250aHNTaG9ydFJlZ2V4ICA9IG1vbnRoc1Nob3J0UmVnZXg7CiAgICBwcm90byQxLndlZWsgPSBsb2NhbGVXZWVrOwogICAgcHJvdG8kMS5maXJzdERheU9mWWVhciA9IGxvY2FsZUZpcnN0RGF5T2ZZZWFyOwogICAgcHJvdG8kMS5maXJzdERheU9mV2VlayA9IGxvY2FsZUZpcnN0RGF5T2ZXZWVrOwoKICAgIHByb3RvJDEud2Vla2RheXMgICAgICAgPSAgICAgICAgbG9jYWxlV2Vla2RheXM7CiAgICBwcm90byQxLndlZWtkYXlzTWluICAgID0gICAgICAgIGxvY2FsZVdlZWtkYXlzTWluOwogICAgcHJvdG8kMS53ZWVrZGF5c1Nob3J0ICA9ICAgICAgICBsb2NhbGVXZWVrZGF5c1Nob3J0OwogICAgcHJvdG8kMS53ZWVrZGF5c1BhcnNlICA9ICAgICAgICBsb2NhbGVXZWVrZGF5c1BhcnNlOwoKICAgIHByb3RvJDEud2Vla2RheXNSZWdleCAgICAgICA9ICAgICAgICB3ZWVrZGF5c1JlZ2V4OwogICAgcHJvdG8kMS53ZWVrZGF5c1Nob3J0UmVnZXggID0gICAgICAgIHdlZWtkYXlzU2hvcnRSZWdleDsKICAgIHByb3RvJDEud2Vla2RheXNNaW5SZWdleCAgICA9ICAgICAgICB3ZWVrZGF5c01pblJlZ2V4OwoKICAgIHByb3RvJDEuaXNQTSA9IGxvY2FsZUlzUE07CiAgICBwcm90byQxLm1lcmlkaWVtID0gbG9jYWxlTWVyaWRpZW07CgogICAgZnVuY3Rpb24gZ2V0JDEgKGZvcm1hdCwgaW5kZXgsIGZpZWxkLCBzZXR0ZXIpIHsKICAgICAgICB2YXIgbG9jYWxlID0gZ2V0TG9jYWxlKCk7CiAgICAgICAgdmFyIHV0YyA9IGNyZWF0ZVVUQygpLnNldChzZXR0ZXIsIGluZGV4KTsKICAgICAgICByZXR1cm4gbG9jYWxlW2ZpZWxkXSh1dGMsIGZvcm1hdCk7CiAgICB9CgogICAgZnVuY3Rpb24gbGlzdE1vbnRoc0ltcGwgKGZvcm1hdCwgaW5kZXgsIGZpZWxkKSB7CiAgICAgICAgaWYgKGlzTnVtYmVyKGZvcm1hdCkpIHsKICAgICAgICAgICAgaW5kZXggPSBmb3JtYXQ7CiAgICAgICAgICAgIGZvcm1hdCA9IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnJzsKCiAgICAgICAgaWYgKGluZGV4ICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGdldCQxKGZvcm1hdCwgaW5kZXgsIGZpZWxkLCAnbW9udGgnKTsKICAgICAgICB9CgogICAgICAgIHZhciBpOwogICAgICAgIHZhciBvdXQgPSBbXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICAgICAgICBvdXRbaV0gPSBnZXQkMShmb3JtYXQsIGksIGZpZWxkLCAnbW9udGgnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dDsKICAgIH0KCiAgICAvLyAoKQogICAgLy8gKDUpCiAgICAvLyAoZm10LCA1KQogICAgLy8gKGZtdCkKICAgIC8vICh0cnVlKQogICAgLy8gKHRydWUsIDUpCiAgICAvLyAodHJ1ZSwgZm10LCA1KQogICAgLy8gKHRydWUsIGZtdCkKICAgIGZ1bmN0aW9uIGxpc3RXZWVrZGF5c0ltcGwgKGxvY2FsZVNvcnRlZCwgZm9ybWF0LCBpbmRleCwgZmllbGQpIHsKICAgICAgICBpZiAodHlwZW9mIGxvY2FsZVNvcnRlZCA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgIGlmIChpc051bWJlcihmb3JtYXQpKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IGZvcm1hdDsKICAgICAgICAgICAgICAgIGZvcm1hdCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9ybWF0ID0gZm9ybWF0IHx8ICcnOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvcm1hdCA9IGxvY2FsZVNvcnRlZDsKICAgICAgICAgICAgaW5kZXggPSBmb3JtYXQ7CiAgICAgICAgICAgIGxvY2FsZVNvcnRlZCA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKGlzTnVtYmVyKGZvcm1hdCkpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gZm9ybWF0OwogICAgICAgICAgICAgICAgZm9ybWF0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQgfHwgJyc7CiAgICAgICAgfQoKICAgICAgICB2YXIgbG9jYWxlID0gZ2V0TG9jYWxlKCksCiAgICAgICAgICAgIHNoaWZ0ID0gbG9jYWxlU29ydGVkID8gbG9jYWxlLl93ZWVrLmRvdyA6IDA7CgogICAgICAgIGlmIChpbmRleCAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBnZXQkMShmb3JtYXQsIChpbmRleCArIHNoaWZ0KSAlIDcsIGZpZWxkLCAnZGF5Jyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgaTsKICAgICAgICB2YXIgb3V0ID0gW107CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDc7IGkrKykgewogICAgICAgICAgICBvdXRbaV0gPSBnZXQkMShmb3JtYXQsIChpICsgc2hpZnQpICUgNywgZmllbGQsICdkYXknKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dDsKICAgIH0KCiAgICBmdW5jdGlvbiBsaXN0TW9udGhzIChmb3JtYXQsIGluZGV4KSB7CiAgICAgICAgcmV0dXJuIGxpc3RNb250aHNJbXBsKGZvcm1hdCwgaW5kZXgsICdtb250aHMnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBsaXN0TW9udGhzU2hvcnQgKGZvcm1hdCwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gbGlzdE1vbnRoc0ltcGwoZm9ybWF0LCBpbmRleCwgJ21vbnRoc1Nob3J0Jyk7CiAgICB9CgogICAgZnVuY3Rpb24gbGlzdFdlZWtkYXlzIChsb2NhbGVTb3J0ZWQsIGZvcm1hdCwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gbGlzdFdlZWtkYXlzSW1wbChsb2NhbGVTb3J0ZWQsIGZvcm1hdCwgaW5kZXgsICd3ZWVrZGF5cycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGxpc3RXZWVrZGF5c1Nob3J0IChsb2NhbGVTb3J0ZWQsIGZvcm1hdCwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gbGlzdFdlZWtkYXlzSW1wbChsb2NhbGVTb3J0ZWQsIGZvcm1hdCwgaW5kZXgsICd3ZWVrZGF5c1Nob3J0Jyk7CiAgICB9CgogICAgZnVuY3Rpb24gbGlzdFdlZWtkYXlzTWluIChsb2NhbGVTb3J0ZWQsIGZvcm1hdCwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gbGlzdFdlZWtkYXlzSW1wbChsb2NhbGVTb3J0ZWQsIGZvcm1hdCwgaW5kZXgsICd3ZWVrZGF5c01pbicpOwogICAgfQoKICAgIGdldFNldEdsb2JhbExvY2FsZSgnZW4nLCB7CiAgICAgICAgZGF5T2ZNb250aE9yZGluYWxQYXJzZTogL1xkezEsMn0odGh8c3R8bmR8cmQpLywKICAgICAgICBvcmRpbmFsIDogZnVuY3Rpb24gKG51bWJlcikgewogICAgICAgICAgICB2YXIgYiA9IG51bWJlciAlIDEwLAogICAgICAgICAgICAgICAgb3V0cHV0ID0gKHRvSW50KG51bWJlciAlIDEwMCAvIDEwKSA9PT0gMSkgPyAndGgnIDoKICAgICAgICAgICAgICAgIChiID09PSAxKSA/ICdzdCcgOgogICAgICAgICAgICAgICAgKGIgPT09IDIpID8gJ25kJyA6CiAgICAgICAgICAgICAgICAoYiA9PT0gMykgPyAncmQnIDogJ3RoJzsKICAgICAgICAgICAgcmV0dXJuIG51bWJlciArIG91dHB1dDsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBTaWRlIGVmZmVjdCBpbXBvcnRzCgogICAgaG9va3MubGFuZyA9IGRlcHJlY2F0ZSgnbW9tZW50LmxhbmcgaXMgZGVwcmVjYXRlZC4gVXNlIG1vbWVudC5sb2NhbGUgaW5zdGVhZC4nLCBnZXRTZXRHbG9iYWxMb2NhbGUpOwogICAgaG9va3MubGFuZ0RhdGEgPSBkZXByZWNhdGUoJ21vbWVudC5sYW5nRGF0YSBpcyBkZXByZWNhdGVkLiBVc2UgbW9tZW50LmxvY2FsZURhdGEgaW5zdGVhZC4nLCBnZXRMb2NhbGUpOwoKICAgIHZhciBtYXRoQWJzID0gTWF0aC5hYnM7CgogICAgZnVuY3Rpb24gYWJzICgpIHsKICAgICAgICB2YXIgZGF0YSAgICAgICAgICAgPSB0aGlzLl9kYXRhOwoKICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgPSBtYXRoQWJzKHRoaXMuX21pbGxpc2Vjb25kcyk7CiAgICAgICAgdGhpcy5fZGF5cyAgICAgICAgID0gbWF0aEFicyh0aGlzLl9kYXlzKTsKICAgICAgICB0aGlzLl9tb250aHMgICAgICAgPSBtYXRoQWJzKHRoaXMuX21vbnRocyk7CgogICAgICAgIGRhdGEubWlsbGlzZWNvbmRzICA9IG1hdGhBYnMoZGF0YS5taWxsaXNlY29uZHMpOwogICAgICAgIGRhdGEuc2Vjb25kcyAgICAgICA9IG1hdGhBYnMoZGF0YS5zZWNvbmRzKTsKICAgICAgICBkYXRhLm1pbnV0ZXMgICAgICAgPSBtYXRoQWJzKGRhdGEubWludXRlcyk7CiAgICAgICAgZGF0YS5ob3VycyAgICAgICAgID0gbWF0aEFicyhkYXRhLmhvdXJzKTsKICAgICAgICBkYXRhLm1vbnRocyAgICAgICAgPSBtYXRoQWJzKGRhdGEubW9udGhzKTsKICAgICAgICBkYXRhLnllYXJzICAgICAgICAgPSBtYXRoQWJzKGRhdGEueWVhcnMpOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRTdWJ0cmFjdCQxIChkdXJhdGlvbiwgaW5wdXQsIHZhbHVlLCBkaXJlY3Rpb24pIHsKICAgICAgICB2YXIgb3RoZXIgPSBjcmVhdGVEdXJhdGlvbihpbnB1dCwgdmFsdWUpOwoKICAgICAgICBkdXJhdGlvbi5fbWlsbGlzZWNvbmRzICs9IGRpcmVjdGlvbiAqIG90aGVyLl9taWxsaXNlY29uZHM7CiAgICAgICAgZHVyYXRpb24uX2RheXMgICAgICAgICArPSBkaXJlY3Rpb24gKiBvdGhlci5fZGF5czsKICAgICAgICBkdXJhdGlvbi5fbW9udGhzICAgICAgICs9IGRpcmVjdGlvbiAqIG90aGVyLl9tb250aHM7CgogICAgICAgIHJldHVybiBkdXJhdGlvbi5fYnViYmxlKCk7CiAgICB9CgogICAgLy8gc3VwcG9ydHMgb25seSAyLjAtc3R5bGUgYWRkKDEsICdzJykgb3IgYWRkKGR1cmF0aW9uKQogICAgZnVuY3Rpb24gYWRkJDEgKGlucHV0LCB2YWx1ZSkgewogICAgICAgIHJldHVybiBhZGRTdWJ0cmFjdCQxKHRoaXMsIGlucHV0LCB2YWx1ZSwgMSk7CiAgICB9CgogICAgLy8gc3VwcG9ydHMgb25seSAyLjAtc3R5bGUgc3VidHJhY3QoMSwgJ3MnKSBvciBzdWJ0cmFjdChkdXJhdGlvbikKICAgIGZ1bmN0aW9uIHN1YnRyYWN0JDEgKGlucHV0LCB2YWx1ZSkgewogICAgICAgIHJldHVybiBhZGRTdWJ0cmFjdCQxKHRoaXMsIGlucHV0LCB2YWx1ZSwgLTEpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFic0NlaWwgKG51bWJlcikgewogICAgICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKG51bWJlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguY2VpbChudW1iZXIpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBidWJibGUgKCkgewogICAgICAgIHZhciBtaWxsaXNlY29uZHMgPSB0aGlzLl9taWxsaXNlY29uZHM7CiAgICAgICAgdmFyIGRheXMgICAgICAgICA9IHRoaXMuX2RheXM7CiAgICAgICAgdmFyIG1vbnRocyAgICAgICA9IHRoaXMuX21vbnRoczsKICAgICAgICB2YXIgZGF0YSAgICAgICAgID0gdGhpcy5fZGF0YTsKICAgICAgICB2YXIgc2Vjb25kcywgbWludXRlcywgaG91cnMsIHllYXJzLCBtb250aHNGcm9tRGF5czsKCiAgICAgICAgLy8gaWYgd2UgaGF2ZSBhIG1peCBvZiBwb3NpdGl2ZSBhbmQgbmVnYXRpdmUgdmFsdWVzLCBidWJibGUgZG93biBmaXJzdAogICAgICAgIC8vIGNoZWNrOiBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMjE2NgogICAgICAgIGlmICghKChtaWxsaXNlY29uZHMgPj0gMCAmJiBkYXlzID49IDAgJiYgbW9udGhzID49IDApIHx8CiAgICAgICAgICAgICAgICAobWlsbGlzZWNvbmRzIDw9IDAgJiYgZGF5cyA8PSAwICYmIG1vbnRocyA8PSAwKSkpIHsKICAgICAgICAgICAgbWlsbGlzZWNvbmRzICs9IGFic0NlaWwobW9udGhzVG9EYXlzKG1vbnRocykgKyBkYXlzKSAqIDg2NGU1OwogICAgICAgICAgICBkYXlzID0gMDsKICAgICAgICAgICAgbW9udGhzID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgY29kZSBidWJibGVzIHVwIHZhbHVlcywgc2VlIHRoZSB0ZXN0cyBmb3IKICAgICAgICAvLyBleGFtcGxlcyBvZiB3aGF0IHRoYXQgbWVhbnMuCiAgICAgICAgZGF0YS5taWxsaXNlY29uZHMgPSBtaWxsaXNlY29uZHMgJSAxMDAwOwoKICAgICAgICBzZWNvbmRzICAgICAgICAgICA9IGFic0Zsb29yKG1pbGxpc2Vjb25kcyAvIDEwMDApOwogICAgICAgIGRhdGEuc2Vjb25kcyAgICAgID0gc2Vjb25kcyAlIDYwOwoKICAgICAgICBtaW51dGVzICAgICAgICAgICA9IGFic0Zsb29yKHNlY29uZHMgLyA2MCk7CiAgICAgICAgZGF0YS5taW51dGVzICAgICAgPSBtaW51dGVzICUgNjA7CgogICAgICAgIGhvdXJzICAgICAgICAgICAgID0gYWJzRmxvb3IobWludXRlcyAvIDYwKTsKICAgICAgICBkYXRhLmhvdXJzICAgICAgICA9IGhvdXJzICUgMjQ7CgogICAgICAgIGRheXMgKz0gYWJzRmxvb3IoaG91cnMgLyAyNCk7CgogICAgICAgIC8vIGNvbnZlcnQgZGF5cyB0byBtb250aHMKICAgICAgICBtb250aHNGcm9tRGF5cyA9IGFic0Zsb29yKGRheXNUb01vbnRocyhkYXlzKSk7CiAgICAgICAgbW9udGhzICs9IG1vbnRoc0Zyb21EYXlzOwogICAgICAgIGRheXMgLT0gYWJzQ2VpbChtb250aHNUb0RheXMobW9udGhzRnJvbURheXMpKTsKCiAgICAgICAgLy8gMTIgbW9udGhzIC0+IDEgeWVhcgogICAgICAgIHllYXJzID0gYWJzRmxvb3IobW9udGhzIC8gMTIpOwogICAgICAgIG1vbnRocyAlPSAxMjsKCiAgICAgICAgZGF0YS5kYXlzICAgPSBkYXlzOwogICAgICAgIGRhdGEubW9udGhzID0gbW9udGhzOwogICAgICAgIGRhdGEueWVhcnMgID0geWVhcnM7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGZ1bmN0aW9uIGRheXNUb01vbnRocyAoZGF5cykgewogICAgICAgIC8vIDQwMCB5ZWFycyBoYXZlIDE0NjA5NyBkYXlzICh0YWtpbmcgaW50byBhY2NvdW50IGxlYXAgeWVhciBydWxlcykKICAgICAgICAvLyA0MDAgeWVhcnMgaGF2ZSAxMiBtb250aHMgPT09IDQ4MDAKICAgICAgICByZXR1cm4gZGF5cyAqIDQ4MDAgLyAxNDYwOTc7CiAgICB9CgogICAgZnVuY3Rpb24gbW9udGhzVG9EYXlzIChtb250aHMpIHsKICAgICAgICAvLyB0aGUgcmV2ZXJzZSBvZiBkYXlzVG9Nb250aHMKICAgICAgICByZXR1cm4gbW9udGhzICogMTQ2MDk3IC8gNDgwMDsKICAgIH0KCiAgICBmdW5jdGlvbiBhcyAodW5pdHMpIHsKICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBOYU47CiAgICAgICAgfQogICAgICAgIHZhciBkYXlzOwogICAgICAgIHZhciBtb250aHM7CiAgICAgICAgdmFyIG1pbGxpc2Vjb25kcyA9IHRoaXMuX21pbGxpc2Vjb25kczsKCiAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CgogICAgICAgIGlmICh1bml0cyA9PT0gJ21vbnRoJyB8fCB1bml0cyA9PT0gJ3F1YXJ0ZXInIHx8IHVuaXRzID09PSAneWVhcicpIHsKICAgICAgICAgICAgZGF5cyA9IHRoaXMuX2RheXMgKyBtaWxsaXNlY29uZHMgLyA4NjRlNTsKICAgICAgICAgICAgbW9udGhzID0gdGhpcy5fbW9udGhzICsgZGF5c1RvTW9udGhzKGRheXMpOwogICAgICAgICAgICBzd2l0Y2ggKHVuaXRzKSB7CiAgICAgICAgICAgICAgICBjYXNlICdtb250aCc6ICAgcmV0dXJuIG1vbnRoczsKICAgICAgICAgICAgICAgIGNhc2UgJ3F1YXJ0ZXInOiByZXR1cm4gbW9udGhzIC8gMzsKICAgICAgICAgICAgICAgIGNhc2UgJ3llYXInOiAgICByZXR1cm4gbW9udGhzIC8gMTI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBoYW5kbGUgbWlsbGlzZWNvbmRzIHNlcGFyYXRlbHkgYmVjYXVzZSBvZiBmbG9hdGluZyBwb2ludCBtYXRoIGVycm9ycyAoaXNzdWUgIzE4NjcpCiAgICAgICAgICAgIGRheXMgPSB0aGlzLl9kYXlzICsgTWF0aC5yb3VuZChtb250aHNUb0RheXModGhpcy5fbW9udGhzKSk7CiAgICAgICAgICAgIHN3aXRjaCAodW5pdHMpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ3dlZWsnICAgOiByZXR1cm4gZGF5cyAvIDcgICAgICsgbWlsbGlzZWNvbmRzIC8gNjA0OGU1OwogICAgICAgICAgICAgICAgY2FzZSAnZGF5JyAgICA6IHJldHVybiBkYXlzICAgICAgICAgKyBtaWxsaXNlY29uZHMgLyA4NjRlNTsKICAgICAgICAgICAgICAgIGNhc2UgJ2hvdXInICAgOiByZXR1cm4gZGF5cyAqIDI0ICAgICsgbWlsbGlzZWNvbmRzIC8gMzZlNTsKICAgICAgICAgICAgICAgIGNhc2UgJ21pbnV0ZScgOiByZXR1cm4gZGF5cyAqIDE0NDAgICsgbWlsbGlzZWNvbmRzIC8gNmU0OwogICAgICAgICAgICAgICAgY2FzZSAnc2Vjb25kJyA6IHJldHVybiBkYXlzICogODY0MDAgKyBtaWxsaXNlY29uZHMgLyAxMDAwOwogICAgICAgICAgICAgICAgLy8gTWF0aC5mbG9vciBwcmV2ZW50cyBmbG9hdGluZyBwb2ludCBtYXRoIGVycm9ycyBoZXJlCiAgICAgICAgICAgICAgICBjYXNlICdtaWxsaXNlY29uZCc6IHJldHVybiBNYXRoLmZsb29yKGRheXMgKiA4NjRlNSkgKyBtaWxsaXNlY29uZHM7CiAgICAgICAgICAgICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdW5pdCAnICsgdW5pdHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFRPRE86IFVzZSB0aGlzLmFzKCdtcycpPwogICAgZnVuY3Rpb24gdmFsdWVPZiQxICgpIHsKICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBOYU47CiAgICAgICAgfQogICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIHRoaXMuX21pbGxpc2Vjb25kcyArCiAgICAgICAgICAgIHRoaXMuX2RheXMgKiA4NjRlNSArCiAgICAgICAgICAgICh0aGlzLl9tb250aHMgJSAxMikgKiAyNTkyZTYgKwogICAgICAgICAgICB0b0ludCh0aGlzLl9tb250aHMgLyAxMikgKiAzMTUzNmU2CiAgICAgICAgKTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlQXMgKGFsaWFzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXMoYWxpYXMpOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIGFzTWlsbGlzZWNvbmRzID0gbWFrZUFzKCdtcycpOwogICAgdmFyIGFzU2Vjb25kcyAgICAgID0gbWFrZUFzKCdzJyk7CiAgICB2YXIgYXNNaW51dGVzICAgICAgPSBtYWtlQXMoJ20nKTsKICAgIHZhciBhc0hvdXJzICAgICAgICA9IG1ha2VBcygnaCcpOwogICAgdmFyIGFzRGF5cyAgICAgICAgID0gbWFrZUFzKCdkJyk7CiAgICB2YXIgYXNXZWVrcyAgICAgICAgPSBtYWtlQXMoJ3cnKTsKICAgIHZhciBhc01vbnRocyAgICAgICA9IG1ha2VBcygnTScpOwogICAgdmFyIGFzUXVhcnRlcnMgICAgID0gbWFrZUFzKCdRJyk7CiAgICB2YXIgYXNZZWFycyAgICAgICAgPSBtYWtlQXMoJ3knKTsKCiAgICBmdW5jdGlvbiBjbG9uZSQxICgpIHsKICAgICAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24odGhpcyk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0JDIgKHVuaXRzKSB7CiAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICAgICAgcmV0dXJuIHRoaXMuaXNWYWxpZCgpID8gdGhpc1t1bml0cyArICdzJ10oKSA6IE5hTjsKICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlR2V0dGVyKG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5pc1ZhbGlkKCkgPyB0aGlzLl9kYXRhW25hbWVdIDogTmFOOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIG1pbGxpc2Vjb25kcyA9IG1ha2VHZXR0ZXIoJ21pbGxpc2Vjb25kcycpOwogICAgdmFyIHNlY29uZHMgICAgICA9IG1ha2VHZXR0ZXIoJ3NlY29uZHMnKTsKICAgIHZhciBtaW51dGVzICAgICAgPSBtYWtlR2V0dGVyKCdtaW51dGVzJyk7CiAgICB2YXIgaG91cnMgICAgICAgID0gbWFrZUdldHRlcignaG91cnMnKTsKICAgIHZhciBkYXlzICAgICAgICAgPSBtYWtlR2V0dGVyKCdkYXlzJyk7CiAgICB2YXIgbW9udGhzICAgICAgID0gbWFrZUdldHRlcignbW9udGhzJyk7CiAgICB2YXIgeWVhcnMgICAgICAgID0gbWFrZUdldHRlcigneWVhcnMnKTsKCiAgICBmdW5jdGlvbiB3ZWVrcyAoKSB7CiAgICAgICAgcmV0dXJuIGFic0Zsb29yKHRoaXMuZGF5cygpIC8gNyk7CiAgICB9CgogICAgdmFyIHJvdW5kID0gTWF0aC5yb3VuZDsKICAgIHZhciB0aHJlc2hvbGRzID0gewogICAgICAgIHNzOiA0NCwgICAgICAgICAvLyBhIGZldyBzZWNvbmRzIHRvIHNlY29uZHMKICAgICAgICBzIDogNDUsICAgICAgICAgLy8gc2Vjb25kcyB0byBtaW51dGUKICAgICAgICBtIDogNDUsICAgICAgICAgLy8gbWludXRlcyB0byBob3VyCiAgICAgICAgaCA6IDIyLCAgICAgICAgIC8vIGhvdXJzIHRvIGRheQogICAgICAgIGQgOiAyNiwgICAgICAgICAvLyBkYXlzIHRvIG1vbnRoCiAgICAgICAgTSA6IDExICAgICAgICAgIC8vIG1vbnRocyB0byB5ZWFyCiAgICB9OwoKICAgIC8vIGhlbHBlciBmdW5jdGlvbiBmb3IgbW9tZW50LmZuLmZyb20sIG1vbWVudC5mbi5mcm9tTm93LCBhbmQgbW9tZW50LmR1cmF0aW9uLmZuLmh1bWFuaXplCiAgICBmdW5jdGlvbiBzdWJzdGl0dXRlVGltZUFnbyhzdHJpbmcsIG51bWJlciwgd2l0aG91dFN1ZmZpeCwgaXNGdXR1cmUsIGxvY2FsZSkgewogICAgICAgIHJldHVybiBsb2NhbGUucmVsYXRpdmVUaW1lKG51bWJlciB8fCAxLCAhIXdpdGhvdXRTdWZmaXgsIHN0cmluZywgaXNGdXR1cmUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlbGF0aXZlVGltZSQxIChwb3NOZWdEdXJhdGlvbiwgd2l0aG91dFN1ZmZpeCwgbG9jYWxlKSB7CiAgICAgICAgdmFyIGR1cmF0aW9uID0gY3JlYXRlRHVyYXRpb24ocG9zTmVnRHVyYXRpb24pLmFicygpOwogICAgICAgIHZhciBzZWNvbmRzICA9IHJvdW5kKGR1cmF0aW9uLmFzKCdzJykpOwogICAgICAgIHZhciBtaW51dGVzICA9IHJvdW5kKGR1cmF0aW9uLmFzKCdtJykpOwogICAgICAgIHZhciBob3VycyAgICA9IHJvdW5kKGR1cmF0aW9uLmFzKCdoJykpOwogICAgICAgIHZhciBkYXlzICAgICA9IHJvdW5kKGR1cmF0aW9uLmFzKCdkJykpOwogICAgICAgIHZhciBtb250aHMgICA9IHJvdW5kKGR1cmF0aW9uLmFzKCdNJykpOwogICAgICAgIHZhciB5ZWFycyAgICA9IHJvdW5kKGR1cmF0aW9uLmFzKCd5JykpOwoKICAgICAgICB2YXIgYSA9IHNlY29uZHMgPD0gdGhyZXNob2xkcy5zcyAmJiBbJ3MnLCBzZWNvbmRzXSAgfHwKICAgICAgICAgICAgICAgIHNlY29uZHMgPCB0aHJlc2hvbGRzLnMgICAmJiBbJ3NzJywgc2Vjb25kc10gfHwKICAgICAgICAgICAgICAgIG1pbnV0ZXMgPD0gMSAgICAgICAgICAgICAmJiBbJ20nXSAgICAgICAgICAgfHwKICAgICAgICAgICAgICAgIG1pbnV0ZXMgPCB0aHJlc2hvbGRzLm0gICAmJiBbJ21tJywgbWludXRlc10gfHwKICAgICAgICAgICAgICAgIGhvdXJzICAgPD0gMSAgICAgICAgICAgICAmJiBbJ2gnXSAgICAgICAgICAgfHwKICAgICAgICAgICAgICAgIGhvdXJzICAgPCB0aHJlc2hvbGRzLmggICAmJiBbJ2hoJywgaG91cnNdICAgfHwKICAgICAgICAgICAgICAgIGRheXMgICAgPD0gMSAgICAgICAgICAgICAmJiBbJ2QnXSAgICAgICAgICAgfHwKICAgICAgICAgICAgICAgIGRheXMgICAgPCB0aHJlc2hvbGRzLmQgICAmJiBbJ2RkJywgZGF5c10gICAgfHwKICAgICAgICAgICAgICAgIG1vbnRocyAgPD0gMSAgICAgICAgICAgICAmJiBbJ00nXSAgICAgICAgICAgfHwKICAgICAgICAgICAgICAgIG1vbnRocyAgPCB0aHJlc2hvbGRzLk0gICAmJiBbJ01NJywgbW9udGhzXSAgfHwKICAgICAgICAgICAgICAgIHllYXJzICAgPD0gMSAgICAgICAgICAgICAmJiBbJ3knXSAgICAgICAgICAgfHwgWyd5eScsIHllYXJzXTsKCiAgICAgICAgYVsyXSA9IHdpdGhvdXRTdWZmaXg7CiAgICAgICAgYVszXSA9ICtwb3NOZWdEdXJhdGlvbiA+IDA7CiAgICAgICAgYVs0XSA9IGxvY2FsZTsKICAgICAgICByZXR1cm4gc3Vic3RpdHV0ZVRpbWVBZ28uYXBwbHkobnVsbCwgYSk7CiAgICB9CgogICAgLy8gVGhpcyBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIHNldCB0aGUgcm91bmRpbmcgZnVuY3Rpb24gZm9yIHJlbGF0aXZlIHRpbWUgc3RyaW5ncwogICAgZnVuY3Rpb24gZ2V0U2V0UmVsYXRpdmVUaW1lUm91bmRpbmcgKHJvdW5kaW5nRnVuY3Rpb24pIHsKICAgICAgICBpZiAocm91bmRpbmdGdW5jdGlvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiByb3VuZDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZihyb3VuZGluZ0Z1bmN0aW9uKSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICByb3VuZCA9IHJvdW5kaW5nRnVuY3Rpb247CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gVGhpcyBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIHNldCBhIHRocmVzaG9sZCBmb3IgcmVsYXRpdmUgdGltZSBzdHJpbmdzCiAgICBmdW5jdGlvbiBnZXRTZXRSZWxhdGl2ZVRpbWVUaHJlc2hvbGQgKHRocmVzaG9sZCwgbGltaXQpIHsKICAgICAgICBpZiAodGhyZXNob2xkc1t0aHJlc2hvbGRdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAobGltaXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gdGhyZXNob2xkc1t0aHJlc2hvbGRdOwogICAgICAgIH0KICAgICAgICB0aHJlc2hvbGRzW3RocmVzaG9sZF0gPSBsaW1pdDsKICAgICAgICBpZiAodGhyZXNob2xkID09PSAncycpIHsKICAgICAgICAgICAgdGhyZXNob2xkcy5zcyA9IGxpbWl0IC0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gaHVtYW5pemUgKHdpdGhTdWZmaXgpIHsKICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5pbnZhbGlkRGF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGxvY2FsZSA9IHRoaXMubG9jYWxlRGF0YSgpOwogICAgICAgIHZhciBvdXRwdXQgPSByZWxhdGl2ZVRpbWUkMSh0aGlzLCAhd2l0aFN1ZmZpeCwgbG9jYWxlKTsKCiAgICAgICAgaWYgKHdpdGhTdWZmaXgpIHsKICAgICAgICAgICAgb3V0cHV0ID0gbG9jYWxlLnBhc3RGdXR1cmUoK3RoaXMsIG91dHB1dCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbG9jYWxlLnBvc3Rmb3JtYXQob3V0cHV0KTsKICAgIH0KCiAgICB2YXIgYWJzJDEgPSBNYXRoLmFiczsKCiAgICBmdW5jdGlvbiBzaWduKHgpIHsKICAgICAgICByZXR1cm4gKCh4ID4gMCkgLSAoeCA8IDApKSB8fCAreDsKICAgIH0KCiAgICBmdW5jdGlvbiB0b0lTT1N0cmluZyQxKCkgewogICAgICAgIC8vIGZvciBJU08gc3RyaW5ncyB3ZSBkbyBub3QgdXNlIHRoZSBub3JtYWwgYnViYmxpbmcgcnVsZXM6CiAgICAgICAgLy8gICogbWlsbGlzZWNvbmRzIGJ1YmJsZSB1cCB1bnRpbCB0aGV5IGJlY29tZSBob3VycwogICAgICAgIC8vICAqIGRheXMgZG8gbm90IGJ1YmJsZSBhdCBhbGwKICAgICAgICAvLyAgKiBtb250aHMgYnViYmxlIHVwIHVudGlsIHRoZXkgYmVjb21lIHllYXJzCiAgICAgICAgLy8gVGhpcyBpcyBiZWNhdXNlIHRoZXJlIGlzIG5vIGNvbnRleHQtZnJlZSBjb252ZXJzaW9uIGJldHdlZW4gaG91cnMgYW5kIGRheXMKICAgICAgICAvLyAodGhpbmsgb2YgY2xvY2sgY2hhbmdlcykKICAgICAgICAvLyBhbmQgYWxzbyBub3QgYmV0d2VlbiBkYXlzIGFuZCBtb250aHMgKDI4LTMxIGRheXMgcGVyIG1vbnRoKQogICAgICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc2Vjb25kcyA9IGFicyQxKHRoaXMuX21pbGxpc2Vjb25kcykgLyAxMDAwOwogICAgICAgIHZhciBkYXlzICAgICAgICAgPSBhYnMkMSh0aGlzLl9kYXlzKTsKICAgICAgICB2YXIgbW9udGhzICAgICAgID0gYWJzJDEodGhpcy5fbW9udGhzKTsKICAgICAgICB2YXIgbWludXRlcywgaG91cnMsIHllYXJzOwoKICAgICAgICAvLyAzNjAwIHNlY29uZHMgLT4gNjAgbWludXRlcyAtPiAxIGhvdXIKICAgICAgICBtaW51dGVzICAgICAgICAgICA9IGFic0Zsb29yKHNlY29uZHMgLyA2MCk7CiAgICAgICAgaG91cnMgICAgICAgICAgICAgPSBhYnNGbG9vcihtaW51dGVzIC8gNjApOwogICAgICAgIHNlY29uZHMgJT0gNjA7CiAgICAgICAgbWludXRlcyAlPSA2MDsKCiAgICAgICAgLy8gMTIgbW9udGhzIC0+IDEgeWVhcgogICAgICAgIHllYXJzICA9IGFic0Zsb29yKG1vbnRocyAvIDEyKTsKICAgICAgICBtb250aHMgJT0gMTI7CgoKICAgICAgICAvLyBpbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vZG9yZGlsbGUvbW9tZW50LWlzb2R1cmF0aW9uL2Jsb2IvbWFzdGVyL21vbWVudC5pc29kdXJhdGlvbi5qcwogICAgICAgIHZhciBZID0geWVhcnM7CiAgICAgICAgdmFyIE0gPSBtb250aHM7CiAgICAgICAgdmFyIEQgPSBkYXlzOwogICAgICAgIHZhciBoID0gaG91cnM7CiAgICAgICAgdmFyIG0gPSBtaW51dGVzOwogICAgICAgIHZhciBzID0gc2Vjb25kcyA/IHNlY29uZHMudG9GaXhlZCgzKS5yZXBsYWNlKC9cLj8wKyQvLCAnJykgOiAnJzsKICAgICAgICB2YXIgdG90YWwgPSB0aGlzLmFzU2Vjb25kcygpOwoKICAgICAgICBpZiAoIXRvdGFsKSB7CiAgICAgICAgICAgIC8vIHRoaXMgaXMgdGhlIHNhbWUgYXMgQyMncyAoTm9kYSkgYW5kIHB5dGhvbiAoaXNvZGF0ZSkuLi4KICAgICAgICAgICAgLy8gYnV0IG5vdCBvdGhlciBKUyAoZ29vZy5kYXRlKQogICAgICAgICAgICByZXR1cm4gJ1AwRCc7CiAgICAgICAgfQoKICAgICAgICB2YXIgdG90YWxTaWduID0gdG90YWwgPCAwID8gJy0nIDogJyc7CiAgICAgICAgdmFyIHltU2lnbiA9IHNpZ24odGhpcy5fbW9udGhzKSAhPT0gc2lnbih0b3RhbCkgPyAnLScgOiAnJzsKICAgICAgICB2YXIgZGF5c1NpZ24gPSBzaWduKHRoaXMuX2RheXMpICE9PSBzaWduKHRvdGFsKSA/ICctJyA6ICcnOwogICAgICAgIHZhciBobXNTaWduID0gc2lnbih0aGlzLl9taWxsaXNlY29uZHMpICE9PSBzaWduKHRvdGFsKSA/ICctJyA6ICcnOwoKICAgICAgICByZXR1cm4gdG90YWxTaWduICsgJ1AnICsKICAgICAgICAgICAgKFkgPyB5bVNpZ24gKyBZICsgJ1knIDogJycpICsKICAgICAgICAgICAgKE0gPyB5bVNpZ24gKyBNICsgJ00nIDogJycpICsKICAgICAgICAgICAgKEQgPyBkYXlzU2lnbiArIEQgKyAnRCcgOiAnJykgKwogICAgICAgICAgICAoKGggfHwgbSB8fCBzKSA/ICdUJyA6ICcnKSArCiAgICAgICAgICAgIChoID8gaG1zU2lnbiArIGggKyAnSCcgOiAnJykgKwogICAgICAgICAgICAobSA/IGhtc1NpZ24gKyBtICsgJ00nIDogJycpICsKICAgICAgICAgICAgKHMgPyBobXNTaWduICsgcyArICdTJyA6ICcnKTsKICAgIH0KCiAgICB2YXIgcHJvdG8kMiA9IER1cmF0aW9uLnByb3RvdHlwZTsKCiAgICBwcm90byQyLmlzVmFsaWQgICAgICAgID0gaXNWYWxpZCQxOwogICAgcHJvdG8kMi5hYnMgICAgICAgICAgICA9IGFiczsKICAgIHByb3RvJDIuYWRkICAgICAgICAgICAgPSBhZGQkMTsKICAgIHByb3RvJDIuc3VidHJhY3QgICAgICAgPSBzdWJ0cmFjdCQxOwogICAgcHJvdG8kMi5hcyAgICAgICAgICAgICA9IGFzOwogICAgcHJvdG8kMi5hc01pbGxpc2Vjb25kcyA9IGFzTWlsbGlzZWNvbmRzOwogICAgcHJvdG8kMi5hc1NlY29uZHMgICAgICA9IGFzU2Vjb25kczsKICAgIHByb3RvJDIuYXNNaW51dGVzICAgICAgPSBhc01pbnV0ZXM7CiAgICBwcm90byQyLmFzSG91cnMgICAgICAgID0gYXNIb3VyczsKICAgIHByb3RvJDIuYXNEYXlzICAgICAgICAgPSBhc0RheXM7CiAgICBwcm90byQyLmFzV2Vla3MgICAgICAgID0gYXNXZWVrczsKICAgIHByb3RvJDIuYXNNb250aHMgICAgICAgPSBhc01vbnRoczsKICAgIHByb3RvJDIuYXNRdWFydGVycyAgICAgPSBhc1F1YXJ0ZXJzOwogICAgcHJvdG8kMi5hc1llYXJzICAgICAgICA9IGFzWWVhcnM7CiAgICBwcm90byQyLnZhbHVlT2YgICAgICAgID0gdmFsdWVPZiQxOwogICAgcHJvdG8kMi5fYnViYmxlICAgICAgICA9IGJ1YmJsZTsKICAgIHByb3RvJDIuY2xvbmUgICAgICAgICAgPSBjbG9uZSQxOwogICAgcHJvdG8kMi5nZXQgICAgICAgICAgICA9IGdldCQyOwogICAgcHJvdG8kMi5taWxsaXNlY29uZHMgICA9IG1pbGxpc2Vjb25kczsKICAgIHByb3RvJDIuc2Vjb25kcyAgICAgICAgPSBzZWNvbmRzOwogICAgcHJvdG8kMi5taW51dGVzICAgICAgICA9IG1pbnV0ZXM7CiAgICBwcm90byQyLmhvdXJzICAgICAgICAgID0gaG91cnM7CiAgICBwcm90byQyLmRheXMgICAgICAgICAgID0gZGF5czsKICAgIHByb3RvJDIud2Vla3MgICAgICAgICAgPSB3ZWVrczsKICAgIHByb3RvJDIubW9udGhzICAgICAgICAgPSBtb250aHM7CiAgICBwcm90byQyLnllYXJzICAgICAgICAgID0geWVhcnM7CiAgICBwcm90byQyLmh1bWFuaXplICAgICAgID0gaHVtYW5pemU7CiAgICBwcm90byQyLnRvSVNPU3RyaW5nICAgID0gdG9JU09TdHJpbmckMTsKICAgIHByb3RvJDIudG9TdHJpbmcgICAgICAgPSB0b0lTT1N0cmluZyQxOwogICAgcHJvdG8kMi50b0pTT04gICAgICAgICA9IHRvSVNPU3RyaW5nJDE7CiAgICBwcm90byQyLmxvY2FsZSAgICAgICAgID0gbG9jYWxlOwogICAgcHJvdG8kMi5sb2NhbGVEYXRhICAgICA9IGxvY2FsZURhdGE7CgogICAgcHJvdG8kMi50b0lzb1N0cmluZyA9IGRlcHJlY2F0ZSgndG9Jc29TdHJpbmcoKSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIHRvSVNPU3RyaW5nKCkgaW5zdGVhZCAobm90aWNlIHRoZSBjYXBpdGFscyknLCB0b0lTT1N0cmluZyQxKTsKICAgIHByb3RvJDIubGFuZyA9IGxhbmc7CgogICAgLy8gU2lkZSBlZmZlY3QgaW1wb3J0cwoKICAgIC8vIEZPUk1BVFRJTkcKCiAgICBhZGRGb3JtYXRUb2tlbignWCcsIDAsIDAsICd1bml4Jyk7CiAgICBhZGRGb3JtYXRUb2tlbigneCcsIDAsIDAsICd2YWx1ZU9mJyk7CgogICAgLy8gUEFSU0lORwoKICAgIGFkZFJlZ2V4VG9rZW4oJ3gnLCBtYXRjaFNpZ25lZCk7CiAgICBhZGRSZWdleFRva2VuKCdYJywgbWF0Y2hUaW1lc3RhbXApOwogICAgYWRkUGFyc2VUb2tlbignWCcsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKHBhcnNlRmxvYXQoaW5wdXQsIDEwKSAqIDEwMDApOwogICAgfSk7CiAgICBhZGRQYXJzZVRva2VuKCd4JywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUodG9JbnQoaW5wdXQpKTsKICAgIH0pOwoKICAgIC8vIFNpZGUgZWZmZWN0IGltcG9ydHMKCgogICAgaG9va3MudmVyc2lvbiA9ICcyLjI0LjAnOwoKICAgIHNldEhvb2tDYWxsYmFjayhjcmVhdGVMb2NhbCk7CgogICAgaG9va3MuZm4gICAgICAgICAgICAgICAgICAgID0gcHJvdG87CiAgICBob29rcy5taW4gICAgICAgICAgICAgICAgICAgPSBtaW47CiAgICBob29rcy5tYXggICAgICAgICAgICAgICAgICAgPSBtYXg7CiAgICBob29rcy5ub3cgICAgICAgICAgICAgICAgICAgPSBub3c7CiAgICBob29rcy51dGMgICAgICAgICAgICAgICAgICAgPSBjcmVhdGVVVEM7CiAgICBob29rcy51bml4ICAgICAgICAgICAgICAgICAgPSBjcmVhdGVVbml4OwogICAgaG9va3MubW9udGhzICAgICAgICAgICAgICAgID0gbGlzdE1vbnRoczsKICAgIGhvb2tzLmlzRGF0ZSAgICAgICAgICAgICAgICA9IGlzRGF0ZTsKICAgIGhvb2tzLmxvY2FsZSAgICAgICAgICAgICAgICA9IGdldFNldEdsb2JhbExvY2FsZTsKICAgIGhvb2tzLmludmFsaWQgICAgICAgICAgICAgICA9IGNyZWF0ZUludmFsaWQ7CiAgICBob29rcy5kdXJhdGlvbiAgICAgICAgICAgICAgPSBjcmVhdGVEdXJhdGlvbjsKICAgIGhvb2tzLmlzTW9tZW50ICAgICAgICAgICAgICA9IGlzTW9tZW50OwogICAgaG9va3Mud2Vla2RheXMgICAgICAgICAgICAgID0gbGlzdFdlZWtkYXlzOwogICAgaG9va3MucGFyc2Vab25lICAgICAgICAgICAgID0gY3JlYXRlSW5ab25lOwogICAgaG9va3MubG9jYWxlRGF0YSAgICAgICAgICAgID0gZ2V0TG9jYWxlOwogICAgaG9va3MuaXNEdXJhdGlvbiAgICAgICAgICAgID0gaXNEdXJhdGlvbjsKICAgIGhvb2tzLm1vbnRoc1Nob3J0ICAgICAgICAgICA9IGxpc3RNb250aHNTaG9ydDsKICAgIGhvb2tzLndlZWtkYXlzTWluICAgICAgICAgICA9IGxpc3RXZWVrZGF5c01pbjsKICAgIGhvb2tzLmRlZmluZUxvY2FsZSAgICAgICAgICA9IGRlZmluZUxvY2FsZTsKICAgIGhvb2tzLnVwZGF0ZUxvY2FsZSAgICAgICAgICA9IHVwZGF0ZUxvY2FsZTsKICAgIGhvb2tzLmxvY2FsZXMgICAgICAgICAgICAgICA9IGxpc3RMb2NhbGVzOwogICAgaG9va3Mud2Vla2RheXNTaG9ydCAgICAgICAgID0gbGlzdFdlZWtkYXlzU2hvcnQ7CiAgICBob29rcy5ub3JtYWxpemVVbml0cyAgICAgICAgPSBub3JtYWxpemVVbml0czsKICAgIGhvb2tzLnJlbGF0aXZlVGltZVJvdW5kaW5nICA9IGdldFNldFJlbGF0aXZlVGltZVJvdW5kaW5nOwogICAgaG9va3MucmVsYXRpdmVUaW1lVGhyZXNob2xkID0gZ2V0U2V0UmVsYXRpdmVUaW1lVGhyZXNob2xkOwogICAgaG9va3MuY2FsZW5kYXJGb3JtYXQgICAgICAgID0gZ2V0Q2FsZW5kYXJGb3JtYXQ7CiAgICBob29rcy5wcm90b3R5cGUgICAgICAgICAgICAgPSBwcm90bzsKCiAgICAvLyBjdXJyZW50bHkgSFRNTDUgaW5wdXQgdHlwZSBvbmx5IHN1cHBvcnRzIDI0LWhvdXIgZm9ybWF0cwogICAgaG9va3MuSFRNTDVfRk1UID0gewogICAgICAgIERBVEVUSU1FX0xPQ0FMOiAnWVlZWS1NTS1ERFRISDptbScsICAgICAgICAgICAgIC8vIDxpbnB1dCB0eXBlPSJkYXRldGltZS1sb2NhbCIgLz4KICAgICAgICBEQVRFVElNRV9MT0NBTF9TRUNPTkRTOiAnWVlZWS1NTS1ERFRISDptbTpzcycsICAvLyA8aW5wdXQgdHlwZT0iZGF0ZXRpbWUtbG9jYWwiIHN0ZXA9IjEiIC8+CiAgICAgICAgREFURVRJTUVfTE9DQUxfTVM6ICdZWVlZLU1NLUREVEhIOm1tOnNzLlNTUycsICAgLy8gPGlucHV0IHR5cGU9ImRhdGV0aW1lLWxvY2FsIiBzdGVwPSIwLjAwMSIgLz4KICAgICAgICBEQVRFOiAnWVlZWS1NTS1ERCcsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA8aW5wdXQgdHlwZT0iZGF0ZSIgLz4KICAgICAgICBUSU1FOiAnSEg6bW0nLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA8aW5wdXQgdHlwZT0idGltZSIgLz4KICAgICAgICBUSU1FX1NFQ09ORFM6ICdISDptbTpzcycsICAgICAgICAgICAgICAgICAgICAgICAvLyA8aW5wdXQgdHlwZT0idGltZSIgc3RlcD0iMSIgLz4KICAgICAgICBUSU1FX01TOiAnSEg6bW06c3MuU1NTJywgICAgICAgICAgICAgICAgICAgICAgICAvLyA8aW5wdXQgdHlwZT0idGltZSIgc3RlcD0iMC4wMDEiIC8+CiAgICAgICAgV0VFSzogJ0dHR0ctW1ddV1cnLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gPGlucHV0IHR5cGU9IndlZWsiIC8+CiAgICAgICAgTU9OVEg6ICdZWVlZLU1NJyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gPGlucHV0IHR5cGU9Im1vbnRoIiAvPgogICAgfTsKCiAgICByZXR1cm4gaG9va3M7Cgp9KSkpOwo=',
  /* moment-timezone-0.5.27 */ 'Ly8hIG1vbWVudC10aW1lem9uZS5qcwovLyEgdmVyc2lvbiA6IDAuNS4yNQovLyEgQ29weXJpZ2h0IChjKSBKUyBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKLy8hIGxpY2Vuc2UgOiBNSVQKLy8hIGdpdGh1Yi5jb20vbW9tZW50L21vbWVudC10aW1lem9uZQoKKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CgkidXNlIHN0cmljdCI7CgoJLypnbG9iYWwgZGVmaW5lKi8KCWlmICh0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JyAmJiBtb2R1bGUuZXhwb3J0cykgewoJCW1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCdtb21lbnQnKSk7IC8vIE5vZGUKCX0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CgkJZGVmaW5lKFsnbW9tZW50J10sIGZhY3RvcnkpOyAgICAgICAgICAgICAgICAgLy8gQU1ECgl9IGVsc2UgewoJCWZhY3Rvcnkocm9vdC5tb21lbnQpOyAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJyb3dzZXIKCX0KfSh0aGlzLCBmdW5jdGlvbiAobW9tZW50KSB7CgkidXNlIHN0cmljdCI7CgoJLy8gRG8gbm90IGxvYWQgbW9tZW50LXRpbWV6b25lIGEgc2Vjb25kIHRpbWUuCgkvLyBpZiAobW9tZW50LnR6ICE9PSB1bmRlZmluZWQpIHsKCS8vIAlsb2dFcnJvcignTW9tZW50IFRpbWV6b25lICcgKyBtb21lbnQudHoudmVyc2lvbiArICcgd2FzIGFscmVhZHkgbG9hZGVkICcgKyAobW9tZW50LnR6LmRhdGFWZXJzaW9uID8gJ3dpdGggZGF0YSBmcm9tICcgOiAnd2l0aG91dCBhbnkgZGF0YScpICsgbW9tZW50LnR6LmRhdGFWZXJzaW9uKTsKCS8vIAlyZXR1cm4gbW9tZW50OwoJLy8gfQoKCXZhciBWRVJTSU9OID0gIjAuNS4yNSIsCgkJem9uZXMgPSB7fSwKCQlsaW5rcyA9IHt9LAoJCW5hbWVzID0ge30sCgkJZ3Vlc3NlcyA9IHt9LAoJCWNhY2hlZEd1ZXNzOwoKCWlmICghbW9tZW50IHx8IHR5cGVvZiBtb21lbnQudmVyc2lvbiAhPT0gJ3N0cmluZycpIHsKCQlsb2dFcnJvcignTW9tZW50IFRpbWV6b25lIHJlcXVpcmVzIE1vbWVudC5qcy4gU2VlIGh0dHBzOi8vbW9tZW50anMuY29tL3RpbWV6b25lL2RvY3MvIy91c2UtaXQvYnJvd3Nlci8nKTsKCX0KCgl2YXIgbW9tZW50VmVyc2lvbiA9IG1vbWVudC52ZXJzaW9uLnNwbGl0KCcuJyksCgkJbWFqb3IgPSArbW9tZW50VmVyc2lvblswXSwKCQltaW5vciA9ICttb21lbnRWZXJzaW9uWzFdOwoKCS8vIE1vbWVudC5qcyB2ZXJzaW9uIGNoZWNrCglpZiAobWFqb3IgPCAyIHx8IChtYWpvciA9PT0gMiAmJiBtaW5vciA8IDYpKSB7CgkJbG9nRXJyb3IoJ01vbWVudCBUaW1lem9uZSByZXF1aXJlcyBNb21lbnQuanMgPj0gMi42LjAuIFlvdSBhcmUgdXNpbmcgTW9tZW50LmpzICcgKyBtb21lbnQudmVyc2lvbiArICcuIFNlZSBtb21lbnRqcy5jb20nKTsKCX0KCgkvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCgkJVW5wYWNraW5nCgkqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoJZnVuY3Rpb24gY2hhckNvZGVUb0ludChjaGFyQ29kZSkgewoJCWlmIChjaGFyQ29kZSA+IDk2KSB7CgkJCXJldHVybiBjaGFyQ29kZSAtIDg3OwoJCX0gZWxzZSBpZiAoY2hhckNvZGUgPiA2NCkgewoJCQlyZXR1cm4gY2hhckNvZGUgLSAyOTsKCQl9CgkJcmV0dXJuIGNoYXJDb2RlIC0gNDg7Cgl9CgoJZnVuY3Rpb24gdW5wYWNrQmFzZTYwKHN0cmluZykgewoJCXZhciBpID0gMCwKCQkJcGFydHMgPSBzdHJpbmcuc3BsaXQoJy4nKSwKCQkJd2hvbGUgPSBwYXJ0c1swXSwKCQkJZnJhY3Rpb25hbCA9IHBhcnRzWzFdIHx8ICcnLAoJCQltdWx0aXBsaWVyID0gMSwKCQkJbnVtLAoJCQlvdXQgPSAwLAoJCQlzaWduID0gMTsKCgkJLy8gaGFuZGxlIG5lZ2F0aXZlIG51bWJlcnMKCQlpZiAoc3RyaW5nLmNoYXJDb2RlQXQoMCkgPT09IDQ1KSB7CgkJCWkgPSAxOwoJCQlzaWduID0gLTE7CgkJfQoKCQkvLyBoYW5kbGUgZGlnaXRzIGJlZm9yZSB0aGUgZGVjaW1hbAoJCWZvciAoaTsgaSA8IHdob2xlLmxlbmd0aDsgaSsrKSB7CgkJCW51bSA9IGNoYXJDb2RlVG9JbnQod2hvbGUuY2hhckNvZGVBdChpKSk7CgkJCW91dCA9IDYwICogb3V0ICsgbnVtOwoJCX0KCgkJLy8gaGFuZGxlIGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbAoJCWZvciAoaSA9IDA7IGkgPCBmcmFjdGlvbmFsLmxlbmd0aDsgaSsrKSB7CgkJCW11bHRpcGxpZXIgPSBtdWx0aXBsaWVyIC8gNjA7CgkJCW51bSA9IGNoYXJDb2RlVG9JbnQoZnJhY3Rpb25hbC5jaGFyQ29kZUF0KGkpKTsKCQkJb3V0ICs9IG51bSAqIG11bHRpcGxpZXI7CgkJfQoKCQlyZXR1cm4gb3V0ICogc2lnbjsKCX0KCglmdW5jdGlvbiBhcnJheVRvSW50IChhcnJheSkgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKCQkJYXJyYXlbaV0gPSB1bnBhY2tCYXNlNjAoYXJyYXlbaV0pOwoJCX0KCX0KCglmdW5jdGlvbiBpbnRUb1VudGlsIChhcnJheSwgbGVuZ3RoKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJCQlhcnJheVtpXSA9IE1hdGgucm91bmQoKGFycmF5W2kgLSAxXSB8fCAwKSArIChhcnJheVtpXSAqIDYwMDAwKSk7IC8vIG1pbnV0ZXMgdG8gbWlsbGlzZWNvbmRzCgkJfQoKCQlhcnJheVtsZW5ndGggLSAxXSA9IEluZmluaXR5OwoJfQoKCWZ1bmN0aW9uIG1hcEluZGljZXMgKHNvdXJjZSwgaW5kaWNlcykgewoJCXZhciBvdXQgPSBbXSwgaTsKCgkJZm9yIChpID0gMDsgaSA8IGluZGljZXMubGVuZ3RoOyBpKyspIHsKCQkJb3V0W2ldID0gc291cmNlW2luZGljZXNbaV1dOwoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglmdW5jdGlvbiB1bnBhY2sgKHN0cmluZykgewoJCXZhciBkYXRhID0gc3RyaW5nLnNwbGl0KCd8JyksCgkJCW9mZnNldHMgPSBkYXRhWzJdLnNwbGl0KCcgJyksCgkJCWluZGljZXMgPSBkYXRhWzNdLnNwbGl0KCcnKSwKCQkJdW50aWxzICA9IGRhdGFbNF0uc3BsaXQoJyAnKTsKCgkJYXJyYXlUb0ludChvZmZzZXRzKTsKCQlhcnJheVRvSW50KGluZGljZXMpOwoJCWFycmF5VG9JbnQodW50aWxzKTsKCgkJaW50VG9VbnRpbCh1bnRpbHMsIGluZGljZXMubGVuZ3RoKTsKCgkJcmV0dXJuIHsKCQkJbmFtZSAgICAgICA6IGRhdGFbMF0sCgkJCWFiYnJzICAgICAgOiBtYXBJbmRpY2VzKGRhdGFbMV0uc3BsaXQoJyAnKSwgaW5kaWNlcyksCgkJCW9mZnNldHMgICAgOiBtYXBJbmRpY2VzKG9mZnNldHMsIGluZGljZXMpLAoJCQl1bnRpbHMgICAgIDogdW50aWxzLAoJCQlwb3B1bGF0aW9uIDogZGF0YVs1XSB8IDAKCQl9OwoJfQoKCS8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKCQlab25lIG9iamVjdAoJKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCWZ1bmN0aW9uIFpvbmUgKHBhY2tlZFN0cmluZykgewoJCWlmIChwYWNrZWRTdHJpbmcpIHsKCQkJdGhpcy5fc2V0KHVucGFjayhwYWNrZWRTdHJpbmcpKTsKCQl9Cgl9CgoJWm9uZS5wcm90b3R5cGUgPSB7CgkJX3NldCA6IGZ1bmN0aW9uICh1bnBhY2tlZCkgewoJCQl0aGlzLm5hbWUgICAgICAgPSB1bnBhY2tlZC5uYW1lOwoJCQl0aGlzLmFiYnJzICAgICAgPSB1bnBhY2tlZC5hYmJyczsKCQkJdGhpcy51bnRpbHMgICAgID0gdW5wYWNrZWQudW50aWxzOwoJCQl0aGlzLm9mZnNldHMgICAgPSB1bnBhY2tlZC5vZmZzZXRzOwoJCQl0aGlzLnBvcHVsYXRpb24gPSB1bnBhY2tlZC5wb3B1bGF0aW9uOwoJCX0sCgoJCV9pbmRleCA6IGZ1bmN0aW9uICh0aW1lc3RhbXApIHsKCQkJdmFyIHRhcmdldCA9ICt0aW1lc3RhbXAsCgkJCQl1bnRpbHMgPSB0aGlzLnVudGlscywKCQkJCWk7CgoJCQlmb3IgKGkgPSAwOyBpIDwgdW50aWxzLmxlbmd0aDsgaSsrKSB7CgkJCQlpZiAodGFyZ2V0IDwgdW50aWxzW2ldKSB7CgkJCQkJcmV0dXJuIGk7CgkJCQl9CgkJCX0KCQl9LAoKCQlwYXJzZSA6IGZ1bmN0aW9uICh0aW1lc3RhbXApIHsKCQkJdmFyIHRhcmdldCAgPSArdGltZXN0YW1wLAoJCQkJb2Zmc2V0cyA9IHRoaXMub2Zmc2V0cywKCQkJCXVudGlscyAgPSB0aGlzLnVudGlscywKCQkJCW1heCAgICAgPSB1bnRpbHMubGVuZ3RoIC0gMSwKCQkJCW9mZnNldCwgb2Zmc2V0TmV4dCwgb2Zmc2V0UHJldiwgaTsKCgkJCWZvciAoaSA9IDA7IGkgPCBtYXg7IGkrKykgewoJCQkJb2Zmc2V0ICAgICA9IG9mZnNldHNbaV07CgkJCQlvZmZzZXROZXh0ID0gb2Zmc2V0c1tpICsgMV07CgkJCQlvZmZzZXRQcmV2ID0gb2Zmc2V0c1tpID8gaSAtIDEgOiBpXTsKCgkJCQlpZiAob2Zmc2V0IDwgb2Zmc2V0TmV4dCAmJiB0ei5tb3ZlQW1iaWd1b3VzRm9yd2FyZCkgewoJCQkJCW9mZnNldCA9IG9mZnNldE5leHQ7CgkJCQl9IGVsc2UgaWYgKG9mZnNldCA+IG9mZnNldFByZXYgJiYgdHoubW92ZUludmFsaWRGb3J3YXJkKSB7CgkJCQkJb2Zmc2V0ID0gb2Zmc2V0UHJldjsKCQkJCX0KCgkJCQlpZiAodGFyZ2V0IDwgdW50aWxzW2ldIC0gKG9mZnNldCAqIDYwMDAwKSkgewoJCQkJCXJldHVybiBvZmZzZXRzW2ldOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gb2Zmc2V0c1ttYXhdOwoJCX0sCgoJCWFiYnIgOiBmdW5jdGlvbiAobW9tKSB7CgkJCXJldHVybiB0aGlzLmFiYnJzW3RoaXMuX2luZGV4KG1vbSldOwoJCX0sCgoJCW9mZnNldCA6IGZ1bmN0aW9uIChtb20pIHsKCQkJbG9nRXJyb3IoInpvbmUub2Zmc2V0IGhhcyBiZWVuIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2Ygem9uZS51dGNPZmZzZXQiKTsKCQkJcmV0dXJuIHRoaXMub2Zmc2V0c1t0aGlzLl9pbmRleChtb20pXTsKCQl9LAoKCQl1dGNPZmZzZXQgOiBmdW5jdGlvbiAobW9tKSB7CgkJCXJldHVybiB0aGlzLm9mZnNldHNbdGhpcy5faW5kZXgobW9tKV07CgkJfQoJfTsKCgkvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCgkJQ3VycmVudCBUaW1lem9uZQoJKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCWZ1bmN0aW9uIE9mZnNldEF0KGF0KSB7CgkJdmFyIHRpbWVTdHJpbmcgPSBhdC50b1RpbWVTdHJpbmcoKTsKCQl2YXIgYWJiciA9IHRpbWVTdHJpbmcubWF0Y2goL1woW2EteiBdK1wpL2kpOwoJCWlmIChhYmJyICYmIGFiYnJbMF0pIHsKCQkJLy8gMTc6NTY6MzEgR01ULTA2MDAgKENTVCkKCQkJLy8gMTc6NTY6MzEgR01ULTA2MDAgKENlbnRyYWwgU3RhbmRhcmQgVGltZSkKCQkJYWJiciA9IGFiYnJbMF0ubWF0Y2goL1tBLVpdL2cpOwoJCQlhYmJyID0gYWJiciA/IGFiYnIuam9pbignJykgOiB1bmRlZmluZWQ7CgkJfSBlbHNlIHsKCQkJLy8gMTc6NTY6MzEgQ1NUCgkJCS8vIDE3OjU2OjMxIEdNVCswODAwICjlj7DljJfmqJnmupbmmYLplpMpCgkJCWFiYnIgPSB0aW1lU3RyaW5nLm1hdGNoKC9bQS1aXXszLDV9L2cpOwoJCQlhYmJyID0gYWJiciA/IGFiYnJbMF0gOiB1bmRlZmluZWQ7CgkJfQoKCQlpZiAoYWJiciA9PT0gJ0dNVCcpIHsKCQkJYWJiciA9IHVuZGVmaW5lZDsKCQl9CgoJCXRoaXMuYXQgPSArYXQ7CgkJdGhpcy5hYmJyID0gYWJicjsKCQl0aGlzLm9mZnNldCA9IGF0LmdldFRpbWV6b25lT2Zmc2V0KCk7Cgl9CgoJZnVuY3Rpb24gWm9uZVNjb3JlKHpvbmUpIHsKCQl0aGlzLnpvbmUgPSB6b25lOwoJCXRoaXMub2Zmc2V0U2NvcmUgPSAwOwoJCXRoaXMuYWJiclNjb3JlID0gMDsKCX0KCglab25lU2NvcmUucHJvdG90eXBlLnNjb3JlT2Zmc2V0QXQgPSBmdW5jdGlvbiAob2Zmc2V0QXQpIHsKCQl0aGlzLm9mZnNldFNjb3JlICs9IE1hdGguYWJzKHRoaXMuem9uZS51dGNPZmZzZXQob2Zmc2V0QXQuYXQpIC0gb2Zmc2V0QXQub2Zmc2V0KTsKCQlpZiAodGhpcy56b25lLmFiYnIob2Zmc2V0QXQuYXQpLnJlcGxhY2UoL1teQS1aXS9nLCAnJykgIT09IG9mZnNldEF0LmFiYnIpIHsKCQkJdGhpcy5hYmJyU2NvcmUrKzsKCQl9Cgl9OwoKCWZ1bmN0aW9uIGZpbmRDaGFuZ2UobG93LCBoaWdoKSB7CgkJdmFyIG1pZCwgZGlmZjsKCgkJd2hpbGUgKChkaWZmID0gKChoaWdoLmF0IC0gbG93LmF0KSAvIDEyZTQgfCAwKSAqIDZlNCkpIHsKCQkJbWlkID0gbmV3IE9mZnNldEF0KG5ldyBEYXRlKGxvdy5hdCArIGRpZmYpKTsKCQkJaWYgKG1pZC5vZmZzZXQgPT09IGxvdy5vZmZzZXQpIHsKCQkJCWxvdyA9IG1pZDsKCQkJfSBlbHNlIHsKCQkJCWhpZ2ggPSBtaWQ7CgkJCX0KCQl9CgoJCXJldHVybiBsb3c7Cgl9CgoJZnVuY3Rpb24gdXNlck9mZnNldHMoKSB7CgkJdmFyIHN0YXJ0WWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSAtIDIsCgkJCWxhc3QgPSBuZXcgT2Zmc2V0QXQobmV3IERhdGUoc3RhcnRZZWFyLCAwLCAxKSksCgkJCW9mZnNldHMgPSBbbGFzdF0sCgkJCWNoYW5nZSwgbmV4dCwgaTsKCgkJZm9yIChpID0gMTsgaSA8IDQ4OyBpKyspIHsKCQkJbmV4dCA9IG5ldyBPZmZzZXRBdChuZXcgRGF0ZShzdGFydFllYXIsIGksIDEpKTsKCQkJaWYgKG5leHQub2Zmc2V0ICE9PSBsYXN0Lm9mZnNldCkgewoJCQkJY2hhbmdlID0gZmluZENoYW5nZShsYXN0LCBuZXh0KTsKCQkJCW9mZnNldHMucHVzaChjaGFuZ2UpOwoJCQkJb2Zmc2V0cy5wdXNoKG5ldyBPZmZzZXRBdChuZXcgRGF0ZShjaGFuZ2UuYXQgKyA2ZTQpKSk7CgkJCX0KCQkJbGFzdCA9IG5leHQ7CgkJfQoKCQlmb3IgKGkgPSAwOyBpIDwgNDsgaSsrKSB7CgkJCW9mZnNldHMucHVzaChuZXcgT2Zmc2V0QXQobmV3IERhdGUoc3RhcnRZZWFyICsgaSwgMCwgMSkpKTsKCQkJb2Zmc2V0cy5wdXNoKG5ldyBPZmZzZXRBdChuZXcgRGF0ZShzdGFydFllYXIgKyBpLCA2LCAxKSkpOwoJCX0KCgkJcmV0dXJuIG9mZnNldHM7Cgl9CgoJZnVuY3Rpb24gc29ydFpvbmVTY29yZXMgKGEsIGIpIHsKCQlpZiAoYS5vZmZzZXRTY29yZSAhPT0gYi5vZmZzZXRTY29yZSkgewoJCQlyZXR1cm4gYS5vZmZzZXRTY29yZSAtIGIub2Zmc2V0U2NvcmU7CgkJfQoJCWlmIChhLmFiYnJTY29yZSAhPT0gYi5hYmJyU2NvcmUpIHsKCQkJcmV0dXJuIGEuYWJiclNjb3JlIC0gYi5hYmJyU2NvcmU7CgkJfQoJCXJldHVybiBiLnpvbmUucG9wdWxhdGlvbiAtIGEuem9uZS5wb3B1bGF0aW9uOwoJfQoKCWZ1bmN0aW9uIGFkZFRvR3Vlc3NlcyAobmFtZSwgb2Zmc2V0cykgewoJCXZhciBpLCBvZmZzZXQ7CgkJYXJyYXlUb0ludChvZmZzZXRzKTsKCQlmb3IgKGkgPSAwOyBpIDwgb2Zmc2V0cy5sZW5ndGg7IGkrKykgewoJCQlvZmZzZXQgPSBvZmZzZXRzW2ldOwoJCQlndWVzc2VzW29mZnNldF0gPSBndWVzc2VzW29mZnNldF0gfHwge307CgkJCWd1ZXNzZXNbb2Zmc2V0XVtuYW1lXSA9IHRydWU7CgkJfQoJfQoKCWZ1bmN0aW9uIGd1ZXNzZXNGb3JVc2VyT2Zmc2V0cyAob2Zmc2V0cykgewoJCXZhciBvZmZzZXRzTGVuZ3RoID0gb2Zmc2V0cy5sZW5ndGgsCgkJCWZpbHRlcmVkR3Vlc3NlcyA9IHt9LAoJCQlvdXQgPSBbXSwKCQkJaSwgaiwgZ3Vlc3Nlc09mZnNldDsKCgkJZm9yIChpID0gMDsgaSA8IG9mZnNldHNMZW5ndGg7IGkrKykgewoJCQlndWVzc2VzT2Zmc2V0ID0gZ3Vlc3Nlc1tvZmZzZXRzW2ldLm9mZnNldF0gfHwge307CgkJCWZvciAoaiBpbiBndWVzc2VzT2Zmc2V0KSB7CgkJCQlpZiAoZ3Vlc3Nlc09mZnNldC5oYXNPd25Qcm9wZXJ0eShqKSkgewoJCQkJCWZpbHRlcmVkR3Vlc3Nlc1tqXSA9IHRydWU7CgkJCQl9CgkJCX0KCQl9CgoJCWZvciAoaSBpbiBmaWx0ZXJlZEd1ZXNzZXMpIHsKCQkJaWYgKGZpbHRlcmVkR3Vlc3Nlcy5oYXNPd25Qcm9wZXJ0eShpKSkgewoJCQkJb3V0LnB1c2gobmFtZXNbaV0pOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWZ1bmN0aW9uIHJlYnVpbGRHdWVzcyAoKSB7CgoJCS8vIHVzZSBJbnRsIEFQSSB3aGVuIGF2YWlsYWJsZSBhbmQgcmV0dXJuaW5nIHZhbGlkIHRpbWUgem9uZQoJCXRyeSB7CgkJCXZhciBpbnRsTmFtZSA9IEludGwuRGF0ZVRpbWVGb3JtYXQoKS5yZXNvbHZlZE9wdGlvbnMoKS50aW1lWm9uZTsKCQkJaWYgKGludGxOYW1lICYmIGludGxOYW1lLmxlbmd0aCA+IDMpIHsKCQkJCXZhciBuYW1lID0gbmFtZXNbbm9ybWFsaXplTmFtZShpbnRsTmFtZSldOwoJCQkJaWYgKG5hbWUpIHsKCQkJCQlyZXR1cm4gbmFtZTsKCQkJCX0KCQkJCWxvZ0Vycm9yKCJNb21lbnQgVGltZXpvbmUgZm91bmQgIiArIGludGxOYW1lICsgIiBmcm9tIHRoZSBJbnRsIGFwaSwgYnV0IGRpZCBub3QgaGF2ZSB0aGF0IGRhdGEgbG9hZGVkLiIpOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCQkvLyBJbnRsIHVuYXZhaWxhYmxlLCBmYWxsIGJhY2sgdG8gbWFudWFsIGd1ZXNzaW5nLgoJCX0KCgkJdmFyIG9mZnNldHMgPSB1c2VyT2Zmc2V0cygpLAoJCQlvZmZzZXRzTGVuZ3RoID0gb2Zmc2V0cy5sZW5ndGgsCgkJCWd1ZXNzZXMgPSBndWVzc2VzRm9yVXNlck9mZnNldHMob2Zmc2V0cyksCgkJCXpvbmVTY29yZXMgPSBbXSwKCQkJem9uZVNjb3JlLCBpLCBqOwoKCQlmb3IgKGkgPSAwOyBpIDwgZ3Vlc3Nlcy5sZW5ndGg7IGkrKykgewoJCQl6b25lU2NvcmUgPSBuZXcgWm9uZVNjb3JlKGdldFpvbmUoZ3Vlc3Nlc1tpXSksIG9mZnNldHNMZW5ndGgpOwoJCQlmb3IgKGogPSAwOyBqIDwgb2Zmc2V0c0xlbmd0aDsgaisrKSB7CgkJCQl6b25lU2NvcmUuc2NvcmVPZmZzZXRBdChvZmZzZXRzW2pdKTsKCQkJfQoJCQl6b25lU2NvcmVzLnB1c2goem9uZVNjb3JlKTsKCQl9CgoJCXpvbmVTY29yZXMuc29ydChzb3J0Wm9uZVNjb3Jlcyk7CgoJCXJldHVybiB6b25lU2NvcmVzLmxlbmd0aCA+IDAgPyB6b25lU2NvcmVzWzBdLnpvbmUubmFtZSA6IHVuZGVmaW5lZDsKCX0KCglmdW5jdGlvbiBndWVzcyAoaWdub3JlQ2FjaGUpIHsKCQlpZiAoIWNhY2hlZEd1ZXNzIHx8IGlnbm9yZUNhY2hlKSB7CgkJCWNhY2hlZEd1ZXNzID0gcmVidWlsZEd1ZXNzKCk7CgkJfQoJCXJldHVybiBjYWNoZWRHdWVzczsKCX0KCgkvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCgkJR2xvYmFsIE1ldGhvZHMKCSoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCglmdW5jdGlvbiBub3JtYWxpemVOYW1lIChuYW1lKSB7CgkJcmV0dXJuIChuYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1wvL2csICdfJyk7Cgl9CgoJZnVuY3Rpb24gYWRkWm9uZSAocGFja2VkKSB7CgkJdmFyIGksIG5hbWUsIHNwbGl0LCBub3JtYWxpemVkOwoKCQlpZiAodHlwZW9mIHBhY2tlZCA9PT0gInN0cmluZyIpIHsKCQkJcGFja2VkID0gW3BhY2tlZF07CgkJfQoKCQlmb3IgKGkgPSAwOyBpIDwgcGFja2VkLmxlbmd0aDsgaSsrKSB7CgkJCXNwbGl0ID0gcGFja2VkW2ldLnNwbGl0KCd8Jyk7CgkJCW5hbWUgPSBzcGxpdFswXTsKCQkJbm9ybWFsaXplZCA9IG5vcm1hbGl6ZU5hbWUobmFtZSk7CgkJCXpvbmVzW25vcm1hbGl6ZWRdID0gcGFja2VkW2ldOwoJCQluYW1lc1tub3JtYWxpemVkXSA9IG5hbWU7CgkJCWFkZFRvR3Vlc3Nlcyhub3JtYWxpemVkLCBzcGxpdFsyXS5zcGxpdCgnICcpKTsKCQl9Cgl9CgoJZnVuY3Rpb24gZ2V0Wm9uZSAobmFtZSwgY2FsbGVyKSB7CgkJCgkJbmFtZSA9IG5vcm1hbGl6ZU5hbWUobmFtZSk7CgoJCXZhciB6b25lID0gem9uZXNbbmFtZV07CgkJdmFyIGxpbms7CgoJCWlmICh6b25lIGluc3RhbmNlb2YgWm9uZSkgewoJCQlyZXR1cm4gem9uZTsKCQl9CgoJCWlmICh0eXBlb2Ygem9uZSA9PT0gJ3N0cmluZycpIHsKCQkJem9uZSA9IG5ldyBab25lKHpvbmUpOwoJCQl6b25lc1tuYW1lXSA9IHpvbmU7CgkJCXJldHVybiB6b25lOwoJCX0KCgkJLy8gUGFzcyBnZXRab25lIHRvIHByZXZlbnQgcmVjdXJzaW9uIG1vcmUgdGhhbiAxIGxldmVsIGRlZXAKCQlpZiAobGlua3NbbmFtZV0gJiYgY2FsbGVyICE9PSBnZXRab25lICYmIChsaW5rID0gZ2V0Wm9uZShsaW5rc1tuYW1lXSwgZ2V0Wm9uZSkpKSB7CgkJCXpvbmUgPSB6b25lc1tuYW1lXSA9IG5ldyBab25lKCk7CgkJCXpvbmUuX3NldChsaW5rKTsKCQkJem9uZS5uYW1lID0gbmFtZXNbbmFtZV07CgkJCXJldHVybiB6b25lOwoJCX0KCgkJcmV0dXJuIG51bGw7Cgl9CgoJZnVuY3Rpb24gZ2V0TmFtZXMgKCkgewoJCXZhciBpLCBvdXQgPSBbXTsKCgkJZm9yIChpIGluIG5hbWVzKSB7CgkJCWlmIChuYW1lcy5oYXNPd25Qcm9wZXJ0eShpKSAmJiAoem9uZXNbaV0gfHwgem9uZXNbbGlua3NbaV1dKSAmJiBuYW1lc1tpXSkgewoJCQkJb3V0LnB1c2gobmFtZXNbaV0pOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0LnNvcnQoKTsKCX0KCglmdW5jdGlvbiBhZGRMaW5rIChhbGlhc2VzKSB7CgkJdmFyIGksIGFsaWFzLCBub3JtYWwwLCBub3JtYWwxOwoKCQlpZiAodHlwZW9mIGFsaWFzZXMgPT09ICJzdHJpbmciKSB7CgkJCWFsaWFzZXMgPSBbYWxpYXNlc107CgkJfQoKCQlmb3IgKGkgPSAwOyBpIDwgYWxpYXNlcy5sZW5ndGg7IGkrKykgewoJCQlhbGlhcyA9IGFsaWFzZXNbaV0uc3BsaXQoJ3wnKTsKCgkJCW5vcm1hbDAgPSBub3JtYWxpemVOYW1lKGFsaWFzWzBdKTsKCQkJbm9ybWFsMSA9IG5vcm1hbGl6ZU5hbWUoYWxpYXNbMV0pOwoKCQkJbGlua3Nbbm9ybWFsMF0gPSBub3JtYWwxOwoJCQluYW1lc1tub3JtYWwwXSA9IGFsaWFzWzBdOwoKCQkJbGlua3Nbbm9ybWFsMV0gPSBub3JtYWwwOwoJCQluYW1lc1tub3JtYWwxXSA9IGFsaWFzWzFdOwoJCX0KCX0KCglmdW5jdGlvbiBsb2FkRGF0YSAoZGF0YSkgewoJCWFkZFpvbmUoZGF0YS56b25lcyk7CgkJYWRkTGluayhkYXRhLmxpbmtzKTsKCQl0ei5kYXRhVmVyc2lvbiA9IGRhdGEudmVyc2lvbjsKCX0KCglmdW5jdGlvbiB6b25lRXhpc3RzIChuYW1lKSB7CgkJaWYgKCF6b25lRXhpc3RzLmRpZFNob3dFcnJvcikgewoJCQl6b25lRXhpc3RzLmRpZFNob3dFcnJvciA9IHRydWU7CgkJCQlsb2dFcnJvcigibW9tZW50LnR6LnpvbmVFeGlzdHMoJyIgKyBuYW1lICsgIicpIGhhcyBiZWVuIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgIW1vbWVudC50ei56b25lKCciICsgbmFtZSArICInKSIpOwoJCX0KCQlyZXR1cm4gISFnZXRab25lKG5hbWUpOwoJfQoKCWZ1bmN0aW9uIG5lZWRzT2Zmc2V0IChtKSB7CgkJdmFyIGlzVW5peFRpbWVzdGFtcCA9IChtLl9mID09PSAnWCcgfHwgbS5fZiA9PT0gJ3gnKTsKCQlyZXR1cm4gISEobS5fYSAmJiAobS5fdHptID09PSB1bmRlZmluZWQpICYmICFpc1VuaXhUaW1lc3RhbXApOwoJfQoKCWZ1bmN0aW9uIGxvZ0Vycm9yIChtZXNzYWdlKSB7CgkJaWYgKHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gJ2Z1bmN0aW9uJykgewoJCQljb25zb2xlLmVycm9yKG1lc3NhZ2UpOwoJCX0KCX0KCgkvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCgkJbW9tZW50LnR6IG5hbWVzcGFjZQoJKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCWZ1bmN0aW9uIHR6IChpbnB1dCkgewoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwLCAtMSksCgkJCW5hbWUgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdLAoJCQl6b25lID0gZ2V0Wm9uZShuYW1lKSwKCQkJb3V0ICA9IG1vbWVudC51dGMuYXBwbHkobnVsbCwgYXJncyk7CgoJCWlmICh6b25lICYmICFtb21lbnQuaXNNb21lbnQoaW5wdXQpICYmIG5lZWRzT2Zmc2V0KG91dCkpIHsKCQkJb3V0LmFkZCh6b25lLnBhcnNlKG91dCksICdtaW51dGVzJyk7CgkJfQoKCQlvdXQudHoobmFtZSk7CgoJCXJldHVybiBvdXQ7Cgl9CgoJdHoudmVyc2lvbiAgICAgID0gVkVSU0lPTjsKCXR6LmRhdGFWZXJzaW9uICA9ICcnOwoJdHouX3pvbmVzICAgICAgID0gem9uZXM7Cgl0ei5fbGlua3MgICAgICAgPSBsaW5rczsKCXR6Ll9uYW1lcyAgICAgICA9IG5hbWVzOwoJdHouYWRkICAgICAgICAgID0gYWRkWm9uZTsKCXR6LmxpbmsgICAgICAgICA9IGFkZExpbms7Cgl0ei5sb2FkICAgICAgICAgPSBsb2FkRGF0YTsKCXR6LnpvbmUgICAgICAgICA9IGdldFpvbmU7Cgl0ei56b25lRXhpc3RzICAgPSB6b25lRXhpc3RzOyAvLyBkZXByZWNhdGVkIGluIDAuMS4wCgl0ei5ndWVzcyAgICAgICAgPSBndWVzczsKCXR6Lm5hbWVzICAgICAgICA9IGdldE5hbWVzOwoJdHouWm9uZSAgICAgICAgID0gWm9uZTsKCXR6LnVucGFjayAgICAgICA9IHVucGFjazsKCXR6LnVucGFja0Jhc2U2MCA9IHVucGFja0Jhc2U2MDsKCXR6Lm5lZWRzT2Zmc2V0ICA9IG5lZWRzT2Zmc2V0OwoJdHoubW92ZUludmFsaWRGb3J3YXJkICAgPSB0cnVlOwoJdHoubW92ZUFtYmlndW91c0ZvcndhcmQgPSBmYWxzZTsKCgkvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCgkJSW50ZXJmYWNlIHdpdGggTW9tZW50LmpzCgkqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoJdmFyIGZuID0gbW9tZW50LmZuOwoKCW1vbWVudC50eiA9IHR6OwoKCW1vbWVudC5kZWZhdWx0Wm9uZSA9IG51bGw7CgoJbW9tZW50LnVwZGF0ZU9mZnNldCA9IGZ1bmN0aW9uIChtb20sIGtlZXBUaW1lKSB7CgkJdmFyIHpvbmUgPSBtb21lbnQuZGVmYXVsdFpvbmUsCgkJCW9mZnNldDsKCgkJaWYgKG1vbS5feiA9PT0gdW5kZWZpbmVkKSB7CgkJCWlmICh6b25lICYmIG5lZWRzT2Zmc2V0KG1vbSkgJiYgIW1vbS5faXNVVEMpIHsKCQkJCW1vbS5fZCA9IG1vbWVudC51dGMobW9tLl9hKS5fZDsKCQkJCW1vbS51dGMoKS5hZGQoem9uZS5wYXJzZShtb20pLCAnbWludXRlcycpOwoJCQl9CgkJCW1vbS5feiA9IHpvbmU7CgkJfQoJCWlmIChtb20uX3opIHsKCQkJb2Zmc2V0ID0gbW9tLl96LnV0Y09mZnNldChtb20pOwoJCQlpZiAoTWF0aC5hYnMob2Zmc2V0KSA8IDE2KSB7CgkJCQlvZmZzZXQgPSBvZmZzZXQgLyA2MDsKCQkJfQoJCQlpZiAobW9tLnV0Y09mZnNldCAhPT0gdW5kZWZpbmVkKSB7CgkJCQl2YXIgeiA9IG1vbS5fejsKCQkJCW1vbS51dGNPZmZzZXQoLW9mZnNldCwga2VlcFRpbWUpOwoJCQkJbW9tLl96ID0gejsKCQkJfSBlbHNlIHsKCQkJCW1vbS56b25lKG9mZnNldCwga2VlcFRpbWUpOwoJCQl9CgkJfQoJfTsKCglmbi50eiA9IGZ1bmN0aW9uIChuYW1lLCBrZWVwVGltZSkgewoJCWlmIChuYW1lKSB7CgkJCWlmICh0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycpIHsKCQkJCXRocm93IG5ldyBFcnJvcignVGltZSB6b25lIG5hbWUgbXVzdCBiZSBhIHN0cmluZywgZ290ICcgKyBuYW1lICsgJyBbJyArIHR5cGVvZiBuYW1lICsgJ10nKTsKCQkJfQoJCQl0aGlzLl96ID0gZ2V0Wm9uZShuYW1lKTsKCQkJaWYgKHRoaXMuX3opIHsKCQkJCW1vbWVudC51cGRhdGVPZmZzZXQodGhpcywga2VlcFRpbWUpOwoJCQl9IGVsc2UgewoJCQkJbG9nRXJyb3IoIk1vbWVudCBUaW1lem9uZSBoYXMgbm8gZGF0YSBmb3IgIiArIG5hbWUgKyAiLiBTZWUgaHR0cDovL21vbWVudGpzLmNvbS90aW1lem9uZS9kb2NzLyMvZGF0YS1sb2FkaW5nLy4iKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKHRoaXMuX3opIHsgcmV0dXJuIHRoaXMuX3oubmFtZTsgfQoJfTsKCglmdW5jdGlvbiBhYmJyV3JhcCAob2xkKSB7CgkJcmV0dXJuIGZ1bmN0aW9uICgpIHsKCQkJaWYgKHRoaXMuX3opIHsgcmV0dXJuIHRoaXMuX3ouYWJicih0aGlzKTsgfQoJCQlyZXR1cm4gb2xkLmNhbGwodGhpcyk7CgkJfTsKCX0KCglmdW5jdGlvbiByZXNldFpvbmVXcmFwIChvbGQpIHsKCQlyZXR1cm4gZnVuY3Rpb24gKCkgewoJCQl0aGlzLl96ID0gbnVsbDsKCQkJcmV0dXJuIG9sZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCX07Cgl9CgoJZnVuY3Rpb24gcmVzZXRab25lV3JhcDIgKG9sZCkgewoJCXJldHVybiBmdW5jdGlvbiAoKSB7CgkJCWlmIChhcmd1bWVudHMubGVuZ3RoID4gMCkgdGhpcy5feiA9IG51bGw7CgkJCXJldHVybiBvbGQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl9OwoJfQoKCWZuLnpvbmVOYW1lICA9IGFiYnJXcmFwKGZuLnpvbmVOYW1lKTsKCWZuLnpvbmVBYmJyICA9IGFiYnJXcmFwKGZuLnpvbmVBYmJyKTsKCWZuLnV0YyAgICAgICA9IHJlc2V0Wm9uZVdyYXAoZm4udXRjKTsKCWZuLmxvY2FsICAgICA9IHJlc2V0Wm9uZVdyYXAoZm4ubG9jYWwpOwoJZm4udXRjT2Zmc2V0ID0gcmVzZXRab25lV3JhcDIoZm4udXRjT2Zmc2V0KTsKCQoJbW9tZW50LnR6LnNldERlZmF1bHQgPSBmdW5jdGlvbihuYW1lKSB7CgkJaWYgKG1ham9yIDwgMiB8fCAobWFqb3IgPT09IDIgJiYgbWlub3IgPCA5KSkgewoJCQlsb2dFcnJvcignTW9tZW50IFRpbWV6b25lIHNldERlZmF1bHQoKSByZXF1aXJlcyBNb21lbnQuanMgPj0gMi45LjAuIFlvdSBhcmUgdXNpbmcgTW9tZW50LmpzICcgKyBtb21lbnQudmVyc2lvbiArICcuJyk7CgkJfQoJCW1vbWVudC5kZWZhdWx0Wm9uZSA9IG5hbWUgPyBnZXRab25lKG5hbWUpIDogbnVsbDsKCQlyZXR1cm4gbW9tZW50OwoJfTsKCgkvLyBDbG9uaW5nIGEgbW9tZW50IHNob3VsZCBpbmNsdWRlIHRoZSBfeiBwcm9wZXJ0eS4KCXZhciBtb21lbnRQcm9wZXJ0aWVzID0gbW9tZW50Lm1vbWVudFByb3BlcnRpZXM7CglpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG1vbWVudFByb3BlcnRpZXMpID09PSAnW29iamVjdCBBcnJheV0nKSB7CgkJLy8gbW9tZW50IDIuOC4xKwoJCW1vbWVudFByb3BlcnRpZXMucHVzaCgnX3onKTsKCQltb21lbnRQcm9wZXJ0aWVzLnB1c2goJ19hJyk7Cgl9IGVsc2UgaWYgKG1vbWVudFByb3BlcnRpZXMpIHsKCQkvLyBtb21lbnQgMi43LjAKCQltb21lbnRQcm9wZXJ0aWVzLl96ID0gbnVsbDsKCX0KCglsb2FkRGF0YSh7CgkJInZlcnNpb24iOiAiMjAxOWEiLAoJCSJ6b25lcyI6IFsKCQkJIkFmcmljYS9BYmlkamFufEdNVHwwfDB8fDQ4ZTUiLAoJCQkiQWZyaWNhL05haXJvYml8RUFUfC0zMHwwfHw0N2U1IiwKCQkJIkFmcmljYS9BbGdpZXJzfENFVHwtMTB8MHx8MjZlNSIsCgkJCSJBZnJpY2EvTGFnb3N8V0FUfC0xMHwwfHwxN2U2IiwKCQkJIkFmcmljYS9NYXB1dG98Q0FUfC0yMHwwfHwyNmU1IiwKCQkJIkFmcmljYS9DYWlyb3xFRVQgRUVTVHwtMjAgLTMwfDAxMDEwfDFNMm0wIGdMMCBlMTAgbW4wfDE1ZTYiLAoJCQkiQWZyaWNhL0Nhc2FibGFuY2F8KzAwICswMXwwIC0xMHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwMXwxTEhDMCBBMDAgZTAwIHkwMCAxMUEwIHVNMCBlMDAgRGMwIDExQTAgczAwIGUwMCBJTTAgV00wIG1vMCBnTTAgTEEwIFdNMCBqQTAgZTAwIDI4TTAgZTAwIDI2MDAgZTAwIDI4TTAgZTAwIDI2MDAgZ00wIDI2MDAgZTAwIDI4TTAgZTAwfDMyZTUiLAoJCQkiRXVyb3BlL1BhcmlzfENFVCBDRVNUfC0xMCAtMjB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxIQjAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxcU0wIFdNMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxcU0wIFdNMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMHwxMWU2IiwKCQkJIkFmcmljYS9Kb2hhbm5lc2J1cmd8U0FTVHwtMjB8MHx8ODRlNSIsCgkJCSJBZnJpY2EvS2hhcnRvdW18RUFUIENBVHwtMzAgLTIwfDAxfDFVc2wwfDUxZTUiLAoJCQkiQWZyaWNhL1Nhb19Ub21lfEdNVCBXQVR8MCAtMTB8MDEwfDFVUU4wIDJxMDAiLAoJCQkiQWZyaWNhL1RyaXBvbGl8RUVUfC0yMHwwfHwxMWU1IiwKCQkJIkFmcmljYS9XaW5kaG9la3xDQVQgV0FUfC0yMCAtMTB8MDEwMTAxMDEwfDFMS28wIDExQjAgMW5YMCAxMUIwIDFuWDAgMTFCMCAxblgwIDExQjB8MzJlNCIsCgkJCSJBbWVyaWNhL0FkYWt8SFNUIEhEVHxhMCA5MHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTHpvMCAxemIwIE9wMCAxemIwIFJkMCAxemIwIE9wMCAxemIwIE9wMCAxemIwIE9wMCAxemIwIE9wMCAxemIwIFJkMCAxemIwIE9wMCAxemIwIE9wMCAxemIwIE9wMCAxemIwfDMyNiIsCgkJCSJBbWVyaWNhL0FuY2hvcmFnZXxBS1NUIEFLRFR8OTAgODB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUx6bjAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMHwzMGU0IiwKCQkJIkFtZXJpY2EvU2FudG9fRG9taW5nb3xBU1R8NDB8MHx8MjllNSIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXwtMDN8MzB8MHx8MzRlNSIsCgkJCSJBbWVyaWNhL0FzdW5jaW9ufC0wMyAtMDR8MzAgNDB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxFUDAgMWlwMCAxN2IwIDFpcDAgMTlYMCAxZkIwIDE5WDAgMWZCMCAxOVgwIDFpcDAgMTdiMCAxaXAwIDE3YjAgMWlwMCAxOVgwIDFmQjAgMTlYMCAxZkIwIDE5WDAgMWZCMCAxOVgwIDFpcDB8MjhlNSIsCgkJCSJBbWVyaWNhL1BhbmFtYXxFU1R8NTB8MHx8MTVlNSIsCgkJCSJBbWVyaWNhL01leGljb19DaXR5fENTVCBDRFR8NjAgNTB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxLdzAgMWxiMCAxNHAwIDFsYjAgMTRwMCAxblgwIDExQjAgMW5YMCAxMUIwIDFuWDAgMTRwMCAxbGIwIDE0cDAgMWxiMCAxNHAwIDFuWDAgMTFCMCAxblgwIDExQjAgMW5YMCAxNHAwIDFsYjB8MjBlNiIsCgkJCSJBbWVyaWNhL01hbmFndWF8Q1NUfDYwfDB8fDIyZTUiLAoJCQkiQW1lcmljYS9MYV9QYXp8LTA0fDQwfDB8fDE5ZTUiLAoJCQkiQW1lcmljYS9MaW1hfC0wNXw1MHwwfHwxMWU2IiwKCQkJIkFtZXJpY2EvRGVudmVyfE1TVCBNRFR8NzAgNjB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUx6bDAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMHwyNmU1IiwKCQkJIkFtZXJpY2EvQ2FtcG9fR3JhbmRlfC0wMyAtMDR8MzAgNDB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxxUDAgMUMxMCBPbjAgMXpkMCBPbjAgMXpkMCBPbjAgMXpkMCBPbjAgMUhCMCBGWDAgMUhCMCBGWDAgMUhCMCBJTDAgMUhCMCBGWDAgMUhCMCBJTDAgMUVOMCBGWDAgMUhCMHw3N2U0IiwKCQkJIkFtZXJpY2EvQ2FuY3VufENTVCBDRFQgRVNUfDYwIDUwIDUwfDAxMDJ8MUxLdzAgMWxiMCBEZDB8NjNlNCIsCgkJCSJBbWVyaWNhL0NhcmFjYXN8LTA0MzAgLTA0fDR1IDQwfDAxfDFRTVQwfDI5ZTUiLAoJCQkiQW1lcmljYS9DaGljYWdvfENTVCBDRFR8NjAgNTB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUx6azAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMHw5MmU1IiwKCQkJIkFtZXJpY2EvQ2hpaHVhaHVhfE1TVCBNRFR8NzAgNjB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxLeDAgMWxiMCAxNHAwIDFsYjAgMTRwMCAxblgwIDExQjAgMW5YMCAxMUIwIDFuWDAgMTRwMCAxbGIwIDE0cDAgMWxiMCAxNHAwIDFuWDAgMTFCMCAxblgwIDExQjAgMW5YMCAxNHAwIDFsYjB8ODFlNCIsCgkJCSJBbWVyaWNhL1Bob2VuaXh8TVNUfDcwfDB8fDQyZTUiLAoJCQkiQW1lcmljYS9Mb3NfQW5nZWxlc3xQU1QgUERUfDgwIDcwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMem0wIDF6YjAgT3AwIDF6YjAgUmQwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgUmQwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjB8MTVlNiIsCgkJCSJBbWVyaWNhL05ld19Zb3JrfEVTVCBFRFR8NTAgNDB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUx6ajAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMHwyMWU2IiwKCQkJIkFtZXJpY2EvRm9ydF9OZWxzb258UFNUIFBEVCBNU1R8ODAgNzAgNzB8MDEwMnwxTHptMCAxemIwIE9wMHwzOWUyIiwKCQkJIkFtZXJpY2EvSGFsaWZheHxBU1QgQURUfDQwIDMwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMemkwIDF6YjAgT3AwIDF6YjAgUmQwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgUmQwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjB8MzllNCIsCgkJCSJBbWVyaWNhL0dvZHRoYWJ8LTAzIC0wMnwzMCAyMHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTEhCMCAxbzAwIDExQTAgMW8wMCAxMUEwIDFxTTAgV00wIDFxTTAgV00wIDFxTTAgMTFBMCAxbzAwIDExQTAgMW8wMCAxMUEwIDFxTTAgV00wIDFxTTAgV00wIDFxTTAgMTFBMCAxbzAwfDE3ZTMiLAoJCQkiQW1lcmljYS9HcmFuZF9UdXJrfEVTVCBFRFQgQVNUfDUwIDQwIDQwfDAxMDEyMTAxMDEwMTAxMDEwMTB8MUx6ajAgMXpiMCBPcDAgMXpiMCA1SXAwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgUmQwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjB8MzdlMiIsCgkJCSJBbWVyaWNhL0hhdmFuYXxDU1QgQ0RUfDUwIDQwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMemgwIDF6YzAgT28wIDF6YzAgUmMwIDF6YzAgT28wIDF6YzAgT28wIDF6YzAgT28wIDF6YzAgT28wIDF6YzAgUmMwIDF6YzAgT28wIDF6YzAgT28wIDF6YzAgT28wIDF6YzB8MjFlNSIsCgkJCSJBbWVyaWNhL01ldGxha2F0bGF8UFNUIEFLU1QgQUtEVHw4MCA5MCA4MHwwMTIxMjEyMDEyMTIxMjEyMTIxMjF8MVBBYTAgUmQwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgdU0wIGpCMCAxemIwIE9wMCAxemIwIFJkMCAxemIwIE9wMCAxemIwIE9wMCAxemIwIE9wMCAxemIwfDE0ZTIiLAoJCQkiQW1lcmljYS9NaXF1ZWxvbnwtMDMgLTAyfDMwIDIwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMemgwIDF6YjAgT3AwIDF6YjAgUmQwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgUmQwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjAgT3AwIDF6YjB8NjFlMiIsCgkJCSJBbWVyaWNhL01vbnRldmlkZW98LTAyIC0wM3wyMCAzMHwwMTAxfDFMemcwIDFvMTAgMTF6MHwxN2U1IiwKCQkJIkFtZXJpY2EvTm9yb25oYXwtMDJ8MjB8MHx8MzBlMiIsCgkJCSJBbWVyaWNhL1BvcnQtYXUtUHJpbmNlfEVTVCBFRFR8NTAgNDB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMemowIDF6YjAgT3AwIDF6YjAgM2lOMCAxemIwIE9wMCAxemIwIE9wMCAxemIwIE9wMCAxemIwIFJkMCAxemIwIE9wMCAxemIwIE9wMCAxemIwIE9wMCAxemIwfDIzZTUiLAoJCQkiQW50YXJjdGljYS9QYWxtZXJ8LTAzIC0wNHwzMCA0MHwwMTAxMHwxTFNQMCBSZDAgNDZuMCBBcDB8NDAiLAoJCQkiQW1lcmljYS9TYW50aWFnb3wtMDMgLTA0fDMwIDQwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTFNQMCBSZDAgNDZuMCBBcDAgMU5iMCBBcDAgMU5iMCBBcDAgMXpiMCAxMUIwIDFuWDAgMTFCMCAxblgwIDExQjAgMW5YMCAxMUIwIDFuWDAgMTFCMCAxcUwwIDExQjB8NjJlNSIsCgkJCSJBbWVyaWNhL1Nhb19QYXVsb3wtMDIgLTAzfDIwIDMwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMcU8wIDFDMTAgT24wIDF6ZDAgT24wIDF6ZDAgT24wIDF6ZDAgT24wIDFIQjAgRlgwIDFIQjAgRlgwIDFIQjAgSUwwIDFIQjAgRlgwIDFIQjAgSUwwIDFFTjAgRlgwIDFIQjB8MjBlNiIsCgkJCSJBdGxhbnRpYy9Bem9yZXN8LTAxICswMHwxMCAwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMSEIwIDFvMDAgMTFBMCAxbzAwIDExQTAgMXFNMCBXTTAgMXFNMCBXTTAgMXFNMCAxMUEwIDFvMDAgMTFBMCAxbzAwIDExQTAgMXFNMCBXTTAgMXFNMCBXTTAgMXFNMCAxMUEwIDFvMDB8MjVlNCIsCgkJCSJBbWVyaWNhL1N0X0pvaG5zfE5TVCBORFR8M3UgMnV8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUx6aHUgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBSZDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMCBPcDAgMXpiMHwxMWU0IiwKCQkJIkFudGFyY3RpY2EvQ2FzZXl8KzA4ICsxMXwtODAgLWIwfDAxMHwxUldnMCAzbTEwfDEwIiwKCQkJIkFzaWEvQmFuZ2tva3wrMDd8LTcwfDB8fDE1ZTYiLAoJCQkiUGFjaWZpYy9Qb3J0X01vcmVzYnl8KzEwfC1hMHwwfHwyNWU0IiwKCQkJIlBhY2lmaWMvR3VhZGFsY2FuYWx8KzExfC1iMHwwfHwxMWU0IiwKCQkJIkFzaWEvVGFzaGtlbnR8KzA1fC01MHwwfHwyM2U1IiwKCQkJIlBhY2lmaWMvQXVja2xhbmR8TlpEVCBOWlNUfC1kMCAtYzB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxLZTAgMWEwMCAxZkEwIDFhMDAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxZkEwIDFjTTAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxZkEwIDFhMDAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxaW8wIDFhMDB8MTRlNSIsCgkJCSJBc2lhL0JhZ2hkYWR8KzAzfC0zMHwwfHw2NmU1IiwKCQkJIkFudGFyY3RpY2EvVHJvbGx8KzAwICswMnwwIC0yMHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTEhCMCAxbzAwIDExQTAgMW8wMCAxMUEwIDFxTTAgV00wIDFxTTAgV00wIDFxTTAgMTFBMCAxbzAwIDExQTAgMW8wMCAxMUEwIDFxTTAgV00wIDFxTTAgV00wIDFxTTAgMTFBMCAxbzAwfDQwIiwKCQkJIkFzaWEvRGhha2F8KzA2fC02MHwwfHwxNmU2IiwKCQkJIkFzaWEvQW1tYW58RUVUIEVFU1R8LTIwIC0zMHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTEdLMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxbzAwIDExQTAgMW8wMCAxMUEwIDFxTTAgV00wIDFxTTAgMTFBMCAxbzAwIDExQTAgMW8wMCAxMUEwIDFvMDB8MjVlNSIsCgkJCSJBc2lhL0thbWNoYXRrYXwrMTJ8LWMwfDB8fDE4ZTQiLAoJCQkiQXNpYS9CYWt1fCswNCArMDV8LTQwIC01MHwwMTAxMHwxTEhBMCAxbzAwIDExQTAgMW8wMHwyN2U1IiwKCQkJIkFzaWEvQmFybmF1bHwrMDcgKzA2fC03MCAtNjB8MDEwfDFON3YwIDNyZDAiLAoJCQkiQXNpYS9CZWlydXR8RUVUIEVFU1R8LTIwIC0zMHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTEh5MCAxblgwIDExQjAgMW5YMCAxMUIwIDFxTDAgV04wIDFxTDAgV04wIDFxTDAgMTFCMCAxblgwIDExQjAgMW5YMCAxMUIwIDFxTDAgV04wIDFxTDAgV04wIDFxTDAgMTFCMCAxblgwfDIyZTUiLAoJCQkiQXNpYS9LdWFsYV9MdW1wdXJ8KzA4fC04MHwwfHw3MWU1IiwKCQkJIkFzaWEvS29sa2F0YXxJU1R8LTV1fDB8fDE1ZTYiLAoJCQkiQXNpYS9DaGl0YXwrMTAgKzA4ICswOXwtYTAgLTgwIC05MHwwMTJ8MU43czAgM3JlMHwzM2U0IiwKCQkJIkFzaWEvVWxhYW5iYWF0YXJ8KzA4ICswOXwtODAgLTkwfDAxMDEwfDFPOEcwIDFjSjAgMWNQMCAxY0owfDEyZTUiLAoJCQkiQXNpYS9TaGFuZ2hhaXxDU1R8LTgwfDB8fDIzZTYiLAoJCQkiQXNpYS9Db2xvbWJvfCswNTMwfC01dXwwfHwyMmU1IiwKCQkJIkFzaWEvRGFtYXNjdXN8RUVUIEVFU1R8LTIwIC0zMHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTEdLMCAxcUwwIFdOMCAxcUwwIFdOMCAxcUwwIDExQjAgMW5YMCAxMUIwIDFuWDAgMTFCMCAxblgwIDExQjAgMXFMMCBXTjAgMXFMMCBXTjAgMXFMMCAxMUIwIDFuWDAgMTFCMCAxblgwfDI2ZTUiLAoJCQkiQXNpYS9EaWxpfCswOXwtOTB8MHx8MTllNCIsCgkJCSJBc2lhL0R1YmFpfCswNHwtNDB8MHx8MzllNSIsCgkJCSJBc2lhL0ZhbWFndXN0YXxFRVQgRUVTVCArMDN8LTIwIC0zMCAtMzB8MDEwMTAxMjAxMDEwMTAxMDEwMTAxMHwxTEhCMCAxbzAwIDExQTAgMW8wMCAxMUEwIDE1VTAgMktzMCBXTTAgMXFNMCAxMUEwIDFvMDAgMTFBMCAxbzAwIDExQTAgMXFNMCBXTTAgMXFNMCBXTTAgMXFNMCAxMUEwIDFvMDAiLAoJCQkiQXNpYS9HYXphfEVFVCBFRVNUfC0yMCAtMzB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxHSzAgMW5YMCAxMjEwIDFuejAgMTIyMCAxcUwwIFdOMCAxcUwwIFdOMCAxcUwwIDExQjAgMW5YMCAxMUIwIDFxTDAgV04wIDFxTDAgV04wIDFxTDAgV04wIDFxTDAgMTFCMCAxblgwfDE4ZTUiLAoJCQkiQXNpYS9Ib25nX0tvbmd8SEtUfC04MHwwfHw3M2U1IiwKCQkJIkFzaWEvSG92ZHwrMDcgKzA4fC03MCAtODB8MDEwMTB8MU84SDAgMWNKMCAxY1AwIDFjSjB8ODFlMyIsCgkJCSJBc2lhL0lya3V0c2t8KzA5ICswOHwtOTAgLTgwfDAxfDFON3QwfDYwZTQiLAoJCQkiRXVyb3BlL0lzdGFuYnVsfEVFVCBFRVNUICswM3wtMjAgLTMwIC0zMHwwMTAxMDEyfDFMSTEwIDFuQTAgMTFBMCAxdEEwIFUwMCAxNXcwfDEzZTYiLAoJCQkiQXNpYS9KYWthcnRhfFdJQnwtNzB8MHx8MzFlNiIsCgkJCSJBc2lhL0pheWFwdXJhfFdJVHwtOTB8MHx8MjZlNCIsCgkJCSJBc2lhL0plcnVzYWxlbXxJU1QgSURUfC0yMCAtMzB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxHTTAgMW9MMCAxME4wIDFvTDAgMTBOMCAxcnowIFcxMCAxcnowIFcxMCAxcnowIDEwTjAgMW9MMCAxME4wIDFvTDAgMTBOMCAxcnowIFcxMCAxcnowIFcxMCAxcnowIDEwTjAgMW9MMHw4MWU0IiwKCQkJIkFzaWEvS2FidWx8KzA0MzB8LTR1fDB8fDQ2ZTUiLAoJCQkiQXNpYS9LYXJhY2hpfFBLVHwtNTB8MHx8MjRlNiIsCgkJCSJBc2lhL0thdGhtYW5kdXwrMDU0NXwtNUp8MHx8MTJlNSIsCgkJCSJBc2lhL1lha3V0c2t8KzEwICswOXwtYTAgLTkwfDAxfDFON3MwfDI4ZTQiLAoJCQkiQXNpYS9LcmFzbm95YXJza3wrMDggKzA3fC04MCAtNzB8MDF8MU43dTB8MTBlNSIsCgkJCSJBc2lhL01hZ2FkYW58KzEyICsxMCArMTF8LWMwIC1hMCAtYjB8MDEyfDFON3EwIDNDcTB8OTVlMyIsCgkJCSJBc2lhL01ha2Fzc2FyfFdJVEF8LTgwfDB8fDE1ZTUiLAoJCQkiQXNpYS9NYW5pbGF8UFNUfC04MHwwfHwyNGU2IiwKCQkJIkV1cm9wZS9BdGhlbnN8RUVUIEVFU1R8LTIwIC0zMHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTEhCMCAxbzAwIDExQTAgMW8wMCAxMUEwIDFxTTAgV00wIDFxTTAgV00wIDFxTTAgMTFBMCAxbzAwIDExQTAgMW8wMCAxMUEwIDFxTTAgV00wIDFxTTAgV00wIDFxTTAgMTFBMCAxbzAwfDM1ZTUiLAoJCQkiQXNpYS9Ob3Zvc2liaXJza3wrMDcgKzA2fC03MCAtNjB8MDEwfDFON3YwIDRlTjB8MTVlNSIsCgkJCSJBc2lhL09tc2t8KzA3ICswNnwtNzAgLTYwfDAxfDFON3YwfDEyZTUiLAoJCQkiQXNpYS9QeW9uZ3lhbmd8S1NUIEtTVHwtOTAgLTh1fDAxMHwxUDREMCA2QkEwfDI5ZTUiLAoJCQkiQXNpYS9ReXp5bG9yZGF8KzA2ICswNXwtNjAgLTUwfDAxfDFYZWkwfDczZTQiLAoJCQkiQXNpYS9SYW5nb29ufCswNjMwfC02dXwwfHw0OGU1IiwKCQkJIkFzaWEvU2FraGFsaW58KzExICsxMHwtYjAgLWEwfDAxMHwxTjdyMCAzcmQwfDU4ZTQiLAoJCQkiQXNpYS9TZW91bHxLU1R8LTkwfDB8fDIzZTYiLAoJCQkiQXNpYS9TcmVkbmVrb2x5bXNrfCsxMiArMTF8LWMwIC1iMHwwMXwxTjdxMHwzNWUyIiwKCQkJIkFzaWEvVGVocmFufCswMzMwICswNDMwfC0zdSAtNHV8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxFa3UgMWR6MCAxY3AwIDFkejAgMWNwMCAxZHowIDFjTjAgMWR6MCAxY3AwIDFkejAgMWNwMCAxZHowIDFjcDAgMWR6MCAxY04wIDFkejAgMWNwMCAxZHowIDFjcDAgMWR6MCAxY3AwIDFkejB8MTRlNiIsCgkJCSJBc2lhL1Rva3lvfEpTVHwtOTB8MHx8MzhlNiIsCgkJCSJBc2lhL1RvbXNrfCswNyArMDZ8LTcwIC02MHwwMTB8MU43djAgM1FwMHwxMGU1IiwKCQkJIkFzaWEvVmxhZGl2b3N0b2t8KzExICsxMHwtYjAgLWEwfDAxfDFON3IwfDYwZTQiLAoJCQkiQXNpYS9ZZWthdGVyaW5idXJnfCswNiArMDV8LTYwIC01MHwwMXwxTjd3MHwxNGU1IiwKCQkJIkV1cm9wZS9MaXNib258V0VUIFdFU1R8MCAtMTB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxIQjAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxcU0wIFdNMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxcU0wIFdNMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMHwyN2U1IiwKCQkJIkF0bGFudGljL0NhcGVfVmVyZGV8LTAxfDEwfDB8fDUwZTQiLAoJCQkiQXVzdHJhbGlhL1N5ZG5leXxBRURUIEFFU1R8LWIwIC1hMHwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTEtnMCAxY00wIDFjTTAgMWNNMCAxY00wIDFjTTAgMWNNMCAxY00wIDFjTTAgMWZBMCAxY00wIDFjTTAgMWNNMCAxY00wIDFjTTAgMWNNMCAxY00wIDFjTTAgMWNNMCAxY00wIDFmQTAgMWNNMHw0MGU1IiwKCQkJIkF1c3RyYWxpYS9BZGVsYWlkZXxBQ0RUIEFDU1R8LWF1IC05dXwwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTEtndSAxY00wIDFjTTAgMWNNMCAxY00wIDFjTTAgMWNNMCAxY00wIDFjTTAgMWZBMCAxY00wIDFjTTAgMWNNMCAxY00wIDFjTTAgMWNNMCAxY00wIDFjTTAgMWNNMCAxY00wIDFmQTAgMWNNMHwxMWU1IiwKCQkJIkF1c3RyYWxpYS9CcmlzYmFuZXxBRVNUfC1hMHwwfHwyMGU1IiwKCQkJIkF1c3RyYWxpYS9EYXJ3aW58QUNTVHwtOXV8MHx8MTJlNCIsCgkJCSJBdXN0cmFsaWEvRXVjbGF8KzA4NDV8LThKfDB8fDM2OCIsCgkJCSJBdXN0cmFsaWEvTG9yZF9Ib3dlfCsxMSArMTAzMHwtYjAgLWF1fDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMS2YwIDFjTXUgMWNMdSAxY011IDFjTHUgMWNNdSAxY0x1IDFjTXUgMWNMdSAxZkF1IDFjTHUgMWNNdSAxY0x1IDFjTXUgMWNMdSAxY011IDFjTHUgMWNNdSAxY0x1IDFjTXUgMWZ6dSAxY011fDM0NyIsCgkJCSJBdXN0cmFsaWEvUGVydGh8QVdTVHwtODB8MHx8MThlNSIsCgkJCSJQYWNpZmljL0Vhc3RlcnwtMDUgLTA2fDUwIDYwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMHwxTFNQMCBSZDAgNDZuMCBBcDAgMU5iMCBBcDAgMU5iMCBBcDAgMXpiMCAxMUIwIDFuWDAgMTFCMCAxblgwIDExQjAgMW5YMCAxMUIwIDFuWDAgMTFCMCAxcUwwIDExQjB8MzBlMiIsCgkJCSJFdXJvcGUvRHVibGlufEdNVCBJU1R8MCAtMTB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxIQjAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxcU0wIFdNMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxcU0wIFdNMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMHwxMmU1IiwKCQkJIkV0Yy9HTVQtMXwrMDF8LTEwfDB8IiwKCQkJIlBhY2lmaWMvRmFrYW9mb3wrMTN8LWQwfDB8fDQ4MyIsCgkJCSJQYWNpZmljL0tpcml0aW1hdGl8KzE0fC1lMHwwfHw1MWUyIiwKCQkJIkV0Yy9HTVQtMnwrMDJ8LTIwfDB8IiwKCQkJIlBhY2lmaWMvVGFoaXRpfC0xMHxhMHwwfHwxOGU0IiwKCQkJIlBhY2lmaWMvTml1ZXwtMTF8YjB8MHx8MTJlMiIsCgkJCSJFdGMvR01UKzEyfC0xMnxjMHwwfCIsCgkJCSJQYWNpZmljL0dhbGFwYWdvc3wtMDZ8NjB8MHx8MjVlMyIsCgkJCSJFdGMvR01UKzd8LTA3fDcwfDB8IiwKCQkJIlBhY2lmaWMvUGl0Y2Fpcm58LTA4fDgwfDB8fDU2IiwKCQkJIlBhY2lmaWMvR2FtYmllcnwtMDl8OTB8MHx8MTI1IiwKCQkJIkV0Yy9VVEN8VVRDfDB8MHwiLAoJCQkiRXVyb3BlL1VseWFub3Zza3wrMDQgKzAzfC00MCAtMzB8MDEwfDFON3kwIDNyZDB8MTNlNSIsCgkJCSJFdXJvcGUvTG9uZG9ufEdNVCBCU1R8MCAtMTB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxIQjAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxcU0wIFdNMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMCAxMUEwIDFvMDAgMTFBMCAxcU0wIFdNMCAxcU0wIFdNMCAxcU0wIDExQTAgMW8wMHwxMGU2IiwKCQkJIkV1cm9wZS9DaGlzaW5hdXxFRVQgRUVTVHwtMjAgLTMwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMSEEwIDFvMDAgMTFBMCAxbzAwIDExQTAgMXFNMCBXTTAgMXFNMCBXTTAgMXFNMCAxMUEwIDFvMDAgMTFBMCAxbzAwIDExQTAgMXFNMCBXTTAgMXFNMCBXTTAgMXFNMCAxMUEwIDFvMDB8NjdlNCIsCgkJCSJFdXJvcGUvS2FsaW5pbmdyYWR8KzAzIEVFVHwtMzAgLTIwfDAxfDFON3owfDQ0ZTQiLAoJCQkiRXVyb3BlL0tpcm92fCswNCArMDN8LTQwIC0zMHwwMXwxTjd5MHw0OGU0IiwKCQkJIkV1cm9wZS9Nb3Njb3d8TVNLIE1TS3wtNDAgLTMwfDAxfDFON3kwfDE2ZTYiLAoJCQkiRXVyb3BlL1NhcmF0b3Z8KzA0ICswM3wtNDAgLTMwfDAxMHwxTjd5MCA1ODEwIiwKCQkJIkV1cm9wZS9TaW1mZXJvcG9sfEVFVCBNU0sgTVNLfC0yMCAtNDAgLTMwfDAxMnwxTEhBMCAxblcwfDMzZTQiLAoJCQkiRXVyb3BlL1ZvbGdvZ3JhZHwrMDQgKzAzfC00MCAtMzB8MDEwfDFON3kwIDlKZDB8MTBlNSIsCgkJCSJQYWNpZmljL0hvbm9sdWx1fEhTVHxhMHwwfHwzN2U0IiwKCQkJIk1FVHxNRVQgTUVTVHwtMTAgLTIwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMSEIwIDFvMDAgMTFBMCAxbzAwIDExQTAgMXFNMCBXTTAgMXFNMCBXTTAgMXFNMCAxMUEwIDFvMDAgMTFBMCAxbzAwIDExQTAgMXFNMCBXTTAgMXFNMCBXTTAgMXFNMCAxMUEwIDFvMDAiLAoJCQkiUGFjaWZpYy9DaGF0aGFtfCsxMzQ1ICsxMjQ1fC1kSiAtY0p8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxLZTAgMWEwMCAxZkEwIDFhMDAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxZkEwIDFjTTAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxZkEwIDFhMDAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxaW8wIDFhMDB8NjAwIiwKCQkJIlBhY2lmaWMvQXBpYXwrMTQgKzEzfC1lMCAtZDB8MDEwMTAxMDEwMTAxMDEwMTAxMDEwMTB8MUxLZTAgMWEwMCAxZkEwIDFhMDAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxZkEwIDFjTTAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxZkEwIDFhMDAgMWZBMCAxYTAwIDFmQTAgMWEwMCAxaW8wIDFhMDB8MzdlMyIsCgkJCSJQYWNpZmljL0JvdWdhaW52aWxsZXwrMTAgKzExfC1hMCAtYjB8MDF8MU53RTB8MThlNCIsCgkJCSJQYWNpZmljL0Zpaml8KzEzICsxMnwtZDAgLWMwfDAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwfDFMZnAwIDFTTjAgdU0wIDFTTTAgdU0wIDFWQTAgczAwIDFWQTAgczAwIDFWQTAgczAwIDFWQTAgdU0wIDFTTTAgdU0wIDFWQTAgczAwIDFWQTAgczAwIDFWQTAgczAwIDFWQTB8ODhlNCIsCgkJCSJQYWNpZmljL0d1YW18Q2hTVHwtYTB8MHx8MTdlNCIsCgkJCSJQYWNpZmljL01hcnF1ZXNhc3wtMDkzMHw5dXwwfHw4NmUyIiwKCQkJIlBhY2lmaWMvUGFnb19QYWdvfFNTVHxiMHwwfHwzN2UyIiwKCQkJIlBhY2lmaWMvTm9yZm9sa3wrMTEzMCArMTF8LWJ1IC1iMHwwMXwxUG9DdXwyNWU0IiwKCQkJIlBhY2lmaWMvVG9uZ2F0YXB1fCsxMyArMTR8LWQwIC1lMHwwMTB8MVM0ZDAgczAwfDc1ZTMiCgkJXSwKCQkibGlua3MiOiBbCgkJCSJBZnJpY2EvQWJpZGphbnxBZnJpY2EvQWNjcmEiLAoJCQkiQWZyaWNhL0FiaWRqYW58QWZyaWNhL0JhbWFrbyIsCgkJCSJBZnJpY2EvQWJpZGphbnxBZnJpY2EvQmFuanVsIiwKCQkJIkFmcmljYS9BYmlkamFufEFmcmljYS9CaXNzYXUiLAoJCQkiQWZyaWNhL0FiaWRqYW58QWZyaWNhL0NvbmFrcnkiLAoJCQkiQWZyaWNhL0FiaWRqYW58QWZyaWNhL0Rha2FyIiwKCQkJIkFmcmljYS9BYmlkamFufEFmcmljYS9GcmVldG93biIsCgkJCSJBZnJpY2EvQWJpZGphbnxBZnJpY2EvTG9tZSIsCgkJCSJBZnJpY2EvQWJpZGphbnxBZnJpY2EvTW9ucm92aWEiLAoJCQkiQWZyaWNhL0FiaWRqYW58QWZyaWNhL05vdWFrY2hvdHQiLAoJCQkiQWZyaWNhL0FiaWRqYW58QWZyaWNhL091YWdhZG91Z291IiwKCQkJIkFmcmljYS9BYmlkamFufEFmcmljYS9UaW1idWt0dSIsCgkJCSJBZnJpY2EvQWJpZGphbnxBbWVyaWNhL0Rhbm1hcmtzaGF2biIsCgkJCSJBZnJpY2EvQWJpZGphbnxBdGxhbnRpYy9SZXlramF2aWsiLAoJCQkiQWZyaWNhL0FiaWRqYW58QXRsYW50aWMvU3RfSGVsZW5hIiwKCQkJIkFmcmljYS9BYmlkamFufEV0Yy9HTVQiLAoJCQkiQWZyaWNhL0FiaWRqYW58RXRjL0dNVCswIiwKCQkJIkFmcmljYS9BYmlkamFufEV0Yy9HTVQtMCIsCgkJCSJBZnJpY2EvQWJpZGphbnxFdGMvR01UMCIsCgkJCSJBZnJpY2EvQWJpZGphbnxFdGMvR3JlZW53aWNoIiwKCQkJIkFmcmljYS9BYmlkamFufEdNVCIsCgkJCSJBZnJpY2EvQWJpZGphbnxHTVQrMCIsCgkJCSJBZnJpY2EvQWJpZGphbnxHTVQtMCIsCgkJCSJBZnJpY2EvQWJpZGphbnxHTVQwIiwKCQkJIkFmcmljYS9BYmlkamFufEdyZWVud2ljaCIsCgkJCSJBZnJpY2EvQWJpZGphbnxJY2VsYW5kIiwKCQkJIkFmcmljYS9BbGdpZXJzfEFmcmljYS9UdW5pcyIsCgkJCSJBZnJpY2EvQ2Fpcm98RWd5cHQiLAoJCQkiQWZyaWNhL0Nhc2FibGFuY2F8QWZyaWNhL0VsX0FhaXVuIiwKCQkJIkFmcmljYS9Kb2hhbm5lc2J1cmd8QWZyaWNhL01hc2VydSIsCgkJCSJBZnJpY2EvSm9oYW5uZXNidXJnfEFmcmljYS9NYmFiYW5lIiwKCQkJIkFmcmljYS9MYWdvc3xBZnJpY2EvQmFuZ3VpIiwKCQkJIkFmcmljYS9MYWdvc3xBZnJpY2EvQnJhenphdmlsbGUiLAoJCQkiQWZyaWNhL0xhZ29zfEFmcmljYS9Eb3VhbGEiLAoJCQkiQWZyaWNhL0xhZ29zfEFmcmljYS9LaW5zaGFzYSIsCgkJCSJBZnJpY2EvTGFnb3N8QWZyaWNhL0xpYnJldmlsbGUiLAoJCQkiQWZyaWNhL0xhZ29zfEFmcmljYS9MdWFuZGEiLAoJCQkiQWZyaWNhL0xhZ29zfEFmcmljYS9NYWxhYm8iLAoJCQkiQWZyaWNhL0xhZ29zfEFmcmljYS9OZGphbWVuYSIsCgkJCSJBZnJpY2EvTGFnb3N8QWZyaWNhL05pYW1leSIsCgkJCSJBZnJpY2EvTGFnb3N8QWZyaWNhL1BvcnRvLU5vdm8iLAoJCQkiQWZyaWNhL01hcHV0b3xBZnJpY2EvQmxhbnR5cmUiLAoJCQkiQWZyaWNhL01hcHV0b3xBZnJpY2EvQnVqdW1idXJhIiwKCQkJIkFmcmljYS9NYXB1dG98QWZyaWNhL0dhYm9yb25lIiwKCQkJIkFmcmljYS9NYXB1dG98QWZyaWNhL0hhcmFyZSIsCgkJCSJBZnJpY2EvTWFwdXRvfEFmcmljYS9LaWdhbGkiLAoJCQkiQWZyaWNhL01hcHV0b3xBZnJpY2EvTHVidW1iYXNoaSIsCgkJCSJBZnJpY2EvTWFwdXRvfEFmcmljYS9MdXNha2EiLAoJCQkiQWZyaWNhL05haXJvYml8QWZyaWNhL0FkZGlzX0FiYWJhIiwKCQkJIkFmcmljYS9OYWlyb2JpfEFmcmljYS9Bc21hcmEiLAoJCQkiQWZyaWNhL05haXJvYml8QWZyaWNhL0FzbWVyYSIsCgkJCSJBZnJpY2EvTmFpcm9iaXxBZnJpY2EvRGFyX2VzX1NhbGFhbSIsCgkJCSJBZnJpY2EvTmFpcm9iaXxBZnJpY2EvRGppYm91dGkiLAoJCQkiQWZyaWNhL05haXJvYml8QWZyaWNhL0p1YmEiLAoJCQkiQWZyaWNhL05haXJvYml8QWZyaWNhL0thbXBhbGEiLAoJCQkiQWZyaWNhL05haXJvYml8QWZyaWNhL01vZ2FkaXNodSIsCgkJCSJBZnJpY2EvTmFpcm9iaXxJbmRpYW4vQW50YW5hbmFyaXZvIiwKCQkJIkFmcmljYS9OYWlyb2JpfEluZGlhbi9Db21vcm8iLAoJCQkiQWZyaWNhL05haXJvYml8SW5kaWFuL01heW90dGUiLAoJCQkiQWZyaWNhL1RyaXBvbGl8TGlieWEiLAoJCQkiQW1lcmljYS9BZGFrfEFtZXJpY2EvQXRrYSIsCgkJCSJBbWVyaWNhL0FkYWt8VVMvQWxldXRpYW4iLAoJCQkiQW1lcmljYS9BbmNob3JhZ2V8QW1lcmljYS9KdW5lYXUiLAoJCQkiQW1lcmljYS9BbmNob3JhZ2V8QW1lcmljYS9Ob21lIiwKCQkJIkFtZXJpY2EvQW5jaG9yYWdlfEFtZXJpY2EvU2l0a2EiLAoJCQkiQW1lcmljYS9BbmNob3JhZ2V8QW1lcmljYS9ZYWt1dGF0IiwKCQkJIkFtZXJpY2EvQW5jaG9yYWdlfFVTL0FsYXNrYSIsCgkJCSJBbWVyaWNhL0NhbXBvX0dyYW5kZXxBbWVyaWNhL0N1aWFiYSIsCgkJCSJBbWVyaWNhL0NoaWNhZ298QW1lcmljYS9JbmRpYW5hL0tub3giLAoJCQkiQW1lcmljYS9DaGljYWdvfEFtZXJpY2EvSW5kaWFuYS9UZWxsX0NpdHkiLAoJCQkiQW1lcmljYS9DaGljYWdvfEFtZXJpY2EvS25veF9JTiIsCgkJCSJBbWVyaWNhL0NoaWNhZ298QW1lcmljYS9NYXRhbW9yb3MiLAoJCQkiQW1lcmljYS9DaGljYWdvfEFtZXJpY2EvTWVub21pbmVlIiwKCQkJIkFtZXJpY2EvQ2hpY2Fnb3xBbWVyaWNhL05vcnRoX0Rha290YS9CZXVsYWgiLAoJCQkiQW1lcmljYS9DaGljYWdvfEFtZXJpY2EvTm9ydGhfRGFrb3RhL0NlbnRlciIsCgkJCSJBbWVyaWNhL0NoaWNhZ298QW1lcmljYS9Ob3J0aF9EYWtvdGEvTmV3X1NhbGVtIiwKCQkJIkFtZXJpY2EvQ2hpY2Fnb3xBbWVyaWNhL1JhaW55X1JpdmVyIiwKCQkJIkFtZXJpY2EvQ2hpY2Fnb3xBbWVyaWNhL1Jhbmtpbl9JbmxldCIsCgkJCSJBbWVyaWNhL0NoaWNhZ298QW1lcmljYS9SZXNvbHV0ZSIsCgkJCSJBbWVyaWNhL0NoaWNhZ298QW1lcmljYS9XaW5uaXBlZyIsCgkJCSJBbWVyaWNhL0NoaWNhZ298Q1NUNkNEVCIsCgkJCSJBbWVyaWNhL0NoaWNhZ298Q2FuYWRhL0NlbnRyYWwiLAoJCQkiQW1lcmljYS9DaGljYWdvfFVTL0NlbnRyYWwiLAoJCQkiQW1lcmljYS9DaGljYWdvfFVTL0luZGlhbmEtU3RhcmtlIiwKCQkJIkFtZXJpY2EvQ2hpaHVhaHVhfEFtZXJpY2EvTWF6YXRsYW4iLAoJCQkiQW1lcmljYS9DaGlodWFodWF8TWV4aWNvL0JhamFTdXIiLAoJCQkiQW1lcmljYS9EZW52ZXJ8QW1lcmljYS9Cb2lzZSIsCgkJCSJBbWVyaWNhL0RlbnZlcnxBbWVyaWNhL0NhbWJyaWRnZV9CYXkiLAoJCQkiQW1lcmljYS9EZW52ZXJ8QW1lcmljYS9FZG1vbnRvbiIsCgkJCSJBbWVyaWNhL0RlbnZlcnxBbWVyaWNhL0ludXZpayIsCgkJCSJBbWVyaWNhL0RlbnZlcnxBbWVyaWNhL09qaW5hZ2EiLAoJCQkiQW1lcmljYS9EZW52ZXJ8QW1lcmljYS9TaGlwcm9jayIsCgkJCSJBbWVyaWNhL0RlbnZlcnxBbWVyaWNhL1llbGxvd2tuaWZlIiwKCQkJIkFtZXJpY2EvRGVudmVyfENhbmFkYS9Nb3VudGFpbiIsCgkJCSJBbWVyaWNhL0RlbnZlcnxNU1Q3TURUIiwKCQkJIkFtZXJpY2EvRGVudmVyfE5hdmFqbyIsCgkJCSJBbWVyaWNhL0RlbnZlcnxVUy9Nb3VudGFpbiIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL0FyYWd1YWluYSIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL0FyZ2VudGluYS9CdWVub3NfQWlyZXMiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9BcmdlbnRpbmEvQ2F0YW1hcmNhIiwKCQkJIkFtZXJpY2EvRm9ydGFsZXphfEFtZXJpY2EvQXJnZW50aW5hL0NvbW9kUml2YWRhdmlhIiwKCQkJIkFtZXJpY2EvRm9ydGFsZXphfEFtZXJpY2EvQXJnZW50aW5hL0NvcmRvYmEiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9BcmdlbnRpbmEvSnVqdXkiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9BcmdlbnRpbmEvTGFfUmlvamEiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9BcmdlbnRpbmEvTWVuZG96YSIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL0FyZ2VudGluYS9SaW9fR2FsbGVnb3MiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9BcmdlbnRpbmEvU2FsdGEiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9BcmdlbnRpbmEvU2FuX0p1YW4iLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9BcmdlbnRpbmEvU2FuX0x1aXMiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9BcmdlbnRpbmEvVHVjdW1hbiIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL0FyZ2VudGluYS9Vc2h1YWlhIiwKCQkJIkFtZXJpY2EvRm9ydGFsZXphfEFtZXJpY2EvQmFoaWEiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9CZWxlbSIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL0J1ZW5vc19BaXJlcyIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL0NhdGFtYXJjYSIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL0NheWVubmUiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9Db3Jkb2JhIiwKCQkJIkFtZXJpY2EvRm9ydGFsZXphfEFtZXJpY2EvSnVqdXkiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9NYWNlaW8iLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9NZW5kb3phIiwKCQkJIkFtZXJpY2EvRm9ydGFsZXphfEFtZXJpY2EvUGFyYW1hcmlibyIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL1JlY2lmZSIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbWVyaWNhL1Jvc2FyaW8iLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QW1lcmljYS9TYW50YXJlbSIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxBbnRhcmN0aWNhL1JvdGhlcmEiLAoJCQkiQW1lcmljYS9Gb3J0YWxlemF8QXRsYW50aWMvU3RhbmxleSIsCgkJCSJBbWVyaWNhL0ZvcnRhbGV6YXxFdGMvR01UKzMiLAoJCQkiQW1lcmljYS9IYWxpZmF4fEFtZXJpY2EvR2xhY2VfQmF5IiwKCQkJIkFtZXJpY2EvSGFsaWZheHxBbWVyaWNhL0dvb3NlX0JheSIsCgkJCSJBbWVyaWNhL0hhbGlmYXh8QW1lcmljYS9Nb25jdG9uIiwKCQkJIkFtZXJpY2EvSGFsaWZheHxBbWVyaWNhL1RodWxlIiwKCQkJIkFtZXJpY2EvSGFsaWZheHxBdGxhbnRpYy9CZXJtdWRhIiwKCQkJIkFtZXJpY2EvSGFsaWZheHxDYW5hZGEvQXRsYW50aWMiLAoJCQkiQW1lcmljYS9IYXZhbmF8Q3ViYSIsCgkJCSJBbWVyaWNhL0xhX1BhenxBbWVyaWNhL0JvYV9WaXN0YSIsCgkJCSJBbWVyaWNhL0xhX1BhenxBbWVyaWNhL0d1eWFuYSIsCgkJCSJBbWVyaWNhL0xhX1BhenxBbWVyaWNhL01hbmF1cyIsCgkJCSJBbWVyaWNhL0xhX1BhenxBbWVyaWNhL1BvcnRvX1ZlbGhvIiwKCQkJIkFtZXJpY2EvTGFfUGF6fEJyYXppbC9XZXN0IiwKCQkJIkFtZXJpY2EvTGFfUGF6fEV0Yy9HTVQrNCIsCgkJCSJBbWVyaWNhL0xpbWF8QW1lcmljYS9Cb2dvdGEiLAoJCQkiQW1lcmljYS9MaW1hfEFtZXJpY2EvRWlydW5lcGUiLAoJCQkiQW1lcmljYS9MaW1hfEFtZXJpY2EvR3VheWFxdWlsIiwKCQkJIkFtZXJpY2EvTGltYXxBbWVyaWNhL1BvcnRvX0FjcmUiLAoJCQkiQW1lcmljYS9MaW1hfEFtZXJpY2EvUmlvX0JyYW5jbyIsCgkJCSJBbWVyaWNhL0xpbWF8QnJhemlsL0FjcmUiLAoJCQkiQW1lcmljYS9MaW1hfEV0Yy9HTVQrNSIsCgkJCSJBbWVyaWNhL0xvc19BbmdlbGVzfEFtZXJpY2EvRGF3c29uIiwKCQkJIkFtZXJpY2EvTG9zX0FuZ2VsZXN8QW1lcmljYS9FbnNlbmFkYSIsCgkJCSJBbWVyaWNhL0xvc19BbmdlbGVzfEFtZXJpY2EvU2FudGFfSXNhYmVsIiwKCQkJIkFtZXJpY2EvTG9zX0FuZ2VsZXN8QW1lcmljYS9UaWp1YW5hIiwKCQkJIkFtZXJpY2EvTG9zX0FuZ2VsZXN8QW1lcmljYS9WYW5jb3V2ZXIiLAoJCQkiQW1lcmljYS9Mb3NfQW5nZWxlc3xBbWVyaWNhL1doaXRlaG9yc2UiLAoJCQkiQW1lcmljYS9Mb3NfQW5nZWxlc3xDYW5hZGEvUGFjaWZpYyIsCgkJCSJBbWVyaWNhL0xvc19BbmdlbGVzfENhbmFkYS9ZdWtvbiIsCgkJCSJBbWVyaWNhL0xvc19BbmdlbGVzfE1leGljby9CYWphTm9ydGUiLAoJCQkiQW1lcmljYS9Mb3NfQW5nZWxlc3xQU1Q4UERUIiwKCQkJIkFtZXJpY2EvTG9zX0FuZ2VsZXN8VVMvUGFjaWZpYyIsCgkJCSJBbWVyaWNhL0xvc19BbmdlbGVzfFVTL1BhY2lmaWMtTmV3IiwKCQkJIkFtZXJpY2EvTWFuYWd1YXxBbWVyaWNhL0JlbGl6ZSIsCgkJCSJBbWVyaWNhL01hbmFndWF8QW1lcmljYS9Db3N0YV9SaWNhIiwKCQkJIkFtZXJpY2EvTWFuYWd1YXxBbWVyaWNhL0VsX1NhbHZhZG9yIiwKCQkJIkFtZXJpY2EvTWFuYWd1YXxBbWVyaWNhL0d1YXRlbWFsYSIsCgkJCSJBbWVyaWNhL01hbmFndWF8QW1lcmljYS9SZWdpbmEiLAoJCQkiQW1lcmljYS9NYW5hZ3VhfEFtZXJpY2EvU3dpZnRfQ3VycmVudCIsCgkJCSJBbWVyaWNhL01hbmFndWF8QW1lcmljYS9UZWd1Y2lnYWxwYSIsCgkJCSJBbWVyaWNhL01hbmFndWF8Q2FuYWRhL1Nhc2thdGNoZXdhbiIsCgkJCSJBbWVyaWNhL01leGljb19DaXR5fEFtZXJpY2EvQmFoaWFfQmFuZGVyYXMiLAoJCQkiQW1lcmljYS9NZXhpY29fQ2l0eXxBbWVyaWNhL01lcmlkYSIsCgkJCSJBbWVyaWNhL01leGljb19DaXR5fEFtZXJpY2EvTW9udGVycmV5IiwKCQkJIkFtZXJpY2EvTWV4aWNvX0NpdHl8TWV4aWNvL0dlbmVyYWwiLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xBbWVyaWNhL0RldHJvaXQiLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xBbWVyaWNhL0ZvcnRfV2F5bmUiLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xBbWVyaWNhL0luZGlhbmEvSW5kaWFuYXBvbGlzIiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8QW1lcmljYS9JbmRpYW5hL01hcmVuZ28iLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xBbWVyaWNhL0luZGlhbmEvUGV0ZXJzYnVyZyIsCgkJCSJBbWVyaWNhL05ld19Zb3JrfEFtZXJpY2EvSW5kaWFuYS9WZXZheSIsCgkJCSJBbWVyaWNhL05ld19Zb3JrfEFtZXJpY2EvSW5kaWFuYS9WaW5jZW5uZXMiLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xBbWVyaWNhL0luZGlhbmEvV2luYW1hYyIsCgkJCSJBbWVyaWNhL05ld19Zb3JrfEFtZXJpY2EvSW5kaWFuYXBvbGlzIiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8QW1lcmljYS9JcWFsdWl0IiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8QW1lcmljYS9LZW50dWNreS9Mb3Vpc3ZpbGxlIiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8QW1lcmljYS9LZW50dWNreS9Nb250aWNlbGxvIiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8QW1lcmljYS9Mb3Vpc3ZpbGxlIiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8QW1lcmljYS9Nb250cmVhbCIsCgkJCSJBbWVyaWNhL05ld19Zb3JrfEFtZXJpY2EvTmFzc2F1IiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8QW1lcmljYS9OaXBpZ29uIiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8QW1lcmljYS9QYW5nbmlydHVuZyIsCgkJCSJBbWVyaWNhL05ld19Zb3JrfEFtZXJpY2EvVGh1bmRlcl9CYXkiLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xBbWVyaWNhL1Rvcm9udG8iLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xDYW5hZGEvRWFzdGVybiIsCgkJCSJBbWVyaWNhL05ld19Zb3JrfEVTVDVFRFQiLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xVUy9FYXN0LUluZGlhbmEiLAoJCQkiQW1lcmljYS9OZXdfWW9ya3xVUy9FYXN0ZXJuIiwKCQkJIkFtZXJpY2EvTmV3X1lvcmt8VVMvTWljaGlnYW4iLAoJCQkiQW1lcmljYS9Ob3JvbmhhfEF0bGFudGljL1NvdXRoX0dlb3JnaWEiLAoJCQkiQW1lcmljYS9Ob3JvbmhhfEJyYXppbC9EZU5vcm9uaGEiLAoJCQkiQW1lcmljYS9Ob3JvbmhhfEV0Yy9HTVQrMiIsCgkJCSJBbWVyaWNhL1BhbmFtYXxBbWVyaWNhL0F0aWtva2FuIiwKCQkJIkFtZXJpY2EvUGFuYW1hfEFtZXJpY2EvQ2F5bWFuIiwKCQkJIkFtZXJpY2EvUGFuYW1hfEFtZXJpY2EvQ29yYWxfSGFyYm91ciIsCgkJCSJBbWVyaWNhL1BhbmFtYXxBbWVyaWNhL0phbWFpY2EiLAoJCQkiQW1lcmljYS9QYW5hbWF8RVNUIiwKCQkJIkFtZXJpY2EvUGFuYW1hfEphbWFpY2EiLAoJCQkiQW1lcmljYS9QaG9lbml4fEFtZXJpY2EvQ3Jlc3RvbiIsCgkJCSJBbWVyaWNhL1Bob2VuaXh8QW1lcmljYS9EYXdzb25fQ3JlZWsiLAoJCQkiQW1lcmljYS9QaG9lbml4fEFtZXJpY2EvSGVybW9zaWxsbyIsCgkJCSJBbWVyaWNhL1Bob2VuaXh8TVNUIiwKCQkJIkFtZXJpY2EvUGhvZW5peHxVUy9Bcml6b25hIiwKCQkJIkFtZXJpY2EvU2FudGlhZ298Q2hpbGUvQ29udGluZW50YWwiLAoJCQkiQW1lcmljYS9TYW50b19Eb21pbmdvfEFtZXJpY2EvQW5ndWlsbGEiLAoJCQkiQW1lcmljYS9TYW50b19Eb21pbmdvfEFtZXJpY2EvQW50aWd1YSIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9BcnViYSIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9CYXJiYWRvcyIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9CbGFuYy1TYWJsb24iLAoJCQkiQW1lcmljYS9TYW50b19Eb21pbmdvfEFtZXJpY2EvQ3VyYWNhbyIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9Eb21pbmljYSIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9HcmVuYWRhIiwKCQkJIkFtZXJpY2EvU2FudG9fRG9taW5nb3xBbWVyaWNhL0d1YWRlbG91cGUiLAoJCQkiQW1lcmljYS9TYW50b19Eb21pbmdvfEFtZXJpY2EvS3JhbGVuZGlqayIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9Mb3dlcl9QcmluY2VzIiwKCQkJIkFtZXJpY2EvU2FudG9fRG9taW5nb3xBbWVyaWNhL01hcmlnb3QiLAoJCQkiQW1lcmljYS9TYW50b19Eb21pbmdvfEFtZXJpY2EvTWFydGluaXF1ZSIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9Nb250c2VycmF0IiwKCQkJIkFtZXJpY2EvU2FudG9fRG9taW5nb3xBbWVyaWNhL1BvcnRfb2ZfU3BhaW4iLAoJCQkiQW1lcmljYS9TYW50b19Eb21pbmdvfEFtZXJpY2EvUHVlcnRvX1JpY28iLAoJCQkiQW1lcmljYS9TYW50b19Eb21pbmdvfEFtZXJpY2EvU3RfQmFydGhlbGVteSIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9TdF9LaXR0cyIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9TdF9MdWNpYSIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9TdF9UaG9tYXMiLAoJCQkiQW1lcmljYS9TYW50b19Eb21pbmdvfEFtZXJpY2EvU3RfVmluY2VudCIsCgkJCSJBbWVyaWNhL1NhbnRvX0RvbWluZ298QW1lcmljYS9Ub3J0b2xhIiwKCQkJIkFtZXJpY2EvU2FudG9fRG9taW5nb3xBbWVyaWNhL1ZpcmdpbiIsCgkJCSJBbWVyaWNhL1Nhb19QYXVsb3xCcmF6aWwvRWFzdCIsCgkJCSJBbWVyaWNhL1N0X0pvaG5zfENhbmFkYS9OZXdmb3VuZGxhbmQiLAoJCQkiQW50YXJjdGljYS9QYWxtZXJ8QW1lcmljYS9QdW50YV9BcmVuYXMiLAoJCQkiQXNpYS9CYWdoZGFkfEFudGFyY3RpY2EvU3lvd2EiLAoJCQkiQXNpYS9CYWdoZGFkfEFzaWEvQWRlbiIsCgkJCSJBc2lhL0JhZ2hkYWR8QXNpYS9CYWhyYWluIiwKCQkJIkFzaWEvQmFnaGRhZHxBc2lhL0t1d2FpdCIsCgkJCSJBc2lhL0JhZ2hkYWR8QXNpYS9RYXRhciIsCgkJCSJBc2lhL0JhZ2hkYWR8QXNpYS9SaXlhZGgiLAoJCQkiQXNpYS9CYWdoZGFkfEV0Yy9HTVQtMyIsCgkJCSJBc2lhL0JhZ2hkYWR8RXVyb3BlL01pbnNrIiwKCQkJIkFzaWEvQmFuZ2tva3xBbnRhcmN0aWNhL0RhdmlzIiwKCQkJIkFzaWEvQmFuZ2tva3xBc2lhL0hvX0NoaV9NaW5oIiwKCQkJIkFzaWEvQmFuZ2tva3xBc2lhL05vdm9rdXpuZXRzayIsCgkJCSJBc2lhL0Jhbmdrb2t8QXNpYS9QaG5vbV9QZW5oIiwKCQkJIkFzaWEvQmFuZ2tva3xBc2lhL1NhaWdvbiIsCgkJCSJBc2lhL0Jhbmdrb2t8QXNpYS9WaWVudGlhbmUiLAoJCQkiQXNpYS9CYW5na29rfEV0Yy9HTVQtNyIsCgkJCSJBc2lhL0Jhbmdrb2t8SW5kaWFuL0NocmlzdG1hcyIsCgkJCSJBc2lhL0RoYWthfEFudGFyY3RpY2EvVm9zdG9rIiwKCQkJIkFzaWEvRGhha2F8QXNpYS9BbG1hdHkiLAoJCQkiQXNpYS9EaGFrYXxBc2lhL0Jpc2hrZWsiLAoJCQkiQXNpYS9EaGFrYXxBc2lhL0RhY2NhIiwKCQkJIkFzaWEvRGhha2F8QXNpYS9LYXNoZ2FyIiwKCQkJIkFzaWEvRGhha2F8QXNpYS9Rb3N0YW5heSIsCgkJCSJBc2lhL0RoYWthfEFzaWEvVGhpbWJ1IiwKCQkJIkFzaWEvRGhha2F8QXNpYS9UaGltcGh1IiwKCQkJIkFzaWEvRGhha2F8QXNpYS9VcnVtcWkiLAoJCQkiQXNpYS9EaGFrYXxFdGMvR01ULTYiLAoJCQkiQXNpYS9EaGFrYXxJbmRpYW4vQ2hhZ29zIiwKCQkJIkFzaWEvRGlsaXxFdGMvR01ULTkiLAoJCQkiQXNpYS9EaWxpfFBhY2lmaWMvUGFsYXUiLAoJCQkiQXNpYS9EdWJhaXxBc2lhL011c2NhdCIsCgkJCSJBc2lhL0R1YmFpfEFzaWEvVGJpbGlzaSIsCgkJCSJBc2lhL0R1YmFpfEFzaWEvWWVyZXZhbiIsCgkJCSJBc2lhL0R1YmFpfEV0Yy9HTVQtNCIsCgkJCSJBc2lhL0R1YmFpfEV1cm9wZS9TYW1hcmEiLAoJCQkiQXNpYS9EdWJhaXxJbmRpYW4vTWFoZSIsCgkJCSJBc2lhL0R1YmFpfEluZGlhbi9NYXVyaXRpdXMiLAoJCQkiQXNpYS9EdWJhaXxJbmRpYW4vUmV1bmlvbiIsCgkJCSJBc2lhL0dhemF8QXNpYS9IZWJyb24iLAoJCQkiQXNpYS9Ib25nX0tvbmd8SG9uZ2tvbmciLAoJCQkiQXNpYS9KYWthcnRhfEFzaWEvUG9udGlhbmFrIiwKCQkJIkFzaWEvSmVydXNhbGVtfEFzaWEvVGVsX0F2aXYiLAoJCQkiQXNpYS9KZXJ1c2FsZW18SXNyYWVsIiwKCQkJIkFzaWEvS2FtY2hhdGthfEFzaWEvQW5hZHlyIiwKCQkJIkFzaWEvS2FtY2hhdGthfEV0Yy9HTVQtMTIiLAoJCQkiQXNpYS9LYW1jaGF0a2F8S3dhamFsZWluIiwKCQkJIkFzaWEvS2FtY2hhdGthfFBhY2lmaWMvRnVuYWZ1dGkiLAoJCQkiQXNpYS9LYW1jaGF0a2F8UGFjaWZpYy9Ld2FqYWxlaW4iLAoJCQkiQXNpYS9LYW1jaGF0a2F8UGFjaWZpYy9NYWp1cm8iLAoJCQkiQXNpYS9LYW1jaGF0a2F8UGFjaWZpYy9OYXVydSIsCgkJCSJBc2lhL0thbWNoYXRrYXxQYWNpZmljL1RhcmF3YSIsCgkJCSJBc2lhL0thbWNoYXRrYXxQYWNpZmljL1dha2UiLAoJCQkiQXNpYS9LYW1jaGF0a2F8UGFjaWZpYy9XYWxsaXMiLAoJCQkiQXNpYS9LYXRobWFuZHV8QXNpYS9LYXRtYW5kdSIsCgkJCSJBc2lhL0tvbGthdGF8QXNpYS9DYWxjdXR0YSIsCgkJCSJBc2lhL0t1YWxhX0x1bXB1cnxBc2lhL0JydW5laSIsCgkJCSJBc2lhL0t1YWxhX0x1bXB1cnxBc2lhL0t1Y2hpbmciLAoJCQkiQXNpYS9LdWFsYV9MdW1wdXJ8QXNpYS9TaW5nYXBvcmUiLAoJCQkiQXNpYS9LdWFsYV9MdW1wdXJ8RXRjL0dNVC04IiwKCQkJIkFzaWEvS3VhbGFfTHVtcHVyfFNpbmdhcG9yZSIsCgkJCSJBc2lhL01ha2Fzc2FyfEFzaWEvVWp1bmdfUGFuZGFuZyIsCgkJCSJBc2lhL1Jhbmdvb258QXNpYS9ZYW5nb24iLAoJCQkiQXNpYS9SYW5nb29ufEluZGlhbi9Db2NvcyIsCgkJCSJBc2lhL1Nlb3VsfFJPSyIsCgkJCSJBc2lhL1NoYW5naGFpfEFzaWEvQ2hvbmdxaW5nIiwKCQkJIkFzaWEvU2hhbmdoYWl8QXNpYS9DaHVuZ2tpbmciLAoJCQkiQXNpYS9TaGFuZ2hhaXxBc2lhL0hhcmJpbiIsCgkJCSJBc2lhL1NoYW5naGFpfEFzaWEvTWFjYW8iLAoJCQkiQXNpYS9TaGFuZ2hhaXxBc2lhL01hY2F1IiwKCQkJIkFzaWEvU2hhbmdoYWl8QXNpYS9UYWlwZWkiLAoJCQkiQXNpYS9TaGFuZ2hhaXxQUkMiLAoJCQkiQXNpYS9TaGFuZ2hhaXxST0MiLAoJCQkiQXNpYS9UYXNoa2VudHxBbnRhcmN0aWNhL01hd3NvbiIsCgkJCSJBc2lhL1Rhc2hrZW50fEFzaWEvQXF0YXUiLAoJCQkiQXNpYS9UYXNoa2VudHxBc2lhL0FxdG9iZSIsCgkJCSJBc2lhL1Rhc2hrZW50fEFzaWEvQXNoZ2FiYXQiLAoJCQkiQXNpYS9UYXNoa2VudHxBc2lhL0FzaGtoYWJhZCIsCgkJCSJBc2lhL1Rhc2hrZW50fEFzaWEvQXR5cmF1IiwKCQkJIkFzaWEvVGFzaGtlbnR8QXNpYS9EdXNoYW5iZSIsCgkJCSJBc2lhL1Rhc2hrZW50fEFzaWEvT3JhbCIsCgkJCSJBc2lhL1Rhc2hrZW50fEFzaWEvU2FtYXJrYW5kIiwKCQkJIkFzaWEvVGFzaGtlbnR8RXRjL0dNVC01IiwKCQkJIkFzaWEvVGFzaGtlbnR8SW5kaWFuL0tlcmd1ZWxlbiIsCgkJCSJBc2lhL1Rhc2hrZW50fEluZGlhbi9NYWxkaXZlcyIsCgkJCSJBc2lhL1RlaHJhbnxJcmFuIiwKCQkJIkFzaWEvVG9reW98SmFwYW4iLAoJCQkiQXNpYS9VbGFhbmJhYXRhcnxBc2lhL0Nob2liYWxzYW4iLAoJCQkiQXNpYS9VbGFhbmJhYXRhcnxBc2lhL1VsYW5fQmF0b3IiLAoJCQkiQXNpYS9WbGFkaXZvc3Rva3xBc2lhL1VzdC1OZXJhIiwKCQkJIkFzaWEvWWFrdXRza3xBc2lhL0toYW5keWdhIiwKCQkJIkF0bGFudGljL0F6b3Jlc3xBbWVyaWNhL1Njb3Jlc2J5c3VuZCIsCgkJCSJBdGxhbnRpYy9DYXBlX1ZlcmRlfEV0Yy9HTVQrMSIsCgkJCSJBdXN0cmFsaWEvQWRlbGFpZGV8QXVzdHJhbGlhL0Jyb2tlbl9IaWxsIiwKCQkJIkF1c3RyYWxpYS9BZGVsYWlkZXxBdXN0cmFsaWEvU291dGgiLAoJCQkiQXVzdHJhbGlhL0FkZWxhaWRlfEF1c3RyYWxpYS9ZYW5jb3dpbm5hIiwKCQkJIkF1c3RyYWxpYS9CcmlzYmFuZXxBdXN0cmFsaWEvTGluZGVtYW4iLAoJCQkiQXVzdHJhbGlhL0JyaXNiYW5lfEF1c3RyYWxpYS9RdWVlbnNsYW5kIiwKCQkJIkF1c3RyYWxpYS9EYXJ3aW58QXVzdHJhbGlhL05vcnRoIiwKCQkJIkF1c3RyYWxpYS9Mb3JkX0hvd2V8QXVzdHJhbGlhL0xISSIsCgkJCSJBdXN0cmFsaWEvUGVydGh8QXVzdHJhbGlhL1dlc3QiLAoJCQkiQXVzdHJhbGlhL1N5ZG5leXxBdXN0cmFsaWEvQUNUIiwKCQkJIkF1c3RyYWxpYS9TeWRuZXl8QXVzdHJhbGlhL0NhbmJlcnJhIiwKCQkJIkF1c3RyYWxpYS9TeWRuZXl8QXVzdHJhbGlhL0N1cnJpZSIsCgkJCSJBdXN0cmFsaWEvU3lkbmV5fEF1c3RyYWxpYS9Ib2JhcnQiLAoJCQkiQXVzdHJhbGlhL1N5ZG5leXxBdXN0cmFsaWEvTWVsYm91cm5lIiwKCQkJIkF1c3RyYWxpYS9TeWRuZXl8QXVzdHJhbGlhL05TVyIsCgkJCSJBdXN0cmFsaWEvU3lkbmV5fEF1c3RyYWxpYS9UYXNtYW5pYSIsCgkJCSJBdXN0cmFsaWEvU3lkbmV5fEF1c3RyYWxpYS9WaWN0b3JpYSIsCgkJCSJFdGMvVVRDfEV0Yy9VQ1QiLAoJCQkiRXRjL1VUQ3xFdGMvVW5pdmVyc2FsIiwKCQkJIkV0Yy9VVEN8RXRjL1p1bHUiLAoJCQkiRXRjL1VUQ3xVQ1QiLAoJCQkiRXRjL1VUQ3xVVEMiLAoJCQkiRXRjL1VUQ3xVbml2ZXJzYWwiLAoJCQkiRXRjL1VUQ3xadWx1IiwKCQkJIkV1cm9wZS9BdGhlbnN8QXNpYS9OaWNvc2lhIiwKCQkJIkV1cm9wZS9BdGhlbnN8RUVUIiwKCQkJIkV1cm9wZS9BdGhlbnN8RXVyb3BlL0J1Y2hhcmVzdCIsCgkJCSJFdXJvcGUvQXRoZW5zfEV1cm9wZS9IZWxzaW5raSIsCgkJCSJFdXJvcGUvQXRoZW5zfEV1cm9wZS9LaWV2IiwKCQkJIkV1cm9wZS9BdGhlbnN8RXVyb3BlL01hcmllaGFtbiIsCgkJCSJFdXJvcGUvQXRoZW5zfEV1cm9wZS9OaWNvc2lhIiwKCQkJIkV1cm9wZS9BdGhlbnN8RXVyb3BlL1JpZ2EiLAoJCQkiRXVyb3BlL0F0aGVuc3xFdXJvcGUvU29maWEiLAoJCQkiRXVyb3BlL0F0aGVuc3xFdXJvcGUvVGFsbGlubiIsCgkJCSJFdXJvcGUvQXRoZW5zfEV1cm9wZS9Vemhnb3JvZCIsCgkJCSJFdXJvcGUvQXRoZW5zfEV1cm9wZS9WaWxuaXVzIiwKCQkJIkV1cm9wZS9BdGhlbnN8RXVyb3BlL1phcG9yb3poeWUiLAoJCQkiRXVyb3BlL0NoaXNpbmF1fEV1cm9wZS9UaXJhc3BvbCIsCgkJCSJFdXJvcGUvRHVibGlufEVpcmUiLAoJCQkiRXVyb3BlL0lzdGFuYnVsfEFzaWEvSXN0YW5idWwiLAoJCQkiRXVyb3BlL0lzdGFuYnVsfFR1cmtleSIsCgkJCSJFdXJvcGUvTGlzYm9ufEF0bGFudGljL0NhbmFyeSIsCgkJCSJFdXJvcGUvTGlzYm9ufEF0bGFudGljL0ZhZXJvZSIsCgkJCSJFdXJvcGUvTGlzYm9ufEF0bGFudGljL0Zhcm9lIiwKCQkJIkV1cm9wZS9MaXNib258QXRsYW50aWMvTWFkZWlyYSIsCgkJCSJFdXJvcGUvTGlzYm9ufFBvcnR1Z2FsIiwKCQkJIkV1cm9wZS9MaXNib258V0VUIiwKCQkJIkV1cm9wZS9Mb25kb258RXVyb3BlL0JlbGZhc3QiLAoJCQkiRXVyb3BlL0xvbmRvbnxFdXJvcGUvR3Vlcm5zZXkiLAoJCQkiRXVyb3BlL0xvbmRvbnxFdXJvcGUvSXNsZV9vZl9NYW4iLAoJCQkiRXVyb3BlL0xvbmRvbnxFdXJvcGUvSmVyc2V5IiwKCQkJIkV1cm9wZS9Mb25kb258R0IiLAoJCQkiRXVyb3BlL0xvbmRvbnxHQi1FaXJlIiwKCQkJIkV1cm9wZS9Nb3Njb3d8Vy1TVSIsCgkJCSJFdXJvcGUvUGFyaXN8QWZyaWNhL0NldXRhIiwKCQkJIkV1cm9wZS9QYXJpc3xBcmN0aWMvTG9uZ3llYXJieWVuIiwKCQkJIkV1cm9wZS9QYXJpc3xBdGxhbnRpYy9KYW5fTWF5ZW4iLAoJCQkiRXVyb3BlL1BhcmlzfENFVCIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL0Ftc3RlcmRhbSIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL0FuZG9ycmEiLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9CZWxncmFkZSIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL0JlcmxpbiIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL0JyYXRpc2xhdmEiLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9CcnVzc2VscyIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL0J1ZGFwZXN0IiwKCQkJIkV1cm9wZS9QYXJpc3xFdXJvcGUvQnVzaW5nZW4iLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9Db3BlbmhhZ2VuIiwKCQkJIkV1cm9wZS9QYXJpc3xFdXJvcGUvR2licmFsdGFyIiwKCQkJIkV1cm9wZS9QYXJpc3xFdXJvcGUvTGp1YmxqYW5hIiwKCQkJIkV1cm9wZS9QYXJpc3xFdXJvcGUvTHV4ZW1ib3VyZyIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL01hZHJpZCIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL01hbHRhIiwKCQkJIkV1cm9wZS9QYXJpc3xFdXJvcGUvTW9uYWNvIiwKCQkJIkV1cm9wZS9QYXJpc3xFdXJvcGUvT3NsbyIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL1BvZGdvcmljYSIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL1ByYWd1ZSIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL1JvbWUiLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9TYW5fTWFyaW5vIiwKCQkJIkV1cm9wZS9QYXJpc3xFdXJvcGUvU2FyYWpldm8iLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9Ta29wamUiLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9TdG9ja2hvbG0iLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9UaXJhbmUiLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9WYWR1eiIsCgkJCSJFdXJvcGUvUGFyaXN8RXVyb3BlL1ZhdGljYW4iLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9WaWVubmEiLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9XYXJzYXciLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9aYWdyZWIiLAoJCQkiRXVyb3BlL1BhcmlzfEV1cm9wZS9adXJpY2giLAoJCQkiRXVyb3BlL1BhcmlzfFBvbGFuZCIsCgkJCSJFdXJvcGUvVWx5YW5vdnNrfEV1cm9wZS9Bc3RyYWtoYW4iLAoJCQkiUGFjaWZpYy9BdWNrbGFuZHxBbnRhcmN0aWNhL01jTXVyZG8iLAoJCQkiUGFjaWZpYy9BdWNrbGFuZHxBbnRhcmN0aWNhL1NvdXRoX1BvbGUiLAoJCQkiUGFjaWZpYy9BdWNrbGFuZHxOWiIsCgkJCSJQYWNpZmljL0NoYXRoYW18TlotQ0hBVCIsCgkJCSJQYWNpZmljL0Vhc3RlcnxDaGlsZS9FYXN0ZXJJc2xhbmQiLAoJCQkiUGFjaWZpYy9GYWthb2ZvfEV0Yy9HTVQtMTMiLAoJCQkiUGFjaWZpYy9GYWthb2ZvfFBhY2lmaWMvRW5kZXJidXJ5IiwKCQkJIlBhY2lmaWMvR2FsYXBhZ29zfEV0Yy9HTVQrNiIsCgkJCSJQYWNpZmljL0dhbWJpZXJ8RXRjL0dNVCs5IiwKCQkJIlBhY2lmaWMvR3VhZGFsY2FuYWx8QW50YXJjdGljYS9NYWNxdWFyaWUiLAoJCQkiUGFjaWZpYy9HdWFkYWxjYW5hbHxFdGMvR01ULTExIiwKCQkJIlBhY2lmaWMvR3VhZGFsY2FuYWx8UGFjaWZpYy9FZmF0ZSIsCgkJCSJQYWNpZmljL0d1YWRhbGNhbmFsfFBhY2lmaWMvS29zcmFlIiwKCQkJIlBhY2lmaWMvR3VhZGFsY2FuYWx8UGFjaWZpYy9Ob3VtZWEiLAoJCQkiUGFjaWZpYy9HdWFkYWxjYW5hbHxQYWNpZmljL1BvaG5wZWkiLAoJCQkiUGFjaWZpYy9HdWFkYWxjYW5hbHxQYWNpZmljL1BvbmFwZSIsCgkJCSJQYWNpZmljL0d1YW18UGFjaWZpYy9TYWlwYW4iLAoJCQkiUGFjaWZpYy9Ib25vbHVsdXxIU1QiLAoJCQkiUGFjaWZpYy9Ib25vbHVsdXxQYWNpZmljL0pvaG5zdG9uIiwKCQkJIlBhY2lmaWMvSG9ub2x1bHV8VVMvSGF3YWlpIiwKCQkJIlBhY2lmaWMvS2lyaXRpbWF0aXxFdGMvR01ULTE0IiwKCQkJIlBhY2lmaWMvTml1ZXxFdGMvR01UKzExIiwKCQkJIlBhY2lmaWMvUGFnb19QYWdvfFBhY2lmaWMvTWlkd2F5IiwKCQkJIlBhY2lmaWMvUGFnb19QYWdvfFBhY2lmaWMvU2Ftb2EiLAoJCQkiUGFjaWZpYy9QYWdvX1BhZ298VVMvU2Ftb2EiLAoJCQkiUGFjaWZpYy9QaXRjYWlybnxFdGMvR01UKzgiLAoJCQkiUGFjaWZpYy9Qb3J0X01vcmVzYnl8QW50YXJjdGljYS9EdW1vbnREVXJ2aWxsZSIsCgkJCSJQYWNpZmljL1BvcnRfTW9yZXNieXxFdGMvR01ULTEwIiwKCQkJIlBhY2lmaWMvUG9ydF9Nb3Jlc2J5fFBhY2lmaWMvQ2h1dWsiLAoJCQkiUGFjaWZpYy9Qb3J0X01vcmVzYnl8UGFjaWZpYy9UcnVrIiwKCQkJIlBhY2lmaWMvUG9ydF9Nb3Jlc2J5fFBhY2lmaWMvWWFwIiwKCQkJIlBhY2lmaWMvVGFoaXRpfEV0Yy9HTVQrMTAiLAoJCQkiUGFjaWZpYy9UYWhpdGl8UGFjaWZpYy9SYXJvdG9uZ2EiCgkJXQoJfSk7CgoKCXJldHVybiBtb21lbnQ7Cn0pKTsK',
  /* sugar-2.0.4 */ 'LyoKICogIFN1Z2FyIHYyLjAuNAogKgogKiAgRnJlZWx5IGRpc3RyaWJ1dGFibGUgYW5kIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQtc3R5bGUgbGljZW5zZS4KICogIENvcHlyaWdodCAoYykgQW5kcmV3IFBsdW1tZXIKICogIGh0dHBzOi8vc3VnYXJqcy5jb20vCiAqCiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KKGZ1bmN0aW9uKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqKgogICAqIEBtb2R1bGUgQ29yZQogICAqIEBkZXNjcmlwdGlvbiBDb3JlIGZ1bmN0aW9uYWxpdHkgaW5jbHVkaW5nIHRoZSBhYmlsaXR5IHRvIGRlZmluZSBtZXRob2RzIGFuZAogICAqICAgICAgICAgICAgICBleHRlbmQgb250byBuYXRpdmVzLgogICAqCiAgICoqKi8KCiAgLy8gVGhlIGdsb2JhbCB0byBleHBvcnQuCiAgdmFyIFN1Z2FyOwoKICAvLyBUaGUgbmFtZSBvZiBTdWdhciBpbiB0aGUgZ2xvYmFsIG5hbWVzcGFjZS4KICB2YXIgU1VHQVJfR0xPQkFMID0gJ1N1Z2FyJzsKCiAgLy8gTmF0aXZlcyBhdmFpbGFibGUgb24gaW5pdGlhbGl6YXRpb24uIExldHRpbmcgT2JqZWN0IGdvIGZpcnN0IHRvIGVuc3VyZSBpdHMKICAvLyBnbG9iYWwgaXMgc2V0IGJ5IHRoZSB0aW1lIHRoZSByZXN0IGFyZSBjaGVja2luZyBmb3IgY2hhaW5hYmxlIE9iamVjdCBtZXRob2RzLgogIHZhciBOQVRJVkVfTkFNRVMgPSAnT2JqZWN0IE51bWJlciBTdHJpbmcgQXJyYXkgRGF0ZSBSZWdFeHAgRnVuY3Rpb24nOwoKICAvLyBTdGF0aWMgbWV0aG9kIGZsYWcKICB2YXIgU1RBVElDICAgPSAweDE7CgogIC8vIEluc3RhbmNlIG1ldGhvZCBmbGFnCiAgdmFyIElOU1RBTkNFID0gMHgyOwoKICAvLyBJRTggaGFzIGEgYnJva2VuIGRlZmluZVByb3BlcnR5IGJ1dCBubyBkZWZpbmVQcm9wZXJ0aWVzIHNvIHRoaXMgc2F2ZXMgYSB0cnkvY2F0Y2guCiAgdmFyIFBST1BFUlRZX0RFU0NSSVBUT1JfU1VQUE9SVCA9ICEhKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAmJiBPYmplY3QuZGVmaW5lUHJvcGVydGllcyk7CgogIC8vIFRoZSBnbG9iYWwgY29udGV4dC4gUmhpbm8gdXNlcyBhIGRpZmZlcmVudCAiZ2xvYmFsIiBrZXl3b3JkIHNvCiAgLy8gZG8gYW4gZXh0cmEgY2hlY2sgdG8gYmUgc3VyZSB0aGF0IGl0J3MgYWN0dWFsbHkgdGhlIGdsb2JhbCBjb250ZXh0LgogIHZhciBnbG9iYWxDb250ZXh0ID0gdHlwZW9mIGdsb2JhbCAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLk9iamVjdCA9PT0gT2JqZWN0ID8gZ2xvYmFsIDogdGhpczsKCiAgLy8gSXMgdGhlIGVudmlyb25tZW50IG5vZGU/CiAgdmFyIGhhc0V4cG9ydHMgPSB0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0czsKCiAgLy8gV2hldGhlciBvYmplY3QgaW5zdGFuY2UgbWV0aG9kcyBjYW4gYmUgbWFwcGVkIHRvIHRoZSBwcm90b3R5cGUuCiAgdmFyIGFsbG93T2JqZWN0UHJvdG90eXBlID0gZmFsc2U7CgogIC8vIEEgbWFwIGZyb20gQXJyYXkgdG8gU3VnYXJBcnJheS4KICB2YXIgbmFtZXNwYWNlc0J5TmFtZSA9IHt9OwoKICAvLyBBIG1hcCBmcm9tIFtvYmplY3QgT2JqZWN0XSB0byBuYW1lc3BhY2UuCiAgdmFyIG5hbWVzcGFjZXNCeUNsYXNzU3RyaW5nID0ge307CgogIC8vIERlZmluaW5nIHByb3BlcnRpZXMuCiAgdmFyIGRlZmluZVByb3BlcnR5ID0gUFJPUEVSVFlfREVTQ1JJUFRPUl9TVVBQT1JUID8gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSA6IGRlZmluZVByb3BlcnR5U2hpbTsKCiAgLy8gQSBkZWZhdWx0IGNoYWluYWJsZSBjbGFzcyBmb3IgdW5rbm93biB0eXBlcy4KICB2YXIgRGVmYXVsdENoYWluYWJsZSA9IGdldE5ld0NoYWluYWJsZUNsYXNzKCdDaGFpbmFibGUnKTsKCgogIC8vIEdsb2JhbCBtZXRob2RzCgogIGZ1bmN0aW9uIHNldHVwR2xvYmFsKCkgewogICAgU3VnYXIgPSBnbG9iYWxDb250ZXh0W1NVR0FSX0dMT0JBTF07CiAgICBpZiAoU3VnYXIpIHsKICAgICAgLy8gUmV1c2UgYWxyZWFkeSBkZWZpbmVkIFN1Z2FyIGdsb2JhbCBvYmplY3QuCiAgICAgIHJldHVybjsKICAgIH0KICAgIFN1Z2FyID0gZnVuY3Rpb24oYXJnKSB7CiAgICAgIGZvckVhY2hQcm9wZXJ0eShTdWdhciwgZnVuY3Rpb24oc3VnYXJOYW1lc3BhY2UsIG5hbWUpIHsKICAgICAgICAvLyBBbHRob3VnaCBvbmx5IHRoZSBvbmx5IGVudW1lcmFibGUgcHJvcGVydGllcyBvbiB0aGUgZ2xvYmFsCiAgICAgICAgLy8gb2JqZWN0IGFyZSBTdWdhciBuYW1lc3BhY2VzLCBlbnZpcm9ubWVudHMgdGhhdCBjYW4ndCBzZXQKICAgICAgICAvLyBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzIHdpbGwgc3RlcCB0aHJvdWdoIHRoZSB1dGlsaXR5IG1ldGhvZHMKICAgICAgICAvLyBhcyB3ZWxsIGhlcmUsIHNvIHVzZSB0aGlzIGNoZWNrIHRvIG9ubHkgYWxsb3cgdHJ1ZSBuYW1lc3BhY2VzLgogICAgICAgIGlmIChoYXNPd24obmFtZXNwYWNlc0J5TmFtZSwgbmFtZSkpIHsKICAgICAgICAgIHN1Z2FyTmFtZXNwYWNlLmV4dGVuZChhcmcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBTdWdhcjsKICAgIH07CiAgICBpZiAoaGFzRXhwb3J0cykgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IFN1Z2FyOwogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsKICAgICAgICBnbG9iYWxDb250ZXh0W1NVR0FSX0dMT0JBTF0gPSBTdWdhcjsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIENvbnRleHRzIHN1Y2ggYXMgUU1MIGhhdmUgYSByZWFkLW9ubHkgZ2xvYmFsIGNvbnRleHQuCiAgICAgIH0KICAgIH0KICAgIGZvckVhY2hQcm9wZXJ0eShOQVRJVkVfTkFNRVMuc3BsaXQoJyAnKSwgZnVuY3Rpb24obmFtZSkgewogICAgICBjcmVhdGVOYW1lc3BhY2UobmFtZSk7CiAgICB9KTsKICAgIHNldEdsb2JhbFByb3BlcnRpZXMoKTsKICB9CgogIC8qKioKICAgKiBAbWV0aG9kIGNyZWF0ZU5hbWVzcGFjZShuYW1lKQogICAqIEByZXR1cm5zIFN1Z2FyTmFtZXNwYWNlCiAgICogQG5hbWVzcGFjZSBTdWdhcgogICAqIEBzaG9ydCBDcmVhdGVzIGEgbmV3IFN1Z2FyIG5hbWVzcGFjZS4KICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgaXMgZm9yIHBsdWdpbiBkZXZlbG9wZXJzIHdobyB3YW50IHRvIGRlZmluZSBtZXRob2RzIHRvIGJlCiAgICogICAgICAgIHVzZWQgd2l0aCBuYXRpdmVzIHRoYXQgU3VnYXIgZG9lcyBub3QgaGFuZGxlIGJ5IGRlZmF1bHQuIFRoZSBuZXcKICAgKiAgICAgICAgbmFtZXNwYWNlIHdpbGwgYXBwZWFyIG9uIHRoZSBgU3VnYXJgIGdsb2JhbCB3aXRoIGFsbCB0aGUgbWV0aG9kcyBvZgogICAqICAgICAgICBub3JtYWwgbmFtZXNwYWNlcywgaW5jbHVkaW5nIHRoZSBhYmlsaXR5IHRvIGRlZmluZSBuZXcgbWV0aG9kcy4gV2hlbgogICAqICAgICAgICBleHRlbmRlZCwgYW55IGRlZmluZWQgbWV0aG9kcyB3aWxsIGJlIG1hcHBlZCB0byBgbmFtZWAgaW4gdGhlIGdsb2JhbAogICAqICAgICAgICBjb250ZXh0LgogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgU3VnYXIuY3JlYXRlTmFtZXNwYWNlKCdCb29sZWFuJyk7CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lc3BhY2UgbmFtZS4KICAgKgogICAqKiovCiAgZnVuY3Rpb24gY3JlYXRlTmFtZXNwYWNlKG5hbWUpIHsKCiAgICAvLyBJcyB0aGUgY3VycmVudCBuYW1lc3BhY2UgT2JqZWN0PwogICAgdmFyIGlzT2JqZWN0ID0gbmFtZSA9PT0gJ09iamVjdCc7CgogICAgLy8gQSBTdWdhciBuYW1lc3BhY2UgaXMgYWxzbyBhIGNoYWluYWJsZSBjbGFzczogU3VnYXIuQXJyYXksIGV0Yy4KICAgIHZhciBzdWdhck5hbWVzcGFjZSA9IGdldE5ld0NoYWluYWJsZUNsYXNzKG5hbWUsIHRydWUpOwoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZXh0ZW5kKFtvcHRzXSkKICAgICAqIEByZXR1cm5zIFN1Z2FyCiAgICAgKiBAbmFtZXNwYWNlIFN1Z2FyCiAgICAgKiBAc2hvcnQgRXh0ZW5kcyBTdWdhciBkZWZpbmVkIG1ldGhvZHMgb250byBuYXRpdmVzLgogICAgICogQGV4dHJhIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgb24gaW5kaXZpZHVhbCBuYW1lc3BhY2VzIGxpa2UKICAgICAqICAgICAgICBgU3VnYXIuQXJyYXlgIG9yIG9uIHRoZSBgU3VnYXJgIGdsb2JhbCBpdHNlbGYsIGluIHdoaWNoIGNhc2UKICAgICAqICAgICAgICBbb3B0c10gd2lsbCBiZSBmb3J3YXJkZWQgdG8gZWFjaCBgZXh0ZW5kYCBjYWxsLiBGb3IgbW9yZSwKICAgICAqICAgICAgICBzZWUgYGV4dGVuZGluZ2AuCiAgICAgKgogICAgICogQG9wdGlvbnMKICAgICAqCiAgICAgKiAgIG1ldGhvZHMgICAgICAgICAgIEFuIGFycmF5IG9mIG1ldGhvZCBuYW1lcyB0byBleHBsaWNpdGx5IGV4dGVuZC4KICAgICAqCiAgICAgKiAgIGV4Y2VwdCAgICAgICAgICAgIEFuIGFycmF5IG9mIG1ldGhvZCBuYW1lcyBvciBnbG9iYWwgbmFtZXNwYWNlcyAoYEFycmF5YCwKICAgICAqICAgICAgICAgICAgICAgICAgICAgYFN0cmluZ2ApIHRvIGV4cGxpY2l0bHkgZXhjbHVkZS4gTmFtZXNwYWNlcyBzaG91bGQgYmUgdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIGFjdHVhbCBnbG9iYWwgb2JqZWN0cywgbm90IHN0cmluZ3MuCiAgICAgKgogICAgICogICBuYW1lc3BhY2VzICAgICAgICBBbiBhcnJheSBvZiBnbG9iYWwgbmFtZXNwYWNlcyAoYEFycmF5YCwgYFN0cmluZ2ApIHRvCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIGV4cGxpY2l0bHkgZXh0ZW5kLiBOYW1lc3BhY2VzIHNob3VsZCBiZSB0aGUgYWN0dWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIGdsb2JhbCBvYmplY3RzLCBub3Qgc3RyaW5ncy4KICAgICAqCiAgICAgKiAgIGVuaGFuY2UgICAgICAgICAgIEEgc2hvcnRjdXQgdG8gZGlzYWxsb3cgYWxsICJlbmhhbmNlIiBmbGFncyBhdCBvbmNlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIChmbGFncyBsaXN0ZWQgYmVsb3cpLiBGb3IgbW9yZSwgc2VlIGBlbmhhbmNlZCBtZXRob2RzYC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCBpcyBgdHJ1ZWAuCiAgICAgKgogICAgICogICBlbmhhbmNlU3RyaW5nICAgICBBIGJvb2xlYW4gYWxsb3dpbmcgU3RyaW5nIGVuaGFuY2VtZW50cy4gRGVmYXVsdCBpcyBgdHJ1ZWAuCiAgICAgKgogICAgICogICBlbmhhbmNlQXJyYXkgICAgICBBIGJvb2xlYW4gYWxsb3dpbmcgQXJyYXkgZW5oYW5jZW1lbnRzLiBEZWZhdWx0IGlzIGB0cnVlYC4KICAgICAqCiAgICAgKiAgIG9iamVjdFByb3RvdHlwZSAgIEEgYm9vbGVhbiBhbGxvd2luZyBTdWdhciB0byBleHRlbmQgT2JqZWN0LnByb3RvdHlwZQogICAgICogICAgICAgICAgICAgICAgICAgICB3aXRoIGluc3RhbmNlIG1ldGhvZHMuIFRoaXMgb3B0aW9uIGlzIG9mZiBieSBkZWZhdWx0CiAgICAgKiAgICAgICAgICAgICAgICAgICAgIGFuZCBzaG91bGQgZ2VuZXJhbGx5IG5vdCBiZSB1c2VkIGV4Y2VwdCB3aXRoIGNhdXRpb24uCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIEZvciBtb3JlLCBzZWUgYG9iamVjdCBtZXRob2RzYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgU3VnYXIuQXJyYXkuZXh0ZW5kKCk7CiAgICAgKiAgIFN1Z2FyLmV4dGVuZCgpOwogICAgICoKICAgICAqIEBvcHRpb24ge0FycmF5PHN0cmluZz59IFttZXRob2RzXQogICAgICogQG9wdGlvbiB7QXJyYXk8c3RyaW5nfE5hdGl2ZUNvbnN0cnVjdG9yPn0gW2V4Y2VwdF0KICAgICAqIEBvcHRpb24ge0FycmF5PE5hdGl2ZUNvbnN0cnVjdG9yPn0gW25hbWVzcGFjZXNdCiAgICAgKiBAb3B0aW9uIHtib29sZWFufSBbZW5oYW5jZV0KICAgICAqIEBvcHRpb24ge2Jvb2xlYW59IFtlbmhhbmNlU3RyaW5nXQogICAgICogQG9wdGlvbiB7Ym9vbGVhbn0gW2VuaGFuY2VBcnJheV0KICAgICAqIEBvcHRpb24ge2Jvb2xlYW59IFtvYmplY3RQcm90b3R5cGVdCiAgICAgKiBAcGFyYW0ge0V4dGVuZE9wdGlvbnN9IFtvcHRzXQogICAgICoKICAgICAqKioKICAgICAqIEBtZXRob2QgZXh0ZW5kKFtvcHRzXSkKICAgICAqIEByZXR1cm5zIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAbmFtZXNwYWNlIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAc2hvcnQgRXh0ZW5kcyBTdWdhciBkZWZpbmVkIG1ldGhvZHMgZm9yIGEgc3BlY2lmaWMgbmFtZXNwYWNlIG9udG8gbmF0aXZlcy4KICAgICAqIEBwYXJhbSB7RXh0ZW5kT3B0aW9uc30gW29wdHNdCiAgICAgKgogICAgICoqKi8KICAgIHZhciBleHRlbmQgPSBmdW5jdGlvbiAob3B0cykgewoKICAgICAgdmFyIG5hdGl2ZUNsYXNzID0gZ2xvYmFsQ29udGV4dFtuYW1lXSwgbmF0aXZlUHJvdG8gPSBuYXRpdmVDbGFzcy5wcm90b3R5cGU7CiAgICAgIHZhciBzdGF0aWNNZXRob2RzID0ge30sIGluc3RhbmNlTWV0aG9kcyA9IHt9LCBtZXRob2RzQnlOYW1lOwoKICAgICAgZnVuY3Rpb24gb2JqZWN0UmVzdHJpY3RlZChuYW1lLCB0YXJnZXQpIHsKICAgICAgICByZXR1cm4gaXNPYmplY3QgJiYgdGFyZ2V0ID09PSBuYXRpdmVQcm90byAmJgogICAgICAgICAgICAgICAoIWFsbG93T2JqZWN0UHJvdG90eXBlIHx8IG5hbWUgPT09ICdnZXQnIHx8IG5hbWUgPT09ICdzZXQnKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYXJyYXlPcHRpb25FeGlzdHMoZmllbGQsIHZhbCkgewogICAgICAgIHZhciBhcnIgPSBvcHRzW2ZpZWxkXTsKICAgICAgICBpZiAoYXJyKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZWw7IGVsID0gYXJyW2ldOyBpKyspIHsKICAgICAgICAgICAgaWYgKGVsID09PSB2YWwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFycmF5T3B0aW9uRXhjbHVkZXMoZmllbGQsIHZhbCkgewogICAgICAgIHJldHVybiBvcHRzW2ZpZWxkXSAmJiAhYXJyYXlPcHRpb25FeGlzdHMoZmllbGQsIHZhbCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGRpc2FsbG93ZWRCeUZsYWdzKG1ldGhvZE5hbWUsIHRhcmdldCwgZmxhZ3MpIHsKICAgICAgICAvLyBEaXNhbGxvd2luZyBtZXRob2RzIGJ5IGZsYWcgY3VycmVudGx5IG9ubHkgYXBwbGllcyBpZiBtZXRob2RzIGFscmVhZHkKICAgICAgICAvLyBleGlzdCB0byBhdm9pZCBlbmhhbmNpbmcgbmF0aXZlIG1ldGhvZHMsIGFzIGFsaWFzZXMgc2hvdWxkIHN0aWxsIGJlCiAgICAgICAgLy8gZXh0ZW5kZWQgKGkuZS4gQXJyYXkjYWxsIHNob3VsZCBzdGlsbCBiZSBleHRlbmRlZCBldmVuIGlmIEFycmF5I2V2ZXJ5CiAgICAgICAgLy8gaXMgYmVpbmcgZGlzYWxsb3dlZCBieSBhIGZsYWcpLgogICAgICAgIGlmICghdGFyZ2V0W21ldGhvZE5hbWVdIHx8ICFmbGFncykgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZsYWdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAob3B0c1tmbGFnc1tpXV0gPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gbmFtZXNwYWNlSXNFeGNlcHRlZCgpIHsKICAgICAgICByZXR1cm4gYXJyYXlPcHRpb25FeGlzdHMoJ2V4Y2VwdCcsIG5hdGl2ZUNsYXNzKSB8fAogICAgICAgICAgICAgICBhcnJheU9wdGlvbkV4Y2x1ZGVzKCduYW1lc3BhY2VzJywgbmF0aXZlQ2xhc3MpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBtZXRob2RJc0V4Y2VwdGVkKG1ldGhvZE5hbWUpIHsKICAgICAgICByZXR1cm4gYXJyYXlPcHRpb25FeGlzdHMoJ2V4Y2VwdCcsIG1ldGhvZE5hbWUpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjYW5FeHRlbmQobWV0aG9kTmFtZSwgbWV0aG9kLCB0YXJnZXQpIHsKICAgICAgICByZXR1cm4gIW9iamVjdFJlc3RyaWN0ZWQobWV0aG9kTmFtZSwgdGFyZ2V0KSAmJgogICAgICAgICAgICAgICAhZGlzYWxsb3dlZEJ5RmxhZ3MobWV0aG9kTmFtZSwgdGFyZ2V0LCBtZXRob2QuZmxhZ3MpICYmCiAgICAgICAgICAgICAgICFtZXRob2RJc0V4Y2VwdGVkKG1ldGhvZE5hbWUpOwogICAgICB9CgogICAgICBvcHRzID0gb3B0cyB8fCB7fTsKICAgICAgbWV0aG9kc0J5TmFtZSA9IG9wdHMubWV0aG9kczsKCiAgICAgIGlmIChuYW1lc3BhY2VJc0V4Y2VwdGVkKCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3QgJiYgdHlwZW9mIG9wdHMub2JqZWN0UHJvdG90eXBlID09PSAnYm9vbGVhbicpIHsKICAgICAgICAvLyBTdG9yZSAib2JqZWN0UHJvdG90eXBlIiBmbGFnIGZvciBmdXR1cmUgcmVmZXJlbmNlLgogICAgICAgIGFsbG93T2JqZWN0UHJvdG90eXBlID0gb3B0cy5vYmplY3RQcm90b3R5cGU7CiAgICAgIH0KCiAgICAgIGZvckVhY2hQcm9wZXJ0eShtZXRob2RzQnlOYW1lIHx8IHN1Z2FyTmFtZXNwYWNlLCBmdW5jdGlvbihtZXRob2QsIG1ldGhvZE5hbWUpIHsKICAgICAgICBpZiAobWV0aG9kc0J5TmFtZSkgewogICAgICAgICAgLy8gSWYgd2UgaGF2ZSBtZXRob2QgbmFtZXMgcGFzc2VkIGluIGFuIGFycmF5LAogICAgICAgICAgLy8gdGhlbiB3ZSBuZWVkIHRvIGZsaXAgdGhlIGtleSBhbmQgdmFsdWUgaGVyZQogICAgICAgICAgLy8gYW5kIGZpbmQgdGhlIG1ldGhvZCBpbiB0aGUgU3VnYXIgbmFtZXNwYWNlLgogICAgICAgICAgbWV0aG9kTmFtZSA9IG1ldGhvZDsKICAgICAgICAgIG1ldGhvZCA9IHN1Z2FyTmFtZXNwYWNlW21ldGhvZE5hbWVdOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzT3duKG1ldGhvZCwgJ2luc3RhbmNlJykgJiYgY2FuRXh0ZW5kKG1ldGhvZE5hbWUsIG1ldGhvZCwgbmF0aXZlUHJvdG8pKSB7CiAgICAgICAgICBpbnN0YW5jZU1ldGhvZHNbbWV0aG9kTmFtZV0gPSBtZXRob2QuaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGlmKGhhc093bihtZXRob2QsICdzdGF0aWMnKSAmJiBjYW5FeHRlbmQobWV0aG9kTmFtZSwgbWV0aG9kLCBuYXRpdmVDbGFzcykpIHsKICAgICAgICAgIHN0YXRpY01ldGhvZHNbbWV0aG9kTmFtZV0gPSBtZXRob2Q7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIEFjY2Vzc2luZyB0aGUgZXh0ZW5kIHRhcmdldCBlYWNoIHRpbWUgaW5zdGVhZCBvZiBob2xkaW5nIGEgcmVmZXJlbmNlIGFzCiAgICAgIC8vIGl0IG1heSBoYXZlIGJlZW4gb3ZlcndyaXR0ZW4gKGZvciBleGFtcGxlIERhdGUgYnkgU2lub24pLiBBbHNvIG5lZWQgdG8KICAgICAgLy8gYWNjZXNzIHRocm91Z2ggdGhlIGdsb2JhbCB0byBhbGxvdyBleHRlbnNpb24gb2YgdXNlci1kZWZpbmVkIG5hbWVzcGFjZXMuCiAgICAgIGV4dGVuZE5hdGl2ZShuYXRpdmVDbGFzcywgc3RhdGljTWV0aG9kcyk7CiAgICAgIGV4dGVuZE5hdGl2ZShuYXRpdmVQcm90bywgaW5zdGFuY2VNZXRob2RzKTsKCiAgICAgIGlmICghbWV0aG9kc0J5TmFtZSkgewogICAgICAgIC8vIElmIHRoZXJlIGFyZSBubyBtZXRob2QgbmFtZXMgcGFzc2VkLCB0aGVuCiAgICAgICAgLy8gYWxsIG1ldGhvZHMgaW4gdGhlIG5hbWVzcGFjZSB3aWxsIGJlIGV4dGVuZGVkCiAgICAgICAgLy8gdG8gdGhlIG5hdGl2ZS4gVGhpcyBpbmNsdWRlcyBhbGwgZnV0dXJlIGRlZmluZWQKICAgICAgICAvLyBtZXRob2RzLCBzbyBhZGQgYSBmbGFnIGhlcmUgdG8gY2hlY2sgbGF0ZXIuCiAgICAgICAgc2V0UHJvcGVydHkoc3VnYXJOYW1lc3BhY2UsICdhY3RpdmUnLCB0cnVlKTsKICAgICAgfQogICAgICByZXR1cm4gc3VnYXJOYW1lc3BhY2U7CiAgICB9OwoKICAgIGZ1bmN0aW9uIGRlZmluZVdpdGhPcHRpb25Db2xsZWN0KG1ldGhvZE5hbWUsIGluc3RhbmNlLCBhcmdzKSB7CiAgICAgIHNldFByb3BlcnR5KHN1Z2FyTmFtZXNwYWNlLCBtZXRob2ROYW1lLCBmdW5jdGlvbihhcmcxLCBhcmcyLCBhcmczKSB7CiAgICAgICAgdmFyIG9wdHMgPSBjb2xsZWN0RGVmaW5lT3B0aW9ucyhhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgICBkZWZpbmVNZXRob2RzKHN1Z2FyTmFtZXNwYWNlLCBvcHRzLm1ldGhvZHMsIGluc3RhbmNlLCBhcmdzLCBvcHRzLmxhc3QpOwogICAgICAgIHJldHVybiBzdWdhck5hbWVzcGFjZTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqKgogICAgICogQG1ldGhvZCBkZWZpbmVTdGF0aWMobWV0aG9kcykKICAgICAqIEByZXR1cm5zIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAbmFtZXNwYWNlIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAc2hvcnQgRGVmaW5lcyBzdGF0aWMgbWV0aG9kcyBvbiB0aGUgbmFtZXNwYWNlIHRoYXQgY2FuIGxhdGVyIGJlIGV4dGVuZGVkCiAgICAgKiAgICAgICAgb250byB0aGUgbmF0aXZlIGdsb2JhbHMuCiAgICAgKiBAZXh0cmEgQWNjZXB0cyBlaXRoZXIgYSBzaW5nbGUgb2JqZWN0IG1hcHBpbmcgbmFtZXMgdG8gZnVuY3Rpb25zLCBvciBuYW1lCiAgICAgKiAgICAgICAgYW5kIGZ1bmN0aW9uIGFzIHR3byBhcmd1bWVudHMuIElmIGBleHRlbmRgIHdhcyBwcmV2aW91c2x5IGNhbGxlZAogICAgICogICAgICAgIHdpdGggbm8gYXJndW1lbnRzLCB0aGUgbWV0aG9kIHdpbGwgYmUgaW1tZWRpYXRlbHkgbWFwcGVkIHRvIGl0cwogICAgICogICAgICAgIG5hdGl2ZSB3aGVuIGRlZmluZWQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFN1Z2FyLk51bWJlci5kZWZpbmVTdGF0aWMoewogICAgICogICAgIGlzT2RkOiBmdW5jdGlvbiAobnVtKSB7CiAgICAgKiAgICAgICByZXR1cm4gbnVtICUgMiA9PT0gMTsKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqIEBzaWduYXR1cmUgZGVmaW5lU3RhdGljKG1ldGhvZE5hbWUsIG1ldGhvZEZuKQogICAgICogQHBhcmFtIHtPYmplY3R9IG1ldGhvZHMgLSBNZXRob2RzIHRvIGJlIGRlZmluZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kTmFtZSAtIE5hbWUgb2YgYSBzaW5nbGUgbWV0aG9kIHRvIGJlIGRlZmluZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2RGbiAtIEZ1bmN0aW9uIGJvZHkgb2YgYSBzaW5nbGUgbWV0aG9kIHRvIGJlIGRlZmluZWQuCiAgICAgKioqLwogICAgZGVmaW5lV2l0aE9wdGlvbkNvbGxlY3QoJ2RlZmluZVN0YXRpYycsIFNUQVRJQyk7CgogICAgLyoqKgogICAgICogQG1ldGhvZCBkZWZpbmVJbnN0YW5jZShtZXRob2RzKQogICAgICogQHJldHVybnMgU3VnYXJOYW1lc3BhY2UKICAgICAqIEBuYW1lc3BhY2UgU3VnYXJOYW1lc3BhY2UKICAgICAqIEBzaG9ydCBEZWZpbmVzIG1ldGhvZHMgb24gdGhlIG5hbWVzcGFjZSB0aGF0IGNhbiBsYXRlciBiZSBleHRlbmRlZCBhcwogICAgICogICAgICAgIGluc3RhbmNlIG1ldGhvZHMgb250byB0aGUgbmF0aXZlIHByb3RvdHlwZS4KICAgICAqIEBleHRyYSBBY2NlcHRzIGVpdGhlciBhIHNpbmdsZSBvYmplY3QgbWFwcGluZyBuYW1lcyB0byBmdW5jdGlvbnMsIG9yIG5hbWUKICAgICAqICAgICAgICBhbmQgZnVuY3Rpb24gYXMgdHdvIGFyZ3VtZW50cy4gQWxsIGZ1bmN0aW9ucyBzaG91bGQgYWNjZXB0IHRoZQogICAgICogICAgICAgIG5hdGl2ZSBmb3Igd2hpY2ggdGhleSBhcmUgbWFwcGVkIGFzIHRoZWlyIGZpcnN0IGFyZ3VtZW50LCBhbmQgc2hvdWxkCiAgICAgKiAgICAgICAgbmV2ZXIgcmVmZXIgdG8gYHRoaXNgLiBJZiBgZXh0ZW5kYCB3YXMgcHJldmlvdXNseSBjYWxsZWQgd2l0aCBubwogICAgICogICAgICAgIGFyZ3VtZW50cywgdGhlIG1ldGhvZCB3aWxsIGJlIGltbWVkaWF0ZWx5IG1hcHBlZCB0byBpdHMgbmF0aXZlIHdoZW4KICAgICAqICAgICAgICBkZWZpbmVkLgogICAgICoKICAgICAqICAgICAgICBNZXRob2RzIGNhbm5vdCBhY2NlcHQgbW9yZSB0aGFuIDQgYXJndW1lbnRzIGluIGFkZGl0aW9uIHRvIHRoZQogICAgICogICAgICAgIG5hdGl2ZSAoNSBhcmd1bWVudHMgdG90YWwpLiBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgd2lsbCBub3QgYmUKICAgICAqICAgICAgICBtYXBwZWQuIElmIHRoZSBtZXRob2QgbmVlZHMgdG8gYWNjZXB0IHVubGltaXRlZCBhcmd1bWVudHMsIHVzZQogICAgICogICAgICAgIGBkZWZpbmVJbnN0YW5jZVdpdGhBcmd1bWVudHNgLiBPdGhlcndpc2UgaWYgbW9yZSBvcHRpb25zIGFyZQogICAgICogICAgICAgIHJlcXVpcmVkLCB1c2UgYW4gb3B0aW9ucyBvYmplY3QgaW5zdGVhZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgU3VnYXIuTnVtYmVyLmRlZmluZUluc3RhbmNlKHsKICAgICAqICAgICBzcXVhcmU6IGZ1bmN0aW9uIChudW0pIHsKICAgICAqICAgICAgIHJldHVybiBudW0gKiBudW07CiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqCiAgICAgKiBAc2lnbmF0dXJlIGRlZmluZUluc3RhbmNlKG1ldGhvZE5hbWUsIG1ldGhvZEZuKQogICAgICogQHBhcmFtIHtPYmplY3R9IG1ldGhvZHMgLSBNZXRob2RzIHRvIGJlIGRlZmluZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kTmFtZSAtIE5hbWUgb2YgYSBzaW5nbGUgbWV0aG9kIHRvIGJlIGRlZmluZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2RGbiAtIEZ1bmN0aW9uIGJvZHkgb2YgYSBzaW5nbGUgbWV0aG9kIHRvIGJlIGRlZmluZWQuCiAgICAgKioqLwogICAgZGVmaW5lV2l0aE9wdGlvbkNvbGxlY3QoJ2RlZmluZUluc3RhbmNlJywgSU5TVEFOQ0UpOwoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZGVmaW5lSW5zdGFuY2VBbmRTdGF0aWMobWV0aG9kcykKICAgICAqIEByZXR1cm5zIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAbmFtZXNwYWNlIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAc2hvcnQgQSBzaG9ydGN1dCB0byBkZWZpbmUgYm90aCBzdGF0aWMgYW5kIGluc3RhbmNlIG1ldGhvZHMgb24gdGhlIG5hbWVzcGFjZS4KICAgICAqIEBleHRyYSBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCBmb3IgdXNlIHdpdGggYE9iamVjdGAgaW5zdGFuY2UgbWV0aG9kcy4gU3VnYXIKICAgICAqICAgICAgICB3aWxsIG5vdCBtYXAgYW55IG1ldGhvZHMgdG8gYE9iamVjdC5wcm90b3R5cGVgIGJ5IGRlZmF1bHQsIHNvIGRlZmluaW5nCiAgICAgKiAgICAgICAgaW5zdGFuY2UgbWV0aG9kcyBhcyBzdGF0aWMgaGVscHMgZmFjaWxpdGF0ZSB0aGVpciBwcm9wZXIgdXNlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBTdWdhci5PYmplY3QuZGVmaW5lSW5zdGFuY2VBbmRTdGF0aWMoewogICAgICogICAgIGlzQXdlc29tZTogZnVuY3Rpb24gKG9iaikgewogICAgICogICAgICAgLy8gY2hlY2sgaWYgb2JqIGlzIGF3ZXNvbWUhCiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqCiAgICAgKiBAc2lnbmF0dXJlIGRlZmluZUluc3RhbmNlQW5kU3RhdGljKG1ldGhvZE5hbWUsIG1ldGhvZEZuKQogICAgICogQHBhcmFtIHtPYmplY3R9IG1ldGhvZHMgLSBNZXRob2RzIHRvIGJlIGRlZmluZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kTmFtZSAtIE5hbWUgb2YgYSBzaW5nbGUgbWV0aG9kIHRvIGJlIGRlZmluZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2RGbiAtIEZ1bmN0aW9uIGJvZHkgb2YgYSBzaW5nbGUgbWV0aG9kIHRvIGJlIGRlZmluZWQuCiAgICAgKioqLwogICAgZGVmaW5lV2l0aE9wdGlvbkNvbGxlY3QoJ2RlZmluZUluc3RhbmNlQW5kU3RhdGljJywgSU5TVEFOQ0UgfCBTVEFUSUMpOwoKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGRlZmluZVN0YXRpY1dpdGhBcmd1bWVudHMobWV0aG9kcykKICAgICAqIEByZXR1cm5zIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAbmFtZXNwYWNlIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAc2hvcnQgRGVmaW5lcyBzdGF0aWMgbWV0aG9kcyB0aGF0IGNvbGxlY3QgYXJndW1lbnRzLgogICAgICogQGV4dHJhIFRoaXMgbWV0aG9kIGlzIGlkZW50aWNhbCB0byBgZGVmaW5lU3RhdGljYCwgZXhjZXB0IHRoYXQgd2hlbiBkZWZpbmVkCiAgICAgKiAgICAgICAgbWV0aG9kcyBhcmUgY2FsbGVkLCB0aGV5IHdpbGwgY29sbGVjdCBhbnkgYXJndW1lbnRzIHBhc3QgYG4gLSAxYCwKICAgICAqICAgICAgICB3aGVyZSBgbmAgaXMgdGhlIG51bWJlciBvZiBhcmd1bWVudHMgdGhhdCB0aGUgbWV0aG9kIGFjY2VwdHMuCiAgICAgKiAgICAgICAgQ29sbGVjdGVkIGFyZ3VtZW50cyB3aWxsIGJlIHBhc3NlZCB0byB0aGUgbWV0aG9kIGluIGFuIGFycmF5CiAgICAgKiAgICAgICAgYXMgdGhlIGxhc3QgYXJndW1lbnQgZGVmaW5lZCBvbiB0aGUgZnVuY3Rpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFN1Z2FyLk51bWJlci5kZWZpbmVTdGF0aWNXaXRoQXJndW1lbnRzKHsKICAgICAqICAgICBhZGRBbGw6IGZ1bmN0aW9uIChudW0sIGFyZ3MpIHsKICAgICAqICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICogICAgICAgICBudW0gKz0gYXJnc1tpXTsKICAgICAqICAgICAgIH0KICAgICAqICAgICAgIHJldHVybiBudW07CiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqCiAgICAgKiBAc2lnbmF0dXJlIGRlZmluZVN0YXRpY1dpdGhBcmd1bWVudHMobWV0aG9kTmFtZSwgbWV0aG9kRm4pCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbWV0aG9kcyAtIE1ldGhvZHMgdG8gYmUgZGVmaW5lZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2ROYW1lIC0gTmFtZSBvZiBhIHNpbmdsZSBtZXRob2QgdG8gYmUgZGVmaW5lZC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG1ldGhvZEZuIC0gRnVuY3Rpb24gYm9keSBvZiBhIHNpbmdsZSBtZXRob2QgdG8gYmUgZGVmaW5lZC4KICAgICAqKiovCiAgICBkZWZpbmVXaXRoT3B0aW9uQ29sbGVjdCgnZGVmaW5lU3RhdGljV2l0aEFyZ3VtZW50cycsIFNUQVRJQywgdHJ1ZSk7CgogICAgLyoqKgogICAgICogQG1ldGhvZCBkZWZpbmVJbnN0YW5jZVdpdGhBcmd1bWVudHMobWV0aG9kcykKICAgICAqIEByZXR1cm5zIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAbmFtZXNwYWNlIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAc2hvcnQgRGVmaW5lcyBpbnN0YW5jZSBtZXRob2RzIHRoYXQgY29sbGVjdCBhcmd1bWVudHMuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgaXMgaWRlbnRpY2FsIHRvIGBkZWZpbmVJbnN0YW5jZWAsIGV4Y2VwdCB0aGF0IHdoZW4KICAgICAqICAgICAgICBkZWZpbmVkIG1ldGhvZHMgYXJlIGNhbGxlZCwgdGhleSB3aWxsIGNvbGxlY3QgYW55IGFyZ3VtZW50cyBwYXN0CiAgICAgKiAgICAgICAgYG4gLSAxYCwgd2hlcmUgYG5gIGlzIHRoZSBudW1iZXIgb2YgYXJndW1lbnRzIHRoYXQgdGhlIG1ldGhvZAogICAgICogICAgICAgIGFjY2VwdHMuIENvbGxlY3RlZCBhcmd1bWVudHMgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIG1ldGhvZCBhcyB0aGUKICAgICAqICAgICAgICBsYXN0IGFyZ3VtZW50IGRlZmluZWQgb24gdGhlIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBTdWdhci5OdW1iZXIuZGVmaW5lSW5zdGFuY2VXaXRoQXJndW1lbnRzKHsKICAgICAqICAgICBhZGRBbGw6IGZ1bmN0aW9uIChudW0sIGFyZ3MpIHsKICAgICAqICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICogICAgICAgICBudW0gKz0gYXJnc1tpXTsKICAgICAqICAgICAgIH0KICAgICAqICAgICAgIHJldHVybiBudW07CiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqCiAgICAgKiBAc2lnbmF0dXJlIGRlZmluZUluc3RhbmNlV2l0aEFyZ3VtZW50cyhtZXRob2ROYW1lLCBtZXRob2RGbikKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBtZXRob2RzIC0gTWV0aG9kcyB0byBiZSBkZWZpbmVkLgogICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZE5hbWUgLSBOYW1lIG9mIGEgc2luZ2xlIG1ldGhvZCB0byBiZSBkZWZpbmVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gbWV0aG9kRm4gLSBGdW5jdGlvbiBib2R5IG9mIGEgc2luZ2xlIG1ldGhvZCB0byBiZSBkZWZpbmVkLgogICAgICoqKi8KICAgIGRlZmluZVdpdGhPcHRpb25Db2xsZWN0KCdkZWZpbmVJbnN0YW5jZVdpdGhBcmd1bWVudHMnLCBJTlNUQU5DRSwgdHJ1ZSk7CgogICAgLyoqKgogICAgICogQG1ldGhvZCBkZWZpbmVTdGF0aWNQb2x5ZmlsbChtZXRob2RzKQogICAgICogQHJldHVybnMgU3VnYXJOYW1lc3BhY2UKICAgICAqIEBuYW1lc3BhY2UgU3VnYXJOYW1lc3BhY2UKICAgICAqIEBzaG9ydCBEZWZpbmVzIHN0YXRpYyBtZXRob2RzIHRoYXQgYXJlIG1hcHBlZCBvbnRvIHRoZSBuYXRpdmUgaWYgdGhleSBkbwogICAgICogICAgICAgIG5vdCBhbHJlYWR5IGV4aXN0LgogICAgICogQGV4dHJhIEludGVuZGVkIG9ubHkgZm9yIHVzZSBjcmVhdGluZyBwb2x5ZmlsbHMgdGhhdCBmb2xsb3cgdGhlIEVDTUFTY3JpcHQKICAgICAqICAgICAgICBzcGVjLiBBY2NlcHRzIGVpdGhlciBhIHNpbmdsZSBvYmplY3QgbWFwcGluZyBuYW1lcyB0byBmdW5jdGlvbnMsIG9yCiAgICAgKiAgICAgICAgbmFtZSBhbmQgZnVuY3Rpb24gYXMgdHdvIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgU3VnYXIuT2JqZWN0LmRlZmluZVN0YXRpY1BvbHlmaWxsKHsKICAgICAqICAgICBrZXlzOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgKiAgICAgICAvLyBnZXQga2V5cyEKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqIEBzaWduYXR1cmUgZGVmaW5lU3RhdGljUG9seWZpbGwobWV0aG9kTmFtZSwgbWV0aG9kRm4pCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbWV0aG9kcyAtIE1ldGhvZHMgdG8gYmUgZGVmaW5lZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2ROYW1lIC0gTmFtZSBvZiBhIHNpbmdsZSBtZXRob2QgdG8gYmUgZGVmaW5lZC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG1ldGhvZEZuIC0gRnVuY3Rpb24gYm9keSBvZiBhIHNpbmdsZSBtZXRob2QgdG8gYmUgZGVmaW5lZC4KICAgICAqKiovCiAgICBzZXRQcm9wZXJ0eShzdWdhck5hbWVzcGFjZSwgJ2RlZmluZVN0YXRpY1BvbHlmaWxsJywgZnVuY3Rpb24oYXJnMSwgYXJnMiwgYXJnMykgewogICAgICB2YXIgb3B0cyA9IGNvbGxlY3REZWZpbmVPcHRpb25zKGFyZzEsIGFyZzIsIGFyZzMpOwogICAgICBleHRlbmROYXRpdmUoZ2xvYmFsQ29udGV4dFtuYW1lXSwgb3B0cy5tZXRob2RzLCB0cnVlLCBvcHRzLmxhc3QpOwogICAgICByZXR1cm4gc3VnYXJOYW1lc3BhY2U7CiAgICB9KTsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGRlZmluZUluc3RhbmNlUG9seWZpbGwobWV0aG9kcykKICAgICAqIEByZXR1cm5zIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAbmFtZXNwYWNlIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAc2hvcnQgRGVmaW5lcyBpbnN0YW5jZSBtZXRob2RzIHRoYXQgYXJlIG1hcHBlZCBvbnRvIHRoZSBuYXRpdmUgcHJvdG90eXBlCiAgICAgKiAgICAgICAgaWYgdGhleSBkbyBub3QgYWxyZWFkeSBleGlzdC4KICAgICAqIEBleHRyYSBJbnRlbmRlZCBvbmx5IGZvciB1c2UgY3JlYXRpbmcgcG9seWZpbGxzIHRoYXQgZm9sbG93IHRoZSBFQ01BU2NyaXB0CiAgICAgKiAgICAgICAgc3BlYy4gQWNjZXB0cyBlaXRoZXIgYSBzaW5nbGUgb2JqZWN0IG1hcHBpbmcgbmFtZXMgdG8gZnVuY3Rpb25zLCBvcgogICAgICogICAgICAgIG5hbWUgYW5kIGZ1bmN0aW9uIGFzIHR3byBhcmd1bWVudHMuIFRoaXMgbWV0aG9kIGRpZmZlcnMgZnJvbQogICAgICogICAgICAgIGBkZWZpbmVJbnN0YW5jZWAgYXMgdGhlcmUgaXMgbm8gc3RhdGljIHNpZ25hdHVyZSAoYXMgdGhlIG1ldGhvZAogICAgICogICAgICAgIGlzIG1hcHBlZCBhcy1pcyB0byB0aGUgbmF0aXZlKSwgc28gaXQgc2hvdWxkIHJlZmVyIHRvIGl0cyBgdGhpc2AKICAgICAqICAgICAgICBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFN1Z2FyLkFycmF5LmRlZmluZUluc3RhbmNlUG9seWZpbGwoewogICAgICogICAgIGluZGV4T2Y6IGZ1bmN0aW9uIChhcnIsIGVsKSB7CiAgICAgKiAgICAgICAvLyBpbmRleCBmaW5kaW5nIGNvZGUgaGVyZSEKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqIEBzaWduYXR1cmUgZGVmaW5lSW5zdGFuY2VQb2x5ZmlsbChtZXRob2ROYW1lLCBtZXRob2RGbikKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBtZXRob2RzIC0gTWV0aG9kcyB0byBiZSBkZWZpbmVkLgogICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZE5hbWUgLSBOYW1lIG9mIGEgc2luZ2xlIG1ldGhvZCB0byBiZSBkZWZpbmVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gbWV0aG9kRm4gLSBGdW5jdGlvbiBib2R5IG9mIGEgc2luZ2xlIG1ldGhvZCB0byBiZSBkZWZpbmVkLgogICAgICoqKi8KICAgIHNldFByb3BlcnR5KHN1Z2FyTmFtZXNwYWNlLCAnZGVmaW5lSW5zdGFuY2VQb2x5ZmlsbCcsIGZ1bmN0aW9uKGFyZzEsIGFyZzIsIGFyZzMpIHsKICAgICAgdmFyIG9wdHMgPSBjb2xsZWN0RGVmaW5lT3B0aW9ucyhhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgZXh0ZW5kTmF0aXZlKGdsb2JhbENvbnRleHRbbmFtZV0ucHJvdG90eXBlLCBvcHRzLm1ldGhvZHMsIHRydWUsIG9wdHMubGFzdCk7CiAgICAgIC8vIE1hcCBpbnN0YW5jZSBwb2x5ZmlsbHMgdG8gY2hhaW5hYmxlIGFzIHdlbGwuCiAgICAgIGZvckVhY2hQcm9wZXJ0eShvcHRzLm1ldGhvZHMsIGZ1bmN0aW9uKGZuLCBtZXRob2ROYW1lKSB7CiAgICAgICAgZGVmaW5lQ2hhaW5hYmxlTWV0aG9kKHN1Z2FyTmFtZXNwYWNlLCBtZXRob2ROYW1lLCBmbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gc3VnYXJOYW1lc3BhY2U7CiAgICB9KTsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGFsaWFzKHRvTmFtZSwgZnJvbSkKICAgICAqIEByZXR1cm5zIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAbmFtZXNwYWNlIFN1Z2FyTmFtZXNwYWNlCiAgICAgKiBAc2hvcnQgQWxpYXNlcyBvbmUgU3VnYXIgbWV0aG9kIHRvIGFub3RoZXIuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFN1Z2FyLkFycmF5LmFsaWFzKCdhbGwnLCAnZXZlcnknKTsKICAgICAqCiAgICAgKiBAc2lnbmF0dXJlIGFsaWFzKHRvTmFtZSwgZm4pCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdG9OYW1lIC0gTmFtZSBmb3IgbmV3IG1ldGhvZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfEZ1bmN0aW9ufSBmcm9tIC0gTWV0aG9kIHRvIGFsaWFzLCBvciBzdHJpbmcgc2hvcnRjdXQuCiAgICAgKioqLwogICAgc2V0UHJvcGVydHkoc3VnYXJOYW1lc3BhY2UsICdhbGlhcycsIGZ1bmN0aW9uKG5hbWUsIHNvdXJjZSkgewogICAgICB2YXIgbWV0aG9kID0gdHlwZW9mIHNvdXJjZSA9PT0gJ3N0cmluZycgPyBzdWdhck5hbWVzcGFjZVtzb3VyY2VdIDogc291cmNlOwogICAgICBzZXRNZXRob2Qoc3VnYXJOYW1lc3BhY2UsIG5hbWUsIG1ldGhvZCk7CiAgICAgIHJldHVybiBzdWdhck5hbWVzcGFjZTsKICAgIH0pOwoKICAgIC8vIEVhY2ggbmFtZXNwYWNlIGNhbiBleHRlbmQgb25seSBpdHNlbGYgdGhyb3VnaCBpdHMgLmV4dGVuZCBtZXRob2QuCiAgICBzZXRQcm9wZXJ0eShzdWdhck5hbWVzcGFjZSwgJ2V4dGVuZCcsIGV4dGVuZCk7CgogICAgLy8gQ2FjaGUgdGhlIGNsYXNzIHRvIG5hbWVzcGFjZSByZWxhdGlvbnNoaXAgZm9yIGxhdGVyIHVzZS4KICAgIG5hbWVzcGFjZXNCeU5hbWVbbmFtZV0gPSBzdWdhck5hbWVzcGFjZTsKICAgIG5hbWVzcGFjZXNCeUNsYXNzU3RyaW5nWydbb2JqZWN0ICcgKyBuYW1lICsgJ10nXSA9IHN1Z2FyTmFtZXNwYWNlOwoKICAgIG1hcE5hdGl2ZVRvQ2hhaW5hYmxlKG5hbWUpOwogICAgbWFwT2JqZWN0Q2hhaW5hYmxlc1RvTmFtZXNwYWNlKHN1Z2FyTmFtZXNwYWNlKTsKCgogICAgLy8gRXhwb3J0CiAgICByZXR1cm4gU3VnYXJbbmFtZV0gPSBzdWdhck5hbWVzcGFjZTsKICB9CgogIGZ1bmN0aW9uIHNldEdsb2JhbFByb3BlcnRpZXMoKSB7CiAgICBzZXRQcm9wZXJ0eShTdWdhciwgJ2V4dGVuZCcsIFN1Z2FyKTsKICAgIHNldFByb3BlcnR5KFN1Z2FyLCAndG9TdHJpbmcnLCB0b1N0cmluZyk7CiAgICBzZXRQcm9wZXJ0eShTdWdhciwgJ2NyZWF0ZU5hbWVzcGFjZScsIGNyZWF0ZU5hbWVzcGFjZSk7CgogICAgc2V0UHJvcGVydHkoU3VnYXIsICd1dGlsJywgewogICAgICAnaGFzT3duJzogaGFzT3duLAogICAgICAnZ2V0T3duJzogZ2V0T3duLAogICAgICAnc2V0UHJvcGVydHknOiBzZXRQcm9wZXJ0eSwKICAgICAgJ2NsYXNzVG9TdHJpbmcnOiBjbGFzc1RvU3RyaW5nLAogICAgICAnZGVmaW5lUHJvcGVydHknOiBkZWZpbmVQcm9wZXJ0eSwKICAgICAgJ2ZvckVhY2hQcm9wZXJ0eSc6IGZvckVhY2hQcm9wZXJ0eSwKICAgICAgJ21hcE5hdGl2ZVRvQ2hhaW5hYmxlJzogbWFwTmF0aXZlVG9DaGFpbmFibGUKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gU1VHQVJfR0xPQkFMOwogIH0KCgogIC8vIERlZmluaW5nIE1ldGhvZHMKCiAgZnVuY3Rpb24gZGVmaW5lTWV0aG9kcyhzdWdhck5hbWVzcGFjZSwgbWV0aG9kcywgdHlwZSwgYXJncywgZmxhZ3MpIHsKICAgIGZvckVhY2hQcm9wZXJ0eShtZXRob2RzLCBmdW5jdGlvbihtZXRob2QsIG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGluc3RhbmNlTWV0aG9kLCBzdGF0aWNNZXRob2QgPSBtZXRob2Q7CiAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgc3RhdGljTWV0aG9kID0gd3JhcE1ldGhvZFdpdGhBcmd1bWVudHMobWV0aG9kKTsKICAgICAgfQogICAgICBpZiAoZmxhZ3MpIHsKICAgICAgICBzdGF0aWNNZXRob2QuZmxhZ3MgPSBmbGFnczsKICAgICAgfQoKICAgICAgLy8gQSBtZXRob2QgbWF5IGRlZmluZSBpdHMgb3duIGN1c3RvbSBpbXBsZW1lbnRhdGlvbiwgc28KICAgICAgLy8gbWFrZSBzdXJlIHRoYXQncyBub3QgdGhlIGNhc2UgYmVmb3JlIGNyZWF0aW5nIG9uZS4KICAgICAgaWYgKHR5cGUgJiBJTlNUQU5DRSAmJiAhbWV0aG9kLmluc3RhbmNlKSB7CiAgICAgICAgaW5zdGFuY2VNZXRob2QgPSB3cmFwSW5zdGFuY2VNZXRob2QobWV0aG9kLCBhcmdzKTsKICAgICAgICBzZXRQcm9wZXJ0eShzdGF0aWNNZXRob2QsICdpbnN0YW5jZScsIGluc3RhbmNlTWV0aG9kKTsKICAgICAgfQoKICAgICAgaWYgKHR5cGUgJiBTVEFUSUMpIHsKICAgICAgICBzZXRQcm9wZXJ0eShzdGF0aWNNZXRob2QsICdzdGF0aWMnLCB0cnVlKTsKICAgICAgfQoKICAgICAgc2V0TWV0aG9kKHN1Z2FyTmFtZXNwYWNlLCBtZXRob2ROYW1lLCBzdGF0aWNNZXRob2QpOwoKICAgICAgaWYgKHN1Z2FyTmFtZXNwYWNlLmFjdGl2ZSkgewogICAgICAgIC8vIElmIHRoZSBuYW1lc3BhY2UgaGFzIGJlZW4gYWN0aXZhdGVkICguZXh0ZW5kIGhhcyBiZWVuIGNhbGxlZCksCiAgICAgICAgLy8gdGhlbiBtYXAgdGhpcyBtZXRob2QgYXMgd2VsbC4KICAgICAgICBzdWdhck5hbWVzcGFjZS5leHRlbmQobWV0aG9kTmFtZSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gY29sbGVjdERlZmluZU9wdGlvbnMoYXJnMSwgYXJnMiwgYXJnMykgewogICAgdmFyIG1ldGhvZHMsIGxhc3Q7CiAgICBpZiAodHlwZW9mIGFyZzEgPT09ICdzdHJpbmcnKSB7CiAgICAgIG1ldGhvZHMgPSB7fTsKICAgICAgbWV0aG9kc1thcmcxXSA9IGFyZzI7CiAgICAgIGxhc3QgPSBhcmczOwogICAgfSBlbHNlIHsKICAgICAgbWV0aG9kcyA9IGFyZzE7CiAgICAgIGxhc3QgPSBhcmcyOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgbGFzdDogbGFzdCwKICAgICAgbWV0aG9kczogbWV0aG9kcwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHdyYXBJbnN0YW5jZU1ldGhvZChmbiwgYXJncykgewogICAgcmV0dXJuIGFyZ3MgPyB3cmFwTWV0aG9kV2l0aEFyZ3VtZW50cyhmbiwgdHJ1ZSkgOiB3cmFwSW5zdGFuY2VNZXRob2RGaXhlZChmbik7CiAgfQoKICBmdW5jdGlvbiB3cmFwTWV0aG9kV2l0aEFyZ3VtZW50cyhmbiwgaW5zdGFuY2UpIHsKICAgIC8vIEZ1bmN0aW9ucyBhY2NlcHRpbmcgZW51bWVyYXRlZCBhcmd1bWVudHMgd2lsbCBhbHdheXMgaGF2ZSAiYXJncyIgYXMgdGhlCiAgICAvLyBsYXN0IGFyZ3VtZW50LCBzbyBzdWJ0cmFjdCBvbmUgZnJvbSB0aGUgZnVuY3Rpb24gbGVuZ3RoIHRvIGdldCB0aGUgcG9pbnQKICAgIC8vIGF0IHdoaWNoIHRvIHN0YXJ0IGNvbGxlY3RpbmcgYXJndW1lbnRzLiBJZiB0aGlzIGlzIGFuIGluc3RhbmNlIG1ldGhvZCBvbgogICAgLy8gYSBwcm90b3R5cGUsIHRoZW4gInRoaXMiIHdpbGwgYmUgcHVzaGVkIGludG8gdGhlIGFyZ3VtZW50cyBhcnJheSBzbyBzdGFydAogICAgLy8gY29sbGVjdGluZyAxIGFyZ3VtZW50IGVhcmxpZXIuCiAgICB2YXIgc3RhcnRDb2xsZWN0ID0gZm4ubGVuZ3RoIC0gMSAtIChpbnN0YW5jZSA/IDEgOiAwKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbXSwgY29sbGVjdGVkQXJncyA9IFtdLCBsZW47CiAgICAgIGlmIChpbnN0YW5jZSkgewogICAgICAgIGFyZ3MucHVzaCh0aGlzKTsKICAgICAgfQogICAgICBsZW4gPSBNYXRoLm1heChhcmd1bWVudHMubGVuZ3RoLCBzdGFydENvbGxlY3QpOwogICAgICAvLyBPcHRpbWl6ZWQ6IG5vIGxlYWtpbmcgYXJndW1lbnRzCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoaSA8IHN0YXJ0Q29sbGVjdCkgewogICAgICAgICAgYXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbGxlY3RlZEFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgICBhcmdzLnB1c2goY29sbGVjdGVkQXJncyk7CiAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiB3cmFwSW5zdGFuY2VNZXRob2RGaXhlZChmbikgewogICAgc3dpdGNoKGZuLmxlbmd0aCkgewogICAgICAvLyBXcmFwcGVkIGluc3RhbmNlIG1ldGhvZHMgd2lsbCBhbHdheXMgYmUgcGFzc2VkIHRoZSBpbnN0YW5jZQogICAgICAvLyBhcyB0aGUgZmlyc3QgYXJndW1lbnQsIGJ1dCByZXF1aXJpbmcgdGhlIGFyZ3VtZW50IHRvIGJlIGRlZmluZWQKICAgICAgLy8gbWF5IGNhdXNlIGNvbmZ1c2lvbiBoZXJlLCBzbyByZXR1cm4gdGhlIHNhbWUgd3JhcHBlZCBmdW5jdGlvbiByZWdhcmRsZXNzLgogICAgICBjYXNlIDA6CiAgICAgIGNhc2UgMToKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gZm4odGhpcyk7CiAgICAgICAgfTsKICAgICAgY2FzZSAyOgogICAgICAgIHJldHVybiBmdW5jdGlvbihhKSB7CiAgICAgICAgICByZXR1cm4gZm4odGhpcywgYSk7CiAgICAgICAgfTsKICAgICAgY2FzZSAzOgogICAgICAgIHJldHVybiBmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICByZXR1cm4gZm4odGhpcywgYSwgYik7CiAgICAgICAgfTsKICAgICAgY2FzZSA0OgogICAgICAgIHJldHVybiBmdW5jdGlvbihhLCBiLCBjKSB7CiAgICAgICAgICByZXR1cm4gZm4odGhpcywgYSwgYiwgYyk7CiAgICAgICAgfTsKICAgICAgY2FzZSA1OgogICAgICAgIHJldHVybiBmdW5jdGlvbihhLCBiLCBjLCBkKSB7CiAgICAgICAgICByZXR1cm4gZm4odGhpcywgYSwgYiwgYywgZCk7CiAgICAgICAgfTsKICAgIH0KICB9CgogIC8vIE1ldGhvZCBoZWxwZXJzCgogIGZ1bmN0aW9uIGV4dGVuZE5hdGl2ZSh0YXJnZXQsIHNvdXJjZSwgcG9seWZpbGwsIG92ZXJyaWRlKSB7CiAgICBmb3JFYWNoUHJvcGVydHkoc291cmNlLCBmdW5jdGlvbihtZXRob2QsIG5hbWUpIHsKICAgICAgaWYgKHBvbHlmaWxsICYmICFvdmVycmlkZSAmJiB0YXJnZXRbbmFtZV0pIHsKICAgICAgICAvLyBNZXRob2QgZXhpc3RzLCBzbyBiYWlsLgogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzZXRQcm9wZXJ0eSh0YXJnZXQsIG5hbWUsIG1ldGhvZCk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHNldE1ldGhvZChzdWdhck5hbWVzcGFjZSwgbWV0aG9kTmFtZSwgbWV0aG9kKSB7CiAgICBzdWdhck5hbWVzcGFjZVttZXRob2ROYW1lXSA9IG1ldGhvZDsKICAgIGlmIChtZXRob2QuaW5zdGFuY2UpIHsKICAgICAgZGVmaW5lQ2hhaW5hYmxlTWV0aG9kKHN1Z2FyTmFtZXNwYWNlLCBtZXRob2ROYW1lLCBtZXRob2QuaW5zdGFuY2UsIHRydWUpOwogICAgfQogIH0KCgogIC8vIENoYWluYWJsZXMKCiAgZnVuY3Rpb24gZ2V0TmV3Q2hhaW5hYmxlQ2xhc3MobmFtZSkgewogICAgdmFyIGZuID0gZnVuY3Rpb24gU3VnYXJDaGFpbmFibGUob2JqLCBhcmcpIHsKICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGZuKSkgewogICAgICAgIHJldHVybiBuZXcgZm4ob2JqLCBhcmcpOwogICAgICB9CiAgICAgIGlmICh0aGlzLmNvbnN0cnVjdG9yICE9PSBmbikgewogICAgICAgIC8vIEFsbG93IG1vZHVsZXMgdG8gZGVmaW5lIHRoZWlyIG93biBjb25zdHJ1Y3RvcnMuCiAgICAgICAgb2JqID0gdGhpcy5jb25zdHJ1Y3Rvci5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgICAgdGhpcy5yYXcgPSBvYmo7CiAgICB9OwogICAgc2V0UHJvcGVydHkoZm4sICd0b1N0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gU1VHQVJfR0xPQkFMICsgbmFtZTsKICAgIH0pOwogICAgc2V0UHJvcGVydHkoZm4ucHJvdG90eXBlLCAndmFsdWVPZicsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5yYXc7CiAgICB9KTsKICAgIHJldHVybiBmbjsKICB9CgogIGZ1bmN0aW9uIGRlZmluZUNoYWluYWJsZU1ldGhvZChzdWdhck5hbWVzcGFjZSwgbWV0aG9kTmFtZSwgZm4pIHsKICAgIHZhciB3cmFwcGVkID0gd3JhcFdpdGhDaGFpbmFibGVSZXN1bHQoZm4pLCBleGlzdGluZywgY29sbGlzaW9uLCBkY3A7CiAgICBkY3AgPSBEZWZhdWx0Q2hhaW5hYmxlLnByb3RvdHlwZTsKICAgIGV4aXN0aW5nID0gZGNwW21ldGhvZE5hbWVdOwoKICAgIC8vIElmIHRoZSBtZXRob2Qgd2FzIHByZXZpb3VzbHkgZGVmaW5lZCBvbiB0aGUgZGVmYXVsdCBjaGFpbmFibGUsIHRoZW4gYQogICAgLy8gY29sbGlzaW9uIGV4aXN0cywgc28gc2V0IHRoZSBtZXRob2QgdG8gYSBkaXNhbWJpZ3VhdGlvbiBmdW5jdGlvbiB0aGF0IHdpbGwKICAgIC8vIGxhemlseSBldmFsdWF0ZSB0aGUgb2JqZWN0IGFuZCBmaW5kIGl0J3MgYXNzb2NpYXRlZCBjaGFpbmFibGUuIEFuIGV4dHJhCiAgICAvLyBjaGVjayBpcyByZXF1aXJlZCB0byBhdm9pZCBmYWxzZSBwb3NpdGl2ZXMgZnJvbSBPYmplY3QgaW5oZXJpdGVkIG1ldGhvZHMuCiAgICBjb2xsaXNpb24gPSBleGlzdGluZyAmJiBleGlzdGluZyAhPT0gT2JqZWN0LnByb3RvdHlwZVttZXRob2ROYW1lXTsKCiAgICAvLyBUaGUgZGlzYW1iaWd1YXRpb24gZnVuY3Rpb24gaXMgb25seSByZXF1aXJlZCBvbmNlLgogICAgaWYgKCFleGlzdGluZyB8fCAhZXhpc3RpbmcuZGlzYW1iaWd1YXRlKSB7CiAgICAgIGRjcFttZXRob2ROYW1lXSA9IGNvbGxpc2lvbiA/IGRpc2FtYmlndWF0ZU1ldGhvZChtZXRob2ROYW1lKSA6IHdyYXBwZWQ7CiAgICB9CgogICAgLy8gVGhlIHRhcmdldCBjaGFpbmFibGUgYWx3YXlzIHJlY2VpdmVzIHRoZSB3cmFwcGVkIG1ldGhvZC4gQWRkaXRpb25hbGx5LAogICAgLy8gaWYgdGhlIHRhcmdldCBjaGFpbmFibGUgaXMgU3VnYXIuT2JqZWN0LCB0aGVuIG1hcCB0aGUgd3JhcHBlZCBtZXRob2QKICAgIC8vIHRvIGFsbCBvdGhlciBuYW1lc3BhY2VzIGFzIHdlbGwgaWYgdGhleSBkbyBub3QgZGVmaW5lIHRoZWlyIG93biBtZXRob2QKICAgIC8vIG9mIHRoZSBzYW1lIG5hbWUuIFRoaXMgd2F5LCBhIFN1Z2FyLk51bWJlciB3aWxsIGhhdmUgbWV0aG9kcyBsaWtlCiAgICAvLyBpc0VxdWFsIHRoYXQgY2FuIGJlIGNhbGxlZCBvbiBhbnkgb2JqZWN0IHdpdGhvdXQgaGF2aW5nIHRvIHRyYXZlcnNlIHVwCiAgICAvLyB0aGUgcHJvdG90eXBlIGNoYWluIGFuZCBwZXJmb3JtIGRpc2FtYmlndWF0aW9uLCB3aGljaCBjb3N0cyBjeWNsZXMuCiAgICAvLyBOb3RlIHRoYXQgdGhlICJpZiIgYmxvY2sgYmVsb3cgYWN0dWFsbHkgZG9lcyBub3RoaW5nIG9uIGluaXQgYXMgT2JqZWN0CiAgICAvLyBnb2VzIGZpcnN0IGFuZCBubyBvdGhlciBuYW1lc3BhY2VzIGV4aXN0IHlldC4gSG93ZXZlciBpdCBuZWVkcyB0byBiZQogICAgLy8gaGVyZSBhcyBPYmplY3QgaW5zdGFuY2UgbWV0aG9kcyBkZWZpbmVkIGxhdGVyIGFsc28gbmVlZCB0byBiZSBtYXBwZWQKICAgIC8vIGJhY2sgb250byBleGlzdGluZyBuYW1lc3BhY2VzLgogICAgc3VnYXJOYW1lc3BhY2UucHJvdG90eXBlW21ldGhvZE5hbWVdID0gd3JhcHBlZDsKICAgIGlmIChzdWdhck5hbWVzcGFjZSA9PT0gU3VnYXIuT2JqZWN0KSB7CiAgICAgIG1hcE9iamVjdENoYWluYWJsZVRvQWxsTmFtZXNwYWNlcyhtZXRob2ROYW1lLCB3cmFwcGVkKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG1hcE9iamVjdENoYWluYWJsZXNUb05hbWVzcGFjZShzdWdhck5hbWVzcGFjZSkgewogICAgZm9yRWFjaFByb3BlcnR5KFN1Z2FyLk9iamVjdCAmJiBTdWdhci5PYmplY3QucHJvdG90eXBlLCBmdW5jdGlvbih2YWwsIG1ldGhvZE5hbWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBzZXRPYmplY3RDaGFpbmFibGVPbk5hbWVzcGFjZShzdWdhck5hbWVzcGFjZSwgbWV0aG9kTmFtZSwgdmFsKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBtYXBPYmplY3RDaGFpbmFibGVUb0FsbE5hbWVzcGFjZXMobWV0aG9kTmFtZSwgZm4pIHsKICAgIGZvckVhY2hQcm9wZXJ0eShuYW1lc3BhY2VzQnlOYW1lLCBmdW5jdGlvbihzdWdhck5hbWVzcGFjZSkgewogICAgICBzZXRPYmplY3RDaGFpbmFibGVPbk5hbWVzcGFjZShzdWdhck5hbWVzcGFjZSwgbWV0aG9kTmFtZSwgZm4pOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBzZXRPYmplY3RDaGFpbmFibGVPbk5hbWVzcGFjZShzdWdhck5hbWVzcGFjZSwgbWV0aG9kTmFtZSwgZm4pIHsKICAgIHZhciBwcm90byA9IHN1Z2FyTmFtZXNwYWNlLnByb3RvdHlwZTsKICAgIGlmICghaGFzT3duKHByb3RvLCBtZXRob2ROYW1lKSkgewogICAgICBwcm90b1ttZXRob2ROYW1lXSA9IGZuOwogICAgfQogIH0KCiAgZnVuY3Rpb24gd3JhcFdpdGhDaGFpbmFibGVSZXN1bHQoZm4pIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyBEZWZhdWx0Q2hhaW5hYmxlKGZuLmFwcGx5KHRoaXMucmF3LCBhcmd1bWVudHMpKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBkaXNhbWJpZ3VhdGVNZXRob2QobWV0aG9kTmFtZSkgewogICAgdmFyIGZuID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciByYXcgPSB0aGlzLnJhdywgc3VnYXJOYW1lc3BhY2UsIGZuOwogICAgICBpZiAocmF3ICE9IG51bGwpIHsKICAgICAgICAvLyBGaW5kIHRoZSBTdWdhciBuYW1lc3BhY2UgZm9yIHRoaXMgdW5rbm93bi4KICAgICAgICBzdWdhck5hbWVzcGFjZSA9IG5hbWVzcGFjZXNCeUNsYXNzU3RyaW5nW2NsYXNzVG9TdHJpbmcocmF3KV07CiAgICAgIH0KICAgICAgaWYgKCFzdWdhck5hbWVzcGFjZSkgewogICAgICAgIC8vIElmIG5vIHN1Z2FyTmFtZXNwYWNlIGNhbiBiZSByZXNvbHZlZCwgdGhlbiBkZWZhdWx0CiAgICAgICAgLy8gYmFjayB0byBTdWdhci5PYmplY3Qgc28gdGhhdCB1bmRlZmluZWQgYW5kIG90aGVyCiAgICAgICAgLy8gbm9uLXN1cHBvcnRlZCB0eXBlcyBjYW4gc3RpbGwgaGF2ZSBiYXNpYyBvYmplY3QKICAgICAgICAvLyBtZXRob2RzIGNhbGxlZCBvbiB0aGVtLCBzdWNoIGFzIHR5cGUgY2hlY2tzLgogICAgICAgIHN1Z2FyTmFtZXNwYWNlID0gU3VnYXIuT2JqZWN0OwogICAgICB9CgogICAgICBmbiA9IG5ldyBzdWdhck5hbWVzcGFjZShyYXcpW21ldGhvZE5hbWVdOwoKICAgICAgaWYgKGZuLmRpc2FtYmlndWF0ZSkgewogICAgICAgIC8vIElmIHRoZSBtZXRob2QgYWJvdXQgdG8gYmUgY2FsbGVkIG9uIHRoaXMgY2hhaW5hYmxlIGlzCiAgICAgICAgLy8gaXRzZWxmIGEgZGlzYW1iaWd1YXRpb24gbWV0aG9kLCB0aGVuIHRocm93IGFuIGVycm9yIHRvCiAgICAgICAgLy8gcHJldmVudCBpbmZpbml0ZSByZWN1cnNpb24uCiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IHJlc29sdmUgbmFtZXNwYWNlIGZvciAnICsgcmF3KTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogICAgZm4uZGlzYW1iaWd1YXRlID0gdHJ1ZTsKICAgIHJldHVybiBmbjsKICB9CgogIGZ1bmN0aW9uIG1hcE5hdGl2ZVRvQ2hhaW5hYmxlKG5hbWUsIG1ldGhvZE5hbWVzKSB7CiAgICB2YXIgc3VnYXJOYW1lc3BhY2UgPSBuYW1lc3BhY2VzQnlOYW1lW25hbWVdLAogICAgICAgIG5hdGl2ZVByb3RvID0gZ2xvYmFsQ29udGV4dFtuYW1lXS5wcm90b3R5cGU7CgogICAgaWYgKCFtZXRob2ROYW1lcyAmJiBvd25Qcm9wZXJ0eU5hbWVzKSB7CiAgICAgIG1ldGhvZE5hbWVzID0gb3duUHJvcGVydHlOYW1lcyhuYXRpdmVQcm90byk7CiAgICB9CgogICAgZm9yRWFjaFByb3BlcnR5KG1ldGhvZE5hbWVzLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgIGlmIChuYXRpdmVNZXRob2RQcm9oaWJpdGVkKG1ldGhvZE5hbWUpKSB7CiAgICAgICAgLy8gU3VnYXIgY2hhaW5hYmxlcyBoYXZlIHRoZWlyIG93biBjb25zdHJ1Y3RvcnMgYXMgd2VsbCBhcyAidmFsdWVPZiIKICAgICAgICAvLyBtZXRob2RzLCBzbyBleGNsdWRlIHRoZW0gaGVyZS4gVGhlIF9fcHJvdG9fXyBhcmd1bWVudCBzaG91bGQgYmUgdHJhcHBlZAogICAgICAgIC8vIGJ5IHRoZSBmdW5jdGlvbiBjaGVjayBiZWxvdywgaG93ZXZlciBzaW1wbHkgYWNjZXNzaW5nIHRoaXMgcHJvcGVydHkgb24KICAgICAgICAvLyBPYmplY3QucHJvdG90eXBlIGNhdXNlcyBRTUwgdG8gc2VnZmF1bHQsIHNvIHByZS1lbXB0aXZlbHkgZXhjbHVkaW5nIGl0LgogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIHZhciBmbiA9IG5hdGl2ZVByb3RvW21ldGhvZE5hbWVdOwogICAgICAgIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIC8vIEJhaWwgb24gYW55dGhpbmcgbm90IGEgZnVuY3Rpb24uCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgLy8gRnVuY3Rpb24ucHJvdG90eXBlIGhhcyBwcm9wZXJ0aWVzIHRoYXQKICAgICAgICAvLyB3aWxsIHRocm93IGVycm9ycyB3aGVuIGFjY2Vzc2VkLgogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBkZWZpbmVDaGFpbmFibGVNZXRob2Qoc3VnYXJOYW1lc3BhY2UsIG1ldGhvZE5hbWUsIGZuKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gbmF0aXZlTWV0aG9kUHJvaGliaXRlZChtZXRob2ROYW1lKSB7CiAgICByZXR1cm4gbWV0aG9kTmFtZSA9PT0gJ2NvbnN0cnVjdG9yJyB8fAogICAgICAgICAgIG1ldGhvZE5hbWUgPT09ICd2YWx1ZU9mJyB8fAogICAgICAgICAgIG1ldGhvZE5hbWUgPT09ICdfX3Byb3RvX18nOwogIH0KCgogIC8vIFV0aWwKCiAgLy8gSW50ZXJuYWwgcmVmZXJlbmNlcwogIHZhciBvd25Qcm9wZXJ0eU5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMsCiAgICAgIGludGVybmFsVG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgICBpbnRlcm5hbEhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCiAgLy8gRGVmaW5pbmcgdGhpcyBhcyBhIHZhcmlhYmxlIGhlcmUgYXMgdGhlIEVTNSBtb2R1bGUKICAvLyBvdmVyd3JpdGVzIGl0IHRvIHBhdGNoIERPTlRFTlVNLgogIHZhciBmb3JFYWNoUHJvcGVydHkgPSBmdW5jdGlvbiAob2JqLCBmbikgewogICAgZm9yKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghaGFzT3duKG9iaiwga2V5KSkgY29udGludWU7CiAgICAgIGlmIChmbi5jYWxsKG9iaiwgb2JqW2tleV0sIGtleSwgb2JqKSA9PT0gZmFsc2UpIGJyZWFrOwogICAgfQogIH07CgogIGZ1bmN0aW9uIGRlZmluZVByb3BlcnR5U2hpbShvYmosIHByb3AsIGRlc2NyaXB0b3IpIHsKICAgIG9ialtwcm9wXSA9IGRlc2NyaXB0b3IudmFsdWU7CiAgfQoKICBmdW5jdGlvbiBzZXRQcm9wZXJ0eSh0YXJnZXQsIG5hbWUsIHZhbHVlLCBlbnVtZXJhYmxlKSB7CiAgICBkZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIG5hbWUsIHsKICAgICAgdmFsdWU6IHZhbHVlLAogICAgICBlbnVtZXJhYmxlOiAhIWVudW1lcmFibGUsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgd3JpdGFibGU6IHRydWUKICAgIH0pOwogIH0KCiAgLy8gUEVSRjogQXR0ZW1wdHMgdG8gc3BlZWQgdGhpcyBtZXRob2QgdXAgZ2V0IHZlcnkgSGVpc2VuYmVyZ3kuIFF1aWNrbHkKICAvLyByZXR1cm5pbmcgYmFzZWQgb24gdHlwZW9mIHdvcmtzIGZvciBwcmltaXRpdmVzLCBidXQgc2xvd3MgZG93biBvYmplY3QKICAvLyB0eXBlcy4gRXZlbiA9PT0gY2hlY2tzIG9uIG51bGwgYW5kIHVuZGVmaW5lZCAobm8gdHlwZW9mKSB3aWxsIGVuZCB1cAogIC8vIGJhc2ljYWxseSBicmVha2luZyBldmVuLiBUaGlzIHNlZW1zIHRvIGJlIGFzIGZhc3QgYXMgaXQgY2FuIGdvLgogIGZ1bmN0aW9uIGNsYXNzVG9TdHJpbmcob2JqKSB7CiAgICByZXR1cm4gaW50ZXJuYWxUb1N0cmluZy5jYWxsKG9iaik7CiAgfQoKICBmdW5jdGlvbiBoYXNPd24ob2JqLCBwcm9wKSB7CiAgICByZXR1cm4gISFvYmogJiYgaW50ZXJuYWxIYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7CiAgfQoKICBmdW5jdGlvbiBnZXRPd24ob2JqLCBwcm9wKSB7CiAgICBpZiAoaGFzT3duKG9iaiwgcHJvcCkpIHsKICAgICAgcmV0dXJuIG9ialtwcm9wXTsKICAgIH0KICB9CgogIHNldHVwR2xvYmFsKCk7CgogIC8qKioKICAgKiBAbW9kdWxlIENvbW1vbgogICAqIEBkZXNjcmlwdGlvbiBJbnRlcm5hbCB1dGlsaXR5IGFuZCBjb21tb24gbWV0aG9kcy4KICAgKioqLwoKICAvLyBGbGFnIGFsbG93aW5nIG5hdGl2ZSBtZXRob2RzIHRvIGJlIGVuaGFuY2VkCiAgdmFyIEVOSEFOQ0VNRU5UU19GTEFHID0gJ2VuaGFuY2UnOwoKICAvLyBGb3IgdHlwZSBjaGVja2luZywgZXRjLiBFeGNsdWRlcyBvYmplY3QgYXMgdGhpcyBpcyBtb3JlIG51YW5jZWQuCiAgdmFyIE5BVElWRV9UWVBFUyA9ICdCb29sZWFuIE51bWJlciBTdHJpbmcgRGF0ZSBSZWdFeHAgRnVuY3Rpb24gQXJyYXkgRXJyb3IgU2V0IE1hcCc7CgogIC8vIERvIHN0cmluZ3MgaGF2ZSBubyBrZXlzPwogIHZhciBOT19LRVlTX0lOX1NUUklOR19PQkpFQ1RTID0gISgnMCcgaW4gT2JqZWN0KCdhJykpOwoKICAvLyBQcmVmaXggZm9yIHByaXZhdGUgcHJvcGVydGllcwogIHZhciBQUklWQVRFX1BST1BfUFJFRklYID0gJ19zdWdhcl8nOwoKICAvLyBNYXRjaGVzIDEuLjIgc3R5bGUgcmFuZ2VzIGluIHByb3BlcnRpZXMKICB2YXIgUFJPUEVSVFlfUkFOR0VfUkVHID0gL14oLio/KVxbKFstXGRdKilcLlwuKFstXGRdKilcXSguKikkLzsKCiAgLy8gV2hpdGVTcGFjZS9MaW5lVGVybWluYXRvciBhcyBkZWZpbmVkIGluIEVTNS4xIHBsdXMgVW5pY29kZSBjaGFyYWN0ZXJzIGluIHRoZSBTcGFjZSwgU2VwYXJhdG9yIGNhdGVnb3J5LgogIHZhciBUUklNX0NIQVJTID0gJ1x1MDAwOVx1MDAwQVx1MDAwQlx1MDAwQ1x1MDAwRFx1MDAyMFx1MDBBMFx1MTY4MFx1MTgwRVx1MjAwMFx1MjAwMVx1MjAwMlx1MjAwM1x1MjAwNFx1MjAwNVx1MjAwNlx1MjAwN1x1MjAwOFx1MjAwOVx1MjAwQVx1MjAyRlx1MjA1Rlx1MjAyOFx1MjAyOVx1MzAwMFx1RkVGRic7CgogIC8vIFJlZ2V4IGZvciBtYXRjaGluZyBhIGZvcm1hdHRlZCBzdHJpbmcKICB2YXIgU1RSSU5HX0ZPUk1BVF9SRUcgPSAvKFt7fV0pXDF8XHsoW159XSopXH18KCUpJXwoJShcdyopKS9nOwoKICAvLyBDb21tb24gY2hhcnMKICB2YXIgSEFMRl9XSURUSF9aRVJPID0gMHgzMCwKICAgICAgRlVMTF9XSURUSF9aRVJPID0gMHhmZjEwLAogICAgICBIQUxGX1dJRFRIX1BFUklPRCAgID0gJy4nLAogICAgICBGVUxMX1dJRFRIX1BFUklPRCAgID0gJ++8jicsCiAgICAgIEhBTEZfV0lEVEhfQ09NTUEgICAgPSAnLCcsCiAgICAgIE9QRU5fQlJBQ0UgID0gJ3snLAogICAgICBDTE9TRV9CUkFDRSA9ICd9JzsKCiAgLy8gTmFtZXNwYWNlIGFsaWFzZXMKICB2YXIgc3VnYXJPYmplY3QgICA9IFN1Z2FyLk9iamVjdCwKICAgICAgc3VnYXJBcnJheSAgICA9IFN1Z2FyLkFycmF5LAogICAgICBzdWdhckRhdGUgICAgID0gU3VnYXIuRGF0ZSwKICAgICAgc3VnYXJTdHJpbmcgICA9IFN1Z2FyLlN0cmluZywKICAgICAgc3VnYXJOdW1iZXIgICA9IFN1Z2FyLk51bWJlciwKICAgICAgc3VnYXJGdW5jdGlvbiA9IFN1Z2FyLkZ1bmN0aW9uLAogICAgICBzdWdhclJlZ0V4cCAgID0gU3VnYXIuUmVnRXhwOwoKICAvLyBDbGFzcyBjaGVja3MKICB2YXIgaXNTZXJpYWxpemFibGUsCiAgICAgIGlzQm9vbGVhbiwgaXNOdW1iZXIsIGlzU3RyaW5nLAogICAgICBpc0RhdGUsIGlzUmVnRXhwLCBpc0Z1bmN0aW9uLAogICAgICBpc0FycmF5LCBpc1NldCwgaXNNYXAsIGlzRXJyb3I7CgogIGZ1bmN0aW9uIGJ1aWxkQ2xhc3NDaGVja3MoKSB7CgogICAgdmFyIGtub3duVHlwZXMgPSB7fTsKCiAgICBmdW5jdGlvbiBhZGRDb3JlVHlwZXMoKSB7CgogICAgICB2YXIgbmFtZXMgPSBzcGFjZVNwbGl0KE5BVElWRV9UWVBFUyk7CgogICAgICBpc0Jvb2xlYW4gPSBidWlsZFByaW1pdGl2ZUNsYXNzQ2hlY2sobmFtZXNbMF0pOwogICAgICBpc051bWJlciAgPSBidWlsZFByaW1pdGl2ZUNsYXNzQ2hlY2sobmFtZXNbMV0pOwogICAgICBpc1N0cmluZyAgPSBidWlsZFByaW1pdGl2ZUNsYXNzQ2hlY2sobmFtZXNbMl0pOwoKICAgICAgaXNEYXRlICAgPSBidWlsZENsYXNzQ2hlY2sobmFtZXNbM10pOwogICAgICBpc1JlZ0V4cCA9IGJ1aWxkQ2xhc3NDaGVjayhuYW1lc1s0XSk7CgogICAgICAvLyBXYW50ZWQgdG8gZW5oYW5jZSBwZXJmb3JtYW5jZSBoZXJlIGJ5IHVzaW5nIHNpbXBseSAidHlwZW9mIgogICAgICAvLyBidXQgRmlyZWZveCBoYXMgdHdvIG1ham9yIGlzc3VlcyB0aGF0IG1ha2UgdGhpcyBpbXBvc3NpYmxlLAogICAgICAvLyBvbmUgZml4ZWQsIHRoZSBvdGhlciBub3QsIHNvIHBlcmZvcm0gYSBmdWxsIGNsYXNzIGNoZWNrIGhlcmUuCiAgICAgIC8vCiAgICAgIC8vIDEuIFJlZ2V4ZXMgY2FuIGJlIHR5cGVvZiAiZnVuY3Rpb24iIGluIEZGIDwgMwogICAgICAvLyAgICBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02MTkxMSAoZml4ZWQpCiAgICAgIC8vCiAgICAgIC8vIDIuIEhUTUxFbWJlZEVsZW1lbnQgYW5kIEhUTUxPYmplY3RFbGVtZW50IGFyZSBiZSB0eXBlb2YgImZ1bmN0aW9uIgogICAgICAvLyAgICBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD0yNjg5NDUgKHdvbid0IGZpeCkKICAgICAgaXNGdW5jdGlvbiA9IGJ1aWxkQ2xhc3NDaGVjayhuYW1lc1s1XSk7CgoKICAgICAgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgYnVpbGRDbGFzc0NoZWNrKG5hbWVzWzZdKTsKICAgICAgaXNFcnJvciA9IGJ1aWxkQ2xhc3NDaGVjayhuYW1lc1s3XSk7CgogICAgICBpc1NldCA9IGJ1aWxkQ2xhc3NDaGVjayhuYW1lc1s4XSwgdHlwZW9mIFNldCAhPT0gJ3VuZGVmaW5lZCcgJiYgU2V0KTsKICAgICAgaXNNYXAgPSBidWlsZENsYXNzQ2hlY2sobmFtZXNbOV0sIHR5cGVvZiBNYXAgIT09ICd1bmRlZmluZWQnICYmIE1hcCk7CgogICAgICAvLyBBZGQgY29yZSB0eXBlcyBhcyBrbm93biBzbyB0aGF0IHRoZXkgY2FuIGJlIGNoZWNrZWQgYnkgdmFsdWUgYmVsb3csCiAgICAgIC8vIG5vdGFibHkgZXhjbHVkaW5nIEZ1bmN0aW9ucyBhbmQgYWRkaW5nIEFyZ3VtZW50cyBhbmQgRXJyb3IuCiAgICAgIGFkZEtub3duVHlwZSgnQXJndW1lbnRzJyk7CiAgICAgIGFkZEtub3duVHlwZShuYW1lc1swXSk7CiAgICAgIGFkZEtub3duVHlwZShuYW1lc1sxXSk7CiAgICAgIGFkZEtub3duVHlwZShuYW1lc1syXSk7CiAgICAgIGFkZEtub3duVHlwZShuYW1lc1szXSk7CiAgICAgIGFkZEtub3duVHlwZShuYW1lc1s0XSk7CiAgICAgIGFkZEtub3duVHlwZShuYW1lc1s2XSk7CgogICAgfQoKICAgIGZ1bmN0aW9uIGFkZEFycmF5VHlwZXMoKSB7CiAgICAgIHZhciB0eXBlcyA9ICdJbnQ4IFVpbnQ4IFVpbnQ4Q2xhbXBlZCBJbnQxNiBVaW50MTYgSW50MzIgVWludDMyIEZsb2F0MzIgRmxvYXQ2NCc7CiAgICAgIGZvckVhY2goc3BhY2VTcGxpdCh0eXBlcyksIGZ1bmN0aW9uKHN0cikgewogICAgICAgIGFkZEtub3duVHlwZShzdHIgKyAnQXJyYXknKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkS25vd25UeXBlKGNsYXNzTmFtZSkgewogICAgICB2YXIgc3RyID0gJ1tvYmplY3QgJysgY2xhc3NOYW1lICsnXSc7CiAgICAgIGtub3duVHlwZXNbc3RyXSA9IHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gaXNLbm93blR5cGUoY2xhc3NOYW1lKSB7CiAgICAgIHJldHVybiBrbm93blR5cGVzW2NsYXNzTmFtZV07CiAgICB9CgogICAgZnVuY3Rpb24gYnVpbGRDbGFzc0NoZWNrKGNsYXNzTmFtZSwgZ2xvYmFsT2JqZWN0KSB7CiAgICAgIGlmIChnbG9iYWxPYmplY3QgJiYgaXNDbGFzcyhuZXcgZ2xvYmFsT2JqZWN0LCAnT2JqZWN0JykpIHsKICAgICAgICByZXR1cm4gZ2V0Q29uc3RydWN0b3JDbGFzc0NoZWNrKGdsb2JhbE9iamVjdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGdldFRvU3RyaW5nQ2xhc3NDaGVjayhjbGFzc05hbWUpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q29uc3RydWN0b3JDbGFzc0NoZWNrKG9iaikgewogICAgICB2YXIgY3RvclN0ciA9IFN0cmluZyhvYmopOwogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgcmV0dXJuIFN0cmluZyhvYmouY29uc3RydWN0b3IpID09PSBjdG9yU3RyOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFRvU3RyaW5nQ2xhc3NDaGVjayhjbGFzc05hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iaiwgc3RyKSB7CiAgICAgICAgLy8gcGVyZjogUmV0dXJuaW5nIHVwIGZyb250IG9uIGluc3RhbmNlb2YgYXBwZWFycyB0byBiZSBzbG93ZXIuCiAgICAgICAgcmV0dXJuIGlzQ2xhc3Mob2JqLCBjbGFzc05hbWUsIHN0cik7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gYnVpbGRQcmltaXRpdmVDbGFzc0NoZWNrKGNsYXNzTmFtZSkgewogICAgICB2YXIgdHlwZSA9IGNsYXNzTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgdmFyIHQgPSB0eXBlb2Ygb2JqOwogICAgICAgIHJldHVybiB0ID09PSB0eXBlIHx8IHQgPT09ICdvYmplY3QnICYmIGlzQ2xhc3Mob2JqLCBjbGFzc05hbWUpOwogICAgICB9OwogICAgfQoKICAgIGFkZENvcmVUeXBlcygpOwogICAgYWRkQXJyYXlUeXBlcygpOwoKICAgIGlzU2VyaWFsaXphYmxlID0gZnVuY3Rpb24ob2JqLCBjbGFzc05hbWUpIHsKICAgICAgLy8gT25seSBrbm93biBvYmplY3RzIGNhbiBiZSBzZXJpYWxpemVkLiBUaGlzIG5vdGFibHkgZXhjbHVkZXMgZnVuY3Rpb25zLAogICAgICAvLyBob3N0IG9iamVjdHMsIFN5bWJvbHMgKHdoaWNoIGFyZSBtYXRjaGVkIGJ5IHJlZmVyZW5jZSksIGFuZCBpbnN0YW5jZXMKICAgICAgLy8gb2YgY2xhc3Nlcy4gVGhlIGxhdHRlciBjYW4gYXJndWFibHkgYmUgbWF0Y2hlZCBieSB2YWx1ZSwgYnV0CiAgICAgIC8vIGRpc3Rpbmd1aXNoaW5nIGJldHdlZW4gdGhlc2UgYW5kIGhvc3Qgb2JqZWN0cyAtLSB3aGljaCBzaG91bGQgbmV2ZXIgYmUKICAgICAgLy8gY29tcGFyZWQgYnkgdmFsdWUgLS0gaXMgdmVyeSB0cmlja3kgc28gbm90IGRlYWxpbmcgd2l0aCBpdCBoZXJlLgogICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgY2xhc3NUb1N0cmluZyhvYmopOwogICAgICByZXR1cm4gaXNLbm93blR5cGUoY2xhc3NOYW1lKSB8fCBpc1BsYWluT2JqZWN0KG9iaiwgY2xhc3NOYW1lKTsKICAgIH07CgogIH0KCiAgZnVuY3Rpb24gaXNDbGFzcyhvYmosIGNsYXNzTmFtZSwgc3RyKSB7CiAgICBpZiAoIXN0cikgewogICAgICBzdHIgPSBjbGFzc1RvU3RyaW5nKG9iaik7CiAgICB9CiAgICByZXR1cm4gc3RyID09PSAnW29iamVjdCAnKyBjbGFzc05hbWUgKyddJzsKICB9CgogIC8vIFdyYXBwaW5nIHRoZSBjb3JlJ3MgImRlZmluZSIgbWV0aG9kcyB0bwogIC8vIHNhdmUgYSBmZXcgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIHNjcmlwdC4KICBmdW5jdGlvbiB3cmFwTmFtZXNwYWNlKG1ldGhvZCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHN1Z2FyTmFtZXNwYWNlLCBhcmcxLCBhcmcyKSB7CiAgICAgIHN1Z2FyTmFtZXNwYWNlW21ldGhvZF0oYXJnMSwgYXJnMik7CiAgICB9OwogIH0KCiAgLy8gTWV0aG9kIGRlZmluZSBhbGlhc2VzCiAgdmFyIGFsaWFzICAgICAgICAgICAgICAgICAgICAgICA9IHdyYXBOYW1lc3BhY2UoJ2FsaWFzJyksCiAgICAgIGRlZmluZVN0YXRpYyAgICAgICAgICAgICAgICA9IHdyYXBOYW1lc3BhY2UoJ2RlZmluZVN0YXRpYycpLAogICAgICBkZWZpbmVJbnN0YW5jZSAgICAgICAgICAgICAgPSB3cmFwTmFtZXNwYWNlKCdkZWZpbmVJbnN0YW5jZScpLAogICAgICBkZWZpbmVTdGF0aWNQb2x5ZmlsbCAgICAgICAgPSB3cmFwTmFtZXNwYWNlKCdkZWZpbmVTdGF0aWNQb2x5ZmlsbCcpLAogICAgICBkZWZpbmVJbnN0YW5jZVBvbHlmaWxsICAgICAgPSB3cmFwTmFtZXNwYWNlKCdkZWZpbmVJbnN0YW5jZVBvbHlmaWxsJyksCiAgICAgIGRlZmluZUluc3RhbmNlQW5kU3RhdGljICAgICA9IHdyYXBOYW1lc3BhY2UoJ2RlZmluZUluc3RhbmNlQW5kU3RhdGljJyksCiAgICAgIGRlZmluZUluc3RhbmNlV2l0aEFyZ3VtZW50cyA9IHdyYXBOYW1lc3BhY2UoJ2RlZmluZUluc3RhbmNlV2l0aEFyZ3VtZW50cycpOwoKICBmdW5jdGlvbiBkZWZpbmVJbnN0YW5jZVNpbWlsYXIoc3VnYXJOYW1lc3BhY2UsIHNldCwgZm4sIGZsYWdzKSB7CiAgICBkZWZpbmVJbnN0YW5jZShzdWdhck5hbWVzcGFjZSwgY29sbGVjdFNpbWlsYXJNZXRob2RzKHNldCwgZm4pLCBmbGFncyk7CiAgfQoKICBmdW5jdGlvbiBkZWZpbmVJbnN0YW5jZUFuZFN0YXRpY1NpbWlsYXIoc3VnYXJOYW1lc3BhY2UsIHNldCwgZm4sIGZsYWdzKSB7CiAgICBkZWZpbmVJbnN0YW5jZUFuZFN0YXRpYyhzdWdhck5hbWVzcGFjZSwgY29sbGVjdFNpbWlsYXJNZXRob2RzKHNldCwgZm4pLCBmbGFncyk7CiAgfQoKICBmdW5jdGlvbiBjb2xsZWN0U2ltaWxhck1ldGhvZHMoc2V0LCBmbikgewogICAgdmFyIG1ldGhvZHMgPSB7fTsKICAgIGlmIChpc1N0cmluZyhzZXQpKSB7CiAgICAgIHNldCA9IHNwYWNlU3BsaXQoc2V0KTsKICAgIH0KICAgIGZvckVhY2goc2V0LCBmdW5jdGlvbihlbCwgaSkgewogICAgICBmbihtZXRob2RzLCBlbCwgaSk7CiAgICB9KTsKICAgIHJldHVybiBtZXRob2RzOwogIH0KCiAgLy8gVGhpcyBzb25nIGFuZCBkYW5jZSBpcyB0byBmaXggbWV0aG9kcyB0byBhIGRpZmZlcmVudCBsZW5ndGgKICAvLyBmcm9tIHdoYXQgdGhleSBhY3R1YWxseSBhY2NlcHQgaW4gb3JkZXIgdG8gc3RheSBpbiBsaW5lIHdpdGgKICAvLyBzcGVjLiBBZGRpdGlvbmFsbHkgcGFzc2luZyBhcmd1bWVudCBsZW5ndGgsIGFzIHNvbWUgbWV0aG9kcwogIC8vIHRocm93IGFzc2VydGlvbiBlcnJvcnMgYmFzZWQgb24gdGhpcyAodW5kZWZpbmVkIGNoZWNrIGlzIG5vdAogIC8vIGVub3VnaCkuIEZvcnR1bmF0ZWx5IGZvciBub3cgc3BlYyBpcyBzdWNoIHRoYXQgcGFzc2luZyAzCiAgLy8gYWN0dWFsIGFyZ3VtZW50cyBjb3ZlcnMgYWxsIHJlcXVpcmVtZW50cy4gTm90ZSB0aGF0IHBhc3NpbmcKICAvLyB0aGUgYXJndW1lbnQgbGVuZ3RoIGFsc28gZm9yY2VzIHRoZSBjb21waWxlciB0byBub3QgcmV3cml0ZQogIC8vIGxlbmd0aCBvZiB0aGUgY29tcGlsZWQgZnVuY3Rpb24uCiAgZnVuY3Rpb24gZml4QXJndW1lbnRMZW5ndGgoZm4pIHsKICAgIHZhciBzdGF0aWNGbiA9IGZ1bmN0aW9uKGEpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHJldHVybiBmbihhLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzLmxlbmd0aCAtIDEpOwogICAgfTsKICAgIHN0YXRpY0ZuLmluc3RhbmNlID0gZnVuY3Rpb24oYikgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgcmV0dXJuIGZuKHRoaXMsIGIsIGFyZ3NbMV0sIGFyZ3MubGVuZ3RoKTsKICAgIH07CiAgICByZXR1cm4gc3RhdGljRm47CiAgfQoKICBmdW5jdGlvbiBkZWZpbmVBY2Nlc3NvcihuYW1lc3BhY2UsIG5hbWUsIGZuKSB7CiAgICBzZXRQcm9wZXJ0eShuYW1lc3BhY2UsIG5hbWUsIGZuKTsKICB9CgogIGZ1bmN0aW9uIGRlZmluZU9wdGlvbnNBY2Nlc3NvcihuYW1lc3BhY2UsIGRlZmF1bHRzKSB7CiAgICB2YXIgb2JqID0gc2ltcGxlQ2xvbmUoZGVmYXVsdHMpOwoKICAgIGZ1bmN0aW9uIGdldE9wdGlvbihuYW1lKSB7CiAgICAgIHJldHVybiBvYmpbbmFtZV07CiAgICB9CgogICAgZnVuY3Rpb24gc2V0T3B0aW9uKGFyZzEsIGFyZzIpIHsKICAgICAgdmFyIG9wdGlvbnM7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgb3B0aW9ucyA9IGFyZzE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIG9wdGlvbnNbYXJnMV0gPSBhcmcyOwogICAgICB9CiAgICAgIGZvckVhY2hQcm9wZXJ0eShvcHRpb25zLCBmdW5jdGlvbih2YWwsIG5hbWUpIHsKICAgICAgICBpZiAodmFsID09PSBudWxsKSB7CiAgICAgICAgICB2YWwgPSBkZWZhdWx0c1tuYW1lXTsKICAgICAgICB9CiAgICAgICAgb2JqW25hbWVdID0gdmFsOwogICAgICB9KTsKICAgIH0KCiAgICBkZWZpbmVBY2Nlc3NvcihuYW1lc3BhY2UsICdnZXRPcHRpb24nLCBnZXRPcHRpb24pOwogICAgZGVmaW5lQWNjZXNzb3IobmFtZXNwYWNlLCAnc2V0T3B0aW9uJywgc2V0T3B0aW9uKTsKICAgIHJldHVybiBnZXRPcHRpb247CiAgfQoKICAvLyBGb3IgbWV0aG9kcyBkZWZpbmVkIGRpcmVjdGx5IG9uIHRoZSBwcm90b3R5cGUgbGlrZSBSYW5nZQogIGZ1bmN0aW9uIGRlZmluZU9uUHJvdG90eXBlKGN0b3IsIG1ldGhvZHMpIHsKICAgIHZhciBwcm90byA9IGN0b3IucHJvdG90eXBlOwogICAgZm9yRWFjaFByb3BlcnR5KG1ldGhvZHMsIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgIHByb3RvW2tleV0gPSB2YWw7CiAgICB9KTsKICB9CgogIC8vIEFyZ3VtZW50IGhlbHBlcnMKCiAgZnVuY3Rpb24gYXNzZXJ0QXJndW1lbnQoZXhpc3RzKSB7CiAgICBpZiAoIWV4aXN0cykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCByZXF1aXJlZCcpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYXNzZXJ0Q2FsbGFibGUob2JqKSB7CiAgICBpZiAoIWlzRnVuY3Rpb24ob2JqKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdGdW5jdGlvbiBpcyBub3QgY2FsbGFibGUnKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFzc2VydEFycmF5KG9iaikgewogICAgaWYgKCFpc0FycmF5KG9iaikpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJyYXkgcmVxdWlyZWQnKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFzc2VydFdyaXRhYmxlKG9iaikgewogICAgaWYgKGlzUHJpbWl0aXZlKG9iaikpIHsKICAgICAgLy8gSWYgc3RyaWN0IG1vZGUgaXMgYWN0aXZlIHRoZW4gcHJpbWl0aXZlcyB3aWxsIHRocm93IGFuCiAgICAgIC8vIGVycm9yIHdoZW4gYXR0ZW1wdGluZyB0byB3cml0ZSBwcm9wZXJ0aWVzLiBXZSBjYW4ndCBiZQogICAgICAvLyBzdXJlIGlmIHN0cmljdCBtb2RlIGlzIGF2YWlsYWJsZSwgc28gcHJlLWVtcHRpdmVseQogICAgICAvLyB0aHJvdyBhbiBlcnJvciBoZXJlIHRvIGVuc3VyZSBjb25zaXN0ZW50IGJlaGF2aW9yLgogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdQcm9wZXJ0eSBjYW5ub3QgYmUgd3JpdHRlbicpOwogICAgfQogIH0KCiAgLy8gQ29lcmNlcyBhbiBvYmplY3QgdG8gYSBwb3NpdGl2ZSBpbnRlZ2VyLgogIC8vIERvZXMgbm90IGFsbG93IEluZmluaXR5LgogIGZ1bmN0aW9uIGNvZXJjZVBvc2l0aXZlSW50ZWdlcihuKSB7CiAgICBuID0gK24gfHwgMDsKICAgIGlmIChuIDwgMCB8fCAhaXNOdW1iZXIobikgfHwgIWlzRmluaXRlKG4pKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIG51bWJlcicpOwogICAgfQogICAgcmV0dXJuIHRydW5jKG4pOwogIH0KCgogIC8vIEdlbmVyYWwgaGVscGVycwoKICBmdW5jdGlvbiBpc0RlZmluZWQobykgewogICAgcmV0dXJuIG8gIT09IHVuZGVmaW5lZDsKICB9CgogIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKG8pIHsKICAgIHJldHVybiBvID09PSB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiBwcml2YXRlUHJvcGVydHlBY2Nlc3NvcihrZXkpIHsKICAgIHZhciBwcml2YXRlS2V5ID0gUFJJVkFURV9QUk9QX1BSRUZJWCArIGtleTsKICAgIHJldHVybiBmdW5jdGlvbihvYmosIHZhbCkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICBzZXRQcm9wZXJ0eShvYmosIHByaXZhdGVLZXksIHZhbCk7CiAgICAgICAgcmV0dXJuIG9iajsKICAgICAgfQogICAgICByZXR1cm4gb2JqW3ByaXZhdGVLZXldOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHNldENoYWluYWJsZUNvbnN0cnVjdG9yKHN1Z2FyTmFtZXNwYWNlLCBjcmVhdGVGbikgewogICAgc3VnYXJOYW1lc3BhY2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBjcmVhdGVGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9CgogIC8vIEZ1enp5IG1hdGNoaW5nIGhlbHBlcnMKCiAgZnVuY3Rpb24gZ2V0TWF0Y2hlcihmKSB7CiAgICBpZiAoIWlzUHJpbWl0aXZlKGYpKSB7CiAgICAgIHZhciBjbGFzc05hbWUgPSBjbGFzc1RvU3RyaW5nKGYpOwogICAgICBpZiAoaXNSZWdFeHAoZiwgY2xhc3NOYW1lKSkgewogICAgICAgIHJldHVybiByZWdleE1hdGNoZXIoZik7CiAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKGYsIGNsYXNzTmFtZSkpIHsKICAgICAgICByZXR1cm4gZGF0ZU1hdGNoZXIoZik7CiAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihmLCBjbGFzc05hbWUpKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTWF0Y2hlcihmKTsKICAgICAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KGYsIGNsYXNzTmFtZSkpIHsKICAgICAgICByZXR1cm4gZnV6enlNYXRjaGVyKGYpOwogICAgICB9CiAgICB9CiAgICAvLyBEZWZhdWx0IGlzIHN0YW5kYXJkIGlzRXF1YWwKICAgIHJldHVybiBkZWZhdWx0TWF0Y2hlcihmKTsKICB9CgogIGZ1bmN0aW9uIGZ1enp5TWF0Y2hlcihvYmopIHsKICAgIHZhciBtYXRjaGVycyA9IHt9OwogICAgcmV0dXJuIGZ1bmN0aW9uKGVsLCBpLCBhcnIpIHsKICAgICAgdmFyIG1hdGNoZWQgPSB0cnVlOwogICAgICBpZiAoIWlzT2JqZWN0VHlwZShlbCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgZm9yRWFjaFByb3BlcnR5KG9iaiwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAgICBtYXRjaGVyc1trZXldID0gZ2V0T3duKG1hdGNoZXJzLCBrZXkpIHx8IGdldE1hdGNoZXIodmFsKTsKICAgICAgICBpZiAobWF0Y2hlcnNba2V5XS5jYWxsKGFyciwgZWxba2V5XSwgaSwgYXJyKSA9PT0gZmFsc2UpIHsKICAgICAgICAgIG1hdGNoZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICAgIH0pOwogICAgICByZXR1cm4gbWF0Y2hlZDsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBkZWZhdWx0TWF0Y2hlcihmKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZWwpIHsKICAgICAgcmV0dXJuIGlzRXF1YWwoZWwsIGYpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHJlZ2V4TWF0Y2hlcihyZWcpIHsKICAgIHJlZyA9IFJlZ0V4cChyZWcpOwogICAgcmV0dXJuIGZ1bmN0aW9uKGVsKSB7CiAgICAgIHJldHVybiByZWcudGVzdChlbCk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZGF0ZU1hdGNoZXIoZCkgewogICAgdmFyIG1zID0gZC5nZXRUaW1lKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oZWwpIHsKICAgICAgcmV0dXJuICEhKGVsICYmIGVsLmdldFRpbWUpICYmIGVsLmdldFRpbWUoKSA9PT0gbXM7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZnVuY3Rpb25NYXRjaGVyKGZuKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZWwsIGksIGFycikgewogICAgICAvLyBSZXR1cm4gdHJ1ZSB1cCBmcm9udCBpZiBtYXRjaCBieSByZWZlcmVuY2UKICAgICAgcmV0dXJuIGVsID09PSBmbiB8fCBmbi5jYWxsKGFyciwgZWwsIGksIGFycik7CiAgICB9OwogIH0KCiAgLy8gT2JqZWN0IGhlbHBlcnMKCiAgZnVuY3Rpb24gZ2V0S2V5cyhvYmopIHsKICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopOwogIH0KCiAgZnVuY3Rpb24gZGVlcEhhc1Byb3BlcnR5KG9iaiwga2V5LCBhbnkpIHsKICAgIHJldHVybiBoYW5kbGVEZWVwUHJvcGVydHkob2JqLCBrZXksIGFueSwgdHJ1ZSk7CiAgfQoKICBmdW5jdGlvbiBkZWVwR2V0UHJvcGVydHkob2JqLCBrZXksIGFueSkgewogICAgcmV0dXJuIGhhbmRsZURlZXBQcm9wZXJ0eShvYmosIGtleSwgYW55LCBmYWxzZSk7CiAgfQoKICBmdW5jdGlvbiBkZWVwU2V0UHJvcGVydHkob2JqLCBrZXksIHZhbCkgewogICAgaGFuZGxlRGVlcFByb3BlcnR5KG9iaiwga2V5LCBmYWxzZSwgZmFsc2UsIHRydWUsIGZhbHNlLCB2YWwpOwogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIGhhbmRsZURlZXBQcm9wZXJ0eShvYmosIGtleSwgYW55LCBoYXMsIGZpbGwsIGZpbGxMYXN0LCB2YWwpIHsKICAgIHZhciBucywgYnMsIHBzLCBjYmksIHNldCwgaXNMYXN0LCBpc1B1c2gsIGlzSW5kZXgsIG5leHRJc0luZGV4LCBleGlzdHM7CiAgICBucyA9IG9iaiB8fCB1bmRlZmluZWQ7CiAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybjsKCiAgICBpZiAoaXNPYmplY3RUeXBlKGtleSkpIHsKICAgICAgLy8gQWxsb3cgYXJyYXkgYW5kIGFycmF5LWxpa2UgYWNjZXNzb3JzCiAgICAgIGJzID0gW2tleV07CiAgICB9IGVsc2UgewogICAgICBrZXkgPSBTdHJpbmcoa2V5KTsKICAgICAgaWYgKGtleS5pbmRleE9mKCcuLicpICE9PSAtMSkgewogICAgICAgIHJldHVybiBoYW5kbGVBcnJheUluZGV4UmFuZ2Uob2JqLCBrZXksIGFueSwgdmFsKTsKICAgICAgfQogICAgICBicyA9IGtleS5zcGxpdCgnWycpOwogICAgfQoKICAgIHNldCA9IGlzRGVmaW5lZCh2YWwpOwoKICAgIGZvciAodmFyIGkgPSAwLCBibGVuID0gYnMubGVuZ3RoOyBpIDwgYmxlbjsgaSsrKSB7CiAgICAgIHBzID0gYnNbaV07CgogICAgICBpZiAoaXNTdHJpbmcocHMpKSB7CiAgICAgICAgcHMgPSBwZXJpb2RTcGxpdChwcyk7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGogPSAwLCBwbGVuID0gcHMubGVuZ3RoOyBqIDwgcGxlbjsgaisrKSB7CiAgICAgICAga2V5ID0gcHNbal07CgogICAgICAgIC8vIElzIHRoaXMgdGhlIGxhc3Qga2V5PwogICAgICAgIGlzTGFzdCA9IGkgPT09IGJsZW4gLSAxICYmIGogPT09IHBsZW4gLSAxOwoKICAgICAgICAvLyBJbmRleCBvZiB0aGUgY2xvc2luZyBdCiAgICAgICAgY2JpID0ga2V5LmluZGV4T2YoJ10nKTsKCiAgICAgICAgLy8gSXMgdGhlIGtleSBhbiBhcnJheSBpbmRleD8KICAgICAgICBpc0luZGV4ID0gY2JpICE9PSAtMTsKCiAgICAgICAgLy8gSXMgdGhpcyBhcnJheSBwdXNoIHN5bnRheCAiW10iPwogICAgICAgIGlzUHVzaCA9IHNldCAmJiBjYmkgPT09IDA7CgogICAgICAgIC8vIElmIHRoZSBicmFja2V0IHNwbGl0IHdhcyBzdWNjZXNzZnVsIGFuZCB0aGlzIGlzIHRoZSBsYXN0IGVsZW1lbnQKICAgICAgICAvLyBpbiB0aGUgZG90IHNwbGl0LCB0aGVuIHdlIGtub3cgdGhlIG5leHQga2V5IHdpbGwgYmUgYW4gYXJyYXkgaW5kZXguCiAgICAgICAgbmV4dElzSW5kZXggPSBibGVuID4gMSAmJiBqID09PSBwbGVuIC0gMTsKCiAgICAgICAgaWYgKGlzUHVzaCkgewogICAgICAgICAgLy8gU2V0IHRoZSBpbmRleCB0byB0aGUgZW5kIG9mIHRoZSBhcnJheQogICAgICAgICAga2V5ID0gbnMubGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAoaXNJbmRleCkgewogICAgICAgICAgLy8gUmVtb3ZlIHRoZSBjbG9zaW5nIF0KICAgICAgICAgIGtleSA9IGtleS5zbGljZSgwLCAtMSk7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB0aGUgYXJyYXkgaW5kZXggaXMgbGVzcyB0aGFuIDAsIHRoZW4KICAgICAgICAvLyBhZGQgaXRzIGxlbmd0aCB0byBhbGxvdyBuZWdhdGl2ZSBpbmRleGVzLgogICAgICAgIGlmIChpc0luZGV4ICYmIGtleSA8IDApIHsKICAgICAgICAgIGtleSA9ICtrZXkgKyBucy5sZW5ndGg7CiAgICAgICAgfQoKICAgICAgICAvLyBCcmFja2V0IGtleXMgbWF5IGxvb2sgbGlrZSB1c2Vyc1s1XSBvciBqdXN0IFs1XSwgc28gdGhlIGxlYWRpbmcKICAgICAgICAvLyBjaGFyYWN0ZXJzIGFyZSBvcHRpb25hbC4gV2UgY2FuIGVudGVyIHRoZSBuYW1lc3BhY2UgaWYgdGhpcyBpcyB0aGUKICAgICAgICAvLyAybmQgcGFydCwgaWYgdGhlcmUgaXMgb25seSAxIHBhcnQsIG9yIGlmIHRoZXJlIGlzIGFuIGV4cGxpY2l0IGtleS4KICAgICAgICBpZiAoaSB8fCBrZXkgfHwgYmxlbiA9PT0gMSkgewoKICAgICAgICAgIGV4aXN0cyA9IGFueSA/IGtleSBpbiBucyA6IGhhc093bihucywga2V5KTsKCiAgICAgICAgICAvLyBOb24tZXhpc3RlbnQgbmFtZXNwYWNlcyBhcmUgb25seSBmaWxsZWQgaWYgdGhleSBhcmUgaW50ZXJtZWRpYXRlCiAgICAgICAgICAvLyAobm90IGF0IHRoZSBlbmQpIG9yIGV4cGxpY2l0bHkgZmlsbGluZyB0aGUgbGFzdC4KICAgICAgICAgIGlmIChmaWxsICYmICghaXNMYXN0IHx8IGZpbGxMYXN0KSAmJiAhZXhpc3RzKSB7CiAgICAgICAgICAgIC8vIEZvciBvdXIgcHVycG9zZXMsIGxhc3Qgb25seSBuZWVkcyB0byBiZSBhbiBhcnJheS4KICAgICAgICAgICAgbnMgPSBuc1trZXldID0gbmV4dElzSW5kZXggfHwgKGZpbGxMYXN0ICYmIGlzTGFzdCkgPyBbXSA6IHt9OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaGFzKSB7CiAgICAgICAgICAgIGlmIChpc0xhc3QgfHwgIWV4aXN0cykgewogICAgICAgICAgICAgIHJldHVybiBleGlzdHM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc2V0ICYmIGlzTGFzdCkgewogICAgICAgICAgICBhc3NlcnRXcml0YWJsZShucyk7CiAgICAgICAgICAgIG5zW2tleV0gPSB2YWw7CiAgICAgICAgICB9CgogICAgICAgICAgbnMgPSBleGlzdHMgPyBuc1trZXldIDogdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuczsKICB9CgogIC8vIEdldCBvYmplY3QgcHJvcGVydHkgd2l0aCBzdXBwb3J0IGZvciAwLi4xIHN0eWxlIHJhbmdlIG5vdGF0aW9uLgogIGZ1bmN0aW9uIGhhbmRsZUFycmF5SW5kZXhSYW5nZShvYmosIGtleSwgYW55LCB2YWwpIHsKICAgIHZhciBtYXRjaCwgc3RhcnQsIGVuZCwgbGVhZGluZywgdHJhaWxpbmcsIGFyciwgc2V0OwogICAgbWF0Y2ggPSBrZXkubWF0Y2goUFJPUEVSVFlfUkFOR0VfUkVHKTsKICAgIGlmICghbWF0Y2gpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHNldCA9IGlzRGVmaW5lZCh2YWwpOwogICAgbGVhZGluZyA9IG1hdGNoWzFdOwoKICAgIGlmIChsZWFkaW5nKSB7CiAgICAgIGFyciA9IGhhbmRsZURlZXBQcm9wZXJ0eShvYmosIGxlYWRpbmcsIGFueSwgZmFsc2UsIHNldCA/IHRydWUgOiBmYWxzZSwgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBhcnIgPSBvYmo7CiAgICB9CgogICAgYXNzZXJ0QXJyYXkoYXJyKTsKCiAgICB0cmFpbGluZyA9IG1hdGNoWzRdOwogICAgc3RhcnQgICAgPSBtYXRjaFsyXSA/ICttYXRjaFsyXSA6IDA7CiAgICBlbmQgICAgICA9IG1hdGNoWzNdID8gK21hdGNoWzNdIDogYXJyLmxlbmd0aDsKCiAgICAvLyBBIHJhbmdlIG9mIDAuLjEgaXMgaW5jbHVzaXZlLCBzbyB3ZSBuZWVkIHRvIGFkZCAxIHRvIHRoZSBlbmQuIElmIHRoaXMKICAgIC8vIHB1c2hlcyB0aGUgaW5kZXggZnJvbSAtMSB0byAwLCB0aGVuIHNldCBpdCB0byB0aGUgZnVsbCBsZW5ndGggb2YgdGhlCiAgICAvLyBhcnJheSwgb3RoZXJ3aXNlIGl0IHdpbGwgcmV0dXJuIG5vdGhpbmcuCiAgICBlbmQgPSBlbmQgPT09IC0xID8gYXJyLmxlbmd0aCA6IGVuZCArIDE7CgogICAgaWYgKHNldCkgewogICAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgICAgIGhhbmRsZURlZXBQcm9wZXJ0eShhcnIsIGkgKyB0cmFpbGluZywgYW55LCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIHZhbCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGFyciA9IGFyci5zbGljZShzdGFydCwgZW5kKTsKCiAgICAgIC8vIElmIHRoZXJlIGFyZSB0cmFpbGluZyBwcm9wZXJ0aWVzLCB0aGVuIHRoZXkgbmVlZCB0byBiZSBtYXBwZWQgZm9yIGVhY2gKICAgICAgLy8gZWxlbWVudCBpbiB0aGUgYXJyYXkuCiAgICAgIGlmICh0cmFpbGluZykgewogICAgICAgIGlmICh0cmFpbGluZy5jaGFyQXQoMCkgPT09IEhBTEZfV0lEVEhfUEVSSU9EKSB7CiAgICAgICAgICAvLyBOZWVkIHRvIGNob21wIHRoZSBwZXJpb2QgaWYgb25lIGlzIHRyYWlsaW5nIGFmdGVyIHRoZSByYW5nZS4gV2UKICAgICAgICAgIC8vIGNhbid0IGRvIHRoaXMgYXQgdGhlIHJlZ2V4IGxldmVsIGJlY2F1c2UgaXQgd2lsbCBiZSByZXF1aXJlZCBpZgogICAgICAgICAgLy8gd2UncmUgc2V0dGluZyB0aGUgdmFsdWUgYXMgaXQgbmVlZHMgdG8gYmUgY29uY2F0ZW50YXRlZCB0b2dldGhlcgogICAgICAgICAgLy8gd2l0aCB0aGUgYXJyYXkgaW5kZXggdG8gYmUgc2V0LgogICAgICAgICAgdHJhaWxpbmcgPSB0cmFpbGluZy5zbGljZSgxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyci5tYXAoZnVuY3Rpb24oZWwpIHsKICAgICAgICAgIHJldHVybiBoYW5kbGVEZWVwUHJvcGVydHkoZWwsIHRyYWlsaW5nKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFycjsKICB9CgogIGZ1bmN0aW9uIGdldE93bktleShvYmosIGtleSkgewogICAgaWYgKGhhc093bihvYmosIGtleSkpIHsKICAgICAgcmV0dXJuIGtleTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhhc1Byb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuICFpc1ByaW1pdGl2ZShvYmopICYmIHByb3AgaW4gb2JqOwogIH0KCiAgZnVuY3Rpb24gaXNPYmplY3RUeXBlKG9iaiwgdHlwZSkgewogICAgcmV0dXJuICEhb2JqICYmICh0eXBlIHx8IHR5cGVvZiBvYmopID09PSAnb2JqZWN0JzsKICB9CgogIGZ1bmN0aW9uIGlzUHJpbWl0aXZlKG9iaiwgdHlwZSkgewogICAgdHlwZSA9IHR5cGUgfHwgdHlwZW9mIG9iajsKICAgIHJldHVybiBvYmogPT0gbnVsbCB8fCB0eXBlID09PSAnc3RyaW5nJyB8fCB0eXBlID09PSAnbnVtYmVyJyB8fCB0eXBlID09PSAnYm9vbGVhbic7CiAgfQoKICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KG9iaiwgY2xhc3NOYW1lKSB7CiAgICByZXR1cm4gaXNPYmplY3RUeXBlKG9iaikgJiYKICAgICAgICAgICBpc0NsYXNzKG9iaiwgJ09iamVjdCcsIGNsYXNzTmFtZSkgJiYKICAgICAgICAgICBoYXNWYWxpZFBsYWluT2JqZWN0UHJvdG90eXBlKG9iaikgJiYKICAgICAgICAgICBoYXNPd25FbnVtZXJhdGVkUHJvcGVydGllcyhvYmopOwogIH0KCiAgZnVuY3Rpb24gaGFzVmFsaWRQbGFpbk9iamVjdFByb3RvdHlwZShvYmopIHsKICAgIHZhciBoYXNUb1N0cmluZyA9ICd0b1N0cmluZycgaW4gb2JqOwogICAgdmFyIGhhc0NvbnN0cnVjdG9yID0gJ2NvbnN0cnVjdG9yJyBpbiBvYmo7CiAgICAvLyBBbiBvYmplY3QgY3JlYXRlZCB3aXRoIE9iamVjdC5jcmVhdGUobnVsbCkgaGFzIG5vIG1ldGhvZHMgaW4gdGhlCiAgICAvLyBwcm90b3R5cGUgY2hhaW4sIHNvIGNoZWNrIGlmIGFueSBhcmUgbWlzc2luZy4gVGhlIGFkZGl0aW9uYWwgaGFzVG9TdHJpbmcKICAgIC8vIGNoZWNrIGlzIGZvciBmYWxzZSBwb3NpdGl2ZXMgb24gc29tZSBob3N0IG9iamVjdHMgaW4gb2xkIElFIHdoaWNoIGhhdmUKICAgIC8vIHRvU3RyaW5nIGJ1dCBubyBjb25zdHJ1Y3Rvci4gSWYgdGhlIG9iamVjdCBoYXMgYW4gaW5oZXJpdGVkIGNvbnN0cnVjdG9yLAogICAgLy8gdGhlbiBjaGVjayBpZiBpdCBpcyBPYmplY3QgKHRoZSAiaXNQcm90b3R5cGVPZiIgdGFwZGFuY2UgaGVyZSBpcyBhIG1vcmUKICAgIC8vIHJvYnVzdCB3YXkgb2YgZW5zdXJpbmcgdGhpcyBpZiB0aGUgZ2xvYmFsIGhhcyBiZWVuIGhpamFja2VkKS4gTm90ZSB0aGF0CiAgICAvLyBhY2Nlc3NpbmcgdGhlIGNvbnN0cnVjdG9yIGRpcmVjdGx5ICh3aXRob3V0ICJpbiIgb3IgImhhc093blByb3BlcnR5IikKICAgIC8vIHdpbGwgdGhyb3cgYSBwZXJtaXNzaW9ucyBlcnJvciBpbiBJRTggb24gY3Jvc3MtZG9tYWluIHdpbmRvd3MuCiAgICByZXR1cm4gKCFoYXNDb25zdHJ1Y3RvciAmJiAhaGFzVG9TdHJpbmcpIHx8CiAgICAgICAgICAgIChoYXNDb25zdHJ1Y3RvciAmJiAhaGFzT3duKG9iaiwgJ2NvbnN0cnVjdG9yJykgJiYKICAgICAgICAgICAgIGhhc093bihvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAnaXNQcm90b3R5cGVPZicpKTsKICB9CgogIGZ1bmN0aW9uIGhhc093bkVudW1lcmF0ZWRQcm9wZXJ0aWVzKG9iaikgewogICAgLy8gUGxhaW4gb2JqZWN0cyBhcmUgZ2VuZXJhbGx5IGRlZmluZWQgYXMgaGF2aW5nIGVudW1lcmF0ZWQgcHJvcGVydGllcwogICAgLy8gYWxsIHRoZWlyIG93biwgaG93ZXZlciBpbiBlYXJseSBJRSBlbnZpcm9ubWVudHMgd2l0aG91dCBkZWZpbmVQcm9wZXJ0eSwKICAgIC8vIHRoZXJlIG1heSBhbHNvIGJlIGVudW1lcmF0ZWQgbWV0aG9kcyBpbiB0aGUgcHJvdG90eXBlIGNoYWluLCBzbyBjaGVjawogICAgLy8gZm9yIGJvdGggb2YgdGhlc2UgY2FzZXMuCiAgICB2YXIgb2JqZWN0UHJvdG8gPSBPYmplY3QucHJvdG90eXBlOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICB2YXIgdmFsID0gb2JqW2tleV07CiAgICAgIGlmICghaGFzT3duKG9iaiwga2V5KSAmJiB2YWwgIT09IG9iamVjdFByb3RvW2tleV0pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gc2ltcGxlUmVwZWF0KG4sIGZuKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBmbihpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHNpbXBsZUNsb25lKG9iaikgewogICAgcmV0dXJuIHNpbXBsZU1lcmdlKHt9LCBvYmopOwogIH0KCiAgZnVuY3Rpb24gc2ltcGxlTWVyZ2UodGFyZ2V0LCBzb3VyY2UpIHsKICAgIGZvckVhY2hQcm9wZXJ0eShzb3VyY2UsIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgfSk7CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KCiAgLy8gTWFrZSBwcmltdGl2ZXMgdHlwZXMgbGlrZSBzdHJpbmdzIGludG8gb2JqZWN0cy4KICBmdW5jdGlvbiBjb2VyY2VQcmltaXRpdmVUb09iamVjdChvYmopIHsKICAgIGlmIChpc1ByaW1pdGl2ZShvYmopKSB7CiAgICAgIG9iaiA9IE9iamVjdChvYmopOwogICAgfQogICAgaWYgKE5PX0tFWVNfSU5fU1RSSU5HX09CSkVDVFMgJiYgaXNTdHJpbmcob2JqKSkgewogICAgICBmb3JjZVN0cmluZ0NvZXJjaW9uKG9iaik7CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH0KCiAgLy8gRm9yY2Ugc3RyaW5ncyB0byBoYXZlIHRoZWlyIGluZGV4ZXMgc2V0IGluCiAgLy8gZW52aXJvbm1lbnRzIHRoYXQgZG9uJ3QgZG8gdGhpcyBhdXRvbWF0aWNhbGx5LgogIGZ1bmN0aW9uIGZvcmNlU3RyaW5nQ29lcmNpb24ob2JqKSB7CiAgICB2YXIgaSA9IDAsIGNocjsKICAgIHdoaWxlIChjaHIgPSBvYmouY2hhckF0KGkpKSB7CiAgICAgIG9ialtpKytdID0gY2hyOwogICAgfQogIH0KCiAgLy8gRXF1YWxpdHkgaGVscGVycwoKICBmdW5jdGlvbiBpc0VxdWFsKGEsIGIsIHN0YWNrKSB7CiAgICB2YXIgYUNsYXNzLCBiQ2xhc3M7CiAgICBpZiAoYSA9PT0gYikgewogICAgICAvLyBSZXR1cm4gcXVpY2tseSB1cCBmcm9udCB3aGVuIG1hdGNoZWQgYnkgcmVmZXJlbmNlLAogICAgICAvLyBidXQgYmUgY2FyZWZ1bCBhYm91dCAwICE9PSAtMC4KICAgICAgcmV0dXJuIGEgIT09IDAgfHwgMSAvIGEgPT09IDEgLyBiOwogICAgfQogICAgYUNsYXNzID0gY2xhc3NUb1N0cmluZyhhKTsKICAgIGJDbGFzcyA9IGNsYXNzVG9TdHJpbmcoYik7CiAgICBpZiAoYUNsYXNzICE9PSBiQ2xhc3MpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmIChpc1NlcmlhbGl6YWJsZShhLCBhQ2xhc3MpICYmIGlzU2VyaWFsaXphYmxlKGIsIGJDbGFzcykpIHsKICAgICAgcmV0dXJuIG9iamVjdElzRXF1YWwoYSwgYiwgYUNsYXNzLCBzdGFjayk7CiAgICB9IGVsc2UgaWYgKGlzU2V0KGEsIGFDbGFzcykgJiYgaXNTZXQoYiwgYkNsYXNzKSkgewogICAgICByZXR1cm4gYS5zaXplID09PSBiLnNpemUgJiYgaXNFcXVhbChzZXRUb0FycmF5KGEpLCBzZXRUb0FycmF5KGIpLCBzdGFjayk7CiAgICB9IGVsc2UgaWYgKGlzTWFwKGEsIGFDbGFzcykgJiYgaXNNYXAoYiwgYkNsYXNzKSkgewogICAgICByZXR1cm4gYS5zaXplID09PSBiLnNpemUgJiYgaXNFcXVhbChtYXBUb0FycmF5KGEpLCBtYXBUb0FycmF5KGIpLCBzdGFjayk7CiAgICB9IGVsc2UgaWYgKGlzRXJyb3IoYSwgYUNsYXNzKSAmJiBpc0Vycm9yKGIsIGJDbGFzcykpIHsKICAgICAgcmV0dXJuIGEudG9TdHJpbmcoKSA9PT0gYi50b1N0cmluZygpOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIG9iamVjdElzRXF1YWwoYSwgYiwgYUNsYXNzLCBzdGFjaykgewogICAgdmFyIGFUeXBlID0gdHlwZW9mIGEsIGJUeXBlID0gdHlwZW9mIGIsIHByb3BzRXF1YWwsIGNvdW50OwogICAgaWYgKGFUeXBlICE9PSBiVHlwZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoaXNPYmplY3RUeXBlKGEudmFsdWVPZigpKSkgewogICAgICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSB7CiAgICAgICAgLy8gcGVyZjogUXVpY2tseSByZXR1cm5pbmcgdXAgZnJvbnQgZm9yIGFycmF5cy4KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgY291bnQgPSAwOwogICAgICBwcm9wc0VxdWFsID0gdHJ1ZTsKICAgICAgaXRlcmF0ZVdpdGhDeWNsaWNDaGVjayhhLCBmYWxzZSwgc3RhY2ssIGZ1bmN0aW9uKGtleSwgdmFsLCBjeWMsIHN0YWNrKSB7CiAgICAgICAgaWYgKCFjeWMgJiYgKCEoa2V5IGluIGIpIHx8ICFpc0VxdWFsKHZhbCwgYltrZXldLCBzdGFjaykpKSB7CiAgICAgICAgICBwcm9wc0VxdWFsID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGNvdW50Kys7CiAgICAgICAgcmV0dXJuIHByb3BzRXF1YWw7CiAgICAgIH0pOwogICAgICBpZiAoIXByb3BzRXF1YWwgfHwgY291bnQgIT09IGdldEtleXMoYikubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICAvLyBTdHJpbmdpZnlpbmcgdGhlIHZhbHVlIGhhbmRsZXMgTmFOLCB3cmFwcGVkIHByaW1pdGl2ZXMsIGRhdGVzLCBhbmQgZXJyb3JzIGluIG9uZSBnby4KICAgIHJldHVybiBhLnZhbHVlT2YoKS50b1N0cmluZygpID09PSBiLnZhbHVlT2YoKS50b1N0cmluZygpOwogIH0KCiAgLy8gU2VyaWFsaXplcyBhbiBvYmplY3QgaW4gYSB3YXkgdGhhdCB3aWxsIHByb3ZpZGUgYSB0b2tlbiB1bmlxdWUKICAvLyB0byB0aGUgdHlwZSwgY2xhc3MsIGFuZCB2YWx1ZSBvZiBhbiBvYmplY3QuIEhvc3Qgb2JqZWN0cywgY2xhc3MKICAvLyBpbnN0YW5jZXMgZXRjLCBhcmUgbm90IHNlcmlhbGl6YWJsZSwgYW5kIGFyZSBoZWxkIGluIGFuIGFycmF5CiAgLy8gb2YgcmVmZXJlbmNlcyB0aGF0IHdpbGwgcmV0dXJuIHRoZSBpbmRleCBhcyBhIHVuaXF1ZSBpZGVudGlmaWVyCiAgLy8gZm9yIHRoZSBvYmplY3QuIFRoaXMgYXJyYXkgaXMgcGFzc2VkIGZyb20gb3V0c2lkZSBzbyB0aGF0IHRoZQogIC8vIGNhbGxpbmcgZnVuY3Rpb24gY2FuIGRlY2lkZSB3aGVuIHRvIGRpc3Bvc2Ugb2YgdGhpcyBhcnJheS4KICBmdW5jdGlvbiBzZXJpYWxpemVJbnRlcm5hbChvYmosIHJlZnMsIHN0YWNrKSB7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiBvYmosIGNsYXNzTmFtZSwgdmFsdWUsIHJlZjsKCiAgICAvLyBSZXR1cm4gcXVpY2tseSBmb3IgcHJpbWl0aXZlcyB0byBzYXZlIGN5Y2xlcwogICAgaWYgKGlzUHJpbWl0aXZlKG9iaiwgdHlwZSkgJiYgIWlzUmVhbE5hTihvYmopKSB7CiAgICAgIHJldHVybiB0eXBlICsgb2JqOwogICAgfQoKICAgIGNsYXNzTmFtZSA9IGNsYXNzVG9TdHJpbmcob2JqKTsKCiAgICBpZiAoIWlzU2VyaWFsaXphYmxlKG9iaiwgY2xhc3NOYW1lKSkgewogICAgICByZWYgPSBpbmRleE9mKHJlZnMsIG9iaik7CiAgICAgIGlmIChyZWYgPT09IC0xKSB7CiAgICAgICAgcmVmID0gcmVmcy5sZW5ndGg7CiAgICAgICAgcmVmcy5wdXNoKG9iaik7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlZjsKICAgIH0gZWxzZSBpZiAoaXNPYmplY3RUeXBlKG9iaikpIHsKICAgICAgdmFsdWUgPSBzZXJpYWxpemVEZWVwKG9iaiwgcmVmcywgc3RhY2spICsgb2JqLnRvU3RyaW5nKCk7CiAgICB9IGVsc2UgaWYgKDEgLyBvYmogPT09IC1JbmZpbml0eSkgewogICAgICB2YWx1ZSA9ICctMCc7CiAgICB9IGVsc2UgaWYgKG9iai52YWx1ZU9mKSB7CiAgICAgIHZhbHVlID0gb2JqLnZhbHVlT2YoKTsKICAgIH0KICAgIHJldHVybiB0eXBlICsgY2xhc3NOYW1lICsgdmFsdWU7CiAgfQoKICBmdW5jdGlvbiBzZXJpYWxpemVEZWVwKG9iaiwgcmVmcywgc3RhY2spIHsKICAgIHZhciByZXN1bHQgPSAnJzsKICAgIGl0ZXJhdGVXaXRoQ3ljbGljQ2hlY2sob2JqLCB0cnVlLCBzdGFjaywgZnVuY3Rpb24oa2V5LCB2YWwsIGN5Yywgc3RhY2spIHsKICAgICAgcmVzdWx0ICs9IGN5YyA/ICdDWUMnIDoga2V5ICsgc2VyaWFsaXplSW50ZXJuYWwodmFsLCByZWZzLCBzdGFjayk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBpdGVyYXRlV2l0aEN5Y2xpY0NoZWNrKG9iaiwgc29ydGVkS2V5cywgc3RhY2ssIGZuKSB7CgogICAgZnVuY3Rpb24gbmV4dCh2YWwsIGtleSkgewogICAgICB2YXIgY3ljID0gZmFsc2U7CgogICAgICAvLyBBbGxvd2luZyBhIHN0ZXAgaW50byB0aGUgc3RydWN0dXJlIGJlZm9yZSB0cmlnZ2VyaW5nIHRoaXMgY2hlY2sgdG8gc2F2ZQogICAgICAvLyBjeWNsZXMgb24gc3RhbmRhcmQgSlNPTiBzdHJ1Y3R1cmVzIGFuZCBhbHNvIHRvIHRyeSBhcyBoYXJkIGFzIHBvc3NpYmxlIHRvCiAgICAgIC8vIGNhdGNoIGJhc2ljIHByb3BlcnRpZXMgdGhhdCBtYXkgaGF2ZSBiZWVuIG1vZGlmaWVkLgogICAgICBpZiAoc3RhY2subGVuZ3RoID4gMSkgewogICAgICAgIHZhciBpID0gc3RhY2subGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGlmIChzdGFja1tpXSA9PT0gdmFsKSB7CiAgICAgICAgICAgIGN5YyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBzdGFjay5wdXNoKHZhbCk7CiAgICAgIGZuKGtleSwgdmFsLCBjeWMsIHN0YWNrKTsKICAgICAgc3RhY2sucG9wKCk7CiAgICB9CgogICAgZnVuY3Rpb24gaXRlcmF0ZVdpdGhTb3J0ZWRLZXlzKCkgewogICAgICAvLyBTb3J0ZWQga2V5cyBpcyByZXF1aXJlZCBmb3Igc2VyaWFsaXphdGlvbiwgd2hlcmUgb2JqZWN0IG9yZGVyCiAgICAgIC8vIGRvZXMgbm90IG1hdHRlciBidXQgc3RyaW5naWZpZWQgb3JkZXIgZG9lcy4KICAgICAgdmFyIGFyciA9IGdldEtleXMob2JqKS5zb3J0KCksIGtleTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBrZXkgPSBhcnJbaV07CiAgICAgICAgbmV4dChvYmpba2V5XSwgYXJyW2ldKTsKICAgICAgfQogICAgfQoKICAgIC8vIFRoaXMgbWV0aG9kIGZvciBjaGVja2luZyBmb3IgY3ljbGljIHN0cnVjdHVyZXMgd2FzIGVncmVnaW91c2x5IHN0b2xlbiBmcm9tCiAgICAvLyB0aGUgaW5nZW5pb3VzIG1ldGhvZCBieSBAa2l0Y2FtYnJpZGdlIGZyb20gdGhlIFVuZGVyc2NvcmUgc2NyaXB0OgogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2RvY3VtZW50Y2xvdWQvdW5kZXJzY29yZS9pc3N1ZXMvMjQwCiAgICBpZiAoIXN0YWNrKSB7CiAgICAgIHN0YWNrID0gW107CiAgICB9CgogICAgaWYgKHNvcnRlZEtleXMpIHsKICAgICAgaXRlcmF0ZVdpdGhTb3J0ZWRLZXlzKCk7CiAgICB9IGVsc2UgewogICAgICBmb3JFYWNoUHJvcGVydHkob2JqLCBuZXh0KTsKICAgIH0KICB9CgoKICAvLyBBcnJheSBoZWxwZXJzCgogIGZ1bmN0aW9uIGlzQXJyYXlJbmRleChuKSB7CiAgICByZXR1cm4gbiA+Pj4gMCA9PSBuICYmIG4gIT0gMHhGRkZGRkZGRjsKICB9CgogIGZ1bmN0aW9uIGl0ZXJhdGVPdmVyU3BhcnNlQXJyYXkoYXJyLCBmbiwgZnJvbUluZGV4LCBsb29wKSB7CiAgICB2YXIgaW5kZXhlcyA9IGdldFNwYXJzZUFycmF5SW5kZXhlcyhhcnIsIGZyb21JbmRleCwgbG9vcCksIGluZGV4OwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGluZGV4ZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgaW5kZXggPSBpbmRleGVzW2ldOwogICAgICBmbi5jYWxsKGFyciwgYXJyW2luZGV4XSwgaW5kZXgsIGFycik7CiAgICB9CiAgICByZXR1cm4gYXJyOwogIH0KCiAgLy8gSXQncyB1bmNsZWFyIHdoZXRoZXIgb3Igbm90IHNwYXJzZSBhcnJheXMgcXVhbGlmeSBhcyAic2ltcGxlIGVudW1lcmFibGVzIi4KICAvLyBJZiB0aGV5IGFyZSBub3QsIGhvd2V2ZXIsIHRoZSB3cmFwcGluZyBmdW5jdGlvbiB3aWxsIGJlIGRlb3B0aW1pemVkLCBzbwogIC8vIGlzb2xhdGUgaGVyZSAoYWxzbyB0byBzaGFyZSBiZXR3ZWVuIGVzNSBhbmQgYXJyYXkgbW9kdWxlcykuCiAgZnVuY3Rpb24gZ2V0U3BhcnNlQXJyYXlJbmRleGVzKGFyciwgZnJvbUluZGV4LCBsb29wLCBmcm9tUmlnaHQpIHsKICAgIHZhciBpbmRleGVzID0gW10sIGk7CiAgICBmb3IgKGkgaW4gYXJyKSB7CiAgICAgIGlmIChpc0FycmF5SW5kZXgoaSkgJiYgKGxvb3AgfHwgKGZyb21SaWdodCA/IGkgPD0gZnJvbUluZGV4IDogaSA+PSBmcm9tSW5kZXgpKSkgewogICAgICAgIGluZGV4ZXMucHVzaCgraSk7CiAgICAgIH0KICAgIH0KICAgIGluZGV4ZXMuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgIHZhciBhTG9vcCA9IGEgPiBmcm9tSW5kZXg7CiAgICAgIHZhciBiTG9vcCA9IGIgPiBmcm9tSW5kZXg7CiAgICAgIGlmIChhTG9vcCAhPT0gYkxvb3ApIHsKICAgICAgICByZXR1cm4gYUxvb3AgPyAtMSA6IDE7CiAgICAgIH0KICAgICAgcmV0dXJuIGEgLSBiOwogICAgfSk7CiAgICByZXR1cm4gaW5kZXhlczsKICB9CgogIGZ1bmN0aW9uIGdldEVudHJpZXNGb3JJbmRleGVzKG9iaiwgZmluZCwgbG9vcCwgaXNTdHJpbmcpIHsKICAgIHZhciByZXN1bHQsIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAoIWlzQXJyYXkoZmluZCkpIHsKICAgICAgcmV0dXJuIGVudHJ5QXRJbmRleChvYmosIGZpbmQsIGxlbmd0aCwgbG9vcCwgaXNTdHJpbmcpOwogICAgfQogICAgcmVzdWx0ID0gbmV3IEFycmF5KGZpbmQubGVuZ3RoKTsKICAgIGZvckVhY2goZmluZCwgZnVuY3Rpb24oaW5kZXgsIGkpIHsKICAgICAgcmVzdWx0W2ldID0gZW50cnlBdEluZGV4KG9iaiwgaW5kZXgsIGxlbmd0aCwgbG9vcCwgaXNTdHJpbmcpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZnVuY3Rpb24gZ2V0Tm9ybWFsaXplZEluZGV4KGluZGV4LCBsZW5ndGgsIGxvb3ApIHsKICAgIGlmIChpbmRleCAmJiBsb29wKSB7CiAgICAgIGluZGV4ID0gaW5kZXggJSBsZW5ndGg7CiAgICB9CiAgICBpZiAoaW5kZXggPCAwKSBpbmRleCA9IGxlbmd0aCArIGluZGV4OwogICAgcmV0dXJuIGluZGV4OwogIH0KCiAgZnVuY3Rpb24gZW50cnlBdEluZGV4KG9iaiwgaW5kZXgsIGxlbmd0aCwgbG9vcCwgaXNTdHJpbmcpIHsKICAgIGluZGV4ID0gZ2V0Tm9ybWFsaXplZEluZGV4KGluZGV4LCBsZW5ndGgsIGxvb3ApOwogICAgcmV0dXJuIGlzU3RyaW5nID8gb2JqLmNoYXJBdChpbmRleCkgOiBvYmpbaW5kZXhdOwogIH0KCiAgZnVuY3Rpb24gbWFwV2l0aFNob3J0Y3V0cyhlbCwgZiwgY29udGV4dCwgbWFwQXJncykgewogICAgaWYgKCFmKSB7CiAgICAgIHJldHVybiBlbDsKICAgIH0gZWxzZSBpZiAoZi5hcHBseSkgewogICAgICByZXR1cm4gZi5hcHBseShjb250ZXh0LCBtYXBBcmdzIHx8IFtdKTsKICAgIH0gZWxzZSBpZiAoaXNBcnJheShmKSkgewogICAgICByZXR1cm4gZi5tYXAoZnVuY3Rpb24obSkgewogICAgICAgIHJldHVybiBtYXBXaXRoU2hvcnRjdXRzKGVsLCBtLCBjb250ZXh0LCBtYXBBcmdzKTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oZWxbZl0pKSB7CiAgICAgIHJldHVybiBlbFtmXS5jYWxsKGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBkZWVwR2V0UHJvcGVydHkoZWwsIGYpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gc3BhY2VTcGxpdChzdHIpIHsKICAgIHJldHVybiBzdHIuc3BsaXQoJyAnKTsKICB9CgogIGZ1bmN0aW9uIGNvbW1hU3BsaXQoc3RyKSB7CiAgICByZXR1cm4gc3RyLnNwbGl0KEhBTEZfV0lEVEhfQ09NTUEpOwogIH0KCiAgZnVuY3Rpb24gcGVyaW9kU3BsaXQoc3RyKSB7CiAgICByZXR1cm4gc3RyLnNwbGl0KEhBTEZfV0lEVEhfUEVSSU9EKTsKICB9CgogIGZ1bmN0aW9uIGZvckVhY2goYXJyLCBmbikgewogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICBpZiAoIShpIGluIGFycikpIHsKICAgICAgICByZXR1cm4gaXRlcmF0ZU92ZXJTcGFyc2VBcnJheShhcnIsIGZuLCBpKTsKICAgICAgfQogICAgICBmbihhcnJbaV0sIGkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZmlsdGVyKGFyciwgZm4pIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgdmFyIGVsID0gYXJyW2ldOwogICAgICBpZiAoaSBpbiBhcnIgJiYgZm4oZWwsIGkpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goZWwpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZnVuY3Rpb24gbWFwKGFyciwgZm4pIHsKICAgIC8vIHBlcmY6IE5vdCB1c2luZyBmaXhlZCBhcnJheSBsZW4gaGVyZSBhcyBpdCBtYXkgYmUgc3BhcnNlLgogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICBpZiAoaSBpbiBhcnIpIHsKICAgICAgICByZXN1bHQucHVzaChmbihhcnJbaV0sIGkpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIGluZGV4T2YoYXJyLCBlbCkgewogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICBpZiAoaSBpbiBhcnIgJiYgYXJyW2ldID09PSBlbCkgcmV0dXJuIGk7CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICAvLyBOdW1iZXIgaGVscGVycwoKICB2YXIgdHJ1bmMgPSBNYXRoLnRydW5jIHx8IGZ1bmN0aW9uKG4pIHsKICAgIGlmIChuID09PSAwIHx8ICFpc0Zpbml0ZShuKSkgcmV0dXJuIG47CiAgICByZXR1cm4gbiA8IDAgPyBjZWlsKG4pIDogZmxvb3Iobik7CiAgfTsKCiAgZnVuY3Rpb24gaXNSZWFsTmFOKG9iaikgewogICAgLy8gVGhpcyBpcyBvbmx5IHRydWUgb2YgTmFOCiAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqICE9PSBvYmo7CiAgfQoKICBmdW5jdGlvbiB3aXRoUHJlY2lzaW9uKHZhbCwgcHJlY2lzaW9uLCBmbikgewogICAgdmFyIG11bHRpcGxpZXIgPSBwb3coMTAsIGFicyhwcmVjaXNpb24gfHwgMCkpOwogICAgZm4gPSBmbiB8fCByb3VuZDsKICAgIGlmIChwcmVjaXNpb24gPCAwKSBtdWx0aXBsaWVyID0gMSAvIG11bHRpcGxpZXI7CiAgICByZXR1cm4gZm4odmFsICogbXVsdGlwbGllcikgLyBtdWx0aXBsaWVyOwogIH0KCiAgZnVuY3Rpb24gcGFkTnVtYmVyKG51bSwgcGxhY2UsIHNpZ24sIGJhc2UsIHJlcGxhY2VtZW50KSB7CiAgICB2YXIgc3RyID0gYWJzKG51bSkudG9TdHJpbmcoYmFzZSB8fCAxMCk7CiAgICBzdHIgPSByZXBlYXRTdHJpbmcocmVwbGFjZW1lbnQgfHwgJzAnLCBwbGFjZSAtIHN0ci5yZXBsYWNlKC9cLlxkKy8sICcnKS5sZW5ndGgpICsgc3RyOwogICAgaWYgKHNpZ24gfHwgbnVtIDwgMCkgewogICAgICBzdHIgPSAobnVtIDwgMCA/ICctJyA6ICcrJykgKyBzdHI7CiAgICB9CiAgICByZXR1cm4gc3RyOwogIH0KCiAgZnVuY3Rpb24gZ2V0T3JkaW5hbFN1ZmZpeChudW0pIHsKICAgIGlmIChudW0gPj0gMTEgJiYgbnVtIDw9IDEzKSB7CiAgICAgIHJldHVybiAndGgnOwogICAgfSBlbHNlIHsKICAgICAgc3dpdGNoKG51bSAlIDEwKSB7CiAgICAgICAgY2FzZSAxOiAgcmV0dXJuICdzdCc7CiAgICAgICAgY2FzZSAyOiAgcmV0dXJuICduZCc7CiAgICAgICAgY2FzZSAzOiAgcmV0dXJuICdyZCc7CiAgICAgICAgZGVmYXVsdDogcmV0dXJuICd0aCc7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIEZ1bGx3aWR0aCBudW1iZXIgaGVscGVycwogIHZhciBmdWxsV2lkdGhOdW1iZXJSZWcsIGZ1bGxXaWR0aE51bWJlck1hcCwgZnVsbFdpZHRoTnVtYmVyczsKCiAgZnVuY3Rpb24gYnVpbGRGdWxsV2lkdGhOdW1iZXIoKSB7CiAgICB2YXIgZndwID0gRlVMTF9XSURUSF9QRVJJT0QsIGh3cCA9IEhBTEZfV0lEVEhfUEVSSU9ELCBod2MgPSBIQUxGX1dJRFRIX0NPTU1BLCBmd24gPSAnJzsKICAgIGZ1bGxXaWR0aE51bWJlck1hcCA9IHt9OwogICAgZm9yICh2YXIgaSA9IDAsIGRpZ2l0OyBpIDw9IDk7IGkrKykgewogICAgICBkaWdpdCA9IGNocihpICsgRlVMTF9XSURUSF9aRVJPKTsKICAgICAgZnduICs9IGRpZ2l0OwogICAgICBmdWxsV2lkdGhOdW1iZXJNYXBbZGlnaXRdID0gY2hyKGkgKyBIQUxGX1dJRFRIX1pFUk8pOwogICAgfQogICAgZnVsbFdpZHRoTnVtYmVyTWFwW2h3Y10gPSAnJzsKICAgIGZ1bGxXaWR0aE51bWJlck1hcFtmd3BdID0gaHdwOwogICAgLy8gTWFwcGluZyB0aGlzIHRvIGl0c2VsZiB0byBjYXB0dXJlIGl0IGVhc2lseQogICAgLy8gaW4gc3RyaW5nVG9OdW1iZXIgdG8gZGV0ZWN0IGRlY2ltYWxzIGxhdGVyLgogICAgZnVsbFdpZHRoTnVtYmVyTWFwW2h3cF0gPSBod3A7CiAgICBmdWxsV2lkdGhOdW1iZXJSZWcgPSBhbGxDaGFyc1JlZyhmd24gKyBmd3AgKyBod2MgKyBod3ApOwogICAgZnVsbFdpZHRoTnVtYmVycyA9IGZ3bjsKICB9CgogIC8vIFRha2VzIGludG8gYWNjb3VudCBmdWxsLXdpZHRoIGNoYXJhY3RlcnMsIGNvbW1hcywgYW5kIGRlY2ltYWxzLgogIGZ1bmN0aW9uIHN0cmluZ1RvTnVtYmVyKHN0ciwgYmFzZSkgewogICAgdmFyIHNhbml0aXplZCwgaXNEZWNpbWFsOwogICAgc2FuaXRpemVkID0gc3RyLnJlcGxhY2UoZnVsbFdpZHRoTnVtYmVyUmVnLCBmdW5jdGlvbihjaHIpIHsKICAgICAgdmFyIHJlcGxhY2VtZW50ID0gZ2V0T3duKGZ1bGxXaWR0aE51bWJlck1hcCwgY2hyKTsKICAgICAgaWYgKHJlcGxhY2VtZW50ID09PSBIQUxGX1dJRFRIX1BFUklPRCkgewogICAgICAgIGlzRGVjaW1hbCA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlcGxhY2VtZW50OwogICAgfSk7CiAgICByZXR1cm4gaXNEZWNpbWFsID8gcGFyc2VGbG9hdChzYW5pdGl6ZWQpIDogcGFyc2VJbnQoc2FuaXRpemVkLCBiYXNlIHx8IDEwKTsKICB9CgogIC8vIE1hdGggYWxpYXNlcwogIHZhciBhYnMgICA9IE1hdGguYWJzLAogICAgICBwb3cgICA9IE1hdGgucG93LAogICAgICBtaW4gICA9IE1hdGgubWluLAogICAgICBtYXggICA9IE1hdGgubWF4LAogICAgICBjZWlsICA9IE1hdGguY2VpbCwKICAgICAgZmxvb3IgPSBNYXRoLmZsb29yLAogICAgICByb3VuZCA9IE1hdGgucm91bmQ7CgoKICAvLyBTdHJpbmcgaGVscGVycwoKICB2YXIgY2hyID0gU3RyaW5nLmZyb21DaGFyQ29kZTsKCiAgZnVuY3Rpb24gdHJpbShzdHIpIHsKICAgIHJldHVybiBzdHIudHJpbSgpOwogIH0KCiAgZnVuY3Rpb24gcmVwZWF0U3RyaW5nKHN0ciwgbnVtKSB7CiAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICBzdHIgPSBzdHIudG9TdHJpbmcoKTsKICAgIHdoaWxlIChudW0gPiAwKSB7CiAgICAgIGlmIChudW0gJiAxKSB7CiAgICAgICAgcmVzdWx0ICs9IHN0cjsKICAgICAgfQogICAgICBpZiAobnVtID4+PSAxKSB7CiAgICAgICAgc3RyICs9IHN0cjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIHNpbXBsZUNhcGl0YWxpemUoc3RyKSB7CiAgICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRm9ybWF0TWF0Y2hlcihicmFja2V0TWF0Y2hlciwgcGVyY2VudE1hdGNoZXIsIHByZWNoZWNrKSB7CgogICAgdmFyIHJlZyA9IFNUUklOR19GT1JNQVRfUkVHOwogICAgdmFyIGNvbXBpbGVNZW1vaXplZCA9IG1lbW9pemVGdW5jdGlvbihjb21waWxlKTsKCiAgICBmdW5jdGlvbiBnZXRUb2tlbihmb3JtYXQsIG1hdGNoKSB7CiAgICAgIHZhciBnZXQsIHRva2VuLCBsaXRlcmFsLCBmbjsKICAgICAgdmFyIGJLZXkgPSBtYXRjaFsyXTsKICAgICAgdmFyIHBMaXQgPSBtYXRjaFszXTsKICAgICAgdmFyIHBLZXkgPSBtYXRjaFs1XTsKICAgICAgaWYgKG1hdGNoWzRdICYmIHBlcmNlbnRNYXRjaGVyKSB7CiAgICAgICAgdG9rZW4gPSBwS2V5OwogICAgICAgIGdldCA9IHBlcmNlbnRNYXRjaGVyOwogICAgICB9IGVsc2UgaWYgKGJLZXkpIHsKICAgICAgICB0b2tlbiA9IGJLZXk7CiAgICAgICAgZ2V0ID0gYnJhY2tldE1hdGNoZXI7CiAgICAgIH0gZWxzZSBpZiAocExpdCAmJiBwZXJjZW50TWF0Y2hlcikgewogICAgICAgIGxpdGVyYWwgPSBwTGl0OwogICAgICB9IGVsc2UgewogICAgICAgIGxpdGVyYWwgPSBtYXRjaFsxXSB8fCBtYXRjaFswXTsKICAgICAgfQogICAgICBpZiAoZ2V0KSB7CiAgICAgICAgYXNzZXJ0UGFzc2VzUHJlY2hlY2socHJlY2hlY2ssIGJLZXksIHBLZXkpOwogICAgICAgIGZuID0gZnVuY3Rpb24ob2JqLCBvcHQpIHsKICAgICAgICAgIHJldHVybiBnZXQob2JqLCB0b2tlbiwgb3B0KTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGZvcm1hdC5wdXNoKGZuIHx8IGdldExpdGVyYWwobGl0ZXJhbCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFN1YnN0cmluZyhmb3JtYXQsIHN0ciwgc3RhcnQsIGVuZCkgewogICAgICBpZiAoZW5kID4gc3RhcnQpIHsKICAgICAgICB2YXIgc3ViID0gc3RyLnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgICAgIGFzc2VydE5vVW5tYXRjaGVkKHN1YiwgT1BFTl9CUkFDRSk7CiAgICAgICAgYXNzZXJ0Tm9Vbm1hdGNoZWQoc3ViLCBDTE9TRV9CUkFDRSk7CiAgICAgICAgZm9ybWF0LnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gc3ViOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TGl0ZXJhbChzdHIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gYXNzZXJ0UGFzc2VzUHJlY2hlY2socHJlY2hlY2ssIGJ0LCBwdCkgewogICAgICBpZiAocHJlY2hlY2sgJiYgIXByZWNoZWNrKGJ0LCBwdCkpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIHRva2VuICcrIChidCB8fCBwdCkgKycgaW4gZm9ybWF0IHN0cmluZycpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYXNzZXJ0Tm9Vbm1hdGNoZWQoc3RyLCBjaHIpIHsKICAgICAgaWYgKHN0ci5pbmRleE9mKGNocikgIT09IC0xKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5tYXRjaGVkICcrIGNociArJyBpbiBmb3JtYXQgc3RyaW5nJyk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjb21waWxlKHN0cikgewogICAgICB2YXIgZm9ybWF0ID0gW10sIGxhc3RJbmRleCA9IDAsIG1hdGNoOwogICAgICByZWcubGFzdEluZGV4ID0gMDsKICAgICAgd2hpbGUobWF0Y2ggPSByZWcuZXhlYyhzdHIpKSB7CiAgICAgICAgZ2V0U3Vic3RyaW5nKGZvcm1hdCwgc3RyLCBsYXN0SW5kZXgsIG1hdGNoLmluZGV4KTsKICAgICAgICBnZXRUb2tlbihmb3JtYXQsIG1hdGNoKTsKICAgICAgICBsYXN0SW5kZXggPSByZWcubGFzdEluZGV4OwogICAgICB9CiAgICAgIGdldFN1YnN0cmluZyhmb3JtYXQsIHN0ciwgbGFzdEluZGV4LCBzdHIubGVuZ3RoKTsKICAgICAgcmV0dXJuIGZvcm1hdDsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24oc3RyLCBvYmosIG9wdCkgewogICAgICB2YXIgZm9ybWF0ID0gY29tcGlsZU1lbW9pemVkKHN0ciksIHJlc3VsdCA9ICcnOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZvcm1hdC5sZW5ndGg7IGkrKykgewogICAgICAgIHJlc3VsdCArPSBmb3JtYXRbaV0ob2JqLCBvcHQpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAgLy8gSW5mbGVjdGlvbiBoZWxwZXIKCiAgdmFyIEluZmxlY3Rpb25zID0ge307CgogIGZ1bmN0aW9uIGdldEFjcm9ueW0oc3RyKSB7CiAgICByZXR1cm4gSW5mbGVjdGlvbnMuYWNyb255bXMgJiYgSW5mbGVjdGlvbnMuYWNyb255bXMuZmluZChzdHIpOwogIH0KCiAgZnVuY3Rpb24gZ2V0SHVtYW5Xb3JkKHN0cikgewogICAgcmV0dXJuIEluZmxlY3Rpb25zLmh1bWFuICYmIEluZmxlY3Rpb25zLmh1bWFuLmZpbmQoc3RyKTsKICB9CgogIGZ1bmN0aW9uIHJ1bkh1bWFuUnVsZXMoc3RyKSB7CiAgICByZXR1cm4gSW5mbGVjdGlvbnMuaHVtYW4gJiYgSW5mbGVjdGlvbnMuaHVtYW4ucnVuUnVsZXMoc3RyKSB8fCBzdHI7CiAgfQoKICAvLyBSZWdFeHAgaGVscGVycwoKICBmdW5jdGlvbiBhbGxDaGFyc1JlZyhzcmMpIHsKICAgIHJldHVybiBSZWdFeHAoJ1snICsgc3JjICsgJ10nLCAnZycpOwogIH0KCiAgZnVuY3Rpb24gZ2V0UmVnRXhwRmxhZ3MocmVnLCBhZGQpIHsKICAgIHZhciBmbGFncyA9ICcnOwogICAgYWRkID0gYWRkIHx8ICcnOwogICAgZnVuY3Rpb24gY2hlY2tGbGFnKHByb3AsIGZsYWcpIHsKICAgICAgaWYgKHByb3AgfHwgYWRkLmluZGV4T2YoZmxhZykgPiAtMSkgewogICAgICAgIGZsYWdzICs9IGZsYWc7CiAgICAgIH0KICAgIH0KICAgIGNoZWNrRmxhZyhyZWcuZ2xvYmFsLCAnZycpOwogICAgY2hlY2tGbGFnKHJlZy5pZ25vcmVDYXNlLCAnaScpOwogICAgY2hlY2tGbGFnKHJlZy5tdWx0aWxpbmUsICdtJyk7CiAgICBjaGVja0ZsYWcocmVnLnN0aWNreSwgJ3knKTsKICAgIHJldHVybiBmbGFnczsKICB9CgogIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHIpIHsKICAgIGlmICghaXNTdHJpbmcoc3RyKSkgc3RyID0gU3RyaW5nKHN0cik7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbXFxcL1wnKis/fCgpXFtcXXt9Ll4kLV0pL2csJ1xcJDEnKTsKICB9CgogIC8vIERhdGUgaGVscGVycwoKICB2YXIgX3V0YyA9IHByaXZhdGVQcm9wZXJ0eUFjY2Vzc29yKCd1dGMnKTsKCiAgZnVuY3Rpb24gY2FsbERhdGVHZXQoZCwgbWV0aG9kKSB7CiAgICByZXR1cm4gZFsnZ2V0JyArIChfdXRjKGQpID8gJ1VUQycgOiAnJykgKyBtZXRob2RdKCk7CiAgfQoKICBmdW5jdGlvbiBjYWxsRGF0ZVNldChkLCBtZXRob2QsIHZhbHVlLCBzYWZlKSB7CiAgICAvLyAiU2FmZSIgZGVub3RlcyBub3Qgc2V0dGluZyB0aGUgZGF0ZSBpZiB0aGUgdmFsdWUgaXMgdGhlIHNhbWUgYXMgd2hhdCBpcwogICAgLy8gY3VycmVudGx5IHNldC4gSW4gdGhlb3J5IHRoaXMgc2hvdWxkIGJlIGEgbm9vcCwgaG93ZXZlciBpdCB3aWxsIGNhdXNlCiAgICAvLyB0aW1lem9uZSBzaGlmdHMgd2hlbiBpbiB0aGUgbWlkZGxlIG9mIGEgRFNUIGZhbGxiYWNrLiBUaGlzIGlzIHVuYXZvaWRhYmxlCiAgICAvLyBhcyB0aGUgbm90YXRpb24gaXRzZWxmIGlzIGFtYmlndW91cyAoaS5lLiB0aGVyZSBhcmUgdHdvICIxOjAwYW1zIiBvbgogICAgLy8gTm92ZW1iZXIgMXN0LCAyMDE1IGluIG5vcnRoZXJuIGhlbWlzcGhlcmUgdGltZXpvbmVzIHRoYXQgZm9sbG93IERTVCksCiAgICAvLyBob3dldmVyIHdoZW4gYWR2YW5jaW5nIG9yIHJld2luZGluZyBkYXRlcyB0aGlzIGNhbiB0aHJvdyBvZmYgY2FsY3VsYXRpb25zCiAgICAvLyBzbyBhdm9pZGluZyB0aGlzIHVuaW50ZW50aW9uYWwgc2hpZnRpbmcgb24gYW4gb3B0LWluIGJhc2lzLgogICAgaWYgKHNhZmUgJiYgdmFsdWUgPT09IGNhbGxEYXRlR2V0KGQsIG1ldGhvZCwgdmFsdWUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGRbJ3NldCcgKyAoX3V0YyhkKSA/ICdVVEMnIDogJycpICsgbWV0aG9kXSh2YWx1ZSk7CiAgfQoKICAvLyBNZW1vaXphdGlvbiBoZWxwZXJzCgogIHZhciBJTlRFUk5BTF9NRU1PSVpFX0xJTUlUID0gMTAwMDsKCiAgLy8gTm90ZSB0aGF0IGF0dGVtcHMgdG8gY29uc29saWRhdGUgdGhpcyB3aXRoIEZ1bmN0aW9uI21lbW9pemUKICAvLyBlbmRlZCB1cCBjbHVua3kgYXMgdGhhdCBpcyBhbHNvIHNlcmlhbGl6aW5nIGFyZ3VtZW50cy4gU2VwYXJhdGluZwogIC8vIHRoZXNlIGltcGxlbWVudGF0aW9ucyB0dXJuZWQgb3V0IHRvIGJlIHNpbXBsZXIuCiAgZnVuY3Rpb24gbWVtb2l6ZUZ1bmN0aW9uKGZuKSB7CiAgICB2YXIgbWVtbyA9IHt9LCBjb3VudGVyID0gMDsKCiAgICByZXR1cm4gZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChoYXNPd24obWVtbywga2V5KSkgewogICAgICAgIHJldHVybiBtZW1vW2tleV07CiAgICAgIH0KICAgICAgaWYgKGNvdW50ZXIgPT09IElOVEVSTkFMX01FTU9JWkVfTElNSVQpIHsKICAgICAgICBtZW1vID0ge307CiAgICAgICAgY291bnRlciA9IDA7CiAgICAgIH0KICAgICAgY291bnRlcisrOwogICAgICByZXR1cm4gbWVtb1trZXldID0gZm4oa2V5KTsKICAgIH07CiAgfQoKICAvLyBFUzYgaGVscGVycwoKICBmdW5jdGlvbiBzZXRUb0FycmF5KHNldCkgewogICAgdmFyIGFyciA9IG5ldyBBcnJheShzZXQuc2l6ZSksIGkgPSAwOwogICAgc2V0LmZvckVhY2goZnVuY3Rpb24odmFsKSB7CiAgICAgIGFycltpKytdID0gdmFsOwogICAgfSk7CiAgICByZXR1cm4gYXJyOwogIH0KCiAgZnVuY3Rpb24gbWFwVG9BcnJheShtYXApIHsKICAgIHZhciBhcnIgPSBuZXcgQXJyYXkobWFwLnNpemUpLCBpID0gMDsKICAgIG1hcC5mb3JFYWNoKGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgIGFycltpKytdID0gW2tleSwgdmFsXTsKICAgIH0pOwogICAgcmV0dXJuIGFycjsKICB9CgogIGJ1aWxkQ2xhc3NDaGVja3MoKTsKICBidWlsZEZ1bGxXaWR0aE51bWJlcigpOwoKICAvKioqCiAgICogQG1vZHVsZSBFUzYKICAgKiBAZGVzY3JpcHRpb24gUG9seWZpbGxzIHRoYXQgcHJvdmlkZSBiYXNpYyBFUzYgY29tcGF0aWJpbGl0eS4gVGhpcyBtb2R1bGUKICAgKiAgICAgICAgICAgICAgcHJvdmlkZXMgdGhlIGJhc2UgZm9yIFN1Z2FyIGZ1bmN0aW9uYWxpdHksIGJ1dCBpcyBub3QgYSBmdWxsCiAgICogICAgICAgICAgICAgIHBvbHlmaWxsIHN1aXRlLgogICAqCiAgICoqKi8KCgogIC8qKiogQG5hbWVzcGFjZSBTdHJpbmcgKioqLwoKICBmdW5jdGlvbiBnZXRDb2VyY2VkU3RyaW5nU3ViamVjdChvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdHJpbmcgcmVxdWlyZWQuJyk7CiAgICB9CiAgICByZXR1cm4gU3RyaW5nKG9iaik7CiAgfQoKICBmdW5jdGlvbiBnZXRDb2VyY2VkU2VhcmNoU3RyaW5nKG9iaikgewogICAgaWYgKGlzUmVnRXhwKG9iaikpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgfQogICAgcmV0dXJuIFN0cmluZyhvYmopOwogIH0KCiAgZGVmaW5lSW5zdGFuY2VQb2x5ZmlsbChzdWdhclN0cmluZywgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaW5jbHVkZXMoc2VhcmNoLCBbcG9zXSA9IDApCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAcG9seWZpbGwgRVM2CiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIGBzZWFyY2hgIGlzIGNvbnRhaW5lZCB3aXRoaW4gdGhlIHN0cmluZy4KICAgICAqIEBleHRyYSBTZWFyY2ggYmVnaW5zIGF0IFtwb3NdLCB3aGljaCBkZWZhdWx0cyB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZQogICAgICogICAgICAgIHN0cmluZy4gU3VnYXIgZW5oYW5jZXMgdGhpcyBtZXRob2QgdG8gYWxsb3cgbWF0Y2hpbmcgYSByZWdleC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2p1bXB5Jy5pbmNsdWRlcygncHknKSAgICAgIC0+IHRydWUKICAgICAqICAgJ2Jyb2tlbicuaW5jbHVkZXMoJ2tlbicsIDMpIC0+IHRydWUKICAgICAqICAgJ2Jyb2tlbicuaW5jbHVkZXMoJ2JybycsIDMpIC0+IGZhbHNlCiAgICAgKgogICAgICoqKi8KICAgICdpbmNsdWRlcyc6IGZ1bmN0aW9uKHNlYXJjaFN0cmluZykgewogICAgICAvLyBGb3JjZSBjb21waWxlciB0byByZXNwZWN0IGFyZ3VtZW50IGxlbmd0aC4KICAgICAgdmFyIGFyZ0xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIHBvcyA9IGFyZ3VtZW50c1sxXTsKICAgICAgdmFyIHN0ciA9IGdldENvZXJjZWRTdHJpbmdTdWJqZWN0KHRoaXMpOwogICAgICBzZWFyY2hTdHJpbmcgPSBnZXRDb2VyY2VkU2VhcmNoU3RyaW5nKHNlYXJjaFN0cmluZyk7CiAgICAgIHJldHVybiBzdHIuaW5kZXhPZihzZWFyY2hTdHJpbmcsIHBvcykgIT09IC0xOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHN0YXJ0c1dpdGgoc2VhcmNoLCBbcG9zXSA9IDApCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAcG9seWZpbGwgRVM2CiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBzdHJpbmcgc3RhcnRzIHdpdGggc3Vic3RyaW5nIGBzZWFyY2hgLgogICAgICogQGV4dHJhIFNlYXJjaCBiZWdpbnMgYXQgW3Bvc10sIHdoaWNoIGRlZmF1bHRzIHRvIHRoZSBlbnRpcmUgc3RyaW5nIGxlbmd0aC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2hlbGxvJy5zdGFydHNXaXRoKCdoZWxsJykgICAtPiB0cnVlCiAgICAgKiAgICdoZWxsbycuc3RhcnRzV2l0aCgnSEVMTCcpICAgLT4gZmFsc2UKICAgICAqICAgJ2hlbGxvJy5zdGFydHNXaXRoKCdlbGwnLCAxKSAtPiB0cnVlCiAgICAgKgogICAgICoqKi8KICAgICdzdGFydHNXaXRoJzogZnVuY3Rpb24oc2VhcmNoU3RyaW5nKSB7CiAgICAgIC8vIEZvcmNlIGNvbXBpbGVyIHRvIHJlc3BlY3QgYXJndW1lbnQgbGVuZ3RoLgogICAgICB2YXIgYXJnTGVuID0gYXJndW1lbnRzLmxlbmd0aCwgcG9zaXRpb24gPSBhcmd1bWVudHNbMV07CiAgICAgIHZhciBzdHIsIHN0YXJ0LCBwb3MsIGxlbiwgc2VhcmNoTGVuZ3RoOwogICAgICBzdHIgPSBnZXRDb2VyY2VkU3RyaW5nU3ViamVjdCh0aGlzKTsKICAgICAgc2VhcmNoU3RyaW5nID0gZ2V0Q29lcmNlZFNlYXJjaFN0cmluZyhzZWFyY2hTdHJpbmcpOwogICAgICBwb3MgPSArcG9zaXRpb24gfHwgMDsKICAgICAgbGVuID0gc3RyLmxlbmd0aDsKICAgICAgc3RhcnQgPSBtaW4obWF4KHBvcywgMCksIGxlbik7CiAgICAgIHNlYXJjaExlbmd0aCA9IHNlYXJjaFN0cmluZy5sZW5ndGg7CiAgICAgIGlmIChzZWFyY2hMZW5ndGggKyBzdGFydCA+IGxlbikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoc3RyLnN1YnN0cihzdGFydCwgc2VhcmNoTGVuZ3RoKSA9PT0gc2VhcmNoU3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGVuZHNXaXRoKHNlYXJjaCwgW3Bvc10gPSBsZW5ndGgpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAcG9seWZpbGwgRVM2CiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBzdHJpbmcgZW5kcyB3aXRoIHN1YnN0cmluZyBgc2VhcmNoYC4KICAgICAqIEBleHRyYSBTZWFyY2ggZW5kcyBhdCBbcG9zXSwgd2hpY2ggZGVmYXVsdHMgdG8gdGhlIGVudGlyZSBzdHJpbmcgbGVuZ3RoLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnanVtcHknLmVuZHNXaXRoKCdweScpICAgIC0+IHRydWUKICAgICAqICAgJ2p1bXB5Jy5lbmRzV2l0aCgnTVBZJykgICAtPiBmYWxzZQogICAgICogICAnanVtcHknLmVuZHNXaXRoKCdtcCcsIDQpIC0+IGZhbHNlCiAgICAgKgogICAgICoqKi8KICAgICdlbmRzV2l0aCc6IGZ1bmN0aW9uKHNlYXJjaFN0cmluZykgewogICAgICAvLyBGb3JjZSBjb21waWxlciB0byByZXNwZWN0IGFyZ3VtZW50IGxlbmd0aC4KICAgICAgdmFyIGFyZ0xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGVuZFBvc2l0aW9uID0gYXJndW1lbnRzWzFdOwogICAgICB2YXIgc3RyLCBzdGFydCwgZW5kLCBwb3MsIGxlbiwgc2VhcmNoTGVuZ3RoOwogICAgICBzdHIgPSBnZXRDb2VyY2VkU3RyaW5nU3ViamVjdCh0aGlzKTsKICAgICAgc2VhcmNoU3RyaW5nID0gZ2V0Q29lcmNlZFNlYXJjaFN0cmluZyhzZWFyY2hTdHJpbmcpOwogICAgICBsZW4gPSBzdHIubGVuZ3RoOwogICAgICBwb3MgPSBsZW47CiAgICAgIGlmIChpc0RlZmluZWQoZW5kUG9zaXRpb24pKSB7CiAgICAgICAgcG9zID0gK2VuZFBvc2l0aW9uIHx8IDA7CiAgICAgIH0KICAgICAgZW5kID0gbWluKG1heChwb3MsIDApLCBsZW4pOwogICAgICBzZWFyY2hMZW5ndGggPSBzZWFyY2hTdHJpbmcubGVuZ3RoOwogICAgICBzdGFydCA9IGVuZCAtIHNlYXJjaExlbmd0aDsKICAgICAgaWYgKHN0YXJ0IDwgMCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoc3RyLnN1YnN0cihzdGFydCwgc2VhcmNoTGVuZ3RoKSA9PT0gc2VhcmNoU3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJlcGVhdChbbnVtXSA9IDApCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBwb2x5ZmlsbCBFUzYKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBzdHJpbmcgcmVwZWF0ZWQgW251bV0gdGltZXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdqdW1weScucmVwZWF0KDIpIC0+ICdqdW1weWp1bXB5JwogICAgICogICAnYScucmVwZWF0KDUpICAgICAtPiAnYWFhYWEnCiAgICAgKiAgICdhJy5yZXBlYXQoMCkgICAgIC0+ICcnCiAgICAgKgogICAgICoqKi8KICAgICdyZXBlYXQnOiBmdW5jdGlvbihudW0pIHsKICAgICAgbnVtID0gY29lcmNlUG9zaXRpdmVJbnRlZ2VyKG51bSk7CiAgICAgIHJldHVybiByZXBlYXRTdHJpbmcodGhpcywgbnVtKTsKICAgIH0KCiAgfSk7CgoKICAvKioqIEBuYW1lc3BhY2UgTnVtYmVyICoqKi8KCiAgZGVmaW5lU3RhdGljUG9seWZpbGwoc3VnYXJOdW1iZXIsIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGlzTmFOKHZhbHVlKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHBvbHlmaWxsIEVTNgogICAgICogQHN0YXRpYwogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBvbmx5IGlmIHRoZSBudW1iZXIgaXMgYE5hTmAuCiAgICAgKiBAZXh0cmEgVGhpcyBpcyBkaWZmZXJzIGZyb20gdGhlIGdsb2JhbCBgaXNOYU5gLCB3aGljaCByZXR1cm5zIHRydWUgZm9yCiAgICAgKiAgICAgICAgYW55dGhpbmcgdGhhdCBpcyBub3QgYSBudW1iZXIuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE51bWJlci5pc05hTihOYU4pIC0+IHRydWUKICAgICAqICAgTnVtYmVyLmlzTmFOKCduJykgLT4gZmFsc2UKICAgICAqCiAgICAgKioqLwogICAgJ2lzTmFOJzogZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiBpc1JlYWxOYU4ob2JqKTsKICAgIH0KCiAgfSk7CgoKICAvKioqIEBuYW1lc3BhY2UgQXJyYXkgKioqLwoKICBmdW5jdGlvbiBnZXRDb2VyY2VkT2JqZWN0KG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ09iamVjdCByZXF1aXJlZC4nKTsKICAgIH0KICAgIHJldHVybiBjb2VyY2VQcmltaXRpdmVUb09iamVjdChvYmopOwogIH0KCiAgZGVmaW5lU3RhdGljUG9seWZpbGwoc3VnYXJBcnJheSwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZnJvbShhLCBbbWFwXSwgW2NvbnRleHRdKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBwb2x5ZmlsbCBFUzYKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaG9ydCBDcmVhdGVzIGFuIGFycmF5IGZyb20gYW4gYXJyYXktbGlrZSBvYmplY3QuCiAgICAgKiBAZXh0cmEgSWYgYSBmdW5jdGlvbiBpcyBwYXNzZWQgZm9yIFttYXBdLCBpdCB3aWxsIGJlIG1hcCBlYWNoIGVsZW1lbnQgb2YKICAgICAqICAgICAgICB0aGUgYXJyYXkuIFtjb250ZXh0XSBpcyB0aGUgYHRoaXNgIG9iamVjdCBpZiBwYXNzZWQuCiAgICAgKgogICAgICogQGNhbGxiYWNrIG1hcAogICAgICoKICAgICAqICAgZWwgICBUaGUgZWxlbWVudCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGkgICAgVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgYXJyICBBIHJlZmVyZW5jZSB0byB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIEFycmF5LmZyb20oezA6J2EnLDE6J2InLGxlbmd0aDoyfSk7IC0+IFsnYScsJ2InXQogICAgICoKICAgICAqKiovCiAgICAnZnJvbSc6IGZ1bmN0aW9uKGEpIHsKICAgICAgLy8gRm9yY2UgY29tcGlsZXIgdG8gcmVzcGVjdCBhcmd1bWVudCBsZW5ndGguCiAgICAgIHZhciBhcmdMZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBtYXAgPSBhcmd1bWVudHNbMV0sIGNvbnRleHQgPSBhcmd1bWVudHNbMl07CiAgICAgIHZhciBsZW4sIGFycjsKICAgICAgaWYgKGlzRGVmaW5lZChtYXApKSB7CiAgICAgICAgYXNzZXJ0Q2FsbGFibGUobWFwKTsKICAgICAgfQogICAgICBhID0gZ2V0Q29lcmNlZE9iamVjdChhKTsKICAgICAgbGVuID0gdHJ1bmMobWF4KDAsIGEubGVuZ3RoIHx8IDApKTsKICAgICAgaWYgKCFpc0FycmF5SW5kZXgobGVuKSkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIGFycmF5IGxlbmd0aCcpOwogICAgICB9CiAgICAgIGlmIChpc0Z1bmN0aW9uKHRoaXMpKSB7CiAgICAgICAgYXJyID0gbmV3IHRoaXMobGVuKTsKICAgICAgICBhcnIubGVuZ3RoID0gbGVuOwogICAgICB9IGVsc2UgewogICAgICAgIGFyciA9IG5ldyBBcnJheShsZW4pOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBzZXRQcm9wZXJ0eShhcnIsIGksIGlzRGVmaW5lZChtYXApID8gbWFwLmNhbGwoY29udGV4dCwgYVtpXSwgaSkgOiBhW2ldLCB0cnVlKTsKICAgICAgfQogICAgICByZXR1cm4gYXJyOwogICAgfQoKICB9KTsKCiAgZGVmaW5lSW5zdGFuY2VQb2x5ZmlsbChzdWdhckFycmF5LCB7CgogICAgJ2ZpbmQnOiBmdW5jdGlvbihmKSB7CiAgICAgIC8vIEZvcmNlIGNvbXBpbGVyIHRvIHJlc3BlY3QgYXJndW1lbnQgbGVuZ3RoLgogICAgICB2YXIgYXJnTGVuID0gYXJndW1lbnRzLmxlbmd0aCwgY29udGV4dCA9IGFyZ3VtZW50c1sxXTsKICAgICAgYXNzZXJ0Q2FsbGFibGUoZik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGYuY2FsbChjb250ZXh0LCB0aGlzW2ldLCBpLCB0aGlzKSkgewogICAgICAgICAgcmV0dXJuIHRoaXNbaV07CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgICdmaW5kSW5kZXgnOiBmdW5jdGlvbihmKSB7CiAgICAgIC8vIEZvcmNlIGNvbXBpbGVyIHRvIHJlc3BlY3QgYXJndW1lbnQgbGVuZ3RoLgogICAgICB2YXIgYXJnTGVuID0gYXJndW1lbnRzLmxlbmd0aCwgY29udGV4dCA9IGFyZ3VtZW50c1sxXTsKICAgICAgYXNzZXJ0Q2FsbGFibGUoZik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGYuY2FsbChjb250ZXh0LCB0aGlzW2ldLCBpLCB0aGlzKSkgewogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgfSk7CgogIC8qKioKICAgKiBAbW9kdWxlIEVTNwogICAqIEBkZXNjcmlwdGlvbiBQb2x5ZmlsbHMgdGhhdCBwcm92aWRlIGJhc2ljIEVTNyBjb21wYXRpYmlsaXR5LiBUaGlzIG1vZHVsZQogICAqICAgICAgICAgICAgICBwcm92aWRlcyB0aGUgYmFzZSBmb3IgU3VnYXIgZnVuY3Rpb25hbGl0eSwgYnV0IGlzIG5vdCBhIGZ1bGwKICAgKiAgICAgICAgICAgICAgcG9seWZpbGwgc3VpdGUuCiAgICoKICAgKioqLwoKCiAgLyoqKiBAbmFtZXNwYWNlIEFycmF5ICoqKi8KCiAgZnVuY3Rpb24gc2FtZVZhbHVlWmVybyhhLCBiKSB7CiAgICBpZiAoaXNSZWFsTmFOKGEpKSB7CiAgICAgIHJldHVybiBpc1JlYWxOYU4oYik7CiAgICB9CiAgICByZXR1cm4gYSA9PT0gYiA/IGEgIT09IDAgfHwgMSAvIGEgPT09IDEgLyBiIDogZmFsc2U7CiAgfQoKICBkZWZpbmVJbnN0YW5jZVBvbHlmaWxsKHN1Z2FyQXJyYXksIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGluY2x1ZGVzKHNlYXJjaCwgW2Zyb21JbmRleF0gPSAwKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHBvbHlmaWxsIEVTNwogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiBgc2VhcmNoYCBpcyBjb250YWluZWQgd2l0aGluIHRoZSBhcnJheS4KICAgICAqIEBleHRyYSBTZWFyY2ggYmVnaW5zIGF0IFtmcm9tSW5kZXhdLCB3aGljaCBkZWZhdWx0cyB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZQogICAgICogICAgICAgIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDNdLmluY2x1ZGVzKDIpICAgIC0+IHRydWUKICAgICAqICAgWzEsMiwzXS5pbmNsdWRlcyg0KSAgICAtPiBmYWxzZQogICAgICogICBbMSwyLDNdLmluY2x1ZGVzKDIsIDMpIC0+IGZhbHNlCiAgICAgKgogICAgICoqKi8KICAgICdpbmNsdWRlcyc6IGZ1bmN0aW9uKHNlYXJjaCkgewogICAgICAvLyBGb3JjZSBjb21waWxlciB0byByZXNwZWN0IGFyZ3VtZW50IGxlbmd0aC4KICAgICAgdmFyIGFyZ0xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGZyb21JbmRleCA9IGFyZ3VtZW50c1sxXTsKICAgICAgdmFyIGFyciA9IHRoaXMsIGxlbjsKICAgICAgaWYgKGlzU3RyaW5nKGFycikpIHJldHVybiBhcnIuaW5jbHVkZXMoc2VhcmNoLCBmcm9tSW5kZXgpOwogICAgICBmcm9tSW5kZXggPSBmcm9tSW5kZXggPyBmcm9tSW5kZXgudmFsdWVPZigpIDogMDsKICAgICAgbGVuID0gYXJyLmxlbmd0aDsKICAgICAgaWYgKGZyb21JbmRleCA8IDApIHsKICAgICAgICBmcm9tSW5kZXggPSBtYXgoMCwgZnJvbUluZGV4ICsgbGVuKTsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gZnJvbUluZGV4OyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoc2FtZVZhbHVlWmVybyhzZWFyY2gsIGFycltpXSkpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvKioqCiAgICogQG1vZHVsZSBEYXRlCiAgICogQGRlc2NyaXB0aW9uIERhdGUgcGFyc2luZyBhbmQgZm9ybWF0dGluZywgcmVsYXRpdmUgZm9ybWF0cywgbnVtYmVyIHNob3J0Y3V0cywKICAgKiAgICAgICAgICAgICAgYW5kIGxvY2FsZSBzdXBwb3J0IHdpdGggZGVmYXVsdCBFbmdsaXNoIGxvY2FsZXMuCiAgICoKICAgKioqLwoKICB2YXIgREFURV9PUFRJT05TID0gewogICAgJ25ld0RhdGVJbnRlcm5hbCc6IGRlZmF1bHROZXdEYXRlCiAgfTsKCiAgdmFyIExPQ0FMRV9BUlJBWV9GSUVMRFMgPSBbCiAgICAnbW9udGhzJywgJ3dlZWtkYXlzJywgJ3VuaXRzJywgJ251bWVyYWxzJywgJ3BsYWNlaG9sZGVycycsCiAgICAnYXJ0aWNsZXMnLCAndG9rZW5zJywgJ3RpbWVNYXJrZXJzJywgJ2FtcG0nLCAndGltZVN1ZmZpeGVzJywKICAgICdwYXJzZScsICd0aW1lUGFyc2UnLCAndGltZUZyb250UGFyc2UnLCAnbW9kaWZpZXJzJwogIF07CgogIC8vIFJlZ2V4IGZvciBzdHJpcHBpbmcgVGltZXpvbmUgQWJicmV2aWF0aW9ucwogIHZhciBUSU1FWk9ORV9BQkJSRVZJQVRJT05fUkVHID0gLyhcd3szfSlbKClcc1xkXSokLzsKCiAgLy8gT25lIG1pbnV0ZSBpbiBtaWxsaXNlY29uZHMKICB2YXIgTUlOVVRFUyA9IDYwICogMTAwMDsKCiAgLy8gRGF0ZSB1bml0IGluZGV4ZXMKICB2YXIgSE9VUlNfSU5ERVggICA9IDMsCiAgICAgIERBWV9JTkRFWCAgICAgPSA0LAogICAgICBXRUVLX0lOREVYICAgID0gNSwKICAgICAgTU9OVEhfSU5ERVggICA9IDYsCiAgICAgIFlFQVJfSU5ERVggICAgPSA3OwoKICAvLyBJU08gRGVmYXVsdHMKICB2YXIgSVNPX0ZJUlNUX0RBWV9PRl9XRUVLID0gMSwKICAgICAgSVNPX0ZJUlNUX0RBWV9PRl9XRUVLX1lFQVIgPSA0OwoKICB2YXIgUGFyc2luZ1Rva2VucyA9IHsKICAgICd5eXl5JzogewogICAgICBwYXJhbTogJ3llYXInLAogICAgICBzcmM6ICdcXGR7NH0nCiAgICB9LAogICAgJ01NJzogewogICAgICBwYXJhbTogJ21vbnRoJywKICAgICAgc3JjOiAnWzAxXT9cXGQnCiAgICB9LAogICAgJ2RkJzogewogICAgICBwYXJhbTogJ2RhdGUnLAogICAgICBzcmM6ICdbMDEyM10/XFxkJwogICAgfSwKICAgICdoaCc6IHsKICAgICAgcGFyYW06ICdob3VyJywKICAgICAgc3JjOiAnWzAtMl0/XFxkJwogICAgfSwKICAgICdtbSc6IHsKICAgICAgcGFyYW06ICdtaW51dGUnLAogICAgICBzcmM6ICdbMC01XVxcZCcKICAgIH0sCiAgICAnc3MnOiB7CiAgICAgIHBhcmFtOiAnc2Vjb25kJywKICAgICAgc3JjOiAnWzAtNV1cXGQoPzpbLC5dXFxkKyk/JwogICAgfSwKICAgICd5eSc6IHsKICAgICAgcGFyYW06ICd5ZWFyJywKICAgICAgc3JjOiAnXFxkezJ9JwogICAgfSwKICAgICd5JzogewogICAgICBwYXJhbTogJ3llYXInLAogICAgICBzcmM6ICdcXGQnCiAgICB9LAogICAgJ3llYXJTaWduJzogewogICAgICBzcmM6ICdbKy1dJywKICAgICAgc2lnbjogdHJ1ZQogICAgfSwKICAgICd0ekhvdXInOiB7CiAgICAgIHNyYzogJ1swLTFdXFxkJwogICAgfSwKICAgICd0ek1pbnV0ZSc6IHsKICAgICAgc3JjOiAnWzAtNV1cXGQnCiAgICB9LAogICAgJ3R6U2lnbic6IHsKICAgICAgc3JjOiAnWyviiJItXScsCiAgICAgIHNpZ246IHRydWUKICAgIH0sCiAgICAnaWhoJzogewogICAgICBwYXJhbTogJ2hvdXInLAogICAgICBzcmM6ICdbMC0yXT9cXGQoPzpbLC5dXFxkKyk/JwogICAgfSwKICAgICdpbW0nOiB7CiAgICAgIHBhcmFtOiAnbWludXRlJywKICAgICAgc3JjOiAnWzAtNV1cXGQoPzpbLC5dXFxkKyk/JwogICAgfSwKICAgICdHTVQnOiB7CiAgICAgIHBhcmFtOiAndXRjJywKICAgICAgc3JjOiAnR01UJywKICAgICAgdmFsOiAxCiAgICB9LAogICAgJ1onOiB7CiAgICAgIHBhcmFtOiAndXRjJywKICAgICAgc3JjOiAnWicsCiAgICAgIHZhbDogMQogICAgfSwKICAgICd0aW1lc3RhbXAnOiB7CiAgICAgIHNyYzogJ1xcZCsnCiAgICB9CiAgfTsKCiAgdmFyIExvY2FsaXplZFBhcnNpbmdUb2tlbnMgPSB7CiAgICAneWVhcic6IHsKICAgICAgYmFzZTogJ3l5eXknLAogICAgICByZXF1aXJlc1N1ZmZpeDogdHJ1ZQogICAgfSwKICAgICdtb250aCc6IHsKICAgICAgYmFzZTogJ01NJywKICAgICAgcmVxdWlyZXNTdWZmaXg6IHRydWUKICAgIH0sCiAgICAnZGF0ZSc6IHsKICAgICAgYmFzZTogJ2RkJywKICAgICAgcmVxdWlyZXNTdWZmaXg6IHRydWUKICAgIH0sCiAgICAnaG91cic6IHsKICAgICAgYmFzZTogJ2hoJywKICAgICAgcmVxdWlyZXNTdWZmaXhPcjogJzonCiAgICB9LAogICAgJ21pbnV0ZSc6IHsKICAgICAgYmFzZTogJ21tJwogICAgfSwKICAgICdzZWNvbmQnOiB7CiAgICAgIGJhc2U6ICdzcycKICAgIH0sCiAgICAnbnVtJzogewogICAgICBzcmM6ICdcXGQrJywKICAgICAgcmVxdWlyZXNOdW1lcmFsczogdHJ1ZQogICAgfQogIH07CgogIHZhciBDb3JlUGFyc2luZ0Zvcm1hdHMgPSBbCiAgICB7CiAgICAgIC8vIDEyLTE5NzgKICAgICAgLy8gMDgtMTk3OCAoTURZKQogICAgICBzcmM6ICd7TU19Wy0uXFwvXXt5eXl5fScKICAgIH0sCiAgICB7CiAgICAgIC8vIDEyLzA4LzE5NzgKICAgICAgLy8gMDgvMTIvMTk3OCAoTURZKQogICAgICB0aW1lOiB0cnVlLAogICAgICBzcmM6ICd7ZGR9Wy0uXFwvXXtNTX0oPzpbLS5cXC9de3l5eXl8eXl8eX0pPycsCiAgICAgIG1keTogJ3tNTX1bLS5cXC9de2RkfSg/OlstLlxcL117eXl5eXx5eXx5fSk/JwogICAgfSwKICAgIHsKICAgICAgLy8gMTk3NS0wOC0yNQogICAgICB0aW1lOiB0cnVlLAogICAgICBzcmM6ICd7eXl5eX1bLS5cXC9de01NfSg/OlstLlxcL117ZGR9KT8nCiAgICB9LAogICAgewogICAgICAvLyAuTkVUIEpTT04KICAgICAgc3JjOiAnXFxcXC9EYXRlXFwoe3RpbWVzdGFtcH0oPzpbKy1dXFxkezQsNH0pP1xcKVxcXFwvJwogICAgfSwKICAgIHsKICAgICAgLy8gSVNPLTg2MDEKICAgICAgc3JjOiAne3llYXJTaWduP317eXl5eX0oPzotP3tNTX0oPzotP3tkZH0oPzpUe2loaH0oPzo6P3tpbW19KD86Oj97c3N9KT8pPyk/KT8pP3t0ek9mZnNldD99JwogICAgfQogIF07CgogIHZhciBDb3JlT3V0cHV0Rm9ybWF0cyA9IHsKICAgICdJU084NjAxJzogJ3t5eXl5fS17TU19LXtkZH1Ue0hIfTp7bW19Ontzc30ue1NTU317Wn0nLAogICAgJ1JGQzExMjMnOiAne0Rvd30sIHtkZH0ge01vbn0ge3l5eXl9IHtISH06e21tfTp7c3N9IHtaWn0nLAogICAgJ1JGQzEwMzYnOiAne1dlZWtkYXl9LCB7ZGR9LXtNb259LXt5eX0ge0hIfTp7bW19Ontzc30ge1pafScKICB9OwoKICB2YXIgRm9ybWF0VG9rZW5zQmFzZSA9IFsKICAgIHsKICAgICAgbGRtbDogJ0RvdycsCiAgICAgIHN0cmY6ICdhJywKICAgICAgbG93ZXJUb2tlbjogJ2RvdycsCiAgICAgIGdldDogZnVuY3Rpb24oZCwgbG9jYWxlQ29kZSkgewogICAgICAgIHJldHVybiBsb2NhbGVNYW5hZ2VyLmdldChsb2NhbGVDb2RlKS5nZXRXZWVrZGF5TmFtZShnZXRXZWVrZGF5KGQpLCAyKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ1dlZWtkYXknLAogICAgICBzdHJmOiAnQScsCiAgICAgIGxvd2VyVG9rZW46ICd3ZWVrZGF5JywKICAgICAgYWxsb3dBbHRlcm5hdGVzOiB0cnVlLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQsIGxvY2FsZUNvZGUsIGFsdGVybmF0ZSkgewogICAgICAgIHJldHVybiBsb2NhbGVNYW5hZ2VyLmdldChsb2NhbGVDb2RlKS5nZXRXZWVrZGF5TmFtZShnZXRXZWVrZGF5KGQpLCBhbHRlcm5hdGUpOwogICAgICB9CiAgICB9LAogICAgewogICAgICBsZG1sOiAnTW9uJywKICAgICAgc3RyZjogJ2IgaCcsCiAgICAgIGxvd2VyVG9rZW46ICdtb24nLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQsIGxvY2FsZUNvZGUpIHsKICAgICAgICByZXR1cm4gbG9jYWxlTWFuYWdlci5nZXQobG9jYWxlQ29kZSkuZ2V0TW9udGhOYW1lKGdldE1vbnRoKGQpLCAyKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ01vbnRoJywKICAgICAgc3RyZjogJ0InLAogICAgICBsb3dlclRva2VuOiAnbW9udGgnLAogICAgICBhbGxvd0FsdGVybmF0ZXM6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24oZCwgbG9jYWxlQ29kZSwgYWx0ZXJuYXRlKSB7CiAgICAgICAgcmV0dXJuIGxvY2FsZU1hbmFnZXIuZ2V0KGxvY2FsZUNvZGUpLmdldE1vbnRoTmFtZShnZXRNb250aChkKSwgYWx0ZXJuYXRlKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgc3RyZjogJ0MnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICByZXR1cm4gZ2V0WWVhcihkKS50b1N0cmluZygpLnNsaWNlKDAsIDIpOwogICAgICB9CiAgICB9LAogICAgewogICAgICBsZG1sOiAnZCBkYXRlIGRheScsCiAgICAgIHN0cmY6ICdkJywKICAgICAgc3RyZlBhZGRpbmc6IDIsCiAgICAgIGxkbWxQYWRkZWRUb2tlbjogJ2RkJywKICAgICAgb3JkaW5hbFRva2VuOiAnZG8nLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICByZXR1cm4gZ2V0RGF0ZShkKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgc3RyZjogJ2UnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICByZXR1cm4gcGFkTnVtYmVyKGdldERhdGUoZCksIDIsIGZhbHNlLCAxMCwgJyAnKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ0ggMjRocicsCiAgICAgIHN0cmY6ICdIJywKICAgICAgc3RyZlBhZGRpbmc6IDIsCiAgICAgIGxkbWxQYWRkZWRUb2tlbjogJ0hIJywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGdldEhvdXJzKGQpOwogICAgICB9CiAgICB9LAogICAgewogICAgICBsZG1sOiAnaCBob3VycyAxMmhyJywKICAgICAgc3RyZjogJ0knLAogICAgICBzdHJmUGFkZGluZzogMiwKICAgICAgbGRtbFBhZGRlZFRva2VuOiAnaGgnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICByZXR1cm4gZ2V0SG91cnMoZCkgJSAxMiB8fCAxMjsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ0QnLAogICAgICBzdHJmOiAnaicsCiAgICAgIHN0cmZQYWRkaW5nOiAzLAogICAgICBsZG1sUGFkZGVkVG9rZW46ICdEREQnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICB2YXIgcyA9IHNldFVuaXRBbmRMb3dlclRvRWRnZShjbG9uZURhdGUoZCksIE1PTlRIX0lOREVYKTsKICAgICAgICByZXR1cm4gZ2V0RGF5c1NpbmNlKGQsIHMpICsgMTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ00nLAogICAgICBzdHJmOiAnbScsCiAgICAgIHN0cmZQYWRkaW5nOiAyLAogICAgICBvcmRpbmFsVG9rZW46ICdNbycsCiAgICAgIGxkbWxQYWRkZWRUb2tlbjogJ01NJywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGdldE1vbnRoKGQpICsgMTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ20gbWludXRlcycsCiAgICAgIHN0cmY6ICdNJywKICAgICAgc3RyZlBhZGRpbmc6IDIsCiAgICAgIGxkbWxQYWRkZWRUb2tlbjogJ21tJywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGNhbGxEYXRlR2V0KGQsICdNaW51dGVzJyk7CiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgIGxkbWw6ICdRJywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGNlaWwoKGdldE1vbnRoKGQpICsgMSkgLyAzKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ1RUJywKICAgICAgc3RyZjogJ3AnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQsIGxvY2FsZUNvZGUpIHsKICAgICAgICByZXR1cm4gZ2V0TWVyaWRpZW1Ub2tlbihkLCBsb2NhbGVDb2RlKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ3R0JywKICAgICAgc3RyZjogJ1AnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQsIGxvY2FsZUNvZGUpIHsKICAgICAgICByZXR1cm4gZ2V0TWVyaWRpZW1Ub2tlbihkLCBsb2NhbGVDb2RlKS50b0xvd2VyQ2FzZSgpOwogICAgICB9CiAgICB9LAogICAgewogICAgICBsZG1sOiAnVCcsCiAgICAgIGxvd2VyVG9rZW46ICd0JywKICAgICAgZ2V0OiBmdW5jdGlvbihkLCBsb2NhbGVDb2RlKSB7CiAgICAgICAgcmV0dXJuIGdldE1lcmlkaWVtVG9rZW4oZCwgbG9jYWxlQ29kZSkuY2hhckF0KDApOwogICAgICB9CiAgICB9LAogICAgewogICAgICBsZG1sOiAncyBzZWNvbmRzJywKICAgICAgc3RyZjogJ1MnLAogICAgICBzdHJmUGFkZGluZzogMiwKICAgICAgbGRtbFBhZGRlZFRva2VuOiAnc3MnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICByZXR1cm4gY2FsbERhdGVHZXQoZCwgJ1NlY29uZHMnKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ1MgbXMnLAogICAgICBzdHJmUGFkZGluZzogMywKICAgICAgbGRtbFBhZGRlZFRva2VuOiAnU1NTJywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGNhbGxEYXRlR2V0KGQsICdNaWxsaXNlY29uZHMnKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ2UnLAogICAgICBzdHJmOiAndScsCiAgICAgIG9yZGluYWxUb2tlbjogJ2VvJywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGdldFdlZWtkYXkoZCkgfHwgNzsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgc3RyZjogJ1UnLAogICAgICBzdHJmUGFkZGluZzogMiwKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgLy8gU3VuZGF5IGZpcnN0LCAwLTUzCiAgICAgICAgcmV0dXJuIGdldFdlZWtOdW1iZXIoZCwgZmFsc2UsIDApOwogICAgICB9CiAgICB9LAogICAgewogICAgICBsZG1sOiAnVycsCiAgICAgIHN0cmY6ICdWJywKICAgICAgc3RyZlBhZGRpbmc6IDIsCiAgICAgIG9yZGluYWxUb2tlbjogJ1dvJywKICAgICAgbGRtbFBhZGRlZFRva2VuOiAnV1cnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICAvLyBNb25kYXkgZmlyc3QsIDEtNTMgKElTTzg2MDEpCiAgICAgICAgcmV0dXJuIGdldFdlZWtOdW1iZXIoZCwgdHJ1ZSk7CiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICd3JywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGdldFdlZWtkYXkoZCk7CiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgIGxkbWw6ICd3JywKICAgICAgb3JkaW5hbFRva2VuOiAnd28nLAogICAgICBsZG1sUGFkZGVkVG9rZW46ICd3dycsCiAgICAgIGdldDogZnVuY3Rpb24oZCwgbG9jYWxlQ29kZSkgewogICAgICAgIC8vIExvY2FsZSBkZXBlbmRlbnQsIDEtNTMKICAgICAgICB2YXIgbG9jID0gbG9jYWxlTWFuYWdlci5nZXQobG9jYWxlQ29kZSksCiAgICAgICAgICAgIGRvdyA9IGxvYy5nZXRGaXJzdERheU9mV2Vlayhsb2NhbGVDb2RlKSwKICAgICAgICAgICAgZG95ID0gbG9jLmdldEZpcnN0RGF5T2ZXZWVrWWVhcihsb2NhbGVDb2RlKTsKICAgICAgICByZXR1cm4gZ2V0V2Vla051bWJlcihkLCB0cnVlLCBkb3csIGRveSk7CiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICdXJywKICAgICAgc3RyZlBhZGRpbmc6IDIsCiAgICAgIGdldDogZnVuY3Rpb24oZCkgewogICAgICAgIC8vIE1vbmRheSBmaXJzdCwgMC01MwogICAgICAgIHJldHVybiBnZXRXZWVrTnVtYmVyKGQsIGZhbHNlKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbFBhZGRlZFRva2VuOiAnZ2dnZycsCiAgICAgIGxkbWxUd29EaWdpdFRva2VuOiAnZ2cnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQsIGxvY2FsZUNvZGUpIHsKICAgICAgICByZXR1cm4gZ2V0V2Vla1llYXIoZCwgbG9jYWxlQ29kZSk7CiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICdHJywKICAgICAgc3RyZlBhZGRpbmc6IDQsCiAgICAgIHN0cmZUd29EaWdpdFRva2VuOiAnZycsCiAgICAgIGxkbWxQYWRkZWRUb2tlbjogJ0dHR0cnLAogICAgICBsZG1sVHdvRGlnaXRUb2tlbjogJ0dHJywKICAgICAgZ2V0OiBmdW5jdGlvbihkLCBsb2NhbGVDb2RlKSB7CiAgICAgICAgcmV0dXJuIGdldFdlZWtZZWFyKGQsIGxvY2FsZUNvZGUsIHRydWUpOwogICAgICB9CiAgICB9LAogICAgewogICAgICBsZG1sOiAneWVhcicsCiAgICAgIGxkbWxQYWRkZWRUb2tlbjogJ3l5eXknLAogICAgICBsZG1sVHdvRGlnaXRUb2tlbjogJ3l5JywKICAgICAgc3RyZjogJ1knLAogICAgICBzdHJmUGFkZGluZzogNCwKICAgICAgc3RyZlR3b0RpZ2l0VG9rZW46ICd5JywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGdldFllYXIoZCk7CiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgIGxkbWw6ICdaWicsCiAgICAgIHN0cmY6ICd6JywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGdldFVUQ09mZnNldChkKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ1gnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICByZXR1cm4gdHJ1bmMoZC5nZXRUaW1lKCkgLyAxMDAwKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ3gnLAogICAgICBnZXQ6IGZ1bmN0aW9uKGQpIHsKICAgICAgICByZXR1cm4gZC5nZXRUaW1lKCk7CiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgIGxkbWw6ICdaJywKICAgICAgZ2V0OiBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGdldFVUQ09mZnNldChkLCB0cnVlKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbGRtbDogJ3onLAogICAgICBzdHJmOiAnWicsCiAgICAgIGdldDogZnVuY3Rpb24oZCkgewogICAgICAgIC8vIE5vdGUgdGhhdCB0aGlzIGlzIG5vdCBhY2N1cmF0ZSBpbiBhbGwgYnJvd3NpbmcgZW52aXJvbm1lbnRzIQogICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnQvbW9tZW50L2lzc3Vlcy8xNjIKICAgICAgICAvLyBJdCB3aWxsIGNvbnRpbnVlIHRvIGJlIHN1cHBvcnRlZCBmb3IgTm9kZSBhbmQgdXNhZ2Ugd2l0aCB0aGUKICAgICAgICAvLyB1bmRlcnN0YW5kaW5nIHRoYXQgaXQgbWF5IGJlIGJsYW5rLgogICAgICAgIHZhciBtYXRjaCA9IGQudG9TdHJpbmcoKS5tYXRjaChUSU1FWk9ORV9BQkJSRVZJQVRJT05fUkVHKTsKICAgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXTogJyc7CiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICdEJywKICAgICAgYWxpYXM6ICclbS8lZC8leScKICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICdGJywKICAgICAgYWxpYXM6ICclWS0lbS0lZCcKICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICdyJywKICAgICAgYWxpYXM6ICclSTolTTolUyAlcCcKICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICdSJywKICAgICAgYWxpYXM6ICclSDolTScKICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICdUJywKICAgICAgYWxpYXM6ICclSDolTTolUycKICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICd4JywKICAgICAgYWxpYXM6ICd7c2hvcnR9JwogICAgfSwKICAgIHsKICAgICAgc3RyZjogJ1gnLAogICAgICBhbGlhczogJ3t0aW1lfScKICAgIH0sCiAgICB7CiAgICAgIHN0cmY6ICdjJywKICAgICAgYWxpYXM6ICd7c3RhbXB9JwogICAgfQogIF07CgogIHZhciBEYXRlVW5pdHMgPSBbCiAgICB7CiAgICAgIG5hbWU6ICdtaWxsaXNlY29uZCcsCiAgICAgIG1ldGhvZDogJ01pbGxpc2Vjb25kcycsCiAgICAgIG11bHRpcGxpZXI6IDEsCiAgICAgIHN0YXJ0OiAwLAogICAgICBlbmQ6IDk5OQogICAgfSwKICAgIHsKICAgICAgbmFtZTogJ3NlY29uZCcsCiAgICAgIG1ldGhvZDogJ1NlY29uZHMnLAogICAgICBtdWx0aXBsaWVyOiAxMDAwLAogICAgICBzdGFydDogMCwKICAgICAgZW5kOiA1OQogICAgfSwKICAgIHsKICAgICAgbmFtZTogJ21pbnV0ZScsCiAgICAgIG1ldGhvZDogJ01pbnV0ZXMnLAogICAgICBtdWx0aXBsaWVyOiA2MCAqIDEwMDAsCiAgICAgIHN0YXJ0OiAwLAogICAgICBlbmQ6IDU5CiAgICB9LAogICAgewogICAgICBuYW1lOiAnaG91cicsCiAgICAgIG1ldGhvZDogJ0hvdXJzJywKICAgICAgbXVsdGlwbGllcjogNjAgKiA2MCAqIDEwMDAsCiAgICAgIHN0YXJ0OiAwLAogICAgICBlbmQ6IDIzCiAgICB9LAogICAgewogICAgICBuYW1lOiAnZGF5JywKICAgICAgYWxpYXM6ICdkYXRlJywKICAgICAgbWV0aG9kOiAnRGF0ZScsCiAgICAgIGFtYmlndW91czogdHJ1ZSwKICAgICAgbXVsdGlwbGllcjogMjQgKiA2MCAqIDYwICogMTAwMCwKICAgICAgc3RhcnQ6IDEsCiAgICAgIGVuZDogZnVuY3Rpb24oZCkgewogICAgICAgIHJldHVybiBnZXREYXlzSW5Nb250aChkKTsKICAgICAgfQogICAgfSwKICAgIHsKICAgICAgbmFtZTogJ3dlZWsnLAogICAgICBtZXRob2Q6ICdJU09XZWVrJywKICAgICAgYW1iaWd1b3VzOiB0cnVlLAogICAgICBtdWx0aXBsaWVyOiA3ICogMjQgKiA2MCAqIDYwICogMTAwMAogICAgfSwKICAgIHsKICAgICAgbmFtZTogJ21vbnRoJywKICAgICAgbWV0aG9kOiAnTW9udGgnLAogICAgICBhbWJpZ3VvdXM6IHRydWUsCiAgICAgIG11bHRpcGxpZXI6IDMwLjQzNzUgKiAyNCAqIDYwICogNjAgKiAxMDAwLAogICAgICBzdGFydDogMCwKICAgICAgZW5kOiAxMQogICAgfSwKICAgIHsKICAgICAgbmFtZTogJ3llYXInLAogICAgICBtZXRob2Q6ICdGdWxsWWVhcicsCiAgICAgIGFtYmlndW91czogdHJ1ZSwKICAgICAgbXVsdGlwbGllcjogMzY1LjI1ICogMjQgKiA2MCAqIDYwICogMTAwMCwKICAgICAgc3RhcnQ6IDAKICAgIH0KICBdOwoKICAvKioqCiAgICogQG1ldGhvZCBnZXRPcHRpb24obmFtZSkKICAgKiBAcmV0dXJucyBNaXhlZAogICAqIEBhY2Nlc3NvcgogICAqIEBzaG9ydCBHZXRzIGFuIG9wdGlvbiB1c2VkIGludGVyYWxseSBieSBEYXRlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgIFN1Z2FyLkRhdGUuZ2V0T3B0aW9uKCduZXdEYXRlSW50ZXJuYWwnKTsKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICoKICAgKioqCiAgICogQG1ldGhvZCBzZXRPcHRpb24obmFtZSwgdmFsdWUpCiAgICogQGFjY2Vzc29yCiAgICogQHNob3J0IFNldHMgYW4gb3B0aW9uIHVzZWQgaW50ZXJhbGx5IGJ5IERhdGUuCiAgICogQGV4dHJhIElmIGB2YWx1ZWAgaXMgYG51bGxgLCB0aGUgZGVmYXVsdCB2YWx1ZSB3aWxsIGJlIHJlc3RvcmVkLgogICAqIEBvcHRpb25zCiAgICoKICAgKiAgIG5ld0RhdGVJbnRlcm5hbCAgIFN1Z2FyJ3MgaW50ZXJuYWwgZGF0ZSBjb25zdHJ1Y3Rvci4gRGF0ZSBtZXRob2RzIG9mdGVuCiAgICogICAgICAgICAgICAgICAgICAgICBjb25zdHJ1Y3QgYSBgbmV3IERhdGUoKWAgaW50ZXJuYWxseSBhcyBhIHJlZmVyZW5jZSBwb2ludAogICAqICAgICAgICAgICAgICAgICAgICAgKGBpc1RvZGF5YCwgcmVsYXRpdmUgZm9ybWF0cyBsaWtlIGB0b21vcnJvd2AsIGV0YykuIFRoaXMKICAgKiAgICAgICAgICAgICAgICAgICAgIGNhbiBiZSBvdmVycmlkZGVuIGlmIHlvdSBuZWVkIGl0IHRvIGJlIHNvbWV0aGluZyBlbHNlLgogICAqICAgICAgICAgICAgICAgICAgICAgTW9zdCBjb21tb25seSwgdGhpcyBhbGxvd3MgeW91IHRvIHJldHVybiBhIHNoaWZ0ZWQgZGF0ZQogICAqICAgICAgICAgICAgICAgICAgICAgdG8gc2ltdWxhdGUgYSBzcGVjaWZpYyB0aW1lem9uZSwgYXMgZGF0ZXMgaW4gSmF2YXNjcmlwdAogICAqICAgICAgICAgICAgICAgICAgICAgYXJlIGFsd2F5cyBsb2NhbC4KICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgIFN1Z2FyLkRhdGUuc2V0T3B0aW9uKCduZXdEYXRlSW50ZXJuYWwnLCBmdW5jdGlvbigpIHsKICAgKiAgICAgdmFyIGQgPSBuZXcgRGF0ZSgpLCBvZmZzZXQ7CiAgICogICAgIG9mZnNldCA9IChkLmdldFRpbWV6b25lT2Zmc2V0KCkgLSA2MDApICogNjAgKiAxMDAwOyAvLyBIYXdhaWkgdGltZSEKICAgKiAgICAgZC5zZXRUaW1lKGQuZ2V0VGltZSgpICsgb2Zmc2V0KTsKICAgKiAgICAgcmV0dXJuIGQ7CiAgICogICB9KTsKICAgKgogICAqIEBzaWduYXR1cmUgc2V0T3B0aW9uKG9wdGlvbnMpCiAgICogQHBhcmFtIHtEYXRlT3B0aW9uc30gb3B0aW9ucwogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICogQHBhcmFtIHthbnl9IHZhbHVlCiAgICogQG9wdGlvbiB7RnVuY3Rpb259IG5ld0RhdGVJbnRlcm5hbAogICAqCiAgICoqKi8KICB2YXIgX2RhdGVPcHRpb25zID0gZGVmaW5lT3B0aW9uc0FjY2Vzc29yKHN1Z2FyRGF0ZSwgREFURV9PUFRJT05TKTsKCiAgZnVuY3Rpb24gc2V0RGF0ZUNoYWluYWJsZUNvbnN0cnVjdG9yKCkgewogICAgc2V0Q2hhaW5hYmxlQ29uc3RydWN0b3Ioc3VnYXJEYXRlLCBjcmVhdGVEYXRlKTsKICB9CgogIC8vIEdlbmVyYWwgaGVscGVycwoKICBmdW5jdGlvbiBnZXROZXdEYXRlKCkgewogICAgcmV0dXJuIF9kYXRlT3B0aW9ucygnbmV3RGF0ZUludGVybmFsJykoKTsKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHROZXdEYXRlKCkgewogICAgcmV0dXJuIG5ldyBEYXRlOwogIH0KCiAgZnVuY3Rpb24gY2xvbmVEYXRlKGQpIHsKICAgIC8vIFJoaW5vIGVudmlyb25tZW50cyBoYXZlIGEgYnVnIHdoZXJlIG5ldyBEYXRlKGQpIHRydW5jYXRlcwogICAgLy8gbWlsbGlzZWNvbmRzIHNvIG5lZWQgdG8gY2FsbCBnZXRUaW1lKCkgaGVyZS4KICAgIHZhciBjbG9uZSA9IG5ldyBEYXRlKGQuZ2V0VGltZSgpKTsKICAgIF91dGMoY2xvbmUsICEhX3V0YyhkKSk7CiAgICByZXR1cm4gY2xvbmU7CiAgfQoKICBmdW5jdGlvbiBkYXRlSXNWYWxpZChkKSB7CiAgICByZXR1cm4gIWlzTmFOKGQuZ2V0VGltZSgpKTsKICB9CgogIGZ1bmN0aW9uIGFzc2VydERhdGVJc1ZhbGlkKGQpIHsKICAgIGlmICghZGF0ZUlzVmFsaWQoZCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRGF0ZSBpcyBub3QgdmFsaWQnKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldEhvdXJzKGQpIHsKICAgIHJldHVybiBjYWxsRGF0ZUdldChkLCAnSG91cnMnKTsKICB9CgogIGZ1bmN0aW9uIGdldFdlZWtkYXkoZCkgewogICAgcmV0dXJuIGNhbGxEYXRlR2V0KGQsICdEYXknKTsKICB9CgogIGZ1bmN0aW9uIGdldERhdGUoZCkgewogICAgcmV0dXJuIGNhbGxEYXRlR2V0KGQsICdEYXRlJyk7CiAgfQoKICBmdW5jdGlvbiBnZXRNb250aChkKSB7CiAgICByZXR1cm4gY2FsbERhdGVHZXQoZCwgJ01vbnRoJyk7CiAgfQoKICBmdW5jdGlvbiBnZXRZZWFyKGQpIHsKICAgIHJldHVybiBjYWxsRGF0ZUdldChkLCAnRnVsbFllYXInKTsKICB9CgogIGZ1bmN0aW9uIHNldERhdGUoZCwgdmFsKSB7CiAgICBjYWxsRGF0ZVNldChkLCAnRGF0ZScsIHZhbCk7CiAgfQoKICBmdW5jdGlvbiBzZXRNb250aChkLCB2YWwpIHsKICAgIGNhbGxEYXRlU2V0KGQsICdNb250aCcsIHZhbCk7CiAgfQoKICBmdW5jdGlvbiBzZXRZZWFyKGQsIHZhbCkgewogICAgY2FsbERhdGVTZXQoZCwgJ0Z1bGxZZWFyJywgdmFsKTsKICB9CgogIGZ1bmN0aW9uIGdldERheXNJbk1vbnRoKGQpIHsKICAgIHJldHVybiAzMiAtIGNhbGxEYXRlR2V0KG5ldyBEYXRlKGdldFllYXIoZCksIGdldE1vbnRoKGQpLCAzMiksICdEYXRlJyk7CiAgfQoKICBmdW5jdGlvbiBzZXRXZWVrZGF5KGQsIGRvdywgZGlyKSB7CiAgICBpZiAoIWlzTnVtYmVyKGRvdykpIHJldHVybjsKICAgIHZhciBjdXJyZW50V2Vla2RheSA9IGdldFdlZWtkYXkoZCk7CiAgICBpZiAoZGlyKSB7CiAgICAgIC8vIEFsbG93IGEgImRpcmVjdGlvbiIgcGFyYW1ldGVyIHRvIGRldGVybWluZSB3aGV0aGVyIGEgd2Vla2RheSBjYW4KICAgICAgLy8gYmUgc2V0IGJleW9uZCB0aGUgY3VycmVudCB3ZWVrZGF5IGluIGVpdGhlciBkaXJlY3Rpb24uCiAgICAgIHZhciBuZGlyID0gZGlyID4gMCA/IDEgOiAtMTsKICAgICAgdmFyIG9mZnNldCA9IGRvdyAlIDcgLSBjdXJyZW50V2Vla2RheTsKICAgICAgaWYgKG9mZnNldCAmJiBvZmZzZXQgLyBhYnMob2Zmc2V0KSAhPT0gbmRpcikgewogICAgICAgIGRvdyArPSA3ICogbmRpcjsKICAgICAgfQogICAgfQogICAgc2V0RGF0ZShkLCBnZXREYXRlKGQpICsgZG93IC0gY3VycmVudFdlZWtkYXkpOwogICAgcmV0dXJuIGQuZ2V0VGltZSgpOwogIH0KCiAgLy8gTm9ybWFsIGNhbGxEYXRlU2V0IG1ldGhvZCB3aXRoIGFiaWxpdHkKICAvLyB0byBoYW5kbGUgSVNPV2VlayBzZXR0aW5nIGFzIHdlbGwuCiAgZnVuY3Rpb24gY2FsbERhdGVTZXRXaXRoV2VlayhkLCBtZXRob2QsIHZhbHVlLCBzYWZlKSB7CiAgICBpZiAobWV0aG9kID09PSAnSVNPV2VlaycpIHsKICAgICAgc2V0SVNPV2Vla051bWJlcihkLCB2YWx1ZSk7CiAgICB9IGVsc2UgewogICAgICBjYWxsRGF0ZVNldChkLCBtZXRob2QsIHZhbHVlLCBzYWZlKTsKICAgIH0KICB9CgogIC8vIFVUQyBoZWxwZXJzCgogIGZ1bmN0aW9uIGlzVVRDKGQpIHsKICAgIHJldHVybiAhIV91dGMoZCkgfHwgdHpPZmZzZXQoZCkgPT09IDA7CiAgfQoKICBmdW5jdGlvbiBnZXRVVENPZmZzZXQoZCwgaXNvKSB7CiAgICB2YXIgb2Zmc2V0ID0gX3V0YyhkKSA/IDAgOiB0ek9mZnNldChkKSwgaG91cnMsIG1pbnMsIGNvbG9uOwogICAgY29sb24gID0gaXNvID09PSB0cnVlID8gJzonIDogJyc7CiAgICBpZiAoIW9mZnNldCAmJiBpc28pIHJldHVybiAnWic7CiAgICBob3VycyA9IHBhZE51bWJlcih0cnVuYygtb2Zmc2V0IC8gNjApLCAyLCB0cnVlKTsKICAgIG1pbnMgPSBwYWROdW1iZXIoYWJzKG9mZnNldCAlIDYwKSwgMik7CiAgICByZXR1cm4gIGhvdXJzICsgY29sb24gKyBtaW5zOwogIH0KCiAgZnVuY3Rpb24gdHpPZmZzZXQoZCkgewogICAgcmV0dXJuIGQuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICB9CgogIC8vIEFyZ3VtZW50IGhlbHBlcnMKCiAgZnVuY3Rpb24gY29sbGVjdERhdGVBcmd1bWVudHMoYXJncywgYWxsb3dEdXJhdGlvbikgewogICAgdmFyIGFyZzEgPSBhcmdzWzBdLCBhcmcyID0gYXJnc1sxXTsKICAgIGlmIChhbGxvd0R1cmF0aW9uICYmIGlzU3RyaW5nKGFyZzEpKSB7CiAgICAgIGFyZzEgPSBnZXREYXRlUGFyYW1zRnJvbVN0cmluZyhhcmcxKTsKICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIoYXJnMSkgJiYgaXNOdW1iZXIoYXJnMikpIHsKICAgICAgYXJnMSA9IGNvbGxlY3REYXRlUGFyYW1zRnJvbUFyZ3VtZW50cyhhcmdzKTsKICAgICAgYXJnMiA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBpZiAoaXNPYmplY3RUeXBlKGFyZzEpKSB7CiAgICAgICAgYXJnMSA9IHNpbXBsZUNsb25lKGFyZzEpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gW2FyZzEsIGFyZzJdOwogIH0KCiAgZnVuY3Rpb24gY29sbGVjdERhdGVQYXJhbXNGcm9tQXJndW1lbnRzKGFyZ3MpIHsKICAgIHZhciBwYXJhbXMgPSB7fSwgaW5kZXggPSAwOwogICAgd2Fsa1VuaXREb3duKFlFQVJfSU5ERVgsIGZ1bmN0aW9uKHVuaXQpIHsKICAgICAgdmFyIGFyZyA9IGFyZ3NbaW5kZXgrK107CiAgICAgIGlmIChpc0RlZmluZWQoYXJnKSkgewogICAgICAgIHBhcmFtc1t1bml0Lm5hbWVdID0gYXJnOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBwYXJhbXM7CiAgfQoKICBmdW5jdGlvbiBnZXREYXRlUGFyYW1zRnJvbVN0cmluZyhzdHIpIHsKICAgIHZhciBtYXRjaCwgbnVtLCBwYXJhbXMgPSB7fTsKICAgIG1hdGNoID0gc3RyLm1hdGNoKC9eKC0/XGQqW1xkLl1cZCopP1xzPyhcdys/KXM/JC9pKTsKICAgIGlmIChtYXRjaCkgewogICAgICBpZiAoaXNVbmRlZmluZWQobnVtKSkgewogICAgICAgIG51bSA9ICttYXRjaFsxXTsKICAgICAgICBpZiAoaXNOYU4obnVtKSkgewogICAgICAgICAgbnVtID0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcGFyYW1zW21hdGNoWzJdLnRvTG93ZXJDYXNlKCldID0gbnVtOwogICAgfQogICAgcmV0dXJuIHBhcmFtczsKICB9CgogIC8vIEl0ZXJhdGlvbiBoZWxwZXJzCgogIC8vIFllYXJzIC0+IE1pbGxpc2Vjb25kcwogIGZ1bmN0aW9uIGl0ZXJhdGVPdmVyRGF0ZVVuaXRzKGZuLCBzdGFydEluZGV4LCBlbmRJbmRleCkgewogICAgZW5kSW5kZXggPSBlbmRJbmRleCB8fCAwOwogICAgaWYgKGlzVW5kZWZpbmVkKHN0YXJ0SW5kZXgpKSB7CiAgICAgIHN0YXJ0SW5kZXggPSBZRUFSX0lOREVYOwogICAgfQogICAgZm9yICh2YXIgaW5kZXggPSBzdGFydEluZGV4OyBpbmRleCA+PSBlbmRJbmRleDsgaW5kZXgtLSkgewogICAgICBpZiAoZm4oRGF0ZVVuaXRzW2luZGV4XSwgaW5kZXgpID09PSBmYWxzZSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBZZWFycyAtPiBNaWxsaXNlY29uZHMgdXNpbmcgZ2V0TG93ZXIvSGlnaGVyIG1ldGhvZHMKICBmdW5jdGlvbiB3YWxrVW5pdERvd24odW5pdEluZGV4LCBmbikgewogICAgd2hpbGUgKHVuaXRJbmRleCA+PSAwKSB7CiAgICAgIGlmIChmbihEYXRlVW5pdHNbdW5pdEluZGV4XSwgdW5pdEluZGV4KSA9PT0gZmFsc2UpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICB1bml0SW5kZXggPSBnZXRMb3dlclVuaXRJbmRleCh1bml0SW5kZXgpOwogICAgfQogIH0KCiAgLy8gTW92aW5nIGxvd2VyIGZyb20gc3BlY2lmaWMgdW5pdAogIGZ1bmN0aW9uIGdldExvd2VyVW5pdEluZGV4KGluZGV4KSB7CiAgICBpZiAoaW5kZXggPT09IE1PTlRIX0lOREVYKSB7CiAgICAgIHJldHVybiBEQVlfSU5ERVg7CiAgICB9IGVsc2UgaWYgKGluZGV4ID09PSBXRUVLX0lOREVYKSB7CiAgICAgIHJldHVybiBIT1VSU19JTkRFWDsKICAgIH0KICAgIHJldHVybiBpbmRleCAtIDE7CiAgfQoKICAvLyBNb3ZpbmcgaGlnaGVyIGZyb20gc3BlY2lmaWMgdW5pdAogIGZ1bmN0aW9uIGdldEhpZ2hlclVuaXRJbmRleChpbmRleCkgewogICAgcmV0dXJuIGluZGV4ID09PSBEQVlfSU5ERVggPyBNT05USF9JTkRFWCA6IGluZGV4ICsgMTsKICB9CgogIC8vIFllYXJzIC0+IE1pbGxpc2Vjb25kcyBjaGVja2luZyBhbGwgZGF0ZSBwYXJhbXMgaW5jbHVkaW5nICJ3ZWVrZGF5IgogIGZ1bmN0aW9uIGl0ZXJhdGVPdmVyRGF0ZVBhcmFtcyhwYXJhbXMsIGZuLCBzdGFydEluZGV4LCBlbmRJbmRleCkgewoKICAgIGZ1bmN0aW9uIHJ1bihuYW1lLCB1bml0LCBpKSB7CiAgICAgIHZhciB2YWwgPSBnZXREYXRlUGFyYW0ocGFyYW1zLCBuYW1lKTsKICAgICAgaWYgKGlzRGVmaW5lZCh2YWwpKSB7CiAgICAgICAgZm4obmFtZSwgdmFsLCB1bml0LCBpKTsKICAgICAgfQogICAgfQoKICAgIGl0ZXJhdGVPdmVyRGF0ZVVuaXRzKGZ1bmN0aW9uICh1bml0LCBpKSB7CiAgICAgIHZhciByZXN1bHQgPSBydW4odW5pdC5uYW1lLCB1bml0LCBpKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gZmFsc2UgJiYgaSA9PT0gREFZX0lOREVYKSB7CiAgICAgICAgLy8gQ2hlY2sgZm9yICJ3ZWVrZGF5Iiwgd2hpY2ggaGFzIGEgZGlzdGluY3QgbWVhbmluZwogICAgICAgIC8vIGluIHRoZSBjb250ZXh0IG9mIHNldHRpbmcgYSBkYXRlLCBidXQgaGFzIHRoZSBzYW1lCiAgICAgICAgLy8gbWVhbmluZyBhcyAiZGF5IiBhcyBhIHVuaXQgb2YgdGltZS4KICAgICAgICByZXN1bHQgPSBydW4oJ3dlZWtkYXknLCB1bml0LCBpKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwgc3RhcnRJbmRleCwgZW5kSW5kZXgpOwoKICB9CgogIC8vIFllYXJzIC0+IERheXMKICBmdW5jdGlvbiBpdGVyYXRlT3ZlckhpZ2hlckRhdGVQYXJhbXMocGFyYW1zLCBmbikgewogICAgaXRlcmF0ZU92ZXJEYXRlUGFyYW1zKHBhcmFtcywgZm4sIFlFQVJfSU5ERVgsIERBWV9JTkRFWCk7CiAgfQoKICAvLyBBZHZhbmNpbmcgaGVscGVycwoKICBmdW5jdGlvbiBhZHZhbmNlRGF0ZShkLCB1bml0LCBudW0sIHJlc2V0KSB7CiAgICB2YXIgc2V0ID0ge307CiAgICBzZXRbdW5pdF0gPSBudW07CiAgICByZXR1cm4gdXBkYXRlRGF0ZShkLCBzZXQsIHJlc2V0LCAxKTsKICB9CgogIGZ1bmN0aW9uIGFkdmFuY2VEYXRlV2l0aEFyZ3MoZCwgYXJncywgZGlyKSB7CiAgICBhcmdzID0gY29sbGVjdERhdGVBcmd1bWVudHMoYXJncywgdHJ1ZSk7CiAgICByZXR1cm4gdXBkYXRlRGF0ZShkLCBhcmdzWzBdLCBhcmdzWzFdLCBkaXIpOwogIH0KCiAgLy8gRWRnZSBoZWxwZXJzCgogIGZ1bmN0aW9uIHJlc2V0VGltZShkKSB7CiAgICByZXR1cm4gc2V0VW5pdEFuZExvd2VyVG9FZGdlKGQsIEhPVVJTX0lOREVYKTsKICB9CgogIGZ1bmN0aW9uIHJlc2V0TG93ZXJVbml0cyhkLCB1bml0SW5kZXgpIHsKICAgIHJldHVybiBzZXRVbml0QW5kTG93ZXJUb0VkZ2UoZCwgZ2V0TG93ZXJVbml0SW5kZXgodW5pdEluZGV4KSk7CiAgfQoKICBmdW5jdGlvbiBtb3ZlVG9CZWdpbm5pbmdPZldlZWsoZCwgZmlyc3REYXlPZldlZWspIHsKICAgIHNldFdlZWtkYXkoZCwgZmxvb3IoKGdldFdlZWtkYXkoZCkgLSBmaXJzdERheU9mV2VlaykgLyA3KSAqIDcgKyBmaXJzdERheU9mV2Vlayk7CiAgICByZXR1cm4gZDsKICB9CgogIGZ1bmN0aW9uIG1vdmVUb0VuZE9mV2VlayhkLCBmaXJzdERheU9mV2VlaykgewogICAgdmFyIHRhcmdldCA9IGZpcnN0RGF5T2ZXZWVrIC0gMTsKICAgIHNldFdlZWtkYXkoZCwgY2VpbCgoZ2V0V2Vla2RheShkKSAtIHRhcmdldCkgLyA3KSAqIDcgKyB0YXJnZXQpOwogICAgcmV0dXJuIGQ7CiAgfQoKICBmdW5jdGlvbiBtb3ZlVG9CZWdpbm5pbmdPZlVuaXQoZCwgdW5pdEluZGV4LCBsb2NhbGVDb2RlKSB7CiAgICBpZiAodW5pdEluZGV4ID09PSBXRUVLX0lOREVYKSB7CiAgICAgIG1vdmVUb0JlZ2lubmluZ09mV2VlayhkLCBsb2NhbGVNYW5hZ2VyLmdldChsb2NhbGVDb2RlKS5nZXRGaXJzdERheU9mV2VlaygpKTsKICAgIH0KICAgIHJldHVybiBzZXRVbml0QW5kTG93ZXJUb0VkZ2UoZCwgZ2V0TG93ZXJVbml0SW5kZXgodW5pdEluZGV4KSk7CiAgfQoKICBmdW5jdGlvbiBtb3ZlVG9FbmRPZlVuaXQoZCwgdW5pdEluZGV4LCBsb2NhbGVDb2RlLCBzdG9wSW5kZXgpIHsKICAgIGlmICh1bml0SW5kZXggPT09IFdFRUtfSU5ERVgpIHsKICAgICAgbW92ZVRvRW5kT2ZXZWVrKGQsIGxvY2FsZU1hbmFnZXIuZ2V0KGxvY2FsZUNvZGUpLmdldEZpcnN0RGF5T2ZXZWVrKCkpOwogICAgfQogICAgcmV0dXJuIHNldFVuaXRBbmRMb3dlclRvRWRnZShkLCBnZXRMb3dlclVuaXRJbmRleCh1bml0SW5kZXgpLCBzdG9wSW5kZXgsIHRydWUpOwogIH0KCiAgZnVuY3Rpb24gc2V0VW5pdEFuZExvd2VyVG9FZGdlKGQsIHN0YXJ0SW5kZXgsIHN0b3BJbmRleCwgZW5kKSB7CiAgICB3YWxrVW5pdERvd24oc3RhcnRJbmRleCwgZnVuY3Rpb24odW5pdCwgaSkgewogICAgICB2YXIgdmFsID0gZW5kID8gdW5pdC5lbmQgOiB1bml0LnN0YXJ0OwogICAgICBpZiAoaXNGdW5jdGlvbih2YWwpKSB7CiAgICAgICAgdmFsID0gdmFsKGQpOwogICAgICB9CiAgICAgIGNhbGxEYXRlU2V0KGQsIHVuaXQubWV0aG9kLCB2YWwpOwogICAgICByZXR1cm4gIWlzRGVmaW5lZChzdG9wSW5kZXgpIHx8IGkgPiBzdG9wSW5kZXg7CiAgICB9KTsKICAgIHJldHVybiBkOwogIH0KCiAgLy8gUGFyYW0gaGVscGVycwoKICBmdW5jdGlvbiBnZXREYXRlUGFyYW1LZXkocGFyYW1zLCBrZXkpIHsKICAgIHJldHVybiBnZXRPd25LZXkocGFyYW1zLCBrZXkpIHx8CiAgICAgICAgICAgZ2V0T3duS2V5KHBhcmFtcywga2V5ICsgJ3MnKSB8fAogICAgICAgICAgIChrZXkgPT09ICdkYXknICYmIGdldE93bktleShwYXJhbXMsICdkYXRlJykpOwogIH0KCiAgZnVuY3Rpb24gZ2V0RGF0ZVBhcmFtKHBhcmFtcywga2V5KSB7CiAgICByZXR1cm4gZ2V0T3duKHBhcmFtcywgZ2V0RGF0ZVBhcmFtS2V5KHBhcmFtcywga2V5KSk7CiAgfQoKICBmdW5jdGlvbiBkZWxldGVEYXRlUGFyYW0ocGFyYW1zLCBrZXkpIHsKICAgIGRlbGV0ZSBwYXJhbXNbZ2V0RGF0ZVBhcmFtS2V5KHBhcmFtcywga2V5KV07CiAgfQoKICBmdW5jdGlvbiBnZXRVbml0SW5kZXhGb3JQYXJhbU5hbWUobmFtZSkgewogICAgdmFyIHBhcmFtcyA9IHt9LCB1bml0SW5kZXg7CiAgICBwYXJhbXNbbmFtZV0gPSAxOwogICAgaXRlcmF0ZU92ZXJEYXRlUGFyYW1zKHBhcmFtcywgZnVuY3Rpb24obmFtZSwgdmFsLCB1bml0LCBpKSB7CiAgICAgIHVuaXRJbmRleCA9IGk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwogICAgcmV0dXJuIHVuaXRJbmRleDsKICB9CgogIC8vIFRpbWUgZGlzdGFuY2UgaGVscGVycwoKICBmdW5jdGlvbiBnZXREYXlzU2luY2UoZDEsIGQyKSB7CiAgICByZXR1cm4gZ2V0VGltZURpc3RhbmNlRm9yVW5pdChkMSwgZDIsIERhdGVVbml0c1tEQVlfSU5ERVhdKTsKICB9CgogIGZ1bmN0aW9uIGdldFRpbWVEaXN0YW5jZUZvclVuaXQoZDEsIGQyLCB1bml0KSB7CiAgICB2YXIgZndkID0gZDIgPiBkMSwgbnVtLCB0bXA7CiAgICBpZiAoIWZ3ZCkgewogICAgICB0bXAgPSBkMjsKICAgICAgZDIgID0gZDE7CiAgICAgIGQxICA9IHRtcDsKICAgIH0KICAgIG51bSA9IGQyIC0gZDE7CiAgICBpZiAodW5pdC5tdWx0aXBsaWVyID4gMSkgewogICAgICBudW0gPSB0cnVuYyhudW0gLyB1bml0Lm11bHRpcGxpZXIpOwogICAgfQogICAgLy8gRm9yIGhpZ2hlciBvcmRlciB3aXRoIHBvdGVudGlhbCBhbWJpZ3VpdHksIHVzZSB0aGUgbnVtZXJpYyBjYWxjdWxhdGlvbgogICAgLy8gYXMgYSBzdGFydGluZyBwb2ludCwgdGhlbiBpdGVyYXRlIHVudGlsIHdlIHBhc3MgdGhlIHRhcmdldCBkYXRlLgogICAgaWYgKHVuaXQuYW1iaWd1b3VzKSB7CiAgICAgIGQxID0gY2xvbmVEYXRlKGQxKTsKICAgICAgaWYgKG51bSkgewogICAgICAgIGFkdmFuY2VEYXRlKGQxLCB1bml0Lm5hbWUsIG51bSk7CiAgICAgIH0KICAgICAgd2hpbGUgKGQxIDwgZDIpIHsKICAgICAgICBhZHZhbmNlRGF0ZShkMSwgdW5pdC5uYW1lLCAxKTsKICAgICAgICBpZiAoZDEgPiBkMikgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIG51bSArPSAxOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZndkID8gLW51bSA6IG51bTsKICB9CgogIC8vIFBhcnNpbmcgaGVscGVycwoKICBmdW5jdGlvbiBnZXRQYXJzaW5nVG9rZW5WYWx1ZSh0b2tlbiwgc3RyKSB7CiAgICB2YXIgdmFsOwogICAgaWYgKHRva2VuLnZhbCkgewogICAgICB2YWwgPSB0b2tlbi52YWw7CiAgICB9IGVsc2UgaWYgKHRva2VuLnNpZ24pIHsKICAgICAgdmFsID0gc3RyID09PSAnKycgPyAxIDogLTE7CiAgICB9IGVsc2UgaWYgKHRva2VuLmJvb2wpIHsKICAgICAgdmFsID0gISF2YWw7CiAgICB9IGVsc2UgewogICAgICB2YWwgPSArc3RyLnJlcGxhY2UoLywvLCAnLicpOwogICAgfQogICAgaWYgKHRva2VuLnBhcmFtID09PSAnbW9udGgnKSB7CiAgICAgIHZhbCAtPSAxOwogICAgfQogICAgcmV0dXJuIHZhbDsKICB9CgogIGZ1bmN0aW9uIGdldFllYXJGcm9tQWJicmV2aWF0aW9uKHN0ciwgZCwgcHJlZmVyKSB7CiAgICAvLyBGb2xsb3dpbmcgSUVURiBoZXJlLCBhZGRpbmcgMTkwMCBvciAyMDAwIGRlcGVuZGluZyBvbiB0aGUgbGFzdCB0d28gZGlnaXRzLgogICAgLy8gTm90ZSB0aGF0IHRoaXMgbWFrZXMgbm8gYWNjb3JkYW5jZSBmb3Igd2hhdCBzaG91bGQgaGFwcGVuIGFmdGVyIDIwNTAsIGJ1dAogICAgLy8gaW50ZW50aW9uYWxseSBpZ25vcmluZyB0aGlzIGZvciBub3cuIGh0dHBzOi8vd3d3LmlldGYub3JnL3JmYy9yZmMyODIyLnR4dAogICAgdmFyIHZhbCA9ICtzdHIsIGRlbHRhOwogICAgdmFsICs9IHZhbCA8IDUwID8gMjAwMCA6IDE5MDA7CiAgICBpZiAocHJlZmVyKSB7CiAgICAgIGRlbHRhID0gdmFsIC0gZ2V0WWVhcihkKTsKICAgICAgaWYgKGRlbHRhIC8gYWJzKGRlbHRhKSAhPT0gcHJlZmVyKSB7CiAgICAgICAgdmFsICs9IHByZWZlciAqIDEwMDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHZhbDsKICB9CgogIC8vIFdlZWsgbnVtYmVyIGhlbHBlcnMKCiAgZnVuY3Rpb24gc2V0SVNPV2Vla051bWJlcihkLCBudW0pIHsKICAgIGlmIChpc051bWJlcihudW0pKSB7CiAgICAgIC8vIEludGVudGlvbmFsbHkgYXZvaWRpbmcgdXBkYXRlRGF0ZSBoZXJlIHRvIHByZXZlbnQgY2lyY3VsYXIgZGVwZW5kZW5jaWVzLgogICAgICB2YXIgaXNvV2VlayA9IGNsb25lRGF0ZShkKSwgZG93ID0gZ2V0V2Vla2RheShkKTsKICAgICAgbW92ZVRvRmlyc3REYXlPZldlZWtZZWFyKGlzb1dlZWssIElTT19GSVJTVF9EQVlfT0ZfV0VFSywgSVNPX0ZJUlNUX0RBWV9PRl9XRUVLX1lFQVIpOwogICAgICBzZXREYXRlKGlzb1dlZWssIGdldERhdGUoaXNvV2VlaykgKyA3ICogKG51bSAtIDEpKTsKICAgICAgc2V0WWVhcihkLCBnZXRZZWFyKGlzb1dlZWspKTsKICAgICAgc2V0TW9udGgoZCwgZ2V0TW9udGgoaXNvV2VlaykpOwogICAgICBzZXREYXRlKGQsIGdldERhdGUoaXNvV2VlaykpOwogICAgICBzZXRXZWVrZGF5KGQsIGRvdyB8fCA3KTsKICAgIH0KICAgIHJldHVybiBkLmdldFRpbWUoKTsKICB9CgogIGZ1bmN0aW9uIGdldFdlZWtOdW1iZXIoZCwgYWxsb3dQcmV2aW91cywgZmlyc3REYXlPZldlZWssIGZpcnN0RGF5T2ZXZWVrWWVhcikgewogICAgdmFyIGlzb1dlZWssIG4gPSAwOwogICAgaWYgKGlzVW5kZWZpbmVkKGZpcnN0RGF5T2ZXZWVrKSkgewogICAgICBmaXJzdERheU9mV2VlayA9IElTT19GSVJTVF9EQVlfT0ZfV0VFSzsKICAgIH0KICAgIGlmIChpc1VuZGVmaW5lZChmaXJzdERheU9mV2Vla1llYXIpKSB7CiAgICAgIGZpcnN0RGF5T2ZXZWVrWWVhciA9IElTT19GSVJTVF9EQVlfT0ZfV0VFS19ZRUFSOwogICAgfQogICAgLy8gTW92aW5nIHRvIHRoZSBlbmQgb2YgdGhlIHdlZWsgYWxsb3dzIGZvciBmb3J3YXJkIHllYXIgdHJhdmVyc2FsLCBpZQogICAgLy8gRGVjIDI5IDIwMTQgaXMgYWN0dWFsbHkgd2VlayAwMSBvZiAyMDE1LgogICAgaXNvV2VlayA9IG1vdmVUb0VuZE9mV2VlayhjbG9uZURhdGUoZCksIGZpcnN0RGF5T2ZXZWVrKTsKICAgIG1vdmVUb0ZpcnN0RGF5T2ZXZWVrWWVhcihpc29XZWVrLCBmaXJzdERheU9mV2VlaywgZmlyc3REYXlPZldlZWtZZWFyKTsKICAgIGlmIChhbGxvd1ByZXZpb3VzICYmIGQgPCBpc29XZWVrKSB7CiAgICAgIC8vIElmIHRoZSBkYXRlIGlzIHN0aWxsIGJlZm9yZSB0aGUgc3RhcnQgb2YgdGhlIHllYXIsIHRoZW4gaXQgc2hvdWxkIGJlCiAgICAgIC8vIHRoZSBsYXN0IHdlZWsgb2YgdGhlIHByZXZpb3VzIHllYXIsIGllIEphbiAxIDIwMTYgaXMgYWN0dWFsbHkgd2VlayA1MwogICAgICAvLyBvZiAyMDE1LCBzbyBtb3ZlIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHdlZWsgdG8gdHJhdmVyc2UgdGhlIHllYXIuCiAgICAgIGlzb1dlZWsgPSBtb3ZlVG9CZWdpbm5pbmdPZldlZWsoY2xvbmVEYXRlKGQpLCBmaXJzdERheU9mV2Vlayk7CiAgICAgIG1vdmVUb0ZpcnN0RGF5T2ZXZWVrWWVhcihpc29XZWVrLCBmaXJzdERheU9mV2VlaywgZmlyc3REYXlPZldlZWtZZWFyKTsKICAgIH0KICAgIHdoaWxlIChpc29XZWVrIDw9IGQpIHsKICAgICAgLy8gRG9pbmcgYSB2ZXJ5IHNpbXBsZSB3YWxrIHRvIGdldCB0aGUgd2VlayBudW1iZXIuCiAgICAgIHNldERhdGUoaXNvV2VlaywgZ2V0RGF0ZShpc29XZWVrKSArIDcpOwogICAgICBuKys7CiAgICB9CiAgICByZXR1cm4gbjsKICB9CgogIC8vIFdlZWsgeWVhciBoZWxwZXJzCgogIGZ1bmN0aW9uIGdldFdlZWtZZWFyKGQsIGxvY2FsZUNvZGUsIGlzbykgewogICAgdmFyIHllYXIsIG1vbnRoLCBmaXJzdERheU9mV2VlaywgZmlyc3REYXlPZldlZWtZZWFyLCB3ZWVrLCBsb2M7CiAgICB5ZWFyID0gZ2V0WWVhcihkKTsKICAgIG1vbnRoID0gZ2V0TW9udGgoZCk7CiAgICBpZiAobW9udGggPT09IDAgfHwgbW9udGggPT09IDExKSB7CiAgICAgIGlmICghaXNvKSB7CiAgICAgICAgbG9jID0gbG9jYWxlTWFuYWdlci5nZXQobG9jYWxlQ29kZSk7CiAgICAgICAgZmlyc3REYXlPZldlZWsgPSBsb2MuZ2V0Rmlyc3REYXlPZldlZWsobG9jYWxlQ29kZSk7CiAgICAgICAgZmlyc3REYXlPZldlZWtZZWFyID0gbG9jLmdldEZpcnN0RGF5T2ZXZWVrWWVhcihsb2NhbGVDb2RlKTsKICAgICAgfQogICAgICB3ZWVrID0gZ2V0V2Vla051bWJlcihkLCBmYWxzZSwgZmlyc3REYXlPZldlZWssIGZpcnN0RGF5T2ZXZWVrWWVhcik7CiAgICAgIGlmIChtb250aCA9PT0gMCAmJiB3ZWVrID09PSAwKSB7CiAgICAgICAgeWVhciAtPSAxOwogICAgICB9IGVsc2UgaWYgKG1vbnRoID09PSAxMSAmJiB3ZWVrID09PSAxKSB7CiAgICAgICAgeWVhciArPSAxOwogICAgICB9CiAgICB9CiAgICByZXR1cm4geWVhcjsKICB9CgogIGZ1bmN0aW9uIG1vdmVUb0ZpcnN0RGF5T2ZXZWVrWWVhcihkLCBmaXJzdERheU9mV2VlaywgZmlyc3REYXlPZldlZWtZZWFyKSB7CiAgICBzZXRVbml0QW5kTG93ZXJUb0VkZ2UoZCwgTU9OVEhfSU5ERVgpOwogICAgc2V0RGF0ZShkLCBmaXJzdERheU9mV2Vla1llYXIpOwogICAgbW92ZVRvQmVnaW5uaW5nT2ZXZWVrKGQsIGZpcnN0RGF5T2ZXZWVrKTsKICB9CgogIC8vIFJlbGF0aXZlIGhlbHBlcnMKCiAgZnVuY3Rpb24gZGF0ZVJlbGF0aXZlKGQsIGRSZWxhdGl2ZSwgYXJnMSwgYXJnMikgewogICAgdmFyIGFkdSwgZm9ybWF0LCB0eXBlLCBsb2NhbGVDb2RlLCBmbjsKICAgIGFzc2VydERhdGVJc1ZhbGlkKGQpOwogICAgaWYgKGlzRnVuY3Rpb24oYXJnMSkpIHsKICAgICAgZm4gPSBhcmcxOwogICAgfSBlbHNlIHsKICAgICAgbG9jYWxlQ29kZSA9IGFyZzE7CiAgICAgIGZuID0gYXJnMjsKICAgIH0KICAgIGFkdSA9IGdldEFkanVzdGVkVW5pdEZvckRhdGUoZCwgZFJlbGF0aXZlKTsKICAgIGlmIChmbikgewogICAgICBmb3JtYXQgPSBmbi5hcHBseShkLCBhZHUuY29uY2F0KGxvY2FsZU1hbmFnZXIuZ2V0KGxvY2FsZUNvZGUpKSk7CiAgICAgIGlmIChmb3JtYXQpIHsKICAgICAgICByZXR1cm4gZGF0ZUZvcm1hdChkLCBmb3JtYXQsIGxvY2FsZUNvZGUpOwogICAgICB9CiAgICB9CiAgICAvLyBBZGp1c3QgdXAgaWYgdGltZSBpcyBpbiBtcywgYXMgdGhpcyBkb2Vzbid0CiAgICAvLyBsb29rIHZlcnkgZ29vZCBmb3IgYSBzdGFuZGFyZCByZWxhdGl2ZSBkYXRlLgogICAgaWYgKGFkdVsxXSA9PT0gMCkgewogICAgICBhZHVbMV0gPSAxOwogICAgICBhZHVbMF0gPSAxOwogICAgfQogICAgaWYgKGRSZWxhdGl2ZSkgewogICAgICB0eXBlID0gJ2R1cmF0aW9uJzsKICAgIH0gZWxzZSBpZiAoYWR1WzJdID4gMCkgewogICAgICB0eXBlID0gJ2Z1dHVyZSc7CiAgICB9IGVsc2UgewogICAgICB0eXBlID0gJ3Bhc3QnOwogICAgfQogICAgcmV0dXJuIGxvY2FsZU1hbmFnZXIuZ2V0KGxvY2FsZUNvZGUpLmdldFJlbGF0aXZlRm9ybWF0KGFkdSwgdHlwZSk7CiAgfQoKICAvLyBHZXRzIGFuICJhZGp1c3RlZCBkYXRlIHVuaXQiIHdoaWNoIGlzIGEgd2F5IG9mIHJlcHJlc2VudGluZwogIC8vIHRoZSBsYXJnZXN0IHBvc3NpYmxlIG1lYW5pbmdmdWwgdW5pdC4gSW4gb3RoZXIgd29yZHMsIGlmIHBhc3NlZAogIC8vIDM2MDAwMDAsIHRoaXMgd2lsbCByZXR1cm4gYW4gYXJyYXkgd2hpY2ggcmVwcmVzZW50cyAiMSBob3VyIi4KICBmdW5jdGlvbiBnZXRBZGp1c3RlZFVuaXQobXMsIGZuKSB7CiAgICB2YXIgdW5pdEluZGV4ID0gMCwgdmFsdWUgPSAwOwogICAgaXRlcmF0ZU92ZXJEYXRlVW5pdHMoZnVuY3Rpb24odW5pdCwgaSkgewogICAgICB2YWx1ZSA9IGFicyhmbih1bml0KSk7CiAgICAgIGlmICh2YWx1ZSA+PSAxKSB7CiAgICAgICAgdW5pdEluZGV4ID0gaTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIFt2YWx1ZSwgdW5pdEluZGV4LCBtc107CiAgfQoKICAvLyBHZXRzIHRoZSBhZGp1c3RlZCB1bml0IGJhc2VkIG9uIHNpbXBsZSBkaXZpc2lvbiBieQogIC8vIGRhdGUgdW5pdCBtdWx0aXBsaWVyLgogIGZ1bmN0aW9uIGdldEFkanVzdGVkVW5pdEZvck51bWJlcihtcykgewogICAgcmV0dXJuIGdldEFkanVzdGVkVW5pdChtcywgZnVuY3Rpb24odW5pdCkgewogICAgICByZXR1cm4gdHJ1bmMod2l0aFByZWNpc2lvbihtcyAvIHVuaXQubXVsdGlwbGllciwgMSkpOwogICAgfSk7CiAgfQoKICAvLyBHZXRzIHRoZSBhZGp1c3RlZCB1bml0IHVzaW5nIHRoZSB1bml0c0Zyb21Ob3cgbWV0aG9kcywKICAvLyB3aGljaCB1c2UgaW50ZXJuYWwgZGF0ZSBtZXRob2RzIHRoYXQgbmVhdGx5IGF2b2lkIHZhZ3VlbHkKICAvLyBkZWZpbmVkIHVuaXRzIG9mIHRpbWUgKGRheXMgaW4gbW9udGgsIGxlYXAgeWVhcnMsIGV0YykuCiAgLy8gUmVzZXJ2aW5nIGRSZWxhdGl2ZSB0byBhbGxvdyBhbm90aGVyIGRhdGUgdG8gYmUgcmVsYXRpdmUgdG8uCiAgZnVuY3Rpb24gZ2V0QWRqdXN0ZWRVbml0Rm9yRGF0ZShkLCBkUmVsYXRpdmUpIHsKICAgIHZhciBtczsKICAgIGlmICghZFJlbGF0aXZlKSB7CiAgICAgIGRSZWxhdGl2ZSA9IGdldE5ld0RhdGUoKTsKICAgICAgaWYgKGQgPiBkUmVsYXRpdmUpIHsKICAgICAgICAvLyBJZiBvdXIgZGF0ZSBpcyBncmVhdGVyIHRoYW4gdGhlIG9uZSB0aGF0IHdlIGdvdCBmcm9tIGdldE5ld0RhdGUsIGl0CiAgICAgICAgLy8gbWVhbnMgdGhhdCB3ZSBhcmUgZmluZGluZyB0aGUgdW5pdCBmb3IgYSBkYXRlIHRoYXQgaXMgaW4gdGhlIGZ1dHVyZQogICAgICAgIC8vIHJlbGF0aXZlIHRvIG5vdy4gSG93ZXZlciwgb2Z0ZW4gdGhlIGluY29taW5nIGRhdGUgd2FzIGNyZWF0ZWQgaW4KICAgICAgICAvLyB0aGUgc2FtZSBjeWNsZSBhcyBvdXIgY29tcGFyaXNvbiwgYnV0IG91ciAibm93IiBkYXRlIHdpbGwgaGF2ZSBiZWVuCiAgICAgICAgLy8gY3JlYXRlZCBhbiBpbnN0YW50IGFmdGVyIGl0LCBjcmVhdGluZyBzaXR1YXRpb25zIHdoZXJlICI1IG1pbnV0ZXMgZnJvbQogICAgICAgIC8vIG5vdyIgYmVjb21lcyAiNCBtaW51dGVzIGZyb20gbm93IiBpbiB0aGUgc2FtZSB0aWNrLiBUbyBwcmV2ZW50IHRoaXMsCiAgICAgICAgLy8gc3VidHJhY3QgYSBidWZmZXIgb2YgMTBtcyB0byBjb21wZW5zYXRlLgogICAgICAgIGRSZWxhdGl2ZSA9IG5ldyBEYXRlKGRSZWxhdGl2ZS5nZXRUaW1lKCkgLSAxMCk7CiAgICAgIH0KICAgIH0KICAgIG1zID0gZCAtIGRSZWxhdGl2ZTsKICAgIHJldHVybiBnZXRBZGp1c3RlZFVuaXQobXMsIGZ1bmN0aW9uKHUpIHsKICAgICAgcmV0dXJuIGFicyhnZXRUaW1lRGlzdGFuY2VGb3JVbml0KGQsIGRSZWxhdGl2ZSwgdSkpOwogICAgfSk7CiAgfQoKICAvLyBGb3JhbXR0aW5nIGhlbHBlcnMKCiAgLy8gRm9ybWF0dGluZyB0b2tlbnMKICB2YXIgbGRtbFRva2Vucywgc3RyZlRva2VuczsKCiAgZnVuY3Rpb24gZGF0ZUZvcm1hdChkLCBmb3JtYXQsIGxvY2FsZUNvZGUpIHsKICAgIGFzc2VydERhdGVJc1ZhbGlkKGQpOwogICAgZm9ybWF0ID0gQ29yZU91dHB1dEZvcm1hdHNbZm9ybWF0XSB8fCBmb3JtYXQgfHwgJ3tsb25nfSc7CiAgICByZXR1cm4gZGF0ZUZvcm1hdE1hdGNoZXIoZm9ybWF0LCBkLCBsb2NhbGVDb2RlKTsKICB9CgogIGZ1bmN0aW9uIGdldE1lcmlkaWVtVG9rZW4oZCwgbG9jYWxlQ29kZSkgewogICAgdmFyIGhvdXJzID0gZ2V0SG91cnMoZCk7CiAgICByZXR1cm4gbG9jYWxlTWFuYWdlci5nZXQobG9jYWxlQ29kZSkuYW1wbVt0cnVuYyhob3VycyAvIDEyKV0gfHwgJyc7CiAgfQoKICBmdW5jdGlvbiBidWlsZERhdGVGb3JtYXRUb2tlbnMoKSB7CgogICAgZnVuY3Rpb24gYWRkRm9ybWF0cyh0YXJnZXQsIHRva2VucywgZm4pIHsKICAgICAgaWYgKHRva2VucykgewogICAgICAgIGZvckVhY2goc3BhY2VTcGxpdCh0b2tlbnMpLCBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgdGFyZ2V0W3Rva2VuXSA9IGZuOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYnVpbGRMb3dlcmNhc2UoZ2V0KSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihkLCBsb2NhbGVDb2RlKSB7CiAgICAgICAgcmV0dXJuIGdldChkLCBsb2NhbGVDb2RlKS50b0xvd2VyQ2FzZSgpOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGJ1aWxkT3JkaW5hbChnZXQpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGQsIGxvY2FsZUNvZGUpIHsKICAgICAgICB2YXIgbiA9IGdldChkLCBsb2NhbGVDb2RlKTsKICAgICAgICByZXR1cm4gbiArIGxvY2FsZU1hbmFnZXIuZ2V0KGxvY2FsZUNvZGUpLmdldE9yZGluYWwobik7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gYnVpbGRQYWRkZWQoZ2V0LCBwYWRkaW5nKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihkLCBsb2NhbGVDb2RlKSB7CiAgICAgICAgcmV0dXJuIHBhZE51bWJlcihnZXQoZCwgbG9jYWxlQ29kZSksIHBhZGRpbmcpOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGJ1aWxkVHdvRGlnaXRzKGdldCkgewogICAgICByZXR1cm4gZnVuY3Rpb24oZCwgbG9jYWxlQ29kZSkgewogICAgICAgIHJldHVybiBnZXQoZCwgbG9jYWxlQ29kZSkgJSAxMDA7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gYnVpbGRBbGlhcyhhbGlhcykgewogICAgICByZXR1cm4gZnVuY3Rpb24oZCwgbG9jYWxlQ29kZSkgewogICAgICAgIHJldHVybiBkYXRlRm9ybWF0TWF0Y2hlcihhbGlhcywgZCwgbG9jYWxlQ29kZSk7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gYnVpbGRBbHRlcm5hdGVzKGYpIHsKICAgICAgZm9yICh2YXIgbiA9IDE7IG4gPD0gNTsgbisrKSB7CiAgICAgICAgYnVpbGRBbHRlcm5hdGUoZiwgbik7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBidWlsZEFsdGVybmF0ZShmLCBuKSB7CiAgICAgIHZhciBhbHRlcm5hdGUgPSBmdW5jdGlvbihkLCBsb2NhbGVDb2RlKSB7CiAgICAgICAgcmV0dXJuIGYuZ2V0KGQsIGxvY2FsZUNvZGUsIG4pOwogICAgICB9OwogICAgICBhZGRGb3JtYXRzKGxkbWxUb2tlbnMsIGYubGRtbCArIG4sIGFsdGVybmF0ZSk7CiAgICAgIGlmIChmLmxvd2VyVG9rZW4pIHsKICAgICAgICBsZG1sVG9rZW5zW2YubG93ZXJUb2tlbiArIG5dID0gYnVpbGRMb3dlcmNhc2UoYWx0ZXJuYXRlKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldElkZW50aXR5Rm9ybWF0KG5hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGQsIGxvY2FsZUNvZGUpIHsKICAgICAgICB2YXIgbG9jID0gbG9jYWxlTWFuYWdlci5nZXQobG9jYWxlQ29kZSk7CiAgICAgICAgcmV0dXJuIGRhdGVGb3JtYXRNYXRjaGVyKGxvY1tuYW1lXSwgZCwgbG9jYWxlQ29kZSk7CiAgICAgIH07CiAgICB9CgogICAgbGRtbFRva2VucyA9IHt9OwogICAgc3RyZlRva2VucyA9IHt9OwoKICAgIGZvckVhY2goRm9ybWF0VG9rZW5zQmFzZSwgZnVuY3Rpb24oZikgewogICAgICB2YXIgZ2V0ID0gZi5nZXQsIGdldFBhZGRlZDsKICAgICAgaWYgKGYubG93ZXJUb2tlbikgewogICAgICAgIGxkbWxUb2tlbnNbZi5sb3dlclRva2VuXSA9IGJ1aWxkTG93ZXJjYXNlKGdldCk7CiAgICAgIH0KICAgICAgaWYgKGYub3JkaW5hbFRva2VuKSB7CiAgICAgICAgbGRtbFRva2Vuc1tmLm9yZGluYWxUb2tlbl0gPSBidWlsZE9yZGluYWwoZ2V0LCBmKTsKICAgICAgfQogICAgICBpZiAoZi5sZG1sUGFkZGVkVG9rZW4pIHsKICAgICAgICBsZG1sVG9rZW5zW2YubGRtbFBhZGRlZFRva2VuXSA9IGJ1aWxkUGFkZGVkKGdldCwgZi5sZG1sUGFkZGVkVG9rZW4ubGVuZ3RoKTsKICAgICAgfQogICAgICBpZiAoZi5sZG1sVHdvRGlnaXRUb2tlbikgewogICAgICAgIGxkbWxUb2tlbnNbZi5sZG1sVHdvRGlnaXRUb2tlbl0gPSBidWlsZFBhZGRlZChidWlsZFR3b0RpZ2l0cyhnZXQpLCAyKTsKICAgICAgfQogICAgICBpZiAoZi5zdHJmVHdvRGlnaXRUb2tlbikgewogICAgICAgIHN0cmZUb2tlbnNbZi5zdHJmVHdvRGlnaXRUb2tlbl0gPSBidWlsZFBhZGRlZChidWlsZFR3b0RpZ2l0cyhnZXQpLCAyKTsKICAgICAgfQogICAgICBpZiAoZi5zdHJmUGFkZGluZykgewogICAgICAgIGdldFBhZGRlZCA9IGJ1aWxkUGFkZGVkKGdldCwgZi5zdHJmUGFkZGluZyk7CiAgICAgIH0KICAgICAgaWYgKGYuYWxpYXMpIHsKICAgICAgICBnZXQgPSBidWlsZEFsaWFzKGYuYWxpYXMpOwogICAgICB9CiAgICAgIGlmIChmLmFsbG93QWx0ZXJuYXRlcykgewogICAgICAgIGJ1aWxkQWx0ZXJuYXRlcyhmKTsKICAgICAgfQogICAgICBhZGRGb3JtYXRzKGxkbWxUb2tlbnMsIGYubGRtbCwgZ2V0KTsKICAgICAgYWRkRm9ybWF0cyhzdHJmVG9rZW5zLCBmLnN0cmYsIGdldFBhZGRlZCB8fCBnZXQpOwogICAgfSk7CgogICAgZm9yRWFjaFByb3BlcnR5KENvcmVPdXRwdXRGb3JtYXRzLCBmdW5jdGlvbihzcmMsIG5hbWUpIHsKICAgICAgYWRkRm9ybWF0cyhsZG1sVG9rZW5zLCBuYW1lLCBidWlsZEFsaWFzKHNyYykpOwogICAgfSk7CgogICAgZGVmaW5lSW5zdGFuY2VTaW1pbGFyKHN1Z2FyRGF0ZSwgJ3Nob3J0IG1lZGl1bSBsb25nIGZ1bGwnLCBmdW5jdGlvbihtZXRob2RzLCBuYW1lKSB7CiAgICAgIHZhciBmbiA9IGdldElkZW50aXR5Rm9ybWF0KG5hbWUpOwogICAgICBhZGRGb3JtYXRzKGxkbWxUb2tlbnMsIG5hbWUsIGZuKTsKICAgICAgbWV0aG9kc1tuYW1lXSA9IGZuOwogICAgfSk7CgogICAgYWRkRm9ybWF0cyhsZG1sVG9rZW5zLCAndGltZScsIGdldElkZW50aXR5Rm9ybWF0KCd0aW1lJykpOwogICAgYWRkRm9ybWF0cyhsZG1sVG9rZW5zLCAnc3RhbXAnLCBnZXRJZGVudGl0eUZvcm1hdCgnc3RhbXAnKSk7CiAgfQoKICAvLyBGb3JtYXQgbWF0Y2hlcgoKICB2YXIgZGF0ZUZvcm1hdE1hdGNoZXI7CgogIGZ1bmN0aW9uIGJ1aWxkRGF0ZUZvcm1hdE1hdGNoZXIoKSB7CgogICAgZnVuY3Rpb24gZ2V0TGRtbChkLCB0b2tlbiwgbG9jYWxlQ29kZSkgewogICAgICByZXR1cm4gZ2V0T3duKGxkbWxUb2tlbnMsIHRva2VuKShkLCBsb2NhbGVDb2RlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRTdHJmKGQsIHRva2VuLCBsb2NhbGVDb2RlKSB7CiAgICAgIHJldHVybiBnZXRPd24oc3RyZlRva2VucywgdG9rZW4pKGQsIGxvY2FsZUNvZGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrRGF0ZVRva2VuKGxkbWwsIHN0cmYpIHsKICAgICAgcmV0dXJuIGhhc093bihsZG1sVG9rZW5zLCBsZG1sKSB8fCBoYXNPd24oc3RyZlRva2Vucywgc3RyZik7CiAgICB9CgogICAgLy8gRm9ybWF0IG1hdGNoZXIgZm9yIExETUwgb3IgU1RSRiB0b2tlbnMuCiAgICBkYXRlRm9ybWF0TWF0Y2hlciA9IGNyZWF0ZUZvcm1hdE1hdGNoZXIoZ2V0TGRtbCwgZ2V0U3RyZiwgY2hlY2tEYXRlVG9rZW4pOwogIH0KCiAgLy8gQ29tcGFyaXNvbiBoZWxwZXJzCgogIGZ1bmN0aW9uIGZ1bGxDb21wYXJlRGF0ZShkYXRlLCBkLCBtYXJnaW4pIHsKICAgIHZhciB0bXA7CiAgICBpZiAoIWRhdGVJc1ZhbGlkKGRhdGUpKSByZXR1cm47CiAgICBpZiAoaXNTdHJpbmcoZCkpIHsKICAgICAgZCA9IHRyaW0oZCkudG9Mb3dlckNhc2UoKTsKICAgICAgc3dpdGNoKHRydWUpIHsKICAgICAgICBjYXNlIGQgPT09ICdmdXR1cmUnOiAgICByZXR1cm4gZGF0ZS5nZXRUaW1lKCkgPiBnZXROZXdEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIGNhc2UgZCA9PT0gJ3Bhc3QnOiAgICAgIHJldHVybiBkYXRlLmdldFRpbWUoKSA8IGdldE5ld0RhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgY2FzZSBkID09PSAndG9kYXknOiAgICAgcmV0dXJuIGNvbXBhcmVEYXkoZGF0ZSk7CiAgICAgICAgY2FzZSBkID09PSAndG9tb3Jyb3cnOiAgcmV0dXJuIGNvbXBhcmVEYXkoZGF0ZSwgIDEpOwogICAgICAgIGNhc2UgZCA9PT0gJ3llc3RlcmRheSc6IHJldHVybiBjb21wYXJlRGF5KGRhdGUsIC0xKTsKICAgICAgICBjYXNlIGQgPT09ICd3ZWVrZGF5JzogICByZXR1cm4gZ2V0V2Vla2RheShkYXRlKSA+IDAgJiYgZ2V0V2Vla2RheShkYXRlKSA8IDY7CiAgICAgICAgY2FzZSBkID09PSAnd2Vla2VuZCc6ICAgcmV0dXJuIGdldFdlZWtkYXkoZGF0ZSkgPT09IDAgfHwgZ2V0V2Vla2RheShkYXRlKSA9PT0gNjsKCiAgICAgICAgY2FzZSAoaXNEZWZpbmVkKHRtcCA9IEVuZ2xpc2gud2Vla2RheU1hcFtkXSkpOgogICAgICAgICAgcmV0dXJuIGdldFdlZWtkYXkoZGF0ZSkgPT09IHRtcDsKICAgICAgICBjYXNlIChpc0RlZmluZWQodG1wID0gRW5nbGlzaC5tb250aE1hcFtkXSkpOgogICAgICAgICAgcmV0dXJuIGdldE1vbnRoKGRhdGUpID09PSB0bXA7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb21wYXJlRGF0ZShkYXRlLCBkLCBtYXJnaW4pOwogIH0KCiAgZnVuY3Rpb24gY29tcGFyZURhdGUoZGF0ZSwgZCwgbWFyZ2luLCBsb2NhbGVDb2RlLCBvcHRpb25zKSB7CiAgICB2YXIgbG9NYXJnaW4gPSAwLCBoaU1hcmdpbiA9IDAsIHRpbWV6b25lU2hpZnQsIGNvbXBhcmVFZGdlcywgb3ZlcnJpZGUsIG1pbiwgbWF4LCBwLCB0OwoKICAgIGZ1bmN0aW9uIGdldFRpbWV6b25lU2hpZnQoKSB7CiAgICAgIC8vIElmIHRoZXJlIGlzIGFueSBzcGVjaWZpY2l0eSBpbiB0aGUgZGF0ZSB0aGVuIHdlJ3JlIGltcGxpY2l0bHkgbm90CiAgICAgIC8vIGNoZWNraW5nIGFic29sdXRlIHRpbWUsIHNvIGlnbm9yZSB0aW1lem9uZSBzaGlmdHMuCiAgICAgIGlmIChwLnNldCAmJiBwLnNldC5zcGVjaWZpY2l0eSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIHJldHVybiAodHpPZmZzZXQocC5kYXRlKSAtIHR6T2Zmc2V0KGRhdGUpKSAqIE1JTlVURVM7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkU3BlY2lmaWNVbml0KCkgewogICAgICB2YXIgdW5pdCA9IERhdGVVbml0c1twLnNldC5zcGVjaWZpY2l0eV07CiAgICAgIHJldHVybiBhZHZhbmNlRGF0ZShjbG9uZURhdGUocC5kYXRlKSwgdW5pdC5uYW1lLCAxKS5nZXRUaW1lKCkgLSAxOwogICAgfQoKICAgIGlmIChfdXRjKGRhdGUpKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBvcHRpb25zLmZyb21VVEMgPSB0cnVlOwogICAgICBvcHRpb25zLnNldFVUQyA9IHRydWU7CiAgICB9CgogICAgcCA9IGdldEV4dGVuZGVkRGF0ZShudWxsLCBkLCBvcHRpb25zLCB0cnVlKTsKCiAgICBpZiAobWFyZ2luID4gMCkgewogICAgICBsb01hcmdpbiA9IGhpTWFyZ2luID0gbWFyZ2luOwogICAgICBvdmVycmlkZSA9IHRydWU7CiAgICB9CiAgICBpZiAoIWRhdGVJc1ZhbGlkKHAuZGF0ZSkpIHJldHVybiBmYWxzZTsKICAgIGlmIChwLnNldCAmJiBwLnNldC5zcGVjaWZpY2l0eSkgewogICAgICBpZiAoaXNEZWZpbmVkKHAuc2V0LmVkZ2UpIHx8IGlzRGVmaW5lZChwLnNldC5zaGlmdCkpIHsKICAgICAgICBjb21wYXJlRWRnZXMgPSB0cnVlOwogICAgICAgIG1vdmVUb0JlZ2lubmluZ09mVW5pdChwLmRhdGUsIHAuc2V0LnNwZWNpZmljaXR5LCBsb2NhbGVDb2RlKTsKICAgICAgfQogICAgICBpZiAoY29tcGFyZUVkZ2VzIHx8IHAuc2V0LnNwZWNpZmljaXR5ID09PSBNT05USF9JTkRFWCkgewogICAgICAgIG1heCA9IG1vdmVUb0VuZE9mVW5pdChjbG9uZURhdGUocC5kYXRlKSwgcC5zZXQuc3BlY2lmaWNpdHksIGxvY2FsZUNvZGUpLmdldFRpbWUoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtYXggPSBhZGRTcGVjaWZpY1VuaXQoKTsKICAgICAgfQogICAgICBpZiAoIW92ZXJyaWRlICYmIGlzRGVmaW5lZChwLnNldC5zaWduKSAmJiBwLnNldC5zcGVjaWZpY2l0eSkgewogICAgICAgIC8vIElmIHRoZSB0aW1lIGlzIHJlbGF0aXZlLCB0aGVyZSBjYW4gb2NjYXNpb25hbGx5IGJlIGFuIGRpc3Bhcml0eSBiZXR3ZWVuCiAgICAgICAgLy8gdGhlIHJlbGF0aXZlIGRhdGUgYW5kICJub3ciLCB3aGljaCBpdCBpcyBiZWluZyBjb21wYXJlZCB0bywgc28gc2V0IGFuCiAgICAgICAgLy8gZXh0cmEgbWFyZ2luIHRvIGFjY291bnQgZm9yIHRoaXMuCiAgICAgICAgbG9NYXJnaW4gPSA1MDsKICAgICAgICBoaU1hcmdpbiA9IC01MDsKICAgICAgfQogICAgfQogICAgdCAgID0gZGF0ZS5nZXRUaW1lKCk7CiAgICBtaW4gPSBwLmRhdGUuZ2V0VGltZSgpOwogICAgbWF4ID0gbWF4IHx8IG1pbjsKICAgIHRpbWV6b25lU2hpZnQgPSBnZXRUaW1lem9uZVNoaWZ0KCk7CiAgICBpZiAodGltZXpvbmVTaGlmdCkgewogICAgICBtaW4gLT0gdGltZXpvbmVTaGlmdDsKICAgICAgbWF4IC09IHRpbWV6b25lU2hpZnQ7CiAgICB9CiAgICByZXR1cm4gdCA+PSAobWluIC0gbG9NYXJnaW4pICYmIHQgPD0gKG1heCArIGhpTWFyZ2luKTsKICB9CgogIGZ1bmN0aW9uIGNvbXBhcmVEYXkoZCwgc2hpZnQpIHsKICAgIHZhciBjb21wID0gZ2V0TmV3RGF0ZSgpOwogICAgaWYgKHNoaWZ0KSB7CiAgICAgIHNldERhdGUoY29tcCwgZ2V0RGF0ZShjb21wKSArIHNoaWZ0KTsKICAgIH0KICAgIHJldHVybiBnZXRZZWFyKGQpID09PSBnZXRZZWFyKGNvbXApICYmCiAgICAgICAgICAgZ2V0TW9udGgoZCkgPT09IGdldE1vbnRoKGNvbXApICYmCiAgICAgICAgICAgZ2V0RGF0ZShkKSA9PT0gZ2V0RGF0ZShjb21wKTsKICB9CgogIC8vIENyZWF0ZSBoZWxwZXJzCgogIGZ1bmN0aW9uIGNyZWF0ZURhdGUoZCwgb3B0aW9ucywgZm9yY2VDbG9uZSkgewogICAgcmV0dXJuIGdldEV4dGVuZGVkRGF0ZShudWxsLCBkLCBvcHRpb25zLCBmb3JjZUNsb25lKS5kYXRlOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRGF0ZVdpdGhDb250ZXh0KGNvbnRleHREYXRlLCBkLCBvcHRpb25zLCBmb3JjZUNsb25lKSB7CiAgICByZXR1cm4gZ2V0RXh0ZW5kZWREYXRlKGNvbnRleHREYXRlLCBkLCBvcHRpb25zLCBmb3JjZUNsb25lKS5kYXRlOwogIH0KCiAgZnVuY3Rpb24gZ2V0RXh0ZW5kZWREYXRlKGNvbnRleHREYXRlLCBkLCBvcHQsIGZvcmNlQ2xvbmUpIHsKCiAgICB2YXIgZGF0ZSwgc2V0LCBsb2MsIG9wdGlvbnMsIGFmdGVyQ2FsbGJhY2tzLCByZWxhdGl2ZSwgd2Vla2RheURpcjsKCiAgICBhZnRlckNhbGxiYWNrcyA9IFtdOwogICAgb3B0aW9ucyA9IGdldERhdGVPcHRpb25zKG9wdCk7CgogICAgZnVuY3Rpb24gZ2V0RGF0ZU9wdGlvbnMob3B0KSB7CiAgICAgIHZhciBvcHRpb25zID0gaXNTdHJpbmcob3B0KSA/IHsgbG9jYWxlOiBvcHQgfSA6IG9wdCB8fCB7fTsKICAgICAgb3B0aW9ucy5wcmVmZXIgPSArISFnZXRPd24ob3B0aW9ucywgJ2Z1dHVyZScpIC0gKyEhZ2V0T3duKG9wdGlvbnMsICdwYXN0Jyk7CiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEZvcm1hdFBhcmFtcyhtYXRjaCwgZGlmKSB7CiAgICAgIHZhciBzZXQgPSBnZXRPd24ob3B0aW9ucywgJ3BhcmFtcycpIHx8IHt9OwogICAgICBmb3JFYWNoKGRpZi50bywgZnVuY3Rpb24oZmllbGQsIGkpIHsKICAgICAgICB2YXIgc3RyID0gbWF0Y2hbaSArIDFdLCB0b2tlbiwgdmFsOwogICAgICAgIGlmICghc3RyKSByZXR1cm47CiAgICAgICAgaWYgKGZpZWxkID09PSAneXknIHx8IGZpZWxkID09PSAneScpIHsKICAgICAgICAgIGZpZWxkID0gJ3llYXInOwogICAgICAgICAgdmFsID0gZ2V0WWVhckZyb21BYmJyZXZpYXRpb24oc3RyLCBkYXRlLCBnZXRPd24ob3B0aW9ucywgJ3ByZWZlcicpKTsKICAgICAgICB9IGVsc2UgaWYgKHRva2VuID0gZ2V0T3duKFBhcnNpbmdUb2tlbnMsIGZpZWxkKSkgewogICAgICAgICAgZmllbGQgPSB0b2tlbi5wYXJhbSB8fCBmaWVsZDsKICAgICAgICAgIHZhbCA9IGdldFBhcnNpbmdUb2tlblZhbHVlKHRva2VuLCBzdHIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWwgPSBsb2MuZ2V0VG9rZW5WYWx1ZShmaWVsZCwgc3RyKTsKICAgICAgICB9CiAgICAgICAgc2V0W2ZpZWxkXSA9IHZhbDsKICAgICAgfSk7CiAgICAgIHJldHVybiBzZXQ7CiAgICB9CgogICAgLy8gQ2xvbmUgZGF0ZSB3aWxsIHNldCB0aGUgdXRjIGZsYWcsIGJ1dCBpdCB3aWxsCiAgICAvLyBiZSBvdmVycmlkZW4gbGF0ZXIsIHNvIHNldCBvcHRpb24gZmxhZ3MgaW5zdGVhZC4KICAgIGZ1bmN0aW9uIGNsb25lRGF0ZUJ5RmxhZyhkLCBjbG9uZSkgewogICAgICBpZiAoX3V0YyhkKSAmJiAhaXNEZWZpbmVkKGdldE93bihvcHRpb25zLCAnZnJvbVVUQycpKSkgewogICAgICAgIG9wdGlvbnMuZnJvbVVUQyA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKF91dGMoZCkgJiYgIWlzRGVmaW5lZChnZXRPd24ob3B0aW9ucywgJ3NldFVUQycpKSkgewogICAgICAgIG9wdGlvbnMuc2V0VVRDID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoY2xvbmUpIHsKICAgICAgICBkID0gbmV3IERhdGUoZC5nZXRUaW1lKCkpOwogICAgICB9CiAgICAgIHJldHVybiBkOwogICAgfQoKICAgIGZ1bmN0aW9uIGFmdGVyRGF0ZVNldChmbikgewogICAgICBhZnRlckNhbGxiYWNrcy5wdXNoKGZuKTsKICAgIH0KCiAgICBmdW5jdGlvbiBmaXJlQ2FsbGJhY2tzKCkgewogICAgICBmb3JFYWNoKGFmdGVyQ2FsbGJhY2tzLCBmdW5jdGlvbihmbikgewogICAgICAgIGZuLmNhbGwoKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VTdHJpbmdEYXRlKHN0cikgewoKICAgICAgc3RyID0gc3RyLnRvTG93ZXJDYXNlKCk7CgogICAgICAvLyBUaGUgYWN0IG9mIGdldHRpbmcgdGhlIGxvY2FsZSB3aWxsIGluaXRpYWxpemUKICAgICAgLy8gaWYgaXQgaXMgbWlzc2luZyBhbmQgYWRkIHRoZSByZXF1aXJlZCBmb3JtYXRzLgogICAgICBsb2MgPSBsb2NhbGVNYW5hZ2VyLmdldChnZXRPd24ob3B0aW9ucywgJ2xvY2FsZScpKTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBkaWYsIG1hdGNoOyBkaWYgPSBsb2MuY29tcGlsZWRGb3JtYXRzW2ldOyBpKyspIHsKICAgICAgICBtYXRjaCA9IHN0ci5tYXRjaChkaWYucmVnKTsKICAgICAgICBpZiAobWF0Y2gpIHsKCiAgICAgICAgICAvLyBOb3RlIHRoYXQgY2FjaGluZyB0aGUgZm9ybWF0IHdpbGwgbW9kaWZ5IHRoZSBjb21waWxlZEZvcm1hdHMgYXJyYXkKICAgICAgICAgIC8vIHdoaWNoIGlzIG5vdCBhIGdvb2QgaWRlYSB0byBkbyBpbnNpZGUgaXRzIGZvciBsb29wLCBob3dldmVyIHdlCiAgICAgICAgICAvLyBrbm93IGF0IHRoaXMgcG9pbnQgdGhhdCB3ZSBoYXZlIGEgbWF0Y2hlZCBmb3JtYXQgYW5kIHRoYXQgd2Ugd2lsbAogICAgICAgICAgLy8gYnJlYWsgb3V0IGJlbG93LCBzbyBzaW1wbGVyIHRvIGRvIGl0IGhlcmUuCiAgICAgICAgICBsb2MuY2FjaGVGb3JtYXQoZGlmLCBpKTsKCiAgICAgICAgICBzZXQgPSBnZXRGb3JtYXRQYXJhbXMobWF0Y2gsIGRpZik7CgogICAgICAgICAgaWYgKGlzRGVmaW5lZChzZXQudGltZXN0YW1wKSkgewogICAgICAgICAgICBzdHIgPSBzZXQudGltZXN0YW1wOwogICAgICAgICAgICBzZXQgPSBudWxsOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNEZWZpbmVkKHNldC5hbXBtKSkgewogICAgICAgICAgICBoYW5kbGVBbXBtKHNldC5hbXBtKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2V0LnV0YyB8fCBpc0RlZmluZWQoc2V0LnR6SG91cikpIHsKICAgICAgICAgICAgaGFuZGxlVGltZXpvbmVPZmZzZXQoc2V0LnR6SG91ciwgc2V0LnR6TWludXRlLCBzZXQudHpTaWduKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNEZWZpbmVkKHNldC5zaGlmdCkgJiYgaXNVbmRlZmluZWQoc2V0LnVuaXQpKSB7CiAgICAgICAgICAgIC8vICJuZXh0IGphbnVhcnkiLCAibmV4dCBtb25kYXkiLCBldGMKICAgICAgICAgICAgaGFuZGxlVW5pdGxlc3NTaGlmdCgpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc0RlZmluZWQoc2V0Lm51bSkgJiYgaXNVbmRlZmluZWQoc2V0LnVuaXQpKSB7CiAgICAgICAgICAgIC8vICJ0aGUgc2Vjb25kIG9mIEphbnVhcnkiLCBldGMKICAgICAgICAgICAgaGFuZGxlVW5pdGxlc3NOdW0oc2V0Lm51bSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHNldC5taWRkYXkpIHsKICAgICAgICAgICAgLy8gIm5vb24iIGFuZCAibWlkbmlnaHQiCiAgICAgICAgICAgIGhhbmRsZU1pZGRheShzZXQubWlkZGF5KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNEZWZpbmVkKHNldC5kYXkpKSB7CiAgICAgICAgICAgIC8vIFJlbGF0aXZlIGRheSBsb2NhbGl6YXRpb25zIHN1Y2ggYXMgInRvZGF5IiBhbmQgInRvbW9ycm93Ii4KICAgICAgICAgICAgaGFuZGxlUmVsYXRpdmVEYXkoc2V0LmRheSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzRGVmaW5lZChzZXQudW5pdCkpIHsKICAgICAgICAgICAgLy8gIjMgZGF5cyBhZ28iLCBldGMKICAgICAgICAgICAgaGFuZGxlUmVsYXRpdmVVbml0KHNldC51bml0KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2V0LmVkZ2UpIHsKICAgICAgICAgICAgLy8gInRoZSBlbmQgb2YgSmFudWFyeSIsIGV0YwogICAgICAgICAgICBoYW5kbGVFZGdlKHNldC5lZGdlLCBzZXQpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChzZXQueWVhclNpZ24pIHsKICAgICAgICAgICAgc2V0LnllYXIgKj0gc2V0LnllYXJTaWduOwogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFzZXQpIHsKICAgICAgICAvLyBGYWxsIGJhY2sgdG8gbmF0aXZlIHBhcnNpbmcKICAgICAgICBkYXRlID0gbmV3IERhdGUoc3RyKTsKICAgICAgICBpZiAoZ2V0T3duKG9wdGlvbnMsICdmcm9tVVRDJykpIHsKICAgICAgICAgIC8vIEZhbGxpbmcgYmFjayB0byBzeXN0ZW0gZGF0ZSBoZXJlIHdoaWNoIGNhbm5vdCBiZSBwYXJzZWQgYXMgVVRDLAogICAgICAgICAgLy8gc28gaWYgd2UncmUgZm9yY2luZyBVVEMgdGhlbiBzaW1wbHkgYWRkIHRoZSBvZmZzZXQuCiAgICAgICAgICBkYXRlLnNldFRpbWUoZGF0ZS5nZXRUaW1lKCkgKyAodHpPZmZzZXQoZGF0ZSkgKiBNSU5VVEVTKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHJlbGF0aXZlKSB7CiAgICAgICAgdXBkYXRlRGF0ZShkYXRlLCBzZXQsIGZhbHNlLCAxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoX3V0YyhkYXRlKSkgewogICAgICAgICAgLy8gVVRDIHRpbWVzIGNhbiB0cmF2ZXJzZSBpbnRvIG90aGVyIGRheXMgb3IgZXZlbiBtb250aHMsCiAgICAgICAgICAvLyBzbyBwcmVlbXRpdmVseSByZXNldCB0aGUgdGltZSBoZXJlIHRvIHByZXZlbnQgdGhpcy4KICAgICAgICAgIHJlc2V0VGltZShkYXRlKTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlRGF0ZShkYXRlLCBzZXQsIHRydWUsIDAsIGdldE93bihvcHRpb25zLCAncHJlZmVyJyksIHdlZWtkYXlEaXIpOwogICAgICB9CiAgICAgIGZpcmVDYWxsYmFja3MoKTsKICAgICAgcmV0dXJuIGRhdGU7CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQW1wbShhbXBtKSB7CiAgICAgIGlmIChhbXBtID09PSAxICYmIHNldC5ob3VyIDwgMTIpIHsKICAgICAgICAvLyBJZiB0aGUgdGltZSBpcyAxcG0tMTFwbSBhZHZhbmNlIHRoZSB0aW1lIGJ5IDEyIGhvdXJzLgogICAgICAgIHNldC5ob3VyICs9IDEyOwogICAgICB9IGVsc2UgaWYgKGFtcG0gPT09IDAgJiYgc2V0LmhvdXIgPT09IDEyKSB7CiAgICAgICAgLy8gSWYgaXQgaXMgMTI6MDBhbSB0aGVuIHNldCB0aGUgaG91ciB0byAwLgogICAgICAgIHNldC5ob3VyID0gMDsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZVRpbWV6b25lT2Zmc2V0KHR6SG91ciwgdHpNaW51dGUsIHR6U2lnbikgewogICAgICAvLyBBZGp1c3QgZm9yIHRpbWV6b25lIG9mZnNldAogICAgICBfdXRjKGRhdGUsIHRydWUpOwogICAgICB2YXIgb2Zmc2V0ID0gKHR6U2lnbiB8fCAxKSAqICgodHpIb3VyIHx8IDApICogNjAgKyAodHpNaW51dGUgfHwgMCkpOwogICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgc2V0Lm1pbnV0ZSA9IChzZXQubWludXRlIHx8IDApIC0gb2Zmc2V0OwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlVW5pdGxlc3NTaGlmdCgpIHsKICAgICAgaWYgKGlzRGVmaW5lZChzZXQubW9udGgpKSB7CiAgICAgICAgLy8gIm5leHQgSmFudWFyeSIKICAgICAgICBzZXQudW5pdCA9IFlFQVJfSU5ERVg7CiAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHNldC53ZWVrZGF5KSkgewogICAgICAgIC8vICJuZXh0IE1vbmRheSIKICAgICAgICBzZXQudW5pdCA9IFdFRUtfSU5ERVg7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVVbml0bGVzc051bShudW0pIHsKICAgICAgaWYgKGlzRGVmaW5lZChzZXQud2Vla2RheSkpIHsKICAgICAgICAvLyAiVGhlIHNlY29uZCBUdWVzZGF5IG9mIE1hcmNoIgogICAgICAgIHNldE9yZGluYWxXZWVrZGF5KG51bSk7CiAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHNldC5tb250aCkpIHsKICAgICAgICAvLyAiVGhlIHNlY29uZCBvZiBNYXJjaCIKICAgICAgICBzZXQuZGF0ZSA9IHNldC5udW07CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVNaWRkYXkoaG91cikgewogICAgICBzZXQuaG91ciA9IGhvdXIgJSAyNDsKICAgICAgaWYgKGhvdXIgPiAyMykgewogICAgICAgIC8vIElmIHRoZSBkYXRlIGhhcyBob3VycyBwYXN0IDI0LCB3ZSBuZWVkIHRvIHByZXZlbnQgaXQgZnJvbSB0cmF2ZXJzaW5nCiAgICAgICAgLy8gaW50byBhIG5ldyBkYXkgYXMgdGhhdCB3b3VsZCBtYWtlIGl0IGJlaW5nIHBhcnQgb2YgYSBuZXcgd2VlayBpbgogICAgICAgIC8vIGFtYmlndW91cyBkYXRlcyBzdWNoIGFzICJNb25kYXkiLgogICAgICAgIGFmdGVyRGF0ZVNldChmdW5jdGlvbigpIHsKICAgICAgICAgIGFkdmFuY2VEYXRlKGRhdGUsICdkYXRlJywgdHJ1bmMoaG91ciAvIDI0KSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVSZWxhdGl2ZURheSgpIHsKICAgICAgcmVzZXRUaW1lKGRhdGUpOwogICAgICBpZiAoaXNVbmRlZmluZWQoc2V0LnVuaXQpKSB7CiAgICAgICAgc2V0LnVuaXQgPSBEQVlfSU5ERVg7CiAgICAgICAgc2V0Lm51bSAgPSBzZXQuZGF5OwogICAgICAgIGRlbGV0ZSBzZXQuZGF5OwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlUmVsYXRpdmVVbml0KHVuaXRJbmRleCkgewogICAgICB2YXIgbnVtID0gaXNEZWZpbmVkKHNldC5udW0pID8gc2V0Lm51bSA6IDE7CgogICAgICAvLyBJZiBhIHdlZWtkYXkgaXMgZGVmaW5lZCwgdGhlcmUgYXJlIDMgcG9zc2libGUgZm9ybWF0cyBiZWluZyBhcHBsaWVkOgogICAgICAvLwogICAgICAvLyAxLiAidGhlIGRheSBhZnRlciBtb25kYXkiOiB1bml0IGlzIGRheXMKICAgICAgLy8gMi4gIm5leHQgbW9uZGF5Ijogc2hvcnQgZm9yICJuZXh0IHdlZWsgbW9uZGF5IiwgdW5pdCBpcyB3ZWVrcwogICAgICAvLyAzLiAidGhlIDJuZCBtb25kYXkgb2YgbmV4dCBtb250aCI6IHVuaXQgaXMgbW9udGhzCiAgICAgIC8vCiAgICAgIC8vIEluIHRoZSBmaXJzdCBjYXNlLCB3ZSBuZWVkIHRvIHNldCB0aGUgd2Vla2RheSB1cCBmcm9udCwgYXMgdGhlIGRheSBpcwogICAgICAvLyByZWxhdGl2ZSB0byBpdC4gVGhlIHNlY29uZCBjYXNlIGFsc28gbmVlZHMgdG8gYmUgaGFuZGxlZCB1cCBmcm9udCBmb3IKICAgICAgLy8gZm9ybWF0cyBsaWtlICJuZXh0IG1vbmRheSBhdCBtaWRuaWdodCIgd2hpY2ggd2lsbCBoYXZlIGl0cyB3ZWVrZGF5IHJlc2V0CiAgICAgIC8vIGlmIG5vdCBzZXQgdXAgZnJvbnQuIFRoZSBsYXN0IGNhc2Ugd2lsbCBzZXQgdXAgdGhlIHBhcmFtcyBuZWNlc3NhcnkgdG8KICAgICAgLy8gc2hpZnQgdGhlIHdlZWtkYXkgYW5kIGFsbG93IHNlcGFyYXRlQWJzb2x1dGVVbml0cyBiZWxvdyB0byBoYW5kbGUgc2V0dGluZwogICAgICAvLyBpdCBhZnRlciB0aGUgZGF0ZSBoYXMgYmVlbiBzaGlmdGVkLgogICAgICBpZihpc0RlZmluZWQoc2V0LndlZWtkYXkpKSB7CiAgICAgICAgaWYodW5pdEluZGV4ID09PSBNT05USF9JTkRFWCkgewogICAgICAgICAgc2V0T3JkaW5hbFdlZWtkYXkobnVtKTsKICAgICAgICAgIG51bSA9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHVwZGF0ZURhdGUoZGF0ZSwgeyB3ZWVrZGF5OiBzZXQud2Vla2RheSB9LCB0cnVlKTsKICAgICAgICAgIGRlbGV0ZSBzZXQud2Vla2RheTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChzZXQuaGFsZikgewogICAgICAgIC8vIEFsbG93IGxvY2FsaXplZCAiaGFsZiIgYXMgYSBzdGFuZGFsb25lIGNvbGxvcXVpYWxpc20uIFB1cnBvc2VseSBhdm9pZGluZwogICAgICAgIC8vIHRoZSBsb2NhbGUgbnVtYmVyIHN5c3RlbSB0byByZWR1Y2UgY29tcGxleGl0eS4gVGhlIHVuaXRzICJtb250aCIgYW5kCiAgICAgICAgLy8gIndlZWsiIGFyZSBwdXJwb3NlbHkgZXhjbHVkZWQgaW4gdGhlIEVuZ2xpc2ggZGF0ZSBmb3JtYXRzIGJlbG93LCBhcwogICAgICAgIC8vICJoYWxmIGEgd2VlayIgYW5kICJoYWxmIGEgbW9udGgiIGFyZSBtZWFuaW5nbGVzcyBhcyBleGFjdCBkYXRlcy4KICAgICAgICBudW0gKj0gc2V0LmhhbGY7CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZmluZWQoc2V0LnNoaWZ0KSkgewogICAgICAgIC8vIFNoaWZ0IGFuZCB1bml0LCBpZSAibmV4dCBtb250aCIsICJsYXN0IHdlZWsiLCBldGMuCiAgICAgICAgbnVtICo9IHNldC5zaGlmdDsKICAgICAgfSBlbHNlIGlmIChzZXQuc2lnbikgewogICAgICAgIC8vIFVuaXQgYW5kIHNpZ24sIGllICJtb250aHMgYWdvIiwgIndlZWtzIGZyb20gbm93IiwgZXRjLgogICAgICAgIG51bSAqPSBzZXQuc2lnbjsKICAgICAgfQoKICAgICAgaWYgKGlzRGVmaW5lZChzZXQuZGF5KSkgewogICAgICAgIC8vICJ0aGUgZGF5IGFmdGVyIHRvbW9ycm93IgogICAgICAgIG51bSArPSBzZXQuZGF5OwogICAgICAgIGRlbGV0ZSBzZXQuZGF5OwogICAgICB9CgogICAgICAvLyBGb3JtYXRzIGxpa2UgInRoZSAxNXRoIG9mIGxhc3QgbW9udGgiIG9yICI2OjMwcG0gb2YgbmV4dCB3ZWVrIgogICAgICAvLyBjb250YWluIGFic29sdXRlIHVuaXRzIGluIGFkZGl0aW9uIHRvIHJlbGF0aXZlIG9uZXMsIHNvIHNlcGFyYXRlCiAgICAgIC8vIHRoZW0gaGVyZSwgcmVtb3ZlIHRoZW0gZnJvbSB0aGUgcGFyYW1zLCBhbmQgc2V0IHVwIGEgY2FsbGJhY2sgdG8KICAgICAgLy8gc2V0IHRoZW0gYWZ0ZXIgdGhlIHJlbGF0aXZlIG9uZXMgaGF2ZSBiZWVuIHNldC4KICAgICAgc2VwYXJhdGVBYnNvbHV0ZVVuaXRzKHVuaXRJbmRleCk7CgogICAgICAvLyBGaW5hbGx5IHNoaWZ0IHRoZSB1bml0LgogICAgICBzZXRbRW5nbGlzaC51bml0c1t1bml0SW5kZXhdXSA9IG51bTsKICAgICAgcmVsYXRpdmUgPSB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUVkZ2UoZWRnZSwgcGFyYW1zKSB7CiAgICAgIHZhciBlZGdlSW5kZXggPSBwYXJhbXMudW5pdCwgd2Vla2RheU9mTW9udGg7CiAgICAgIGlmICghZWRnZUluZGV4KSB7CiAgICAgICAgLy8gSWYgd2UgaGF2ZSAidGhlIGVuZCBvZiBKYW51YXJ5IiwgdGhlbiB3ZSBuZWVkIHRvIGZpbmQgdGhlIHVuaXQgaW5kZXguCiAgICAgICAgaXRlcmF0ZU92ZXJIaWdoZXJEYXRlUGFyYW1zKHBhcmFtcywgZnVuY3Rpb24odW5pdE5hbWUsIHZhbCwgdW5pdCwgaSkgewogICAgICAgICAgaWYgKHVuaXROYW1lID09PSAnd2Vla2RheScgJiYgaXNEZWZpbmVkKHBhcmFtcy5tb250aCkpIHsKICAgICAgICAgICAgLy8gSWYgYm90aCBhIG1vbnRoIGFuZCB3ZWVrZGF5IGV4aXN0LCB0aGVuIHdlIGhhdmUgYSBmb3JtYXQgbGlrZQogICAgICAgICAgICAvLyAidGhlIGxhc3QgdHVlc2RheSBpbiBOb3ZlbWJlciwgMjAxMiIsIHdoZXJlIHRoZSAibGFzdCIgaXMgc3RpbGwKICAgICAgICAgICAgLy8gcmVsYXRpdmUgdG8gdGhlIGVuZCBvZiB0aGUgbW9udGgsIHNvIHByZXZlbnQgdGhlIHVuaXQgIndlZWtkYXkiCiAgICAgICAgICAgIC8vIGZyb20gdGFraW5nIG92ZXIuCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGVkZ2VJbmRleCA9IGk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGVkZ2VJbmRleCA9PT0gTU9OVEhfSU5ERVggJiYgaXNEZWZpbmVkKHBhcmFtcy53ZWVrZGF5KSkgewogICAgICAgIC8vIElmIGEgd2Vla2RheSBpbiBhIG1vbnRoIGV4aXN0cyAoYXMgZGVzY3JpYmVkIGFib3ZlKSwKICAgICAgICAvLyB0aGVuIHNldCBpdCB1cCB0byBiZSBzZXQgYWZ0ZXIgdGhlIGRhdGUgaGFzIGJlZW4gc2hpZnRlZC4KICAgICAgICB3ZWVrZGF5T2ZNb250aCA9IHBhcmFtcy53ZWVrZGF5OwogICAgICAgIGRlbGV0ZSBwYXJhbXMud2Vla2RheTsKICAgICAgfQogICAgICBhZnRlckRhdGVTZXQoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0b3BJbmRleDsKICAgICAgICAvLyAiZWRnZSIgdmFsdWVzIHRoYXQgYXJlIGF0IHRoZSB2ZXJ5IGVkZ2UgYXJlICIyIiBzbyB0aGUgYmVnaW5uaW5nIG9mIHRoZQogICAgICAgIC8vIHllYXIgaXMgLTIgYW5kIHRoZSBlbmQgb2YgdGhlIHllYXIgaXMgMi4gQ29udmVyc2VseSwgdGhlICJsYXN0IGRheSIgaXMKICAgICAgICAvLyBhY3R1YWxseSAwMDowMGFtIHNvIGl0IGlzIDEuIC0xIGlzIHJlc2VydmVkIGJ1dCB1bnVzZWQgZm9yIG5vdy4KICAgICAgICBpZiAoZWRnZSA8IDApIHsKICAgICAgICAgIG1vdmVUb0JlZ2lubmluZ09mVW5pdChkYXRlLCBlZGdlSW5kZXgsIGdldE93bihvcHRpb25zLCAnbG9jYWxlJykpOwogICAgICAgIH0gZWxzZSBpZiAoZWRnZSA+IDApIHsKICAgICAgICAgIGlmIChlZGdlID09PSAxKSB7CiAgICAgICAgICAgIHN0b3BJbmRleCA9IERBWV9JTkRFWDsKICAgICAgICAgICAgbW92ZVRvQmVnaW5uaW5nT2ZVbml0KGRhdGUsIERBWV9JTkRFWCk7CiAgICAgICAgICB9CiAgICAgICAgICBtb3ZlVG9FbmRPZlVuaXQoZGF0ZSwgZWRnZUluZGV4LCBnZXRPd24ob3B0aW9ucywgJ2xvY2FsZScpLCBzdG9wSW5kZXgpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNEZWZpbmVkKHdlZWtkYXlPZk1vbnRoKSkgewogICAgICAgICAgc2V0V2Vla2RheShkYXRlLCB3ZWVrZGF5T2ZNb250aCwgLWVkZ2UpOwogICAgICAgICAgcmVzZXRUaW1lKGRhdGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGlmIChlZGdlSW5kZXggPT09IE1PTlRIX0lOREVYKSB7CiAgICAgICAgcGFyYW1zLnNwZWNpZmljaXR5ID0gREFZX0lOREVYOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcmFtcy5zcGVjaWZpY2l0eSA9IGVkZ2VJbmRleCAtIDE7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzZXRPcmRpbmFsV2Vla2RheShudW0pIHsKICAgICAgLy8gSWYgd2UgaGF2ZSAidGhlIDJuZCBUdWVzZGF5IG9mIEp1bmUiLCB0aGVuIHBhc3MgdGhlICJ3ZWVrZGF5RGlyIgogICAgICAvLyBmbGFnIGFsb25nIHRvIHVwZGF0ZURhdGUgc28gdGhhdCB0aGUgZGF0ZSBkb2VzIG5vdCBhY2NpZGVudGFsbHkgdHJhdmVyc2UKICAgICAgLy8gaW50byB0aGUgcHJldmlvdXMgbW9udGguIFRoaXMgbmVlZHMgdG8gYmUgaW5kZXBlbmRlbnQgb2YgdGhlICJwcmVmZXIiCiAgICAgIC8vIGZsYWcgYmVjYXVzZSB3ZSBhcmUgb25seSBlbnN1cmluZyB0aGF0IHRoZSB3ZWVrZGF5IGlzIGluIHRoZSBmdXR1cmUsIG5vdAogICAgICAvLyB0aGUgZW50aXJlIGRhdGUuCiAgICAgIHNldC53ZWVrZGF5ID0gNyAqIChudW0gLSAxKSArIHNldC53ZWVrZGF5OwogICAgICBzZXQuZGF0ZSA9IDE7CiAgICAgIHdlZWtkYXlEaXIgPSAxOwogICAgfQoKICAgIGZ1bmN0aW9uIHNlcGFyYXRlQWJzb2x1dGVVbml0cyh1bml0SW5kZXgpIHsKICAgICAgdmFyIHBhcmFtczsKCiAgICAgIGl0ZXJhdGVPdmVyRGF0ZVBhcmFtcyhzZXQsIGZ1bmN0aW9uKG5hbWUsIHZhbCwgdW5pdCwgaSkgewogICAgICAgIC8vIElmIHRoZXJlIGlzIGEgdGltZSB1bml0IHNldCB0aGF0IGlzIG1vcmUgc3BlY2lmaWMgdGhhbgogICAgICAgIC8vIHRoZSBtYXRjaGVkIHVuaXQgd2UgaGF2ZSBhIHN0cmluZyBsaWtlICI1OjMwYW0gaW4gMiBtaW51dGVzIiwKICAgICAgICAvLyB3aGljaCBpcyBtZWFuaW5nbGVzcywgc28gaW52YWxpZGF0ZSB0aGUgZGF0ZS4uLgogICAgICAgIGlmIChpID49IHVuaXRJbmRleCkgewogICAgICAgICAgZGF0ZS5zZXRUaW1lKE5hTik7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIGlmIChpIDwgdW5pdEluZGV4KSB7CiAgICAgICAgICAvLyAuLi5vdGhlcndpc2Ugc2V0IHRoZSBwYXJhbXMgdG8gc2V0IHRoZSBhYnNvbHV0ZSBkYXRlCiAgICAgICAgICAvLyBhcyBhIGNhbGxiYWNrIGFmdGVyIHRoZSByZWxhdGl2ZSBkYXRlIGhhcyBiZWVuIHNldC4KICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgICAgIHBhcmFtc1tuYW1lXSA9IHZhbDsKICAgICAgICAgIGRlbGV0ZURhdGVQYXJhbShzZXQsIG5hbWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGlmIChwYXJhbXMpIHsKICAgICAgICBhZnRlckRhdGVTZXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB1cGRhdGVEYXRlKGRhdGUsIHBhcmFtcywgdHJ1ZSwgZmFsc2UsIGdldE93bihvcHRpb25zLCAncHJlZmVyJyksIHdlZWtkYXlEaXIpOwogICAgICAgIH0pOwogICAgICAgIGlmIChzZXQuZWRnZSkgewogICAgICAgICAgLy8gInRoZSBlbmQgb2YgTWFyY2ggb2YgbmV4dCB5ZWFyIgogICAgICAgICAgaGFuZGxlRWRnZShzZXQuZWRnZSwgcGFyYW1zKTsKICAgICAgICAgIGRlbGV0ZSBzZXQuZWRnZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoY29udGV4dERhdGUgJiYgZCkgewogICAgICAvLyBJZiBhIGNvbnRleHQgZGF0ZSBpcyBwYXNzZWQgKCJnZXQiIGFuZCAidW5pdHNGcm9tTm93IiksCiAgICAgIC8vIHRoZW4gdXNlIGl0IGFzIHRoZSBzdGFydGluZyBwb2ludC4KICAgICAgZGF0ZSA9IGNsb25lRGF0ZUJ5RmxhZyhjb250ZXh0RGF0ZSwgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBkYXRlID0gZ2V0TmV3RGF0ZSgpOwogICAgfQoKICAgIF91dGMoZGF0ZSwgZ2V0T3duKG9wdGlvbnMsICdmcm9tVVRDJykpOwoKICAgIGlmIChpc1N0cmluZyhkKSkgewogICAgICBkYXRlID0gcGFyc2VTdHJpbmdEYXRlKGQpOwogICAgfSBlbHNlIGlmIChpc0RhdGUoZCkpIHsKICAgICAgZGF0ZSA9IGNsb25lRGF0ZUJ5RmxhZyhkLCBoYXNPd24ob3B0aW9ucywgJ2Nsb25lJykgfHwgZm9yY2VDbG9uZSk7CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0VHlwZShkKSkgewogICAgICBzZXQgPSBzaW1wbGVDbG9uZShkKTsKICAgICAgdXBkYXRlRGF0ZShkYXRlLCBzZXQsIHRydWUpOwogICAgfSBlbHNlIGlmIChpc051bWJlcihkKSB8fCBkID09PSBudWxsKSB7CiAgICAgIGRhdGUuc2V0VGltZShkKTsKICAgIH0KICAgIC8vIEEgZGF0ZSBjcmVhdGVkIGJ5IHBhcnNpbmcgYSBzdHJpbmcgcHJlc3VtZXMgdGhhdCB0aGUgZm9ybWF0ICppdHNlbGYqIGlzCiAgICAvLyBVVEMsIGJ1dCBub3QgdGhhdCB0aGUgZGF0ZSwgb25jZSBjcmVhdGVkLCBzaG91bGQgYmUgbWFuaXB1bGF0ZWQgYXMgc3VjaC4gSW4KICAgIC8vIG90aGVyIHdvcmRzLCBpZiB5b3UgYXJlIGNyZWF0aW5nIGEgZGF0ZSBvYmplY3QgZnJvbSBhIHNlcnZlciB0aW1lCiAgICAvLyAiMjAxMi0xMS0xNVQxMjowMDowMFoiLCBpbiB0aGUgbWFqb3JpdHkgb2YgY2FzZXMgeW91IGFyZSB1c2luZyBpdCB0byBjcmVhdGUKICAgIC8vIGEgZGF0ZSB0aGF0IHdpbGwsIGFmdGVyIGNyZWF0aW9uLCBiZSBtYW5pcHVsYXRlZCBhcyBsb2NhbCwgc28gcmVzZXQgdGhlIHV0YwogICAgLy8gZmxhZyBoZXJlIHVubGVzcyAic2V0VVRDIiBpcyBhbHNvIHNldC4KICAgIF91dGMoZGF0ZSwgISFnZXRPd24ob3B0aW9ucywgJ3NldFVUQycpKTsKICAgIHJldHVybiB7CiAgICAgIHNldDogc2V0LAogICAgICBkYXRlOiBkYXRlCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlRGF0ZShkLCBwYXJhbXMsIHJlc2V0LCBhZHZhbmNlLCBwcmVmZXIsIHdlZWtkYXlEaXIpIHsKICAgIHZhciB1cHBlclVuaXRJbmRleDsKCiAgICBmdW5jdGlvbiBzZXRVcHBlclVuaXQodW5pdE5hbWUsIHVuaXRJbmRleCkgewogICAgICBpZiAocHJlZmVyICYmICF1cHBlclVuaXRJbmRleCkgewogICAgICAgIGlmICh1bml0TmFtZSA9PT0gJ3dlZWtkYXknKSB7CiAgICAgICAgICB1cHBlclVuaXRJbmRleCA9IFdFRUtfSU5ERVg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHVwcGVyVW5pdEluZGV4ID0gZ2V0SGlnaGVyVW5pdEluZGV4KHVuaXRJbmRleCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2V0U3BlY2lmaWNpdHkodW5pdEluZGV4KSB7CiAgICAgIC8vIE90aGVyIGZ1bmN0aW9ucyBtYXkgcHJlZW1wdGl2ZWx5IHNldCB0aGUgc3BlY2lmaWNpdHkgYmVmb3JlIGFycml2aW5nCiAgICAgIC8vIGhlcmUgc28gY29uY2VkZSB0byB0aGVtIGlmIHRoZXkgaGF2ZSBhbHJlYWR5IHNldCBtb3JlIHNwZWNpZmljIHVuaXRzLgogICAgICBpZiAodW5pdEluZGV4ID4gcGFyYW1zLnNwZWNpZmljaXR5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHBhcmFtcy5zcGVjaWZpY2l0eSA9IHVuaXRJbmRleDsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5EaXNhbWJpZ3VhdGUoKSB7CiAgICAgIGlmICghdXBwZXJVbml0SW5kZXggfHwgdXBwZXJVbml0SW5kZXggPiBZRUFSX0lOREVYKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHN3aXRjaChwcmVmZXIpIHsKICAgICAgICBjYXNlIC0xOiByZXR1cm4gZCA+IGdldE5ld0RhdGUoKTsKICAgICAgICBjYXNlICAxOiByZXR1cm4gZCA8IGdldE5ld0RhdGUoKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRpc2FtYmlndWF0ZUhpZ2hlclVuaXQoKSB7CiAgICAgIHZhciB1bml0ID0gRGF0ZVVuaXRzW3VwcGVyVW5pdEluZGV4XTsKICAgICAgYWR2YW5jZSA9IHByZWZlcjsKICAgICAgc2V0VW5pdCh1bml0Lm5hbWUsIDEsIHVuaXQsIHVwcGVyVW5pdEluZGV4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVGcmFjdGlvbih1bml0LCB1bml0SW5kZXgsIGZyYWN0aW9uKSB7CiAgICAgIGlmICh1bml0SW5kZXgpIHsKICAgICAgICB2YXIgbG93ZXJVbml0ID0gRGF0ZVVuaXRzW2dldExvd2VyVW5pdEluZGV4KHVuaXRJbmRleCldOwogICAgICAgIHZhciB2YWwgPSByb3VuZCh1bml0Lm11bHRpcGxpZXIgLyBsb3dlclVuaXQubXVsdGlwbGllciAqIGZyYWN0aW9uKTsKICAgICAgICBwYXJhbXNbbG93ZXJVbml0Lm5hbWVdID0gdmFsOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbW9udGhIYXNTaGlmdGVkKGQsIHRhcmdldE1vbnRoKSB7CiAgICAgIGlmICh0YXJnZXRNb250aCA8IDApIHsKICAgICAgICB0YXJnZXRNb250aCA9IHRhcmdldE1vbnRoICUgMTIgKyAxMjsKICAgICAgfQogICAgICByZXR1cm4gdGFyZ2V0TW9udGggJSAxMiAhPT0gZ2V0TW9udGgoZCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0VW5pdCh1bml0TmFtZSwgdmFsdWUsIHVuaXQsIHVuaXRJbmRleCkgewogICAgICB2YXIgbWV0aG9kID0gdW5pdC5tZXRob2QsIGNoZWNrTW9udGgsIGZyYWN0aW9uOwoKICAgICAgc2V0VXBwZXJVbml0KHVuaXROYW1lLCB1bml0SW5kZXgpOwogICAgICBzZXRTcGVjaWZpY2l0eSh1bml0SW5kZXgpOwoKICAgICAgZnJhY3Rpb24gPSB2YWx1ZSAlIDE7CiAgICAgIGlmIChmcmFjdGlvbikgewogICAgICAgIGhhbmRsZUZyYWN0aW9uKHVuaXQsIHVuaXRJbmRleCwgZnJhY3Rpb24pOwogICAgICAgIHZhbHVlID0gdHJ1bmModmFsdWUpOwogICAgICB9CgogICAgICBpZiAodW5pdE5hbWUgPT09ICd3ZWVrZGF5JykgewogICAgICAgIGlmICghYWR2YW5jZSkgewogICAgICAgICAgLy8gV2Vla2RheXMgYXJlIGFsd2F5cyBjb25zaWRlcmVkIGFic29sdXRlIHVuaXRzIHNvIHNpbXBseSBzZXQgdGhlbQogICAgICAgICAgLy8gaGVyZSBldmVuIGlmIGl0IGlzIGFuICJhZHZhbmNlIiBvcGVyYXRpb24uIFRoaXMgaXMgdG8gaGVscCBhdm9pZAogICAgICAgICAgLy8gYW1iaWd1b3VzIG1lYW5pbmdzIGluICJhZHZhbmNlIiBhcyB3ZWxsIGFzIHRvIG5lYXRseSBhbGxvdyBmb3JtYXRzCiAgICAgICAgICAvLyBsaWtlICJXZWRuZXNkYXkgb2YgbmV4dCB3ZWVrIiB3aXRob3V0IG1vcmUgY29tcGxleCBsb2dpYy4KICAgICAgICAgIHNldFdlZWtkYXkoZCwgdmFsdWUsIHdlZWtkYXlEaXIpOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY2hlY2tNb250aCA9IHVuaXRJbmRleCA9PT0gTU9OVEhfSU5ERVggJiYgZ2V0RGF0ZShkKSA+IDI4OwoKICAgICAgLy8gSWYgd2UgYXJlIGFkdmFuY2luZyBvciByZXdpbmRpbmcsIHRoZW4gd2UgbmVlZCB3ZSBuZWVkIHRvIHNldCB0aGUKICAgICAgLy8gYWJzb2x1dGUgdGltZSBpZiB0aGUgdW5pdCBpcyAiaG91cnMiIG9yIGxlc3MuIFRoaXMgaXMgZHVlIHRvIHRoZSBmYWN0CiAgICAgIC8vIHRoYXQgc2V0dGluZyBieSBtZXRob2QgaXMgYW1iaWd1b3VzIGR1cmluZyBEU1Qgc2hpZnRzLiBGb3IgZXhhbXBsZSwKICAgICAgLy8gMTowMGFtIG9uIE5vdmVtYmVyIDFzdCAyMDE1IG9jY3VycyB0d2ljZSBpbiBOb3J0aCBBbWVyaWNhbiB0aW1lem9uZXMKICAgICAgLy8gd2l0aCBEU1QsIHRoZSBzZWNvbmQgdGltZSBiZWluZyBhZnRlciB0aGUgY2xvY2tzIGFyZSByb2xsZWQgYmFjayBhdAogICAgICAvLyAyOjAwYW0uIFdoZW4gc3ByaW5naW5nIGZvcndhcmQgdGhpcyBpcyBhdXRvbWF0aWNhbGx5IGhhbmRsZWQgYXMgdGhlcmUKICAgICAgLy8gaXMgbm8gMjowMGFtIHNvIHRoZSBkYXRlIGF1dG9tYXRpY2FsbHkganVtcHMgdG8gMzowMGFtLiBIb3dldmVyLCB3aGVuCiAgICAgIC8vIHJvbGxpbmcgYmFjaywgc2V0SG91cnMoMikgd2lsbCBhbHdheXMgY2hvb3NlIHRoZSBmaXJzdCAiMmFtIiBldmVuIGlmCiAgICAgIC8vIHRoZSBkYXRlIGlzIGN1cnJlbnRseSBzZXQgdG8gdGhlIHNlY29uZCwgY2F1c2luZyB1bmludGVuZGVkIGp1bXBzLgogICAgICAvLyBUaGlzIGFtYmlndWl0eSBpcyB1bmF2b2lkYWJsZSB3aGVuIHNldHRpbmcgZGF0ZXMgYXMgdGhlIG5vdGF0aW9uIGlzCiAgICAgIC8vIGFtYmlndW91cy4gSG93ZXZlciB3aGVuIGFkdmFuY2luZywgd2UgY2xlYXJseSB3YW50IHRoZSByZXN1bHRpbmcgZGF0ZQogICAgICAvLyB0byBiZSBhbiBhY3V0YWwgaG91ciBhaGVhZCwgd2hpY2ggY2FuIG9ubHkgYmUgYWNjb21wbGlzaGVkIGJ5IHNldHRpbmcKICAgICAgLy8gdGhlIGFic29sdXRlIHRpbWUuIENvbnZlcnNlbHksIGFueSB1bml0IGhpZ2hlciB0aGFuICJob3VycyIgTVVTVCB1c2UKICAgICAgLy8gdGhlIGludGVybmFsIHNldCBtZXRob2RzLCBhcyB0aGV5IGFyZSBhbWJpZ3VvdXMgYXMgYWJzb2x1dGUgdW5pdHMgb2YKICAgICAgLy8gdGltZS4gWWVhcnMgbWF5IGJlIDM2NSBvciAzNjYgZGF5cyBkZXBlbmRpbmcgb24gbGVhcCB5ZWFycywgbW9udGhzIGFyZQogICAgICAvLyBhbGwgb3ZlciB0aGUgcGxhY2UsIGFuZCBldmVuIGRheXMgbWF5IGJlIDIzLTI1IGhvdXJzIGRlcGVuZGluZyBvbiBEU1QKICAgICAgLy8gc2hpZnRzLiBGaW5hbGx5LCBub3RlIHRoYXQgdGhlIGtpbmQgb2YganVtcGluZyBkZXNjcmliZWQgYWJvdmUgd2lsbAogICAgICAvLyBvY2N1ciB3aGVuIGNhbGxpbmcgQU5ZICJzZXQiIG1ldGhvZCBvbiB0aGUgZGF0ZSBhbmQgd2lsbCBvY2N1ciBldmVuIGlmCiAgICAgIC8vIHRoZSB2YWx1ZSBiZWluZyBzZXQgaXMgaWRlbnRpY2FsIHRvIHRoZSBvbmUgY3VycmVudGx5IHNldCAoaS5lLgogICAgICAvLyBzZXRIb3VycygyKSBvbiBhIGRhdGUgYXQgMmFtIG1heSBub3QgYmUgYSBub29wKS4gVGhpcyBpcyBwcmVjYXJpb3VzLAogICAgICAvLyBzbyBhdm9pZGluZyB0aGlzIHNpdHVhdGlvbiBpbiBjYWxsRGF0ZVNldCBieSBjaGVja2luZyB1cCBmcm9udCB0aGF0CiAgICAgIC8vIHRoZSB2YWx1ZSBpcyBub3QgdGhlIHNhbWUgYmVmb3JlIHNldHRpbmcuCiAgICAgIGlmIChhZHZhbmNlICYmICF1bml0LmFtYmlndW91cykgewogICAgICAgIGQuc2V0VGltZShkLmdldFRpbWUoKSArICh2YWx1ZSAqIGFkdmFuY2UgKiB1bml0Lm11bHRpcGxpZXIpKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAoYWR2YW5jZSkgewogICAgICAgIGlmICh1bml0SW5kZXggPT09IFdFRUtfSU5ERVgpIHsKICAgICAgICAgIHZhbHVlICo9IDc7CiAgICAgICAgICBtZXRob2QgPSBEYXRlVW5pdHNbREFZX0lOREVYXS5tZXRob2Q7CiAgICAgICAgfQogICAgICAgIHZhbHVlID0gKHZhbHVlICogYWR2YW5jZSkgKyBjYWxsRGF0ZUdldChkLCBtZXRob2QpOwogICAgICB9CiAgICAgIGNhbGxEYXRlU2V0V2l0aFdlZWsoZCwgbWV0aG9kLCB2YWx1ZSwgYWR2YW5jZSk7CiAgICAgIGlmIChjaGVja01vbnRoICYmIG1vbnRoSGFzU2hpZnRlZChkLCB2YWx1ZSkpIHsKICAgICAgICAvLyBBcyB3ZSBhcmUgc2V0dGluZyB0aGUgdW5pdHMgaW4gcmV2ZXJzZSBvcmRlciwgdGhlcmUgaXMgYSBjaGFuY2UgdGhhdAogICAgICAgIC8vIG91ciBkYXRlIG1heSBhY2NpZGVudGFsbHkgdHJhdmVyc2UgaW50byBhIG5ldyBtb250aCwgc3VjaCBhcyBzZXR0aW5nCiAgICAgICAgLy8geyBtb250aDogMSwgZGF0ZSAxNSB9IG9uIEphbnVhcnkgMzFzdC4gQ2hlY2sgZm9yIHRoaXMgaGVyZSBhbmQgcmVzZXQKICAgICAgICAvLyB0aGUgZGF0ZSB0byB0aGUgbGFzdCBkYXkgb2YgdGhlIHByZXZpb3VzIG1vbnRoIGlmIHRoaXMgaGFzIGhhcHBlbmVkLgogICAgICAgIHNldERhdGUoZCwgMCk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNOdW1iZXIocGFyYW1zKSAmJiBhZHZhbmNlKSB7CiAgICAgIC8vIElmIHBhcmFtIGlzIGEgbnVtYmVyIGFuZCBhZHZhbmNpbmcsIHRoZSBudW1iZXIgaXMgaW4gbWlsbGlzZWNvbmRzLgogICAgICBwYXJhbXMgPSB7IG1pbGxpc2Vjb25kOiBwYXJhbXMgfTsKICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIocGFyYW1zKSkgewogICAgICAvLyBPdGhlcndpc2UganVzdCBzZXQgdGhlIHRpbWVzdGFtcCBhbmQgcmV0dXJuLgogICAgICBkLnNldFRpbWUocGFyYW1zKTsKICAgICAgcmV0dXJuIGQ7CiAgICB9CgogICAgaXRlcmF0ZU92ZXJEYXRlUGFyYW1zKHBhcmFtcywgc2V0VW5pdCk7CgogICAgaWYgKHJlc2V0ICYmIHBhcmFtcy5zcGVjaWZpY2l0eSkgewogICAgICByZXNldExvd2VyVW5pdHMoZCwgcGFyYW1zLnNwZWNpZmljaXR5KTsKICAgIH0KCiAgICAvLyBJZiBwYXN0IG9yIGZ1dHVyZSBpcyBwcmVmZXJyZWQsIHRoZW4gdGhlIHByb2Nlc3Mgb2YgImRpc2FtYmlndWF0aW9uIiB3aWxsCiAgICAvLyBlbnN1cmUgdGhhdCBhbiBhbWJpZ3VvdXMgdGltZS9kYXRlICgiNHBtIiwgInRodXJzZGF5IiwgIkp1bmUiLCBldGMuKSB3aWxsCiAgICAvLyBiZSBpbiB0aGUgcGFzdCBvciBmdXR1cmUuIFdlZWtzIGFyZSBvbmx5IGNvbnNpZGVyZWQgYW1iaWd1b3VzIGlmIHRoZXJlIGlzCiAgICAvLyBhIHdlZWtkYXksIGkuZS4gInRodXJzZGF5IiBpcyBhbiBhbWJpZ3VvdXMgd2VlaywgYnV0ICJ0aGUgNHRoIiBpcyBhbgogICAgLy8gYW1iaWd1b3VzIG1vbnRoLgogICAgaWYgKGNhbkRpc2FtYmlndWF0ZSgpKSB7CiAgICAgIGRpc2FtYmlndWF0ZUhpZ2hlclVuaXQoKTsKICAgIH0KICAgIHJldHVybiBkOwogIH0KCiAgLy8gTG9jYWxlcwoKICAvLyBMb2NhbGUgaGVscGVycwogIHZhciBFbmdsaXNoLCBsb2NhbGVNYW5hZ2VyOwoKICBmdW5jdGlvbiBnZXRFbmdsaXNoVmFyaWFudCh2KSB7CiAgICByZXR1cm4gc2ltcGxlTWVyZ2Uoc2ltcGxlQ2xvbmUoRW5nbGlzaExvY2FsZUJhc2VEZWZpbml0aW9uKSwgdik7CiAgfQoKICBmdW5jdGlvbiBhcnJheVRvUmVnQWx0ZXJuYXRlcyhhcnIpIHsKICAgIHZhciBqb2luZWQgPSBhcnIuam9pbignJyk7CiAgICBpZiAoIWFyciB8fCAhYXJyLmxlbmd0aCkgewogICAgICByZXR1cm4gJyc7CiAgICB9CiAgICBpZiAoam9pbmVkLmxlbmd0aCA9PT0gYXJyLmxlbmd0aCkgewogICAgICByZXR1cm4gJ1snICsgam9pbmVkICsgJ10nOwogICAgfQogICAgLy8gbWFwIGhhbmRsZXMgc3BhcnNlIGFycmF5cyBzbyBubyBuZWVkIHRvIGNvbXBhY3QgdGhlIGFycmF5IGhlcmUuCiAgICByZXR1cm4gbWFwKGFyciwgZXNjYXBlUmVnRXhwKS5qb2luKCd8Jyk7CiAgfQoKICBmdW5jdGlvbiBnZXRSZWdOb25DYXB0dXJpbmcoc3JjLCBvcHQpIHsKICAgIGlmIChzcmMubGVuZ3RoID4gMSkgewogICAgICBzcmMgPSAnKD86JyArIHNyYyArICcpJzsKICAgIH0KICAgIGlmIChvcHQpIHsKICAgICAgc3JjICs9ICc/JzsKICAgIH0KICAgIHJldHVybiBzcmM7CiAgfQoKICBmdW5jdGlvbiBnZXRQYXJzaW5nVG9rZW5XaXRoU3VmZml4KGZpZWxkLCBzcmMsIHN1ZmZpeCkgewogICAgdmFyIHRva2VuID0gTG9jYWxpemVkUGFyc2luZ1Rva2Vuc1tmaWVsZF07CiAgICBpZiAodG9rZW4ucmVxdWlyZXNTdWZmaXgpIHsKICAgICAgc3JjID0gZ2V0UmVnTm9uQ2FwdHVyaW5nKHNyYyArIGdldFJlZ05vbkNhcHR1cmluZyhzdWZmaXgpKTsKICAgIH0gZWxzZSBpZiAodG9rZW4ucmVxdWlyZXNTdWZmaXhPcikgewogICAgICBzcmMgKz0gZ2V0UmVnTm9uQ2FwdHVyaW5nKHRva2VuLnJlcXVpcmVzU3VmZml4T3IgKyAnfCcgKyBzdWZmaXgpOwogICAgfSBlbHNlIHsKICAgICAgc3JjICs9IGdldFJlZ05vbkNhcHR1cmluZyhzdWZmaXgsIHRydWUpOwogICAgfQogICAgcmV0dXJuIHNyYzsKICB9CgogIGZ1bmN0aW9uIGdldEFycmF5V2l0aE9mZnNldChhcnIsIG4sIGFsdGVybmF0ZSwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsOwogICAgaWYgKGFsdGVybmF0ZSA+IDEpIHsKICAgICAgdmFsID0gYXJyW24gKyAoYWx0ZXJuYXRlIC0gMSkgKiBvZmZzZXRdOwogICAgfQogICAgcmV0dXJuIHZhbCB8fCBhcnJbbl07CiAgfQoKICBmdW5jdGlvbiBidWlsZExvY2FsZXMoKSB7CgogICAgZnVuY3Rpb24gTG9jYWxlTWFuYWdlcihsb2MpIHsKICAgICAgdGhpcy5sb2NhbGVzID0ge307CiAgICAgIHRoaXMuYWRkKGxvYyk7CiAgICB9CgogICAgTG9jYWxlTWFuYWdlci5wcm90b3R5cGUgPSB7CgogICAgICBnZXQ6IGZ1bmN0aW9uKGNvZGUsIGZhbGxiYWNrKSB7CiAgICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYWxlc1tjb2RlXTsKICAgICAgICBpZiAoIWxvYyAmJiBMYXp5TG9hZGVkTG9jYWxlc1tjb2RlXSkgewogICAgICAgICAgbG9jID0gdGhpcy5hZGQoY29kZSwgTGF6eUxvYWRlZExvY2FsZXNbY29kZV0pOwogICAgICAgIH0gZWxzZSBpZiAoIWxvYyAmJiBjb2RlKSB7CiAgICAgICAgICBsb2MgPSB0aGlzLmxvY2FsZXNbY29kZS5zbGljZSgwLCAyKV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBsb2MgfHwgZmFsbGJhY2sgPT09IGZhbHNlID8gbG9jIDogdGhpcy5jdXJyZW50OwogICAgICB9LAoKICAgICAgZ2V0QWxsOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVzOwogICAgICB9LAoKICAgICAgc2V0OiBmdW5jdGlvbihjb2RlKSB7CiAgICAgICAgdmFyIGxvYyA9IHRoaXMuZ2V0KGNvZGUsIGZhbHNlKTsKICAgICAgICBpZiAoIWxvYykgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBMb2NhbGU6ICcgKyBjb2RlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudCA9IGxvYzsKICAgICAgfSwKCiAgICAgIGFkZDogZnVuY3Rpb24oY29kZSwgZGVmKSB7CiAgICAgICAgaWYgKCFkZWYpIHsKICAgICAgICAgIGRlZiA9IGNvZGU7CiAgICAgICAgICBjb2RlID0gZGVmLmNvZGU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlZi5jb2RlID0gY29kZTsKICAgICAgICB9CiAgICAgICAgdmFyIGxvYyA9IGRlZi5jb21waWxlZEZvcm1hdHMgPyBkZWYgOiBnZXROZXdMb2NhbGUoZGVmKTsKICAgICAgICB0aGlzLmxvY2FsZXNbY29kZV0gPSBsb2M7CiAgICAgICAgaWYgKCF0aGlzLmN1cnJlbnQpIHsKICAgICAgICAgIHRoaXMuY3VycmVudCA9IGxvYzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxvYzsKICAgICAgfSwKCiAgICAgIHJlbW92ZTogZnVuY3Rpb24oY29kZSkgewogICAgICAgIGlmICh0aGlzLmN1cnJlbnQuY29kZSA9PT0gY29kZSkgewogICAgICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5nZXQoJ2VuJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWxldGUgdGhpcy5sb2NhbGVzW2NvZGVdOwogICAgICB9CgogICAgfTsKCiAgICAvLyBTb3JyeSBhYm91dCB0aGlzIGd1eXMuLi4KICAgIEVuZ2xpc2ggPSBnZXROZXdMb2NhbGUoQW1lcmljYW5FbmdsaXNoRGVmaW5pdGlvbik7CiAgICBsb2NhbGVNYW5hZ2VyID0gbmV3IExvY2FsZU1hbmFnZXIoRW5nbGlzaCk7CiAgfQoKICBmdW5jdGlvbiBnZXROZXdMb2NhbGUoZGVmKSB7CgogICAgZnVuY3Rpb24gTG9jYWxlKGRlZikgewogICAgICB0aGlzLmluaXQoZGVmKTsKICAgIH0KCiAgICBMb2NhbGUucHJvdG90eXBlID0gewoKICAgICAgZ2V0TW9udGhOYW1lOiBmdW5jdGlvbihuLCBhbHRlcm5hdGUpIHsKICAgICAgICBpZiAodGhpcy5tb250aFN1ZmZpeCkgewogICAgICAgICAgcmV0dXJuIChuICsgMSkgKyB0aGlzLm1vbnRoU3VmZml4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0QXJyYXlXaXRoT2Zmc2V0KHRoaXMubW9udGhzLCBuLCBhbHRlcm5hdGUsIDEyKTsKICAgICAgfSwKCiAgICAgIGdldFdlZWtkYXlOYW1lOiBmdW5jdGlvbihuLCBhbHRlcm5hdGUpIHsKICAgICAgICByZXR1cm4gZ2V0QXJyYXlXaXRoT2Zmc2V0KHRoaXMud2Vla2RheXMsIG4sIGFsdGVybmF0ZSwgNyk7CiAgICAgIH0sCgogICAgICBnZXRUb2tlblZhbHVlOiBmdW5jdGlvbihmaWVsZCwgc3RyKSB7CiAgICAgICAgdmFyIG1hcCA9IHRoaXNbZmllbGQgKyAnTWFwJ10sIHZhbDsKICAgICAgICBpZiAobWFwKSB7CiAgICAgICAgICB2YWwgPSBtYXBbc3RyXTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbCkpIHsKICAgICAgICAgIHZhbCA9IHRoaXMuZ2V0TnVtYmVyKHN0cik7CiAgICAgICAgICBpZiAoZmllbGQgPT09ICdtb250aCcpIHsKICAgICAgICAgICAgLy8gTW9udGhzIGFyZSB0aGUgb25seSBudW1lcmljIGRhdGUgZmllbGQKICAgICAgICAgICAgLy8gd2hvc2UgdmFsdWUgaXMgbm90IHRoZSBzYW1lIGFzIGl0cyBudW1iZXIuCiAgICAgICAgICAgIHZhbCAtPSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsOwogICAgICB9LAoKICAgICAgZ2V0TnVtYmVyOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICB2YXIgbnVtID0gdGhpcy5udW1lcmFsTWFwW3N0cl07CiAgICAgICAgaWYgKGlzRGVmaW5lZChudW0pKSB7CiAgICAgICAgICByZXR1cm4gbnVtOwogICAgICAgIH0KICAgICAgICAvLyBUaGUgdW5hcnkgcGx1cyBvcGVyYXRvciBoZXJlIHNob3cgYmV0dGVyIHBlcmZvcm1hbmNlIGFuZCBoYW5kbGVzCiAgICAgICAgLy8gZXZlcnkgZm9ybWF0IHRoYXQgcGFyc2VGbG9hdCBkb2VzIHdpdGggdGhlIGV4Y2VwdGlvbiBvZiB0cmFpbGluZwogICAgICAgIC8vIGNoYXJhY3RlcnMsIHdoaWNoIGFyZSBndWFyYW50ZWVkIG5vdCB0byBiZSBpbiBvdXIgc3RyaW5nIGF0IHRoaXMgcG9pbnQuCiAgICAgICAgbnVtID0gK3N0ci5yZXBsYWNlKC8sLywgJy4nKTsKICAgICAgICBpZiAoIWlzTmFOKG51bSkpIHsKICAgICAgICAgIHJldHVybiBudW07CiAgICAgICAgfQogICAgICAgIG51bSA9IHRoaXMuZ2V0TnVtZXJhbFZhbHVlKHN0cik7CiAgICAgICAgaWYgKCFpc05hTihudW0pKSB7CiAgICAgICAgICB0aGlzLm51bWVyYWxNYXBbc3RyXSA9IG51bTsKICAgICAgICAgIHJldHVybiBudW07CiAgICAgICAgfQogICAgICAgIHJldHVybiBudW07CiAgICAgIH0sCgogICAgICBnZXROdW1lcmFsVmFsdWU6IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHZhciBwbGFjZSA9IDEsIG51bSA9IDAsIGxhc3RXYXNQbGFjZSwgaXNQbGFjZSwgbnVtZXJhbCwgZGlnaXQsIGFycjsKICAgICAgICAvLyBOb3RlIHRoYXQgIm51bWVyYWxzIiB0aGF0IG5lZWQgdG8gYmUgY29udmVydGVkIHRocm91Z2ggdGhpcyBtZXRob2QgYXJlCiAgICAgICAgLy8gYWxsIGNvbnNpZGVyZWQgdG8gYmUgc2luZ2xlIGNoYXJhY3RlcnMgaW4gb3JkZXIgdG8gaGFuZGxlIENKSy4gVGhpcwogICAgICAgIC8vIG1ldGhvZCBpcyBieSBubyBtZWFucyB1bmlxdWUgdG8gQ0pLLCBidXQgdGhlIGNvbXBsZXhpdHkgb2YgaGFuZGxpbmcKICAgICAgICAvLyBpbmZsZWN0aW9ucyBpbiBub24tQ0pLIGxhbmd1YWdlcyBhZGRzIHRvbyBtdWNoIG92ZXJoZWFkIGZvciBub3QgZW5vdWdoCiAgICAgICAgLy8gdmFsdWUsIHNvIGF2b2lkaW5nIGZvciBub3cuCiAgICAgICAgYXJyID0gc3RyLnNwbGl0KCcnKTsKICAgICAgICBmb3IgKHZhciBpID0gYXJyLmxlbmd0aCAtIDE7IG51bWVyYWwgPSBhcnJbaV07IGktLSkgewogICAgICAgICAgZGlnaXQgPSBnZXRPd24odGhpcy5udW1lcmFsTWFwLCBudW1lcmFsKTsKICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChkaWdpdCkpIHsKICAgICAgICAgICAgZGlnaXQgPSBnZXRPd24oZnVsbFdpZHRoTnVtYmVyTWFwLCBudW1lcmFsKSB8fCAwOwogICAgICAgICAgfQogICAgICAgICAgaXNQbGFjZSA9IGRpZ2l0ID4gMCAmJiBkaWdpdCAlIDEwID09PSAwOwogICAgICAgICAgaWYgKGlzUGxhY2UpIHsKICAgICAgICAgICAgaWYgKGxhc3RXYXNQbGFjZSkgewogICAgICAgICAgICAgIG51bSArPSBwbGFjZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaSkgewogICAgICAgICAgICAgIHBsYWNlID0gZGlnaXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbnVtICs9IGRpZ2l0OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBudW0gKz0gZGlnaXQgKiBwbGFjZTsKICAgICAgICAgICAgcGxhY2UgKj0gMTA7CiAgICAgICAgICB9CiAgICAgICAgICBsYXN0V2FzUGxhY2UgPSBpc1BsYWNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVtOwogICAgICB9LAoKICAgICAgZ2V0T3JkaW5hbDogZnVuY3Rpb24obikgewogICAgICAgIHZhciBzdWZmaXggPSB0aGlzLm9yZGluYWxTdWZmaXg7CiAgICAgICAgcmV0dXJuIHN1ZmZpeCB8fCBnZXRPcmRpbmFsU3VmZml4KG4pOwogICAgICB9LAoKICAgICAgZ2V0UmVsYXRpdmVGb3JtYXQ6IGZ1bmN0aW9uKGFkdSwgdHlwZSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbnZlcnRBZGp1c3RlZFRvRm9ybWF0KGFkdSwgdHlwZSk7CiAgICAgIH0sCgogICAgICBnZXREdXJhdGlvbjogZnVuY3Rpb24obXMpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb252ZXJ0QWRqdXN0ZWRUb0Zvcm1hdChnZXRBZGp1c3RlZFVuaXRGb3JOdW1iZXIobWF4KDAsIG1zKSksICdkdXJhdGlvbicpOwogICAgICB9LAoKICAgICAgZ2V0Rmlyc3REYXlPZldlZWs6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB2YWwgPSB0aGlzLmZpcnN0RGF5T2ZXZWVrOwogICAgICAgIHJldHVybiBpc0RlZmluZWQodmFsKSA/IHZhbCA6IElTT19GSVJTVF9EQVlfT0ZfV0VFSzsKICAgICAgfSwKCiAgICAgIGdldEZpcnN0RGF5T2ZXZWVrWWVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmlyc3REYXlPZldlZWtZZWFyIHx8IElTT19GSVJTVF9EQVlfT0ZfV0VFS19ZRUFSOwogICAgICB9LAoKICAgICAgY29udmVydEFkanVzdGVkVG9Gb3JtYXQ6IGZ1bmN0aW9uKGFkdSwgdHlwZSkgewogICAgICAgIHZhciBzaWduLCB1bml0LCBtdWx0LAogICAgICAgICAgICBudW0gICAgPSBhZHVbMF0sCiAgICAgICAgICAgIHUgICAgICA9IGFkdVsxXSwKICAgICAgICAgICAgbXMgICAgID0gYWR1WzJdLAogICAgICAgICAgICBmb3JtYXQgPSB0aGlzW3R5cGVdIHx8IHRoaXMucmVsYXRpdmU7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm9ybWF0KSkgewogICAgICAgICAgcmV0dXJuIGZvcm1hdC5jYWxsKHRoaXMsIG51bSwgdSwgbXMsIHR5cGUpOwogICAgICAgIH0KICAgICAgICBtdWx0ID0gIXRoaXMucGx1cmFsIHx8IG51bSA9PT0gMSA/IDAgOiAxOwogICAgICAgIHVuaXQgPSB0aGlzLnVuaXRzW211bHQgKiA4ICsgdV0gfHwgdGhpcy51bml0c1t1XTsKICAgICAgICBzaWduID0gdGhpc1ttcyA+IDAgPyAnZnJvbU5vdycgOiAnYWdvJ107CiAgICAgICAgcmV0dXJuIGZvcm1hdC5yZXBsYWNlKC9ceyguKj8pXH0vZywgZnVuY3Rpb24oZnVsbCwgbWF0Y2gpIHsKICAgICAgICAgIHN3aXRjaChtYXRjaCkgewogICAgICAgICAgICBjYXNlICdudW0nOiByZXR1cm4gbnVtOwogICAgICAgICAgICBjYXNlICd1bml0JzogcmV0dXJuIHVuaXQ7CiAgICAgICAgICAgIGNhc2UgJ3NpZ24nOiByZXR1cm4gc2lnbjsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwKCiAgICAgIGNhY2hlRm9ybWF0OiBmdW5jdGlvbihkaWYsIGkpIHsKICAgICAgICB0aGlzLmNvbXBpbGVkRm9ybWF0cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgdGhpcy5jb21waWxlZEZvcm1hdHMudW5zaGlmdChkaWYpOwogICAgICB9LAoKICAgICAgYWRkRm9ybWF0OiBmdW5jdGlvbihzcmMsIHRvKSB7CiAgICAgICAgdmFyIGxvYyA9IHRoaXM7CgogICAgICAgIGZ1bmN0aW9uIGdldFRva2VuU3JjKHN0cikgewogICAgICAgICAgdmFyIHN1ZmZpeCwgc3JjLCB2YWwsCiAgICAgICAgICAgICAgb3B0ICAgPSBzdHIubWF0Y2goL1w/JC8pLAogICAgICAgICAgICAgIG5jICAgID0gc3RyLm1hdGNoKC9eKFxkKylcPz8kLyksCiAgICAgICAgICAgICAgc2xpY2UgPSBzdHIubWF0Y2goLyhcZCkoPzotKFxkKSk/LyksCiAgICAgICAgICAgICAga2V5ICAgPSBzdHIucmVwbGFjZSgvW15hLXpdKyQvaSwgJycpOwoKICAgICAgICAgIC8vIEFsbG93aW5nIGFsaWFzIHRva2VucyBzdWNoIGFzIHt0aW1lfQogICAgICAgICAgaWYgKHZhbCA9IGdldE93bihsb2MucGFyc2luZ0FsaWFzZXMsIGtleSkpIHsKICAgICAgICAgICAgc3JjID0gcmVwbGFjZVBhcnNpbmdUb2tlbnModmFsKTsKICAgICAgICAgICAgaWYgKG9wdCkgewogICAgICAgICAgICAgIHNyYyA9IGdldFJlZ05vbkNhcHR1cmluZyhzcmMsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzcmM7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG5jKSB7CiAgICAgICAgICAgIHNyYyA9IGxvYy50b2tlbnNbbmNbMV1dOwogICAgICAgICAgfSBlbHNlIGlmICh2YWwgPSBnZXRPd24oUGFyc2luZ1Rva2Vucywga2V5KSkgewogICAgICAgICAgICBzcmMgPSB2YWwuc3JjOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsID0gZ2V0T3duKGxvYy5wYXJzaW5nVG9rZW5zLCBrZXkpIHx8IGdldE93bihsb2MsIGtleSk7CgogICAgICAgICAgICAvLyBCb3RoIHRoZSAibW9udGhzIiBhcnJheSBhbmQgdGhlICJtb250aCIgcGFyc2luZyB0b2tlbiBjYW4gYmUgYWNjZXNzZWQKICAgICAgICAgICAgLy8gYnkgZWl0aGVyIHttb250aH0gb3Ige21vbnRoc30sIGZhbGxpbmcgYmFjayBhcyBuZWNlc3NhcnksIGhvd2V2ZXIKICAgICAgICAgICAgLy8gcmVnYXJkbGVzcyBvZiB3aGV0aGVyIG9yIG5vdCBhIGZhbGxiYWNrIG9jY3VycywgdGhlIGZpbmFsIGZpZWxkIHRvCiAgICAgICAgICAgIC8vIGJlIHBhc3NlZCB0byBhZGRSYXdGb3JtYXQgbXVzdCBiZSBub3JtYWxpemVkIGFzIHNpbmd1bGFyLgogICAgICAgICAgICBrZXkgPSBrZXkucmVwbGFjZSgvcyQvLCAnJyk7CgogICAgICAgICAgICBpZiAoIXZhbCkgewogICAgICAgICAgICAgIHZhbCA9IGdldE93bihsb2MucGFyc2luZ1Rva2Vucywga2V5KSB8fCBnZXRPd24obG9jLCBrZXkgKyAncycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNTdHJpbmcodmFsKSkgewogICAgICAgICAgICAgIHNyYyA9IHZhbDsKICAgICAgICAgICAgICBzdWZmaXggPSBsb2Nba2V5ICsgJ1N1ZmZpeCddOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChzbGljZSkgewogICAgICAgICAgICAgICAgdmFsID0gZmlsdGVyKHZhbCwgZnVuY3Rpb24obSwgaSkgewogICAgICAgICAgICAgICAgICB2YXIgbW9kID0gaSAlIChsb2MudW5pdHMgPyA4IDogdmFsLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBtb2QgPj0gc2xpY2VbMV0gJiYgbW9kIDw9IChzbGljZVsyXSB8fCBzbGljZVsxXSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3JjID0gYXJyYXlUb1JlZ0FsdGVybmF0ZXModmFsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFzcmMpIHsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5jKSB7CiAgICAgICAgICAgIC8vIE5vbi1jYXB0dXJpbmcgdG9rZW5zIGxpa2UgezB9CiAgICAgICAgICAgIHNyYyA9IGdldFJlZ05vbkNhcHR1cmluZyhzcmMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gQ2FwdHVyaW5nIGdyb3VwIGFuZCBhZGQgdG8gcGFyc2VkIHRva2VucwogICAgICAgICAgICB0by5wdXNoKGtleSk7CiAgICAgICAgICAgIHNyYyA9ICcoJyArIHNyYyArICcpJzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdWZmaXgpIHsKICAgICAgICAgICAgLy8gRGF0ZS90aW1lIHN1ZmZpeGVzIHN1Y2ggYXMgdGhvc2UgaW4gQ0pLCiAgICAgICAgICAgIHNyYyA9IGdldFBhcnNpbmdUb2tlbldpdGhTdWZmaXgoa2V5LCBzcmMsIHN1ZmZpeCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob3B0KSB7CiAgICAgICAgICAgIHNyYyArPSAnPyc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3JjOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVwbGFjZVBhcnNpbmdUb2tlbnMoc3RyKSB7CgogICAgICAgICAgLy8gTWFrZSBzcGFjZXMgb3B0aW9uYWwKICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC8gL2csICcgPycpOwoKICAgICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvXHsoW14sXSs/KVx9L2csIGZ1bmN0aW9uKG1hdGNoLCB0b2tlbikgewogICAgICAgICAgICB2YXIgdG9rZW5zID0gdG9rZW4uc3BsaXQoJ3wnKSwgc3JjOwogICAgICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBzcmMgPSBnZXRSZWdOb25DYXB0dXJpbmcobWFwKHRva2VucywgZ2V0VG9rZW5TcmMpLmpvaW4oJ3wnKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3JjID0gZ2V0VG9rZW5TcmModG9rZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzcmM7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmICghdG8pIHsKICAgICAgICAgIHRvID0gW107CiAgICAgICAgICBzcmMgPSByZXBsYWNlUGFyc2luZ1Rva2VucyhzcmMpOwogICAgICAgIH0KCiAgICAgICAgbG9jLmFkZFJhd0Zvcm1hdChzcmMsIHRvKTsKICAgICAgfSwKCiAgICAgIGFkZFJhd0Zvcm1hdDogZnVuY3Rpb24oZm9ybWF0LCB0bykgewogICAgICAgIHRoaXMuY29tcGlsZWRGb3JtYXRzLnVuc2hpZnQoewogICAgICAgICAgcmVnOiBSZWdFeHAoJ14gKicgKyBmb3JtYXQgKyAnICokJywgJ2knKSwKICAgICAgICAgIHRvOiB0bwogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgaW5pdDogZnVuY3Rpb24oZGVmKSB7CiAgICAgICAgdmFyIGxvYyA9IHRoaXM7CgogICAgICAgIC8vIC0tIEluaXRpYWxpemF0aW9uIGhlbHBlcnMKCiAgICAgICAgZnVuY3Rpb24gaW5pdEZvcm1hdHMoKSB7CiAgICAgICAgICBsb2MuY29tcGlsZWRGb3JtYXRzID0gW107CiAgICAgICAgICBsb2MucGFyc2luZ0FsaWFzZXMgPSB7fTsKICAgICAgICAgIGxvYy5wYXJzaW5nVG9rZW5zID0ge307CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpbml0RGVmaW5pdGlvbigpIHsKICAgICAgICAgIHNpbXBsZU1lcmdlKGxvYywgZGVmKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGluaXRBcnJheUZpZWxkcygpIHsKICAgICAgICAgIGZvckVhY2goTE9DQUxFX0FSUkFZX0ZJRUxEUywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICB2YXIgdmFsID0gbG9jW25hbWVdOwogICAgICAgICAgICBpZiAoaXNTdHJpbmcodmFsKSkgewogICAgICAgICAgICAgIGxvY1tuYW1lXSA9IGNvbW1hU3BsaXQodmFsKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghdmFsKSB7CiAgICAgICAgICAgICAgbG9jW25hbWVdID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0gVmFsdWUgYXJyYXkgYnVpbGQgaGVscGVycwoKICAgICAgICBmdW5jdGlvbiBidWlsZFZhbHVlQXJyYXkobmFtZSwgbW9kLCBtYXAsIGZuKSB7CiAgICAgICAgICB2YXIgZmllbGQgPSBuYW1lLCBhbGwgPSBbXSwgc2V0TWFwOwogICAgICAgICAgaWYgKCFsb2NbZmllbGRdKSB7CiAgICAgICAgICAgIGZpZWxkICs9ICdzJzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghbWFwKSB7CiAgICAgICAgICAgIG1hcCA9IHt9OwogICAgICAgICAgICBzZXRNYXAgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZm9yQWxsQWx0ZXJuYXRlcyhmaWVsZCwgZnVuY3Rpb24oYWx0LCBqLCBpKSB7CiAgICAgICAgICAgIHZhciBpZHggPSBqICogbW9kICsgaSwgdmFsOwogICAgICAgICAgICB2YWwgPSBmbiA/IGZuKGkpIDogaTsKICAgICAgICAgICAgbWFwW2FsdF0gPSB2YWw7CiAgICAgICAgICAgIG1hcFthbHQudG9Mb3dlckNhc2UoKV0gPSB2YWw7CiAgICAgICAgICAgIGFsbFtpZHhdID0gYWx0OwogICAgICAgICAgfSk7CiAgICAgICAgICBsb2NbZmllbGRdID0gYWxsOwogICAgICAgICAgaWYgKHNldE1hcCkgewogICAgICAgICAgICBsb2NbbmFtZSArICdNYXAnXSA9IG1hcDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZvckFsbEFsdGVybmF0ZXMoZmllbGQsIGZuKSB7CiAgICAgICAgICBmb3JFYWNoKGxvY1tmaWVsZF0sIGZ1bmN0aW9uKHN0ciwgaSkgewogICAgICAgICAgICBmb3JFYWNoQWx0ZXJuYXRlKHN0ciwgZnVuY3Rpb24oYWx0LCBqKSB7CiAgICAgICAgICAgICAgZm4oYWx0LCBqLCBpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZvckVhY2hBbHRlcm5hdGUoc3RyLCBmbikgewogICAgICAgICAgdmFyIGFyciA9IG1hcChzdHIuc3BsaXQoJysnKSwgZnVuY3Rpb24oc3BsaXQpIHsKICAgICAgICAgICAgcmV0dXJuIHNwbGl0LnJlcGxhY2UoLyguKyk6KC4rKSQvLCBmdW5jdGlvbihmdWxsLCBiYXNlLCBzdWZmaXhlcykgewogICAgICAgICAgICAgIHJldHVybiBtYXAoc3VmZml4ZXMuc3BsaXQoJ3wnKSwgZnVuY3Rpb24oc3VmZml4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmFzZSArIHN1ZmZpeDsKICAgICAgICAgICAgICB9KS5qb2luKCd8Jyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkuam9pbignfCcpOwogICAgICAgICAgZm9yRWFjaChhcnIuc3BsaXQoJ3wnKSwgZm4pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYnVpbGROdW1lcmFscygpIHsKICAgICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICAgIGJ1aWxkVmFsdWVBcnJheSgnbnVtZXJhbCcsIDEwLCBtYXApOwogICAgICAgICAgYnVpbGRWYWx1ZUFycmF5KCdhcnRpY2xlJywgMSwgbWFwLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9KTsKICAgICAgICAgIGJ1aWxkVmFsdWVBcnJheSgncGxhY2Vob2xkZXInLCA0LCBtYXAsIGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgcmV0dXJuIHBvdygxMCwgbiArIDEpOwogICAgICAgICAgfSk7CiAgICAgICAgICBsb2MubnVtZXJhbE1hcCA9IG1hcDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGJ1aWxkVGltZUZvcm1hdHMoKSB7CiAgICAgICAgICBsb2MucGFyc2luZ0FsaWFzZXNbJ3RpbWUnXSA9IGdldFRpbWVGb3JtYXQoKTsKICAgICAgICAgIGxvYy5wYXJzaW5nQWxpYXNlc1sndHpPZmZzZXQnXSA9IGdldFRaT2Zmc2V0Rm9ybWF0KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRUaW1lRm9ybWF0KCkgewogICAgICAgICAgdmFyIHNyYzsKICAgICAgICAgIGlmIChsb2MuYW1wbUZyb250KSB7CiAgICAgICAgICAgIC8vICJhbXBtRnJvbnQiIGV4aXN0cyBtb3N0bHkgZm9yIENKSyBsb2NhbGVzLCB3aGljaCBhbHNvIHByZXN1bWUgdGhhdAogICAgICAgICAgICAvLyB0aW1lIHN1ZmZpeGVzIGV4aXN0LCBhbGxvd2luZyB0aGlzIHRvIGJlIGEgc2ltcGxlciByZWdleC4KICAgICAgICAgICAgc3JjID0gJ3thbXBtP30ge2hvdXJ9ICg/OnttaW51dGV9ICg/Ojo/e3NlY29uZH0pPyk/JzsKICAgICAgICAgIH0gZWxzZSBpZihsb2MuYW1wbS5sZW5ndGgpIHsKICAgICAgICAgICAgc3JjID0gJ3tob3VyfSg/OlsuOl17bWludXRlfSg/OlsuOl17c2Vjb25kfSk/IHthbXBtP318IHthbXBtfSknOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3JjID0gJ3tob3VyfSg/OlsuOl17bWludXRlfSg/OlsuOl17c2Vjb25kfSk/KSc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3JjOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0VFpPZmZzZXRGb3JtYXQoKSB7CiAgICAgICAgICByZXR1cm4gJyg/OntafXx7R01UP30oPzp7dHpTaWdufXt0ekhvdXJ9KD86Oj97dHpNaW51dGV9KD86IFxcKFtcXHdcXHNdK1xcKSk/KT8pPyk/JzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGJ1aWxkUGFyc2luZ1Rva2VucygpIHsKICAgICAgICAgIGZvckVhY2hQcm9wZXJ0eShMb2NhbGl6ZWRQYXJzaW5nVG9rZW5zLCBmdW5jdGlvbih0b2tlbiwgbmFtZSkgewogICAgICAgICAgICB2YXIgc3JjLCBhcnI7CiAgICAgICAgICAgIHNyYyA9IHRva2VuLmJhc2UgPyBQYXJzaW5nVG9rZW5zW3Rva2VuLmJhc2VdLnNyYyA6IHRva2VuLnNyYzsKICAgICAgICAgICAgaWYgKHRva2VuLnJlcXVpcmVzTnVtZXJhbHMgfHwgbG9jLm51bWVyYWxVbml0cykgewogICAgICAgICAgICAgIHNyYyArPSBnZXROdW1lcmFsU3JjKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXJyID0gbG9jW25hbWUgKyAncyddOwogICAgICAgICAgICBpZiAoYXJyICYmIGFyci5sZW5ndGgpIHsKICAgICAgICAgICAgICBzcmMgKz0gJ3wnICsgYXJyYXlUb1JlZ0FsdGVybmF0ZXMoYXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2MucGFyc2luZ1Rva2Vuc1tuYW1lXSA9IHNyYzsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0TnVtZXJhbFNyYygpIHsKICAgICAgICAgIHZhciBhbGwsIHNyYyA9ICcnOwogICAgICAgICAgYWxsID0gbG9jLm51bWVyYWxzLmNvbmNhdChsb2MucGxhY2Vob2xkZXJzKS5jb25jYXQobG9jLmFydGljbGVzKTsKICAgICAgICAgIGlmIChsb2MuYWxsb3dzRnVsbFdpZHRoKSB7CiAgICAgICAgICAgIGFsbCA9IGFsbC5jb25jYXQoZnVsbFdpZHRoTnVtYmVycy5zcGxpdCgnJykpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFsbC5sZW5ndGgpIHsKICAgICAgICAgICAgc3JjID0gJ3woPzonICsgYXJyYXlUb1JlZ0FsdGVybmF0ZXMoYWxsKSArICcpKyc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3JjOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYnVpbGRUaW1lU3VmZml4ZXMoKSB7CiAgICAgICAgICBpdGVyYXRlT3ZlckRhdGVVbml0cyhmdW5jdGlvbih1bml0LCBpKSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IGxvYy50aW1lU3VmZml4ZXNbaV07CiAgICAgICAgICAgIGlmICh0b2tlbikgewogICAgICAgICAgICAgIGxvY1sodW5pdC5hbGlhcyB8fCB1bml0Lm5hbWUpICsgJ1N1ZmZpeCddID0gdG9rZW47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYnVpbGRNb2RpZmllcnMoKSB7CiAgICAgICAgICBmb3JFYWNoKGxvYy5tb2RpZmllcnMsIGZ1bmN0aW9uKG1vZGlmaWVyKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gbW9kaWZpZXIubmFtZSwgbWFwS2V5ID0gbmFtZSArICdNYXAnLCBtYXA7CiAgICAgICAgICAgIG1hcCA9IGxvY1ttYXBLZXldIHx8IHt9OwogICAgICAgICAgICBmb3JFYWNoQWx0ZXJuYXRlKG1vZGlmaWVyLnNyYywgZnVuY3Rpb24oYWx0LCBqKSB7CiAgICAgICAgICAgICAgdmFyIHRva2VuID0gZ2V0T3duKGxvYy5wYXJzaW5nVG9rZW5zLCBuYW1lKSwgdmFsID0gbW9kaWZpZXIudmFsdWU7CiAgICAgICAgICAgICAgbWFwW2FsdF0gPSB2YWw7CiAgICAgICAgICAgICAgbG9jLnBhcnNpbmdUb2tlbnNbbmFtZV0gPSB0b2tlbiA/IHRva2VuICsgJ3wnICsgYWx0IDogYWx0OwogICAgICAgICAgICAgIGlmIChtb2RpZmllci5uYW1lID09PSAnc2lnbicgJiYgaiA9PT0gMCkgewogICAgICAgICAgICAgICAgLy8gSG9va2luZyBpbiBoZXJlIHRvIHNldCB0aGUgZmlyc3QgImZyb21Ob3ciIG9yICJhZ28iIG1vZGlmaWVyCiAgICAgICAgICAgICAgICAvLyBkaXJlY3RseSBvbiB0aGUgbG9jYWxlLCBzbyB0aGF0IGl0IGNhbiBiZSByZXVzZWQgaW4gdGhlCiAgICAgICAgICAgICAgICAvLyByZWxhdGl2ZSBmb3JtYXQuCiAgICAgICAgICAgICAgICBsb2NbdmFsID09PSAxID8gJ2Zyb21Ob3cnIDogJ2FnbyddID0gYWx0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxvY1ttYXBLZXldID0gbWFwOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyAtLSBGb3JtYXQgYWRkaW5nIGhlbHBlcnMKCiAgICAgICAgZnVuY3Rpb24gYWRkQ29yZUZvcm1hdHMoKSB7CiAgICAgICAgICBmb3JFYWNoKENvcmVQYXJzaW5nRm9ybWF0cywgZnVuY3Rpb24oZGYpIHsKICAgICAgICAgICAgdmFyIHNyYyA9IGRmLnNyYzsKICAgICAgICAgICAgaWYgKGRmLm1keSAmJiBsb2MubWR5KSB7CiAgICAgICAgICAgICAgLy8gVXNlIHRoZSBtbS9kZC95eXl5IHZhcmlhbnQgaWYgaXQKICAgICAgICAgICAgICAvLyBleGlzdHMgYW5kIHRoZSBsb2NhbGUgcmVxdWlyZXMgaXQKICAgICAgICAgICAgICBzcmMgPSBkZi5tZHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRmLnRpbWUpIHsKICAgICAgICAgICAgICAvLyBDb3JlIGZvcm1hdHMgdGhhdCBhbGxvdyB0aW1lIHJlcXVpcmUgdGhlIHRpbWUKICAgICAgICAgICAgICAvLyByZWcgb24gYm90aCBzaWRlcywgc28gYWRkIGJvdGggdmVyc2lvbnMgaGVyZS4KICAgICAgICAgICAgICBsb2MuYWRkRm9ybWF0KGdldEZvcm1hdFdpdGhUaW1lKHNyYywgdHJ1ZSkpOwogICAgICAgICAgICAgIGxvYy5hZGRGb3JtYXQoZ2V0Rm9ybWF0V2l0aFRpbWUoc3JjKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG9jLmFkZEZvcm1hdChzcmMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGxvYy5hZGRGb3JtYXQoJ3t0aW1lfScpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRkTG9jYWxlRm9ybWF0cygpIHsKICAgICAgICAgIGFkZEZvcm1hdFNldCgncGFyc2UnKTsKICAgICAgICAgIGFkZEZvcm1hdFNldCgndGltZVBhcnNlJywgdHJ1ZSk7CiAgICAgICAgICBhZGRGb3JtYXRTZXQoJ3RpbWVGcm9udFBhcnNlJywgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRGb3JtYXRTZXQoZmllbGQsIGFsbG93VGltZSwgdGltZUZyb250KSB7CiAgICAgICAgICBmb3JFYWNoKGxvY1tmaWVsZF0sIGZ1bmN0aW9uKGZvcm1hdCkgewogICAgICAgICAgICBpZiAoYWxsb3dUaW1lKSB7CiAgICAgICAgICAgICAgZm9ybWF0ID0gZ2V0Rm9ybWF0V2l0aFRpbWUoZm9ybWF0LCB0aW1lRnJvbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvYy5hZGRGb3JtYXQoZm9ybWF0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0Rm9ybWF0V2l0aFRpbWUoYmFzZUZvcm1hdCwgdGltZUJlZm9yZSkgewogICAgICAgICAgaWYgKHRpbWVCZWZvcmUpIHsKICAgICAgICAgICAgcmV0dXJuIGdldFRpbWVCZWZvcmUoKSArIGJhc2VGb3JtYXQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFzZUZvcm1hdCArIGdldFRpbWVBZnRlcigpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0VGltZUJlZm9yZSgpIHsKICAgICAgICAgIHJldHVybiBnZXRSZWdOb25DYXB0dXJpbmcoJ3t0aW1lfVssXFxzXFx1MzAwMF0nLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldFRpbWVBZnRlcigpIHsKICAgICAgICAgIHZhciBtYXJrZXJzID0gJyw/W1xcc1xcdTMwMDBdJywgbG9jYWxpemVkOwogICAgICAgICAgbG9jYWxpemVkID0gYXJyYXlUb1JlZ0FsdGVybmF0ZXMobG9jLnRpbWVNYXJrZXJzKTsKICAgICAgICAgIGlmIChsb2NhbGl6ZWQpIHsKICAgICAgICAgICAgbWFya2VycyArPSAnfCAoPzonICsgbG9jYWxpemVkICsgJykgJzsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtlcnMgPSBnZXRSZWdOb25DYXB0dXJpbmcobWFya2VycywgbG9jLnRpbWVNYXJrZXJPcHRpb25hbCk7CiAgICAgICAgICByZXR1cm4gZ2V0UmVnTm9uQ2FwdHVyaW5nKG1hcmtlcnMgKyAne3RpbWV9JywgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICBpbml0Rm9ybWF0cygpOwogICAgICAgIGluaXREZWZpbml0aW9uKCk7CiAgICAgICAgaW5pdEFycmF5RmllbGRzKCk7CgogICAgICAgIGJ1aWxkVmFsdWVBcnJheSgnbW9udGgnLCAxMik7CiAgICAgICAgYnVpbGRWYWx1ZUFycmF5KCd3ZWVrZGF5JywgNyk7CiAgICAgICAgYnVpbGRWYWx1ZUFycmF5KCd1bml0JywgOCk7CiAgICAgICAgYnVpbGRWYWx1ZUFycmF5KCdhbXBtJywgMik7CgogICAgICAgIGJ1aWxkTnVtZXJhbHMoKTsKICAgICAgICBidWlsZFRpbWVGb3JtYXRzKCk7CiAgICAgICAgYnVpbGRQYXJzaW5nVG9rZW5zKCk7CiAgICAgICAgYnVpbGRUaW1lU3VmZml4ZXMoKTsKICAgICAgICBidWlsZE1vZGlmaWVycygpOwoKICAgICAgICAvLyBUaGUgb3JkZXIgb2YgdGhlc2UgZm9ybWF0cyBpcyBpbXBvcnRhbnQuIE9yZGVyIGlzIHJldmVyc2VkIHNvIGZvcm1hdHMKICAgICAgICAvLyB0aGF0IGFyZSBpbml0aWFsaXplZCBsYXRlciB3aWxsIHRha2UgcHJlY2VkZW5jZS4gR2VuZXJhbGx5LCB0aGlzIG1lYW5zCiAgICAgICAgLy8gdGhhdCBtb3JlIHNwZWNpZmljIGZvcm1hdHMgc2hvdWxkIGNvbWUgbGF0ZXIuCiAgICAgICAgYWRkQ29yZUZvcm1hdHMoKTsKICAgICAgICBhZGRMb2NhbGVGb3JtYXRzKCk7CgogICAgICB9CgogICAgfTsKCiAgICByZXR1cm4gbmV3IExvY2FsZShkZWYpOwogIH0KCgogIC8qKioKICAgKiBAbWV0aG9kIFt1bml0c11TaW5jZShkLCBbb3B0aW9uc10pCiAgICogQHJldHVybnMgTnVtYmVyCiAgICogQHNob3J0IFJldHVybnMgdGhlIHRpbWUgc2luY2UgW2RdLgogICAqIEBleHRyYSBbZF0gd2lsbCBhY2NlcHQgYSBkYXRlIG9iamVjdCwgdGltZXN0YW1wLCBvciBzdHJpbmcuIElmIG5vdCBzcGVjaWZpZWQsCiAgICogICAgICAgIFtkXSBpcyBhc3N1bWVkIHRvIGJlIG5vdy4gYHVuaXRzQWdvYCBpcyBwcm92aWRlZCBhcyBhbiBhbGlhcyB0byBtYWtlCiAgICogICAgICAgIHRoaXMgbW9yZSByZWFkYWJsZSB3aGVuIFtkXSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBjdXJyZW50IGRhdGUuCiAgICogICAgICAgIFtvcHRpb25zXSBjYW4gYmUgYW4gb2JqZWN0IG9yIGEgbG9jYWxlIGNvZGUgYXMgYSBzdHJpbmcuIFNlZSBgY3JlYXRlYAogICAqICAgICAgICBmb3IgbW9yZS4KICAgKgogICAqIEBzZXQKICAgKiAgIG1pbGxpc2Vjb25kc1NpbmNlCiAgICogICBzZWNvbmRzU2luY2UKICAgKiAgIG1pbnV0ZXNTaW5jZQogICAqICAgaG91cnNTaW5jZQogICAqICAgZGF5c1NpbmNlCiAgICogICB3ZWVrc1NpbmNlCiAgICogICBtb250aHNTaW5jZQogICAqICAgeWVhcnNTaW5jZQogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgbmV3IERhdGUoKS5taWxsaXNlY29uZHNTaW5jZSgnMSBob3VyIGFnbycpIC0+IDMsNjAwLDAwMAogICAqICAgbmV3IERhdGUoKS5kYXlzU2luY2UoJzEgd2VlayBhZ28nKSAgICAgICAgIC0+IDcKICAgKiAgIG5ldyBEYXRlKCkueWVhcnNTaW5jZSgnMTUgeWVhcnMgYWdvJykgICAgICAtPiAxNQogICAqICAgbGFzdFllYXIueWVhcnNBZ28oKSAgICAgICAgICAgICAgICAgLT4gMQogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfERhdGV9IGQKICAgKiBAcGFyYW0ge0RhdGVDcmVhdGVPcHRpb25zfSBvcHRpb25zCiAgICoKICAgKioqCiAgICogQG1ldGhvZCBbdW5pdHNdQWdvKCkKICAgKiBAcmV0dXJucyBOdW1iZXIKICAgKiBAc2hvcnQgUmV0dXJucyB0aGUgdGltZSBhZ28gaW4gdGhlIGFwcHJvcHJpYXRlIHVuaXQuCiAgICoKICAgKiBAc2V0CiAgICogICBtaWxsaXNlY29uZHNBZ28KICAgKiAgIHNlY29uZHNBZ28KICAgKiAgIG1pbnV0ZXNBZ28KICAgKiAgIGhvdXJzQWdvCiAgICogICBkYXlzQWdvCiAgICogICB3ZWVrc0FnbwogICAqICAgbW9udGhzQWdvCiAgICogICB5ZWFyc0FnbwogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgbGFzdFllYXIubWlsbGlzZWNvbmRzQWdvKCkgLT4gMyw2MDAsMDAwCiAgICogICBsYXN0WWVhci5kYXlzQWdvKCkgICAgICAgICAtPiA3CiAgICogICBsYXN0WWVhci55ZWFyc0FnbygpICAgICAgICAtPiAxNQogICAqCiAgICoqKgogICAqIEBtZXRob2QgW3VuaXRzXVVudGlsKFtkXSwgW29wdGlvbnNdKQogICAqIEByZXR1cm5zIE51bWJlcgogICAqIEBzaG9ydCBSZXR1cm5zIHRoZSB0aW1lIHVudGlsIFtkXS4KICAgKiBAZXh0cmEgW2RdIHdpbGwgYWNjZXB0IGEgZGF0ZSBvYmplY3QsIHRpbWVzdGFtcCwgb3Igc3RyaW5nLiBJZiBub3Qgc3BlY2lmaWVkLAogICAqICAgICAgICBbZF0gaXMgYXNzdW1lZCB0byBiZSBub3cuIGB1bml0c0Zyb21Ob3dgIGlzIHByb3ZpZGVkIGFzIGFuIGFsaWFzIHRvCiAgICogICAgICAgIG1ha2UgdGhpcyBtb3JlIHJlYWRhYmxlIHdoZW4gW2RdIGlzIGFzc3VtZWQgdG8gYmUgdGhlIGN1cnJlbnQgZGF0ZS4KICAgKiAgICAgICAgW29wdGlvbnNdIGNhbiBiZSBhbiBvYmplY3Qgb3IgYSBsb2NhbGUgY29kZSBhcyBhIHN0cmluZy4gU2VlIGBjcmVhdGVgCiAgICogICAgICAgIGZvciBtb3JlLgogICAqCiAgICoKICAgKiBAc2V0CiAgICogICBtaWxsaXNlY29uZHNVbnRpbAogICAqICAgc2Vjb25kc1VudGlsCiAgICogICBtaW51dGVzVW50aWwKICAgKiAgIGhvdXJzVW50aWwKICAgKiAgIGRheXNVbnRpbAogICAqICAgd2Vla3NVbnRpbAogICAqICAgbW9udGhzVW50aWwKICAgKiAgIHllYXJzVW50aWwKICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgIG5ldyBEYXRlKCkubWlsbGlzZWNvbmRzVW50aWwoJzEgaG91ciBmcm9tIG5vdycpIC0+IDMsNjAwLDAwMAogICAqICAgbmV3IERhdGUoKS5kYXlzVW50aWwoJzEgd2VlayBmcm9tIG5vdycpICAgICAgICAgLT4gNwogICAqICAgbmV3IERhdGUoKS55ZWFyc1VudGlsKCcxNSB5ZWFycyBmcm9tIG5vdycpICAgICAgLT4gMTUKICAgKiAgIG5leHRZZWFyLnllYXJzRnJvbU5vdygpICAgICAgICAgICAgICAgICAgLT4gMQogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfERhdGV9IGQKICAgKiBAcGFyYW0ge0RhdGVDcmVhdGVPcHRpb25zfSBvcHRpb25zCiAgICoKICAgKioqCiAgICogQG1ldGhvZCBbdW5pdHNdRnJvbU5vdygpCiAgICogQHJldHVybnMgTnVtYmVyCiAgICogQHNob3J0IFJldHVybnMgdGhlIHRpbWUgZnJvbSBub3cgaW4gdGhlIGFwcHJvcHJpYXRlIHVuaXQuCiAgICoKICAgKiBAc2V0CiAgICogICBtaWxsaXNlY29uZHNGcm9tTm93CiAgICogICBzZWNvbmRzRnJvbU5vdwogICAqICAgbWludXRlc0Zyb21Ob3cKICAgKiAgIGhvdXJzRnJvbU5vdwogICAqICAgZGF5c0Zyb21Ob3cKICAgKiAgIHdlZWtzRnJvbU5vdwogICAqICAgbW9udGhzRnJvbU5vdwogICAqICAgeWVhcnNGcm9tTm93CiAgICoKICAgKiBAZXhhbXBsZQogICAqCiAgICogICBuZXh0WWVhci5taWxsaXNlY29uZHNGcm9tTm93KCkgLT4gMyw2MDAsMDAwCiAgICogICBuZXh0WWVhci5kYXlzRnJvbU5vdygpICAgICAgICAgLT4gNwogICAqICAgbmV4dFllYXIueWVhcnNGcm9tTm93KCkgICAgICAgIC0+IDE1CiAgICoKICAgKioqCiAgICogQG1ldGhvZCBhZGRbVW5pdHNdKG4sIFtyZXNldF0gPSBmYWxzZSkKICAgKiBAcmV0dXJucyBEYXRlCiAgICogQHNob3J0IEFkZHMgYG5gIHVuaXRzIHRvIHRoZSBkYXRlLiBJZiBbcmVzZXRdIGlzIHRydWUsIGFsbCBsb3dlciB1bml0cyB3aWxsCiAgICogICAgICAgIGJlIHJlc2V0LgogICAqIEBleHRyYSBUaGlzIG1ldGhvZCBtb2RpZmllcyB0aGUgZGF0ZSEgTm90ZSB0aGF0IGluIHRoZSBjYXNlIG9mIGBhZGRNb250aHNgLAogICAqICAgICAgICB0aGUgZGF0ZSBtYXkgZmFsbCBvbiBhIGRhdGUgdGhhdCBkb2Vzbid0IGV4aXN0IChpLmUuIEZlYnJ1YXJ5IDMwKS4gSW4KICAgKiAgICAgICAgdGhpcyBjYXNlIHRoZSBkYXRlIHdpbGwgYmUgc2hpZnRlZCB0byB0aGUgbGFzdCBkYXkgb2YgdGhlIG1vbnRoLiBEb24ndAogICAqICAgICAgICB1c2UgYGFkZE1vbnRoc2AgaWYgeW91IG5lZWQgcHJlY2lzaW9uLgogICAqCiAgICogQHNldAogICAqICAgYWRkTWlsbGlzZWNvbmRzCiAgICogICBhZGRTZWNvbmRzCiAgICogICBhZGRNaW51dGVzCiAgICogICBhZGRIb3VycwogICAqICAgYWRkRGF5cwogICAqICAgYWRkV2Vla3MKICAgKiAgIGFkZE1vbnRocwogICAqICAgYWRkWWVhcnMKICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgIG5ldyBEYXRlKCkuYWRkWWVhcnMoNSkgICAgICAgIC0+IGN1cnJlbnQgdGltZSArIDUgeWVhcnMKICAgKiAgIG5ldyBEYXRlKCkuYWRkRGF5cyg1KSAgICAgICAgIC0+IGN1cnJlbnQgdGltZSArIDUgZGF5cwogICAqICAgbmV3IERhdGUoKS5hZGREYXlzKDUsIHRydWUpICAgLT4gY3VycmVudCB0aW1lICsgNSBkYXlzICh0aW1lIHJlc2V0KQogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IG4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXNldF0KICAgKgogICAqKioKICAgKiBAbWV0aG9kIGlzTGFzdFtVbml0XShbbG9jYWxlQ29kZV0pCiAgICogQHJldHVybnMgQm9vbGVhbgogICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgdGhlIGRhdGUgaXMgbGFzdCB3ZWVrLCBtb250aCwgb3IgeWVhci4KICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgdGFrZXMgYW4gb3B0aW9uYWwgbG9jYWxlIGNvZGUgZm9yIGBpc0xhc3RXZWVrYCwgd2hpY2ggaXMKICAgKiAgICAgICAgbG9jYWxlIGRlcGVuZGVudC4gVGhlIGRlZmF1bHQgbG9jYWxlIGNvZGUgaXMgYGVuYCwgd2hpY2ggcGxhY2VzCiAgICogICAgICAgIFN1bmRheSBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSB3ZWVrLiBZb3UgY2FuIHBhc3MgYGVuLUdCYCBhcyBhIHF1aWNrCiAgICogICAgICAgIHdheSB0byBmb3JjZSBNb25kYXkgYXMgdGhlIGJlZ2lubmluZyBvZiB0aGUgd2Vlay4KICAgKgogICAqIEBzZXQKICAgKiAgIGlzTGFzdFdlZWsKICAgKiAgIGlzTGFzdE1vbnRoCiAgICogICBpc0xhc3RZZWFyCiAgICoKICAgKiBAZXhhbXBsZQogICAqCiAgICogICB5ZXN0ZXJkYXkuaXNMYXN0V2VlaygpICAtPiB0cnVlIG9yIGZhbHNlPwogICAqICAgeWVzdGVyZGF5LmlzTGFzdE1vbnRoKCkgLT4gcHJvYmFibHkgbm90Li4uCiAgICogICB5ZXN0ZXJkYXkuaXNMYXN0WWVhcigpICAtPiBldmVuIGxlc3MgbGlrZWx5Li4uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gW2xvY2FsZUNvZGVdCiAgICoKICAgKioqCiAgICogQG1ldGhvZCBpc1RoaXNbVW5pdF0oW2xvY2FsZUNvZGVdKQogICAqIEByZXR1cm5zIEJvb2xlYW4KICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBkYXRlIGlzIHRoaXMgd2VlaywgbW9udGgsIG9yIHllYXIuCiAgICogQGV4dHJhIFRoaXMgbWV0aG9kIHRha2VzIGFuIG9wdGlvbmFsIGxvY2FsZSBjb2RlIGZvciBgaXNUaGlzV2Vla2AsIHdoaWNoIGlzCiAgICogICAgICAgIGxvY2FsZSBkZXBlbmRlbnQuIFRoZSBkZWZhdWx0IGxvY2FsZSBjb2RlIGlzIGBlbmAsIHdoaWNoIHBsYWNlcwogICAqICAgICAgICBTdW5kYXkgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgd2Vlay4gWW91IGNhbiBwYXNzIGBlbi1HQmAgYXMgYSBxdWljawogICAqICAgICAgICB3YXkgdG8gZm9yY2UgTW9uZGF5IGFzIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHdlZWsuCiAgICoKICAgKiBAc2V0CiAgICogICBpc1RoaXNXZWVrCiAgICogICBpc1RoaXNNb250aAogICAqICAgaXNUaGlzWWVhcgogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgdG9tb3Jyb3cuaXNUaGlzV2VlaygpICAtPiB0cnVlIG9yIGZhbHNlPwogICAqICAgdG9tb3Jyb3cuaXNUaGlzTW9udGgoKSAtPiBwcm9iYWJseS4uLgogICAqICAgdG9tb3Jyb3cuaXNUaGlzWWVhcigpICAtPiBzaWducyBwb2ludCB0byB5ZXMuLi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBbbG9jYWxlQ29kZV0KICAgKgogICAqKioKICAgKiBAbWV0aG9kIGlzTmV4dFtVbml0XShbbG9jYWxlQ29kZV0pCiAgICogQHJldHVybnMgQm9vbGVhbgogICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgdGhlIGRhdGUgaXMgbmV4dCB3ZWVrLCBtb250aCwgb3IgeWVhci4KICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgdGFrZXMgYW4gb3B0aW9uYWwgbG9jYWxlIGNvZGUgZm9yIGBpc05leHRXZWVrYCwgd2hpY2ggaXMKICAgKiAgICAgICAgbG9jYWxlIGRlcGVuZGVudC4gVGhlIGRlZmF1bHQgbG9jYWxlIGNvZGUgaXMgYGVuYCwgd2hpY2ggcGxhY2VzCiAgICogICAgICAgIFN1bmRheSBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSB3ZWVrLiBZb3UgY2FuIHBhc3MgYGVuLUdCYCBhcyBhIHF1aWNrCiAgICogICAgICAgIHdheSB0byBmb3JjZSBNb25kYXkgYXMgdGhlIGJlZ2lubmluZyBvZiB0aGUgd2Vlay4KICAgKgogICAqIEBzZXQKICAgKiAgIGlzTmV4dFdlZWsKICAgKiAgIGlzTmV4dE1vbnRoCiAgICogICBpc05leHRZZWFyCiAgICoKICAgKiBAZXhhbXBsZQogICAqCiAgICogICB0b21vcnJvdy5pc05leHRXZWVrKCkgIC0+IHRydWUgb3IgZmFsc2U/CiAgICogICB0b21vcnJvdy5pc05leHRNb250aCgpIC0+IHByb2JhYmx5IG5vdC4uLgogICAqICAgdG9tb3Jyb3cuaXNOZXh0WWVhcigpICAtPiBldmVuIGxlc3MgbGlrZWx5Li4uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gW2xvY2FsZUNvZGVdCiAgICoKICAgKioqCiAgICogQG1ldGhvZCBiZWdpbm5pbmdPZltVbml0XShbbG9jYWxlQ29kZV0pCiAgICogQHJldHVybnMgRGF0ZQogICAqIEBzaG9ydCBTZXRzIHRoZSBkYXRlIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFwcHJvcHJpYXRlIHVuaXQuCiAgICogQGV4dHJhIFRoaXMgbWV0aG9kIG1vZGlmaWVzIHRoZSBkYXRlISBBIGxvY2FsZSBjb2RlIGNhbiBiZSBwYXNzZWQgZm9yCiAgICogICAgICAgIGBiZWdpbm5pbmdPZldlZWtgLCB3aGljaCBpcyBsb2NhbGUgZGVwZW5kZW50LiBJZiBjb25zaXN0ZW5jeSBpcwogICAqICAgICAgICBuZWVkZWQsIHVzZSBgYmVnaW5uaW5nT2ZJU09XZWVrYCBpbnN0ZWFkLgogICAqCiAgICogQHNldAogICAqICAgYmVnaW5uaW5nT2ZEYXkKICAgKiAgIGJlZ2lubmluZ09mV2VlawogICAqICAgYmVnaW5uaW5nT2ZNb250aAogICAqICAgYmVnaW5uaW5nT2ZZZWFyCiAgICoKICAgKiBAZXhhbXBsZQogICAqCiAgICogICBuZXcgRGF0ZSgpLmJlZ2lubmluZ09mRGF5KCkgICAtPiB0aGUgYmVnaW5uaW5nIG9mIHRvZGF5IChyZXNldHMgdGhlIHRpbWUpCiAgICogICBuZXcgRGF0ZSgpLmJlZ2lubmluZ09mV2VlaygpICAtPiB0aGUgYmVnaW5uaW5nIG9mIHRoZSB3ZWVrCiAgICogICBuZXcgRGF0ZSgpLmJlZ2lubmluZ09mTW9udGgoKSAtPiB0aGUgYmVnaW5uaW5nIG9mIHRoZSBtb250aAogICAqICAgbmV3IERhdGUoKS5iZWdpbm5pbmdPZlllYXIoKSAgLT4gdGhlIGJlZ2lubmluZyBvZiB0aGUgeWVhcgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IFtsb2NhbGVDb2RlXQogICAqCiAgICoqKgogICAqIEBtZXRob2QgZW5kT2ZbVW5pdF0oW2xvY2FsZUNvZGVdKQogICAqIEByZXR1cm5zIERhdGUKICAgKiBAc2hvcnQgU2V0cyB0aGUgZGF0ZSB0byB0aGUgZW5kIG9mIHRoZSBhcHByb3ByaWF0ZSB1bml0LgogICAqIEBleHRyYSBUaGlzIG1ldGhvZCBtb2RpZmllcyB0aGUgZGF0ZSEgQSBsb2NhbGUgY29kZSBjYW4gYmUgcGFzc2VkIGZvcgogICAqICAgICAgICBgZW5kT2ZXZWVrYCwgd2hpY2ggaXMgbG9jYWxlIGRlcGVuZGVudC4gSWYgY29uc2lzdGVuY3kgaXMgbmVlZGVkLCB1c2UKICAgKiAgICAgICAgYGVuZE9mSVNPV2Vla2AgaW5zdGVhZC4KICAgKgogICAqIEBzZXQKICAgKiAgIGVuZE9mRGF5CiAgICogICBlbmRPZldlZWsKICAgKiAgIGVuZE9mTW9udGgKICAgKiAgIGVuZE9mWWVhcgogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgbmV3IERhdGUoKS5lbmRPZkRheSgpICAgLT4gdGhlIGVuZCBvZiB0b2RheSAoc2V0cyB0aGUgdGltZSB0byAyMzo1OTo1OS45OTkpCiAgICogICBuZXcgRGF0ZSgpLmVuZE9mV2VlaygpICAtPiB0aGUgZW5kIG9mIHRoZSB3ZWVrCiAgICogICBuZXcgRGF0ZSgpLmVuZE9mTW9udGgoKSAtPiB0aGUgZW5kIG9mIHRoZSBtb250aAogICAqICAgbmV3IERhdGUoKS5lbmRPZlllYXIoKSAgLT4gdGhlIGVuZCBvZiB0aGUgeWVhcgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IFtsb2NhbGVDb2RlXQogICAqCiAgICoqKi8KICBmdW5jdGlvbiBidWlsZERhdGVVbml0TWV0aG9kcygpIHsKCiAgICBkZWZpbmVJbnN0YW5jZVNpbWlsYXIoc3VnYXJEYXRlLCBEYXRlVW5pdHMsIGZ1bmN0aW9uKG1ldGhvZHMsIHVuaXQsIGluZGV4KSB7CiAgICAgIHZhciBuYW1lID0gdW5pdC5uYW1lLCBjYXBzID0gc2ltcGxlQ2FwaXRhbGl6ZShuYW1lKTsKCiAgICAgIGlmIChpbmRleCA+IERBWV9JTkRFWCkgewogICAgICAgIGZvckVhY2goWydMYXN0JywnVGhpcycsJ05leHQnXSwgZnVuY3Rpb24oc2hpZnQpIHsKICAgICAgICAgIG1ldGhvZHNbJ2lzJyArIHNoaWZ0ICsgY2Fwc10gPSBmdW5jdGlvbihkLCBsb2NhbGVDb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wYXJlRGF0ZShkLCBzaGlmdCArICcgJyArIG5hbWUsIDAsIGxvY2FsZUNvZGUsIHsgbG9jYWxlOiAnZW4nIH0pOwogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoaW5kZXggPiBIT1VSU19JTkRFWCkgewogICAgICAgIG1ldGhvZHNbJ2JlZ2lubmluZ09mJyArIGNhcHNdID0gZnVuY3Rpb24oZCwgbG9jYWxlQ29kZSkgewogICAgICAgICAgcmV0dXJuIG1vdmVUb0JlZ2lubmluZ09mVW5pdChkLCBpbmRleCwgbG9jYWxlQ29kZSk7CiAgICAgICAgfTsKICAgICAgICBtZXRob2RzWydlbmRPZicgKyBjYXBzXSA9IGZ1bmN0aW9uKGQsIGxvY2FsZUNvZGUpIHsKICAgICAgICAgIHJldHVybiBtb3ZlVG9FbmRPZlVuaXQoZCwgaW5kZXgsIGxvY2FsZUNvZGUpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIG1ldGhvZHNbJ2FkZCcgKyBjYXBzICsgJ3MnXSA9IGZ1bmN0aW9uKGQsIG51bSwgcmVzZXQpIHsKICAgICAgICByZXR1cm4gYWR2YW5jZURhdGUoZCwgbmFtZSwgbnVtLCByZXNldCk7CiAgICAgIH07CgogICAgICB2YXIgc2luY2UgPSBmdW5jdGlvbihkYXRlLCBkLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIGdldFRpbWVEaXN0YW5jZUZvclVuaXQoZGF0ZSwgY3JlYXRlRGF0ZVdpdGhDb250ZXh0KGRhdGUsIGQsIG9wdGlvbnMsIHRydWUpLCB1bml0KTsKICAgICAgfTsKICAgICAgdmFyIHVudGlsID0gZnVuY3Rpb24oZGF0ZSwgZCwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBnZXRUaW1lRGlzdGFuY2VGb3JVbml0KGNyZWF0ZURhdGVXaXRoQ29udGV4dChkYXRlLCBkLCBvcHRpb25zLCB0cnVlKSwgZGF0ZSwgdW5pdCk7CiAgICAgIH07CgogICAgICBtZXRob2RzW25hbWUgKyAnc0FnbyddICAgPSBtZXRob2RzW25hbWUgKyAnc1VudGlsJ10gICA9IHVudGlsOwogICAgICBtZXRob2RzW25hbWUgKyAnc1NpbmNlJ10gPSBtZXRob2RzW25hbWUgKyAnc0Zyb21Ob3cnXSA9IHNpbmNlOwoKICAgIH0pOwoKICB9CgogIC8qKioKICAgKiBAbWV0aG9kIGlzW0RheV0oKQogICAqIEByZXR1cm5zIEJvb2xlYW4KICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBkYXRlIGZhbGxzIG9uIHRoZSBzcGVjaWZpZWQgZGF5LgogICAqCiAgICogQHNldAogICAqICAgaXNUb2RheQogICAqICAgaXNZZXN0ZXJkYXkKICAgKiAgIGlzVG9tb3Jyb3cKICAgKiAgIGlzV2Vla2RheQogICAqICAgaXNXZWVrZW5kCiAgICogICBpc1N1bmRheQogICAqICAgaXNNb25kYXkKICAgKiAgIGlzVHVlc2RheQogICAqICAgaXNXZWRuZXNkYXkKICAgKiAgIGlzVGh1cnNkYXkKICAgKiAgIGlzRnJpZGF5CiAgICogICBpc1NhdHVyZGF5CiAgICoKICAgKiBAZXhhbXBsZQogICAqCiAgICogICB0b21vcnJvdy5pc1RvZGF5KCkgLT4gZmFsc2UKICAgKiAgIHRodXJzZGF5LmlzVG9tb3Jyb3coKSAtPiA/CiAgICogICB5ZXN0ZXJkYXkuaXNXZWRuZXNkYXkoKSAtPiA/CiAgICogICB0b2RheS5pc1dlZWtlbmQoKSAtPiA/CiAgICoKICAgKioqCiAgICogQG1ldGhvZCBpc0Z1dHVyZSgpCiAgICogQHJldHVybnMgQm9vbGVhbgogICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgdGhlIGRhdGUgaXMgaW4gdGhlIGZ1dHVyZS4KICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgIGxhc3RXZWVrLmlzRnV0dXJlKCkgLT4gZmFsc2UKICAgKiAgIG5leHRXZWVrLmlzRnV0dXJlKCkgLT4gdHJ1ZQogICAqCiAgICoqKgogICAqIEBtZXRob2QgaXNQYXN0KCkKICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgZGF0ZSBpcyBpbiB0aGUgcGFzdC4KICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgIGxhc3RXZWVrLmlzUGFzdCgpIC0+IHRydWUKICAgKiAgIG5leHRXZWVrLmlzUGFzdCgpIC0+IGZhbHNlCiAgICoKICAgKioqLwogIGZ1bmN0aW9uIGJ1aWxkUmVsYXRpdmVBbGlhc2VzKCkgewogICAgdmFyIHNwZWNpYWwgID0gc3BhY2VTcGxpdCgnVG9kYXkgWWVzdGVyZGF5IFRvbW9ycm93IFdlZWtkYXkgV2Vla2VuZCBGdXR1cmUgUGFzdCcpOwogICAgdmFyIHdlZWtkYXlzID0gRW5nbGlzaC53ZWVrZGF5cy5zbGljZSgwLCA3KTsKICAgIHZhciBtb250aHMgICA9IEVuZ2xpc2gubW9udGhzLnNsaWNlKDAsIDEyKTsKICAgIHZhciB0b2dldGhlciA9IHNwZWNpYWwuY29uY2F0KHdlZWtkYXlzKS5jb25jYXQobW9udGhzKTsKICAgIGRlZmluZUluc3RhbmNlU2ltaWxhcihzdWdhckRhdGUsIHRvZ2V0aGVyLCBmdW5jdGlvbihtZXRob2RzLCBuYW1lKSB7CiAgICAgIG1ldGhvZHNbJ2lzJysgbmFtZV0gPSBmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGZ1bGxDb21wYXJlRGF0ZShkLCBuYW1lKTsKICAgICAgfTsKICAgIH0pOwogIH0KCiAgZGVmaW5lU3RhdGljKHN1Z2FyRGF0ZSwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgY3JlYXRlKGQsIFtvcHRpb25zXSkKICAgICAqIEByZXR1cm5zIERhdGUKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaG9ydCBBbHRlcm5hdGUgZGF0ZSBjb25zdHJ1Y3RvciB3aGljaCBhY2NlcHRzIHRleHQgZm9ybWF0cywgYSB0aW1lc3RhbXAsCiAgICAgKiAgICAgICAgb2JqZWN0cywgb3IgYW5vdGhlciBkYXRlLgogICAgICogQGV4dHJhIElmIG5vIGFyZ3VtZW50IGlzIGdpdmVuLCB0aGUgZGF0ZSBpcyBhc3N1bWVkIHRvIGJlIG5vdy4gVGhlIHNlY29uZAogICAgICogICAgICAgIGFyZ3VtZW50IGNhbiBlaXRoZXIgYmUgYW4gb3B0aW9ucyBvYmplY3Qgb3IgYSBsb2NhbGUgY29kZSBhcyBhCiAgICAgKiAgICAgICAgc2hvcnRjdXQuIEZvciBtb3JlLCBzZWUgYGRhdGUgcGFyc2luZ2AuCiAgICAgKgogICAgICogQG9wdGlvbnMKICAgICAqCiAgICAgKiAgIGxvY2FsZSAgICAgQSBsb2NhbGUgY29kZSB0byBwYXJzZSB0aGUgZGF0ZSBpbi4gVGhpcyBjYW4gYWxzbyBiZSBwYXNzZWQgYXMKICAgICAqICAgICAgICAgICAgICB0aGUgc2Vjb25kIGFyZ3VtZW50IHRvIHRoaXMgbWV0aG9kLiBEZWZhdWx0IGlzIHRoZSBjdXJyZW50CiAgICAgKiAgICAgICAgICAgICAgbG9jYWxlLCB3aGljaCBpcyBgZW5gIGlmIG5vbmUgaXMgc2V0LgogICAgICoKICAgICAqICAgcGFzdCAgICAgICBJZiBgdHJ1ZWAsIGFtYmlndW91cyBkYXRlcyBsaWtlIGBTdW5kYXlgIHdpbGwgYmUgcGFyc2VkIGFzCiAgICAgKiAgICAgICAgICAgICAgYGxhc3QgU3VuZGF5YC4gTm90ZSB0aGF0IG5vbi1hbWJpZ3VvdXMgZGF0ZXMgYXJlIG5vdAogICAgICogICAgICAgICAgICAgIGd1YXJhbnRlZWQgdG8gYmUgaW4gdGhlIHBhc3QuCiAgICAgKiAgICAgICAgICAgICAgRGVmYXVsdCBpcyBgZmFsc2VgLgogICAgICoKICAgICAqICAgZnV0dXJlICAgICBJZiBgdHJ1ZWAsIGFtYmlndW91cyBkYXRlcyBsaWtlIGBTdW5kYXlgIHdpbGwgYmUgcGFyc2VkIGFzCiAgICAgKiAgICAgICAgICAgICAgYG5leHQgU3VuZGF5YC4gTm90ZSB0aGF0IG5vbi1hbWJpZ3VvdXMgZGF0ZXMgYXJlIG5vdAogICAgICogICAgICAgICAgICAgIGd1YXJhbnRlZWQgdG8gYmUgaW4gdGhlIGZ1dHVyZS4KICAgICAqICAgICAgICAgICAgICBEZWZhdWx0IGlzIGBmYWxzZWAuCiAgICAgKgogICAgICogICBmcm9tVVRDICAgIElmIGB0cnVlYCwgZGF0ZXMgd2l0aCBubyB0aW1lem9uZSBub3RhdGlvbiB3aWxsIGJlIHBhcnNlZCBhcwogICAgICogICAgICAgICAgICAgIFVUQyAobm8gdGltZXpvbmUgb2Zmc2V0KS4gVGhpcyBpcyB1c2VmdWwgZm9yIHNlcnZlcgogICAgICogICAgICAgICAgICAgIHRpbWVzdGFtcHMsIGV0Yy4gTm90ZSB0aGF0IHRoaXMgZmxhZyBpcyBub3QgcmVxdWlyZWQgaWYgdGhlCiAgICAgKiAgICAgICAgICAgICAgdGltZXpvbmUgaXMgc3BlY2lmaWVkIGluIHRoZSBzdHJpbmcsIGVpdGhlciBhcyBhbiBleHBsaWNpdAogICAgICogICAgICAgICAgICAgIHZhbHVlIChleC4gKzA5MDAgb3IgLTA5OjAwKSBvciAiWiIsIHdoaWNoIGlzIFVUQyB0aW1lLgogICAgICoKICAgICAqICAgc2V0VVRDICAgICBJZiBgdHJ1ZWAsIHRoaXMgd2lsbCBzZXQgYSBmbGFnIG9uIHRoZSBkYXRlIHRoYXQgdGVsbHMgU3VnYXIKICAgICAqICAgICAgICAgICAgICB0byBpbnRlcm5hbGx5IHVzZSBVVEMgbWV0aG9kcyBsaWtlIGBnZXRVVENIb3Vyc2Agd2hlbiBoYW5kbGluZwogICAgICogICAgICAgICAgICAgIGl0LiBUaGlzIGZsYWcgaXMgdGhlIHNhbWUgYXMgY2FsbGluZyB0aGUgYHNldFVUQ2AgbWV0aG9kIG9uCiAgICAgKiAgICAgICAgICAgICAgdGhlIGRhdGUgYWZ0ZXIgcGFyc2luZyBpcyBjb21wbGV0ZS4gTm90ZSB0aGF0IHRoaXMgaXMKICAgICAqICAgICAgICAgICAgICBkaWZmZXJlbnQgZnJvbSBgZnJvbVVUQ2AsIHdoaWNoIHBhcnNlcyBhIHN0cmluZyBhcyBVVEMsIGJ1dAogICAgICogICAgICAgICAgICAgIGRvZXMgbm90IHNldCB0aGlzIGZsYWcuCiAgICAgKgogICAgICogICBjbG9uZSAgICAgIElmIGB0cnVlYCBhbmQgYGRgIGlzIGEgZGF0ZSwgaXQgd2lsbCBiZSBjbG9uZWQuCiAgICAgKgogICAgICogICBwYXJhbXMgICAgIEFuIG9wdGlvbmFsIG9iamVjdCB0aGF0IGlzIHBvcHVsYXRlZCB3aXRoIHByb3BlcnRpZXMgdGhhdCBhcmUKICAgICAqICAgICAgICAgICAgICBwYXJzZWQgZnJvbSBzdHJpbmcgaW5wdXQuIFRoaXMgb3B0aW9uIGlzIHVzZWZ1bCB3aGVuIHBhcnNlZAogICAgICogICAgICAgICAgICAgIHByb3BlcnRpZXMgbmVlZCB0byBiZSByZXRhaW5lZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgRGF0ZS5jcmVhdGUoJ0p1bHknKSAgICAgICAgICAgICAgICAgICAgICAtPiBKdWx5IG9mIHRoaXMgeWVhcgogICAgICogICBEYXRlLmNyZWF0ZSgnMTc3NicpICAgICAgICAgICAgICAgICAgICAgIC0+IDE3NzYKICAgICAqICAgRGF0ZS5jcmVhdGUoJ3RvZGF5JykgICAgICAgICAgICAgICAgICAgICAtPiB0b2RheQogICAgICogICBEYXRlLmNyZWF0ZSgnV2VkbmVzZGF5JykgICAgICAgICAgICAgICAgIC0+IFRoaXMgd2VkbmVzZGF5CiAgICAgKiAgIERhdGUuY3JlYXRlKCduZXh0IEZyaWRheScpICAgICAgICAgICAgICAgLT4gTmV4dCBmcmlkYXkKICAgICAqICAgRGF0ZS5jcmVhdGUoJ0p1bHkgNCwgMTc3NicpICAgICAgICAgICAgICAtPiBKdWx5IDQsIDE3NzYKICAgICAqICAgRGF0ZS5jcmVhdGUoLTQ0NjgwNjgwMDAwMCkgICAgICAgICAgICAgICAtPiBOb3ZlbWJlciA1LCAxOTU1CiAgICAgKiAgIERhdGUuY3JlYXRlKCcxNzc25bm0MDfmnIgwNOaXpScsICdqYScpICAgICAgLT4gSnVseSA0LCAxNzc2CiAgICAgKiAgIERhdGUuY3JlYXRlKCdBdWd1c3QnLCB7cGFzdDogdHJ1ZX0pICAgICAgLT4gQXVndXN0IG9mIHRoaXMgb3IgbGFzdCB5ZWFyCiAgICAgKiAgIERhdGUuY3JlYXRlKCdBdWd1c3QnLCB7ZnV0dXJlOiB0cnVlfSkgICAgLT4gQXVndXN0IG9mIHRoaXMgb3IgbmV4dCB5ZWFyCiAgICAgKiAgIERhdGUuY3JlYXRlKCdUaHVyc2RheScsIHtmcm9tVVRDOiB0cnVlfSkgLT4gVGh1cnNkYXkgYXQgMTI6MDBhbSBVVEMgdGltZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcnxEYXRlfSBkCiAgICAgKiBAcGFyYW0ge0RhdGVDcmVhdGVPcHRpb25zfSBbb3B0aW9uc10KICAgICAqCiAgICAgKiBAb3B0aW9uIHtzdHJpbmd9IFtsb2NhbGVdCiAgICAgKiBAb3B0aW9uIHtib29sZWFufSBbcGFzdF0KICAgICAqIEBvcHRpb24ge2Jvb2xlYW59IFtmdXR1cmVdCiAgICAgKiBAb3B0aW9uIHtib29sZWFufSBbZnJvbVVUQ10KICAgICAqIEBvcHRpb24ge2Jvb2xlYW59IFtzZXRVVENdCiAgICAgKiBAb3B0aW9uIHtib29sZWFufSBbY2xvbmVdCiAgICAgKiBAb3B0aW9uIHtPYmplY3R9IFtwYXJhbXNdCiAgICAgKgogICAgICoqKi8KICAgICdjcmVhdGUnOiBmdW5jdGlvbihkLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiBjcmVhdGVEYXRlKGQsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGdldExvY2FsZShbbG9jYWxlQ29kZV0gPSBjdXJyZW50KQogICAgICogQHJldHVybnMgTG9jYWxlCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2hvcnQgR2V0cyB0aGUgbG9jYWxlIG9iamVjdCBmb3IgdGhlIGdpdmVuIGNvZGUsIG9yIHRoZSBjdXJyZW50IGxvY2FsZS4KICAgICAqIEBleHRyYSBUaGUgbG9jYWxlIG9iamVjdCBoYXMgdmFyaW91cyBwcm9wZXJ0aWVzIHRoYXQgZGljdGF0ZSBob3cgZGF0ZXMgYXJlCiAgICAgKiAgICAgICAgcGFyc2VkIGFuZCBmb3JtYXR0ZWQgZm9yIHRoYXQgbG9jYWxlLiBUaGUgbG9jYWxlIG9iamVjdCBpcyBleHBvc2VkCiAgICAgKiAgICAgICAgaGVyZSBtb3N0bHkgZm9yIGludHJvc3BlY3Rpb24gLSBpdCBzaG91bGQgYmUgdW5jb21tb24gdG8gbmVlZCB0bwogICAgICogICAgICAgIG1hbmlwbGF0ZSB0aGUgb2JqZWN0IGl0c2VsZi4gRm9yIG1vcmUsIHNlZSBgZGF0ZSBsb2NhbGVzYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgRGF0ZS5nZXRMb2NhbGUoKSAgICAgLT4gUmV0dXJucyB0aGUgY3VycmVudCBsb2NhbGUKICAgICAqICAgRGF0ZS5nZXRMb2NhbGUoJ2VuJykgLT4gUmV0dXJucyB0aGUgRU4gbG9jYWxlCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtsb2NhbGVDb2RlXQogICAgICoKICAgICAqKiovCiAgICAnZ2V0TG9jYWxlJzogZnVuY3Rpb24oY29kZSkgewogICAgICByZXR1cm4gbG9jYWxlTWFuYWdlci5nZXQoY29kZSwgIWNvZGUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGdldEFsbExvY2FsZXMoKQogICAgICogQHJldHVybnMgQXJyYXk8TG9jYWxlPgogICAgICogQHN0YXRpYwogICAgICogQHNob3J0IFJldHVybnMgYWxsIGF2YWlsYWJsZSBsb2NhbGVzIGFzIGFuIG9iamVjdC4KICAgICAqIEBleHRyYSBGb3IgbW9yZSwgc2VlIGBkYXRlIGxvY2FsZXNgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIERhdGUuZ2V0QWxsTG9jYWxlcygpCiAgICAgKgogICAgICoqKi8KICAgICdnZXRBbGxMb2NhbGVzJzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBsb2NhbGVNYW5hZ2VyLmdldEFsbCgpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGdldEFsbExvY2FsZUNvZGVzKCkKICAgICAqIEByZXR1cm5zIHN0cmluZ1tdCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2hvcnQgUmV0dXJucyBhbGwgYXZhaWxhYmxlIGxvY2FsZSBjb2RlcyBhcyBhbiBhcnJheSBvZiBzdHJpbmdzLgogICAgICogQGV4dHJhIEZvciBtb3JlLCBzZWUgYGRhdGUgbG9jYWxlc2AuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgRGF0ZS5nZXRBbGxMb2NhbGVDb2RlcygpCiAgICAgKgogICAgICoqKi8KICAgICdnZXRBbGxMb2NhbGVDb2Rlcyc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZ2V0S2V5cyhsb2NhbGVNYW5hZ2VyLmdldEFsbCgpKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBzZXRMb2NhbGUobG9jYWxlQ29kZSkKICAgICAqIEByZXR1cm5zIExvY2FsZQogICAgICogQHN0YXRpYwogICAgICogQHNob3J0IFNldHMgdGhlIGN1cnJlbnQgbG9jYWxlIHRvIGJlIHVzZWQgd2l0aCBkYXRlcy4KICAgICAqIEBleHRyYSBTdWdhciBoYXMgbmF0aXZlIHN1cHBvcnQgZm9yIDE3IG1ham9yIGxvY2FsZXMuIEluIGFkZGl0aW9uLCB5b3UgY2FuCiAgICAgKiAgICAgICAgZGVmaW5lIGEgbmV3IGxvY2FsZSB3aXRoIGBhZGRMb2NhbGVgLiBGb3IgbW9yZSwgc2VlIGBkYXRlIGxvY2FsZXNgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIERhdGUuc2V0TG9jYWxlKCdlbicpCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGxvY2FsZUNvZGUKICAgICAqCiAgICAgKioqLwogICAgJ3NldExvY2FsZSc6IGZ1bmN0aW9uKGNvZGUpIHsKICAgICAgcmV0dXJuIGxvY2FsZU1hbmFnZXIuc2V0KGNvZGUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGFkZExvY2FsZShsb2NhbGVDb2RlLCBkZWYpCiAgICAgKiBAcmV0dXJucyBMb2NhbGUKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaG9ydCBBZGRzIGEgbG9jYWxlIGRlZmluaXRpb24gdG8gdGhlIGxvY2FsZXMgdW5kZXJzdG9vZCBieSBTdWdhci4KICAgICAqIEBleHRyYSBUaGlzIG1ldGhvZCBzaG91bGQgb25seSBiZSByZXF1aXJlZCBmb3IgYWRkaW5nIGxvY2FsZSBkZWZpbml0aW9ucwogICAgICogICAgICAgIHRoYXQgZG9uJ3QgYWxyZWFkeSBleGlzdC4gRm9yIG1vcmUsIHNlZSBgZGF0ZSBsb2NhbGVzYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBEYXRlLmFkZExvY2FsZSgnZW8nLCB7fSkKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYWxlQ29kZQogICAgICogQHBhcmFtIHtPYmplY3R9IGRlZgogICAgICoKICAgICAqKiovCiAgICAnYWRkTG9jYWxlJzogZnVuY3Rpb24oY29kZSwgc2V0KSB7CiAgICAgIHJldHVybiBsb2NhbGVNYW5hZ2VyLmFkZChjb2RlLCBzZXQpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJlbW92ZUxvY2FsZShsb2NhbGVDb2RlKQogICAgICogQHJldHVybnMgTG9jYWxlCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2hvcnQgRGVsZXRlcyB0aGUgdGhlIGxvY2FsZSBieSBgbG9jYWxlQ29kZWAgZnJvbSBTdWdhcidzIGtub3duIGxvY2FsZXMuCiAgICAgKiBAZXh0cmEgRm9yIG1vcmUsIHNlZSBgZGF0ZSBsb2NhbGVzYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBEYXRlLnJlbW92ZUxvY2FsZSgnZm9vJykKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYWxlQ29kZQogICAgICoKICAgICAqKiovCiAgICAncmVtb3ZlTG9jYWxlJzogZnVuY3Rpb24oY29kZSkgewogICAgICByZXR1cm4gbG9jYWxlTWFuYWdlci5yZW1vdmUoY29kZSk7CiAgICB9CgogIH0pOwoKICBkZWZpbmVJbnN0YW5jZVdpdGhBcmd1bWVudHMoc3VnYXJEYXRlLCB7CgogICAgLyoqKgogICAgICogQG1ldGhvZCBzZXQoc2V0LCBbcmVzZXRdID0gZmFsc2UpCiAgICAgKiBAcmV0dXJucyBEYXRlCiAgICAgKiBAc2hvcnQgU2V0cyB0aGUgZGF0ZSBvYmplY3QuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgYWNjZXB0cyBtdWx0aXBsZSBmb3JtYXRzIGluY2x1ZGluZyBhIHNpbmdsZSBudW1iZXIgYXMKICAgICAqICAgICAgICBhIHRpbWVzdGFtcCwgYW4gb2JqZWN0LCBvciBlbnVtZXJhdGVkIGFyZ3VtZW50cy4gSWYgW3Jlc2V0XSBpcwogICAgICogICAgICAgIGB0cnVlYCwgYW55IHVuaXRzIG1vcmUgc3BlY2lmaWMgdGhhbiB0aG9zZSBwYXNzZWQgd2lsbCBiZSByZXNldC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5zZXQoe3llYXI6MjAxMSxtb250aDoxMSxkYXk6MzF9KSAtPiBEZWNlbWJlciAzMSwgMjAxMQogICAgICogICBuZXcgRGF0ZSgpLnNldCgyMDExLCAxMSwgMzEpICAgICAgICAgICAgICAgIC0+IERlY2VtYmVyIDMxLCAyMDExCiAgICAgKiAgIG5ldyBEYXRlKCkuc2V0KDg2NDAwMDAwKSAgICAgICAgICAgICAgICAgICAgLT4gMSBkYXkgYWZ0ZXIgSmFuIDEsIDE5NzAKICAgICAqICAgbmV3IERhdGUoKS5zZXQoe3llYXI6MjAwNCxtb250aDo2fSwgdHJ1ZSkgICAtPiBKdW5lIDEsIDIwMDQsIDAwOjAwOjAwLjAwMAogICAgICoKICAgICAqIEBzaWduYXR1cmUgc2V0KG1pbGxpc2Vjb25kcykKICAgICAqIEBzaWduYXR1cmUgc2V0KHllYXIsIG1vbnRoLCBbZGF5XSwgW2hvdXJdLCBbbWludXRlXSwgW3NlY29uZF0sIFttaWxsbGlzZWNvbmRzXSkKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0XQogICAgICogQHBhcmFtIHtudW1iZXJ9IHllYXIKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtb250aAogICAgICogQHBhcmFtIHtudW1iZXJ9IFtkYXldCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2hvdXJdCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21pbnV0ZV0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc2Vjb25kXQogICAgICogQHBhcmFtIHtudW1iZXJ9IFttaWxsaXNlY29uZHNdCiAgICAgKgogICAgICoqKi8KICAgICdzZXQnOiBmdW5jdGlvbihkLCBhcmdzKSB7CiAgICAgIGFyZ3MgPSBjb2xsZWN0RGF0ZUFyZ3VtZW50cyhhcmdzKTsKICAgICAgcmV0dXJuIHVwZGF0ZURhdGUoZCwgYXJnc1swXSwgYXJnc1sxXSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgYWR2YW5jZShzZXQsIFtyZXNldF0gPSBmYWxzZSkKICAgICAqIEByZXR1cm5zIERhdGUKICAgICAqIEBzaG9ydCBTaGlmdHMgdGhlIGRhdGUgZm9yd2FyZC4KICAgICAqIEBleHRyYSBgc2V0YCBhY2NlcHRzIG11bHRpcGxlIGZvcm1hdHMgaW5jbHVkaW5nIGFuIG9iamVjdCwgYSBzdHJpbmcgaW4gdGhlCiAgICAgKiAgICAgICAgZm9ybWF0ICIzIGRheXMiLCBhIHNpbmdsZSBudW1iZXIgYXMgbWlsbGlzZWNvbmRzLCBvciBlbnVtZXJhdGVkCiAgICAgKiAgICAgICAgcGFyYW1ldGVycyAoYXMgd2l0aCB0aGUgRGF0ZSBjb25zdHJ1Y3RvcikuIElmIFtyZXNldF0gaXMgYHRydWVgLCBhbnkKICAgICAqICAgICAgICB1bml0cyBtb3JlIHNwZWNpZmljIHRoYW4gdGhvc2UgcGFzc2VkIHdpbGwgYmUgcmVzZXQuIFRoaXMgbWV0aG9kCiAgICAgKiAgICAgICAgbW9kaWZpZXMgdGhlIGRhdGUhCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG5ldyBEYXRlKCkuYWR2YW5jZSh7IHllYXI6IDIgfSkgLT4gMiB5ZWFycyBpbiB0aGUgZnV0dXJlCiAgICAgKiAgIG5ldyBEYXRlKCkuYWR2YW5jZSgnMiBob3VycycpICAgLT4gMiBob3VycyBpbiB0aGUgZnV0dXJlCiAgICAgKiAgIG5ldyBEYXRlKCkuYWR2YW5jZSgwLCAyLCAzKSAgICAgLT4gMiBtb250aHMgMyBkYXlzIGluIHRoZSBmdXR1cmUKICAgICAqICAgbmV3IERhdGUoKS5hZHZhbmNlKDg2NDAwMDAwKSAgICAtPiAxIGRheSBpbiB0aGUgZnV0dXJlCiAgICAgKgogICAgICogQHNpZ25hdHVyZSBhZHZhbmNlKG1pbGxpc2Vjb25kcykKICAgICAqIEBzaWduYXR1cmUgYWR2YW5jZSh5ZWFyLCBtb250aCwgW2RheV0sIFtob3VyXSwgW21pbnV0ZV0sIFtzZWNvbmRdLCBbbWlsbGxpc2Vjb25kc10pCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IHNldAogICAgICogQHBhcmFtIHtib29sZWFufSBbcmVzZXRdCiAgICAgKiBAcGFyYW0ge251bWJlcn0geWVhcgogICAgICogQHBhcmFtIHtudW1iZXJ9IG1vbnRoCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2RheV0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaG91cl0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWludXRlXQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtzZWNvbmRdCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21pbGxpc2Vjb25kc10KICAgICAqCiAgICAgKioqLwogICAgJ2FkdmFuY2UnOiBmdW5jdGlvbihkLCBhcmdzKSB7CiAgICAgIHJldHVybiBhZHZhbmNlRGF0ZVdpdGhBcmdzKGQsIGFyZ3MsIDEpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJld2luZChzZXQsIFtyZXNldF0gPSBmYWxzZSkKICAgICAqIEByZXR1cm5zIERhdGUKICAgICAqIEBzaG9ydCBTaGlmdHMgdGhlIGRhdGUgYmFja3dhcmQuCiAgICAgKiBAZXh0cmEgW3NldF0gYWNjZXB0cyBtdWx0aXBsZSBmb3JtYXRzIGluY2x1ZGluZyBhbiBvYmplY3QsIGEgc3RyaW5nIGluIHRoZQogICAgICogICAgICAgIGZvcm1hdCAiMyBkYXlzIiwgYSBzaW5nbGUgbnVtYmVyIGFzIG1pbGxpc2Vjb25kcywgb3IgZW51bWVyYXRlZAogICAgICogICAgICAgIHBhcmFtZXRlcnMgKGFzIHdpdGggdGhlIERhdGUgY29uc3RydWN0b3IpLiBJZiBbcmVzZXRdIGlzIGB0cnVlYCwgYW55CiAgICAgKiAgICAgICAgdW5pdHMgbW9yZSBzcGVjaWZpYyB0aGFuIHRob3NlIHBhc3NlZCB3aWxsIGJlIHJlc2V0LiBUaGlzIG1ldGhvZAogICAgICogICAgICAgIG1vZGlmaWVzIHRoZSBkYXRlIQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBuZXcgRGF0ZSgpLnJld2luZCh7IHllYXI6IDIgfSkgLT4gMiB5ZWFycyBpbiB0aGUgcGFzdAogICAgICogICBuZXcgRGF0ZSgpLnJld2luZCgnMiB3ZWVrcycpICAgLT4gMiB3ZWVrcyBpbiB0aGUgcGFzdAogICAgICogICBuZXcgRGF0ZSgpLnJld2luZCgwLCAyLCAzKSAgICAgLT4gMiBtb250aHMgMyBkYXlzIGluIHRoZSBwYXN0CiAgICAgKiAgIG5ldyBEYXRlKCkucmV3aW5kKDg2NDAwMDAwKSAgICAtPiAxIGRheSBpbiB0aGUgcGFzdAogICAgICoKICAgICAqIEBzaWduYXR1cmUgYWR2YW5jZShtaWxsaXNlY29uZHMpCiAgICAgKiBAc2lnbmF0dXJlIGFkdmFuY2UoeWVhciwgbW9udGgsIFtkYXldLCBbaG91cl0sIFttaW51dGVdLCBbc2Vjb25kXSwgW21pbGxsaXNlY29uZHNdKQogICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBzZXQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0XQogICAgICogQHBhcmFtIHtudW1iZXJ9IHllYXIKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtb250aAogICAgICogQHBhcmFtIHtudW1iZXJ9IFtkYXldCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2hvdXJdCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21pbnV0ZV0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc2Vjb25kXQogICAgICogQHBhcmFtIHtudW1iZXJ9IFttaWxsaXNlY29uZHNdCiAgICAgKgogICAgICoqKi8KICAgICdyZXdpbmQnOiBmdW5jdGlvbihkLCBhcmdzKSB7CiAgICAgIHJldHVybiBhZHZhbmNlRGF0ZVdpdGhBcmdzKGQsIGFyZ3MsIC0xKTsKICAgIH0KCiAgfSk7CgogIGRlZmluZUluc3RhbmNlKHN1Z2FyRGF0ZSwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZ2V0KGQsIFtvcHRpb25zXSkKICAgICAqIEByZXR1cm5zIERhdGUKICAgICAqIEBzaG9ydCBHZXRzIGEgbmV3IGRhdGUgdXNpbmcgdGhlIGN1cnJlbnQgb25lIGFzIGEgc3RhcnRpbmcgcG9pbnQuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgaXMgaWRlbnRpY2FsIHRvIGBEYXRlLmNyZWF0ZWAsIGV4Y2VwdCB0aGF0IHJlbGF0aXZlCiAgICAgKiAgICAgICAgZm9ybWF0cyBsaWtlIGBuZXh0IG1vbnRoYCBhcmUgcmVsYXRpdmUgdG8gdGhlIGRhdGUgaW5zdGFuY2UgcmF0aGVyCiAgICAgKiAgICAgICAgdGhhbiB0aGUgY3VycmVudCBkYXRlLiBBY2NlcHRzIGEgbG9jYWxlIGNvZGUgYXMgYSBzdHJpbmcgaW4gcGxhY2UKICAgICAqICAgICAgICBvZiBbb3B0aW9uc10uIFNlZSBgY3JlYXRlYCBmb3IgbW9yZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV4dFllYXIuZ2V0KCdtb25kYXknKSAtPiBtb25kYXkgb2YgdGhlIHdlZWsgZXhhY3RseSAxIHllYXIgZnJvbSBub3cKICAgICAqICAgbWlsbGVuaXVtLmdldCgnMiB5ZWFycyBiZWZvcmUnKSAtPiAyIHllYXJzIGJlZm9yZSBKYW4gMSwgMjAwMC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ8RGF0ZX0gZAogICAgICogQHBhcmFtIHtEYXRlQ3JlYXRlT3B0aW9uc30gb3B0aW9ucwogICAgICoKICAgICAqKiovCiAgICAnZ2V0JzogZnVuY3Rpb24oZGF0ZSwgZCwgb3B0aW9ucykgewogICAgICByZXR1cm4gY3JlYXRlRGF0ZVdpdGhDb250ZXh0KGRhdGUsIGQsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHNldFdlZWtkYXkoZG93KQogICAgICogQHNob3J0IFNldHMgdGhlIHdlZWtkYXkgb2YgdGhlIGRhdGUsIHN0YXJ0aW5nIHdpdGggU3VuZGF5IGF0IGAwYC4KICAgICAqIEBleHRyYSBUaGlzIG1ldGhvZCBtb2RpZmllcyB0aGUgZGF0ZSEKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgZCA9IG5ldyBEYXRlKCk7IGQuc2V0V2Vla2RheSgxKTsgZDsgLT4gTW9uZGF5IG9mIHRoaXMgd2VlawogICAgICogICBkID0gbmV3IERhdGUoKTsgZC5zZXRXZWVrZGF5KDYpOyBkOyAtPiBTYXR1cmRheSBvZiB0aGlzIHdlZWsKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZG93CiAgICAgKgogICAgICoqKi8KICAgICdzZXRXZWVrZGF5JzogZnVuY3Rpb24oZGF0ZSwgZG93KSB7CiAgICAgIHJldHVybiBzZXRXZWVrZGF5KGRhdGUsIGRvdyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2Qgc2V0SVNPV2VlayhudW0pCiAgICAgKiBAc2hvcnQgU2V0cyB0aGUgd2VlayAob2YgdGhlIHllYXIpIGFzIGRlZmluZWQgYnkgdGhlIElTTzg2MDEgc3RhbmRhcmQuCiAgICAgKiBAZXh0cmEgTm90ZSB0aGF0IHRoaXMgc3RhbmRhcmQgcGxhY2VzIFN1bmRheSBhdCB0aGUgZW5kIG9mIHRoZSB3ZWVrIChkYXkgNykuCiAgICAgKiAgICAgICAgVGhpcyBtZXRob2QgbW9kaWZpZXMgdGhlIGRhdGUhCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIGQgPSBuZXcgRGF0ZSgpOyBkLnNldElTT1dlZWsoMTUpOyBkOyAtPiAxNXRoIHdlZWsgb2YgdGhlIHllYXIKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbnVtCiAgICAgKgogICAgICoqKi8KICAgICdzZXRJU09XZWVrJzogZnVuY3Rpb24oZGF0ZSwgbnVtKSB7CiAgICAgIHJldHVybiBzZXRJU09XZWVrTnVtYmVyKGRhdGUsIG51bSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZ2V0SVNPV2VlaygpCiAgICAgKiBAcmV0dXJucyBOdW1iZXIKICAgICAqIEBzaG9ydCBHZXRzIHRoZSBkYXRlJ3Mgd2VlayAob2YgdGhlIHllYXIpIGFzIGRlZmluZWQgYnkgdGhlIElTTzg2MDEgc3RhbmRhcmQuCiAgICAgKiBAZXh0cmEgTm90ZSB0aGF0IHRoaXMgc3RhbmRhcmQgcGxhY2VzIFN1bmRheSBhdCB0aGUgZW5kIG9mIHRoZSB3ZWVrIChkYXkgNykuCiAgICAgKiAgICAgICAgSWYgYHV0Y2AgaXMgc2V0IG9uIHRoZSBkYXRlLCB0aGUgd2VlayB3aWxsIGJlIGFjY29yZGluZyB0byBVVEMgdGltZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5nZXRJU09XZWVrKCkgLT4gdG9kYXkncyB3ZWVrIG9mIHRoZSB5ZWFyCiAgICAgKgogICAgICoqKi8KICAgICdnZXRJU09XZWVrJzogZnVuY3Rpb24oZGF0ZSkgewogICAgICByZXR1cm4gZ2V0V2Vla051bWJlcihkYXRlLCB0cnVlKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBiZWdpbm5pbmdPZklTT1dlZWsoKQogICAgICogQHJldHVybnMgRGF0ZQogICAgICogQHNob3J0IFNldCB0aGUgZGF0ZSB0byB0aGUgYmVnaW5uaW5nIG9mIHdlZWsgYXMgZGVmaW5lZCBieSBJU084NjAxLgogICAgICogQGV4dHJhIE5vdGUgdGhhdCB0aGlzIHN0YW5kYXJkIHBsYWNlcyBNb25kYXkgYXQgdGhlIHN0YXJ0IG9mIHRoZSB3ZWVrLgogICAgICogICAgICAgIFRoaXMgbWV0aG9kIG1vZGlmaWVzIHRoZSBkYXRlIQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBuZXcgRGF0ZSgpLmJlZ2lubmluZ09mSVNPV2VlaygpIC0+IE1vbmRheQogICAgICoKICAgICAqKiovCiAgICAnYmVnaW5uaW5nT2ZJU09XZWVrJzogZnVuY3Rpb24oZGF0ZSkgewogICAgICB2YXIgZGF5ID0gZ2V0V2Vla2RheShkYXRlKTsKICAgICAgaWYgKGRheSA9PT0gMCkgewogICAgICAgIGRheSA9IC02OwogICAgICB9IGVsc2UgaWYgKGRheSAhPT0gMSkgewogICAgICAgIGRheSA9IDE7CiAgICAgIH0KICAgICAgc2V0V2Vla2RheShkYXRlLCBkYXkpOwogICAgICByZXR1cm4gcmVzZXRUaW1lKGRhdGUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGVuZE9mSVNPV2VlaygpCiAgICAgKiBAcmV0dXJucyBEYXRlCiAgICAgKiBAc2hvcnQgU2V0IHRoZSBkYXRlIHRvIHRoZSBlbmQgb2Ygd2VlayBhcyBkZWZpbmVkIGJ5IHRoaXMgSVNPODYwMSBzdGFuZGFyZC4KICAgICAqIEBleHRyYSBOb3RlIHRoYXQgdGhpcyBzdGFuZGFyZCBwbGFjZXMgU3VuZGF5IGF0IHRoZSBlbmQgb2YgdGhlIHdlZWsuCiAgICAgKiAgICAgICAgVGhpcyBtZXRob2QgbW9kaWZpZXMgdGhlIGRhdGUhCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG5ldyBEYXRlKCkuZW5kT2ZJU09XZWVrKCkgLT4gU3VuZGF5CiAgICAgKgogICAgICoqKi8KICAgICdlbmRPZklTT1dlZWsnOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgIGlmIChnZXRXZWVrZGF5KGRhdGUpICE9PSAwKSB7CiAgICAgICAgc2V0V2Vla2RheShkYXRlLCA3KTsKICAgICAgfQogICAgICByZXR1cm4gbW92ZVRvRW5kT2ZVbml0KGRhdGUsIERBWV9JTkRFWCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZ2V0VVRDT2Zmc2V0KFtpc29dID0gZmFsc2UpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBvZmZzZXQgZnJvbSBVVEMgdGltZS4gSWYgW2lzb10KICAgICAqICAgICAgICBpcyB0cnVlIHRoZSBvZmZzZXQgd2lsbCBiZSBpbiBJU084NjAxIGZvcm1hdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5nZXRVVENPZmZzZXQoKSAgICAgLT4gIiswOTAwIgogICAgICogICBuZXcgRGF0ZSgpLmdldFVUQ09mZnNldCh0cnVlKSAtPiAiKzA5OjAwIgogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNvCiAgICAgKgogICAgICoqKi8KICAgICdnZXRVVENPZmZzZXQnOiBmdW5jdGlvbihkYXRlLCBpc28pIHsKICAgICAgcmV0dXJuIGdldFVUQ09mZnNldChkYXRlLCBpc28pOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHNldFVUQyhbb25dID0gZmFsc2UpCiAgICAgKiBAcmV0dXJucyBEYXRlCiAgICAgKiBAc2hvcnQgQ29udHJvbHMgYSBmbGFnIG9uIHRoZSBkYXRlIHRoYXQgdGVsbHMgU3VnYXIgdG8gaW50ZXJuYWxseSB1c2UgVVRDCiAgICAgKiAgICAgICAgbWV0aG9kcyBsaWtlIGBnZXRVVENIb3Vyc2AuCiAgICAgKiBAZXh0cmEgVGhpcyBmbGFnIGlzIG1vc3QgY29tbW9ubHkgdXNlZCBmb3Igb3V0cHV0IGluIFVUQyB0aW1lIHdpdGggdGhlCiAgICAgKiAgICAgICAgYGZvcm1hdGAgbWV0aG9kLiBOb3RlIHRoYXQgdGhpcyBmbGFnIG9ubHkgZ292ZXJucyB3aGljaCBtZXRob2RzIGFyZQogICAgICogICAgICAgIGNhbGxlZCBpbnRlcm5hbGx5IOKAkyBkYXRlIG5hdGl2ZSBtZXRob2RzIGxpa2UgYHNldEhvdXJzYCB3aWxsIHN0aWxsCiAgICAgKiAgICAgICAgcmV0dXJuIGxvY2FsIG5vbi1VVEMgdmFsdWVzLiBUaGlzIG1ldGhvZCB3aWxsIG1vZGlmeSB0aGUgZGF0ZSEKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5zZXRVVEModHJ1ZSkubG9uZygpICAtPiBmb3JtYXR0ZWQgd2l0aCBVVEMgbWV0aG9kcwogICAgICogICBuZXcgRGF0ZSgpLnNldFVUQyhmYWxzZSkubG9uZygpIC0+IGZvcm1hdHRlZCB3aXRob3V0IFVUQyBtZXRob2RzCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFufSBvbgogICAgICoKICAgICAqKiovCiAgICAnc2V0VVRDJzogZnVuY3Rpb24oZGF0ZSwgb24pIHsKICAgICAgcmV0dXJuIF91dGMoZGF0ZSwgb24pOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGlzVVRDKCkKICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgdGhlIGRhdGUgaGFzIG5vIHRpbWV6b25lIG9mZnNldC4KICAgICAqIEBleHRyYSBUaGlzIHdpbGwgYWxzbyByZXR1cm4gdHJ1ZSBmb3IgZGF0ZXMgd2hvc2UgaW50ZXJuYWwgdXRjIGZsYWcgaXMgc2V0CiAgICAgKiAgICAgICAgd2l0aCBgc2V0VVRDYC4gRXZlbiBpZiB0aGUgdXRjIGZsYWcgaXMgc2V0LCBgZ2V0VGltZXpvbmVPZmZzZXRgCiAgICAgKiAgICAgICAgd2lsbCBhbHdheXMgcmVwb3J0IHRoZSBzYW1lIHRoaW5nIGFzIEphdmFzY3JpcHQgYWx3YXlzIHJlcG9ydHMgdGhhdAogICAgICogICAgICAgIGJhc2VkIG9uIHRoZSBlbnZpcm9ubWVudCdzIGxvY2FsZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5pc1VUQygpIC0+IHRydWUgb3IgZmFsc2UgKGRlcGVuZHMgb24gdGhlIGxvY2FsIG9mZnNldCkKICAgICAqICAgbmV3IERhdGUoKS5zZXRVVEModHJ1ZSkuaXNVVEMoKSAtPiB0cnVlCiAgICAgKgogICAgICoqKi8KICAgICdpc1VUQyc6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgcmV0dXJuIGlzVVRDKGRhdGUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGlzVmFsaWQoKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgZGF0ZSBpcyB2YWxpZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5pc1ZhbGlkKCkgICAgICAgICAtPiB0cnVlCiAgICAgKiAgIG5ldyBEYXRlKCdmbGV4b3InKS5pc1ZhbGlkKCkgLT4gZmFsc2UKICAgICAqCiAgICAgKioqLwogICAgJ2lzVmFsaWQnOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgIHJldHVybiBkYXRlSXNWYWxpZChkYXRlKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBpc0FmdGVyKGQsIFttYXJnaW5dID0gMCkKICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgdGhlIGRhdGUgaXMgYWZ0ZXIgYGRgLgogICAgICogQGV4dHJhIFttYXJnaW5dIGlzIHRvIGFsbG93IGV4dHJhIG1hcmdpbiBvZiBlcnJvciBpbiBtcy4gYGRgIHdpbGwgYWNjZXB0CiAgICAgKiAgICAgICAgYSBkYXRlIG9iamVjdCwgdGltZXN0YW1wLCBvciBzdHJpbmcuIElmIG5vdCBzcGVjaWZpZWQsIGBkYCBpcwogICAgICogICAgICAgIGFzc3VtZWQgdG8gYmUgbm93LiBTZWUgYGNyZWF0ZWAgZm9yIGZvcm1hdHMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIHRvZGF5LmlzQWZ0ZXIoJ3RvbW9ycm93JykgIC0+IGZhbHNlCiAgICAgKiAgIHRvZGF5LmlzQWZ0ZXIoJ3llc3RlcmRheScpIC0+IHRydWUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ8RGF0ZX0gZAogICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXJnaW5dCiAgICAgKgogICAgICoqKi8KICAgICdpc0FmdGVyJzogZnVuY3Rpb24oZGF0ZSwgZCwgbWFyZ2luKSB7CiAgICAgIHJldHVybiBkYXRlLmdldFRpbWUoKSA+IGNyZWF0ZURhdGUoZCkuZ2V0VGltZSgpIC0gKG1hcmdpbiB8fCAwKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBpc0JlZm9yZShkLCBbbWFyZ2luXSA9IDApCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBkYXRlIGlzIGJlZm9yZSBgZGAuCiAgICAgKiBAZXh0cmEgW21hcmdpbl0gaXMgdG8gYWxsb3cgZXh0cmEgbWFyZ2luIG9mIGVycm9yIGluIG1zLiBgZGAgd2lsbCBhY2NlcHQKICAgICAqICAgICAgICBhIGRhdGUgb2JqZWN0LCB0aW1lc3RhbXAsIG9yIHRleHQgZm9ybWF0LiBJZiBub3Qgc3BlY2lmaWVkLCBgZGAgaXMKICAgICAqICAgICAgICBhc3N1bWVkIHRvIGJlIG5vdy4gU2VlIGBjcmVhdGVgIGZvciBmb3JtYXRzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICB0b2RheS5pc0JlZm9yZSgndG9tb3Jyb3cnKSAgLT4gdHJ1ZQogICAgICogICB0b2RheS5pc0JlZm9yZSgneWVzdGVyZGF5JykgLT4gZmFsc2UKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ8RGF0ZX0gZAogICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXJnaW5dCiAgICAgKgogICAgICoqKi8KICAgICdpc0JlZm9yZSc6IGZ1bmN0aW9uKGRhdGUsIGQsIG1hcmdpbikgewogICAgICByZXR1cm4gZGF0ZS5nZXRUaW1lKCkgPCBjcmVhdGVEYXRlKGQpLmdldFRpbWUoKSArIChtYXJnaW4gfHwgMCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaXNCZXR3ZWVuKGQxLCBkMiwgW21hcmdpbl0gPSAwKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgZGF0ZSBpcyBsYXRlciBvciBlcXVhbCB0byBgZDFgIGFuZCBiZWZvcmUgb3IKICAgICAqICAgICAgICBlcXVhbCB0byBgZDJgLgogICAgICogQGV4dHJhIFttYXJnaW5dIGlzIHRvIGFsbG93IGV4dHJhIG1hcmdpbiBvZiBlcnJvciBpbiBtcy4gYGQxYCBhbmQgYGQyYCB3aWxsCiAgICAgKiAgICAgICAgYWNjZXB0IGEgZGF0ZSBvYmplY3QsIHRpbWVzdGFtcCwgb3IgdGV4dCBmb3JtYXQuIElmIG5vdCBzcGVjaWZpZWQsCiAgICAgKiAgICAgICAgdGhleSBhcmUgYXNzdW1lZCB0byBiZSBub3cuICBTZWUgYGNyZWF0ZWAgZm9yIGZvcm1hdHMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG5ldyBEYXRlKCkuaXNCZXR3ZWVuKCd5ZXN0ZXJkYXknLCAndG9tb3Jyb3cnKSAgICAtPiB0cnVlCiAgICAgKiAgIG5ldyBEYXRlKCkuaXNCZXR3ZWVuKCdsYXN0IHllYXInLCAnMiB5ZWFycyBhZ28nKSAtPiBmYWxzZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcnxEYXRlfSBkMQogICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfERhdGV9IGQyCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21hcmdpbl0KICAgICAqCiAgICAgKioqLwogICAgJ2lzQmV0d2Vlbic6IGZ1bmN0aW9uKGRhdGUsIGQxLCBkMiwgbWFyZ2luKSB7CiAgICAgIHZhciB0ICA9IGRhdGUuZ2V0VGltZSgpOwogICAgICB2YXIgdDEgPSBjcmVhdGVEYXRlKGQxKS5nZXRUaW1lKCk7CiAgICAgIHZhciB0MiA9IGNyZWF0ZURhdGUoZDIpLmdldFRpbWUoKTsKICAgICAgdmFyIGxvID0gbWluKHQxLCB0Mik7CiAgICAgIHZhciBoaSA9IG1heCh0MSwgdDIpOwogICAgICBtYXJnaW4gPSBtYXJnaW4gfHwgMDsKICAgICAgcmV0dXJuIChsbyAtIG1hcmdpbiA8PSB0KSAmJiAoaGkgKyBtYXJnaW4gPj0gdCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaXNMZWFwWWVhcigpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBkYXRlIGlzIGEgbGVhcCB5ZWFyLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBtaWxsZW5pdW0uaXNMZWFwWWVhcigpIC0+IHRydWUKICAgICAqCiAgICAgKioqLwogICAgJ2lzTGVhcFllYXInOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgIHZhciB5ZWFyID0gZ2V0WWVhcihkYXRlKTsKICAgICAgcmV0dXJuICh5ZWFyICUgNCA9PT0gMCAmJiB5ZWFyICUgMTAwICE9PSAwKSB8fCAoeWVhciAlIDQwMCA9PT0gMCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZGF5c0luTW9udGgoKQogICAgICogQHJldHVybnMgTnVtYmVyCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0aGUgbnVtYmVyIG9mIGRheXMgaW4gdGhlIGRhdGUncyBtb250aC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbWF5LmRheXNJbk1vbnRoKCkgLT4gMzEKICAgICAqICAgZmViLmRheXNJbk1vbnRoKCkgLT4gMjggb3IgMjkKICAgICAqCiAgICAgKioqLwogICAgJ2RheXNJbk1vbnRoJzogZnVuY3Rpb24oZGF0ZSkgewogICAgICByZXR1cm4gZ2V0RGF5c0luTW9udGgoZGF0ZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZm9ybWF0KFtmXSwgW2xvY2FsZUNvZGVdID0gY3VycmVudExvY2FsZUNvZGUpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBkYXRlIGFzIGEgc3RyaW5nIHVzaW5nIHRoZSBmb3JtYXQgYGZgLgogICAgICogQGV4dHJhIGBmYCBpcyBhIHN0cmluZyB0aGF0IGNvbnRhaW5zIHRva2VucyBpbiBlaXRoZXIgTERNTCBmb3JtYXQgdXNpbmcKICAgICAqICAgICAgICBjdXJseSBicmFjZXMsIG9yICJzdHJmdGltZSIgZm9ybWF0IHVzaW5nIGEgcGVyY2VudCBzaWduLiBJZiBgZmAgaXMKICAgICAqICAgICAgICBub3Qgc3BlY2lmaWVkLCB0aGUgbG9jYWxlIHNwZWNpZmljIGB7bG9uZ31gIGZvcm1hdCBpcyB1c2VkLiBbbG9jYWxlQ29kZV0KICAgICAqICAgICAgICBpcyBhIGxvY2FsZSBjb2RlIHRvIHVzZSAoaWYgbm90IHNwZWNpZmllZCB0aGUgY3VycmVudCBsb2NhbGUgaXMKICAgICAqICAgICAgICB1c2VkKS4gRm9yIG1vcmUsIHNlZSBgZGF0ZSBmb3JtYXR0aW5nYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5mb3JtYXQoKSAgICAgICAgICAgICAgICAgICAgICAgIC0+IGV4LiBGZWJydWFyeSAxMywgMjAxMiAxMToyMSBBTQogICAgICogICBuZXcgRGF0ZSgpLmZvcm1hdCgne1dlZWtkYXl9IHtkfSB7TW9udGh9JykgLT4gZXguIE1vbmRheSBKdWx5IDQKICAgICAqICAgbmV3IERhdGUoKS5mb3JtYXQoJ3toaH06e21tfScpICAgICAgICAgICAgIC0+IGV4LiAxNTo1NwogICAgICogICBuZXcgRGF0ZSgpLmZvcm1hdCgnJUg6JU0nKSAgICAgICAgICAgICAgICAgLT4gZXguIDE1OjU3CiAgICAgKiAgIG5ldyBEYXRlKCkuZm9ybWF0KCd7MTJocn06e21tfXt0dH0nKSAgICAgICAtPiBleC4gMzo1N3BtCiAgICAgKiAgIG5ldyBEYXRlKCkuZm9ybWF0KCdJU084NjAxJykgICAgICAgICAgICAgICAtPiBleC4gMjAxMS0wNy0wNSAxMjoyNDo1NS41MjhaCiAgICAgKiAgIG5ldyBEYXRlKCkuZm9ybWF0KCd7V2Vla2RheX0nLCAnamEnKSAgICAgICAtPiBleC4g5YWI6YCxCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGYKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbG9jYWxlQ29kZV0KICAgICAqCiAgICAgKioqCiAgICAgKiBAbWV0aG9kIHNob3J0KFtsb2NhbGVDb2RlXSA9IGN1cnJlbnRMb2NhbGVDb2RlKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgT3V0cHV0cyB0aGUgZGF0ZSBpbiB0aGUgc2hvcnQgZm9ybWF0IGZvciB0aGUgY3VycmVudCBsb2NhbGUuCiAgICAgKiBAZXh0cmEgW2xvY2FsZUNvZGVdIG92ZXJyaWRlcyB0aGUgY3VycmVudCBsb2NhbGUgY29kZSBpZiBwYXNzZWQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG5ldyBEYXRlKCkuc2hvcnQoKSAgICAgLT4gZXguIDAyLzEzLzIwMTYKICAgICAqICAgbmV3IERhdGUoKS5zaG9ydCgnZmknKSAtPiBleC4gMTMuMi4yMDE2CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtsb2NhbGVDb2RlXQogICAgICoKICAgICAqKioKICAgICAqIEBtZXRob2QgbWVkaXVtKFtsb2NhbGVDb2RlXSA9IGN1cnJlbnRMb2NhbGVDb2RlKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgT3V0cHV0cyB0aGUgZGF0ZSBpbiB0aGUgbWVkaXVtIGZvcm1hdCBmb3IgdGhlIGN1cnJlbnQgbG9jYWxlLgogICAgICogQGV4dHJhIFtsb2NhbGVDb2RlXSBvdmVycmlkZXMgdGhlIGN1cnJlbnQgbG9jYWxlIGNvZGUgaWYgcGFzc2VkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBuZXcgRGF0ZSgpLm1lZGl1bSgpICAgICAtPiBleC4gRmVicnVhcnkgMTMsIDIwMTYKICAgICAqICAgbmV3IERhdGUoKS5tZWRpdW0oJ2phJykgLT4gZXguIDIwMTblubQy5pyIMTPml6UKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2xvY2FsZUNvZGVdCiAgICAgKgogICAgICoqKgogICAgICogQG1ldGhvZCBsb25nKFtsb2NhbGVDb2RlXSA9IGN1cnJlbnRMb2NhbGVDb2RlKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgT3V0cHV0cyB0aGUgZGF0ZSBpbiB0aGUgbG9uZyBmb3JtYXQgZm9yIHRoZSBjdXJyZW50IGxvY2FsZS4KICAgICAqIEBleHRyYSBbbG9jYWxlQ29kZV0gb3ZlcnJpZGVzIHRoZSBjdXJyZW50IGxvY2FsZSBjb2RlIGlmIHBhc3NlZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5sb25nKCkgICAgIC0+IGV4LiBGZWJydWFyeSAxMywgMjAxNiA2OjIyIFBNCiAgICAgKiAgIG5ldyBEYXRlKCkubG9uZygnZXMnKSAtPiBleC4gMTMgZGUgZmVicmVybyBkZSAyMDE2IDE4OjIyCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtsb2NhbGVDb2RlXQogICAgICoKICAgICAqKioKICAgICAqIEBtZXRob2QgZnVsbChbbG9jYWxlQ29kZV0gPSBjdXJyZW50TG9jYWxlQ29kZSkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IE91dHB1dHMgdGhlIGRhdGUgaW4gdGhlIGZ1bGwgZm9ybWF0IGZvciB0aGUgY3VycmVudCBsb2NhbGUuCiAgICAgKiBAZXh0cmEgW2xvY2FsZUNvZGVdIG92ZXJyaWRlcyB0aGUgY3VycmVudCBsb2NhbGUgY29kZSBpZiBwYXNzZWQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG5ldyBEYXRlKCkuZnVsbCgpICAgICAtPiBleC4gU2F0dXJkYXksIEZlYnJ1YXJ5IDEzLCAyMDE2IDY6MjMgUE0KICAgICAqICAgbmV3IERhdGUoKS5mdWxsKCdydScpIC0+IGV4LiDRgdGD0LHQsdC+0YLQsCwgMTMg0YTQtdCy0YDQsNC70Y8gMjAxNiDQsy4sIDE4OjIzCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtsb2NhbGVDb2RlXQogICAgICoKICAgICAqKiovCiAgICAnZm9ybWF0JzogZnVuY3Rpb24oZGF0ZSwgZiwgbG9jYWxlQ29kZSkgewogICAgICByZXR1cm4gZGF0ZUZvcm1hdChkYXRlLCBmLCBsb2NhbGVDb2RlKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCByZWxhdGl2ZShbbG9jYWxlQ29kZV0gPSBjdXJyZW50TG9jYWxlQ29kZSwgW2ZuXSkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJldHVybnMgdGhlIGRhdGUgaW4gYSB0ZXh0IGZvcm1hdCByZWxhdGl2ZSB0byB0aGUgY3VycmVudCB0aW1lLAogICAgICogICAgICAgIHN1Y2ggYXMgIjUgbWludXRlcyBhZ28iLgogICAgICogQGV4dHJhIFtmbl0gaXMgYSBmdW5jdGlvbiB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gcHJvdmlkZSBtb3JlIGdyYW51bGFyCiAgICAgKiAgICAgICAgY29udHJvbCBvdmVyIHRoZSByZXN1bHRpbmcgc3RyaW5nLiBJdHMgcmV0dXJuIHZhbHVlIHdpbGwgYmUgcGFzc2VkCiAgICAgKiAgICAgICAgdG8gYGZvcm1hdGAuIElmIG5vdGhpbmcgaXMgcmV0dXJuZWQsIHRoZSByZWxhdGl2ZSBmb3JtYXQgd2lsbCBiZQogICAgICogICAgICAgIHVzZWQuIFtmbl0gbWF5IGJlIHBhc3NlZCBhcyB0aGUgZmlyc3QgYXJndW1lbnQgaW4gcGxhY2Ugb2YgW2xvY2FsZV0uCiAgICAgKiAgICAgICAgRm9yIG1vcmUgYWJvdXQgZm9ybWF0cywgc2VlIGBkYXRlIGZvcm1hdHRpbmdgLgogICAgICoKICAgICAqIEBjYWxsYmFjayByZWxhdGl2ZUZuCiAgICAgKgogICAgICogICBudW0gICBUaGUgb2Zmc2V0IG51bWJlciBpbiBgdW5pdGAuCiAgICAgKiAgIHVuaXQgIEEgbnVtZXJpYyByZXByZXNlbnRhdGlvbiBvZiB0aGUgdW5pdCB0aGF0IGBudW1gIGlzIGluLCBzdGFydGluZyBhdAogICAgICogICAgICAgICAwIGZvciBtcy4KICAgICAqICAgbXMgICAgVGhlIGFic29sdXRlIG9mZnNldCBpbiBtaWxsaXNlY29uZHMuCiAgICAgKiAgIGxvYyAgIFRoZSBsb2NhbGUgb2JqZWN0LCBlaXRoZXIgc3BlY2lmaWVkIGJ5IFtsb2NhbGVdIG9yIGRlZmF1bHQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIGhvdXJBZ28ucmVsYXRpdmUoKSAtPiAxIGhvdXIgYWdvCiAgICAgKiAgIGphbi5yZWxhdGl2ZSgpICAgICAtPiBleC4gNSBtb250aHMgYWdvCiAgICAgKiAgIGphbi5yZWxhdGl2ZSgnamEnKSAtPiAz44O25pyI5YmNCiAgICAgKiAgIGphbi5yZWxhdGl2ZShmdW5jdGlvbihudW0sIHVuaXQsIG1zLCBsb2MpIHsKICAgICAqICAgICAvLyBSZXR1cm4gYW4gYWJzb2x1dGUgZGF0ZSBmb3IgYW55dGhpbmcgb3ZlciA2IG1vbnRocy4KICAgICAqICAgICBpZih1bml0ID09IDYgJiYgbnVtID4gNiB8fCB1bml0ID4gNikgewogICAgICogICAgICAgcmV0dXJuICd7TW9udGh9IHtkfSwge3l5eXl9JzsKICAgICAqICAgICB9CiAgICAgKiAgIH0pOyAtPiBleC4gNSBtb250aHMgYWdvCiAgICAgKgogICAgICogQHNpZ25hdHVyZSByZWxhdGl2ZShbZm5dKQogICAgICogQHBhcmFtIHtzdHJpbmd9IFtsb2NhbGVDb2RlXQogICAgICogQHBhcmFtIHtyZWxhdGl2ZUZufSBbZm5dCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBudW0KICAgICAqIEBjYWxsYmFja1BhcmFtIHtudW1iZXJ9IHVuaXQKICAgICAqIEBjYWxsYmFja1BhcmFtIHtudW1iZXJ9IG1zCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7TG9jYWxlfSBsb2MKICAgICAqIEBjYWxsYmFja1JldHVybnMge3N0cmluZ30gcmVsYXRpdmVGbgogICAgICoKICAgICAqKiovCiAgICAncmVsYXRpdmUnOiBmdW5jdGlvbihkYXRlLCBsb2NhbGVDb2RlLCBmbikgewogICAgICByZXR1cm4gZGF0ZVJlbGF0aXZlKGRhdGUsIG51bGwsIGxvY2FsZUNvZGUsIGZuKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCByZWxhdGl2ZVRvKGQsIFtsb2NhbGVDb2RlXSA9IGN1cnJlbnRMb2NhbGVDb2RlKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0aGUgZGF0ZSBpbiBhIHRleHQgZm9ybWF0IHJlbGF0aXZlIHRvIGBkYCwgc3VjaCBhcwogICAgICogICAgICAgICI1IG1pbnV0ZXMiLgogICAgICogQGV4dHJhIGBkYCB3aWxsIGFjY2VwdCBhIGRhdGUgb2JqZWN0LCB0aW1lc3RhbXAsIG9yIHN0cmluZy4gW2xvY2FsZUNvZGVdCiAgICAgKiAgICAgICAgYXBwbGllcyB0byB0aGUgbWV0aG9kIG91dHB1dCwgbm90IGBkYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgamFuLnJlbGF0aXZlVG8oanVsKSAgICAgICAgICAgICAgICAgLT4gNSBtb250aHMKICAgICAqICAgeWVzdGVyZGF5LnJlbGF0aXZlVG8oJ3RvZGF5JywgJ2phJykgLT4g5LiA5pelCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfERhdGV9IGQKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhbGVDb2RlCiAgICAgKgogICAgICoKICAgICAqKiovCiAgICAncmVsYXRpdmVUbyc6IGZ1bmN0aW9uKGRhdGUsIGQsIGxvY2FsZUNvZGUpIHsKICAgICAgcmV0dXJuIGRhdGVSZWxhdGl2ZShkYXRlLCBjcmVhdGVEYXRlKGQpLCBsb2NhbGVDb2RlKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBpcyhkLCBbbWFyZ2luXSA9IDApCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBkYXRlIG1hdGNoZXMgYGRgLgogICAgICogQGV4dHJhIGBkYCB3aWxsIGFjY2VwdCBhIGRhdGUgb2JqZWN0LCB0aW1lc3RhbXAsIG9yIHRleHQgZm9ybWF0LiBJbiB0aGUKICAgICAqICAgICAgICBjYXNlIG9mIG9iamVjdHMgYW5kIHRleHQgZm9ybWF0cywgYGlzYCB3aWxsIGFkZGl0aW9uYWxseSBjb21wYXJlCiAgICAgKiAgICAgICAgYmFzZWQgb24gdGhlIHByZWNpc2lvbiBpbXBsaWVkIGluIHRoZSBpbnB1dC4gSW4gdGhlIGNhc2Ugb2YgdGV4dAogICAgICogICAgICAgIGZvcm1hdHMgYGRgIHdpbGwgdXNlIHRoZSBjdXJyZW50bHkgc2V0IGxvY2FsZS4gW21hcmdpbl0gYWxsb3dzIGFuCiAgICAgKiAgICAgICAgZXh0cmEgbWFyZ2luIG9mIGVycm9yIGluIG1pbGxpc2Vjb25kcy4gU2VlIGBjcmVhdGVgIGZvciBmb3JtYXRzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBuZXcgRGF0ZSgpLmlzKCdKdWx5JykgICAgICAgICAgICAgICAtPiB0cnVlIG9yIGZhbHNlPwogICAgICogICBuZXcgRGF0ZSgpLmlzKCcxNzc2JykgICAgICAgICAgICAgICAtPiBmYWxzZQogICAgICogICBuZXcgRGF0ZSgpLmlzKCd0b2RheScpICAgICAgICAgICAgICAtPiB0cnVlCiAgICAgKiAgIG5ldyBEYXRlKCkuaXMoJ3dlZWtkYXknKSAgICAgICAgICAgIC0+IHRydWUgb3IgZmFsc2U/CiAgICAgKiAgIG5ldyBEYXRlKCkuaXMoJ0p1bHkgNCwgMTc3NicpICAgICAgIC0+IGZhbHNlCiAgICAgKiAgIG5ldyBEYXRlKCkuaXMoLTYxMDYwOTMyMDAwMDApICAgICAgIC0+IGZhbHNlCiAgICAgKiAgIG5ldyBEYXRlKCkuaXMobmV3IERhdGUoMTc3NiwgNiwgNCkpIC0+IGZhbHNlCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfERhdGV9IGQKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFyZ2luXQogICAgICoKICAgICAqKiovCiAgICAnaXMnOiBmdW5jdGlvbihkYXRlLCBkLCBtYXJnaW4pIHsKICAgICAgcmV0dXJuIGZ1bGxDb21wYXJlRGF0ZShkYXRlLCBkLCBtYXJnaW4pOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJlc2V0KFt1bml0XSA9ICdkYXknLCBbbG9jYWxlQ29kZV0gPSBjdXJyZW50TG9jYWxlQ29kZSkKICAgICAqIEByZXR1cm5zIERhdGUKICAgICAqIEBzaG9ydCBSZXNldHMgdGhlIGRhdGUgdG8gdGhlIGJlZ2lubmluZyBvZiBbdW5pdF0uCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgZWZmZWN0aXZlbHkgcmVzZXRzIGFsbCBzbWFsbGVyIHVuaXRzLCBwdXNoaW5nIHRoZSBkYXRlCiAgICAgKiAgICAgICAgdG8gdGhlIGJlZ2lubmluZyBvZiBbdW5pdF0uIERlZmF1bHQgaXMgYGRheWAsIHdoaWNoIGVmZmVjdGl2ZWx5CiAgICAgKiAgICAgICAgcmVzZXRzIHRoZSB0aW1lLiBbbG9jYWxlQ29kZV0gaXMgcHJvdmlkZWQgZm9yIHJlc2V0dGluZyB3ZWVrcywgd2hpY2gKICAgICAqICAgICAgICBpcyBsb2NhbGUgZGVwZW5kZW50LiBUaGlzIG1ldGhvZCBtb2RpZmllcyB0aGUgZGF0ZSEKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbmV3IERhdGUoKS5yZXNldCgnZGF5JykgICAtPiBCZWdpbm5pbmcgb2YgdGhlIGRheQogICAgICogICBuZXcgRGF0ZSgpLnJlc2V0KCdtb250aCcpIC0+IEJlZ2lubmluZyBvZiB0aGUgbW9udGgKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3VuaXRdCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2xvY2FsZUNvZGVdCiAgICAgKgogICAgICoqKi8KICAgICdyZXNldCc6IGZ1bmN0aW9uKGRhdGUsIHVuaXQsIGxvY2FsZUNvZGUpIHsKICAgICAgdmFyIHVuaXRJbmRleCA9IHVuaXQgPyBnZXRVbml0SW5kZXhGb3JQYXJhbU5hbWUodW5pdCkgOiBEQVlfSU5ERVg7CiAgICAgIG1vdmVUb0JlZ2lubmluZ09mVW5pdChkYXRlLCB1bml0SW5kZXgsIGxvY2FsZUNvZGUpOwogICAgICByZXR1cm4gZGF0ZTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBjbG9uZSgpCiAgICAgKiBAcmV0dXJucyBEYXRlCiAgICAgKiBAc2hvcnQgQ2xvbmVzIHRoZSBkYXRlLgogICAgICogQGV4dHJhIE5vdGUgdGhhdCB0aGUgVVRDIGZsYWcgd2lsbCBiZSBwcmVzZXJ2ZWQgaWYgc2V0LiBUaGlzIGZsYWcgaXMKICAgICAqICAgICAgICBzZXQgdmlhIHRoZSBgc2V0VVRDYCBtZXRob2Qgb3IgYW4gb3B0aW9uIG9uIGBEYXRlLmNyZWF0ZWAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG5ldyBEYXRlKCkuY2xvbmUoKSAtPiBDb3B5IG9mIG5vdwogICAgICoKICAgICAqKiovCiAgICAnY2xvbmUnOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgIHJldHVybiBjbG9uZURhdGUoZGF0ZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaXNvKCkKICAgICAqIEBhbGlhcyB0b0lTT1N0cmluZwogICAgICoKICAgICAqKiovCiAgICAnaXNvJzogZnVuY3Rpb24oZGF0ZSkgewogICAgICByZXR1cm4gZGF0ZS50b0lTT1N0cmluZygpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGdldFdlZWtkYXkoKQogICAgICogQHJldHVybnMgTnVtYmVyCiAgICAgKiBAc2hvcnQgQWxpYXMgZm9yIGBnZXREYXlgLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBuZXcgRGF0ZSgpLmdldFdlZWtkYXkoKTsgICAgLT4gKGV4LikgMwogICAgICoKICAgICAqKiovCiAgICAnZ2V0V2Vla2RheSc6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgcmV0dXJuIGdldFdlZWtkYXkoZGF0ZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZ2V0VVRDV2Vla2RheSgpCiAgICAgKiBAcmV0dXJucyBOdW1iZXIKICAgICAqIEBzaG9ydCBBbGlhcyBmb3IgYGdldFVUQ0RheWAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG5ldyBEYXRlKCkuZ2V0VVRDV2Vla2RheSgpOyAtPiAoZXguKSAzCiAgICAgKgogICAgICoqKi8KICAgICdnZXRVVENXZWVrZGF5JzogZnVuY3Rpb24oZGF0ZSkgewogICAgICByZXR1cm4gZGF0ZS5nZXRVVENEYXkoKTsKICAgIH0KCiAgfSk7CgoKICAvKioqIEBuYW1lc3BhY2UgTnVtYmVyICoqKi8KCiAgLyoqKgogICAqIEBtZXRob2QgW2RhdGVVbml0XSgpCiAgICogQHJldHVybnMgTnVtYmVyCiAgICogQHNob3J0IFRha2VzIHRoZSBudW1iZXIgYXMgYSB1bml0IG9mIHRpbWUgYW5kIGNvbnZlcnRzIHRvIG1pbGxpc2Vjb25kcy4KICAgKiBAZXh0cmEgTWV0aG9kIG5hbWVzIGNhbiBiZSBzaW5ndWxhciBvciBwbHVyYWwuICBOb3RlIHRoYXQgYXMgImEgbW9udGgiIGlzCiAgICogICAgICAgIGFtYmlndW91cyBhcyBhIHVuaXQgb2YgdGltZSwgYG1vbnRoc2Agd2lsbCBiZSBlcXVpdmFsZW50IHRvIDMwLjQzNzUKICAgKiAgICAgICAgZGF5cywgdGhlIGF2ZXJhZ2UgbnVtYmVyIGluIGEgbW9udGguIEJlIGNhcmVmdWwgdXNpbmcgYG1vbnRoc2AgaWYgeW91CiAgICogICAgICAgIG5lZWQgZXhhY3QgcHJlY2lzaW9uLgogICAqCiAgICogQHNldAogICAqICAgbWlsbGlzZWNvbmQKICAgKiAgIG1pbGxpc2Vjb25kcwogICAqICAgc2Vjb25kCiAgICogICBzZWNvbmRzCiAgICogICBtaW51dGUKICAgKiAgIG1pbnV0ZXMKICAgKiAgIGhvdXIKICAgKiAgIGhvdXJzCiAgICogICBkYXkKICAgKiAgIGRheXMKICAgKiAgIHdlZWsKICAgKiAgIHdlZWtzCiAgICogICBtb250aAogICAqICAgbW9udGhzCiAgICogICB5ZWFyCiAgICogICB5ZWFycwogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgKDUpLm1pbGxpc2Vjb25kcygpIC0+IDUKICAgKiAgICgxMCkuaG91cnMoKSAgICAgICAtPiAzNjAwMDAwMAogICAqICAgKDEpLmRheSgpICAgICAgICAgIC0+IDg2NDAwMDAwCiAgICoKICAgKioqCiAgICogQG1ldGhvZCBbZGF0ZVVuaXRdQmVmb3JlKGQsIFtvcHRpb25zXSkKICAgKiBAcmV0dXJucyBEYXRlCiAgICogQHNob3J0IFJldHVybnMgYSBkYXRlIHRoYXQgaXMgYG5gIHVuaXRzIGJlZm9yZSBbZF0sIHdoZXJlIGBuYCBpcyB0aGUgbnVtYmVyLgogICAqIEBleHRyYSBbZF0gd2lsbCBhY2NlcHQgYSBkYXRlIG9iamVjdCwgdGltZXN0YW1wLCBvciB0ZXh0IGZvcm1hdC4gTm90ZSB0aGF0CiAgICogICAgICAgICJtb250aHMiIGlzIGFtYmlndW91cyBhcyBhIHVuaXQgb2YgdGltZS4gSWYgdGhlIHRhcmdldCBkYXRlIGZhbGxzIG9uIGEKICAgKiAgICAgICAgZGF5IHRoYXQgZG9lcyBub3QgZXhpc3QgKGkuZS4gQXVndXN0IDMxIC0+IEZlYnJ1YXJ5IDMxKSwgdGhlIGRhdGUgd2lsbAogICAqICAgICAgICBiZSBzaGlmdGVkIHRvIHRoZSBsYXN0IGRheSBvZiB0aGUgbW9udGguIEJlIGNhcmVmdWwgdXNpbmcKICAgKiAgICAgICAgYG1vbnRoc0JlZm9yZWAgaWYgeW91IG5lZWQgZXhhY3QgcHJlY2lzaW9uLiBbb3B0aW9uc10gY2FuIGJlIGFuIG9iamVjdAogICAqICAgICAgICBvciBhIGxvY2FsZSBjb2RlIGFzIGEgc3RyaW5nLiBTZWUgYGNyZWF0ZWAgZm9yIG1vcmUuCiAgICoKICAgKgogICAqIEBzZXQKICAgKiAgIG1pbGxpc2Vjb25kQmVmb3JlCiAgICogICBtaWxsaXNlY29uZHNCZWZvcmUKICAgKiAgIHNlY29uZEJlZm9yZQogICAqICAgc2Vjb25kc0JlZm9yZQogICAqICAgbWludXRlQmVmb3JlCiAgICogICBtaW51dGVzQmVmb3JlCiAgICogICBob3VyQmVmb3JlCiAgICogICBob3Vyc0JlZm9yZQogICAqICAgZGF5QmVmb3JlCiAgICogICBkYXlzQmVmb3JlCiAgICogICB3ZWVrQmVmb3JlCiAgICogICB3ZWVrc0JlZm9yZQogICAqICAgbW9udGhCZWZvcmUKICAgKiAgIG1vbnRoc0JlZm9yZQogICAqICAgeWVhckJlZm9yZQogICAqICAgeWVhcnNCZWZvcmUKICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICg1KS5kYXlzQmVmb3JlKCd0dWVzZGF5JykgICAgICAgICAgLT4gNSBkYXlzIGJlZm9yZSB0dWVzZGF5IG9mIHRoaXMgd2VlawogICAqICAgKDEpLnllYXJCZWZvcmUoJ0phbnVhcnkgMjMsIDE5OTcnKSAtPiBKYW51YXJ5IDIzLCAxOTk2CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ8RGF0ZX0gZAogICAqIEBwYXJhbSB7RGF0ZUNyZWF0ZU9wdGlvbnN9IG9wdGlvbnMKICAgKgogICAqKioKICAgKiBAbWV0aG9kIFtkYXRlVW5pdF1BZ28oKQogICAqIEByZXR1cm5zIERhdGUKICAgKiBAc2hvcnQgUmV0dXJucyBhIGRhdGUgdGhhdCBpcyBgbmAgdW5pdHMgYWdvLgogICAqIEBleHRyYSBOb3RlIHRoYXQgIm1vbnRocyIgaXMgYW1iaWd1b3VzIGFzIGEgdW5pdCBvZiB0aW1lLiBJZiB0aGUgdGFyZ2V0IGRhdGUKICAgKiAgICAgICAgZmFsbHMgb24gYSBkYXkgdGhhdCBkb2VzIG5vdCBleGlzdCAoaS5lLiBBdWd1c3QgMzEgLT4gRmVicnVhcnkgMzEpLCB0aGUKICAgKiAgICAgICAgZGF0ZSB3aWxsIGJlIHNoaWZ0ZWQgdG8gdGhlIGxhc3QgZGF5IG9mIHRoZSBtb250aC4gQmUgY2FyZWZ1bCB1c2luZwogICAqICAgICAgICBgbW9udGhzQWdvYCBpZiB5b3UgbmVlZCBleGFjdCBwcmVjaXNpb24uCiAgICoKICAgKiBAc2V0CiAgICogICBtaWxsaXNlY29uZEFnbwogICAqICAgbWlsbGlzZWNvbmRzQWdvCiAgICogICBzZWNvbmRBZ28KICAgKiAgIHNlY29uZHNBZ28KICAgKiAgIG1pbnV0ZUFnbwogICAqICAgbWludXRlc0FnbwogICAqICAgaG91ckFnbwogICAqICAgaG91cnNBZ28KICAgKiAgIGRheUFnbwogICAqICAgZGF5c0FnbwogICAqICAgd2Vla0FnbwogICAqICAgd2Vla3NBZ28KICAgKiAgIG1vbnRoQWdvCiAgICogICBtb250aHNBZ28KICAgKiAgIHllYXJBZ28KICAgKiAgIHllYXJzQWdvCiAgICoKICAgKiBAZXhhbXBsZQogICAqCiAgICogICAoNSkud2Vla3NBZ28oKSAtPiA1IHdlZWtzIGFnbwogICAqICAgKDEpLnllYXJBZ28oKSAgLT4gSmFudWFyeSAyMywgMTk5NgogICAqCiAgICoqKgogICAqIEBtZXRob2QgW2RhdGVVbml0XUFmdGVyKGQsIFtvcHRpb25zXSkKICAgKiBAcmV0dXJucyBEYXRlCiAgICogQHNob3J0IFJldHVybnMgYSBkYXRlIGBuYCB1bml0cyBhZnRlciBbZF0sIHdoZXJlIGBuYCBpcyB0aGUgbnVtYmVyLgogICAqIEBleHRyYSBbZF0gd2lsbCBhY2NlcHQgYSBkYXRlIG9iamVjdCwgdGltZXN0YW1wLCBvciB0ZXh0IGZvcm1hdC4gTm90ZSB0aGF0CiAgICogICAgICAgICJtb250aHMiIGlzIGFtYmlndW91cyBhcyBhIHVuaXQgb2YgdGltZS4gSWYgdGhlIHRhcmdldCBkYXRlIGZhbGxzIG9uIGEKICAgKiAgICAgICAgZGF5IHRoYXQgZG9lcyBub3QgZXhpc3QgKGkuZS4gQXVndXN0IDMxIC0+IEZlYnJ1YXJ5IDMxKSwgdGhlIGRhdGUgd2lsbAogICAqICAgICAgICBiZSBzaGlmdGVkIHRvIHRoZSBsYXN0IGRheSBvZiB0aGUgbW9udGguIEJlIGNhcmVmdWwgdXNpbmcKICAgKiAgICAgICAgYG1vbnRoc0FmdGVyYCBpZiB5b3UgbmVlZCBleGFjdCBwcmVjaXNpb24uIFtvcHRpb25zXSBjYW4gYmUgYW4gb2JqZWN0CiAgICogICAgICAgIG9yIGEgbG9jYWxlIGNvZGUgYXMgYSBzdHJpbmcuIFNlZSBgY3JlYXRlYCBmb3IgbW9yZS4KICAgKgogICAqIEBzZXQKICAgKiAgIG1pbGxpc2Vjb25kQWZ0ZXIKICAgKiAgIG1pbGxpc2Vjb25kc0FmdGVyCiAgICogICBzZWNvbmRBZnRlcgogICAqICAgc2Vjb25kc0FmdGVyCiAgICogICBtaW51dGVBZnRlcgogICAqICAgbWludXRlc0FmdGVyCiAgICogICBob3VyQWZ0ZXIKICAgKiAgIGhvdXJzQWZ0ZXIKICAgKiAgIGRheUFmdGVyCiAgICogICBkYXlzQWZ0ZXIKICAgKiAgIHdlZWtBZnRlcgogICAqICAgd2Vla3NBZnRlcgogICAqICAgbW9udGhBZnRlcgogICAqICAgbW9udGhzQWZ0ZXIKICAgKiAgIHllYXJBZnRlcgogICAqICAgeWVhcnNBZnRlcgogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgKDUpLmRheXNBZnRlcigndHVlc2RheScpICAgICAgICAgIC0+IDUgZGF5cyBhZnRlciB0dWVzZGF5IG9mIHRoaXMgd2VlawogICAqICAgKDEpLnllYXJBZnRlcignSmFudWFyeSAyMywgMTk5NycpIC0+IEphbnVhcnkgMjMsIDE5OTgKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcnxEYXRlfSBkCiAgICogQHBhcmFtIHtEYXRlQ3JlYXRlT3B0aW9uc30gb3B0aW9ucwogICAqCiAgICoqKgogICAqIEBtZXRob2QgW2RhdGVVbml0XUZyb21Ob3coKQogICAqIEByZXR1cm5zIERhdGUKICAgKiBAc2hvcnQgUmV0dXJucyBhIGRhdGUgYG5gIHVuaXRzIGZyb20gbm93LgogICAqIEBleHRyYSBOb3RlIHRoYXQgIm1vbnRocyIgaXMgYW1iaWd1b3VzIGFzIGEgdW5pdCBvZiB0aW1lLiBJZiB0aGUgdGFyZ2V0IGRhdGUKICAgKiAgICAgICAgZmFsbHMgb24gYSBkYXkgdGhhdCBkb2VzIG5vdCBleGlzdCAoaS5lLiBBdWd1c3QgMzEgLT4gRmVicnVhcnkgMzEpLCB0aGUKICAgKiAgICAgICAgZGF0ZSB3aWxsIGJlIHNoaWZ0ZWQgdG8gdGhlIGxhc3QgZGF5IG9mIHRoZSBtb250aC4gQmUgY2FyZWZ1bCB1c2luZwogICAqICAgICAgICBgbW9udGhzRnJvbU5vd2AgaWYgeW91IG5lZWQgZXhhY3QgcHJlY2lzaW9uLgogICAqCiAgICogQHNldAogICAqICAgbWlsbGlzZWNvbmRGcm9tTm93CiAgICogICBtaWxsaXNlY29uZHNGcm9tTm93CiAgICogICBzZWNvbmRGcm9tTm93CiAgICogICBzZWNvbmRzRnJvbU5vdwogICAqICAgbWludXRlRnJvbU5vdwogICAqICAgbWludXRlc0Zyb21Ob3cKICAgKiAgIGhvdXJGcm9tTm93CiAgICogICBob3Vyc0Zyb21Ob3cKICAgKiAgIGRheUZyb21Ob3cKICAgKiAgIGRheXNGcm9tTm93CiAgICogICB3ZWVrRnJvbU5vdwogICAqICAgd2Vla3NGcm9tTm93CiAgICogICBtb250aEZyb21Ob3cKICAgKiAgIG1vbnRoc0Zyb21Ob3cKICAgKiAgIHllYXJGcm9tTm93CiAgICogICB5ZWFyc0Zyb21Ob3cKICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICg1KS53ZWVrc0Zyb21Ob3coKSAtPiA1IHdlZWtzIGFnbwogICAqICAgKDEpLnllYXJGcm9tTm93KCkgIC0+IEphbnVhcnkgMjMsIDE5OTgKICAgKgogICAqKiovCiAgZnVuY3Rpb24gYnVpbGROdW1iZXJVbml0TWV0aG9kcygpIHsKICAgIGRlZmluZUluc3RhbmNlU2ltaWxhcihzdWdhck51bWJlciwgRGF0ZVVuaXRzLCBmdW5jdGlvbihtZXRob2RzLCB1bml0KSB7CiAgICAgIHZhciBuYW1lID0gdW5pdC5uYW1lLCBiYXNlLCBhZnRlciwgYmVmb3JlOwogICAgICBiYXNlID0gZnVuY3Rpb24obikgewogICAgICAgIHJldHVybiByb3VuZChuICogdW5pdC5tdWx0aXBsaWVyKTsKICAgICAgfTsKICAgICAgYWZ0ZXIgPSBmdW5jdGlvbihuLCBkLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIGFkdmFuY2VEYXRlKGNyZWF0ZURhdGUoZCwgb3B0aW9ucywgdHJ1ZSksIG5hbWUsIG4pOwogICAgICB9OwogICAgICBiZWZvcmUgPSBmdW5jdGlvbihuLCBkLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIGFkdmFuY2VEYXRlKGNyZWF0ZURhdGUoZCwgb3B0aW9ucywgdHJ1ZSksIG5hbWUsIC1uKTsKICAgICAgfTsKICAgICAgbWV0aG9kc1tuYW1lXSA9IGJhc2U7CiAgICAgIG1ldGhvZHNbbmFtZSArICdzJ10gPSBiYXNlOwogICAgICBtZXRob2RzW25hbWUgKyAnQmVmb3JlJ10gPSBiZWZvcmU7CiAgICAgIG1ldGhvZHNbbmFtZSArICdzQmVmb3JlJ10gPSBiZWZvcmU7CiAgICAgIG1ldGhvZHNbbmFtZSArICdBZ28nXSA9IGJlZm9yZTsKICAgICAgbWV0aG9kc1tuYW1lICsgJ3NBZ28nXSA9IGJlZm9yZTsKICAgICAgbWV0aG9kc1tuYW1lICsgJ0FmdGVyJ10gPSBhZnRlcjsKICAgICAgbWV0aG9kc1tuYW1lICsgJ3NBZnRlciddID0gYWZ0ZXI7CiAgICAgIG1ldGhvZHNbbmFtZSArICdGcm9tTm93J10gPSBhZnRlcjsKICAgICAgbWV0aG9kc1tuYW1lICsgJ3NGcm9tTm93J10gPSBhZnRlcjsKICAgIH0pOwogIH0KCiAgZGVmaW5lSW5zdGFuY2Uoc3VnYXJOdW1iZXIsIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGR1cmF0aW9uKFtsb2NhbGVDb2RlXSA9IGN1cnJlbnRMb2NhbGVDb2RlKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgVGFrZXMgdGhlIG51bWJlciBhcyBtaWxsaXNlY29uZHMgYW5kIHJldHVybnMgYSBsb2NhbGl6ZWQgc3RyaW5nLgogICAgICogQGV4dHJhIFRoaXMgbWV0aG9kIGlzIHRoZSBzYW1lIGFzIGBEYXRlI3JlbGF0aXZlYCB3aXRob3V0IHRoZSBsb2NhbGl6ZWQKICAgICAqICAgICAgICBlcXVpdmFsZW50IG9mICJmcm9tIG5vdyIgb3IgImFnbyIuIFtsb2NhbGVDb2RlXSBjYW4gYmUgcGFzc2VkIGFzIHRoZQogICAgICogICAgICAgIGZpcnN0IChhbmQgb25seSkgcGFyYW1ldGVyLiBOb3RlIHRoYXQgdGhpcyBtZXRob2QgaXMgb25seSBhdmFpbGFibGUKICAgICAqICAgICAgICB3aGVuIHRoZSBkYXRlcyBtb2R1bGUgaXMgaW5jbHVkZWQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICg1MDApLmR1cmF0aW9uKCkgLT4gJzUwMCBtaWxsaXNlY29uZHMnCiAgICAgKiAgICgxMjAwKS5kdXJhdGlvbigpIC0+ICcxIHNlY29uZCcKICAgICAqICAgKDc1KS5taW51dGVzKCkuZHVyYXRpb24oKSAtPiAnMSBob3VyJwogICAgICogICAoNzUpLm1pbnV0ZXMoKS5kdXJhdGlvbignZXMnKSAtPiAnMSBob3JhJwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbG9jYWxlQ29kZV0KICAgICAqCiAgICAgKioqLwogICAgJ2R1cmF0aW9uJzogZnVuY3Rpb24obiwgbG9jYWxlQ29kZSkgewogICAgICByZXR1cm4gbG9jYWxlTWFuYWdlci5nZXQobG9jYWxlQ29kZSkuZ2V0RHVyYXRpb24obik7CiAgICB9CgogIH0pOwoKCiAgdmFyIEVuZ2xpc2hMb2NhbGVCYXNlRGVmaW5pdGlvbiA9IHsKICAgICdjb2RlJzogJ2VuJywKICAgICdwbHVyYWwnOiB0cnVlLAogICAgJ3RpbWVNYXJrZXJzJzogJ2F0JywKICAgICdhbXBtJzogJ0FNfEEuTS58YSxQTXxQLk0ufHAnLAogICAgJ3VuaXRzJzogJ21pbGxpc2Vjb25kOnxzLHNlY29uZDp8cyxtaW51dGU6fHMsaG91cjp8cyxkYXk6fHMsd2Vlazp8cyxtb250aDp8cyx5ZWFyOnxzJywKICAgICdtb250aHMnOiAnSmFuOnVhcnl8LEZlYjpydWFyeXwsTWFyOmNofCxBcHI6aWx8LE1heSxKdW46ZXwsSnVsOnl8LEF1Zzp1c3R8LFNlcDp0ZW1iZXJ8dHwsT2N0Om9iZXJ8LE5vdjplbWJlcnwsRGVjOmVtYmVyfCcsCiAgICAnd2Vla2RheXMnOiAnU3VuOmRheXwsTW9uOmRheXwsVHVlOnNkYXl8LFdlZDpuZXNkYXl8LFRodTpyc2RheXwsRnJpOmRheXwsU2F0OnVyZGF5fCt3ZWVrZW5kJywKICAgICdudW1lcmFscyc6ICd6ZXJvLG9uZXxmaXJzdCx0d298c2Vjb25kLHRocmVlfHRoaXJkLGZvdXI6fHRoLGZpdmV8ZmlmdGgsc2l4Onx0aCxzZXZlbjp8dGgsZWlnaHQ6fGgsbmluOmV8dGgsdGVuOnx0aCcsCiAgICAnYXJ0aWNsZXMnOiAnYSxhbix0aGUnLAogICAgJ3Rva2Vucyc6ICd0aGUsc3R8bmR8cmR8dGgsb2Z8aW4sYXxhbixvbicsCiAgICAndGltZSc6ICd7SH06e21tfScsCiAgICAncGFzdCc6ICd7bnVtfSB7dW5pdH0ge3NpZ259JywKICAgICdmdXR1cmUnOiAne251bX0ge3VuaXR9IHtzaWdufScsCiAgICAnZHVyYXRpb24nOiAne251bX0ge3VuaXR9JywKICAgICdtb2RpZmllcnMnOiBbCiAgICAgIHsgJ25hbWUnOiAnaGFsZicsICAgJ3NyYyc6ICdoYWxmJywgJ3ZhbHVlJzogLjUgfSwKICAgICAgeyAnbmFtZSc6ICdtaWRkYXknLCAnc3JjJzogJ25vb24nLCAndmFsdWUnOiAxMiB9LAogICAgICB7ICduYW1lJzogJ21pZGRheScsICdzcmMnOiAnbWlkbmlnaHQnLCAndmFsdWUnOiAyNCB9LAogICAgICB7ICduYW1lJzogJ2RheScsICAgICdzcmMnOiAneWVzdGVyZGF5JywgJ3ZhbHVlJzogLTEgfSwKICAgICAgeyAnbmFtZSc6ICdkYXknLCAgICAnc3JjJzogJ3RvZGF5fHRvbmlnaHQnLCAndmFsdWUnOiAwIH0sCiAgICAgIHsgJ25hbWUnOiAnZGF5JywgICAgJ3NyYyc6ICd0b21vcnJvdycsICd2YWx1ZSc6IDEgfSwKICAgICAgeyAnbmFtZSc6ICdzaWduJywgICAnc3JjJzogJ2Fnb3xiZWZvcmUnLCAndmFsdWUnOiAtMSB9LAogICAgICB7ICduYW1lJzogJ3NpZ24nLCAgICdzcmMnOiAnZnJvbSBub3d8YWZ0ZXJ8ZnJvbXxpbnxsYXRlcicsICd2YWx1ZSc6IDEgfSwKICAgICAgeyAnbmFtZSc6ICdlZGdlJywgICAnc3JjJzogJ2ZpcnN0IGRheXxmaXJzdHxiZWdpbm5pbmcnLCAndmFsdWUnOiAtMiB9LAogICAgICB7ICduYW1lJzogJ2VkZ2UnLCAgICdzcmMnOiAnbGFzdCBkYXknLCAndmFsdWUnOiAxIH0sCiAgICAgIHsgJ25hbWUnOiAnZWRnZScsICAgJ3NyYyc6ICdlbmR8bGFzdCcsICd2YWx1ZSc6IDIgfSwKICAgICAgeyAnbmFtZSc6ICdzaGlmdCcsICAnc3JjJzogJ2xhc3QnLCAndmFsdWUnOiAtMSB9LAogICAgICB7ICduYW1lJzogJ3NoaWZ0JywgICdzcmMnOiAndGhlfHRoaXMnLCAndmFsdWUnOiAwIH0sCiAgICAgIHsgJ25hbWUnOiAnc2hpZnQnLCAgJ3NyYyc6ICduZXh0JywgJ3ZhbHVlJzogMSB9CiAgICBdLAogICAgJ3BhcnNlJzogWwogICAgICAnKD86anVzdCk/IG5vdycsCiAgICAgICd7c2hpZnR9IHt1bml0OjUtN30nLAogICAgICAie21vbnRocz99ICg/Ont5ZWFyfXwne3l5fSkiLAogICAgICAne21pZGRheX0gezQ/fSB7ZGF5fHdlZWtkYXl9JywKICAgICAgJ3ttb250aHN9LD8oPzpbLS5cXC9cXHNde3llYXJ9KT8nLAogICAgICAne2VkZ2V9IG9mICg/OmRheSk/IHtkYXl8d2Vla2RheX0nLAogICAgICAnezB9IHtudW19ezE/fSB7d2Vla2RheX0gezJ9IHttb250aHN9LD8ge3llYXI/fScsCiAgICAgICd7c2hpZnQ/fSB7ZGF5P30ge3dlZWtkYXk/fSB7dGltZU1hcmtlcj99IHttaWRkYXl9JywKICAgICAgJ3tzaWduP30gezM/fSB7aGFsZn0gezM/fSB7dW5pdDozLTR8dW5pdDo3fSB7c2lnbj99JywKICAgICAgJ3swP30ge2VkZ2V9IHt3ZWVrZGF5P30gezJ9IHtzaGlmdD99IHt1bml0OjQtNz99IHttb250aHM/fSw/IHt5ZWFyP30nCiAgICBdLAogICAgJ3RpbWVQYXJzZSc6IFsKICAgICAgJ3tkYXl8d2Vla2RheX0nLAogICAgICAne3NoaWZ0fSB7dW5pdDo1P30ge3dlZWtkYXl9JywKICAgICAgJ3swP30ge2RhdGV9ezE/fSB7Mj99IHttb250aHM/fScsCiAgICAgICd7d2Vla2RheX0gezI/fSB7c2hpZnR9IHt1bml0OjV9JywKICAgICAgJ3swP30ge251bX0gezI/fSB7bW9udGhzfVxcLj8sPyB7eWVhcj99JywKICAgICAgJ3tudW0/fSB7dW5pdDo0LTV9IHtzaWdufSB7ZGF5fHdlZWtkYXl9JywKICAgICAgJ3t5ZWFyfVstLlxcL1xcc117bW9udGhzfVstLlxcL1xcc117ZGF0ZX0nLAogICAgICAnezB8bW9udGhzfSB7ZGF0ZT99ezE/fSBvZiB7c2hpZnR9IHt1bml0OjYtN30nLAogICAgICAnezA/fSB7bnVtfXsxP30ge3dlZWtkYXl9IG9mIHtzaGlmdH0ge3VuaXQ6Nn0nLAogICAgICAie2RhdGV9Wy0uXFwvXFxzXXttb250aHN9Wy0uXFwvXFxzXSg/Ont5ZWFyfXwnP3t5eX0pIiwKICAgICAgInt3ZWVrZGF5P31cXC4/LD8ge21vbnRoc31cXC4/LD8ge2RhdGV9ezE/fSw/ICg/Ont5ZWFyfXwne3l5fSk/IgogICAgXSwKICAgICd0aW1lRnJvbnRQYXJzZSc6IFsKICAgICAgJ3tzaWdufSB7bnVtfSB7dW5pdH0nLAogICAgICAne251bX0ge3VuaXR9IHtzaWdufScsCiAgICAgICd7ND99IHtkYXl8d2Vla2RheX0nCiAgICBdCiAgfTsKCiAgdmFyIEFtZXJpY2FuRW5nbGlzaERlZmluaXRpb24gPSBnZXRFbmdsaXNoVmFyaWFudCh7CiAgICAnbWR5JzogdHJ1ZSwKICAgICdmaXJzdERheU9mV2Vlayc6IDAsCiAgICAnZmlyc3REYXlPZldlZWtZZWFyJzogMSwKICAgICdzaG9ydCc6ICAne01NfS97ZGR9L3t5eXl5fScsCiAgICAnbWVkaXVtJzogJ3tNb250aH0ge2R9LCB7eXl5eX0nLAogICAgJ2xvbmcnOiAgICd7TW9udGh9IHtkfSwge3l5eXl9IHt0aW1lfScsCiAgICAnZnVsbCc6ICAgJ3tXZWVrZGF5fSwge01vbnRofSB7ZH0sIHt5eXl5fSB7dGltZX0nLAogICAgJ3N0YW1wJzogICd7RG93fSB7TW9ufSB7ZH0ge3l5eXl9IHt0aW1lfScsCiAgICAndGltZSc6ICAgJ3tofTp7bW19IHtUVH0nCiAgfSk7CgogIHZhciBCcml0aXNoRW5nbGlzaERlZmluaXRpb24gPSBnZXRFbmdsaXNoVmFyaWFudCh7CiAgICAnc2hvcnQnOiAgJ3tkZH0ve01NfS97eXl5eX0nLAogICAgJ21lZGl1bSc6ICd7ZH0ge01vbnRofSB7eXl5eX0nLAogICAgJ2xvbmcnOiAgICd7ZH0ge01vbnRofSB7eXl5eX0ge0h9OnttbX0nLAogICAgJ2Z1bGwnOiAgICd7V2Vla2RheX0sIHtkfSB7TW9udGh9LCB7eXl5eX0ge3RpbWV9JywKICAgICdzdGFtcCc6ICAne0Rvd30ge2R9IHtNb259IHt5eXl5fSB7dGltZX0nCiAgfSk7CgogIHZhciBDYW5hZGlhbkVuZ2xpc2hEZWZpbml0aW9uID0gZ2V0RW5nbGlzaFZhcmlhbnQoewogICAgJ3Nob3J0JzogICd7eXl5eX0te01NfS17ZGR9JywKICAgICdtZWRpdW0nOiAne2R9IHtNb250aH0sIHt5eXl5fScsCiAgICAnbG9uZyc6ICAgJ3tkfSB7TW9udGh9LCB7eXl5eX0ge0h9OnttbX0nLAogICAgJ2Z1bGwnOiAgICd7V2Vla2RheX0sIHtkfSB7TW9udGh9LCB7eXl5eX0ge3RpbWV9JywKICAgICdzdGFtcCc6ICAne0Rvd30ge2R9IHtNb259IHt5eXl5fSB7dGltZX0nCiAgfSk7CgogIHZhciBMYXp5TG9hZGVkTG9jYWxlcyA9IHsKICAgICdlbi1VUyc6IEFtZXJpY2FuRW5nbGlzaERlZmluaXRpb24sCiAgICAnZW4tR0InOiBCcml0aXNoRW5nbGlzaERlZmluaXRpb24sCiAgICAnZW4tQVUnOiBCcml0aXNoRW5nbGlzaERlZmluaXRpb24sCiAgICAnZW4tQ0EnOiBDYW5hZGlhbkVuZ2xpc2hEZWZpbml0aW9uCiAgfTsKCiAgYnVpbGRMb2NhbGVzKCk7CiAgYnVpbGREYXRlRm9ybWF0VG9rZW5zKCk7CiAgYnVpbGREYXRlRm9ybWF0TWF0Y2hlcigpOwogIGJ1aWxkRGF0ZVVuaXRNZXRob2RzKCk7CiAgYnVpbGROdW1iZXJVbml0TWV0aG9kcygpOwogIGJ1aWxkUmVsYXRpdmVBbGlhc2VzKCk7CiAgc2V0RGF0ZUNoYWluYWJsZUNvbnN0cnVjdG9yKCk7CgogIC8qKioKICAgKiBAbW9kdWxlIFN0cmluZwogICAqIEBkZXNjcmlwdGlvbiBTdHJpbmcgbWFudXB1bGF0aW9uLCBlbmNvZGluZywgdHJ1bmNhdGlvbiwgYW5kIGZvcm1hdHRpbmcsIGFuZCBtb3JlLgogICAqCiAgICoqKi8KCiAgLy8gRmxhZyBhbGxvd2luZyBuYXRpdmUgc3RyaW5nIG1ldGhvZHMgdG8gYmUgZW5oYW5jZWQKICB2YXIgU1RSSU5HX0VOSEFOQ0VNRU5UU19GTEFHID0gJ2VuaGFuY2VTdHJpbmcnOwoKICAvLyBNYXRjaGVzIG5vbi1wdW5jdHVhdGlvbiBjaGFyYWN0ZXJzIGV4Y2VwdCBhcG9zdHJvcGhlIGZvciBjYXBpdGFsaXphdGlvbi4KICB2YXIgQ0FQSVRBTElaRV9SRUcgPSAvW15cdTAwMDAtXHUwMDQwXHUwMDVCLVx1MDA2MFx1MDA3Qi1cdTAwN0ZdKygncyk/L2c7CgogIC8vIFJlZ2V4IG1hdGNoaW5nIGNhbWVsQ2FzZS4KICB2YXIgQ0FNRUxJWkVfUkVHID0gLyhefF8pKFteX10rKS9nOwoKICAvLyBSZWdleCBtYXRjaGluZyBhbnkgSFRNTCBlbnRpdHkuCiAgdmFyIEhUTUxfRU5USVRZX1JFRyA9IC8mIz8oeCk/KFtcd1xkXXswLDV9KTsvZ2k7CgogIC8vIFZlcnkgYmFzaWMgSFRNTCBlc2NhcGluZyByZWdleC4KICB2YXIgSFRNTF9FU0NBUEVfUkVHID0gL1smPD5dL2c7CgogIC8vIFNwZWNpYWwgSFRNTCBlbnRpdGllcy4KICB2YXIgSFRNTEZyb21FbnRpdHlNYXAgPSB7CiAgICAnbHQnOiAgICAnPCcsCiAgICAnZ3QnOiAgICAnPicsCiAgICAnYW1wJzogICAnJicsCiAgICAnbmJzcCc6ICAnICcsCiAgICAncXVvdCc6ICAnIicsCiAgICAnYXBvcyc6ICAiJyIKICB9OwoKICB2YXIgSFRNTFRvRW50aXR5TWFwOwoKICAvLyBXb3JkcyB0aGF0IHNob3VsZCBub3QgYmUgY2FwaXRhbGl6ZWQgaW4gdGl0bGVzCiAgdmFyIERPV05DQVNFRF9XT1JEUyA9IFsKICAgICdhbmQnLCAnb3InLCAnbm9yJywgJ2EnLCAnYW4nLCAndGhlJywgJ3NvJywgJ2J1dCcsICd0bycsICdvZicsICdhdCcsCiAgICAnYnknLCAnZnJvbScsICdpbnRvJywgJ29uJywgJ29udG8nLCAnb2ZmJywgJ291dCcsICdpbicsICdvdmVyJywKICAgICd3aXRoJywgJ2ZvcicKICBdOwoKICAvLyBIVE1MIHRhZ3MgdGhhdCBkbyBub3QgaGF2ZSBpbm5lciBjb250ZW50LgogIHZhciBIVE1MX1ZPSURfRUxFTUVOVFMgPSBbCiAgICAnYXJlYScsJ2Jhc2UnLCdicicsJ2NvbCcsJ2NvbW1hbmQnLCdlbWJlZCcsJ2hyJywnaW1nJywKICAgICdpbnB1dCcsJ2tleWdlbicsJ2xpbmsnLCdtZXRhJywncGFyYW0nLCdzb3VyY2UnLCd0cmFjaycsJ3dicicKICBdOwoKICB2YXIgTEVGVF9UUklNX1JFRyAgPSBSZWdFeHAoJ15bJysgVFJJTV9DSEFSUyArJ10rJyk7CiAgdmFyIFJJR0hUX1RSSU1fUkVHID0gUmVnRXhwKCdbJysgVFJJTV9DSEFSUyArJ10rJCcpOwogIHZhciBUUlVOQ19SRUcgICAgICA9IFJlZ0V4cCgnKD89WycgKyBUUklNX0NIQVJTICsgJ10pJyk7CgogIC8vIFJlZmVyZW5jZSB0byBuYXRpdmUgU3RyaW5nI2luY2x1ZGVzIHRvIGVuaGFuY2UgbGF0ZXIuCiAgdmFyIG5hdGl2ZUluY2x1ZGVzID0gU3RyaW5nLnByb3RvdHlwZS5pbmNsdWRlczsKCiAgLy8gQmFzZTY0CiAgdmFyIGVuY29kZUJhc2U2NCwgZGVjb2RlQmFzZTY0OwoKICAvLyBGb3JtYXQgbWF0Y2hlciBmb3IgU3RyaW5nI2Zvcm1hdC4KICB2YXIgc3RyaW5nRm9ybWF0TWF0Y2hlciA9IGNyZWF0ZUZvcm1hdE1hdGNoZXIoZGVlcEdldFByb3BlcnR5KTsKCiAgZnVuY3Rpb24gcGFkU3RyaW5nKG51bSwgcGFkZGluZykgewogICAgcmV0dXJuIHJlcGVhdFN0cmluZyhpc0RlZmluZWQocGFkZGluZykgPyBwYWRkaW5nIDogJyAnLCBudW0pOwogIH0KCiAgZnVuY3Rpb24gdHJ1bmNhdGVTdHJpbmcoc3RyLCBsZW5ndGgsIGZyb20sIGVsbGlwc2lzLCBzcGxpdCkgewogICAgdmFyIHN0cjEsIHN0cjIsIGxlbjEsIGxlbjI7CiAgICBpZiAoc3RyLmxlbmd0aCA8PSBsZW5ndGgpIHsKICAgICAgcmV0dXJuIHN0ci50b1N0cmluZygpOwogICAgfQogICAgZWxsaXBzaXMgPSBpc1VuZGVmaW5lZChlbGxpcHNpcykgPyAnLi4uJyA6IGVsbGlwc2lzOwogICAgc3dpdGNoKGZyb20pIHsKICAgICAgY2FzZSAnbGVmdCc6CiAgICAgICAgc3RyMiA9IHNwbGl0ID8gdHJ1bmNhdGVPbldvcmQoc3RyLCBsZW5ndGgsIHRydWUpIDogc3RyLnNsaWNlKHN0ci5sZW5ndGggLSBsZW5ndGgpOwogICAgICAgIHJldHVybiBlbGxpcHNpcyArIHN0cjI7CiAgICAgIGNhc2UgJ21pZGRsZSc6CiAgICAgICAgbGVuMSA9IGNlaWwobGVuZ3RoIC8gMik7CiAgICAgICAgbGVuMiA9IGZsb29yKGxlbmd0aCAvIDIpOwogICAgICAgIHN0cjEgPSBzcGxpdCA/IHRydW5jYXRlT25Xb3JkKHN0ciwgbGVuMSkgOiBzdHIuc2xpY2UoMCwgbGVuMSk7CiAgICAgICAgc3RyMiA9IHNwbGl0ID8gdHJ1bmNhdGVPbldvcmQoc3RyLCBsZW4yLCB0cnVlKSA6IHN0ci5zbGljZShzdHIubGVuZ3RoIC0gbGVuMik7CiAgICAgICAgcmV0dXJuIHN0cjEgKyBlbGxpcHNpcyArIHN0cjI7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgc3RyMSA9IHNwbGl0ID8gdHJ1bmNhdGVPbldvcmQoc3RyLCBsZW5ndGgpIDogc3RyLnNsaWNlKDAsIGxlbmd0aCk7CiAgICAgICAgcmV0dXJuIHN0cjEgKyBlbGxpcHNpczsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHN0cmluZ0VhY2goc3RyLCBzZWFyY2gsIGZuKSB7CiAgICB2YXIgY2h1bmtzLCBjaHVuaywgcmVnLCByZXN1bHQgPSBbXTsKICAgIGlmIChpc0Z1bmN0aW9uKHNlYXJjaCkpIHsKICAgICAgZm4gPSBzZWFyY2g7CiAgICAgIHJlZyA9IC9bXHNcU10vZzsKICAgIH0gZWxzZSBpZiAoIXNlYXJjaCkgewogICAgICByZWcgPSAvW1xzXFNdL2c7CiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKHNlYXJjaCkpIHsKICAgICAgcmVnID0gUmVnRXhwKGVzY2FwZVJlZ0V4cChzZWFyY2gpLCAnZ2knKTsKICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAoc2VhcmNoKSkgewogICAgICByZWcgPSBSZWdFeHAoc2VhcmNoLnNvdXJjZSwgZ2V0UmVnRXhwRmxhZ3Moc2VhcmNoLCAnZycpKTsKICAgIH0KICAgIC8vIEdldHRpbmcgdGhlIGVudGlyZSBhcnJheSBvZiBjaHVua3MgdXAgZnJvbnQgYXMgd2UgbmVlZCB0bwogICAgLy8gcGFzcyB0aGlzIGludG8gdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGFzIGFuIGFyZ3VtZW50LgogICAgY2h1bmtzID0gcnVuR2xvYmFsTWF0Y2goc3RyLCByZWcpOwoKICAgIGlmIChjaHVua3MpIHsKICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gY2h1bmtzLmxlbmd0aCwgcjsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgY2h1bmsgPSBjaHVua3NbaV07CiAgICAgICAgcmVzdWx0W2ldID0gY2h1bms7CiAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICByID0gZm4uY2FsbChzdHIsIGNodW5rLCBpLCBjaHVua3MpOwogICAgICAgICAgaWYgKHIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfSBlbHNlIGlmIChpc0RlZmluZWQocikpIHsKICAgICAgICAgICAgcmVzdWx0W2ldID0gcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvLyAibWF0Y2giIGluIDwgSUU5IGhhcyBlbnVtYWJsZSBwcm9wZXJ0aWVzIHRoYXQgd2lsbCBjb25mdXNlIGZvci4uaW4KICAvLyBsb29wcywgc28gZW5zdXJlIHRoYXQgdGhlIG1hdGNoIGlzIGEgbm9ybWFsIGFycmF5IGJ5IG1hbnVhbGx5IHJ1bm5pbmcKICAvLyAiZXhlYyIuIE5vdGUgdGhhdCB0aGlzIG1ldGhvZCBpcyBhbHNvIHNsaWdodGx5IG1vcmUgcGVyZm9ybWFudC4KICBmdW5jdGlvbiBydW5HbG9iYWxNYXRjaChzdHIsIHJlZykgewogICAgdmFyIHJlc3VsdCA9IFtdLCBtYXRjaCwgbGFzdExhc3RJbmRleDsKICAgIHdoaWxlICgobWF0Y2ggPSByZWcuZXhlYyhzdHIpKSAhPSBudWxsKSB7CiAgICAgIGlmIChyZWcubGFzdEluZGV4ID09PSBsYXN0TGFzdEluZGV4KSB7CiAgICAgICAgcmVnLmxhc3RJbmRleCArPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wdXNoKG1hdGNoWzBdKTsKICAgICAgfQogICAgICBsYXN0TGFzdEluZGV4ID0gcmVnLmxhc3RJbmRleDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBlYWNoV29yZChzdHIsIGZuKSB7CiAgICByZXR1cm4gc3RyaW5nRWFjaCh0cmltKHN0ciksIC9cUysvZywgZm4pOwogIH0KCiAgZnVuY3Rpb24gc3RyaW5nQ29kZXMoc3RyLCBmbikgewogICAgdmFyIGNvZGVzID0gbmV3IEFycmF5KHN0ci5sZW5ndGgpLCBpLCBsZW47CiAgICBmb3IoaSA9IDAsIGxlbiA9IHN0ci5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgY29kZSA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICBjb2Rlc1tpXSA9IGNvZGU7CiAgICAgIGlmIChmbikgewogICAgICAgIGZuLmNhbGwoc3RyLCBjb2RlLCBpLCBzdHIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gY29kZXM7CiAgfQoKICBmdW5jdGlvbiBzdHJpbmdVbmRlcnNjb3JlKHN0cikgewogICAgdmFyIGFyZWcgPSBJbmZsZWN0aW9ucy5hY3JvbnltcyAmJiBJbmZsZWN0aW9ucy5hY3Jvbnltcy5yZWc7CiAgICByZXR1cm4gc3RyCiAgICAgIC5yZXBsYWNlKC9bLVxzXSsvZywgJ18nKQogICAgICAucmVwbGFjZShhcmVnLCBmdW5jdGlvbihhY3JvbnltLCBpbmRleCkgewogICAgICAgIHJldHVybiAoaW5kZXggPiAwID8gJ18nIDogJycpICsgYWNyb255bS50b0xvd2VyQ2FzZSgpOwogICAgICB9KQogICAgICAucmVwbGFjZSgvKFtBLVpcZF0rKShbQS1aXVthLXpdKS9nLCckMV8kMicpCiAgICAgIC5yZXBsYWNlKC8oW2EtelxkXSkoW0EtWl0pL2csJyQxXyQyJykKICAgICAgLnRvTG93ZXJDYXNlKCk7CiAgfQoKICBmdW5jdGlvbiBzdHJpbmdDYW1lbGl6ZShzdHIsIHVwcGVyKSB7CiAgICBzdHIgPSBzdHJpbmdVbmRlcnNjb3JlKHN0cik7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoQ0FNRUxJWkVfUkVHLCBmdW5jdGlvbihtYXRjaCwgcHJlLCB3b3JkLCBpbmRleCkgewogICAgICB2YXIgY2FwID0gdXBwZXIgIT09IGZhbHNlIHx8IGluZGV4ID4gMCwgYWNyb255bTsKICAgICAgYWNyb255bSA9IGdldEFjcm9ueW0od29yZCk7CiAgICAgIGlmIChhY3JvbnltICYmIGNhcCkgewogICAgICAgIHJldHVybiBhY3JvbnltOwogICAgICB9CiAgICAgIHJldHVybiBjYXAgPyBzdHJpbmdDYXBpdGFsaXplKHdvcmQsIHRydWUpIDogd29yZDsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gc3RyaW5nU3BhY2lmeShzdHIpIHsKICAgIHJldHVybiBzdHJpbmdVbmRlcnNjb3JlKHN0cikucmVwbGFjZSgvXy9nLCAnICcpOwogIH0KCiAgZnVuY3Rpb24gc3RyaW5nQ2FwaXRhbGl6ZShzdHIsIGRvd25jYXNlLCBhbGwpIHsKICAgIGlmIChkb3duY2FzZSkgewogICAgICBzdHIgPSBzdHIudG9Mb3dlckNhc2UoKTsKICAgIH0KICAgIHJldHVybiBhbGwgPyBzdHIucmVwbGFjZShDQVBJVEFMSVpFX1JFRywgc2ltcGxlQ2FwaXRhbGl6ZSkgOiBzaW1wbGVDYXBpdGFsaXplKHN0cik7CiAgfQoKICBmdW5jdGlvbiBzdHJpbmdUaXRsZWl6ZShzdHIpIHsKICAgIHZhciBmdWxsU3RvcFB1bmN0dWF0aW9uID0gL1suOjshXSQvLCBsYXN0SGFkUHVuY3R1YXRpb247CiAgICBzdHIgPSBydW5IdW1hblJ1bGVzKHN0cik7CiAgICBzdHIgPSBzdHJpbmdTcGFjaWZ5KHN0cik7CiAgICByZXR1cm4gZWFjaFdvcmQoc3RyLCBmdW5jdGlvbih3b3JkLCBpbmRleCwgd29yZHMpIHsKICAgICAgd29yZCA9IGdldEh1bWFuV29yZCh3b3JkKSB8fCB3b3JkOwogICAgICB3b3JkID0gZ2V0QWNyb255bSh3b3JkKSB8fCB3b3JkOwogICAgICB2YXIgaGFzUHVuY3R1YXRpb24sIGlzRmlyc3RPckxhc3Q7CiAgICAgIHZhciBmaXJzdCA9IGluZGV4ID09IDAsIGxhc3QgPSBpbmRleCA9PSB3b3Jkcy5sZW5ndGggLSAxOwogICAgICBoYXNQdW5jdHVhdGlvbiA9IGZ1bGxTdG9wUHVuY3R1YXRpb24udGVzdCh3b3JkKTsKICAgICAgaXNGaXJzdE9yTGFzdCA9IGZpcnN0IHx8IGxhc3QgfHwgaGFzUHVuY3R1YXRpb24gfHwgbGFzdEhhZFB1bmN0dWF0aW9uOwogICAgICBsYXN0SGFkUHVuY3R1YXRpb24gPSBoYXNQdW5jdHVhdGlvbjsKICAgICAgaWYgKGlzRmlyc3RPckxhc3QgfHwgaW5kZXhPZihET1dOQ0FTRURfV09SRFMsIHdvcmQpID09PSAtMSkgewogICAgICAgIHJldHVybiBzdHJpbmdDYXBpdGFsaXplKHdvcmQsIGZhbHNlLCB0cnVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gd29yZDsKICAgICAgfQogICAgfSkuam9pbignICcpOwogIH0KCiAgZnVuY3Rpb24gc3RyaW5nUGFyYW1ldGVyaXplKHN0ciwgc2VwYXJhdG9yKSB7CiAgICBpZiAoc2VwYXJhdG9yID09PSB1bmRlZmluZWQpIHNlcGFyYXRvciA9ICctJzsKICAgIHN0ciA9IHN0ci5yZXBsYWNlKC9bXmEtejAtOVwtX10rL2dpLCBzZXBhcmF0b3IpOwogICAgaWYgKHNlcGFyYXRvcikgewogICAgICB2YXIgcmVnID0gUmVnRXhwKCdee3N9K3x7c30rJHwoe3N9KXtzfSsnLnNwbGl0KCd7c30nKS5qb2luKGVzY2FwZVJlZ0V4cChzZXBhcmF0b3IpKSwgJ2cnKTsKICAgICAgc3RyID0gc3RyLnJlcGxhY2UocmVnLCAnJDEnKTsKICAgIH0KICAgIHJldHVybiBlbmNvZGVVUkkoc3RyLnRvTG93ZXJDYXNlKCkpOwogIH0KCiAgZnVuY3Rpb24gcmV2ZXJzZVN0cmluZyhzdHIpIHsKICAgIHJldHVybiBzdHIuc3BsaXQoJycpLnJldmVyc2UoKS5qb2luKCcnKTsKICB9CgogIGZ1bmN0aW9uIHRydW5jYXRlT25Xb3JkKHN0ciwgbGltaXQsIGZyb21MZWZ0KSB7CiAgICBpZiAoZnJvbUxlZnQpIHsKICAgICAgcmV0dXJuIHJldmVyc2VTdHJpbmcodHJ1bmNhdGVPbldvcmQocmV2ZXJzZVN0cmluZyhzdHIpLCBsaW1pdCkpOwogICAgfQogICAgdmFyIHdvcmRzID0gc3RyLnNwbGl0KFRSVU5DX1JFRyk7CiAgICB2YXIgY291bnQgPSAwOwogICAgcmV0dXJuIGZpbHRlcih3b3JkcywgZnVuY3Rpb24od29yZCkgewogICAgICBjb3VudCArPSB3b3JkLmxlbmd0aDsKICAgICAgcmV0dXJuIGNvdW50IDw9IGxpbWl0OwogICAgfSkuam9pbignJyk7CiAgfQoKICBmdW5jdGlvbiB1bmVzY2FwZUhUTUwoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoSFRNTF9FTlRJVFlfUkVHLCBmdW5jdGlvbihmdWxsLCBoZXgsIGNvZGUpIHsKICAgICAgdmFyIHNwZWNpYWwgPSBIVE1MRnJvbUVudGl0eU1hcFtjb2RlXTsKICAgICAgcmV0dXJuIHNwZWNpYWwgfHwgY2hyKGhleCA/IHBhcnNlSW50KGNvZGUsIDE2KSA6ICtjb2RlKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gdGFnSXNWb2lkKHRhZykgewogICAgcmV0dXJuIGluZGV4T2YoSFRNTF9WT0lEX0VMRU1FTlRTLCB0YWcudG9Mb3dlckNhc2UoKSkgIT09IC0xOwogIH0KCiAgZnVuY3Rpb24gc3RyaW5nUmVwbGFjZUFsbChzdHIsIGYsIHJlcGxhY2UpIHsKICAgIHZhciBpID0gMCwgdG9rZW5zOwogICAgaWYgKGlzU3RyaW5nKGYpKSB7CiAgICAgIGYgPSBSZWdFeHAoZXNjYXBlUmVnRXhwKGYpLCAnZycpOwogICAgfSBlbHNlIGlmIChmICYmICFmLmdsb2JhbCkgewogICAgICBmID0gUmVnRXhwKGYuc291cmNlLCBnZXRSZWdFeHBGbGFncyhmLCAnZycpKTsKICAgIH0KICAgIGlmICghcmVwbGFjZSkgewogICAgICByZXBsYWNlID0gJyc7CiAgICB9IGVsc2UgewogICAgICB0b2tlbnMgPSByZXBsYWNlOwogICAgICByZXBsYWNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHQgPSB0b2tlbnNbaSsrXTsKICAgICAgICByZXR1cm4gdCAhPSBudWxsID8gdCA6ICcnOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGYsIHJlcGxhY2UpOwogIH0KCiAgZnVuY3Rpb24gcmVwbGFjZVRhZ3Moc3RyLCBmaW5kLCByZXBsYWNlbWVudCwgc3RyaXApIHsKICAgIHZhciB0YWdzID0gaXNTdHJpbmcoZmluZCkgPyBbZmluZF0gOiBmaW5kLCByZWcsIHNyYzsKICAgIHRhZ3MgPSBtYXAodGFncyB8fCBbXSwgZnVuY3Rpb24odCkgewogICAgICByZXR1cm4gZXNjYXBlUmVnRXhwKHQpOwogICAgfSkuam9pbignfCcpOwogICAgc3JjID0gdGFncy5yZXBsYWNlKCdhbGwnLCAnJykgfHwgJ1teXFxzPl0rJzsKICAgIHNyYyA9ICc8KFxcLyk/KCcgKyBzcmMgKyAnKShcXHMrW148Pl0qPyk/XFxzKihcXC8pPz4nOwogICAgcmVnID0gUmVnRXhwKHNyYywgJ2dpJyk7CiAgICByZXR1cm4gcnVuVGFnUmVwbGFjZW1lbnRzKHN0ci50b1N0cmluZygpLCByZWcsIHN0cmlwLCByZXBsYWNlbWVudCk7CiAgfQoKICBmdW5jdGlvbiBydW5UYWdSZXBsYWNlbWVudHMoc3RyLCByZWcsIHN0cmlwLCByZXBsYWNlbWVudCwgZnVsbFN0cmluZykgewoKICAgIHZhciBtYXRjaDsKICAgIHZhciByZXN1bHQgPSAnJzsKICAgIHZhciBjdXJyZW50SW5kZXggPSAwOwogICAgdmFyIG9wZW5UYWdOYW1lOwogICAgdmFyIG9wZW5UYWdBdHRyaWJ1dGVzOwogICAgdmFyIG9wZW5UYWdDb3VudCA9IDA7CgogICAgZnVuY3Rpb24gcHJvY2Vzc1RhZyhpbmRleCwgdGFnTmFtZSwgYXR0cmlidXRlcywgdGFnTGVuZ3RoLCBpc1ZvaWQpIHsKICAgICAgdmFyIGNvbnRlbnQgPSBzdHIuc2xpY2UoY3VycmVudEluZGV4LCBpbmRleCksIHMgPSAnJywgciA9ICcnOwogICAgICBpZiAoaXNTdHJpbmcocmVwbGFjZW1lbnQpKSB7CiAgICAgICAgciA9IHJlcGxhY2VtZW50OwogICAgICB9IGVsc2UgaWYgKHJlcGxhY2VtZW50KSB7CiAgICAgICAgciA9IHJlcGxhY2VtZW50LmNhbGwoZnVsbFN0cmluZywgdGFnTmFtZSwgY29udGVudCwgYXR0cmlidXRlcywgZnVsbFN0cmluZykgfHwgJyc7CiAgICAgIH0KICAgICAgaWYgKHN0cmlwKSB7CiAgICAgICAgcyA9IHI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udGVudCA9IHI7CiAgICAgIH0KICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICBjb250ZW50ID0gcnVuVGFnUmVwbGFjZW1lbnRzKGNvbnRlbnQsIHJlZywgc3RyaXAsIHJlcGxhY2VtZW50LCBmdWxsU3RyaW5nKTsKICAgICAgfQogICAgICByZXN1bHQgKz0gcyArIGNvbnRlbnQgKyAoaXNWb2lkID8gJycgOiBzKTsKICAgICAgY3VycmVudEluZGV4ID0gaW5kZXggKyAodGFnTGVuZ3RoIHx8IDApOwogICAgfQoKICAgIGZ1bGxTdHJpbmcgPSBmdWxsU3RyaW5nIHx8IHN0cjsKICAgIHJlZyA9IFJlZ0V4cChyZWcuc291cmNlLCAnZ2knKTsKCiAgICB3aGlsZShtYXRjaCA9IHJlZy5leGVjKHN0cikpIHsKCiAgICAgIHZhciB0YWdOYW1lICAgICAgICAgPSBtYXRjaFsyXTsKICAgICAgdmFyIGF0dHJpYnV0ZXMgICAgICA9IChtYXRjaFszXXx8ICcnKS5zbGljZSgxKTsKICAgICAgdmFyIGlzQ2xvc2luZ1RhZyAgICA9ICEhbWF0Y2hbMV07CiAgICAgIHZhciBpc1NlbGZDbG9zaW5nICAgPSAhIW1hdGNoWzRdOwogICAgICB2YXIgdGFnTGVuZ3RoICAgICAgID0gbWF0Y2hbMF0ubGVuZ3RoOwogICAgICB2YXIgaXNWb2lkICAgICAgICAgID0gdGFnSXNWb2lkKHRhZ05hbWUpOwogICAgICB2YXIgaXNPcGVuaW5nVGFnICAgID0gIWlzQ2xvc2luZ1RhZyAmJiAhaXNTZWxmQ2xvc2luZyAmJiAhaXNWb2lkOwogICAgICB2YXIgaXNTYW1lQXNDdXJyZW50ID0gdGFnTmFtZSA9PT0gb3BlblRhZ05hbWU7CgogICAgICBpZiAoIW9wZW5UYWdOYW1lKSB7CiAgICAgICAgcmVzdWx0ICs9IHN0ci5zbGljZShjdXJyZW50SW5kZXgsIG1hdGNoLmluZGV4KTsKICAgICAgICBjdXJyZW50SW5kZXggPSBtYXRjaC5pbmRleDsKICAgICAgfQoKICAgICAgaWYgKGlzT3BlbmluZ1RhZykgewogICAgICAgIGlmICghb3BlblRhZ05hbWUpIHsKICAgICAgICAgIG9wZW5UYWdOYW1lID0gdGFnTmFtZTsKICAgICAgICAgIG9wZW5UYWdBdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICAgIG9wZW5UYWdDb3VudCsrOwogICAgICAgICAgY3VycmVudEluZGV4ICs9IHRhZ0xlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKGlzU2FtZUFzQ3VycmVudCkgewogICAgICAgICAgb3BlblRhZ0NvdW50Kys7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlzQ2xvc2luZ1RhZyAmJiBpc1NhbWVBc0N1cnJlbnQpIHsKICAgICAgICBvcGVuVGFnQ291bnQtLTsKICAgICAgICBpZiAob3BlblRhZ0NvdW50ID09PSAwKSB7CiAgICAgICAgICBwcm9jZXNzVGFnKG1hdGNoLmluZGV4LCBvcGVuVGFnTmFtZSwgb3BlblRhZ0F0dHJpYnV0ZXMsIHRhZ0xlbmd0aCwgaXNWb2lkKTsKICAgICAgICAgIG9wZW5UYWdOYW1lICAgICAgID0gbnVsbDsKICAgICAgICAgIG9wZW5UYWdBdHRyaWJ1dGVzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoIW9wZW5UYWdOYW1lKSB7CiAgICAgICAgcHJvY2Vzc1RhZyhtYXRjaC5pbmRleCwgdGFnTmFtZSwgYXR0cmlidXRlcywgdGFnTGVuZ3RoLCBpc1ZvaWQpOwogICAgICB9CiAgICB9CiAgICBpZiAob3BlblRhZ05hbWUpIHsKICAgICAgcHJvY2Vzc1RhZyhzdHIubGVuZ3RoLCBvcGVuVGFnTmFtZSwgb3BlblRhZ0F0dHJpYnV0ZXMpOwogICAgfQogICAgcmVzdWx0ICs9IHN0ci5zbGljZShjdXJyZW50SW5kZXgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIG51bWJlck9ySW5kZXgoc3RyLCBuLCBmcm9tKSB7CiAgICBpZiAoaXNTdHJpbmcobikpIHsKICAgICAgbiA9IHN0ci5pbmRleE9mKG4pOwogICAgICBpZiAobiA9PT0gLTEpIHsKICAgICAgICBuID0gZnJvbSA/IHN0ci5sZW5ndGggOiAwOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbjsKICB9CgogIGZ1bmN0aW9uIGJ1aWxkQmFzZTY0KCkgewogICAgdmFyIGVuY29kZUFzY2lpLCBkZWNvZGVBc2NpaTsKCiAgICBmdW5jdGlvbiBjYXRjaEVuY29kaW5nRXJyb3IoZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0cikgewogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gZm4oc3RyKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgaWYgKHR5cGVvZiBCdWZmZXIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIGVuY29kZUJhc2U2NCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBuZXcgQnVmZmVyKHN0cikudG9TdHJpbmcoJ2Jhc2U2NCcpOwogICAgICB9OwogICAgICBkZWNvZGVCYXNlNjQgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gbmV3IEJ1ZmZlcihzdHIsICdiYXNlNjQnKS50b1N0cmluZygndXRmOCcpOwogICAgICB9OwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodHlwZW9mIGJ0b2EgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIGVuY29kZUFzY2lpID0gY2F0Y2hFbmNvZGluZ0Vycm9yKGJ0b2EpOwogICAgICBkZWNvZGVBc2NpaSA9IGNhdGNoRW5jb2RpbmdFcnJvcihhdG9iKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBrZXkgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLz0nOwogICAgICB2YXIgYmFzZTY0cmVnID0gL1teQS1aYS16MC05XCtcL1w9XS9nOwogICAgICBlbmNvZGVBc2NpaSA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHZhciBvdXRwdXQgPSAnJzsKICAgICAgICB2YXIgY2hyMSwgY2hyMiwgY2hyMzsKICAgICAgICB2YXIgZW5jMSwgZW5jMiwgZW5jMywgZW5jNDsKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgZG8gewogICAgICAgICAgY2hyMSA9IHN0ci5jaGFyQ29kZUF0KGkrKyk7CiAgICAgICAgICBjaHIyID0gc3RyLmNoYXJDb2RlQXQoaSsrKTsKICAgICAgICAgIGNocjMgPSBzdHIuY2hhckNvZGVBdChpKyspOwogICAgICAgICAgZW5jMSA9IGNocjEgPj4gMjsKICAgICAgICAgIGVuYzIgPSAoKGNocjEgJiAzKSA8PCA0KSB8IChjaHIyID4+IDQpOwogICAgICAgICAgZW5jMyA9ICgoY2hyMiAmIDE1KSA8PCAyKSB8IChjaHIzID4+IDYpOwogICAgICAgICAgZW5jNCA9IGNocjMgJiA2MzsKICAgICAgICAgIGlmIChpc05hTihjaHIyKSkgewogICAgICAgICAgICBlbmMzID0gZW5jNCA9IDY0OwogICAgICAgICAgfSBlbHNlIGlmIChpc05hTihjaHIzKSkgewogICAgICAgICAgICBlbmM0ID0gNjQ7CiAgICAgICAgICB9CiAgICAgICAgICBvdXRwdXQgKz0ga2V5LmNoYXJBdChlbmMxKTsKICAgICAgICAgIG91dHB1dCArPSBrZXkuY2hhckF0KGVuYzIpOwogICAgICAgICAgb3V0cHV0ICs9IGtleS5jaGFyQXQoZW5jMyk7CiAgICAgICAgICBvdXRwdXQgKz0ga2V5LmNoYXJBdChlbmM0KTsKICAgICAgICAgIGNocjEgPSBjaHIyID0gY2hyMyA9ICcnOwogICAgICAgICAgZW5jMSA9IGVuYzIgPSBlbmMzID0gZW5jNCA9ICcnOwogICAgICAgIH0gd2hpbGUgKGkgPCBzdHIubGVuZ3RoKTsKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICB9OwogICAgICBkZWNvZGVBc2NpaSA9IGZ1bmN0aW9uKGlucHV0KSB7CiAgICAgICAgdmFyIG91dHB1dCA9ICcnOwogICAgICAgIHZhciBjaHIxLCBjaHIyLCBjaHIzOwogICAgICAgIHZhciBlbmMxLCBlbmMyLCBlbmMzLCBlbmM0OwogICAgICAgIHZhciBpID0gMDsKICAgICAgICBpZiAoaW5wdXQubWF0Y2goYmFzZTY0cmVnKSkgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KICAgICAgICBpbnB1dCA9IGlucHV0LnJlcGxhY2UoL1teQS1aYS16MC05XCtcL1w9XS9nLCAnJyk7CiAgICAgICAgZG8gewogICAgICAgICAgZW5jMSA9IGtleS5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKTsKICAgICAgICAgIGVuYzIgPSBrZXkuaW5kZXhPZihpbnB1dC5jaGFyQXQoaSsrKSk7CiAgICAgICAgICBlbmMzID0ga2V5LmluZGV4T2YoaW5wdXQuY2hhckF0KGkrKykpOwogICAgICAgICAgZW5jNCA9IGtleS5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKTsKICAgICAgICAgIGNocjEgPSAoZW5jMSA8PCAyKSB8IChlbmMyID4+IDQpOwogICAgICAgICAgY2hyMiA9ICgoZW5jMiAmIDE1KSA8PCA0KSB8IChlbmMzID4+IDIpOwogICAgICAgICAgY2hyMyA9ICgoZW5jMyAmIDMpIDw8IDYpIHwgZW5jNDsKICAgICAgICAgIG91dHB1dCA9IG91dHB1dCArIGNocihjaHIxKTsKICAgICAgICAgIGlmIChlbmMzICE9IDY0KSB7CiAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dCArIGNocihjaHIyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlbmM0ICE9IDY0KSB7CiAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dCArIGNocihjaHIzKTsKICAgICAgICAgIH0KICAgICAgICAgIGNocjEgPSBjaHIyID0gY2hyMyA9ICcnOwogICAgICAgICAgZW5jMSA9IGVuYzIgPSBlbmMzID0gZW5jNCA9ICcnOwogICAgICAgIH0gd2hpbGUgKGkgPCBpbnB1dC5sZW5ndGgpOwogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgIH07CiAgICB9CiAgICBlbmNvZGVCYXNlNjQgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgcmV0dXJuIGVuY29kZUFzY2lpKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzdHIpKSk7CiAgICB9OwogICAgZGVjb2RlQmFzZTY0ID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoZXNjYXBlKGRlY29kZUFzY2lpKHN0cikpKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBidWlsZEVudGl0aWVzKCkgewogICAgSFRNTFRvRW50aXR5TWFwID0ge307CiAgICBmb3JFYWNoUHJvcGVydHkoSFRNTEZyb21FbnRpdHlNYXAsIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgIEhUTUxUb0VudGl0eU1hcFt2YWxdID0gJyYnICsga2V5ICsgJzsnOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBjYWxsSW5jbHVkZXNXaXRoUmVnZXhTdXBwb3J0KHN0ciwgc2VhcmNoLCBwb3NpdGlvbikgewogICAgaWYgKCFpc1JlZ0V4cChzZWFyY2gpKSB7CiAgICAgIHJldHVybiBuYXRpdmVJbmNsdWRlcy5jYWxsKHN0ciwgc2VhcmNoLCBwb3NpdGlvbik7CiAgICB9CiAgICBpZiAocG9zaXRpb24pIHsKICAgICAgc3RyID0gc3RyLnNsaWNlKHBvc2l0aW9uKTsKICAgIH0KICAgIHJldHVybiBzZWFyY2gudGVzdChzdHIpOwogIH0KCiAgZGVmaW5lSW5zdGFuY2Uoc3VnYXJTdHJpbmcsIHsKCiAgICAvLyBFbmhhbmNtZW50IHRvIFN0cmluZyNpbmNsdWRlcyB0byBhbGxvdyBhIHJlZ2V4LgogICAgJ2luY2x1ZGVzJzogZml4QXJndW1lbnRMZW5ndGgoY2FsbEluY2x1ZGVzV2l0aFJlZ2V4U3VwcG9ydCkKCiAgfSwgW0VOSEFOQ0VNRU5UU19GTEFHLCBTVFJJTkdfRU5IQU5DRU1FTlRTX0ZMQUddKTsKCiAgZGVmaW5lSW5zdGFuY2Uoc3VnYXJTdHJpbmcsIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGF0KGluZGV4LCBbbG9vcF0gPSBmYWxzZSkKICAgICAqIEByZXR1cm5zIE1peGVkCiAgICAgKiBAc2hvcnQgR2V0cyB0aGUgY2hhcmFjdGVyKHMpIGF0IGEgZ2l2ZW4gaW5kZXguCiAgICAgKiBAZXh0cmEgV2hlbiBbbG9vcF0gaXMgdHJ1ZSwgb3ZlcnNob290aW5nIHRoZSBlbmQgb2YgdGhlIHN0cmluZyB3aWxsIGJlZ2luCiAgICAgKiAgICAgICAgY291bnRpbmcgZnJvbSB0aGUgb3RoZXIgZW5kLiBgaW5kZXhgIG1heSBiZSBuZWdhdGl2ZS4gSWYgYGluZGV4YCBpcwogICAgICogICAgICAgIGFuIGFycmF5LCBtdWx0aXBsZSBlbGVtZW50cyB3aWxsIGJlIHJldHVybmVkLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdqdW1weScuYXQoMCkgICAgICAgICAgICAgLT4gJ2onCiAgICAgKiAgICdqdW1weScuYXQoMikgICAgICAgICAgICAgLT4gJ20nCiAgICAgKiAgICdqdW1weScuYXQoNSkgICAgICAgICAgICAgLT4gJycKICAgICAqICAgJ2p1bXB5Jy5hdCg1LCB0cnVlKSAgICAgICAtPiAnaicKICAgICAqICAgJ2p1bXB5Jy5hdCgtMSkgICAgICAgICAgICAtPiAneScKICAgICAqICAgJ2x1Y2t5IGNoYXJtcycuYXQoWzIsIDRdKSAtPiBbJ3UnLCdrJ10KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcnxBcnJheTxudW1iZXI+fSBpbmRleAogICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcF0KICAgICAqCiAgICAgKioqLwogICAgJ2F0JzogZnVuY3Rpb24oc3RyLCBpbmRleCwgbG9vcCkgewogICAgICByZXR1cm4gZ2V0RW50cmllc0ZvckluZGV4ZXMoc3RyLCBpbmRleCwgbG9vcCwgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZXNjYXBlVVJMKFtwYXJhbV0gPSBmYWxzZSkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IEVzY2FwZXMgY2hhcmFjdGVycyBpbiBhIHN0cmluZyB0byBtYWtlIGEgdmFsaWQgVVJMLgogICAgICogQGV4dHJhIElmIFtwYXJhbV0gaXMgdHJ1ZSwgaXQgd2lsbCBhbHNvIGVzY2FwZSB2YWxpZCBVUkwgY2hhcmFjdGVycy4gVXNlCiAgICAgKiAgICAgICAgdGhpcyB3aGVuIHRoZSBlbnRpcmUgc3RyaW5nIGlzIG1lYW50IGZvciB1c2UgaW4gYSBxdWVyeSBzdHJpbmcuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdhLCBiLCBhbmQgYycuZXNjYXBlVVJMKCkgLT4gJ2EsJTIwYiwlMjBhbmQlMjBjJwogICAgICogICAnaHR0cDovL2Zvby5jb20vJy5lc2NhcGVVUkwodHJ1ZSkgLT4gJ2h0dHAlM0ElMkYlMkZmb28uY29tJTJGJwogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3BhcmFtXQogICAgICoKICAgICAqKiovCiAgICAnZXNjYXBlVVJMJzogZnVuY3Rpb24oc3RyLCBwYXJhbSkgewogICAgICByZXR1cm4gcGFyYW0gPyBlbmNvZGVVUklDb21wb25lbnQoc3RyKSA6IGVuY29kZVVSSShzdHIpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHVuZXNjYXBlVVJMKFtwYXJ0aWFsXSA9IGZhbHNlKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUmVzdG9yZXMgZXNjYXBlZCBjaGFyYWN0ZXJzIGluIGEgVVJMIGVzY2FwZWQgc3RyaW5nLgogICAgICogQGV4dHJhIElmIFtwYXJ0aWFsXSBpcyB0cnVlLCBpdCB3aWxsIG9ubHkgdW5lc2NhcGUgbm9uLXZhbGlkIFVSTCB0b2tlbnMsCiAgICAgKiAgICAgICAgYW5kIGlzIGluY2x1ZGVkIGhlcmUgZm9yIGNvbXBsZXRlbmVzcywgYnV0IHNob3VsZCBiZSByYXJlbHkgbmVlZGVkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnaHR0cCUzQSUyRiUyRmZvby5jb20lMkYnLnVuZXNjYXBlVVJMKCkgICAgIC0+ICdodHRwOi8vZm9vLmNvbS8nCiAgICAgKiAgICdodHRwJTNBJTJGJTJGZm9vLmNvbSUyRicudW5lc2NhcGVVUkwodHJ1ZSkgLT4gJ2h0dHAlM0ElMkYlMkZmb28uY29tJTJGJwogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3BhcnRpYWxdCiAgICAgKgogICAgICoqKi8KICAgICd1bmVzY2FwZVVSTCc6IGZ1bmN0aW9uKHN0ciwgcGFyYW0pIHsKICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJKHN0cikgOiBkZWNvZGVVUklDb21wb25lbnQoc3RyKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBlc2NhcGVIVE1MKCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IENvbnZlcnRzIEhUTUwgY2hhcmFjdGVycyB0byB0aGVpciBlbnRpdHkgZXF1aXZhbGVudHMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICc8cD5zb21lIHRleHQ8L3A+Jy5lc2NhcGVIVE1MKCkgLT4gJyZsdDtwJmd0O3NvbWUgdGV4dCZsdDsvcCZndDsnCiAgICAgKiAgICdvbmUgJiB0d28nLmVzY2FwZUhUTUwoKSAgICAgICAgLT4gJ29uZSAmYW1wOyB0d28nCiAgICAgKgogICAgICoqKi8KICAgICdlc2NhcGVIVE1MJzogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBzdHIucmVwbGFjZShIVE1MX0VTQ0FQRV9SRUcsIGZ1bmN0aW9uKGNocikgewogICAgICAgIHJldHVybiBnZXRPd24oSFRNTFRvRW50aXR5TWFwLCBjaHIpOwogICAgICB9KTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCB1bmVzY2FwZUhUTUwoKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUmVzdG9yZXMgZXNjYXBlZCBIVE1MIGNoYXJhY3RlcnMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICcmbHQ7cCZndDtzb21lIHRleHQmbHQ7L3AmZ3Q7Jy51bmVzY2FwZUhUTUwoKSAtPiAnPHA+c29tZSB0ZXh0PC9wPicKICAgICAqICAgJ29uZSAmYW1wOyB0d28nLnVuZXNjYXBlSFRNTCgpICAgICAgICAgICAgICAgIC0+ICdvbmUgJiB0d28nCiAgICAgKgogICAgICoqKi8KICAgICd1bmVzY2FwZUhUTUwnOiBmdW5jdGlvbihzdHIpIHsKICAgICAgcmV0dXJuIHVuZXNjYXBlSFRNTChzdHIpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHN0cmlwVGFncyhbdGFnXSA9ICdhbGwnLCBbcmVwbGFjZV0pCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBTdHJpcHMgSFRNTCB0YWdzIGZyb20gdGhlIHN0cmluZy4KICAgICAqIEBleHRyYSBbdGFnXSBtYXkgYmUgYW4gYXJyYXkgb2YgdGFncyBvciAnYWxsJywgaW4gd2hpY2ggY2FzZSBhbGwgdGFncyB3aWxsCiAgICAgKiAgICAgICAgYmUgc3RyaXBwZWQuIFtyZXBsYWNlXSB3aWxsIHJlcGxhY2Ugd2hhdCB3YXMgc3RyaXBwZWQsIGFuZCBtYXkgYmUgYQogICAgICogICAgICAgIHN0cmluZyBvciBhIGZ1bmN0aW9uIHRvIGhhbmRsZSByZXBsYWNlbWVudHMuIElmIHRoaXMgZnVuY3Rpb24gcmV0dXJucwogICAgICogICAgICAgIGEgc3RyaW5nLCB0aGVuIGl0IHdpbGwgYmUgdXNlZCBmb3IgdGhlIHJlcGxhY2VtZW50LiBJZiBpdCByZXR1cm5zCiAgICAgKiAgICAgICAgYHVuZGVmaW5lZGAsIHRoZSB0YWdzIHdpbGwgYmUgc3RyaXBwZWQgbm9ybWFsbHkuCiAgICAgKgogICAgICogQGNhbGxiYWNrIHRhZ1JlcGxhY2VGbgogICAgICoKICAgICAqICAgdGFnICAgICBUaGUgdGFnIG5hbWUuCiAgICAgKiAgIGlubmVyICAgVGhlIHRhZyBjb250ZW50LgogICAgICogICBhdHRyICAgIFRoZSBhdHRyaWJ1dGVzIG9uIHRoZSB0YWcsIGlmIGFueSwgYXMgYSBzdHJpbmcuCiAgICAgKiAgIG91dGVyICAgVGhlIGVudGlyZSBtYXRjaGVkIHRhZyBzdHJpbmcuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICc8cD5qdXN0IDxiPnNvbWU8L2I+IHRleHQ8L3A+Jy5zdHJpcFRhZ3MoKSAgICAtPiAnanVzdCBzb21lIHRleHQnCiAgICAgKiAgICc8cD5qdXN0IDxiPnNvbWU8L2I+IHRleHQ8L3A+Jy5zdHJpcFRhZ3MoJ3AnKSAtPiAnanVzdCA8Yj5zb21lPC9iPiB0ZXh0JwogICAgICogICAnPHA+aGkhPC9wPicuc3RyaXBUYWdzKCdwJywgZnVuY3Rpb24oYWxsLCBjb250ZW50KSB7CiAgICAgKiAgICAgcmV0dXJuICd8JzsKICAgICAqICAgfSk7IC0+ICd8aGkhfCcKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGFnCiAgICAgKiBAcGFyYW0ge3N0cmluZ3x0YWdSZXBsYWNlRm59IHJlcGxhY2UKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IHRhZwogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30gaW5uZXIKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGF0dHIKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IG91dGVyCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtzdHJpbmd9IHRhZ1JlcGxhY2VGbgogICAgICoKICAgICAqKiovCiAgICAnc3RyaXBUYWdzJzogZnVuY3Rpb24oc3RyLCB0YWcsIHJlcGxhY2UpIHsKICAgICAgcmV0dXJuIHJlcGxhY2VUYWdzKHN0ciwgdGFnLCByZXBsYWNlLCB0cnVlKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCByZW1vdmVUYWdzKFt0YWddID0gJ2FsbCcsIFtyZXBsYWNlXSkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJlbW92ZXMgSFRNTCB0YWdzIGFuZCB0aGVpciBjb250ZW50cyBmcm9tIHRoZSBzdHJpbmcuCiAgICAgKiBAZXh0cmEgW3RhZ10gbWF5IGJlIGFuIGFycmF5IG9mIHRhZ3Mgb3IgJ2FsbCcsIGluIHdoaWNoIGNhc2UgYWxsIHRhZ3Mgd2lsbAogICAgICogICAgICAgIGJlIHJlbW92ZWQuIFtyZXBsYWNlXSB3aWxsIHJlcGxhY2Ugd2hhdCB3YXMgcmVtb3ZlZCwgYW5kIG1heSBiZSBhCiAgICAgKiAgICAgICAgc3RyaW5nIG9yIGEgZnVuY3Rpb24gdG8gaGFuZGxlIHJlcGxhY2VtZW50cy4gSWYgdGhpcyBmdW5jdGlvbiByZXR1cm5zCiAgICAgKiAgICAgICAgYSBzdHJpbmcsIHRoZW4gaXQgd2lsbCBiZSB1c2VkIGZvciB0aGUgcmVwbGFjZW1lbnQuIElmIGl0IHJldHVybnMKICAgICAqICAgICAgICBgdW5kZWZpbmVkYCwgdGhlIHRhZ3Mgd2lsbCBiZSByZW1vdmVkIG5vcm1hbGx5LgogICAgICoKICAgICAqIEBjYWxsYmFjayB0YWdSZXBsYWNlRm4KICAgICAqCiAgICAgKiAgIHRhZyAgICAgVGhlIHRhZyBuYW1lLgogICAgICogICBpbm5lciAgIFRoZSB0YWcgY29udGVudC4KICAgICAqICAgYXR0ciAgICBUaGUgYXR0cmlidXRlcyBvbiB0aGUgdGFnLCBpZiBhbnksIGFzIGEgc3RyaW5nLgogICAgICogICBvdXRlciAgIFRoZSBlbnRpcmUgbWF0Y2hlZCB0YWcgc3RyaW5nLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnPHA+anVzdCA8Yj5zb21lPC9iPiB0ZXh0PC9wPicucmVtb3ZlVGFncygpICAgIC0+ICcnCiAgICAgKiAgICc8cD5qdXN0IDxiPnNvbWU8L2I+IHRleHQ8L3A+Jy5yZW1vdmVUYWdzKCdiJykgLT4gJzxwPmp1c3QgdGV4dDwvcD4nCiAgICAgKiAgICc8cD5oaSE8L3A+Jy5yZW1vdmVUYWdzKCdwJywgZnVuY3Rpb24oYWxsLCBjb250ZW50KSB7CiAgICAgKiAgICAgcmV0dXJuICdieWUhJzsKICAgICAqICAgfSk7IC0+ICdieWUhJwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YWcKICAgICAqIEBwYXJhbSB7c3RyaW5nfHRhZ1JlcGxhY2VGbn0gcmVwbGFjZQogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30gdGFnCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7c3RyaW5nfSBpbm5lcgogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30gYXR0cgogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30gb3V0ZXIKICAgICAqIEBjYWxsYmFja1JldHVybnMge3N0cmluZ30gdGFnUmVwbGFjZUZuCiAgICAgKgogICAgICoqKi8KICAgICdyZW1vdmVUYWdzJzogZnVuY3Rpb24oc3RyLCB0YWcsIHJlcGxhY2UpIHsKICAgICAgcmV0dXJuIHJlcGxhY2VUYWdzKHN0ciwgdGFnLCByZXBsYWNlLCBmYWxzZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZW5jb2RlQmFzZTY0KCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IEVuY29kZXMgdGhlIHN0cmluZyBpbnRvIGJhc2U2NCBlbmNvZGluZy4KICAgICAqIEBleHRyYSBUaGlzIG1ldGhvZCB3cmFwcyBuYXRpdmUgbWV0aG9kcyB3aGVuIGF2YWlsYWJsZSwgYW5kIHVzZXMgYSBjdXN0b20KICAgICAqICAgICAgICBpbXBsZW1lbnRhdGlvbiB3aGVuIG5vdCBhdmFpbGFibGUuIEl0IGNhbiBhbHNvIGhhbmRsZSBVbmljb2RlCiAgICAgKiAgICAgICAgc3RyaW5nIGVuY29kaW5ncy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2dvbm5hIGdldCBlbmNvZGVkIScuZW5jb2RlQmFzZTY0KCkgIC0+ICdaMjl1Ym1FZ1oyVjBJR1Z1WTI5a1pXUWgnCiAgICAgKiAgICdodHRwOi8vdHdpdHRlci5jb20vJy5lbmNvZGVCYXNlNjQoKSAtPiAnYUhSMGNEb3ZMM1IzYVhSMFpYSXVZMjl0THc9PScKICAgICAqCiAgICAgKioqLwogICAgJ2VuY29kZUJhc2U2NCc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gZW5jb2RlQmFzZTY0KHN0cik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZGVjb2RlQmFzZTY0KCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IERlY29kZXMgdGhlIHN0cmluZyBmcm9tIGJhc2U2NCBlbmNvZGluZy4KICAgICAqIEBleHRyYSBUaGlzIG1ldGhvZCB3cmFwcyBuYXRpdmUgbWV0aG9kcyB3aGVuIGF2YWlsYWJsZSwgYW5kIHVzZXMgYSBjdXN0b20KICAgICAqICAgICAgICBpbXBsZW1lbnRhdGlvbiB3aGVuIG5vdCBhdmFpbGFibGUuIEl0IGNhbiBhbHNvIGhhbmRsZSBVbmljb2RlIHN0cmluZwogICAgICogICAgICAgIGVuY29kaW5ncy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2FIUjBjRG92TDNSM2FYUjBaWEl1WTI5dEx3PT0nLmRlY29kZUJhc2U2NCgpIC0+ICdodHRwOi8vdHdpdHRlci5jb20vJwogICAgICogICAnYW5WemRDQm5iM1FnWkdWamIyUmxaQT09Jy5kZWNvZGVCYXNlNjQoKSAgICAgLT4gJ2p1c3QgZ290IGRlY29kZWQhJwogICAgICoKICAgICAqKiovCiAgICAnZGVjb2RlQmFzZTY0JzogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBkZWNvZGVCYXNlNjQoc3RyKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBmb3JFYWNoKFtzZWFyY2hdLCBbY2FsbGJhY2tdKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBSdW5zIGNhbGxiYWNrIFtmbl0gYWdhaW5zdCBldmVyeSBjaGFyYWN0ZXIgaW4gdGhlIHN0cmluZywgb3IgZXZlcnkKICAgICAqICAgICAgICBldmVyeSBvY2N1cmVuY2Ugb2YgW3NlYXJjaF0gaWYgaXQgaXMgcHJvdmlkZWQuCiAgICAgKiBAZXh0cmEgUmV0dXJucyBhbiBhcnJheSBvZiBtYXRjaGVzLiBbc2VhcmNoXSBtYXkgYmUgZWl0aGVyIGEgc3RyaW5nIG9yCiAgICAgKiAgICAgICAgcmVnZXgsIGFuZCBkZWZhdWx0cyB0byBldmVyeSBjaGFyYWN0ZXIgaW4gdGhlIHN0cmluZy4gSWYgW2ZuXQogICAgICogICAgICAgIHJldHVybnMgZmFsc2UgYXQgYW55IHRpbWUgaXQgd2lsbCBicmVhayBvdXQgb2YgdGhlIGxvb3AuCiAgICAgKgogICAgICogQGNhbGxiYWNrIHN0cmluZ0VhY2hGbgogICAgICoKICAgICAqICAgbWF0Y2ggIFRoZSBjdXJyZW50IG1hdGNoLgogICAgICogICBpICAgICAgVGhlIGN1cnJlbnQgaW5kZXguCiAgICAgKiAgIGFyciAgICBBbiBhcnJheSBvZiBhbGwgbWF0Y2hlcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2p1bXB5Jy5mb3JFYWNoKGxvZykgICAgIC0+IFsnaicsJ3UnLCdtJywncCcsJ3knXQogICAgICogICAnanVtcHknLmZvckVhY2goL1tyLXpdLykgLT4gWyd1JywneSddCiAgICAgKiAgICdqdW1weScuZm9yRWFjaCgvbXAvKSAgICAtPiBbJ21wJ10KICAgICAqICAgJ2p1bXB5Jy5mb3JFYWNoKC9bci16XS8sIGZ1bmN0aW9uKG0pIHsKICAgICAqICAgICAvLyBDYWxsZWQgdHdpY2U6ICJ1IiwgInkiCiAgICAgKiAgIH0pOwogICAgICoKICAgICAqIEBzaWduYXR1cmUgZm9yRWFjaChjYWxsYmFjaykKICAgICAqIEBwYXJhbSB7c3RyaW5nfFJlZ0V4cH0gW3NlYXJjaF0KICAgICAqIEBwYXJhbSB7c3RyaW5nRWFjaEZufSBbY2FsbGJhY2tdCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7c3RyaW5nfSBtYXRjaAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5PHN0cmluZz59IGFycgogICAgICoKICAgICAqKiovCiAgICAnZm9yRWFjaCc6IGZ1bmN0aW9uKHN0ciwgc2VhcmNoLCBmbikgewogICAgICByZXR1cm4gc3RyaW5nRWFjaChzdHIsIHNlYXJjaCwgZm4pOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGNoYXJzKFtjYWxsYmFja10pCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IFJ1bnMgW2ZuXSBhZ2FpbnN0IGVhY2ggY2hhcmFjdGVyIGluIHRoZSBzdHJpbmcsIGFuZCByZXR1cm5zIGFuIGFycmF5LgogICAgICoKICAgICAqIEBjYWxsYmFjayBlYWNoQ2hhckZuCiAgICAgKgogICAgICogICBjaGFyICBUaGUgY3VycmVudCBjaGFyYWN0ZXIuCiAgICAgKiAgIGkgICAgIFRoZSBjdXJyZW50IGluZGV4LgogICAgICogICBhcnIgICBBbiBhcnJheSBvZiBhbGwgY2hhcmFjdGVycy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2p1bXB5Jy5jaGFycygpIC0+IFsnaicsJ3UnLCdtJywncCcsJ3knXQogICAgICogICAnanVtcHknLmNoYXJzKGZ1bmN0aW9uKGMpIHsKICAgICAqICAgICAvLyBDYWxsZWQgNSB0aW1lczogImoiLCJ1IiwibSIsInAiLCJ5IgogICAgICogICB9KTsKICAgICAqCiAgICAgKiBAcGFyYW0ge2VhY2hDaGFyRm59IFtjYWxsYmFja10KICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGNoYXIKICAgICAqIEBjYWxsYmFja1BhcmFtIHtudW1iZXJ9IGkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheTxzdHJpbmc+fSBhcnIKICAgICAqCiAgICAgKioqLwogICAgJ2NoYXJzJzogZnVuY3Rpb24oc3RyLCBzZWFyY2gsIGZuKSB7CiAgICAgIHJldHVybiBzdHJpbmdFYWNoKHN0ciwgc2VhcmNoLCBmbik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2Qgd29yZHMoW2NhbGxiYWNrXSkKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgUnVucyBbZm5dIGFnYWluc3QgZWFjaCB3b3JkIGluIHRoZSBzdHJpbmcsIGFuZCByZXR1cm5zIGFuIGFycmF5LgogICAgICogQGV4dHJhIEEgIndvcmQiIGlzIGRlZmluZWQgYXMgYW55IHNlcXVlbmNlIG9mIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGVhY2hXb3JkRm4KICAgICAqCiAgICAgKiAgIHdvcmQgIFRoZSBjdXJyZW50IHdvcmQuCiAgICAgKiAgIGkgICAgIFRoZSBjdXJyZW50IGluZGV4LgogICAgICogICBhcnIgICBBbiBhcnJheSBvZiBhbGwgd29yZHMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdicm9rZW4gd2Vhcicud29yZHMoKSAtPiBbJ2Jyb2tlbicsJ3dlYXInXQogICAgICogICAnYnJva2VuIHdlYXInLndvcmRzKGZ1bmN0aW9uKHcpIHsKICAgICAqICAgICAvLyBDYWxsZWQgdHdpY2U6ICJicm9rZW4iLCAid2VhciIKICAgICAqICAgfSk7CiAgICAgKgogICAgICogQHBhcmFtIHtlYWNoV29yZEZufSBbY2FsbGJhY2tdCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7c3RyaW5nfSB3b3JkCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXk8c3RyaW5nPn0gYXJyCiAgICAgKgogICAgICoqKi8KICAgICd3b3Jkcyc6IGZ1bmN0aW9uKHN0ciwgZm4pIHsKICAgICAgcmV0dXJuIHN0cmluZ0VhY2godHJpbShzdHIpLCAvXFMrL2csIGZuKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBsaW5lcyhbY2FsbGJhY2tdKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBSdW5zIFtmbl0gYWdhaW5zdCBlYWNoIGxpbmUgaW4gdGhlIHN0cmluZywgYW5kIHJldHVybnMgYW4gYXJyYXkuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGVhY2hMaW5lRm4KICAgICAqCiAgICAgKiAgIGxpbmUgIFRoZSBjdXJyZW50IGxpbmUuCiAgICAgKiAgIGkgICAgIFRoZSBjdXJyZW50IGluZGV4LgogICAgICogICBhcnIgICBBbiBhcnJheSBvZiBhbGwgbGluZXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIGxpbmVUZXh0LmxpbmVzKCkgLT4gYXJyYXkgb2YgbGluZXMKICAgICAqICAgbGluZVRleHQubGluZXMoZnVuY3Rpb24obCkgewogICAgICogICAgIC8vIENhbGxlZCBvbmNlIHBlciBsaW5lCiAgICAgKiAgIH0pOwogICAgICoKICAgICAqIEBwYXJhbSB7ZWFjaExpbmVGbn0gW2NhbGxiYWNrXQogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30gbGluZQogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5PHN0cmluZz59IGFycgogICAgICoKICAgICAqKiovCiAgICAnbGluZXMnOiBmdW5jdGlvbihzdHIsIGZuKSB7CiAgICAgIHJldHVybiBzdHJpbmdFYWNoKHRyaW0oc3RyKSwgL14uKiQvZ20sIGZuKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBjb2RlcyhbY2FsbGJhY2tdKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBSdW5zIGNhbGxiYWNrIFtmbl0gYWdhaW5zdCBlYWNoIGNoYXJhY3RlciBjb2RlIGluIHRoZSBzdHJpbmcuCiAgICAgKiAgICAgICAgUmV0dXJucyBhbiBhcnJheSBvZiBjaGFyYWN0ZXIgY29kZXMuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGVhY2hDb2RlRm4KICAgICAqCiAgICAgKiAgIGNvZGUgIFRoZSBjdXJyZW50IGNoYXJhY3RlciBjb2RlLgogICAgICogICBpICAgICBUaGUgY3VycmVudCBpbmRleC4KICAgICAqICAgc3RyICAgVGhlIHN0cmluZyBiZWluZyBvcGVyYXRlZCBvbi4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2p1bXB5Jy5jb2RlcygpIC0+IFsxMDYsMTE3LDEwOSwxMTIsMTIxXQogICAgICogICAnanVtcHknLmNvZGVzKGZ1bmN0aW9uKGMpIHsKICAgICAqICAgICAvLyBDYWxsZWQgNSB0aW1lczogMTA2LCAxMTcsIDEwOSwgMTEyLCAxMjEKICAgICAqICAgfSk7CiAgICAgKgogICAgICogQHBhcmFtIHtlYWNoQ29kZUZufSBbY2FsbGJhY2tdCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBjb2RlCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7c3RyaW5nfSBzdHIKICAgICAqCiAgICAgKioqLwogICAgJ2NvZGVzJzogZnVuY3Rpb24oc3RyLCBmbikgewogICAgICByZXR1cm4gc3RyaW5nQ29kZXMoc3RyLCBmbik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2Qgc2hpZnQobikKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgU2hpZnRzIGVhY2ggY2hhcmFjdGVyIGluIHRoZSBzdHJpbmcgYG5gIHBsYWNlcyBpbiB0aGUgY2hhcmFjdGVyIG1hcC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2EnLnNoaWZ0KDEpICAtPiAnYicKICAgICAqICAgJ+OCrycuc2hpZnQoMSkgLT4gJ+OCsCcKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbgogICAgICoKICAgICAqKiovCiAgICAnc2hpZnQnOiBmdW5jdGlvbihzdHIsIG4pIHsKICAgICAgdmFyIHJlc3VsdCA9ICcnOwogICAgICBuID0gbiB8fCAwOwogICAgICBzdHJpbmdDb2RlcyhzdHIsIGZ1bmN0aW9uKGMpIHsKICAgICAgICByZXN1bHQgKz0gY2hyKGMgKyBuKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaXNCbGFuaygpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBzdHJpbmcgaGFzIGxlbmd0aCAwIG9yIGNvbnRhaW5zIG9ubHkgd2hpdGVzcGFjZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJycuaXNCbGFuaygpICAgICAgLT4gdHJ1ZQogICAgICogICAnICAgJy5pc0JsYW5rKCkgICAtPiB0cnVlCiAgICAgKiAgICdub3dheScuaXNCbGFuaygpIC0+IGZhbHNlCiAgICAgKgogICAgICoqKi8KICAgICdpc0JsYW5rJzogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiB0cmltKHN0cikubGVuZ3RoID09PSAwOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGlzRW1wdHkoKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgc3RyaW5nIGhhcyBsZW5ndGggMC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJycuaXNFbXB0eSgpICAtPiB0cnVlCiAgICAgKiAgICdhJy5pc0JsYW5rKCkgLT4gZmFsc2UKICAgICAqICAgJyAnLmlzQmxhbmsoKSAtPiBmYWxzZQogICAgICoKICAgICAqKiovCiAgICAnaXNFbXB0eSc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gc3RyLmxlbmd0aCA9PT0gMDsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBpbnNlcnQoc3RyLCBbaW5kZXhdID0gbGVuZ3RoKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgQWRkcyBgc3RyYCBhdCBbaW5kZXhdLiBBbGxvd3MgbmVnYXRpdmUgdmFsdWVzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnZG9wYW1pbmUnLmluc2VydCgnZScsIDMpICAgICAgIC0+IGRvcGVhbWluZQogICAgICogICAnc3BlbGxpbmcgZXJvcicuaW5zZXJ0KCdyJywgLTMpIC0+IHNwZWxsaW5nIGVycm9yCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtpbmRleF0KICAgICAqCiAgICAgKioqLwogICAgJ2luc2VydCc6IGZ1bmN0aW9uKHN0ciwgc3Vic3RyLCBpbmRleCkgewogICAgICBpbmRleCA9IGlzVW5kZWZpbmVkKGluZGV4KSA/IHN0ci5sZW5ndGggOiBpbmRleDsKICAgICAgcmV0dXJuIHN0ci5zbGljZSgwLCBpbmRleCkgKyBzdWJzdHIgKyBzdHIuc2xpY2UoaW5kZXgpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJlbW92ZShmKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUmVtb3ZlcyB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBgZmAgaW4gdGhlIHN0cmluZy4KICAgICAqIEBleHRyYSBgZmAgY2FuIGJlIGEgZWl0aGVyIGNhc2Utc2Vuc2l0aXZlIHN0cmluZyBvciBhIHJlZ2V4LiBJbiBlaXRoZXIgY2FzZQogICAgICogICAgICAgIG9ubHkgdGhlIGZpcnN0IG1hdGNoIHdpbGwgYmUgcmVtb3ZlZC4gVG8gcmVtb3ZlIG11bHRpcGxlIG9jY3VycmVuY2VzLAogICAgICogICAgICAgIHVzZSBgcmVtb3ZlQWxsYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ3NjaGZpZnR5IGZpdmUnLnJlbW92ZSgnZicpICAgICAgLT4gJ3NjaGlmdHkgZml2ZScKICAgICAqICAgJ3NjaGZpZnR5IGZpdmUnLnJlbW92ZSgvW2EtZl0vZykgLT4gJ3NoZmlmdHkgZml2ZScKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xSZWdFeHB9IGYKICAgICAqCiAgICAgKioqLwogICAgJ3JlbW92ZSc6IGZ1bmN0aW9uKHN0ciwgZikgewogICAgICByZXR1cm4gc3RyLnJlcGxhY2UoZiwgJycpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJlbW92ZUFsbChmKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUmVtb3ZlcyBhbnkgb2NjdXJlbmNlcyBvZiBgZmAgaW4gdGhlIHN0cmluZy4KICAgICAqIEBleHRyYSBgZmAgY2FuIGJlIGVpdGhlciBhIGNhc2Utc2Vuc2l0aXZlIHN0cmluZyBvciBhIHJlZ2V4LiBJbiBlaXRoZXIgY2FzZQogICAgICogICAgICAgIGFsbCBtYXRjaGVzIHdpbGwgYmUgcmVtb3ZlZC4gVG8gcmVtb3ZlIG9ubHkgYSBzaW5nbGUgb2NjdXJlbmNlLCB1c2UKICAgICAqICAgICAgICBgcmVtb3ZlYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ3NjaGZpZnR5IGZpdmUnLnJlbW92ZUFsbCgnZicpICAgICAtPiAnc2NoaXR5IGl2ZScKICAgICAqICAgJ3NjaGZpZnR5IGZpdmUnLnJlbW92ZUFsbCgvW2EtZl0vKSAtPiAnc2hpdHkgaXYnCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8UmVnRXhwfSBmCiAgICAgKgogICAgICoqKi8KICAgICdyZW1vdmVBbGwnOiBmdW5jdGlvbihzdHIsIGYpIHsKICAgICAgcmV0dXJuIHN0cmluZ1JlcGxhY2VBbGwoc3RyLCBmKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCByZXZlcnNlKCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJldmVyc2VzIHRoZSBzdHJpbmcuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdqdW1weScucmV2ZXJzZSgpICAgICAgICAtPiAneXBtdWonCiAgICAgKiAgICdsdWNreSBjaGFybXMnLnJldmVyc2UoKSAtPiAnc21yYWhjIHlrY3VsJwogICAgICoKICAgICAqKiovCiAgICAncmV2ZXJzZSc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gcmV2ZXJzZVN0cmluZyhzdHIpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGNvbXBhY3QoKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgQ29tcGFjdHMgd2hpdGVzcGFjZSBpbiB0aGUgc3RyaW5nIHRvIGEgc2luZ2xlIHNwYWNlIGFuZCB0cmltcyB0aGUgZW5kcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ3RvbyBcbiBtdWNoIFxuIHNwYWNlJy5jb21wYWN0KCkgLT4gJ3RvbyBtdWNoIHNwYWNlJwogICAgICogICAnZW5vdWdoIFxuICcuY29tcGFjdCgpICAgICAgICAgICAtPiAnZW5vdWdodCcKICAgICAqCiAgICAgKioqLwogICAgJ2NvbXBhY3QnOiBmdW5jdGlvbihzdHIpIHsKICAgICAgcmV0dXJuIHRyaW0oc3RyKS5yZXBsYWNlKC8oW1xyXG5cc+OAgF0pKy9nLCBmdW5jdGlvbihtYXRjaCwgd2hpdGVzcGFjZSkgewogICAgICAgIHJldHVybiB3aGl0ZXNwYWNlID09PSAn44CAJyA/IHdoaXRlc3BhY2UgOiAnICc7CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGZyb20oW2luZGV4XSA9IDApCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZXR1cm5zIGEgc2VjdGlvbiBvZiB0aGUgc3RyaW5nIHN0YXJ0aW5nIGZyb20gW2luZGV4XS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2x1Y2t5IGNoYXJtcycuZnJvbSgpICAgLT4gJ2x1Y2t5IGNoYXJtcycKICAgICAqICAgJ2x1Y2t5IGNoYXJtcycuZnJvbSg3KSAgLT4gJ2hhcm1zJwogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaW5kZXhdCiAgICAgKgogICAgICoqKi8KICAgICdmcm9tJzogZnVuY3Rpb24oc3RyLCBmcm9tKSB7CiAgICAgIHJldHVybiBzdHIuc2xpY2UobnVtYmVyT3JJbmRleChzdHIsIGZyb20sIHRydWUpKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCB0byhbaW5kZXhdID0gZW5kKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUmV0dXJucyBhIHNlY3Rpb24gb2YgdGhlIHN0cmluZyBlbmRpbmcgYXQgW2luZGV4XS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2x1Y2t5IGNoYXJtcycudG8oKSAgIC0+ICdsdWNreSBjaGFybXMnCiAgICAgKiAgICdsdWNreSBjaGFybXMnLnRvKDcpICAtPiAnbHVja3kgY2gnCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtpbmRleF0KICAgICAqCiAgICAgKioqLwogICAgJ3RvJzogZnVuY3Rpb24oc3RyLCB0bykgewogICAgICBpZiAoaXNVbmRlZmluZWQodG8pKSB0byA9IHN0ci5sZW5ndGg7CiAgICAgIHJldHVybiBzdHIuc2xpY2UoMCwgbnVtYmVyT3JJbmRleChzdHIsIHRvKSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZGFzaGVyaXplKCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IENvbnZlcnRzIHVuZGVyc2NvcmVzIGFuZCBjYW1lbCBjYXNpbmcgdG8gaHlwZW5zLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnYV9mYXJld2VsbF90b19hcm1zJy5kYXNoZXJpemUoKSAtPiAnYS1mYXJld2VsbC10by1hcm1zJwogICAgICogICAnY2Fwc0xvY2snLmRhc2hlcml6ZSgpICAgICAgICAgICAtPiAnY2Fwcy1sb2NrJwogICAgICoKICAgICAqKiovCiAgICAnZGFzaGVyaXplJzogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBzdHJpbmdVbmRlcnNjb3JlKHN0cikucmVwbGFjZSgvXy9nLCAnLScpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHVuZGVyc2NvcmUoKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgQ29udmVydHMgaHlwaGVucyBhbmQgY2FtZWwgY2FzaW5nIHRvIHVuZGVyc2NvcmVzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnYS1mYXJld2VsbC10by1hcm1zJy51bmRlcnNjb3JlKCkgLT4gJ2FfZmFyZXdlbGxfdG9fYXJtcycKICAgICAqICAgJ2NhcHNMb2NrJy51bmRlcnNjb3JlKCkgICAgICAgICAgIC0+ICdjYXBzX2xvY2snCiAgICAgKgogICAgICoqKi8KICAgICd1bmRlcnNjb3JlJzogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBzdHJpbmdVbmRlcnNjb3JlKHN0cik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgY2FtZWxpemUoW3VwcGVyXSA9IHRydWUpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBDb252ZXJ0cyB1bmRlcnNjb3JlcyBhbmQgaHlwaGVucyB0byBjYW1lbCBjYXNlLgogICAgICogQGV4dHJhIElmIFt1cHBlcl0gaXMgdHJ1ZSwgdGhlIHN0cmluZyB3aWxsIGJlIFVwcGVyQ2FtZWxDYXNlLiBJZiB0aGUKICAgICAqICAgICAgICBpbmZsZWN0aW9ucyBtb2R1bGUgaXMgaW5jbHVkZWQsIGFjcm9ueW1zIGNhbiBhbHNvIGJlIGRlZmluZWQgdGhhdAogICAgICogICAgICAgIHdpbGwgYmUgdXNlZCB3aGVuIGNhbWVsaXppbmcuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdjYXBzX2xvY2snLmNhbWVsaXplKCkgICAgICAgICAgICAgIC0+ICdDYXBzTG9jaycKICAgICAqICAgJ21vei1ib3JkZXItcmFkaXVzJy5jYW1lbGl6ZSgpICAgICAgLT4gJ01vekJvcmRlclJhZGl1cycKICAgICAqICAgJ21vei1ib3JkZXItcmFkaXVzJy5jYW1lbGl6ZShmYWxzZSkgLT4gJ21vekJvcmRlclJhZGl1cycKICAgICAqICAgJ2h0dHAtbWV0aG9kJy5jYW1lbGl6ZSgpICAgICAgICAgICAgLT4gJ0hUVFBNZXRob2QnCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFufSBbdXBwZXJdCiAgICAgKgogICAgICoqKi8KICAgICdjYW1lbGl6ZSc6IGZ1bmN0aW9uKHN0ciwgdXBwZXIpIHsKICAgICAgcmV0dXJuIHN0cmluZ0NhbWVsaXplKHN0ciwgdXBwZXIpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHNwYWNpZnkoKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgQ29udmVydHMgY2FtZWxjYXNlLCB1bmRlcnNjb3JlcywgYW5kIGh5cGhlbnMgdG8gc3BhY2VzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnY2FtZWxDYXNlJy5zcGFjaWZ5KCkgICAgICAgICAgICAgICAgICAgICAgICAgLT4gJ2NhbWVsIGNhc2UnCiAgICAgKiAgICdhbi11Z2x5LXN0cmluZycuc3BhY2lmeSgpICAgICAgICAgICAgICAgICAgICAtPiAnYW4gdWdseSBzdHJpbmcnCiAgICAgKiAgICdvaC1ub195b3VEaWQtbm90Jy5zcGFjaWZ5KCkuY2FwaXRhbGl6ZSh0cnVlKSAtPiAnc29tZXRoaW5nIGVsc2UnCiAgICAgKgogICAgICoqKi8KICAgICdzcGFjaWZ5JzogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBzdHJpbmdTcGFjaWZ5KHN0cik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgdGl0bGVpemUoKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgQ3JlYXRlcyBhIHRpdGxlIHZlcnNpb24gb2YgdGhlIHN0cmluZy4KICAgICAqIEBleHRyYSBDYXBpdGFsaXplcyBhbGwgdGhlIHdvcmRzIGFuZCByZXBsYWNlcyBzb21lIGNoYXJhY3RlcnMgaW4gdGhlIHN0cmluZwogICAgICogICAgICAgIHRvIGNyZWF0ZSBhIG5pY2VyIGxvb2tpbmcgdGl0bGUuIFN0cmluZyN0aXRsZWl6ZSBpcyBtZWFudCBmb3IKICAgICAqICAgICAgICBjcmVhdGluZyBwcmV0dHkgb3V0cHV0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnbWFuIGZyb20gdGhlIGJvb25kb2NrcycudGl0bGVpemUoKSAtPiAnTWFuIGZyb20gdGhlIEJvb25kb2NrcycKICAgICAqICAgJ3gtbWVuOiBhcG9jYWx5cHNlJy50aXRsZWl6ZSgpIC0+ICdYIE1lbjogQXBvY2FseXBzZScKICAgICAqICAgJ1RoZU1hbldpdGhvdXRBUGFzdCcudGl0bGVpemUoKSAtPiAnVGhlIE1hbiBXaXRob3V0IGEgUGFzdCcKICAgICAqICAgJ3JhaWRlcnNfb2ZfdGhlX2xvc3RfYXJrJy50aXRsZWl6ZSgpIC0+ICdSYWlkZXJzIG9mIHRoZSBMb3N0IEFyaycKICAgICAqCiAgICAgKioqLwogICAgJ3RpdGxlaXplJzogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBzdHJpbmdUaXRsZWl6ZShzdHIpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHBhcmFtZXRlcml6ZSgpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZXBsYWNlcyBzcGVjaWFsIGNoYXJhY3RlcnMgaW4gYSBzdHJpbmcgc28gdGhhdCBpdCBtYXkgYmUgdXNlZCBhcwogICAgICogICAgICAgIHBhcnQgb2YgYSBwcmV0dHkgVVJMLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnaGVsbCwgbm8hJy5wYXJhbWV0ZXJpemUoKSAtPiAnaGVsbC1ubycKICAgICAqCiAgICAgKioqLwogICAgJ3BhcmFtZXRlcml6ZSc6IGZ1bmN0aW9uKHN0ciwgc2VwYXJhdG9yKSB7CiAgICAgIHJldHVybiBzdHJpbmdQYXJhbWV0ZXJpemUoc3RyLCBzZXBhcmF0b3IpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHRydW5jYXRlKGxlbmd0aCwgW2Zyb21dID0gJ3JpZ2h0JywgW2VsbGlwc2lzXSA9ICcuLi4nKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgVHJ1bmNhdGVzIGEgc3RyaW5nLgogICAgICogQGV4dHJhIFtmcm9tXSBjYW4gYmUgYCdyaWdodCdgLCBgJ2xlZnQnYCwgb3IgYCdtaWRkbGUnYC4gSWYgdGhlIHN0cmluZyBpcwogICAgICogICAgICAgIHNob3J0ZXIgdGhhbiBgbGVuZ3RoYCwgW2VsbGlwc2lzXSB3aWxsIG5vdCBiZSBhZGRlZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ3NpdHRpbiBvbiB0aGUgZG9jaycudHJ1bmNhdGUoMTApICAgICAgICAgICAtPiAnc2l0dGluIG9uIC4uLicKICAgICAqICAgJ3NpdHRpbiBvbiB0aGUgZG9jaycudHJ1bmNhdGUoMTAsICdsZWZ0JykgICAtPiAnLi4ubiB0aGUgZG9jaycKICAgICAqICAgJ3NpdHRpbiBvbiB0aGUgZG9jaycudHJ1bmNhdGUoMTAsICdtaWRkbGUnKSAtPiAnc2l0dGkuLi4gZG9jaycKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2Zyb21dCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2VsbGlwc2lzXQogICAgICoKICAgICAqKiovCiAgICAndHJ1bmNhdGUnOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgZnJvbSwgZWxsaXBzaXMpIHsKICAgICAgcmV0dXJuIHRydW5jYXRlU3RyaW5nKHN0ciwgbGVuZ3RoLCBmcm9tLCBlbGxpcHNpcyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgdHJ1bmNhdGVPbldvcmQobGVuZ3RoLCBbZnJvbV0gPSAncmlnaHQnLCBbZWxsaXBzaXNdID0gJy4uLicpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBUcnVuY2F0ZXMgYSBzdHJpbmcgd2l0aG91dCBzcGxpdHRpbmcgdXAgd29yZHMuCiAgICAgKiBAZXh0cmEgW2Zyb21dIGNhbiBiZSBgJ3JpZ2h0J2AsIGAnbGVmdCdgLCBvciBgJ21pZGRsZSdgLiBJZiB0aGUgc3RyaW5nIGlzCiAgICAgKiAgICAgICAgc2hvcnRlciB0aGFuIGBsZW5ndGhgLCBbZWxsaXBzaXNdIHdpbGwgbm90IGJlIGFkZGVkLiBBICJ3b3JkIiBpcwogICAgICogICAgICAgIGRlZmluZWQgYXMgYW55IHNlcXVlbmNlIG9mIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdoZXJlIHdlIGdvJy50cnVuY2F0ZU9uV29yZCg1KSAgICAgICAgIC0+ICdoZXJlLi4uJwogICAgICogICAnaGVyZSB3ZSBnbycudHJ1bmNhdGVPbldvcmQoNSwgJ2xlZnQnKSAtPiAnLi4ud2UgZ28nCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aAogICAgICogQHBhcmFtIHtzdHJpbmd9IFtmcm9tXQogICAgICogQHBhcmFtIHtzdHJpbmd9IFtlbGxpcHNpc10KICAgICAqCiAgICAgKioqLwogICAgJ3RydW5jYXRlT25Xb3JkJzogZnVuY3Rpb24oc3RyLCBsZW5ndGgsIGZyb20sIGVsbGlwc2lzKSB7CiAgICAgIHJldHVybiB0cnVuY2F0ZVN0cmluZyhzdHIsIGxlbmd0aCwgZnJvbSwgZWxsaXBzaXMsIHRydWUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHBhZChudW0sIFtwYWRkaW5nXSA9ICcgJykKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFBhZHMgdGhlIHN0cmluZyBvdXQgd2l0aCBbcGFkZGluZ10gdG8gYmUgZXhhY3RseSBgbnVtYCBjaGFyYWN0ZXJzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnd2FzYWJpJy5wYWQoOCkgICAgICAtPiAnIHdhc2FiaSAnCiAgICAgKiAgICd3YXNhYmknLnBhZCg4LCAnLScpIC0+ICctd2FzYWJpLScKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbnVtCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3BhZGRpbmddCiAgICAgKgogICAgICoqKi8KICAgICdwYWQnOiBmdW5jdGlvbihzdHIsIG51bSwgcGFkZGluZykgewogICAgICB2YXIgaGFsZiwgZnJvbnQsIGJhY2s7CiAgICAgIG51bSAgID0gY29lcmNlUG9zaXRpdmVJbnRlZ2VyKG51bSk7CiAgICAgIGhhbGYgID0gbWF4KDAsIG51bSAtIHN0ci5sZW5ndGgpIC8gMjsKICAgICAgZnJvbnQgPSBmbG9vcihoYWxmKTsKICAgICAgYmFjayAgPSBjZWlsKGhhbGYpOwogICAgICByZXR1cm4gcGFkU3RyaW5nKGZyb250LCBwYWRkaW5nKSArIHN0ciArIHBhZFN0cmluZyhiYWNrLCBwYWRkaW5nKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBwYWRMZWZ0KG51bSwgW3BhZGRpbmddID0gJyAnKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUGFkcyB0aGUgc3RyaW5nIG91dCBmcm9tIHRoZSBsZWZ0IHdpdGggW3BhZGRpbmddIHRvIGJlIGV4YWN0bHkKICAgICAqICAgICAgICBgbnVtYCBjaGFyYWN0ZXJzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnd2FzYWJpJy5wYWRMZWZ0KDgpICAgICAgLT4gJyAgd2FzYWJpJwogICAgICogICAnd2FzYWJpJy5wYWRMZWZ0KDgsICctJykgLT4gJy0td2FzYWJpJwogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbcGFkZGluZ10KICAgICAqCiAgICAgKioqLwogICAgJ3BhZExlZnQnOiBmdW5jdGlvbihzdHIsIG51bSwgcGFkZGluZykgewogICAgICBudW0gPSBjb2VyY2VQb3NpdGl2ZUludGVnZXIobnVtKTsKICAgICAgcmV0dXJuIHBhZFN0cmluZyhtYXgoMCwgbnVtIC0gc3RyLmxlbmd0aCksIHBhZGRpbmcpICsgc3RyOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHBhZFJpZ2h0KG51bSwgW3BhZGRpbmddID0gJyAnKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUGFkcyB0aGUgc3RyaW5nIG91dCBmcm9tIHRoZSByaWdodCB3aXRoIFtwYWRkaW5nXSB0byBiZSBleGFjdGx5CiAgICAgKiAgICAgICAgYG51bWAgY2hhcmFjdGVycy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ3dhc2FiaScucGFkUmlnaHQoOCkgICAgICAtPiAnd2FzYWJpICAnCiAgICAgKiAgICd3YXNhYmknLnBhZFJpZ2h0KDgsICctJykgLT4gJ3dhc2FiaS0tJwogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbcGFkZGluZ10KICAgICAqCiAgICAgKioqLwogICAgJ3BhZFJpZ2h0JzogZnVuY3Rpb24oc3RyLCBudW0sIHBhZGRpbmcpIHsKICAgICAgbnVtID0gY29lcmNlUG9zaXRpdmVJbnRlZ2VyKG51bSk7CiAgICAgIHJldHVybiBzdHIgKyBwYWRTdHJpbmcobWF4KDAsIG51bSAtIHN0ci5sZW5ndGgpLCBwYWRkaW5nKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBmaXJzdChbbl0gPSAxKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0aGUgZmlyc3QgW25dIGNoYXJhY3RlcnMgb2YgdGhlIHN0cmluZy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJ2x1Y2t5IGNoYXJtcycuZmlyc3QoKSAgLT4gJ2wnCiAgICAgKiAgICdsdWNreSBjaGFybXMnLmZpcnN0KDMpIC0+ICdsdWMnCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtuXQogICAgICoKICAgICAqKiovCiAgICAnZmlyc3QnOiBmdW5jdGlvbihzdHIsIG51bSkgewogICAgICBpZiAoaXNVbmRlZmluZWQobnVtKSkgbnVtID0gMTsKICAgICAgcmV0dXJuIHN0ci5zdWJzdHIoMCwgbnVtKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBsYXN0KFtuXSA9IDEpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBsYXN0IFtuXSBjaGFyYWN0ZXJzIG9mIHRoZSBzdHJpbmcuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdsdWNreSBjaGFybXMnLmxhc3QoKSAgLT4gJ3MnCiAgICAgKiAgICdsdWNreSBjaGFybXMnLmxhc3QoMykgLT4gJ3JtcycKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW25dCiAgICAgKgogICAgICoqKi8KICAgICdsYXN0JzogZnVuY3Rpb24oc3RyLCBudW0pIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKG51bSkpIG51bSA9IDE7CiAgICAgIHZhciBzdGFydCA9IHN0ci5sZW5ndGggLSBudW0gPCAwID8gMCA6IHN0ci5sZW5ndGggLSBudW07CiAgICAgIHJldHVybiBzdHIuc3Vic3RyKHN0YXJ0KTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCB0b051bWJlcihbYmFzZV0gPSAxMCkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IENvbnZlcnRzIHRoZSBzdHJpbmcgaW50byBhIG51bWJlci4KICAgICAqIEBleHRyYSBBbnkgdmFsdWUgd2l0aCBhICIuIiBmaWxsIGJlIGNvbnZlcnRlZCB0byBhIGZsb2F0aW5nIHBvaW50IHZhbHVlLAogICAgICogICAgICAgIG90aGVyd2lzZSBhbiBpbnRlZ2VyLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnMTUzJy50b051bWJlcigpICAgIC0+IDE1MwogICAgICogICAnMTIsMDAwJy50b051bWJlcigpIC0+IDEyMDAwCiAgICAgKiAgICcxMHB4Jy50b051bWJlcigpICAgLT4gMTAKICAgICAqICAgJ2ZmJy50b051bWJlcigxNikgICAtPiAyNTUKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Jhc2VdCiAgICAgKgogICAgICoqKi8KICAgICd0b051bWJlcic6IGZ1bmN0aW9uKHN0ciwgYmFzZSkgewogICAgICByZXR1cm4gc3RyaW5nVG9OdW1iZXIoc3RyLCBiYXNlKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBjYXBpdGFsaXplKFtsb3dlcl0gPSBmYWxzZSwgW2FsbF0gPSBmYWxzZSkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IENhcGl0YWxpemVzIHRoZSBmaXJzdCBjaGFyYWN0ZXIgb2YgdGhlIHN0cmluZy4KICAgICAqIEBleHRyYSBJZiBbbG93ZXJdIGlzIHRydWUsIHRoZSByZW1haW5kZXIgb2YgdGhlIHN0cmluZyB3aWxsIGJlIGRvd25jYXNlZC4KICAgICAqICAgICAgICBJZiBbYWxsXSBpcyB0cnVlLCBhbGwgd29yZHMgaW4gdGhlIHN0cmluZyB3aWxsIGJlIGNhcGl0YWxpemVkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAnaGVsbG8nLmNhcGl0YWxpemUoKSAgICAgICAgICAgLT4gJ0hlbGxvJwogICAgICogICAnSEVMTE8nLmNhcGl0YWxpemUodHJ1ZSkgICAgICAgLT4gJ0hlbGxvJwogICAgICogICAnaGVsbG8ga2l0dHknLmNhcGl0YWxpemUoKSAgICAgLT4gJ0hlbGxvIGtpdHR5JwogICAgICogICAnaEVsbE8ga0l0VHknLmNhcGl0YWxpemUodHJ1ZSwgdHJ1ZSkgLT4gJ0hlbGxvIEtpdHR5JwogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvd2VyXQogICAgICogQHBhcmFtIHtib29sZWFufSBbYWxsXQogICAgICoKICAgICAqKiovCiAgICAnY2FwaXRhbGl6ZSc6IGZ1bmN0aW9uKHN0ciwgbG93ZXIsIGFsbCkgewogICAgICByZXR1cm4gc3RyaW5nQ2FwaXRhbGl6ZShzdHIsIGxvd2VyLCBhbGwpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHRyaW1MZWZ0KCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJlbW92ZXMgbGVhZGluZyB3aGl0ZXNwYWNlIGZyb20gdGhlIHN0cmluZy4KICAgICAqIEBleHRyYSBXaGl0ZXNwYWNlIGlzIGRlZmluZWQgYXMgbGluZSBicmVha3MsIHRhYnMsIGFuZCBhbnkgY2hhcmFjdGVyIGluIHRoZQogICAgICogICAgICAgICJTcGFjZSwgU2VwYXJhdG9yIiBVbmljb2RlIGNhdGVnb3J5LCBjb25mb3JtaW5nIHRvIHRoZSB0aGUgRVM1IGB0cmltYAogICAgICogICAgICAgIHNwZWMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICcgICB3YXNhYmkgICAnLnRyaW1MZWZ0KCkgIC0+ICd3YXNhYmkgICAnCiAgICAgKgogICAgICoqKi8KICAgICd0cmltTGVmdCc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gc3RyLnJlcGxhY2UoTEVGVF9UUklNX1JFRywgJycpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHRyaW1SaWdodCgpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZW1vdmVzIHRyYWlsaW5nIHdoaXRlc3BhY2UgZnJvbSB0aGUgc3RyaW5nLgogICAgICogQGV4dHJhIFdoaXRlc3BhY2UgaXMgZGVmaW5lZCBhcyBsaW5lIGJyZWFrcywgdGFicywgYW5kIGFueSBjaGFyYWN0ZXIgaW4gdGhlCiAgICAgKiAgICAgICAgIlNwYWNlLCBTZXBhcmF0b3IiIFVuaWNvZGUgY2F0ZWdvcnksIGNvbmZvcm1pbmcgdG8gdGhlIHRoZSBFUzUgYHRyaW1gCiAgICAgKiAgICAgICAgc3BlYy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJyAgIHdhc2FiaSAgICcudHJpbVJpZ2h0KCkgLT4gJyAgIHdhc2FiaScKICAgICAqCiAgICAgKioqLwogICAgJ3RyaW1SaWdodCc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gc3RyLnJlcGxhY2UoUklHSFRfVFJJTV9SRUcsICcnKTsKICAgIH0KCiAgfSk7CgogIGRlZmluZUluc3RhbmNlV2l0aEFyZ3VtZW50cyhzdWdhclN0cmluZywgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgcmVwbGFjZUFsbChmLCBbc3RyMV0sIFtzdHIyXSwgLi4uKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc2hvcnQgUmVwbGFjZXMgYWxsIG9jY3VyZW5jZXMgb2YgYGZgIHdpdGggYXJndW1lbnRzIHBhc3NlZC4KICAgICAqIEBleHRyYSBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCB0byBiZSBhIHF1aWNrIHdheSB0byBwZXJmb3JtIG11bHRpcGxlIHN0cmluZwogICAgICogICAgICAgIHJlcGxhY2VtZW50cyBxdWlja2x5IHdoZW4gdGhlIHJlcGxhY2VtZW50IHRva2VuIGRpZmZlcnMgZGVwZW5kaW5nIG9uCiAgICAgKiAgICAgICAgcG9zaXRpb24uIGBmYCBjYW4gYmUgZWl0aGVyIGEgY2FzZS1zZW5zaXRpdmUgc3RyaW5nIG9yIGEgcmVnZXguCiAgICAgKiAgICAgICAgSW4gZWl0aGVyIGNhc2UgYWxsIG1hdGNoZXMgd2lsbCBiZSByZXBsYWNlZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgJy14IC15IC16Jy5yZXBsYWNlQWxsKCctJywgMSwgMiwgMykgICAgICAgICAgICAgICAtPiAnMXggMnkgM3onCiAgICAgKiAgICdvbmUgYW5kIHR3bycucmVwbGFjZUFsbCgvb25lfHR3by8sICcxc3QnLCAnMm5kJykgLT4gJzFzdCBhbmQgMm5kJwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfFJlZ0V4cH0gZgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHIxXQogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHIyXQogICAgICoKICAgICAqKiovCiAgICAncmVwbGFjZUFsbCc6IGZ1bmN0aW9uKHN0ciwgZiwgYXJncykgewogICAgICByZXR1cm4gc3RyaW5nUmVwbGFjZUFsbChzdHIsIGYsIGFyZ3MpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGZvcm1hdChvYmoxLCBbb2JqMl0sIC4uLikKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJlcGxhY2VzIGB7fWAgdG9rZW5zIGluIHRoZSBzdHJpbmcgd2l0aCBhcmd1bWVudHMgb3IgcHJvcGVydGllcy4KICAgICAqIEBleHRyYSBUb2tlbnMgc3VwcG9ydCBgZGVlcCBwcm9wZXJ0aWVzYC4gSWYgYSBzaW5nbGUgb2JqZWN0IGlzIHBhc3NlZCwgaXRzCiAgICAgKiAgICAgICAgcHJvcGVydGllcyBjYW4gYmUgYWNjZXNzZWQgYnkga2V5d29yZHMgc3VjaCBhcyBge25hbWV9YC4gSWYgbXVsdGlwbGUKICAgICAqICAgICAgICBvYmplY3RzIG9yIGEgbm9uLW9iamVjdCBhcmUgcGFzc2VkLCB0aGV5IGNhbiBiZSBhY2Nlc3NlZCBieSB0aGUKICAgICAqICAgICAgICBhcmd1bWVudCBwb3NpdGlvbiBsaWtlIGB7MH1gLiBMaXRlcmFsIGJyYWNlcyBpbiB0aGUgc3RyaW5nIGNhbiBiZQogICAgICogICAgICAgIGVzY2FwZWQgYnkgcmVwZWF0aW5nIHRoZW0uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICdXZWxjb21lLCB7bmFtZX0uJy5mb3JtYXQoeyBuYW1lOiAnQmlsbCcgfSkgLT4gJ1dlbGNvbWUsIEJpbGwuJwogICAgICogICAnWW91IGFyZSB7MH0geWVhcnMgb2xkIHRvZGF5LicuZm9ybWF0KDUpICAgIC0+ICdZb3UgYXJlIDUgeWVhcnMgb2xkIHRvZGF5LicKICAgICAqICAgJ3swLm5hbWV9IGFuZCB7MS5uYW1lfScuZm9ybWF0KHVzZXJzKSAgICAgICAtPiBsb2dzIGZpcnN0IHR3byB1c2VycycgbmFtZXMKICAgICAqICAgJyR7Y3VycmVuY2llcy51c2QuYmFsYW5jZX0nLmZvcm1hdChIYXJyeSkgICAtPiAiJDUwMCIKICAgICAqICAgJ3t7SGVsbG99fScuZm9ybWF0KCdIZWxsbycpICAgICAgICAgICAgICAgICAtPiAie0hlbGxvfSIKICAgICAqCiAgICAgKiBAcGFyYW0ge2FueX0gW29iajFdCiAgICAgKiBAcGFyYW0ge2FueX0gW29iajJdCiAgICAgKgogICAgICoqKi8KICAgICdmb3JtYXQnOiBmdW5jdGlvbihzdHIsIGFyZ3MpIHsKICAgICAgdmFyIGFyZzEgPSBhcmdzWzBdICYmIGFyZ3NbMF0udmFsdWVPZigpOwogICAgICAvLyBVbndyYXAgaWYgYSBzaW5nbGUgb2JqZWN0IGlzIHBhc3NlZCBpbi4KICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAxICYmIGlzT2JqZWN0VHlwZShhcmcxKSkgewogICAgICAgIGFyZ3MgPSBhcmcxOwogICAgICB9CiAgICAgIHJldHVybiBzdHJpbmdGb3JtYXRNYXRjaGVyKHN0ciwgYXJncyk7CiAgICB9CgogIH0pOwoKICBidWlsZEJhc2U2NCgpOwogIGJ1aWxkRW50aXRpZXMoKTsKCiAgLyoqKgogICAqIEBtb2R1bGUgQXJyYXkKICAgKiBAZGVzY3JpcHRpb24gQXJyYXkgbWFuaXB1bGF0aW9uIGFuZCB0cmF2ZXJzYWwsIGFscGhhbnVtZXJpYyBzb3J0aW5nIGFuZCBjb2xsYXRpb24uCiAgICoKICAgKioqLwoKICB2YXIgSEFMRl9XSURUSF9OSU5FID0gMHgzOTsKICB2YXIgRlVMTF9XSURUSF9OSU5FID0gMHhmZjE5OwoKICAvLyBVbmRlZmluZWQgYXJyYXkgZWxlbWVudHMgaW4gPCBJRTggd2lsbCBub3QgYmUgdmlzaXRlZCBieSBjb25jYXQKICAvLyBhbmQgc28gd2lsbCBub3QgYmUgY29waWVkLiBUaGlzIG1lYW5zIHRoYXQgbm9uLXNwYXJzZSBhcnJheXMgd2lsbAogIC8vIGJlY29tZSBzcGFyc2UsIHNvIGRldGVjdCBmb3IgdGhpcyBoZXJlLgogIHZhciBIQVNfQ09OQ0FUX0JVRyA9ICEoJzAnIGluIFtdLmNvbmNhdCh1bmRlZmluZWQpLmNvbmNhdCgpKTsKCiAgdmFyIEFSUkFZX09QVElPTlMgPSB7CiAgICAnc29ydElnbm9yZSc6ICAgICAgbnVsbCwKICAgICdzb3J0TmF0dXJhbCc6ICAgICB0cnVlLAogICAgJ3NvcnRJZ25vcmVDYXNlJzogIHRydWUsCiAgICAnc29ydE9yZGVyJzogICAgICAgZ2V0U29ydE9yZGVyKCksCiAgICAnc29ydENvbGxhdGUnOiAgICAgY29sbGF0ZVN0cmluZ3MsCiAgICAnc29ydEVxdWl2YWxlbnRzJzogZ2V0U29ydEVxdWl2YWxlbnRzKCkKICB9OwoKICAvKioqCiAgICogQG1ldGhvZCBnZXRPcHRpb24obmFtZSkKICAgKiBAcmV0dXJucyBNaXhlZAogICAqIEBhY2Nlc3NvcgogICAqIEBzaG9ydCBHZXRzIGFuIG9wdGlvbiB1c2VkIGludGVyYWxseSBieSBBcnJheS4KICAgKiBAZXh0cmEgT3B0aW9ucyBsaXN0ZWQgYmVsb3cuIEN1cnJlbnQgb3B0aW9ucyBhcmUgZm9yIHNvcnRpbmcgc3RyaW5ncyB3aXRoCiAgICogICAgICAgIGBzb3J0QnlgLgogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgU3VnYXIuQXJyYXkuZ2V0T3B0aW9uKCdzb3J0TmF0dXJhbCcpCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAqCiAgICoqKgogICAqIEBtZXRob2Qgc2V0T3B0aW9uKG5hbWUsIHZhbHVlKQogICAqIEBhY2Nlc3NvcgogICAqIEBzaG9ydCBTZXRzIGFuIG9wdGlvbiB1c2VkIGludGVyYWxseSBieSBBcnJheS4KICAgKiBAZXh0cmEgT3B0aW9ucyBsaXN0ZWQgYmVsb3cuIEN1cnJlbnQgb3B0aW9ucyBhcmUgZm9yIHNvcnRpbmcgc3RyaW5ncyB3aXRoCiAgICogICAgICAgIGBzb3J0QnlgLiBJZiBgdmFsdWVgIGlzIGBudWxsYCwgdGhlIGRlZmF1bHQgdmFsdWUgd2lsbCBiZSByZXN0b3JlZC4KICAgKgogICAqIEBvcHRpb25zCiAgICoKICAgKiAgIHNvcnRJZ25vcmUgICAgICAgIEEgcmVnZXggdG8gaWdub3JlIHdoZW4gc29ydGluZy4gQW4gZXhhbXBsZSB1c2FnZSBvZiB0aGlzCiAgICogICAgICAgICAgICAgICAgICAgICBvcHRpb24gd291bGQgYmUgdG8gaWdub3JlIG51bWJlcnMgaW4gYSBsaXN0IHRvIGluc3RlYWQKICAgKiAgICAgICAgICAgICAgICAgICAgIHNvcnQgYnkgdGhlIGZpcnN0IHRleHQgdGhhdCBhcHBlYXJzLiBEZWZhdWx0IGlzIGBudWxsYC4KICAgKgogICAqICAgc29ydElnbm9yZUNhc2UgICAgQSBib29sZWFuIHRoYXQgaWdub3JlcyBjYXNlIHdoZW4gc29ydGluZy4KICAgKiAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgaXMgYHRydWVgLgogICAqCiAgICogICBzb3J0TmF0dXJhbCAgICAgICBBIGJvb2xlYW4gdGhhdCB0dXJucyBvbiBuYXR1cmFsIHNvcnRpbmcuICJOYXR1cmFsIiBtZWFucwogICAqICAgICAgICAgICAgICAgICAgICAgdGhhdCBudW1lcmFscyBsaWtlICIxMCIgd2lsbCBiZSBzb3J0ZWQgYWZ0ZXIgIjkiIGluc3RlYWQKICAgKiAgICAgICAgICAgICAgICAgICAgIG9mIGFmdGVyICIxIi4gRGVmYXVsdCBpcyBgdHJ1ZWAuCiAgICoKICAgKiAgIHNvcnRPcmRlciAgICAgICAgIEEgc3RyaW5nIG9mIGNoYXJhY3RlcnMgdG8gdXNlIGFzIHRoZSBiYXNlIHNvcnQgb3JkZXIuIFRoZQogICAqICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCBpcyBhbiBvcmRlciBuYXR1cmFsIHRvIG1vc3QgbWFqb3Igd29ybGQgbGFuZ3VhZ2VzLgogICAqCiAgICogICBzb3J0RXF1aXZhbGVudHMgICBBIHRhYmxlIG9mIGVxdWl2YWxlbnQgY2hhcmFjdGVycyB1c2VkIHdoZW4gc29ydGluZy4gVGhlCiAgICogICAgICAgICAgICAgICAgICAgICBkZWZhdWx0IHByb2R1Y2VzIGEgbmF0dXJhbCBzb3J0IG9yZGVyIGZvciBtb3N0IHdvcmxkCiAgICogICAgICAgICAgICAgICAgICAgICBsYW5ndWFnZXMsIGhvd2V2ZXIgY2FuIGJlIG1vZGlmaWVkIGZvciBvdGhlcnMuIEZvcgogICAqICAgICAgICAgICAgICAgICAgICAgZXhhbXBsZSwgc2V0dGluZyAiw6QiIGFuZCAiw7YiIHRvIGBudWxsYCBpbiB0aGUgdGFibGUgd291bGQKICAgKiAgICAgICAgICAgICAgICAgICAgIHByb2R1Y2UgYSBTY2FuZGFuYXZpYW4gc29ydCBvcmRlci4gTm90ZSB0aGF0IHNldHRpbmcgdGhpcwogICAqICAgICAgICAgICAgICAgICAgICAgb3B0aW9uIHRvIGBudWxsYCB3aWxsIHJlc3RvcmUgdGhlIGRlZmF1bHQgdGFibGUsIGJ1dCBhbnkKICAgKiAgICAgICAgICAgICAgICAgICAgIG11dGF0aW9ucyBtYWRlIHRvIHRoYXQgdGFibGUgd2lsbCBwZXJzaXN0LgogICAqCiAgICogICBzb3J0Q29sbGF0ZSAgICAgICBUaGUgY29sbGF0aW9uIGZ1bmN0aW9uIHVzZWQgd2hlbiBzb3J0aW5nIHN0cmluZ3MuIFRoZQogICAqICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCBmdW5jdGlvbiBwcm9kdWNlcyBhIG5hdHVyYWwgc29ydCBvcmRlciB0aGF0IGNhbgogICAqICAgICAgICAgICAgICAgICAgICAgYmUgY3VzdG9taXplZCB3aXRoIHRoZSBvdGhlciAic29ydCIgb3B0aW9ucy4gT3ZlcnJpZGluZwogICAqICAgICAgICAgICAgICAgICAgICAgdGhlIGZ1bmN0aW9uIGRpcmVjdGx5IGhlcmUgd2lsbCBhbHNvIG92ZXJyaWRlIHRoZXNlCiAgICogICAgICAgICAgICAgICAgICAgICBvcHRpb25zLgogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgU3VnYXIuQXJyYXkuc2V0T3B0aW9uKCdzb3J0SWdub3JlJywgL15cZCtcLi8pCiAgICogICBTdWdhci5BcnJheS5zZXRPcHRpb24oJ3NvcnRJZ25vcmVDYXNlJywgZmFsc2UpCiAgICoKICAgKiBAc2lnbmF0dXJlIHNldE9wdGlvbihvcHRpb25zKQogICAqIEBwYXJhbSB7QXJyYXlPcHRpb25zfSBvcHRpb25zCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKiBAcGFyYW0ge2FueX0gdmFsdWUKICAgKiBAb3B0aW9uIHtSZWdFeHB9IFtzb3J0SWdub3JlXQogICAqIEBvcHRpb24ge2Jvb2xlYW59IFtzb3J0SWdub3JlQ2FzZV0KICAgKiBAb3B0aW9uIHtib29sZWFufSBbc29ydE5hdHVyYWxdCiAgICogQG9wdGlvbiB7c3RyaW5nfSBbc29ydE9yZGVyXQogICAqIEBvcHRpb24ge09iamVjdH0gW3NvcnRFcXVpdmFsZW50c10KICAgKiBAb3B0aW9uIHtGdW5jdGlvbn0gW3NvcnRDb2xsYXRlXQogICAqCiAgICoqKi8KICB2YXIgX2FycmF5T3B0aW9ucyA9IGRlZmluZU9wdGlvbnNBY2Nlc3NvcihzdWdhckFycmF5LCBBUlJBWV9PUFRJT05TKTsKCgogIGZ1bmN0aW9uIHNldEFycmF5Q2hhaW5hYmxlQ29uc3RydWN0b3IoKSB7CiAgICBzZXRDaGFpbmFibGVDb25zdHJ1Y3RvcihzdWdhckFycmF5LCBhcnJheUNyZWF0ZSk7CiAgfQoKICBmdW5jdGlvbiBpc0FycmF5T3JJbmhlcml0ZWQob2JqKSB7CiAgICByZXR1cm4gb2JqICYmIG9iai5jb25zdHJ1Y3RvciAmJiBpc0FycmF5KG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUpOwogIH0KCiAgZnVuY3Rpb24gYXJyYXlDcmVhdGUob2JqLCBjbG9uZSkgewogICAgdmFyIGFycjsKICAgIGlmIChpc0FycmF5T3JJbmhlcml0ZWQob2JqKSkgewogICAgICBhcnIgPSBjbG9uZSA/IGFycmF5Q2xvbmUob2JqKSA6IG9iajsKICAgIH0gZWxzZSBpZiAoaXNPYmplY3RUeXBlKG9iaikgfHwgaXNTdHJpbmcob2JqKSkgewogICAgICBhcnIgPSBBcnJheS5mcm9tKG9iaik7CiAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZChvYmopKSB7CiAgICAgIGFyciA9IFtvYmpdOwogICAgfQogICAgcmV0dXJuIGFyciB8fCBbXTsKICB9CgogIGZ1bmN0aW9uIGFycmF5Q2xvbmUoYXJyKSB7CiAgICB2YXIgY2xvbmUgPSBuZXcgQXJyYXkoYXJyLmxlbmd0aCk7CiAgICBmb3JFYWNoKGFyciwgZnVuY3Rpb24oZWwsIGkpIHsKICAgICAgY2xvbmVbaV0gPSBlbDsKICAgIH0pOwogICAgcmV0dXJuIGNsb25lOwogIH0KCiAgZnVuY3Rpb24gYXJyYXlDb25jYXQoYXJyMSwgYXJyMikgewogICAgaWYgKEhBU19DT05DQVRfQlVHKSB7CiAgICAgIHJldHVybiBhcnJheVNhZmVDb25jYXQoYXJyMSwgYXJyMik7CiAgICB9CiAgICByZXR1cm4gYXJyMS5jb25jYXQoYXJyMik7CiAgfQoKICAvLyBBdm9pZHMgaXNzdWVzIHdpdGggW3VuZGVmaW5lZF0gaW4gPCBJRTkKICBmdW5jdGlvbiBhcnJheVdyYXAob2JqKSB7CiAgICB2YXIgYXJyID0gW107CiAgICBhcnIucHVzaChvYmopOwogICAgcmV0dXJuIGFycjsKICB9CgogIC8vIEF2b2lkcyBpc3N1ZXMgd2l0aCBjb25jYXQgaW4gPCBJRTgKICBmdW5jdGlvbiBhcnJheVNhZmVDb25jYXQoYXJyLCBhcmcpIHsKICAgIHZhciByZXN1bHQgPSBhcnJheUNsb25lKGFyciksIGxlbiA9IHJlc3VsdC5sZW5ndGgsIGFycjI7CiAgICBhcnIyID0gaXNBcnJheShhcmcpID8gYXJnIDogW2FyZ107CiAgICByZXN1bHQubGVuZ3RoICs9IGFycjIubGVuZ3RoOwogICAgZm9yRWFjaChhcnIyLCBmdW5jdGlvbihlbCwgaSkgewogICAgICByZXN1bHRbbGVuICsgaV0gPSBlbDsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgoKICBmdW5jdGlvbiBhcnJheUFwcGVuZChhcnIsIGVsLCBpbmRleCkgewogICAgdmFyIHNwbGljZUFyZ3M7CiAgICBpbmRleCA9ICtpbmRleDsKICAgIGlmIChpc05hTihpbmRleCkpIHsKICAgICAgaW5kZXggPSBhcnIubGVuZ3RoOwogICAgfQogICAgc3BsaWNlQXJncyA9IFtpbmRleCwgMF07CiAgICBpZiAoaXNEZWZpbmVkKGVsKSkgewogICAgICBzcGxpY2VBcmdzID0gc3BsaWNlQXJncy5jb25jYXQoZWwpOwogICAgfQogICAgYXJyLnNwbGljZS5hcHBseShhcnIsIHNwbGljZUFyZ3MpOwogICAgcmV0dXJuIGFycjsKICB9CgogIGZ1bmN0aW9uIGFycmF5UmVtb3ZlKGFyciwgZikgewogICAgdmFyIG1hdGNoZXIgPSBnZXRNYXRjaGVyKGYpLCBpID0gMDsKICAgIHdoaWxlKGkgPCBhcnIubGVuZ3RoKSB7CiAgICAgIGlmIChtYXRjaGVyKGFycltpXSwgaSwgYXJyKSkgewogICAgICAgIGFyci5zcGxpY2UoaSwgMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSsrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYXJyOwogIH0KCiAgZnVuY3Rpb24gYXJyYXlFeGNsdWRlKGFyciwgZikgewogICAgdmFyIHJlc3VsdCA9IFtdLCBtYXRjaGVyID0gZ2V0TWF0Y2hlcihmKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICghbWF0Y2hlcihhcnJbaV0sIGksIGFycikpIHsKICAgICAgICByZXN1bHQucHVzaChhcnJbaV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZnVuY3Rpb24gYXJyYXlVbmlxdWUoYXJyLCBtYXApIHsKICAgIHZhciByZXN1bHQgPSBbXSwgb2JqID0ge30sIHJlZnMgPSBbXTsKICAgIGZvckVhY2goYXJyLCBmdW5jdGlvbihlbCwgaSkgewogICAgICB2YXIgdHJhbnNmb3JtZWQgPSBtYXAgPyBtYXBXaXRoU2hvcnRjdXRzKGVsLCBtYXAsIGFyciwgW2VsLCBpLCBhcnJdKSA6IGVsOwogICAgICB2YXIga2V5ID0gc2VyaWFsaXplSW50ZXJuYWwodHJhbnNmb3JtZWQsIHJlZnMpOwogICAgICBpZiAoIWhhc093bihvYmosIGtleSkpIHsKICAgICAgICByZXN1bHQucHVzaChlbCk7CiAgICAgICAgb2JqW2tleV0gPSB0cnVlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBhcnJheUZsYXR0ZW4oYXJyLCBsZXZlbCwgY3VycmVudCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgbGV2ZWwgPSBsZXZlbCB8fCBJbmZpbml0eTsKICAgIGN1cnJlbnQgPSBjdXJyZW50IHx8IDA7CiAgICBmb3JFYWNoKGFyciwgZnVuY3Rpb24oZWwpIHsKICAgICAgaWYgKGlzQXJyYXkoZWwpICYmIGN1cnJlbnQgPCBsZXZlbCkgewogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoYXJyYXlGbGF0dGVuKGVsLCBsZXZlbCwgY3VycmVudCArIDEpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQucHVzaChlbCk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIGFycmF5Q29tcGFjdChhcnIsIGFsbCkgewogICAgcmV0dXJuIGZpbHRlcihhcnIsIGZ1bmN0aW9uKGVsKSB7CiAgICAgIHJldHVybiBlbCB8fCAoIWFsbCAmJiBlbCAhPSBudWxsICYmIGVsLnZhbHVlT2YoKSA9PT0gZWwudmFsdWVPZigpKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gYXJyYXlTaHVmZmxlKGFycikgewogICAgYXJyID0gYXJyYXlDbG9uZShhcnIpOwogICAgdmFyIGkgPSBhcnIubGVuZ3RoLCBqLCB4OwogICAgd2hpbGUoaSkgewogICAgICBqID0gKE1hdGgucmFuZG9tKCkgKiBpKSB8IDA7CiAgICAgIHggPSBhcnJbLS1pXTsKICAgICAgYXJyW2ldID0gYXJyW2pdOwogICAgICBhcnJbal0gPSB4OwogICAgfQogICAgcmV0dXJuIGFycjsKICB9CgogIGZ1bmN0aW9uIGFycmF5R3JvdXBCeShhcnIsIG1hcCwgZm4pIHsKICAgIHZhciByZXN1bHQgPSB7fSwga2V5OwogICAgZm9yRWFjaChhcnIsIGZ1bmN0aW9uKGVsLCBpKSB7CiAgICAgIGtleSA9IG1hcFdpdGhTaG9ydGN1dHMoZWwsIG1hcCwgYXJyLCBbZWwsIGksIGFycl0pOwogICAgICBpZiAoIWhhc093bihyZXN1bHQsIGtleSkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IFtdOwogICAgICB9CiAgICAgIHJlc3VsdFtrZXldLnB1c2goZWwpOwogICAgfSk7CiAgICBpZiAoZm4pIHsKICAgICAgZm9yRWFjaFByb3BlcnR5KHJlc3VsdCwgZm4pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIGFycmF5SW50ZXJzZWN0T3JTdWJ0cmFjdChhcnIxLCBhcnIyLCBzdWJ0cmFjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdLCBvYmogPSB7fSwgcmVmcyA9IFtdOwogICAgaWYgKCFpc0FycmF5KGFycjIpKSB7CiAgICAgIGFycjIgPSBhcnJheVdyYXAoYXJyMik7CiAgICB9CiAgICBmb3JFYWNoKGFycjIsIGZ1bmN0aW9uKGVsKSB7CiAgICAgIG9ialtzZXJpYWxpemVJbnRlcm5hbChlbCwgcmVmcyldID0gdHJ1ZTsKICAgIH0pOwogICAgZm9yRWFjaChhcnIxLCBmdW5jdGlvbihlbCkgewogICAgICB2YXIga2V5ID0gc2VyaWFsaXplSW50ZXJuYWwoZWwsIHJlZnMpOwogICAgICBpZiAoaGFzT3duKG9iaiwga2V5KSAhPT0gc3VidHJhY3QpIHsKICAgICAgICBkZWxldGUgb2JqW2tleV07CiAgICAgICAgcmVzdWx0LnB1c2goZWwpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvLyBDb2xsYXRpb24gaGVscGVycwoKICBmdW5jdGlvbiBjb21wYXJlVmFsdWUoYVZhbCwgYlZhbCkgewogICAgdmFyIGNtcCwgaSwgY29sbGF0ZTsKICAgIGlmIChpc1N0cmluZyhhVmFsKSAmJiBpc1N0cmluZyhiVmFsKSkgewogICAgICBjb2xsYXRlID0gX2FycmF5T3B0aW9ucygnc29ydENvbGxhdGUnKTsKICAgICAgcmV0dXJuIGNvbGxhdGUoYVZhbCwgYlZhbCk7CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkoYVZhbCkgJiYgaXNBcnJheShiVmFsKSkgewogICAgICBpZiAoYVZhbC5sZW5ndGggPCBiVmFsLmxlbmd0aCkgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfSBlbHNlIGlmIChhVmFsLmxlbmd0aCA+IGJWYWwubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yKGkgPSAwOyBpIDwgYVZhbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgY21wID0gY29tcGFyZVZhbHVlKGFWYWxbaV0sIGJWYWxbaV0pOwogICAgICAgICAgaWYgKGNtcCAhPT0gMCkgewogICAgICAgICAgICByZXR1cm4gY21wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFWYWwgPCBiVmFsID8gLTEgOiBhVmFsID4gYlZhbCA/IDEgOiAwOwogIH0KCiAgZnVuY3Rpb24gY29kZUlzTnVtZXJhbChjb2RlKSB7CiAgICByZXR1cm4gKGNvZGUgPj0gSEFMRl9XSURUSF9aRVJPICYmIGNvZGUgPD0gSEFMRl9XSURUSF9OSU5FKSB8fAogICAgICAgICAgIChjb2RlID49IEZVTExfV0lEVEhfWkVSTyAmJiBjb2RlIDw9IEZVTExfV0lEVEhfTklORSk7CiAgfQoKICBmdW5jdGlvbiBjb2xsYXRlU3RyaW5ncyhhLCBiKSB7CiAgICB2YXIgYVZhbHVlLCBiVmFsdWUsIGFDaGFyLCBiQ2hhciwgYUVxdWl2LCBiRXF1aXYsIGluZGV4ID0gMCwgdGllYnJlYWtlciA9IDA7CgogICAgdmFyIHNvcnRPcmRlciAgICAgICA9IF9hcnJheU9wdGlvbnMoJ3NvcnRPcmRlcicpOwogICAgdmFyIHNvcnRJZ25vcmUgICAgICA9IF9hcnJheU9wdGlvbnMoJ3NvcnRJZ25vcmUnKTsKICAgIHZhciBzb3J0TmF0dXJhbCAgICAgPSBfYXJyYXlPcHRpb25zKCdzb3J0TmF0dXJhbCcpOwogICAgdmFyIHNvcnRJZ25vcmVDYXNlICA9IF9hcnJheU9wdGlvbnMoJ3NvcnRJZ25vcmVDYXNlJyk7CiAgICB2YXIgc29ydEVxdWl2YWxlbnRzID0gX2FycmF5T3B0aW9ucygnc29ydEVxdWl2YWxlbnRzJyk7CgogICAgYSA9IGdldENvbGxhdGlvblJlYWR5U3RyaW5nKGEsIHNvcnRJZ25vcmUsIHNvcnRJZ25vcmVDYXNlKTsKICAgIGIgPSBnZXRDb2xsYXRpb25SZWFkeVN0cmluZyhiLCBzb3J0SWdub3JlLCBzb3J0SWdub3JlQ2FzZSk7CgogICAgZG8gewoKICAgICAgYUNoYXIgID0gZ2V0Q29sbGF0aW9uQ2hhcmFjdGVyKGEsIGluZGV4LCBzb3J0RXF1aXZhbGVudHMpOwogICAgICBiQ2hhciAgPSBnZXRDb2xsYXRpb25DaGFyYWN0ZXIoYiwgaW5kZXgsIHNvcnRFcXVpdmFsZW50cyk7CiAgICAgIGFWYWx1ZSA9IGdldFNvcnRPcmRlckluZGV4KGFDaGFyLCBzb3J0T3JkZXIpOwogICAgICBiVmFsdWUgPSBnZXRTb3J0T3JkZXJJbmRleChiQ2hhciwgc29ydE9yZGVyKTsKCiAgICAgIGlmIChhVmFsdWUgPT09IC0xIHx8IGJWYWx1ZSA9PT0gLTEpIHsKICAgICAgICBhVmFsdWUgPSBhLmNoYXJDb2RlQXQoaW5kZXgpIHx8IG51bGw7CiAgICAgICAgYlZhbHVlID0gYi5jaGFyQ29kZUF0KGluZGV4KSB8fCBudWxsOwogICAgICAgIGlmIChzb3J0TmF0dXJhbCAmJiBjb2RlSXNOdW1lcmFsKGFWYWx1ZSkgJiYgY29kZUlzTnVtZXJhbChiVmFsdWUpKSB7CiAgICAgICAgICBhVmFsdWUgPSBzdHJpbmdUb051bWJlcihhLnNsaWNlKGluZGV4KSk7CiAgICAgICAgICBiVmFsdWUgPSBzdHJpbmdUb051bWJlcihiLnNsaWNlKGluZGV4KSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGFFcXVpdiA9IGFDaGFyICE9PSBhLmNoYXJBdChpbmRleCk7CiAgICAgICAgYkVxdWl2ID0gYkNoYXIgIT09IGIuY2hhckF0KGluZGV4KTsKICAgICAgICBpZiAoYUVxdWl2ICE9PSBiRXF1aXYgJiYgdGllYnJlYWtlciA9PT0gMCkgewogICAgICAgICAgdGllYnJlYWtlciA9IGFFcXVpdiAtIGJFcXVpdjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5kZXggKz0gMTsKICAgIH0gd2hpbGUoYVZhbHVlICE9IG51bGwgJiYgYlZhbHVlICE9IG51bGwgJiYgYVZhbHVlID09PSBiVmFsdWUpOwogICAgaWYgKGFWYWx1ZSA9PT0gYlZhbHVlKSByZXR1cm4gdGllYnJlYWtlcjsKICAgIHJldHVybiBhVmFsdWUgLSBiVmFsdWU7CiAgfQoKICBmdW5jdGlvbiBnZXRDb2xsYXRpb25SZWFkeVN0cmluZyhzdHIsIHNvcnRJZ25vcmUsIHNvcnRJZ25vcmVDYXNlKSB7CiAgICBpZiAoIWlzU3RyaW5nKHN0cikpIHN0ciA9IFN0cmluZyhzdHIpOwogICAgaWYgKHNvcnRJZ25vcmVDYXNlKSB7CiAgICAgIHN0ciA9IHN0ci50b0xvd2VyQ2FzZSgpOwogICAgfQogICAgaWYgKHNvcnRJZ25vcmUpIHsKICAgICAgc3RyID0gc3RyLnJlcGxhY2Uoc29ydElnbm9yZSwgJycpOwogICAgfQogICAgcmV0dXJuIHN0cjsKICB9CgogIGZ1bmN0aW9uIGdldENvbGxhdGlvbkNoYXJhY3RlcihzdHIsIGluZGV4LCBzb3J0RXF1aXZhbGVudHMpIHsKICAgIHZhciBjaHIgPSBzdHIuY2hhckF0KGluZGV4KTsKICAgIHJldHVybiBnZXRPd24oc29ydEVxdWl2YWxlbnRzLCBjaHIpIHx8IGNocjsKICB9CgogIGZ1bmN0aW9uIGdldFNvcnRPcmRlckluZGV4KGNociwgc29ydE9yZGVyKSB7CiAgICBpZiAoIWNocikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBzb3J0T3JkZXIuaW5kZXhPZihjaHIpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0U29ydE9yZGVyKCkgewogICAgdmFyIG9yZGVyID0gJ0HDgcOAw4LDg8SEQkPEhsSMw4dExI7DkEXDicOIxJrDisOLxJhGR8SeSMSxScONw4zEsMOOw49KS0zFgU1OxYPFh8ORT8OTw5LDlFBRUsWYU8WaxaDFnlTFpFXDmsOZxa7Dm8OcVldYWcOdWsW5xbvFvcOew4bFksOYw5XDhcOEw5YnOwogICAgcmV0dXJuIG1hcChvcmRlci5zcGxpdCgnJyksIGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gc3RyICsgc3RyLnRvTG93ZXJDYXNlKCk7CiAgICB9KS5qb2luKCcnKTsKICB9CgogIGZ1bmN0aW9uIGdldFNvcnRFcXVpdmFsZW50cygpIHsKICAgIHZhciBlcXVpdmFsZW50cyA9IHt9OwogICAgZm9yRWFjaChzcGFjZVNwbGl0KCdBw4HDgMOCw4PDhCBDw4cgRcOJw4jDisOLIEnDjcOMxLDDjsOPIE/Dk8OSw5TDlcOWIFPDnyBVw5rDmcObw5wnKSwgZnVuY3Rpb24oc2V0KSB7CiAgICAgIHZhciBmaXJzdCA9IHNldC5jaGFyQXQoMCk7CiAgICAgIGZvckVhY2goc2V0LnNsaWNlKDEpLnNwbGl0KCcnKSwgZnVuY3Rpb24oY2hyKSB7CiAgICAgICAgZXF1aXZhbGVudHNbY2hyXSA9IGZpcnN0OwogICAgICAgIGVxdWl2YWxlbnRzW2Noci50b0xvd2VyQ2FzZSgpXSA9IGZpcnN0LnRvTG93ZXJDYXNlKCk7CiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gZXF1aXZhbGVudHM7CiAgfQoKICBkZWZpbmVTdGF0aWMoc3VnYXJBcnJheSwgewoKICAgIC8qKioKICAgICAqCiAgICAgKiBAbWV0aG9kIGNyZWF0ZShbb2JqXSwgW2Nsb25lXSA9IGZhbHNlKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaG9ydCBDcmVhdGVzIGFuIGFycmF5IGZyb20gYW4gdW5rbm93biBvYmplY3QuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byBuYXRpdmUgYEFycmF5LmZyb21gIGJ1dCBpcyBmYXN0ZXIgd2hlbgogICAgICogICAgICAgIGBvYmpgIGlzIGFscmVhZHkgYW4gYXJyYXkuIFdoZW4gW2Nsb25lXSBpcyB0cnVlLCB0aGUgYXJyYXkgd2lsbCBiZQogICAgICogICAgICAgIHNoYWxsb3cgY2xvbmVkLiBBZGRpdGlvbmFsbHksIGl0IHdpbGwgbm90IGZhaWwgb24gYHVuZGVmaW5lZGAsCiAgICAgKiAgICAgICAgYG51bGxgLCBvciBudW1iZXJzLCBwcm9kdWNpbmcgYW4gZW1wdHkgYXJyYXkgaW4gdGhlIGNhc2Ugb2YKICAgICAqICAgICAgICBgdW5kZWZpbmVkYCBhbmQgd3JhcHBpbmcgYG9iamAgb3RoZXJ3aXNlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBBcnJheS5jcmVhdGUoKSAgICAgICAgICAtPiBbXQogICAgICogICBBcnJheS5jcmVhdGUoOCkgICAgICAgICAtPiBbOF0KICAgICAqICAgQXJyYXkuY3JlYXRlKCdhYmMnKSAgICAgLT4gWydhJywnYicsJ2MnXQogICAgICogICBBcnJheS5jcmVhdGUoWzEsMiwzXSkgICAtPiBbMSwgMiwgM10KICAgICAqICAgQXJyYXkuY3JlYXRlKHVuZGVmaW5lZCkgLT4gW10KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcnxBcnJheUxpa2U8VD59IFtvYmpdCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjbG9uZV0KICAgICAqCiAgICAgKioqLwogICAgJ2NyZWF0ZSc6IGZ1bmN0aW9uKG9iaiwgY2xvbmUpIHsKICAgICAgcmV0dXJuIGFycmF5Q3JlYXRlKG9iaiwgY2xvbmUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKgogICAgICogQG1ldGhvZCBjb25zdHJ1Y3QobiwgbWFwKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaG9ydCBDb25zdHJ1Y3RzIGFuIGFycmF5IG9mIGBuYCBsZW5ndGggZnJvbSB0aGUgdmFsdWVzIG9mIGBtYXBgLgogICAgICogQGV4dHJhIFRoaXMgZnVuY3Rpb24gaXMgZXNzZW50aWFsbHkgYSBzaG9ydGN1dCBmb3IgdXNpbmcgYEFycmF5LmZyb21gIHdpdGgKICAgICAqICAgICAgICBgbmV3IEFycmF5KG4pYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgaW5kZXhNYXBGbgogICAgICoKICAgICAqICAgaSAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIEFycmF5LmNvbnN0cnVjdCg0LCBmdW5jdGlvbihpKSB7CiAgICAgKiAgICAgcmV0dXJuIGkgKiBpOwogICAgICogICB9KTsgLT4gWzAsIDEsIDRdCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IG4KICAgICAqIEBwYXJhbSB7aW5kZXhNYXBGbn0gbWFwCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHthbnl9IGluZGV4TWFwRm4KICAgICAqCiAgICAgKioqLwogICAgJ2NvbnN0cnVjdCc6IGZ1bmN0aW9uKG4sIGZuKSB7CiAgICAgIG4gPSBjb2VyY2VQb3NpdGl2ZUludGVnZXIobik7CiAgICAgIHJldHVybiBBcnJheS5mcm9tKG5ldyBBcnJheShuKSwgZnVuY3Rpb24oZWwsIGkpIHsKICAgICAgICByZXR1cm4gZm4gJiYgZm4oaSk7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgZGVmaW5lSW5zdGFuY2Uoc3VnYXJBcnJheSwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaXNFbXB0eSgpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBhcnJheSBoYXMgYSBsZW5ndGggb2YgemVyby4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgW10uaXNFbXB0eSgpICAgIC0+IHRydWUKICAgICAqICAgWydhJ10uaXNFbXB0eSgpIC0+IGZhbHNlCiAgICAgKgogICAgICoqKi8KICAgICdpc0VtcHR5JzogZnVuY3Rpb24oYXJyKSB7CiAgICAgIHJldHVybiBhcnIubGVuZ3RoID09PSAwOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGlzRXF1YWwoYXJyKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgYXJyYXkgaXMgZXF1YWwgdG8gYGFycmAuCiAgICAgKiBAZXh0cmEgT2JqZWN0cyBpbiB0aGUgYXJyYXkgYXJlIGNvbnNpZGVyZWQgZXF1YWwgaWYgdGhleSBhcmUgbm90IG9ic2VyYWJseQogICAgICogICAgICAgIGRpc3Rpbmd1aXNoYWJsZS4gVGhpcyBtZXRob2QgaXMgYW4gaW5zdGFuY2UgYWxpYXMgZm9yCiAgICAgKiAgICAgICAgYE9iamVjdC5pc0VxdWFsKClgLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbJ2EnLCdiJ10uaXNFcXVhbChbJ2EnLCdiJ10pIC0+IHRydWUKICAgICAqICAgWydhJywnYiddLmlzRXF1YWwoWydhJywnYyddKSAtPiBmYWxzZQogICAgICogICBbe2E6J2EnfV0uaXNFcXVhbChbe2E6J2EnfV0pIC0+IHRydWUKICAgICAqICAgWzVdLmlzRXF1YWwoW09iamVjdCg1KV0pICAgICAtPiBmYWxzZQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycgogICAgICoKICAgICAqKiovCiAgICAnaXNFcXVhbCc6IGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgcmV0dXJuIGlzRXF1YWwoYSwgYik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgY2xvbmUoKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFsxLDIsM10uY2xvbmUoKSAtPiBbMSwyLDNdCiAgICAgKgogICAgICoqKi8KICAgICdjbG9uZSc6IGZ1bmN0aW9uKGFycikgewogICAgICByZXR1cm4gYXJyYXlDbG9uZShhcnIpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGF0KGluZGV4LCBbbG9vcF0gPSBmYWxzZSkKICAgICAqIEByZXR1cm5zIEFycmF5RWxlbWVudAogICAgICogQHNob3J0IEdldHMgdGhlIGVsZW1lbnQocykgYXQgYGluZGV4YC4KICAgICAqIEBleHRyYSBXaGVuIFtsb29wXSBpcyB0cnVlLCBvdmVyc2hvb3RpbmcgdGhlIGVuZCBvZiB0aGUgYXJyYXkgd2lsbCBiZWdpbgogICAgICogICAgICAgIGNvdW50aW5nIGZyb20gdGhlIG90aGVyIGVuZC4gYGluZGV4YCBtYXkgYmUgbmVnYXRpdmUuIElmIGBpbmRleGAgaXMKICAgICAqICAgICAgICBhbiBhcnJheSwgbXVsdGlwbGUgZWxlbWVudHMgd2lsbCBiZSByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzXS5hdCgwKSAgICAgICAtPiAxCiAgICAgKiAgIFsxLDIsM10uYXQoMikgICAgICAgLT4gMwogICAgICogICBbMSwyLDNdLmF0KDQpICAgICAgIC0+IHVuZGVmaW5lZAogICAgICogICBbMSwyLDNdLmF0KDQsIHRydWUpIC0+IDIKICAgICAqICAgWzEsMiwzXS5hdCgtMSkgICAgICAtPiAzCiAgICAgKiAgIFsxLDIsM10uYXQoWzAsIDFdKSAgLT4gWzEsIDJdCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ8bnVtYmVyW119IGluZGV4CiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wXQogICAgICoKICAgICAqKiovCiAgICAnYXQnOiBmdW5jdGlvbihhcnIsIGluZGV4LCBsb29wKSB7CiAgICAgIHJldHVybiBnZXRFbnRyaWVzRm9ySW5kZXhlcyhhcnIsIGluZGV4LCBsb29wKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBhZGQoaXRlbSwgW2luZGV4XSkKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgQWRkcyBgaXRlbWAgdG8gdGhlIGFycmF5IGFuZCByZXR1cm5zIHRoZSByZXN1bHQgYXMgYSBuZXcgYXJyYXkuCiAgICAgKiBAZXh0cmEgSWYgYGl0ZW1gIGlzIGFsc28gYW4gYXJyYXksIGl0IHdpbGwgYmUgY29uY2F0ZW5hdGVkIGluc3RlYWQgb2YKICAgICAqICAgICAgICBpbnNlcnRlZC4gW2luZGV4XSB3aWxsIGNvbnRyb2wgd2hlcmUgYGl0ZW1gIGlzIGFkZGVkLiBVc2UgYGFwcGVuZGAKICAgICAqICAgICAgICB0byBtb2RpZnkgdGhlIG9yaWdpbmFsIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDMsNF0uYWRkKDUpICAgICAgIC0+IFsxLDIsMyw0LDVdCiAgICAgKiAgIFsxLDIsMyw0XS5hZGQoOCwgMSkgICAgLT4gWzEsOCwyLDMsNF0KICAgICAqICAgWzEsMiwzLDRdLmFkZChbNSw2LDddKSAtPiBbMSwyLDMsNCw1LDYsN10KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5RWxlbWVudHxBcnJheX0gaXRlbQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtpbmRleF0KICAgICAqCiAgICAgKioqLwogICAgJ2FkZCc6IGZ1bmN0aW9uKGFyciwgaXRlbSwgaW5kZXgpIHsKICAgICAgcmV0dXJuIGFycmF5QXBwZW5kKGFycmF5Q2xvbmUoYXJyKSwgaXRlbSwgaW5kZXgpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHN1YnRyYWN0KGl0ZW0pCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IFN1YnRyYWN0cyBgaXRlbWAgZnJvbSB0aGUgYXJyYXkgYW5kIHJldHVybnMgdGhlIHJlc3VsdCBhcyBhIG5ldyBhcnJheS4KICAgICAqIEBleHRyYSBJZiBgaXRlbWAgaXMgYWxzbyBhbiBhcnJheSwgYWxsIGVsZW1lbnRzIGluIGl0IHdpbGwgYmUgcmVtb3ZlZC4gSW4KICAgICAqICAgICAgICBhZGRpdGlvbiB0byBwcmltaXRpdmVzLCB0aGlzIG1ldGhvZCB3aWxsIGFsc28gZGVlcC1jaGVjayBvYmplY3RzIGZvcgogICAgICogICAgICAgIGVxdWFsaXR5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwzLDVdLnN1YnRyYWN0KFs1LDcsOV0pICAgICAtPiBbMSwzXQogICAgICogICBbJ2EnLCdiJ10uc3VidHJhY3QoWydiJywnYyddKSAtPiBbJ2EnXQogICAgICogICBbMSwyLDNdLnN1YnRyYWN0KDIpICAgICAgICAgICAtPiBbMSwzXQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fEFycmF5fSBpdGVtCiAgICAgKgogICAgICoqKi8KICAgICdzdWJ0cmFjdCc6IGZ1bmN0aW9uKGFyciwgaXRlbSkgewogICAgICByZXR1cm4gYXJyYXlJbnRlcnNlY3RPclN1YnRyYWN0KGFyciwgaXRlbSwgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgYXBwZW5kKGl0ZW0sIFtpbmRleF0pCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IEFwcGVuZHMgYGl0ZW1gIHRvIHRoZSBhcnJheS4KICAgICAqIEBleHRyYSBJZiBgaXRlbWAgaXMgYWxzbyBhbiBhcnJheSwgaXQgd2lsbCBiZSBjb25jYXRlbmF0ZWQgaW5zdGVhZCBvZgogICAgICogICAgICAgIGluc2VydGVkLiBUaGlzIG1ldGhvZCBtb2RpZmllcyB0aGUgYXJyYXkhIFVzZSBgYWRkYCB0byBjcmVhdGUgYSBuZXcKICAgICAqICAgICAgICBhcnJheS4gQWRkaXRpb25hbGx5LCBgaW5zZXJ0YCBpcyBwcm92aWRlZCBhcyBhbiBhbGlhcyB0aGF0IHJlYWRzCiAgICAgKiAgICAgICAgYmV0dGVyIHdoZW4gdXNpbmcgYW4gaW5kZXguCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFsxLDIsMyw0XS5hcHBlbmQoNSkgICAgICAgLT4gWzEsMiwzLDQsNV0KICAgICAqICAgWzEsMiwzLDRdLmFwcGVuZChbNSw2LDddKSAtPiBbMSwyLDMsNCw1LDYsN10KICAgICAqICAgWzEsMiwzLDRdLmFwcGVuZCg4LCAxKSAgICAtPiBbMSw4LDIsMyw0XQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fEFycmF5fSBpdGVtCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgKICAgICAqCiAgICAgKioqLwogICAgJ2FwcGVuZCc6IGZ1bmN0aW9uKGFyciwgaXRlbSwgaW5kZXgpIHsKICAgICAgcmV0dXJuIGFycmF5QXBwZW5kKGFyciwgaXRlbSwgaW5kZXgpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJlbW92ZUF0KHN0YXJ0LCBbZW5kXSkKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgUmVtb3ZlcyBlbGVtZW50IGF0IGBzdGFydGAuIElmIFtlbmRdIGlzIHNwZWNpZmllZCwgcmVtb3ZlcyB0aGUgcmFuZ2UKICAgICAqICAgICAgICBiZXR3ZWVuIGBzdGFydGAgYW5kIFtlbmRdLiBUaGlzIG1ldGhvZCB3aWxsIG1vZGlmeSB0aGUgYXJyYXkhCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFsnYScsJ2InLCdjJ10ucmVtb3ZlQXQoMCkgLT4gWydiJywnYyddCiAgICAgKiAgIFsxLDIsMyw0XS5yZW1vdmVBdCgxLCAyKSAgLT4gWzEsIDRdCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0CiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2VuZF0KICAgICAqCiAgICAgKioqLwogICAgJ3JlbW92ZUF0JzogZnVuY3Rpb24oYXJyLCBzdGFydCwgZW5kKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZChzdGFydCkpIHJldHVybiBhcnI7CiAgICAgIGlmIChpc1VuZGVmaW5lZChlbmQpKSAgIGVuZCA9IHN0YXJ0OwogICAgICBhcnIuc3BsaWNlKHN0YXJ0LCBlbmQgLSBzdGFydCArIDEpOwogICAgICByZXR1cm4gYXJyOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHVuaXF1ZShbbWFwXSkKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgUmVtb3ZlcyBhbGwgZHVwbGljYXRlIGVsZW1lbnRzIGluIHRoZSBhcnJheS4KICAgICAqIEBleHRyYSBbbWFwXSBtYXkgYmUgYSBmdW5jdGlvbiByZXR1cm5pbmcgdGhlIHZhbHVlIHRvIGJlIHVuaXF1ZWQgb3IgYQogICAgICogICAgICAgIHN0cmluZyBhY3RpbmcgYXMgYSBzaG9ydGN1dC4gVGhpcyBpcyBtb3N0IGNvbW1vbmx5IHVzZWQgd2hlbiB5b3UKICAgICAqICAgICAgICBvbmx5IG5lZWQgdG8gY2hlY2sgYSBzaW5nbGUgZmllbGQgdGhhdCBjYW4gZW5zdXJlIHRoZSBvYmplY3QncwogICAgICogICAgICAgIHVuaXF1ZW5lc3MgKHN1Y2ggYXMgYW4gYGlkYCBmaWVsZCkuIElmIFttYXBdIGlzIG5vdCBwYXNzZWQsIHRoZW4KICAgICAqICAgICAgICBvYmplY3RzIHdpbGwgYmUgZGVlcCBjaGVja2VkIGZvciBlcXVhbGl0eS4gU3VwcG9ydHMKICAgICAqICAgICAgICBgZGVlcCBwcm9wZXJ0aWVzYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgbWFwRm4KICAgICAqCiAgICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBpICAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGFyciAgQSByZWZlcmVuY2UgdG8gdGhlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDIsM10udW5pcXVlKCkgICAgICAgICAgICAtPiBbMSwyLDNdCiAgICAgKiAgIFt7YTonYSd9LHthOidhJ31dLnVuaXF1ZSgpICAgIC0+IFt7YTonYSd9XQogICAgICoKICAgICAqICAgdXNlcnMudW5pcXVlKGZ1bmN0aW9uKHVzZXIpIHsKICAgICAqICAgICByZXR1cm4gdXNlci5pZDsKICAgICAqICAgfSk7IC0+IHVzZXJzIGFycmF5IHVuaXF1ZWQgYnkgaWQKICAgICAqCiAgICAgKiAgIHVzZXJzLnVuaXF1ZSgnaWQnKSAgICAgICAgICAgIC0+IHVzZXJzIGFycmF5IHVuaXF1ZWQgYnkgaWQKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xtYXBGbn0gbWFwCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXlFbGVtZW50fSBlbAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5fSBhcnIKICAgICAqIEBjYWxsYmFja1JldHVybnMge05ld0FycmF5RWxlbWVudH0gbWFwRm4KICAgICAqCiAgICAgKioqLwogICAgJ3VuaXF1ZSc6IGZ1bmN0aW9uKGFyciwgbWFwKSB7CiAgICAgIHJldHVybiBhcnJheVVuaXF1ZShhcnIsIG1hcCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZmxhdHRlbihbbGltaXRdID0gSW5maW5pdHkpCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IFJldHVybnMgYSBmbGF0dGVuZWQsIG9uZS1kaW1lbnNpb25hbCBjb3B5IG9mIHRoZSBhcnJheS4KICAgICAqIEBleHRyYSBZb3UgY2FuIG9wdGlvbmFsbHkgc3BlY2lmeSBhIFtsaW1pdF0sIHdoaWNoIHdpbGwgb25seSBmbGF0dGVuIHRvCiAgICAgKiAgICAgICAgdGhhdCBkZXB0aC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgW1sxXSwgMiwgWzNdXS5mbGF0dGVuKCkgLT4gWzEsMiwzXQogICAgICogICBbWzFdLFtdLDIsM10uZmxhdHRlbigpICAtPiBbMSwyLDNdCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtsaW1pdF0KICAgICAqCiAgICAgKioqLwogICAgJ2ZsYXR0ZW4nOiBmdW5jdGlvbihhcnIsIGxpbWl0KSB7CiAgICAgIHJldHVybiBhcnJheUZsYXR0ZW4oYXJyLCBsaW1pdCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZmlyc3QoW251bV0gPSAxKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBmaXJzdCBlbGVtZW50KHMpIGluIHRoZSBhcnJheS4KICAgICAqIEBleHRyYSBXaGVuIGBudW1gIGlzIHBhc3NlZCwgcmV0dXJucyB0aGUgZmlyc3QgYG51bWAgZWxlbWVudHMgaW4gdGhlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDNdLmZpcnN0KCkgIC0+IDEKICAgICAqICAgWzEsMiwzXS5maXJzdCgyKSAtPiBbMSwyXQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbnVtXQogICAgICoKICAgICAqKiovCiAgICAnZmlyc3QnOiBmdW5jdGlvbihhcnIsIG51bSkgewogICAgICBpZiAoaXNVbmRlZmluZWQobnVtKSkgcmV0dXJuIGFyclswXTsKICAgICAgaWYgKG51bSA8IDApIG51bSA9IDA7CiAgICAgIHJldHVybiBhcnIuc2xpY2UoMCwgbnVtKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBsYXN0KFtudW1dID0gMSkKICAgICAqIEByZXR1cm5zIE1peGVkCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0aGUgbGFzdCBlbGVtZW50KHMpIGluIHRoZSBhcnJheS4KICAgICAqIEBleHRyYSBXaGVuIGBudW1gIGlzIHBhc3NlZCwgcmV0dXJucyB0aGUgbGFzdCBgbnVtYCBlbGVtZW50cyBpbiB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFsxLDIsM10ubGFzdCgpICAtPiAzCiAgICAgKiAgIFsxLDIsM10ubGFzdCgyKSAtPiBbMiwzXQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbnVtXQogICAgICoKICAgICAqKiovCiAgICAnbGFzdCc6IGZ1bmN0aW9uKGFyciwgbnVtKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZChudW0pKSByZXR1cm4gYXJyW2Fyci5sZW5ndGggLSAxXTsKICAgICAgdmFyIHN0YXJ0ID0gYXJyLmxlbmd0aCAtIG51bSA8IDAgPyAwIDogYXJyLmxlbmd0aCAtIG51bTsKICAgICAgcmV0dXJuIGFyci5zbGljZShzdGFydCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZnJvbShpbmRleCkKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgUmV0dXJucyBhIHNsaWNlIG9mIHRoZSBhcnJheSBmcm9tIGBpbmRleGAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFsnYScsJ2InLCdjJ10uZnJvbSgxKSAtPiBbJ2InLCdjJ10KICAgICAqICAgWydhJywnYicsJ2MnXS5mcm9tKDIpIC0+IFsnYyddCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtpbmRleF0KICAgICAqCiAgICAgKioqLwogICAgJ2Zyb20nOiBmdW5jdGlvbihhcnIsIG51bSkgewogICAgICByZXR1cm4gYXJyLnNsaWNlKG51bSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgdG8oaW5kZXgpCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IFJldHVybnMgYSBzbGljZSBvZiB0aGUgYXJyYXkgdXAgdG8gYGluZGV4YC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWydhJywnYicsJ2MnXS50bygxKSAtPiBbJ2EnXQogICAgICogICBbJ2EnLCdiJywnYyddLnRvKDIpIC0+IFsnYScsJ2InXQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaW5kZXhdCiAgICAgKgogICAgICoqKi8KICAgICd0byc6IGZ1bmN0aW9uKGFyciwgbnVtKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZChudW0pKSBudW0gPSBhcnIubGVuZ3RoOwogICAgICByZXR1cm4gYXJyLnNsaWNlKDAsIG51bSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgY29tcGFjdChbYWxsXSA9IGZhbHNlKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBSZW1vdmVzIGFsbCBpbnN0YW5jZXMgb2YgYHVuZGVmaW5lZGAsIGBudWxsYCwgYW5kIGBOYU5gIGZyb20gdGhlIGFycmF5LgogICAgICogQGV4dHJhIElmIFthbGxdIGlzIGB0cnVlYCwgYWxsICJmYWxzeSIgZWxlbWVudHMgd2lsbCBiZSByZW1vdmVkLiBUaGlzCiAgICAgKiAgICAgICAgaW5jbHVkZXMgZW1wdHkgc3RyaW5ncywgYDBgLCBhbmQgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsbnVsbCwyLHVuZGVmaW5lZCwzXS5jb21wYWN0KCkgLT4gWzEsMiwzXQogICAgICogICBbMSwnJywyLGZhbHNlLDNdLmNvbXBhY3QoKSAgICAgICAtPiBbMSwnJywyLGZhbHNlLDNdCiAgICAgKiAgIFsxLCcnLDIsZmFsc2UsM10uY29tcGFjdCh0cnVlKSAgIC0+IFsxLDIsM10KICAgICAqICAgW251bGwsIFtudWxsLCAnYnllJ11dLmNvbXBhY3QoKSAgLT4gWydoaScsIFtudWxsLCAnYnllJ11dCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFufSBbYWxsXQogICAgICoKICAgICAqKiovCiAgICAnY29tcGFjdCc6IGZ1bmN0aW9uKGFyciwgYWxsKSB7CiAgICAgIHJldHVybiBhcnJheUNvbXBhY3QoYXJyLCBhbGwpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGdyb3VwQnkobWFwLCBbZm5dKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgR3JvdXBzIHRoZSBhcnJheSBieSBgbWFwYC4KICAgICAqIEBleHRyYSBXaWxsIHJldHVybiBhbiBvYmplY3Qgd2hvc2Uga2V5cyBhcmUgdGhlIG1hcHBlZCBmcm9tIGBtYXBgLCB3aGljaAogICAgICogICAgICAgIG1heSBiZSBhIG1hcHBpbmcgZnVuY3Rpb24sIG9yIGEgc3RyaW5nIGFjdGluZyBhcyBhIHNob3J0Y3V0LiBgbWFwYAogICAgICogICAgICAgIHN1cHBvcnRzIGBkZWVwIHByb3BlcnRpZXNgLiBPcHRpb25hbGx5IGNhbGxzIFtmbl0gZm9yIGVhY2ggZ3JvdXAuCiAgICAgKgogICAgICogQGNhbGxiYWNrIG1hcEZuCiAgICAgKgogICAgICogICBlbCAgIFRoZSBlbGVtZW50IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBhcnIgIEEgcmVmZXJlbmNlIHRvIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgZ3JvdXBGbgogICAgICoKICAgICAqICAgYXJyICBUaGUgY3VycmVudCBncm91cCBhcyBhbiBhcnJheS4KICAgICAqICAga2V5ICBUaGUgdW5pcXVlIGtleSBvZiB0aGUgY3VycmVudCBncm91cC4KICAgICAqICAgb2JqICBBIHJlZmVyZW5jZSB0byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbJ2EnLCdhYScsJ2FhYSddLmdyb3VwQnkoJ2xlbmd0aCcpIC0+IHsgMTogWydhJ10sIDI6IFsnYWEnXSwgMzogWydhYWEnXSB9CiAgICAgKgogICAgICogICB1c2Vycy5ncm91cEJ5KGZ1bmN0aW9uKG4pIHsKICAgICAqICAgICByZXR1cm4gbi5hZ2U7CiAgICAgKiAgIH0pOyAtPiB1c2VycyBhcnJheSBncm91cGVkIGJ5IGFnZQogICAgICoKICAgICAqICAgdXNlcnMuZ3JvdXBCeSgnYWdlJywgZnVuY3Rpb24oYWdlLCB1c2VycykgewogICAgICogICAgIC8vIGl0ZXJhdGVzIGVhY2ggZ3JvdXBpbmcKICAgICAqICAgfSk7CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8bWFwRm59IG1hcAogICAgICogQHBhcmFtIHtncm91cEZufSBmbgogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5RWxlbWVudH0gZWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtudW1iZXJ9IGkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheX0gYXJyCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7c3RyaW5nfSBrZXkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtPYmplY3R9IG9iagogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3QXJyYXlFbGVtZW50fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnZ3JvdXBCeSc6IGZ1bmN0aW9uKGFyciwgbWFwLCBmbikgewogICAgICByZXR1cm4gYXJyYXlHcm91cEJ5KGFyciwgbWFwLCBmbik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaW5Hcm91cHMobnVtLCBbcGFkZGluZ10pCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IEdyb3VwcyB0aGUgYXJyYXkgaW50byBgbnVtYCBhcnJheXMuCiAgICAgKiBAZXh0cmEgSWYgc3BlY2lmaWVkLCBbcGFkZGluZ10gd2lsbCBiZSBhZGRlZCB0byB0aGUgbGFzdCBhcnJheSB0byBiZSBvZgogICAgICogICAgICAgIGVxdWFsIGxlbmd0aC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzLDQsNSw2LDddLmluR3JvdXBzKDMpICAgIC0+IFtbMSwyLDNdLFs0LDUsNl0sWzddXQogICAgICogICBbMSwyLDMsNCw1LDYsN10uaW5Hcm91cHMoMywgMCkgLT4gW1sxLDIsM10sWzQsNSw2XSxbNywwLDBdXQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW0KICAgICAqIEBwYXJhbSB7YW55fSBbcGFkZGluZ10KICAgICAqCiAgICAgKioqLwogICAgJ2luR3JvdXBzJzogZnVuY3Rpb24oYXJyLCBudW0sIHBhZGRpbmcpIHsKICAgICAgdmFyIHBhZCA9IGlzRGVmaW5lZChwYWRkaW5nKTsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyBBcnJheShudW0pOwogICAgICB2YXIgZGl2aXNvciA9IGNlaWwoYXJyLmxlbmd0aCAvIG51bSk7CiAgICAgIHNpbXBsZVJlcGVhdChudW0sIGZ1bmN0aW9uKGkpIHsKICAgICAgICB2YXIgaW5kZXggPSBpICogZGl2aXNvcjsKICAgICAgICB2YXIgZ3JvdXAgPSBhcnIuc2xpY2UoaW5kZXgsIGluZGV4ICsgZGl2aXNvcik7CiAgICAgICAgaWYgKHBhZCAmJiBncm91cC5sZW5ndGggPCBkaXZpc29yKSB7CiAgICAgICAgICBzaW1wbGVSZXBlYXQoZGl2aXNvciAtIGdyb3VwLmxlbmd0aCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGdyb3VwLnB1c2gocGFkZGluZyk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0W2ldID0gZ3JvdXA7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGluR3JvdXBzT2YobnVtLCBbcGFkZGluZ10gPSBudWxsKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBHcm91cHMgdGhlIGFycmF5IGludG8gYXJyYXlzIG9mIGBudW1gIGVsZW1lbnRzIGVhY2guCiAgICAgKiBAZXh0cmEgW3BhZGRpbmddIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGxhc3QgYXJyYXkgdG8gYmUgb2YgZXF1YWwgbGVuZ3RoLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDMsNCw1LDYsN10uaW5Hcm91cHNPZig0KSAgICAtPiBbIFsxLDIsMyw0XSwgWzUsNiw3XSBdCiAgICAgKiAgIFsxLDIsMyw0LDUsNiw3XS5pbkdyb3Vwc09mKDQsIDApIC0+IFsgWzEsMiwzLDRdLCBbNSw2LDcsMF0gXQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW0KICAgICAqIEBwYXJhbSB7YW55fSBbcGFkZGluZ10KICAgICAqCiAgICAgKioqLwogICAgJ2luR3JvdXBzT2YnOiBmdW5jdGlvbihhcnIsIG51bSwgcGFkZGluZykgewogICAgICB2YXIgcmVzdWx0ID0gW10sIGxlbiA9IGFyci5sZW5ndGgsIGdyb3VwOwogICAgICBpZiAobGVuID09PSAwIHx8IG51bSA9PT0gMCkgcmV0dXJuIGFycjsKICAgICAgaWYgKGlzVW5kZWZpbmVkKG51bSkpIG51bSA9IDE7CiAgICAgIGlmIChpc1VuZGVmaW5lZChwYWRkaW5nKSkgcGFkZGluZyA9IG51bGw7CiAgICAgIHNpbXBsZVJlcGVhdChjZWlsKGxlbiAvIG51bSksIGZ1bmN0aW9uKGkpIHsKICAgICAgICBncm91cCA9IGFyci5zbGljZShudW0gKiBpLCBudW0gKiBpICsgbnVtKTsKICAgICAgICB3aGlsZShncm91cC5sZW5ndGggPCBudW0pIHsKICAgICAgICAgIGdyb3VwLnB1c2gocGFkZGluZyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKGdyb3VwKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2Qgc2h1ZmZsZSgpCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IFJldHVybnMgYSBjb3B5IG9mIHRoZSBhcnJheSB3aXRoIHRoZSBlbGVtZW50cyByYW5kb21pemVkLgogICAgICogQGV4dHJhIFVzZXMgRmlzaGVyLVlhdGVzIGFsZ29yaXRobS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzLDRdLnNodWZmbGUoKSAgLT4gWz8sPyw/LD9dCiAgICAgKgogICAgICoqKi8KICAgICdzaHVmZmxlJzogZnVuY3Rpb24oYXJyKSB7CiAgICAgIHJldHVybiBhcnJheVNodWZmbGUoYXJyKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBzYW1wbGUoW251bV0gPSAxLCBbcmVtb3ZlXSA9IGZhbHNlKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBzaG9ydCBSZXR1cm5zIGEgcmFuZG9tIGVsZW1lbnQgZnJvbSB0aGUgYXJyYXkuCiAgICAgKiBAZXh0cmEgSWYgW251bV0gaXMgcGFzc2VkLCB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBbbnVtXSBlbGVtZW50cy4gSWYKICAgICAqICAgICAgICBbcmVtb3ZlXSBpcyB0cnVlLCBzYW1wbGVkIGVsZW1lbnRzIHdpbGwgYWxzbyBiZSByZW1vdmVkIGZyb20gdGhlCiAgICAgKiAgICAgICAgYXJyYXkuIFtyZW1vdmVdIGNhbiBhbHNvIGJlIHBhc3NlZCBpbiBwbGFjZSBvZiBbbnVtXS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzLDQsNV0uc2FtcGxlKCkgIC0+IC8vIFJhbmRvbSBlbGVtZW50CiAgICAgKiAgIFsxLDIsMyw0LDVdLnNhbXBsZSgxKSAtPiAvLyBBcnJheSBvZiAxIHJhbmRvbSBlbGVtZW50CiAgICAgKiAgIFsxLDIsMyw0LDVdLnNhbXBsZSgzKSAtPiAvLyBBcnJheSBvZiAzIHJhbmRvbSBlbGVtZW50cwogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbnVtXQogICAgICogQHBhcmFtIHtib29sZWFufSBbcmVtb3ZlXQogICAgICoKICAgICAqKiovCiAgICAnc2FtcGxlJzogZnVuY3Rpb24oYXJyLCBhcmcxLCBhcmcyKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXSwgbnVtLCByZW1vdmUsIHNpbmdsZTsKICAgICAgaWYgKGlzQm9vbGVhbihhcmcxKSkgewogICAgICAgIHJlbW92ZSA9IGFyZzE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbnVtID0gYXJnMTsKICAgICAgICByZW1vdmUgPSBhcmcyOwogICAgICB9CiAgICAgIGlmIChpc1VuZGVmaW5lZChudW0pKSB7CiAgICAgICAgbnVtID0gMTsKICAgICAgICBzaW5nbGUgPSB0cnVlOwogICAgICB9CiAgICAgIGlmICghcmVtb3ZlKSB7CiAgICAgICAgYXJyID0gYXJyYXlDbG9uZShhcnIpOwogICAgICB9CiAgICAgIG51bSA9IG1pbihudW0sIGFyci5sZW5ndGgpOwogICAgICBmb3IgKHZhciBpID0gMCwgaW5kZXg7IGkgPCBudW07IGkrKykgewogICAgICAgIGluZGV4ID0gdHJ1bmMoTWF0aC5yYW5kb20oKSAqIGFyci5sZW5ndGgpOwogICAgICAgIHJlc3VsdC5wdXNoKGFycltpbmRleF0pOwogICAgICAgIGFyci5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICAgIHJldHVybiBzaW5nbGUgPyByZXN1bHRbMF0gOiByZXN1bHQ7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2Qgc29ydEJ5KFttYXBdLCBbZGVzY10gPSBmYWxzZSkKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgRW5oYW5jZWQgc29ydGluZyBmdW5jdGlvbiB0aGF0IHdpbGwgc29ydCB0aGUgYXJyYXkgYnkgYG1hcGAuCiAgICAgKiBAZXh0cmEgYG1hcGAgbWF5IGJlIGEgZnVuY3Rpb24sIGEgc3RyaW5nIGFjdGluZyBhcyBhIHNob3J0Y3V0LCBhbiBhcnJheQogICAgICogICAgICAgIChjb21wYXJpc29uIGJ5IG11bHRpcGxlIHZhbHVlcyksIG9yIGJsYW5rIChkaXJlY3QgY29tcGFyaXNvbiBvZgogICAgICogICAgICAgIGFycmF5IHZhbHVlcykuIGBtYXBgIHN1cHBvcnRzIGBkZWVwIHByb3BlcnRpZXNgLiBbZGVzY10gd2lsbCBzb3J0CiAgICAgKiAgICAgICAgdGhlIGFycmF5IGluIGRlc2NlbmRpbmcgb3JkZXIuIFdoZW4gdGhlIGZpZWxkIGJlaW5nIHNvcnRlZCBvbiBpcwogICAgICogICAgICAgIGEgc3RyaW5nLCB0aGUgcmVzdWx0aW5nIG9yZGVyIHdpbGwgYmUgZGV0ZXJtaW5lZCBieSBhbiBpbnRlcm5hbAogICAgICogICAgICAgIGNvbGxhdGlvbiBhbGdvcml0aG0gdGhhdCBpcyBvcHRpbWl6ZWQgZm9yIG1ham9yIFdlc3Rlcm4gbGFuZ3VhZ2VzLAogICAgICogICAgICAgIGJ1dCBjYW4gYmUgY3VzdG9taXplZCB1c2luZyBzb3J0aW5nIGFjY2Vzc29ycyBzdWNoIGFzIGBzb3J0SWdub3JlYC4KICAgICAqICAgICAgICBUaGlzIG1ldGhvZCB3aWxsIG1vZGlmeSB0aGUgYXJyYXkhCiAgICAgKgogICAgICogQGNhbGxiYWNrIHNvcnRNYXBGbgogICAgICoKICAgICAqICAgZWwgICBBbiBhcnJheSBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbJ3dvcmxkJywnYScsJ25ldyddLnNvcnRCeSgnbGVuZ3RoJykgICAgICAgLT4gWydhJywnbmV3Jywnd29ybGQnXQogICAgICogICBbJ3dvcmxkJywnYScsJ25ldyddLnNvcnRCeSgnbGVuZ3RoJywgdHJ1ZSkgLT4gWyd3b3JsZCcsJ25ldycsJ2EnXQogICAgICogICB1c2Vycy5zb3J0QnkoZnVuY3Rpb24obikgewogICAgICogICAgIHJldHVybiBuLmFnZTsKICAgICAqICAgfSk7IC0+IHVzZXJzIGFycmF5IHNvcnRlZCBieSBhZ2UKICAgICAqICAgdXNlcnMuc29ydEJ5KCdhZ2UnKSAtPiB1c2VycyBhcnJheSBzb3J0ZWQgYnkgYWdlCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8c29ydE1hcEZufSBbbWFwXQogICAgICogQHBhcmFtIHtib29sZWFufSBbZGVzY10KICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtOZXdBcnJheUVsZW1lbnR9IHNvcnRNYXBGbgogICAgICoKICAgICAqKiovCiAgICAnc29ydEJ5JzogZnVuY3Rpb24oYXJyLCBtYXAsIGRlc2MpIHsKICAgICAgYXJyLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIHZhciBhUHJvcGVydHkgPSBtYXBXaXRoU2hvcnRjdXRzKGEsIG1hcCwgYXJyLCBbYV0pOwogICAgICAgIHZhciBiUHJvcGVydHkgPSBtYXBXaXRoU2hvcnRjdXRzKGIsIG1hcCwgYXJyLCBbYl0pOwogICAgICAgIHJldHVybiBjb21wYXJlVmFsdWUoYVByb3BlcnR5LCBiUHJvcGVydHkpICogKGRlc2MgPyAtMSA6IDEpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGFycjsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCByZW1vdmUoc2VhcmNoKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBSZW1vdmVzIGFueSBlbGVtZW50IGluIHRoZSBhcnJheSB0aGF0IG1hdGNoZXMgYHNlYXJjaGAuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2Qgd2lsbCBtb2RpZnkgdGhlIGFycmF5ISBVc2UgYGV4Y2x1ZGVgIGZvciBhCiAgICAgKiAgICAgICAgbm9uLWRlc3RydWN0aXZlIGFsaWFzLiBUaGlzIG1ldGhvZCBpbXBsZW1lbnRzIGBlbmhhbmNlZCBtYXRjaGluZ2AuCiAgICAgKgogICAgICogQGNhbGxiYWNrIHNlYXJjaEZuCiAgICAgKgogICAgICogICBlbCAgIFRoZSBlbGVtZW50IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBhcnIgIEEgcmVmZXJlbmNlIHRvIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzXS5yZW1vdmUoMykgICAgICAgICAtPiBbMSwyXQogICAgICogICBbJ2EnLCdiJywnYyddLnJlbW92ZSgvYi8pIC0+IFsnYScsJ2MnXQogICAgICogICBbe2E6MX0se2I6Mn1dLnJlbW92ZShmdW5jdGlvbihuKSB7CiAgICAgKiAgICAgcmV0dXJuIG5bJ2EnXSA9PSAxOwogICAgICogICB9KTsgLT4gW3tiOjJ9XQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fHNlYXJjaEZufSBzZWFyY2gKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXl9IGFycgogICAgICogQGNhbGxiYWNrUmV0dXJucyB7Ym9vbGVhbn0gc2VhcmNoRm4KICAgICAqCiAgICAgKioqLwogICAgJ3JlbW92ZSc6IGZ1bmN0aW9uKGFyciwgZikgewogICAgICByZXR1cm4gYXJyYXlSZW1vdmUoYXJyLCBmKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBleGNsdWRlKHNlYXJjaCkKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgUmV0dXJucyBhIG5ldyBhcnJheSB3aXRoIGV2ZXJ5IGVsZW1lbnQgdGhhdCBkb2VzIG5vdCBtYXRjaCBgc2VhcmNoYC4KICAgICAqIEBleHRyYSBUaGlzIG1ldGhvZCBjYW4gYmUgdGhvdWdodCBvZiBhcyB0aGUgaW52ZXJzZSBvZiBgQXJyYXkjZmlsdGVyYC4gSXQKICAgICAqICAgICAgICB3aWxsIG5vdCBtb2RpZnkgdGhlIG9yaWdpbmFsIGFycmF5LCBVc2UgYHJlbW92ZWAgdG8gbW9kaWZ5IHRoZQogICAgICogICAgICAgIGFycmF5IGluIHBsYWNlLiBJbXBsZW1lbnRzIGBlbmhhbmNlZCBtYXRjaGluZ2AuCiAgICAgKgogICAgICogQGNhbGxiYWNrIHNlYXJjaEZuCiAgICAgKgogICAgICogICBlbCAgIFRoZSBlbGVtZW50IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBhcnIgIEEgcmVmZXJlbmNlIHRvIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzXS5leGNsdWRlKDMpICAgICAgICAgLT4gWzEsMl0KICAgICAqICAgWydhJywnYicsJ2MnXS5leGNsdWRlKC9iLykgLT4gWydhJywnYyddCiAgICAgKiAgIFt7YToxfSx7YjoyfV0uZXhjbHVkZShmdW5jdGlvbihuKSB7CiAgICAgKiAgICAgcmV0dXJuIG5bJ2EnXSA9PSAxOwogICAgICogICB9KTsgLT4gW3tiOjJ9XQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fHNlYXJjaEZufSBzZWFyY2gKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXl9IGFycgogICAgICogQGNhbGxiYWNrUmV0dXJucyB7Ym9vbGVhbn0gc2VhcmNoRm4KICAgICAqCiAgICAgKioqLwogICAgJ2V4Y2x1ZGUnOiBmdW5jdGlvbihhcnIsIGYpIHsKICAgICAgcmV0dXJuIGFycmF5RXhjbHVkZShhcnIsIGYpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHVuaW9uKGFycikKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgUmV0dXJucyBhIG5ldyBhcnJheSBjb250YWluaW5nIGVsZW1lbnRzIGluIGJvdGggYXJyYXlzIHdpdGgKICAgICAqICAgICAgICBkdXBsaWNhdGVzIHJlbW92ZWQuCiAgICAgKiBAZXh0cmEgSW4gYWRkaXRpb24gdG8gcHJpbWl0aXZlcywgdGhpcyBtZXRob2Qgd2lsbCBhbHNvIGRlZXAtY2hlY2sgb2JqZWN0cwogICAgICogICAgICAgIGZvciBlcXVhbGl0eS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMyw1XS51bmlvbihbNSw3LDldKSAgICAgLT4gWzEsMyw1LDcsOV0KICAgICAqICAgWydhJywnYiddLnVuaW9uKFsnYicsJ2MnXSkgLT4gWydhJywnYicsJ2MnXQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycgogICAgICoKICAgICAqKiovCiAgICAndW5pb24nOiBmdW5jdGlvbihhcnIxLCBhcnIyKSB7CiAgICAgIHJldHVybiBhcnJheVVuaXF1ZShhcnJheUNvbmNhdChhcnIxLCBhcnIyKSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaW50ZXJzZWN0KGFycikKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgUmV0dXJucyBhIG5ldyBhcnJheSBjb250YWluaW5nIGFueSBlbGVtZW50cyB0aGF0IGJvdGggYXJyYXlzIGhhdmUgaW4KICAgICAqICAgICAgICBjb21tb24uCiAgICAgKiBAZXh0cmEgSW4gYWRkaXRpb24gdG8gcHJpbWl0aXZlcywgdGhpcyBtZXRob2Qgd2lsbCBhbHNvIGRlZXAtY2hlY2sgb2JqZWN0cwogICAgICogICAgICAgIGZvciBlcXVhbGl0eS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMyw1XS5pbnRlcnNlY3QoWzUsNyw5XSkgICAgIC0+IFs1XQogICAgICogICBbJ2EnLCdiJ10uaW50ZXJzZWN0KFsnYicsJ2MnXSkgLT4gWydiJ10KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnIKICAgICAqCiAgICAgKioqLwogICAgJ2ludGVyc2VjdCc6IGZ1bmN0aW9uKGFycjEsIGFycjIpIHsKICAgICAgcmV0dXJuIGFycmF5SW50ZXJzZWN0T3JTdWJ0cmFjdChhcnIxLCBhcnIyLCBmYWxzZSk7CiAgICB9CgogIH0pOwoKICBkZWZpbmVJbnN0YW5jZVdpdGhBcmd1bWVudHMoc3VnYXJBcnJheSwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgemlwKFthcnIxXSwgW2FycjJdLCAuLi4pCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IE1lcmdlcyBtdWx0aXBsZSBhcnJheXMgdG9nZXRoZXIuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgInppcHMgdXAiIHNtYWxsZXIgYXJyYXlzIGludG8gb25lIGxhcmdlIHdob3NlIGVsZW1lbnRzCiAgICAgKiAgICAgICAgYXJlICJhbGwgZWxlbWVudHMgYXQgaW5kZXggMCIsICJhbGwgZWxlbWVudHMgYXQgaW5kZXggMSIsIGV0Yy4KICAgICAqICAgICAgICBVc2VmdWwgd2hlbiB5b3UgaGF2ZSBhc3NvY2lhdGVkIGRhdGEgdGhhdCBpcyBzcGxpdCBvdmVyIHNlcGFyYXRlZAogICAgICogICAgICAgIGFycmF5cy4gSWYgdGhlIGFycmF5cyBwYXNzZWQgaGF2ZSBtb3JlIGVsZW1lbnRzIHRoYW4gdGhlIG9yaWdpbmFsCiAgICAgKiAgICAgICAgYXJyYXksIHRoZXkgd2lsbCBiZSBkaXNjYXJkZWQuIElmIHRoZXkgaGF2ZSBmZXdlciBlbGVtZW50cywgdGhlCiAgICAgKiAgICAgICAgbWlzc2luZyBlbGVtZW50cyB3aWxsIGZpbGxlZCB3aXRoIGBudWxsYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzXS56aXAoWzQsNSw2XSkgLT4gW1sxLDJdLCBbMyw0XSwgWzUsNl1dCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyMQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyMgogICAgICoKICAgICAqKiovCiAgICAnemlwJzogZnVuY3Rpb24oYXJyLCBhcmdzKSB7CiAgICAgIHJldHVybiBtYXAoYXJyLCBmdW5jdGlvbihlbCwgaSkgewogICAgICAgIHJldHVybiBbZWxdLmNvbmNhdChtYXAoYXJncywgZnVuY3Rpb24oaykgewogICAgICAgICAgcmV0dXJuIChpIGluIGspID8ga1tpXSA6IG51bGw7CiAgICAgICAgfSkpOwogICAgICB9KTsKICAgIH0KCiAgfSk7CgogIC8qKioKICAgKiBAbWV0aG9kIGluc2VydChpdGVtLCBbaW5kZXhdKQogICAqIEByZXR1cm5zIEFycmF5CiAgICogQHNob3J0IEFwcGVuZHMgYGl0ZW1gIHRvIHRoZSBhcnJheSBhdCBbaW5kZXhdLgogICAqIEBleHRyYSBUaGlzIG1ldGhvZCBpcyBzaW1wbHkgYSBtb3JlIHJlYWRhYmxlIGFsaWFzIGZvciBgYXBwZW5kYCB3aGVuIHBhc3NpbmcKICAgKiAgICAgICAgYW4gaW5kZXguIElmIGBlbGAgaXMgYW4gYXJyYXkgaXQgd2lsbCBiZSBqb2luZWQuIFRoaXMgbWV0aG9kIG1vZGlmaWVzCiAgICogICAgICAgIHRoZSBhcnJheSEgVXNlIGBhZGRgIGFzIGEgbm9uLWRlc3RydWN0aXZlIGFsaWFzLgogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgWzEsMyw0LDVdLmluc2VydCgyLCAxKSAgICAgLT4gWzEsMiwzLDQsNV0KICAgKiAgIFsxLDQsNSw2XS5pbnNlcnQoWzIsM10sIDEpIC0+IFsxLDIsMyw0LDUsNl0KICAgKgogICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fEFycmF5fSBpdGVtCiAgICogQHBhcmFtIHtudW1iZXJ9IFtpbmRleF0KICAgKgogICAqKiovCiAgYWxpYXMoc3VnYXJBcnJheSwgJ2luc2VydCcsICdhcHBlbmQnKTsKCiAgc2V0QXJyYXlDaGFpbmFibGVDb25zdHJ1Y3RvcigpOwoKICAvKioqCiAgICogQG1vZHVsZSBPYmplY3QKICAgKiBAZGVzY3JpcHRpb24gT2JqZWN0IGNyZWF0aW9uLCBtYW5pcHVsYXRpb24sIGNvbXBhcmlzb24sIHR5cGUgY2hlY2tpbmcsIGFuZCBtb3JlLgogICAqCiAgICogTXVjaCB0aGFua3MgdG8ga2FuZ2F4IGZvciBoaXMgaW5mb3JtYXRpdmUgYXJpY2xlIGFib3V0IGhvdyBwcm9ibGVtcyB3aXRoCiAgICogaW5zdGFuY2VvZiBhbmQgY29uc3RydWN0b3I6IGh0dHA6Ly9iaXQubHkvMVFkczI3VwogICAqCiAgICoqKi8KCiAgLy8gTWF0Y2hlcyBicmFja2V0LXN0eWxlIHF1ZXJ5IHN0cmluZ3MgbGlrZSB1c2VyW25hbWVdCiAgdmFyIERFRVBfUVVFUllfU1RSSU5HX1JFRyA9IC9eKC4rPykoXFsuKlxdKSQvOwoKICAvLyBNYXRjaGVzIGFueSBjaGFyYWN0ZXIgbm90IGFsbG93ZWQgaW4gYSBkZWNpbWFsIG51bWJlci4KICB2YXIgTk9OX0RFQ0lNQUxfUkVHID0gL1teXGQuLV0vOwoKICAvLyBOYXRpdmUgbWV0aG9kcyBmb3IgbWVyZ2luZyBieSBkZXNjcmlwdG9yIHdoZW4gYXZhaWxhYmxlLgogIHZhciBnZXRPd25Qcm9wZXJ0eU5hbWVzICAgICAgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKICB2YXIgZ2V0T3duUHJvcGVydHlTeW1ib2xzICAgID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9sczsKICB2YXIgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcjsKCiAgLy8gQmFzaWMgSGVscGVycwoKICBmdW5jdGlvbiBpc0FyZ3VtZW50cyhvYmosIGNsYXNzTmFtZSkgewogICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8IGNsYXNzVG9TdHJpbmcob2JqKTsKICAgIC8vIC5jYWxsZWUgZXhpc3RzIG9uIEFyZ3VtZW50cyBvYmplY3RzIGluIDwgSUU4CiAgICByZXR1cm4gaGFzUHJvcGVydHkob2JqLCAnbGVuZ3RoJykgJiYgKGNsYXNzTmFtZSA9PT0gJ1tvYmplY3QgQXJndW1lbnRzXScgfHwgISFvYmouY2FsbGVlKTsKICB9CgogIC8vIFF1ZXJ5IFN0cmluZ3MgfCBDcmVhdGluZwoKICBmdW5jdGlvbiB0b1F1ZXJ5U3RyaW5nV2l0aE9wdGlvbnMob2JqLCBvcHRzKSB7CiAgICBvcHRzID0gb3B0cyB8fCB7fTsKICAgIGlmIChpc1VuZGVmaW5lZChvcHRzLnNlcGFyYXRvcikpIHsKICAgICAgb3B0cy5zZXBhcmF0b3IgPSAnXyc7CiAgICB9CiAgICByZXR1cm4gdG9RdWVyeVN0cmluZyhvYmosIG9wdHMuZGVlcCwgb3B0cy50cmFuc2Zvcm0sIG9wdHMucHJlZml4IHx8ICcnLCBvcHRzLnNlcGFyYXRvcik7CiAgfQoKICBmdW5jdGlvbiB0b1F1ZXJ5U3RyaW5nKG9iaiwgZGVlcCwgdHJhbnNmb3JtLCBwcmVmaXgsIHNlcGFyYXRvcikgewogICAgaWYgKGlzQXJyYXkob2JqKSkgewogICAgICByZXR1cm4gY29sbGVjdEFycmF5QXNRdWVyeVN0cmluZyhvYmosIGRlZXAsIHRyYW5zZm9ybSwgcHJlZml4LCBzZXBhcmF0b3IpOwogICAgfSBlbHNlIGlmIChpc09iamVjdFR5cGUob2JqKSAmJiBvYmoudG9TdHJpbmcgPT09IGludGVybmFsVG9TdHJpbmcpIHsKICAgICAgcmV0dXJuIGNvbGxlY3RPYmplY3RBc1F1ZXJ5U3RyaW5nKG9iaiwgZGVlcCwgdHJhbnNmb3JtLCBwcmVmaXgsIHNlcGFyYXRvcik7CiAgICB9IGVsc2UgaWYgKHByZWZpeCkgewogICAgICByZXR1cm4gZ2V0VVJJQ29tcG9uZW50VmFsdWUob2JqLCBwcmVmaXgsIHRyYW5zZm9ybSk7CiAgICB9CiAgICByZXR1cm4gJyc7CiAgfQoKICBmdW5jdGlvbiBjb2xsZWN0QXJyYXlBc1F1ZXJ5U3RyaW5nKGFyciwgZGVlcCwgdHJhbnNmb3JtLCBwcmVmaXgsIHNlcGFyYXRvcikgewogICAgdmFyIGVsLCBxYywga2V5LCByZXN1bHQgPSBbXTsKICAgIC8vIEludGVudGlvbmFsbHkgdHJlYXRpbmcgc3BhcnNlIGFycmF5cyBhcyBkZW5zZSBoZXJlIGJ5IGF2b2lkaW5nIG1hcCwKICAgIC8vIG90aGVyd2lzZSBpbmRleGVzIHdpbGwgc2hpZnQgZHVyaW5nIHRoZSBwcm9jZXNzIG9mIHNlcmlhbGl6YXRpb24uCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGVsID0gYXJyW2ldOwogICAgICBrZXkgPSBwcmVmaXggKyAocHJlZml4ICYmIGRlZXAgPyAnW10nIDogJycpOwogICAgICBpZiAoIWtleSAmJiAhaXNPYmplY3RUeXBlKGVsKSkgewogICAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGtleSwgdGhlbiB0aGUgdmFsdWVzIG9mIHRoZSBhcnJheSBzaG91bGQgYmUKICAgICAgICAvLyBjb25zaWRlcmVkIGFzIG51bGwga2V5cywgc28gdXNlIHRoZW0gaW5zdGVhZDsKICAgICAgICBxYyA9IHNhbml0aXplVVJJQ29tcG9uZW50KGVsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBxYyA9IHRvUXVlcnlTdHJpbmcoZWwsIGRlZXAsIHRyYW5zZm9ybSwga2V5LCBzZXBhcmF0b3IpOwogICAgICB9CiAgICAgIHJlc3VsdC5wdXNoKHFjKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQuam9pbignJicpOwogIH0KCiAgZnVuY3Rpb24gY29sbGVjdE9iamVjdEFzUXVlcnlTdHJpbmcob2JqLCBkZWVwLCB0cmFuc2Zvcm0sIHByZWZpeCwgc2VwYXJhdG9yKSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3JFYWNoUHJvcGVydHkob2JqLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICB2YXIgZnVsbEtleTsKICAgICAgaWYgKHByZWZpeCAmJiBkZWVwKSB7CiAgICAgICAgZnVsbEtleSA9IHByZWZpeCArICdbJyArIGtleSArICddJzsKICAgICAgfSBlbHNlIGlmIChwcmVmaXgpIHsKICAgICAgICBmdWxsS2V5ID0gcHJlZml4ICsgc2VwYXJhdG9yICsga2V5OwogICAgICB9IGVsc2UgewogICAgICAgIGZ1bGxLZXkgPSBrZXk7CiAgICAgIH0KICAgICAgcmVzdWx0LnB1c2godG9RdWVyeVN0cmluZyh2YWwsIGRlZXAsIHRyYW5zZm9ybSwgZnVsbEtleSwgc2VwYXJhdG9yKSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQuam9pbignJicpOwogIH0KCiAgZnVuY3Rpb24gZ2V0VVJJQ29tcG9uZW50VmFsdWUob2JqLCBwcmVmaXgsIHRyYW5zZm9ybSkgewogICAgdmFyIHZhbHVlOwogICAgaWYgKHRyYW5zZm9ybSkgewogICAgICB2YWx1ZSA9IHRyYW5zZm9ybShvYmosIHByZWZpeCk7CiAgICB9IGVsc2UgaWYgKGlzRGF0ZShvYmopKSB7CiAgICAgIHZhbHVlID0gb2JqLmdldFRpbWUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlID0gb2JqOwogICAgfQogICAgcmV0dXJuIHNhbml0aXplVVJJQ29tcG9uZW50KHByZWZpeCkgKyAnPScgKyBzYW5pdGl6ZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiBzYW5pdGl6ZVVSSUNvbXBvbmVudChvYmopIHsKICAgIC8vIHVuZGVmaW5lZCwgbnVsbCwgYW5kIE5hTiBhcmUgcmVwcmVzZW50ZWQgYXMgYSBibGFuayBzdHJpbmcsCiAgICAvLyB3aGlsZSBmYWxzZSBhbmQgMCBhcmUgc3RyaW5naWZpZWQuCiAgICByZXR1cm4gIW9iaiAmJiBvYmogIT09IGZhbHNlICYmIG9iaiAhPT0gMCA/ICcnIDogZW5jb2RlVVJJQ29tcG9uZW50KG9iaik7CiAgfQoKCiAgLy8gUXVlcnkgU3RyaW5ncyB8IFBhcnNpbmcKCiAgZnVuY3Rpb24gZnJvbVF1ZXJ5U3RyaW5nV2l0aE9wdGlvbnMob2JqLCBvcHRzKSB7CiAgICB2YXIgc3RyID0gU3RyaW5nKG9iaiB8fCAnJykucmVwbGFjZSgvXi4qP1w/LywgJycpLCByZXN1bHQgPSB7fSwgYXV0bzsKICAgIG9wdHMgPSBvcHRzIHx8IHt9OwogICAgaWYgKHN0cikgewogICAgICBmb3JFYWNoKHN0ci5zcGxpdCgnJicpLCBmdW5jdGlvbihwKSB7CiAgICAgICAgdmFyIHNwbGl0ID0gcC5zcGxpdCgnPScpOwogICAgICAgIHZhciBrZXkgPSBkZWNvZGVVUklDb21wb25lbnQoc3BsaXRbMF0pOwogICAgICAgIHZhciB2YWwgPSBzcGxpdC5sZW5ndGggPT09IDIgPyBkZWNvZGVVUklDb21wb25lbnQoc3BsaXRbMV0pIDogJyc7CiAgICAgICAgYXV0byA9IG9wdHMuYXV0byAhPT0gZmFsc2U7CiAgICAgICAgcGFyc2VRdWVyeUNvbXBvbmVudChyZXN1bHQsIGtleSwgdmFsLCBvcHRzLmRlZXAsIGF1dG8sIG9wdHMuc2VwYXJhdG9yLCBvcHRzLnRyYW5zZm9ybSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIHBhcnNlUXVlcnlDb21wb25lbnQob2JqLCBrZXksIHZhbCwgZGVlcCwgYXV0bywgc2VwYXJhdG9yLCB0cmFuc2Zvcm0pIHsKICAgIHZhciBtYXRjaDsKICAgIGlmIChzZXBhcmF0b3IpIHsKICAgICAga2V5ID0gbWFwUXVlcnlTZXBhcmF0b3JUb0tleXMoa2V5LCBzZXBhcmF0b3IpOwogICAgICBkZWVwID0gdHJ1ZTsKICAgIH0KICAgIGlmIChkZWVwID09PSB0cnVlICYmIChtYXRjaCA9IGtleS5tYXRjaChERUVQX1FVRVJZX1NUUklOR19SRUcpKSkgewogICAgICBwYXJzZURlZXBRdWVyeUNvbXBvbmVudChvYmosIG1hdGNoLCB2YWwsIGRlZXAsIGF1dG8sIHNlcGFyYXRvciwgdHJhbnNmb3JtKTsKICAgIH0gZWxzZSB7CiAgICAgIHNldFF1ZXJ5UHJvcGVydHkob2JqLCBrZXksIHZhbCwgYXV0bywgdHJhbnNmb3JtKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHBhcnNlRGVlcFF1ZXJ5Q29tcG9uZW50KG9iaiwgbWF0Y2gsIHZhbCwgZGVlcCwgYXV0bywgc2VwYXJhdG9yLCB0cmFuc2Zvcm0pIHsKICAgIHZhciBrZXkgPSBtYXRjaFsxXTsKICAgIHZhciBpbm5lciA9IG1hdGNoWzJdLnNsaWNlKDEsIC0xKS5zcGxpdCgnXVsnKTsKICAgIGZvckVhY2goaW5uZXIsIGZ1bmN0aW9uKGspIHsKICAgICAgaWYgKCFoYXNPd24ob2JqLCBrZXkpKSB7CiAgICAgICAgb2JqW2tleV0gPSBrID8ge30gOiBbXTsKICAgICAgfQogICAgICBvYmogPSBnZXRPd24ob2JqLCBrZXkpOwogICAgICBrZXkgPSBrID8gayA6IG9iai5sZW5ndGgudG9TdHJpbmcoKTsKICAgIH0pOwogICAgc2V0UXVlcnlQcm9wZXJ0eShvYmosIGtleSwgdmFsLCBhdXRvLCB0cmFuc2Zvcm0pOwogIH0KCiAgZnVuY3Rpb24gbWFwUXVlcnlTZXBhcmF0b3JUb0tleXMoa2V5LCBzZXBhcmF0b3IpIHsKICAgIHZhciBzcGxpdCA9IGtleS5zcGxpdChzZXBhcmF0b3IpLCByZXN1bHQgPSBzcGxpdFswXTsKICAgIGZvciAodmFyIGkgPSAxLCBsZW4gPSBzcGxpdC5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICByZXN1bHQgKz0gJ1snICsgc3BsaXRbaV0gKyAnXSc7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZnVuY3Rpb24gc2V0UXVlcnlQcm9wZXJ0eShvYmosIGtleSwgdmFsLCBhdXRvLCB0cmFuc2Zvcm0pIHsKICAgIHZhciBmblZhbHVlOwogICAgaWYgKHRyYW5zZm9ybSkgewogICAgICBmblZhbHVlID0gdHJhbnNmb3JtKHZhbCwga2V5LCBvYmopOwogICAgfQogICAgaWYgKGlzRGVmaW5lZChmblZhbHVlKSkgewogICAgICB2YWwgPSBmblZhbHVlOwogICAgfSBlbHNlIGlmIChhdXRvKSB7CiAgICAgIHZhbCA9IGdldFF1ZXJ5VmFsdWVBdXRvKG9iaiwga2V5LCB2YWwpOwogICAgfQogICAgb2JqW2tleV0gPSB2YWw7CiAgfQoKICBmdW5jdGlvbiBnZXRRdWVyeVZhbHVlQXV0byhvYmosIGtleSwgdmFsKSB7CiAgICBpZiAoIXZhbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSBpZiAodmFsID09PSAndHJ1ZScpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKHZhbCA9PT0gJ2ZhbHNlJykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgbnVtID0gK3ZhbDsKICAgIGlmICghaXNOYU4obnVtKSAmJiBzdHJpbmdJc0RlY2ltYWwodmFsKSkgewogICAgICByZXR1cm4gbnVtOwogICAgfQogICAgdmFyIGV4aXN0aW5nID0gZ2V0T3duKG9iaiwga2V5KTsKICAgIGlmICh2YWwgJiYgZXhpc3RpbmcpIHsKICAgICAgcmV0dXJuIGlzQXJyYXkoZXhpc3RpbmcpID8gZXhpc3RpbmcuY29uY2F0KHZhbCkgOiBbZXhpc3RpbmcsIHZhbF07CiAgICB9CiAgICByZXR1cm4gdmFsOwogIH0KCiAgZnVuY3Rpb24gc3RyaW5nSXNEZWNpbWFsKHN0cikgewogICAgcmV0dXJuIHN0ciAhPT0gJycgJiYgIU5PTl9ERUNJTUFMX1JFRy50ZXN0KHN0cik7CiAgfQoKCiAgLy8gT2JqZWN0IE1lcmdpbmcKCiAgZnVuY3Rpb24gbWVyZ2VXaXRoT3B0aW9ucyh0YXJnZXQsIHNvdXJjZSwgb3B0cykgewogICAgb3B0cyA9IG9wdHMgfHwge307CiAgICByZXR1cm4gb2JqZWN0TWVyZ2UodGFyZ2V0LCBzb3VyY2UsIG9wdHMuZGVlcCwgb3B0cy5yZXNvbHZlLCBvcHRzLmhpZGRlbiwgb3B0cy5kZXNjcmlwdG9yKTsKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHRzKHRhcmdldCwgc291cmNlcywgb3B0cykgewogICAgb3B0cyA9IG9wdHMgfHwge307CiAgICBvcHRzLnJlc29sdmUgPSBvcHRzLnJlc29sdmUgfHwgZmFsc2U7CiAgICByZXR1cm4gbWVyZ2VBbGwodGFyZ2V0LCBzb3VyY2VzLCBvcHRzKTsKICB9CgogIGZ1bmN0aW9uIG1lcmdlQWxsKHRhcmdldCwgc291cmNlcywgb3B0cykgewogICAgaWYgKCFpc0FycmF5KHNvdXJjZXMpKSB7CiAgICAgIHNvdXJjZXMgPSBbc291cmNlc107CiAgICB9CiAgICBmb3JFYWNoKHNvdXJjZXMsIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICByZXR1cm4gbWVyZ2VXaXRoT3B0aW9ucyh0YXJnZXQsIHNvdXJjZSwgb3B0cyk7CiAgICB9KTsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQoKICBmdW5jdGlvbiBpdGVyYXRlT3ZlclByb3BlcnRpZXMoaGlkZGVuLCBvYmosIGZuKSB7CiAgICBpZiAoZ2V0T3duUHJvcGVydHlOYW1lcyAmJiBoaWRkZW4pIHsKICAgICAgaXRlcmF0ZU92ZXJLZXlzKGdldE93blByb3BlcnR5TmFtZXMsIG9iaiwgZm4sIGhpZGRlbik7CiAgICB9IGVsc2UgewogICAgICBmb3JFYWNoUHJvcGVydHkob2JqLCBmbik7CiAgICB9CiAgICBpZiAoZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICAgIGl0ZXJhdGVPdmVyS2V5cyhnZXRPd25Qcm9wZXJ0eVN5bWJvbHMsIG9iaiwgZm4sIGhpZGRlbik7CiAgICB9CiAgfQoKICAvLyAia2V5cyIgbWF5IGluY2x1ZGUgc3ltYm9scwogIGZ1bmN0aW9uIGl0ZXJhdGVPdmVyS2V5cyhnZXRGbiwgb2JqLCBmbiwgaGlkZGVuKSB7CiAgICB2YXIga2V5cyA9IGdldEZuKG9iaiksIGRlc2M7CiAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBrZXlzW2ldOyBpKyspIHsKICAgICAgZGVzYyA9IGdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSk7CiAgICAgIGlmIChkZXNjLmVudW1lcmFibGUgfHwgaGlkZGVuKSB7CiAgICAgICAgZm4ob2JqW2tleV0sIGtleSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIG1lcmdlQnlQcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBzb3VyY2UsIHByb3AsIHNvdXJjZVZhbCkgewogICAgdmFyIGRlc2NyaXB0b3IgPSBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLCBwcm9wKTsKICAgIGlmIChpc0RlZmluZWQoZGVzY3JpcHRvci52YWx1ZSkpIHsKICAgICAgZGVzY3JpcHRvci52YWx1ZSA9IHNvdXJjZVZhbDsKICAgIH0KICAgIGRlZmluZVByb3BlcnR5KHRhcmdldCwgcHJvcCwgZGVzY3JpcHRvcik7CiAgfQoKICBmdW5jdGlvbiBvYmplY3RNZXJnZSh0YXJnZXQsIHNvdXJjZSwgZGVlcCwgcmVzb2x2ZSwgaGlkZGVuLCBkZXNjcmlwdG9yKSB7CiAgICB2YXIgcmVzb2x2ZUJ5RnVuY3Rpb24gPSBpc0Z1bmN0aW9uKHJlc29sdmUpLCByZXNvbHZlQ29uZmxpY3RzID0gcmVzb2x2ZSAhPT0gZmFsc2U7CgogICAgaWYgKGlzVW5kZWZpbmVkKHRhcmdldCkpIHsKICAgICAgdGFyZ2V0ID0gZ2V0TmV3T2JqZWN0Rm9yTWVyZ2Uoc291cmNlKTsKICAgIH0gZWxzZSBpZiAocmVzb2x2ZUNvbmZsaWN0cyAmJiBpc0RhdGUodGFyZ2V0KSAmJiBpc0RhdGUoc291cmNlKSkgewogICAgICAvLyBBIGRhdGUncyB0aW1lc3RhbXAgaXMgYSBwcm9wZXJ0eSB0aGF0IGNhbiBvbmx5IGJlIHJlYWNoZWQgdGhyb3VnaCBpdHMKICAgICAgLy8gbWV0aG9kcywgc28gYWN0aXZlbHkgc2V0IGl0IHVwIGZyb250IGlmIGJvdGggYXJlIGRhdGVzLgogICAgICB0YXJnZXQuc2V0VGltZShzb3VyY2UuZ2V0VGltZSgpKTsKICAgIH0KCiAgICBpZiAoaXNQcmltaXRpdmUodGFyZ2V0KSkgewogICAgICAvLyBXaWxsIG5vdCBtZXJnZSBpbnRvIGEgcHJpbWl0aXZlIHR5cGUsIHNvIHNpbXBseSBvdmVycmlkZS4KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0KCiAgICAvLyBJZiB0aGUgc291cmNlIG9iamVjdCBpcyBhIHByaW1pdGl2ZQogICAgLy8gdHlwZSB0aGVuIGNvZXJjZSBpdCBpbnRvIGFuIG9iamVjdC4KICAgIGlmIChpc1ByaW1pdGl2ZShzb3VyY2UpKSB7CiAgICAgIHNvdXJjZSA9IGNvZXJjZVByaW1pdGl2ZVRvT2JqZWN0KHNvdXJjZSk7CiAgICB9CgogICAgaXRlcmF0ZU92ZXJQcm9wZXJ0aWVzKGhpZGRlbiwgc291cmNlLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICB2YXIgc291cmNlVmFsLCB0YXJnZXRWYWwsIHJlc29sdmVkLCBnb0RlZXAsIHJlc3VsdDsKCiAgICAgIHNvdXJjZVZhbCA9IHNvdXJjZVtrZXldOwoKICAgICAgLy8gV2UgYXJlIGl0ZXJhdGluZyBvdmVyIHByb3BlcnRpZXMgb2YgdGhlIHNvdXJjZSwgc28gaGFzT3duUHJvcGVydHkgb24KICAgICAgLy8gaXQgaXMgZ3VhcmFudGVlZCB0byBhbHdheXMgYmUgdHJ1ZS4gSG93ZXZlciwgdGhlIHRhcmdldCBtYXkgaGFwcGVuIHRvCiAgICAgIC8vIGhhdmUgcHJvcGVydGllcyBpbiBpdHMgcHJvdG90eXBlIGNoYWluIHRoYXQgc2hvdWxkIG5vdCBiZSBjb25zaWRlcmVkCiAgICAgIC8vIGFzIGNvbmZsaWN0cy4KICAgICAgdGFyZ2V0VmFsID0gZ2V0T3duKHRhcmdldCwga2V5KTsKCiAgICAgIGlmIChyZXNvbHZlQnlGdW5jdGlvbikgewogICAgICAgIHJlc3VsdCA9IHJlc29sdmUoa2V5LCB0YXJnZXRWYWwsIHNvdXJjZVZhbCwgdGFyZ2V0LCBzb3VyY2UpOwogICAgICAgIGlmIChpc1VuZGVmaW5lZChyZXN1bHQpKSB7CiAgICAgICAgICAvLyBSZXN1bHQgaXMgdW5kZWZpbmVkIHNvIGRvIG5vdCBtZXJnZSB0aGlzIHByb3BlcnR5LgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHJlc3VsdCkgJiYgcmVzdWx0ICE9PSBTdWdhcikgewogICAgICAgICAgLy8gSWYgdGhlIHNvdXJjZSByZXR1cm5zIGFueXRoaW5nIGV4Y2VwdCB1bmRlZmluZWQsIHRoZW4gdGhlIGNvbmZsaWN0CiAgICAgICAgICAvLyBoYXMgYmVlbiByZXNvbHZlZCwgc28gZG9uJ3QgY29udGludWUgdHJhdmVyc2luZyBpbnRvIHRoZSBvYmplY3QuIElmCiAgICAgICAgICAvLyB0aGUgcmV0dXJuZWQgdmFsdWUgaXMgdGhlIFN1Z2FyIGdsb2JhbCBvYmplY3QsIHRoZW4gYWxsb3dpbmcgU3VnYXIKICAgICAgICAgIC8vIHRvIHJlc29sdmUgdGhlIGNvbmZsaWN0LCBzbyBjb250aW51ZSBvbi4KICAgICAgICAgIHNvdXJjZVZhbCA9IHJlc3VsdDsKICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNVbmRlZmluZWQoc291cmNlVmFsKSkgewogICAgICAgIC8vIFdpbGwgbm90IG1lcmdlIHVuZGVmaW5lZC4KICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIFJlZ2V4IHByb3BlcnRpZXMgYXJlIHJlYWQtb25seSwgc28gaW50ZW50aW9uYWxseSBkaXNhbGxvd2luZyBkZWVwCiAgICAgIC8vIG1lcmdpbmcgZm9yIG5vdy4gSW5zdGVhZCBtZXJnZSBieSByZWZlcmVuY2UgZXZlbiBpZiBkZWVwLgogICAgICBnb0RlZXAgPSAhcmVzb2x2ZWQgJiYgZGVlcCAmJiBpc09iamVjdFR5cGUoc291cmNlVmFsKSAmJiAhaXNSZWdFeHAoc291cmNlVmFsKTsKCiAgICAgIGlmICghZ29EZWVwICYmICFyZXNvbHZlQ29uZmxpY3RzICYmIGlzRGVmaW5lZCh0YXJnZXRWYWwpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoZ29EZWVwKSB7CiAgICAgICAgc291cmNlVmFsID0gb2JqZWN0TWVyZ2UodGFyZ2V0VmFsLCBzb3VyY2VWYWwsIGRlZXAsIHJlc29sdmUsIGhpZGRlbiwgZGVzY3JpcHRvcik7CiAgICAgIH0KCiAgICAgIC8vIGdldE93blByb3BlcnR5TmFtZXMgaXMgc3RhbmRpbmcgaW4gYXMKICAgICAgLy8gYSB0ZXN0IGZvciBwcm9wZXJ0eSBkZXNjcmlwdG9yIHN1cHBvcnQKICAgICAgaWYgKGdldE93blByb3BlcnR5TmFtZXMgJiYgZGVzY3JpcHRvcikgewogICAgICAgIG1lcmdlQnlQcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBzb3VyY2UsIGtleSwgc291cmNlVmFsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0YXJnZXRba2V5XSA9IHNvdXJjZVZhbDsKICAgICAgfQoKICAgIH0pOwogICAgcmV0dXJuIHRhcmdldDsKICB9CgogIGZ1bmN0aW9uIGdldE5ld09iamVjdEZvck1lcmdlKHNvdXJjZSkgewogICAgdmFyIGtsYXNzID0gY2xhc3NUb1N0cmluZyhzb3VyY2UpOwogICAgLy8gUHJpbWl0aXZlIHR5cGVzLCBkYXRlcywgYW5kIHJlZ2V4ZXMgaGF2ZSBubyAiZW1wdHkiIHN0YXRlLiBJZiB0aGV5IGV4aXN0CiAgICAvLyBhdCBhbGwsIHRoZW4gdGhleSBoYXZlIGFuIGFzc29jaWF0ZWQgdmFsdWUuIEFzIHdlIGFyZSBvbmx5IGNyZWF0aW5nIG5ldwogICAgLy8gb2JqZWN0cyB3aGVuIHRoZXkgZG9uJ3QgZXhpc3QgaW4gdGhlIHRhcmdldCwgdGhlc2UgdmFsdWVzIGNhbiBjb21lIGFsb25lCiAgICAvLyBmb3IgdGhlIHJpZGUgd2hlbiBjcmVhdGVkLgogICAgaWYgKGlzQXJyYXkoc291cmNlLCBrbGFzcykpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHNvdXJjZSwga2xhc3MpKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSwga2xhc3MpKSB7CiAgICAgIHJldHVybiBuZXcgRGF0ZShzb3VyY2UuZ2V0VGltZSgpKTsKICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAoc291cmNlLCBrbGFzcykpIHsKICAgICAgcmV0dXJuIFJlZ0V4cChzb3VyY2Uuc291cmNlLCBnZXRSZWdFeHBGbGFncyhzb3VyY2UpKTsKICAgIH0gZWxzZSBpZiAoaXNQcmltaXRpdmUoc291cmNlICYmIHNvdXJjZS52YWx1ZU9mKCkpKSB7CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9CiAgICAvLyBJZiB0aGUgb2JqZWN0IGlzIG5vdCBvZiBhIGtub3duIHR5cGUsIHRoZW4gc2ltcGx5IG1lcmdpbmcgaXRzCiAgICAvLyBwcm9wZXJ0aWVzIGludG8gYSBwbGFpbiBvYmplY3Qgd2lsbCByZXN1bHQgaW4gc29tZXRoaW5nIGRpZmZlcmVudAogICAgLy8gKGl0IHdpbGwgbm90IHJlc3BvbmQgdG8gaW5zdGFuY2VvZiBvcGVyYXRvciBldGMpLiBTaW1pbGFybHkgd2UgZG9uJ3QKICAgIC8vIHdhbnQgdG8gY2FsbCBhIGNvbnN0cnVjdG9yIGhlcmUgYXMgd2UgY2FuJ3Qga25vdyBmb3Igc3VyZSB3aGF0IHRoZQogICAgLy8gb3JpZ2luYWwgY29uc3RydWN0b3Igd2FzIGNhbGxlZCB3aXRoIChFdmVudHMgZXRjKSwgc28gdGhyb3cgYW4KICAgIC8vIGVycm9yIGhlcmUgaW5zdGVhZC4gTm9uLXN0YW5kYXJkIHR5cGVzIGNhbiBiZSBoYW5kbGVkIGlmIGVpdGhlciB0aGV5CiAgICAvLyBhbHJlYWR5IGV4aXN0IGFuZCBzaW1wbHkgaGF2ZSB0aGVpciBwcm9wZXJ0aWVzIG1lcmdlZCwgaWYgdGhlIG1lcmdlCiAgICAvLyBpcyBub3QgZGVlcCBzbyB0aGVpciByZWZlcmVuY2VzIHdpbGwgc2ltcGx5IGJlIGNvcGllZCBvdmVyLCBvciBpZiBhCiAgICAvLyByZXNvbHZlIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXNzaXN0IHRoZSBtZXJnZS4KICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ011c3QgYmUgYSBiYXNpYyBkYXRhIHR5cGUnKTsKICB9CgogIGZ1bmN0aW9uIGNsb25lKHNvdXJjZSwgZGVlcCkgewogICAgdmFyIHRhcmdldCA9IGdldE5ld09iamVjdEZvck1lcmdlKHNvdXJjZSk7CiAgICByZXR1cm4gb2JqZWN0TWVyZ2UodGFyZ2V0LCBzb3VyY2UsIGRlZXAsIHRydWUsIHRydWUsIHRydWUpOwogIH0KCgogIC8vIEtleXMvVmFsdWVzCgogIGZ1bmN0aW9uIG9iamVjdFNpemUob2JqKSB7CiAgICByZXR1cm4gZ2V0S2V5c1dpdGhPYmplY3RDb2VyY2lvbihvYmopLmxlbmd0aDsKICB9CgogIGZ1bmN0aW9uIGdldEtleXNXaXRoT2JqZWN0Q29lcmNpb24ob2JqKSB7CiAgICByZXR1cm4gZ2V0S2V5cyhjb2VyY2VQcmltaXRpdmVUb09iamVjdChvYmopKTsKICB9CgogIGZ1bmN0aW9uIGdldFZhbHVlcyhvYmopIHsKICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgIGZvckVhY2hQcm9wZXJ0eShvYmosIGZ1bmN0aW9uKHZhbCkgewogICAgICB2YWx1ZXMucHVzaCh2YWwpOwogICAgfSk7CiAgICByZXR1cm4gdmFsdWVzOwogIH0KCiAgZnVuY3Rpb24gdGFwKG9iaiwgYXJnKSB7CiAgICB2YXIgZm4gPSBhcmc7CiAgICBpZiAoIWlzRnVuY3Rpb24oYXJnKSkgewogICAgICBmbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChhcmcpIG9ialthcmddKCk7CiAgICAgIH07CiAgICB9CiAgICBmbi5jYWxsKG9iaiwgb2JqKTsKICAgIHJldHVybiBvYmo7CiAgfQoKICAvLyBTZWxlY3QvUmVqZWN0CgogIGZ1bmN0aW9uIG9iamVjdFNlbGVjdChvYmosIGYpIHsKICAgIHJldHVybiBzZWxlY3RGcm9tT2JqZWN0KG9iaiwgZiwgdHJ1ZSk7CiAgfQoKICBmdW5jdGlvbiBvYmplY3RSZWplY3Qob2JqLCBmKSB7CiAgICByZXR1cm4gc2VsZWN0RnJvbU9iamVjdChvYmosIGYsIGZhbHNlKTsKICB9CgogIGZ1bmN0aW9uIHNlbGVjdEZyb21PYmplY3Qob2JqLCBmLCBzZWxlY3QpIHsKICAgIHZhciBtYXRjaCwgcmVzdWx0ID0ge307CiAgICBmID0gW10uY29uY2F0KGYpOwogICAgZm9yRWFjaFByb3BlcnR5KG9iaiwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAgbWF0Y2ggPSBmYWxzZTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKG1hdGNoSW5PYmplY3QoZltpXSwga2V5KSkgewogICAgICAgICAgbWF0Y2ggPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobWF0Y2ggPT09IHNlbGVjdCkgewogICAgICAgIHJlc3VsdFtrZXldID0gdmFsOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBtYXRjaEluT2JqZWN0KG1hdGNoLCBrZXkpIHsKICAgIGlmIChpc1JlZ0V4cChtYXRjaCkpIHsKICAgICAgcmV0dXJuIG1hdGNoLnRlc3Qoa2V5KTsKICAgIH0gZWxzZSBpZiAoaXNPYmplY3RUeXBlKG1hdGNoKSkgewogICAgICByZXR1cm4ga2V5IGluIG1hdGNoOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGtleSA9PT0gU3RyaW5nKG1hdGNoKTsKICAgIH0KICB9CgogIC8vIFJlbW92ZS9FeGNsdWRlCgogIGZ1bmN0aW9uIG9iamVjdFJlbW92ZShvYmosIGYpIHsKICAgIHZhciBtYXRjaGVyID0gZ2V0TWF0Y2hlcihmKTsKICAgIGZvckVhY2hQcm9wZXJ0eShvYmosIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgIGlmIChtYXRjaGVyKHZhbCwga2V5LCBvYmopKSB7CiAgICAgICAgZGVsZXRlIG9ialtrZXldOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfQoKICBmdW5jdGlvbiBvYmplY3RFeGNsdWRlKG9iaiwgZikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIG1hdGNoZXIgPSBnZXRNYXRjaGVyKGYpOwogICAgZm9yRWFjaFByb3BlcnR5KG9iaiwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAgaWYgKCFtYXRjaGVyKHZhbCwga2V5LCBvYmopKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSB2YWw7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIG9iamVjdEludGVyc2VjdE9yU3VidHJhY3Qob2JqMSwgb2JqMiwgc3VidHJhY3QpIHsKICAgIGlmICghaXNPYmplY3RUeXBlKG9iajEpKSB7CiAgICAgIHJldHVybiBzdWJ0cmFjdCA/IG9iajEgOiB7fTsKICAgIH0KICAgIG9iajIgPSBjb2VyY2VQcmltaXRpdmVUb09iamVjdChvYmoyKTsKICAgIGZ1bmN0aW9uIHJlc29sdmUoa2V5LCB2YWwsIHZhbDEpIHsKICAgICAgdmFyIGV4aXN0cyA9IGtleSBpbiBvYmoyICYmIGlzRXF1YWwodmFsMSwgb2JqMltrZXldKTsKICAgICAgaWYgKGV4aXN0cyAhPT0gc3VidHJhY3QpIHsKICAgICAgICByZXR1cm4gdmFsMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iamVjdE1lcmdlKHt9LCBvYmoxLCBmYWxzZSwgcmVzb2x2ZSk7CiAgfQoKICAvKioqCiAgICogQG1ldGhvZCBpc1tUeXBlXSgpCiAgICogQHJldHVybnMgQm9vbGVhbgogICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgdGhlIG9iamVjdCBpcyBhbiBvYmplY3Qgb2YgdGhhdCB0eXBlLgogICAqCiAgICogQHNldAogICAqICAgaXNBcnJheQogICAqICAgaXNCb29sZWFuCiAgICogICBpc0RhdGUKICAgKiAgIGlzRXJyb3IKICAgKiAgIGlzRnVuY3Rpb24KICAgKiAgIGlzTWFwCiAgICogICBpc051bWJlcgogICAqICAgaXNSZWdFeHAKICAgKiAgIGlzU2V0CiAgICogICBpc1N0cmluZwogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgT2JqZWN0LmlzQXJyYXkoWzNdKSAtPiB0cnVlCiAgICogICBPYmplY3QuaXNOdW1iZXIoMykgIC0+IHRydWUKICAgKiAgIE9iamVjdC5pc1N0cmluZyg4KSAgLT4gZmFsc2UKICAgKgogICAqKiovCiAgZnVuY3Rpb24gYnVpbGRDbGFzc0NoZWNrTWV0aG9kcygpIHsKICAgIHZhciBjaGVja3MgPSBbaXNCb29sZWFuLCBpc051bWJlciwgaXNTdHJpbmcsIGlzRGF0ZSwgaXNSZWdFeHAsIGlzRnVuY3Rpb24sIGlzQXJyYXksIGlzRXJyb3IsIGlzU2V0LCBpc01hcF07CiAgICBkZWZpbmVJbnN0YW5jZUFuZFN0YXRpY1NpbWlsYXIoc3VnYXJPYmplY3QsIE5BVElWRV9UWVBFUywgZnVuY3Rpb24obWV0aG9kcywgbmFtZSwgaSkgewogICAgICBtZXRob2RzWydpcycgKyBuYW1lXSA9IGNoZWNrc1tpXTsKICAgIH0pOwogIH0KCiAgZGVmaW5lU3RhdGljKHN1Z2FyT2JqZWN0LCB7CgogICAgLyoqKgogICAgICogQG1ldGhvZCBmcm9tUXVlcnlTdHJpbmcoc3RyLCBbb3B0aW9uc10pCiAgICAgKiBAcmV0dXJucyBPYmplY3QKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaG9ydCBDb252ZXJ0cyB0aGUgcXVlcnkgc3RyaW5nIG9mIGEgVVJMIGludG8gYW4gb2JqZWN0LgogICAgICogQGV4dHJhIE9wdGlvbnMgY2FuIGJlIHBhc3NlZCB3aXRoIFtvcHRpb25zXSBmb3IgbW9yZSBjb250cm9sIG92ZXIgdGhlIHJlc3VsdC4KICAgICAqCiAgICAgKiBAb3B0aW9ucwogICAgICoKICAgICAqICAgZGVlcCAgICAgICAgSWYgdGhlIHN0cmluZyBjb250YWlucyAiZGVlcCIgc3ludGF4IGBmb29bXWAsIHRoaXMgd2lsbAogICAgICogICAgICAgICAgICAgICBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJheS4gKERlZmF1bHQgYGZhbHNlYCkKICAgICAqCiAgICAgKiAgIGF1dG8gICAgICAgIElmIGB0cnVlYCwgYm9vbGVhbnMgYCJ0cnVlImAgYW5kIGAiZmFsc2UiYCwgbnVtYmVycywgYW5kIGFycmF5cwogICAgICogICAgICAgICAgICAgICAocmVwZWF0ZWQga2V5cykgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IGNhc3QgdG8gbmF0aXZlCiAgICAgKiAgICAgICAgICAgICAgIHZhbHVlcy4gKERlZmF1bHQgYHRydWVgKQogICAgICoKICAgICAqICAgdHJhbnNmb3JtICAgQSBmdW5jdGlvbiB3aG9zZSByZXR1cm4gdmFsdWUgYmVjb21lcyB0aGUgZmluYWwgdmFsdWUuIElmCiAgICAgKiAgICAgICAgICAgICAgIHRoZSBmdW5jdGlvbiByZXR1cm5zIGB1bmRlZmluZWRgLCB0aGVuIHRoZSBvcmlnaW5hbCB2YWx1ZQogICAgICogICAgICAgICAgICAgICB3aWxsIGJlIHVzZWQuIFRoaXMgYWxsb3dzIHRoZSBmdW5jdGlvbiB0byBpbnRlcmNlcHQgb25seQogICAgICogICAgICAgICAgICAgICBjZXJ0YWluIGtleXMgb3IgdmFsdWVzLiAoRGVmYXVsdCBgdW5kZWZpbmVkYCkKICAgICAqCiAgICAgKiAgIHNlcGFyYXRvciAgIElmIHBhc3NlZCwga2V5cyB3aWxsIGJlIHNwbGl0IG9uIHRoaXMgc3RyaW5nIHRvIGV4dHJhY3QKICAgICAqICAgICAgICAgICAgICAgZGVlcCB2YWx1ZXMuIChEZWZhdWx0IGAnJ2ApCiAgICAgKgogICAgICogQGNhbGxiYWNrIHF1ZXJ5U3RyaW5nVHJhbnNmb3JtRm4KICAgICAqCiAgICAgKiAgIGtleSAgIFRoZSBrZXkgY29tcG9uZW50IG9mIHRoZSBxdWVyeSBzdHJpbmcgKGJlZm9yZSBgPWApLgogICAgICogICB2YWwgICBUaGUgdmFsdWUgY29tcG9uZW50IG9mIHRoZSBxdWVyeSBzdHJpbmcgKGFmdGVyIGA9YCkuCiAgICAgKiAgIG9iaiAgIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QgYmVpbmcgYnVpbHQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5mcm9tUXVlcnlTdHJpbmcoJ2E9MSZiPTInKSAgICAgICAgICAgICAgICAgLT4ge2E6MSxiOjJ9CiAgICAgKiAgIE9iamVjdC5mcm9tUXVlcnlTdHJpbmcoJ2FbXT0xJmFbXT0yJyx7ZGVlcDp0cnVlfSkgLT4ge2E6WycxJywnMiddfQogICAgICogICBPYmplY3QuZnJvbVF1ZXJ5U3RyaW5nKCdhX2I9Yycse3NlcGFyYXRvcjonXyd9KSAgIC0+IHthOntiOidjJ319CiAgICAgKiAgIE9iamVjdC5mcm9tUXVlcnlTdHJpbmcoJ2lkPTEyMycsIHt0cmFuc2Zvcm06aWRUb051bWJlcn0pOwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHIKICAgICAqIEBwYXJhbSB7UXVlcnlTdHJpbmdQYXJzZU9wdGlvbnN9IG9wdGlvbnMKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtPYmplY3R9IG9iagogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3UHJvcGVydHl9IHF1ZXJ5U3RyaW5nVHJhbnNmb3JtRm4KICAgICAqIEBvcHRpb24ge2Jvb2xlYW59IFtkZWVwXQogICAgICogQG9wdGlvbiB7Ym9vbGVhbn0gW2F1dG9dCiAgICAgKiBAb3B0aW9uIHtzdHJpbmd9IFtzZXBhcmF0b3JdCiAgICAgKiBAb3B0aW9uIHtxdWVyeVN0cmluZ1RyYW5zZm9ybUZufSBbdHJhbnNmb3JtXQogICAgICoKICAgICAqKiovCiAgICAnZnJvbVF1ZXJ5U3RyaW5nJzogZnVuY3Rpb24ob2JqLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiBmcm9tUXVlcnlTdHJpbmdXaXRoT3B0aW9ucyhvYmosIG9wdGlvbnMpOwogICAgfQoKICB9KTsKCiAgZGVmaW5lSW5zdGFuY2VBbmRTdGF0aWMoc3VnYXJPYmplY3QsIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGhhcyhrZXksIFtpbmhlcml0ZWRdID0gZmFsc2UpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgQ2hlY2tzIGlmIHRoZSBvYmplY3QgaGFzIHByb3BlcnR5IGBrZXlgLgogICAgICogQGV4dHJhIFN1cHBvcnRzIGBkZWVwIHByb3BlcnRpZXNgLiBJZiBbaW5oZXJpdGVkXSBpcyBgdHJ1ZWAsCiAgICAgKiAgICAgICAgcHJvcGVydGllcyBkZWZpbmVkIGluIHRoZSBwcm90b3R5cGUgY2hhaW4gd2lsbCBhbHNvIHJldHVybiBgdHJ1ZWAuCiAgICAgKiAgICAgICAgVGhlIGRlZmF1bHQgb2YgYGZhbHNlYCBmb3IgdGhpcyBhcmd1bWVudCBtYWtlcyB0aGlzIG1ldGhvZCBzdWl0ZWQKICAgICAqICAgICAgICB0byB3b3JraW5nIHdpdGggb2JqZWN0cyBhcyBkYXRhIHN0b3JlcyBieSBkZWZhdWx0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuaGFzKHVzZXJzQnlOYW1lLCAnSGFycnknKSAgICAgLT4gdHJ1ZQogICAgICogICBPYmplY3QuaGFzKGRhdGEsICd1c2Vyc1sxXS5wcm9maWxlJykgLT4gdHJ1ZQogICAgICogICBPYmplY3QuaGFzKFtdLCAnZm9yRWFjaCcpICAgICAgICAgICAgLT4gZmFsc2UKICAgICAqICAgT2JqZWN0LmhhcyhbXSwgJ2ZvckVhY2gnLCB0cnVlKSAgICAgIC0+IHRydWUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5CiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpbmhlcml0ZWRdCiAgICAgKgogICAgICoqKi8KICAgICdoYXMnOiBmdW5jdGlvbihvYmosIGtleSwgYW55KSB7CiAgICAgIHJldHVybiBkZWVwSGFzUHJvcGVydHkob2JqLCBrZXksIGFueSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZ2V0KGtleSwgW2luaGVyaXRlZF0gPSBmYWxzZSkKICAgICAqIEByZXR1cm5zIE1peGVkCiAgICAgKiBAc2hvcnQgR2V0cyBhIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuCiAgICAgKiBAZXh0cmEgU3VwcG9ydHMgYGRlZXAgcHJvcGVydGllc2AuIElmIFtpbmhlcml0ZWRdIGlzIGB0cnVlYCwKICAgICAqICAgICAgICBwcm9wZXJ0aWVzIGRlZmluZWQgaW4gdGhlIHByb3RvdHlwZSBjaGFpbiB3aWxsIGFsc28gYmUgcmV0dXJuZWQuCiAgICAgKiAgICAgICAgVGhlIGRlZmF1bHQgb2YgYGZhbHNlYCBmb3IgdGhpcyBhcmd1bWVudCBtYWtlcyB0aGlzIG1ldGhvZCBzdWl0ZWQKICAgICAqICAgICAgICB0byB3b3JraW5nIHdpdGggb2JqZWN0cyBhcyBkYXRhIHN0b3JlcyBieSBkZWZhdWx0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuZ2V0KEhhcnJ5LCAnbmFtZScpOyAgICAgICAgICAgLT4gJ0hhcnJ5JwogICAgICogICBPYmplY3QuZ2V0KEhhcnJ5LCAncHJvZmlsZS5saWtlcycpOyAgLT4gSGFycnkncyBsaWtlcwogICAgICogICBPYmplY3QuZ2V0KGRhdGEsICd1c2Vyc1szXS5uYW1lJykgICAgLT4gVXNlciAzJ3MgbmFtZQogICAgICogICBPYmplY3QuZ2V0KGRhdGEsICd1c2Vyc1sxLi4yXScpICAgICAgLT4gVXNlcnMgMSBhbmQgMgogICAgICogICBPYmplY3QuZ2V0KGRhdGEsICd1c2Vyc1sxLi4yXS5uYW1lJykgLT4gTmFtZXMgb2YgdXNlcnMgMSBhbmQgMgogICAgICogICBPYmplY3QuZ2V0KGRhdGEsICd1c2Vyc1stMi4uLTFdJykgICAgLT4gTGFzdCAyIHVzZXJzCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleQogICAgICogQHBhcmFtIHtib29sZWFufSBbaW5oZXJpdGVkXQogICAgICoKICAgICAqKiovCiAgICAnZ2V0JzogZnVuY3Rpb24ob2JqLCBrZXksIGFueSkgewogICAgICByZXR1cm4gZGVlcEdldFByb3BlcnR5KG9iaiwga2V5LCBhbnkpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHNldChrZXksIHZhbCkKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IFNldHMgYSBwcm9wZXJ0eSBvbiB0aGUgb2JqZWN0LgogICAgICogQGV4dHJhIFVzaW5nIGEgZG90IG9yIHNxdWFyZSBicmFja2V0IGluIGBrZXlgIGlzIGNvbnNpZGVyZWQgImRlZXAiIHN5bnRheCwKICAgICAqICAgICAgICBhbmQgd2lsbCBhdHRlbXB0IHRvIHRyYXZlcnNlIGludG8gdGhlIG9iamVjdCB0byBzZXQgdGhlIHByb3BlcnR5LAogICAgICogICAgICAgIGNyZWF0aW5nIHByb3BlcnRpZXMgdGhhdCBkbyBub3QgZXhpc3QgYWxvbmcgdGhlIHdheS4gSWYgdGhlIG1pc3NpbmcKICAgICAqICAgICAgICBwcm9wZXJ0eSBpcyByZWZlcmVuY2VkIHVzaW5nIHNxdWFyZSBicmFja2V0cywgYW4gZW1wdHkgYXJyYXkgd2lsbCBiZQogICAgICogICAgICAgIGNyZWF0ZWQsIG90aGVyd2lzZSBhbiBlbXB0eSBvYmplY3QuIEEgc3BlY2lhbCBgW11gIGNhcnJpZXMgdGhlCiAgICAgKiAgICAgICAgbWVhbmluZyBvZiAidGhlIGxhc3QgaW5kZXggKyAxIiwgYW5kIHdpbGwgZWZmZWN0aXZlbHkgcHVzaCBgdmFsYAogICAgICogICAgICAgIG9udG8gdGhlIGVuZCBvZiB0aGUgYXJyYXkuIExhc3RseSwgYSBgLi5gIHNlcGFyYXRvciBpbnNpZGUgdGhlCiAgICAgKiAgICAgICAgYnJhY2tldHMgaXMgInJhbmdlIiBub3RhdGlvbiwgYW5kIHdpbGwgc2V0IHByb3BlcnRpZXMgb24gYWxsCiAgICAgKiAgICAgICAgZWxlbWVudHMgaW4gdGhlIHNwZWNpZmllZCByYW5nZS4gUmFuZ2UgbWVtYmVycyBtYXkgYmUgbmVnYXRpdmUsCiAgICAgKiAgICAgICAgd2hpY2ggd2lsbCBiZSBvZmZzZXQgZnJvbSB0aGUgZW5kIG9mIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LnNldCh7fSwgJ25hbWUnLCAnSGFycnknKTsgICAgICAgICAtPiB7bmFtZTonSGFycnknfQogICAgICogICBPYmplY3Quc2V0KHt9LCAndXNlci5uYW1lJywgJ0hhcnJ5Jyk7ICAgIC0+IHt1c2VyOntuYW1lOidIYXJyeSd9fQogICAgICogICBPYmplY3Quc2V0KHt9LCAndXNlcnNbXS5uYW1lJywgJ0JvYicpICAgIC0+IHt1c2Vyczpbe25hbWU6J0JvYid9fQogICAgICogICBPYmplY3Quc2V0KHt9LCAndXNlcnNbMV0ubmFtZScsJ0JvYicpICAgIC0+IHt1c2VyczpbdW5kZWZpbmVkLCB7bmFtZTonQm9iJ31dfQogICAgICogICBPYmplY3Quc2V0KHt9LCAndXNlcnNbMC4uMV0ubmFtZScsJ0JvYicpIC0+IHt1c2Vyczpbe25hbWU6J0JvYid9LHtuYW1lOidCb2InfV19CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleQogICAgICogQHBhcmFtIHtQcm9wZXJ0eX0gdmFsCiAgICAgKgogICAgICoqKi8KICAgICdzZXQnOiBmdW5jdGlvbihvYmosIGtleSwgdmFsKSB7CiAgICAgIHJldHVybiBkZWVwU2V0UHJvcGVydHkob2JqLCBrZXksIHZhbCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2Qgc2l6ZSgpCiAgICAgKiBAcmV0dXJucyBOdW1iZXIKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBudW1iZXIgb2YgcHJvcGVydGllcyBpbiB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3Quc2l6ZSh7Zm9vOidiYXInfSkgLT4gMQogICAgICoKICAgICAqKiovCiAgICAnc2l6ZSc6IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gb2JqZWN0U2l6ZShvYmopOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGlzRW1wdHkoKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgaW4gdGhlIG9iamVjdCBpcyB6ZXJvLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuaXNFbXB0eSh7fSkgICAgLT4gdHJ1ZQogICAgICogICBPYmplY3QuaXNFbXB0eSh7YToxfSkgLT4gZmFsc2UKICAgICAqCiAgICAgKioqLwogICAgJ2lzRW1wdHknOiBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIG9iamVjdFNpemUob2JqKSA9PT0gMDsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCB0b1F1ZXJ5U3RyaW5nKFtvcHRpb25zXSkKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IENvbnZlcnRzIHRoZSBvYmplY3QgaW50byBhIHF1ZXJ5IHN0cmluZy4KICAgICAqIEBleHRyYSBBY2NlcHRzIGRlZXAgb2JqZWN0cyBhbmQgYXJyYXlzLiBbb3B0aW9uc10gY2FuIGJlIHBhc3NlZCBmb3IgbW9yZQogICAgICogICAgICAgIGNvbnRyb2wgb3ZlciB0aGUgcmVzdWx0LgogICAgICoKICAgICAqIEBvcHRpb25zCiAgICAgKgogICAgICogICBkZWVwICAgICAgICBJZiBgdHJ1ZWAsIG5vbi1zdGFuZGFyZCAiZGVlcCIgc3ludGF4IGBmb29bXWAgd2lsbCBiZQogICAgICogICAgICAgICAgICAgICB1c2VkIGZvciBvdXRwdXQuIE5vdGUgdGhhdCBgc2VwYXJhdG9yYCB3aWxsIGJlIGlnbm9yZWQsCiAgICAgKiAgICAgICAgICAgICAgIGFzIHRoaXMgb3B0aW9uIG92ZXJyaWRlcyBzaGFsbG93IHN5bnRheC4gKERlZmF1bHQgYGZhbHNlYCkKICAgICAqCiAgICAgKiAgIHByZWZpeCAgICAgIElmIHBhc3NlZCwgdGhpcyBzdHJpbmcgd2lsbCBiZSBwcmVmaXhlZCB0byBhbGwga2V5cywKICAgICAqICAgICAgICAgICAgICAgc2VwYXJhdGVkIGJ5IHRoZSBgc2VwYXJhdG9yYC4gKERlZmF1bHQgYCcnYCkuCiAgICAgKgogICAgICogICB0cmFuc2Zvcm0gICBBIGZ1bmN0aW9uIHdob3NlIHJldHVybiB2YWx1ZSBiZWNvbWVzIHRoZSBmaW5hbCB2YWx1ZQogICAgICogICAgICAgICAgICAgICBpbiB0aGUgc3RyaW5nLiAoRGVmYXVsdCBgdW5kZWZpbmVkYCkKICAgICAqCiAgICAgKiAgIHNlcGFyYXRvciAgIEEgc3RyaW5nIHRoYXQgaXMgdXNlZCB0byBzZXBhcmF0ZSBrZXlzLCBlaXRoZXIgZm9yIGRlZXAKICAgICAqICAgICAgICAgICAgICAgb2JqZWN0cywgb3Igd2hlbiBgcHJlZml4YCBpcyBwYXNzZWQuKERlZmF1bHQgYF9gKS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgcXVlcnlTdHJpbmdUcmFuc2Zvcm1GbgogICAgICoKICAgICAqICAga2V5ICBUaGUga2V5IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgdmFsICBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBvYmogIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHtmb286J2Jhcid9KSAgICAgICAgICAgICAgICAgIC0+ICdmb289YmFyJwogICAgICogICBPYmplY3QudG9RdWVyeVN0cmluZyh7Zm9vOlsnYScsJ2InXX0pICAgICAgICAgICAgICAtPiAnZm9vPWEmZm9vPWInCiAgICAgKiAgIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHtmb286WydhJywnYiddfSwge2RlZXA6dHJ1ZX0pIC0+ICdmb29bXT1hJmZvb1tdPWInCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iagogICAgICogQHBhcmFtIHtRdWVyeVN0cmluZ09wdGlvbnN9IFtvcHRpb25zXQogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30ga2V5CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UHJvcGVydHl9IHZhbAogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtOZXdQcm9wZXJ0eX0gcXVlcnlTdHJpbmdUcmFuc2Zvcm1GbgogICAgICogQG9wdGlvbiB7Ym9vbGVhbn0gW2RlZXBdCiAgICAgKiBAb3B0aW9uIHtzdHJpbmd9IFtwcmVmaXhdCiAgICAgKiBAb3B0aW9uIHtzdHJpbmd9IFtzZXBhcmF0b3JdCiAgICAgKiBAb3B0aW9uIHtxdWVyeVN0cmluZ1RyYW5zZm9ybUZufSBbdHJhbnNmb3JtXQogICAgICoKICAgICAqKiovCiAgICAndG9RdWVyeVN0cmluZyc6IGZ1bmN0aW9uKG9iaiwgb3B0aW9ucykgewogICAgICByZXR1cm4gdG9RdWVyeVN0cmluZ1dpdGhPcHRpb25zKG9iaiwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaXNFcXVhbChvYmopCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIGBvYmpgIGlzIGVxdWl2YWxlbnQgdG8gdGhlIG9iamVjdC4KICAgICAqIEBleHRyYSBJZiBib3RoIG9iamVjdHMgYXJlIGJ1aWx0LWluIHR5cGVzLCB0aGV5IHdpbGwgYmUgY29uc2lkZXJlZAogICAgICogICAgICAgIGVxdWl2YWxlbnQgaWYgdGhleSBhcmUgbm90ICJvYnNlcnZhYmx5IGRpc3Rpbmd1aXNoYWJsZSIuIFRoaXMgbWVhbnMKICAgICAqICAgICAgICB0aGF0IHByaW1pdGl2ZXMgYW5kIG9iamVjdCB0eXBlcywgYDBgIGFuZCBgLTBgLCBhbmQgc3BhcnNlIGFuZAogICAgICogICAgICAgIGRlbnNlIGFycmF5cyBhcmUgYWxsIG5vdCBlcXVhbC4gRnVuY3Rpb25zIGFuZCBub24tYnVpbHQtaW5zIGxpa2UKICAgICAqICAgICAgICBpbnN0YW5jZXMgb2YgdXNlci1kZWZpbmVkIGNsYXNzZXMgYW5kIGhvc3Qgb2JqZWN0cyBsaWtlIEVsZW1lbnQgYW5kCiAgICAgKiAgICAgICAgRXZlbnQgYXJlIHN0cmljdGx5IGNvbXBhcmVkIGA9PT1gLCBhbmQgd2lsbCBvbmx5IGJlIGVxdWFsIGlmIHRoZXkKICAgICAqICAgICAgICBhcmUgdGhlIHNhbWUgcmVmZXJlbmNlLiBQbGFpbiBvYmplY3RzIGFzIHdlbGwgYXMgQXJyYXlzIHdpbGwgYmUKICAgICAqICAgICAgICB0cmF2ZXJzZWQgaW50byBhbmQgZGVlcGx5IGNoZWNrZWQgYnkgdGhlaXIgbm9uLWluaGVyaXRlZCwgZW51bWVyYWJsZQogICAgICogICAgICAgIHByb3BlcnRpZXMuIE90aGVyIGFsbG93ZWQgdHlwZXMgaW5jbHVkZSBUeXBlZCBBcnJheXMsIFNldHMsIE1hcHMsCiAgICAgKiAgICAgICAgQXJndW1lbnRzLCBEYXRlcywgUmVnZXhlcywgYW5kIEVycm9ycy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LmlzRXF1YWwoe2E6Mn0sIHthOjJ9KSAgICAgICAgIC0+IHRydWUKICAgICAqICAgT2JqZWN0LmlzRXF1YWwoe2E6Mn0sIHthOjN9KSAgICAgICAgIC0+IGZhbHNlCiAgICAgKiAgIE9iamVjdC5pc0VxdWFsKDUsIE9iamVjdCg1KSkgICAgICAgICAtPiBmYWxzZQogICAgICogICBPYmplY3QuaXNFcXVhbChPYmplY3QoNSksIE9iamVjdCg1KSkgLT4gdHJ1ZQogICAgICogICBPYmplY3QuaXNFcXVhbChOYU4sIE5hTikgICAgICAgICAgICAgLT4gZmFsc2UKICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqCiAgICAgKgogICAgICoqKi8KICAgICdpc0VxdWFsJzogZnVuY3Rpb24ob2JqMSwgb2JqMikgewogICAgICByZXR1cm4gaXNFcXVhbChvYmoxLCBvYmoyKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBtZXJnZShzb3VyY2UsIFtvcHRpb25zXSkKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IE1lcmdlcyBwcm9wZXJ0aWVzIGZyb20gYHNvdXJjZWAgaW50byB0aGUgb2JqZWN0LgogICAgICogQGV4dHJhIFRoaXMgbWV0aG9kIHdpbGwgbW9kaWZ5IHRoZSBvYmplY3QhIFVzZSBgYWRkYCBmb3IgYSBub24tZGVzdHJ1Y3RpdmUKICAgICAqICAgICAgICBhbGlhcy4KICAgICAqCiAgICAgKiBAb3B0aW9ucwogICAgICoKICAgICAqICAgZGVlcCAgICAgICAgIElmIGB0cnVlYCBkZWVwIHByb3BlcnRpZXMgYXJlIG1lcmdlZCByZWN1cnNpdmVseS4KICAgICAqICAgICAgICAgICAgICAgIChEZWZhdWx0IGBmYWxzZWApCiAgICAgKgogICAgICogICBoaWRkZW4gICAgICAgSWYgYHRydWVgLCBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzIHdpbGwgYmUgbWVyZ2VkIGFzIHdlbGwuCiAgICAgKiAgICAgICAgICAgICAgICAoRGVmYXVsdCBgZmFsc2VgKQogICAgICoKICAgICAqICAgZGVzY3JpcHRvciAgIElmIGB0cnVlYCwgcHJvcGVydGllcyB3aWxsIGJlIG1lcmdlZCBieSBwcm9wZXJ0eSBkZXNjcmlwdG9yLgogICAgICogICAgICAgICAgICAgICAgVXNlIHRoaXMgb3B0aW9uIHRvIG1lcmdlIGdldHRlcnMgb3Igc2V0dGVycywgb3IgdG8gcHJlc2VydmUKICAgICAqICAgICAgICAgICAgICAgIGBlbnVtZXJhYmxlYCwgYGNvbmZpZ3VyYWJsZWAsIGV0Yy4KICAgICAqICAgICAgICAgICAgICAgIChEZWZhdWx0IGBmYWxzZWApCiAgICAgKgogICAgICogICByZXNvbHZlICAgICAgRGV0ZXJtaW5lcyB3aGljaCBwcm9wZXJ0eSB3aW5zIGluIHRoZSBjYXNlIG9mIGNvbmZsaWN0cy4KICAgICAqICAgICAgICAgICAgICAgIElmIGB0cnVlYCwgYHNvdXJjZWAgd2lucy4gSWYgYGZhbHNlYCwgdGhlIG9yaWdpbmFsIHByb3BlcnR5IHdpbnMuCiAgICAgKiAgICAgICAgICAgICAgICBJZiBhIGZ1bmN0aW9uIGlzIHBhc3NlZCwgaXRzIHJldHVybiB2YWx1ZSB3aWxsIGRlY2lkZSB0aGUgcmVzdWx0LgogICAgICogICAgICAgICAgICAgICAgQW55IG5vbi11bmRlZmluZWQgcmV0dXJuIHZhbHVlIHdpbGwgcmVzb2x2ZSB0aGUgY29uZmxpY3QKICAgICAqICAgICAgICAgICAgICAgIGZvciB0aGF0IHByb3BlcnR5ICh3aWxsIG5vdCBjb250aW51ZSBpZiBgZGVlcGApLiBSZXR1cm5pbmcKICAgICAqICAgICAgICAgICAgICAgIGB1bmRlZmluZWRgIHdpbGwgZG8gbm90aGluZyAobm8gbWVyZ2UpLiBGaW5hbGx5LCByZXR1cm5pbmcKICAgICAqICAgICAgICAgICAgICAgIHRoZSBnbG9iYWwgb2JqZWN0IGBTdWdhcmAgd2lsbCBhbGxvdyBTdWdhciB0byBoYW5kbGUgdGhlCiAgICAgKiAgICAgICAgICAgICAgICBtZXJnZSBhcyBub3JtYWwuIChEZWZhdWx0IGB0cnVlYCkKICAgICAqCiAgICAgKiBAY2FsbGJhY2sgcmVzb2x2ZUZuCiAgICAgKgogICAgICogICBrZXkgICAgICAgIFRoZSBrZXkgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICB0YXJnZXRWYWwgIFRoZSBjdXJyZW50IHZhbHVlIGZvciB0aGUga2V5IGluIHRoZSB0YXJnZXQuCiAgICAgKiAgIHNvdXJjZVZhbCAgVGhlIGN1cnJlbnQgdmFsdWUgZm9yIHRoZSBrZXkgaW4gYHNvdXJjZWAuCiAgICAgKiAgIHRhcmdldCAgICAgVGhlIHRhcmdldCBvYmplY3QuCiAgICAgKiAgIHNvdXJjZSAgICAgVGhlIHNvdXJjZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5tZXJnZSh7b25lOjF9LHt0d286Mn0pICAgICAgICAgICAgICAgICAtPiB7b25lOjEsdHdvOjJ9CiAgICAgKiAgIE9iamVjdC5tZXJnZSh7b25lOjF9LHtvbmU6OSx0d286Mn0pICAgICAgICAgICAtPiB7b25lOjksdHdvOjJ9CiAgICAgKiAgIE9iamVjdC5tZXJnZSh7eDp7YToxfX0se3g6e2I6Mn19LHtkZWVwOnRydWV9KSAtPiB7eDp7YToxLGI6Mn19CiAgICAgKiAgIE9iamVjdC5tZXJnZSh7YToxfSx7YToyfSx7cmVzb2x2ZTptZXJnZUFkZH0pICAtPiB7YTozfQogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UKICAgICAqIEBwYXJhbSB7T2JqZWN0TWVyZ2VPcHRpb25zfSBbb3B0aW9uc10KICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB0YXJnZXRWYWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtQcm9wZXJ0eX0gc291cmNlVmFsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7T2JqZWN0fSB0YXJnZXQKICAgICAqIEBjYWxsYmFja1BhcmFtIHtPYmplY3R9IHNvdXJjZQogICAgICogQGNhbGxiYWNrUmV0dXJucyB7Ym9vbGVhbn0gcmVzb2x2ZUZuCiAgICAgKiBAb3B0aW9uIHtib29sZWFufSBbZGVlcF0KICAgICAqIEBvcHRpb24ge2Jvb2xlYW59IFtoaWRkZW5dCiAgICAgKiBAb3B0aW9uIHtib29sZWFufSBbZGVzY3JpcHRvcl0KICAgICAqIEBvcHRpb24ge2Jvb2xlYW58cmVzb2x2ZUZufSBbcmVzb2x2ZV0KICAgICAqCiAgICAgKioqLwogICAgJ21lcmdlJzogZnVuY3Rpb24odGFyZ2V0LCBzb3VyY2UsIG9wdHMpIHsKICAgICAgcmV0dXJuIG1lcmdlV2l0aE9wdGlvbnModGFyZ2V0LCBzb3VyY2UsIG9wdHMpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGFkZChvYmosIFtvcHRpb25zXSkKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IEFkZHMgcHJvcGVydGllcyBpbiBgb2JqYCBhbmQgcmV0dXJucyBhIG5ldyBvYmplY3QuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2Qgd2lsbCBub3QgbW9kaWZ5IHRoZSBvcmlnaW5hbCBvYmplY3QuIFNlZSBgbWVyZ2VgIGZvciBvcHRpb25zLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuYWRkKHtvbmU6MX0se3R3bzoyfSkgICAgICAgICAgICAgICAgIC0+IHtvbmU6MSx0d286Mn0KICAgICAqICAgT2JqZWN0LmFkZCh7b25lOjF9LHtvbmU6OSx0d286Mn0pICAgICAgICAgICAtPiB7b25lOjksdHdvOjJ9CiAgICAgKiAgIE9iamVjdC5hZGQoe3g6e2E6MX19LHt4OntiOjJ9fSx7ZGVlcDp0cnVlfSkgLT4ge3g6e2E6MSxiOjJ9fQogICAgICogICBPYmplY3QuYWRkKHthOjF9LHthOjJ9LHtyZXNvbHZlOm1lcmdlQWRkfSkgIC0+IHthOjN9CiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iagogICAgICogQHBhcmFtIHtPYmplY3RNZXJnZU9wdGlvbnN9IFtvcHRpb25zXQogICAgICoKICAgICAqKiovCiAgICAnYWRkJzogZnVuY3Rpb24ob2JqMSwgb2JqMiwgb3B0cykgewogICAgICByZXR1cm4gbWVyZ2VXaXRoT3B0aW9ucyhjbG9uZShvYmoxKSwgb2JqMiwgb3B0cyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbWVyZ2VBbGwoc291cmNlcywgW29wdGlvbnNdKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgTWVyZ2VzIHByb3BlcnRpZXMgZnJvbSBhbiBhcnJheSBvZiBgc291cmNlc2AuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2Qgd2lsbCBtb2RpZnkgdGhlIG9iamVjdCEgVXNlIGBhZGRBbGxgIGZvciBhIG5vbi1kZXN0cnVjdGl2ZQogICAgICogICAgICAgIGFsaWFzLiBTZWUgYG1lcmdlYCBmb3Igb3B0aW9ucy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0Lm1lcmdlQWxsKHtvbmU6MX0sW3t0d286Mn0se3RocmVlOjN9XSkgLT4ge29uZToxLHR3bzoyLHRocmVlOjN9CiAgICAgKiAgIE9iamVjdC5tZXJnZUFsbCh7eDp7YToxfX0sW3t4OntiOjJ9fSx7eDp7YzozfX1dLHtkZWVwOnRydWV9KSAtPiB7eDp7YToxLGI6MixjOjN9fQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0Pn0gc291cmNlcwogICAgICogQHBhcmFtIHtPYmplY3RNZXJnZU9wdGlvbnN9IFtvcHRpb25zXQogICAgICoKICAgICAqKiovCiAgICAnbWVyZ2VBbGwnOiBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZXMsIG9wdHMpIHsKICAgICAgcmV0dXJuIG1lcmdlQWxsKHRhcmdldCwgc291cmNlcywgb3B0cyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgYWRkQWxsKHNvdXJjZXMsIFtvcHRpb25zXSkKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IEFkZHMgcHJvcGVydGllcyBmcm9tIGFuIGFycmF5IG9mIGBzb3VyY2VzYCBhbmQgcmV0dXJucyBhIG5ldyBvYmplY3QuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2Qgd2lsbCBub3QgbW9kaWZ5IHRoZSBvYmplY3QuIFNlZSBgbWVyZ2VgIGZvciBvcHRpb25zLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuYWRkQWxsKHtvbmU6MX0sW3t0d286Mn0se3RocmVlOjN9XSkgLT4ge29uZToxLHR3bzoyLHRocmVlOjN9CiAgICAgKiAgIE9iamVjdC5hZGRBbGwoe3g6e2E6MX19LFt7eDp7YjoyfX0se3g6e2M6M319XSx7ZGVlcDp0cnVlfSkgLT4ge3g6e2E6MSxiOjIsYzozfX0KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5PE9iamVjdD59IHNvdXJjZXMKICAgICAqIEBwYXJhbSB7T2JqZWN0TWVyZ2VPcHRpb25zfSBbb3B0aW9uc10KICAgICAqCiAgICAgKioqLwogICAgJ2FkZEFsbCc6IGZ1bmN0aW9uKG9iaiwgc291cmNlcywgb3B0cykgewogICAgICByZXR1cm4gbWVyZ2VBbGwoY2xvbmUob2JqKSwgc291cmNlcywgb3B0cyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZGVmYXVsdHMoc291cmNlcywgW29wdGlvbnNdKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgTWVyZ2VzIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbXVsdGlwbGUgYHNvdXJjZXNgIHdoaWxlIHByZXNlcnZpbmcKICAgICAqICAgICAgICB0aGUgb2JqZWN0J3MgZGVmaW5lZCBwcm9wZXJ0aWVzLgogICAgICogQGV4dHJhIFRoaXMgbWV0aG9kIG1vZGlmaWVzIHRoZSBvYmplY3QhIFNlZSBgbWVyZ2VgIGZvciBvcHRpb25zLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuZGVmYXVsdHMoe29uZToxfSxbe29uZTo5fSx7dHdvOjJ9XSkgICAgICAgICAgICAgICAgICAgLT4ge29uZToxLHR3bzoyfQogICAgICogICBPYmplY3QuZGVmYXVsdHMoe3g6e2E6MX19LFt7eDp7YTo5fX0se3g6e2I6Mn19XSx7ZGVlcDp0cnVlfSkgLT4ge3g6e2E6MSxiOjJ9fQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0Pn0gc291cmNlcwogICAgICogQHBhcmFtIHtPYmplY3RNZXJnZU9wdGlvbnN9IFtvcHRpb25zXQogICAgICoKICAgICAqKiovCiAgICAnZGVmYXVsdHMnOiBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZXMsIG9wdHMpIHsKICAgICAgcmV0dXJuIGRlZmF1bHRzKHRhcmdldCwgc291cmNlcywgb3B0cyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaW50ZXJzZWN0KG9iaikKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IFJldHVybnMgYSBuZXcgb2JqZWN0IHdob3NlIHByb3BlcnRpZXMgYXJlIHRob3NlIHRoYXQgdGhlIG9iamVjdCBoYXMKICAgICAqICAgICAgICBpbiBjb21tb24gYm90aCB3aXRoIGBvYmpgLgogICAgICogQGV4dHJhIElmIGJvdGgga2V5IGFuZCB2YWx1ZSBkbyBub3QgbWF0Y2gsIHRoZW4gdGhlIHByb3BlcnR5IHdpbGwgbm90IGJlIGluY2x1ZGVkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuaW50ZXJzZWN0KHthOidhJ30se2I6J2InfSkgLT4ge30KICAgICAqICAgT2JqZWN0LmludGVyc2VjdCh7YTonYSd9LHthOidiJ30pIC0+IHt9CiAgICAgKiAgIE9iamVjdC5pbnRlcnNlY3Qoe2E6J2EnLGI6J2InfSx7YjonYicsejoneid9KSAtPiB7YjonYid9CiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iagogICAgICoKICAgICAqKiovCiAgICAnaW50ZXJzZWN0JzogZnVuY3Rpb24ob2JqMSwgb2JqMikgewogICAgICByZXR1cm4gb2JqZWN0SW50ZXJzZWN0T3JTdWJ0cmFjdChvYmoxLCBvYmoyLCBmYWxzZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2Qgc3VidHJhY3Qob2JqKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgUmV0dXJucyBhIGNsb25lIG9mIHRoZSBvYmplY3Qgd2l0aCBhbnkgcHJvcGVydGllcyBzaGFyZWQgd2l0aCBgb2JqYCBleGNsdWRlZC4KICAgICAqIEBleHRyYSBJZiBib3RoIGtleSBhbmQgdmFsdWUgZG8gbm90IG1hdGNoLCB0aGVuIHRoZSBwcm9wZXJ0eSB3aWxsIG5vdCBiZSBleGNsdWRlZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LnN1YnRyYWN0KHthOidhJyxiOidiJ30se2I6J2InfSkgLT4ge2E6J2EnfQogICAgICogICBPYmplY3Quc3VidHJhY3Qoe2E6J2EnLGI6J2InfSx7YTonYid9KSAtPiB7YTonYScsYjonYid9CiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iagogICAgICoKICAgICAqKiovCiAgICAnc3VidHJhY3QnOiBmdW5jdGlvbihvYmoxLCBvYmoyKSB7CiAgICAgIHJldHVybiBvYmplY3RJbnRlcnNlY3RPclN1YnRyYWN0KG9iajEsIG9iajIsIHRydWUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGNsb25lKFtkZWVwXSA9IGZhbHNlKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgQ3JlYXRlcyBhIGNsb25lIG9mIHRoZSBvYmplY3QuCiAgICAgKiBAZXh0cmEgRGVmYXVsdCBpcyBhIHNoYWxsb3cgY2xvbmUsIHVubGVzcyBbZGVlcF0gaXMgdHJ1ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LmNsb25lKHtmb286J2Jhcid9KSAgICAgICAtPiBjcmVhdGVzIHNoYWxsb3cgY2xvbmUKICAgICAqICAgT2JqZWN0LmNsb25lKHtmb286J2Jhcid9LCB0cnVlKSAtPiBjcmVhdGVzIGEgZGVlcCBjbG9uZQogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2RlZXBdCiAgICAgKgogICAgICoqKi8KICAgICdjbG9uZSc6IGZ1bmN0aW9uKG9iaiwgZGVlcCkgewogICAgICByZXR1cm4gY2xvbmUob2JqLCBkZWVwKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCB2YWx1ZXMoKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIHZhbHVlcyBpbiB0aGUgb2JqZWN0LgogICAgICogQGV4dHJhIFZhbHVlcyBhcmUgaW4gbm8gcGFydGljdWxhciBvcmRlci4gRG9lcyBub3QgaW5jbHVkZSBpbmhlcml0ZWQgb3IKICAgICAqICAgICAgICBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QudmFsdWVzKHthOidhJyxiOidiJ30pIC0+IFsnYScsJ2InXQogICAgICoKICAgICAqKiovCiAgICAndmFsdWVzJzogZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiBnZXRWYWx1ZXMob2JqKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBpbnZlcnQoW211bHRpXSA9IGZhbHNlKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgQ3JlYXRlcyBhIG5ldyBvYmplY3Qgd2l0aCB0aGUga2V5cyBhbmQgdmFsdWVzIHN3YXBwZWQuCiAgICAgKiBAZXh0cmEgSWYgW211bHRpXSBpcyB0cnVlLCB2YWx1ZXMgd2lsbCBiZSBhbiBhcnJheSBvZiBhbGwga2V5cywgb3RoZXdpc2UKICAgICAqICAgICAgICBjb2xsaXNpb25zIHdpbGwgYmUgb3ZlcndyaXR0ZW4uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5pbnZlcnQoe2ZvbzonYmFyJ30pICAgICAtPiB7YmFyOidmb28nfQogICAgICogICBPYmplY3QuaW52ZXJ0KHthOjEsYjoxfSwgdHJ1ZSkgLT4gezE6WydhJywnYiddfQogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW211bHRpXQogICAgICoKICAgICAqKiovCiAgICAnaW52ZXJ0JzogZnVuY3Rpb24ob2JqLCBtdWx0aSkgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIG11bHRpID0gbXVsdGkgPT09IHRydWU7CiAgICAgIGZvckVhY2hQcm9wZXJ0eShvYmosIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgICAgaWYgKGhhc093bihyZXN1bHQsIHZhbCkgJiYgbXVsdGkpIHsKICAgICAgICAgIHJlc3VsdFt2YWxdLnB1c2goa2V5KTsKICAgICAgICB9IGVsc2UgaWYgKG11bHRpKSB7CiAgICAgICAgICByZXN1bHRbdmFsXSA9IFtrZXldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHRbdmFsXSA9IGtleTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHRhcChmbikKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IFJ1bnMgYGZuYCBhbmQgcmV0dXJucyB0aGUgb2JqZWN0LgogICAgICogQGV4dHJhIEEgc3RyaW5nIGNhbiBhbHNvIGJlIHVzZWQgYXMgYSBzaG9ydGN1dCB0byBhIG1ldGhvZC4gVGhpcyBtZXRob2QgaXMKICAgICAqICAgICAgICBkZXNpZ25lZCB0byBydW4gYW4gaW50ZXJtZWRpYXJ5IGZ1bmN0aW9uIHRoYXQgInRhcHMgaW50byIgYSBtZXRob2QKICAgICAqICAgICAgICBjaGFpbi4gQXMgc3VjaCwgaXQgaXMgZmFpcmx5IHVzZWxlc3MgYXMgYSBzdGF0aWMgbWV0aG9kLiBIb3dldmVyIGl0CiAgICAgKiAgICAgICAgY2FuIGJlIHF1aXRlIHVzZWZ1bCB3aGVuIGNvbWJpbmVkIHdpdGggY2hhaW5hYmxlcy4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgdGFwRm4KICAgICAqCiAgICAgKiAgIG9iaiAgQSByZWZlcmVuY2UgdG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgU3VnYXIuQXJyYXkoWzEsNCw5XSkubWFwKE1hdGguc3FydCkudGFwKCdwb3AnKSAtPiBbMSwyXQogICAgICogICBTdWdhci5PYmplY3Qoe2E6J2EnfSkudGFwKGxvZ0FyZ3MpLm1lcmdlKHtiOidiJ30pICAtPiB7YTonYScsYjonYid9CiAgICAgKgogICAgICogQHBhcmFtIHt0YXBGbn0gZm4KICAgICAqIEBjYWxsYmFja1BhcmFtIHtPYmplY3R9IG9iagogICAgICogQGNhbGxiYWNrUmV0dXJucyB7YW55fSB0YXBGbgogICAgICoKICAgICAqKiovCiAgICAndGFwJzogZnVuY3Rpb24ob2JqLCBhcmcpIHsKICAgICAgcmV0dXJuIHRhcChvYmosIGFyZyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaXNBcmd1bWVudHMoKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgb2JqZWN0IGlzIGFuIGFyZ3VtZW50cyBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5pc0FyZ3VtZW50cyhbMV0pIC0+IGZhbHNlCiAgICAgKgogICAgICoqKi8KICAgICdpc0FyZ3VtZW50cyc6IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gaXNBcmd1bWVudHMob2JqKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBpc09iamVjdCgpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBvYmplY3QgaXMgYSAicGxhaW4iIG9iamVjdC4KICAgICAqIEBleHRyYSBQbGFpbiBvYmplY3RzIGRvIG5vdCBpbmNsdWRlIGluc3RhbmNlcyBvZiBjbGFzc2VzIG9yICJob3N0IiBvYmplY3RzLAogICAgICogICAgICAgIHN1Y2ggYXMgRWxlbWVudHMsIEV2ZW50cywgZXRjLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuaXNPYmplY3QoeyBicm9rZW46J3dlYXInIH0pIC0+IHRydWUKICAgICAqCiAgICAgKioqLwogICAgJ2lzT2JqZWN0JzogZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiBpc1BsYWluT2JqZWN0KG9iaik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgcmVtb3ZlKHNlYXJjaCkKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IERlbGV0ZXMgYWxsIHByb3BlcnRpZXMgaW4gdGhlIG9iamVjdCBtYXRjaGluZyBgc2VhcmNoYC4KICAgICAqIEBleHRyYSBUaGlzIG1ldGhvZCB3aWxsIG1vZGlmeSB0aGUgb2JqZWN0IS4gSW1wbGVtZW50cyBgZW5oYW5jZWQgbWF0Y2hpbmdgLgogICAgICoKICAgICAqIEBjYWxsYmFjayBzZWFyY2hGbgogICAgICoKICAgICAqICAga2V5ICBUaGUga2V5IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgdmFsICBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBvYmogIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5yZW1vdmUoe2E6J2EnLGI6J2InfSwgJ2EnKTsgICAgICAgICAgIC0+IHtiOidiJ30KICAgICAqICAgT2JqZWN0LnJlbW92ZSh7YTonYScsYjonYicsejoneid9LCAvW2EtZl0vKTsgLT4ge3o6J3onfQogICAgICoKICAgICAqIEBwYXJhbSB7UHJvcGVydHl8c2VhcmNoRm59IHNlYXJjaAogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtib29sZWFufSBzZWFyY2hGbgogICAgICoKICAgICAqKiovCiAgICAncmVtb3ZlJzogZnVuY3Rpb24ob2JqLCBmKSB7CiAgICAgIHJldHVybiBvYmplY3RSZW1vdmUob2JqLCBmKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBleGNsdWRlKHNlYXJjaCkKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IFJldHVybnMgYSBuZXcgb2JqZWN0IHdpdGggYWxsIHByb3BlcnRpZXMgbWF0Y2hpbmcgYHNlYXJjaGAgcmVtb3ZlZC4KICAgICAqIEBleHRyYSBUaGlzIGlzIGEgbm9uLWRlc3RydWN0aXZlIHZlcnNpb24gb2YgYHJlbW92ZWAgYW5kIHdpbGwgbm90IG1vZGlmeQogICAgICogICAgICAgIHRoZSBvYmplY3QuIEltcGxlbWVudHMgYGVuaGFuY2VkIG1hdGNoaW5nYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgc2VhcmNoRm4KICAgICAqCiAgICAgKiAgIGtleSAgVGhlIGtleSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIHZhbCAgVGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgb2JqICBBIHJlZmVyZW5jZSB0byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuZXhjbHVkZSh7YTonYScsYjonYid9LCAnYScpOyAgICAgICAgICAgLT4ge2I6J2InfQogICAgICogICBPYmplY3QuZXhjbHVkZSh7YTonYScsYjonYicsejoneid9LCAvW2EtZl0vKTsgLT4ge3o6J3onfQogICAgICoKICAgICAqIEBwYXJhbSB7UHJvcGVydHl8c2VhcmNoRm59IHNlYXJjaAogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtib29sZWFufSBzZWFyY2hGbgogICAgICoKICAgICAqKiovCiAgICAnZXhjbHVkZSc6IGZ1bmN0aW9uKG9iaiwgZikgewogICAgICByZXR1cm4gb2JqZWN0RXhjbHVkZShvYmosIGYpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHNlbGVjdChmaW5kKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgQnVpbGRzIGEgbmV3IG9iamVjdCBjb250YWluaW5nIHRoZSBrZXlzIHNwZWNpZmllZCBpbiBgZmluZGAuCiAgICAgKiBAZXh0cmEgV2hlbiBgZmluZGAgaXMgYSBzdHJpbmcsIGEgc2luZ2xlIGtleSB3aWxsIGJlIHNlbGVjdGVkLiBBcnJheXMgb3IKICAgICAqICAgICAgICBvYmplY3RzIG1hdGNoIG11bHRpcGxlIGtleXMsIGFuZCBhIHJlZ2V4IHdpbGwgbWF0Y2gga2V5cyBieSByZWdleC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LnNlbGVjdCh7YToxLGI6Mn0sICdhJykgICAgICAgICAgIC0+IHthOjF9CiAgICAgKiAgIE9iamVjdC5zZWxlY3Qoe2E6MSxiOjJ9LCBbJ2EnLCAnYiddKSAgICAtPiB7YToxLGI6Mn0KICAgICAqICAgT2JqZWN0LnNlbGVjdCh7YToxLGI6Mn0sIC9bYS16XS8pICAgICAgIC0+IHthOjEsYjoyfQogICAgICogICBPYmplY3Quc2VsZWN0KHthOjEsYjoyfSwge2E6J2EnLGI6J2InfSkgLT4ge2E6MSxiOjJ9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8UmVnRXhwfEFycmF5PHN0cmluZz58T2JqZWN0fSBmaW5kCiAgICAgKgogICAgICoqKi8KICAgICdzZWxlY3QnOiBmdW5jdGlvbihvYmosIGYpIHsKICAgICAgcmV0dXJuIG9iamVjdFNlbGVjdChvYmosIGYpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJlamVjdChmaW5kKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgQnVpbGRzIGEgbmV3IG9iamVjdCBjb250YWluaW5nIGFsbCBrZXlzIGV4Y2VwdCB0aG9zZSBpbiBgZmluZGAuCiAgICAgKiBAZXh0cmEgV2hlbiBgZmluZGAgaXMgYSBzdHJpbmcsIGEgc2luZ2xlIGtleSB3aWxsIGJlIHJlamVjdGVkLiBBcnJheXMgb3IKICAgICAqICAgICAgICBvYmplY3RzIG1hdGNoIG11bHRpcGxlIGtleXMsIGFuZCBhIHJlZ2V4IHdpbGwgbWF0Y2gga2V5cyBieSByZWdleC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LnJlamVjdCh7YToxLGI6Mn0sICdhJykgICAgICAgIC0+IHtiOjJ9CiAgICAgKiAgIE9iamVjdC5yZWplY3Qoe2E6MSxiOjJ9LCAvW2Etel0vKSAgICAtPiB7fQogICAgICogICBPYmplY3QucmVqZWN0KHthOjEsYjoyfSwge2E6J2EnfSkgICAgLT4ge2I6Mn0KICAgICAqICAgT2JqZWN0LnJlamVjdCh7YToxLGI6Mn0sIFsnYScsICdiJ10pIC0+IHt9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8UmVnRXhwfEFycmF5PHN0cmluZz58T2JqZWN0fSBmaW5kCiAgICAgKgogICAgICoqKi8KICAgICdyZWplY3QnOiBmdW5jdGlvbihvYmosIGYpIHsKICAgICAgcmV0dXJuIG9iamVjdFJlamVjdChvYmosIGYpOwogICAgfQoKICB9KTsKCiAgLy8gVE9ETzogd2h5IGlzIHRoaXMgaGVyZT8KICBkZWZpbmVJbnN0YW5jZShzdWdhck9iamVjdCwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2Qga2V5cygpCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHBvbHlmaWxsIEVTNQogICAgICogQHNob3J0IFJldHVybnMgYW4gYXJyYXkgY29udGFpbmluZyB0aGUga2V5cyBvZiBhbGwgb2YgdGhlIG5vbi1pbmhlcml0ZWQsCiAgICAgKiAgICAgICAgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5rZXlzKHthOidhJyxiOidiJ30pIC0+IFsnYScsJ2InXQogICAgICoKICAgICAqKiovCiAgICAna2V5cyc6IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gZ2V0S2V5cyhvYmopOwogICAgfQoKICB9KTsKCiAgYnVpbGRDbGFzc0NoZWNrTWV0aG9kcygpOwoKICAvKioqCiAgICogQG1vZHVsZSBFbnVtZXJhYmxlCiAgICogQGRlc2NyaXB0aW9uIENvdW50aW5nLCBtYXBwaW5nLCBhbmQgZmluZGluZyBtZXRob2RzIG9uIGJvdGggYXJyYXlzIGFuZCBvYmplY3RzLgogICAqCiAgICoqKi8KCiAgZnVuY3Rpb24gc3VtKG9iaiwgbWFwKSB7CiAgICB2YXIgc3VtID0gMDsKICAgIGVudW1lcmF0ZVdpdGhNYXBwaW5nKG9iaiwgbWFwLCBmdW5jdGlvbih2YWwpIHsKICAgICAgc3VtICs9IHZhbDsKICAgIH0pOwogICAgcmV0dXJuIHN1bTsKICB9CgogIGZ1bmN0aW9uIGF2ZXJhZ2Uob2JqLCBtYXApIHsKICAgIHZhciBzdW0gPSAwLCBjb3VudCA9IDA7CiAgICBlbnVtZXJhdGVXaXRoTWFwcGluZyhvYmosIG1hcCwgZnVuY3Rpb24odmFsKSB7CiAgICAgIHN1bSArPSB2YWw7CiAgICAgIGNvdW50Kys7CiAgICB9KTsKICAgIC8vIFByZXZlbnQgZGl2aWRlIGJ5IDAKICAgIHJldHVybiBzdW0gLyAoY291bnQgfHwgMSk7CiAgfQoKICBmdW5jdGlvbiBtZWRpYW4ob2JqLCBtYXApIHsKICAgIHZhciByZXN1bHQgPSBbXSwgbWlkZGxlLCBsZW47CiAgICBlbnVtZXJhdGVXaXRoTWFwcGluZyhvYmosIG1hcCwgZnVuY3Rpb24odmFsKSB7CiAgICAgIHJlc3VsdC5wdXNoKHZhbCk7CiAgICB9KTsKICAgIGxlbiA9IHJlc3VsdC5sZW5ndGg7CiAgICBpZiAoIWxlbikgcmV0dXJuIDA7CiAgICByZXN1bHQuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgIC8vIElFNyB3aWxsIHRocm93IGVycm9ycyBvbiBub24tbnVtYmVycyEKICAgICAgcmV0dXJuIChhIHx8IDApIC0gKGIgfHwgMCk7CiAgICB9KTsKICAgIG1pZGRsZSA9IHRydW5jKGxlbiAvIDIpOwogICAgcmV0dXJuIGxlbiAlIDIgPyByZXN1bHRbbWlkZGxlXSA6IChyZXN1bHRbbWlkZGxlIC0gMV0gKyByZXN1bHRbbWlkZGxlXSkgLyAyOwogIH0KCiAgZnVuY3Rpb24gZ2V0TWluT3JNYXgob2JqLCBhcmcxLCBhcmcyLCBtYXgsIGFzT2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW10sIHB1c2hWYWwsIGVkZ2UsIGFsbCwgbWFwOwogICAgaWYgKGlzQm9vbGVhbihhcmcxKSkgewogICAgICBhbGwgPSBhcmcxOwogICAgICBtYXAgPSBhcmcyOwogICAgfSBlbHNlIHsKICAgICAgbWFwID0gYXJnMTsKICAgIH0KICAgIGVudW1lcmF0ZVdpdGhNYXBwaW5nKG9iaiwgbWFwLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICBpZiAoaXNVbmRlZmluZWQodmFsKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjb21wYXJlIHdpdGggdW5kZWZpbmVkJyk7CiAgICAgIH0KICAgICAgcHVzaFZhbCA9IGFzT2JqZWN0ID8ga2V5IDogb2JqW2tleV07CiAgICAgIGlmICh2YWwgPT09IGVkZ2UpIHsKICAgICAgICByZXN1bHQucHVzaChwdXNoVmFsKTsKICAgICAgfSBlbHNlIGlmIChpc1VuZGVmaW5lZChlZGdlKSB8fCAobWF4ICYmIHZhbCA+IGVkZ2UpIHx8ICghbWF4ICYmIHZhbCA8IGVkZ2UpKSB7CiAgICAgICAgcmVzdWx0ID0gW3B1c2hWYWxdOwogICAgICAgIGVkZ2UgPSB2YWw7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGdldFJlZHVjZWRNaW5NYXhSZXN1bHQocmVzdWx0LCBvYmosIGFsbCwgYXNPYmplY3QpOwogIH0KCiAgZnVuY3Rpb24gZ2V0TGVhc3RPck1vc3Qob2JqLCBhcmcxLCBhcmcyLCBtb3N0LCBhc09iamVjdCkgewogICAgdmFyIGdyb3VwID0ge30sIHJlZnMgPSBbXSwgbWluTWF4UmVzdWx0LCByZXN1bHQsIGFsbCwgbWFwOwogICAgaWYgKGlzQm9vbGVhbihhcmcxKSkgewogICAgICBhbGwgPSBhcmcxOwogICAgICBtYXAgPSBhcmcyOwogICAgfSBlbHNlIHsKICAgICAgbWFwID0gYXJnMTsKICAgIH0KICAgIGVudW1lcmF0ZVdpdGhNYXBwaW5nKG9iaiwgbWFwLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICB2YXIgZ3JvdXBLZXkgPSBzZXJpYWxpemVJbnRlcm5hbCh2YWwsIHJlZnMpOwogICAgICB2YXIgYXJyID0gZ2V0T3duKGdyb3VwLCBncm91cEtleSkgfHwgW107CiAgICAgIGFyci5wdXNoKGFzT2JqZWN0ID8ga2V5IDogb2JqW2tleV0pOwogICAgICBncm91cFtncm91cEtleV0gPSBhcnI7CiAgICB9KTsKICAgIG1pbk1heFJlc3VsdCA9IGdldE1pbk9yTWF4KGdyb3VwLCAhIWFsbCwgJ2xlbmd0aCcsIG1vc3QsIHRydWUpOwogICAgaWYgKGFsbCkgewogICAgICByZXN1bHQgPSBbXTsKICAgICAgLy8gRmxhdHRlbiByZXN1bHQKICAgICAgZm9yRWFjaFByb3BlcnR5KG1pbk1heFJlc3VsdCwgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdCh2YWwpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IGdldE93bihncm91cCwgbWluTWF4UmVzdWx0KTsKICAgIH0KICAgIHJldHVybiBnZXRSZWR1Y2VkTWluTWF4UmVzdWx0KHJlc3VsdCwgb2JqLCBhbGwsIGFzT2JqZWN0KTsKICB9CgoKICAvLyBTdXBwb3J0CgogIGZ1bmN0aW9uIGdldFJlZHVjZWRNaW5NYXhSZXN1bHQocmVzdWx0LCBvYmosIGFsbCwgYXNPYmplY3QpIHsKICAgIGlmIChhc09iamVjdCAmJiBhbGwpIHsKICAgICAgLy8gVGhlIG1ldGhvZCBoYXMgcmV0dXJuZWQgYW4gYXJyYXkgb2Yga2V5cyBzbyB1c2UgdGhpcyBhcnJheQogICAgICAvLyB0byBidWlsZCB1cCB0aGUgcmVzdWx0aW5nIG9iamVjdCBpbiB0aGUgZm9ybSB3ZSB3YW50IGl0IGluLgogICAgICByZXR1cm4gcmVzdWx0LnJlZHVjZShmdW5jdGlvbihvLCBrZXkpIHsKICAgICAgICBvW2tleV0gPSBvYmpba2V5XTsKICAgICAgICByZXR1cm4gbzsKICAgICAgfSwge30pOwogICAgfSBlbHNlIGlmIChyZXN1bHQgJiYgIWFsbCkgewogICAgICByZXN1bHQgPSByZXN1bHRbMF07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZnVuY3Rpb24gZW51bWVyYXRlV2l0aE1hcHBpbmcob2JqLCBtYXAsIGZuKSB7CiAgICB2YXIgYXJyYXlJbmRleGVzID0gaXNBcnJheShvYmopOwogICAgZm9yRWFjaFByb3BlcnR5KG9iaiwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAgaWYgKGFycmF5SW5kZXhlcykgewogICAgICAgIGlmICghaXNBcnJheUluZGV4KGtleSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAga2V5ID0gK2tleTsKICAgICAgfQogICAgICB2YXIgbWFwcGVkID0gbWFwV2l0aFNob3J0Y3V0cyh2YWwsIG1hcCwgb2JqLCBbdmFsLCBrZXksIG9ial0pOwogICAgICBmbihtYXBwZWQsIGtleSk7CiAgICB9KTsKICB9CgogIC8qKiogQG5hbWVzcGFjZSBBcnJheSAqKiovCgogIC8vIEZsYWcgYWxsb3dpbmcgbmF0aXZlIGFycmF5IG1ldGhvZHMgdG8gYmUgZW5oYW5jZWQKICB2YXIgQVJSQVlfRU5IQU5DRU1FTlRTX0ZMQUcgPSAnZW5oYW5jZUFycmF5JzsKCiAgLy8gRW5oYW5jZWQgbWFwIGZ1bmN0aW9uCiAgdmFyIGVuaGFuY2VkTWFwID0gYnVpbGRFbmhhbmNlZE1hcHBpbmcoJ21hcCcpOwoKICAvLyBFbmhhbmNlZCBtYXRjaGVyIG1ldGhvZHMKICB2YXIgZW5oYW5jZWRGaW5kICAgICAgPSBidWlsZEVuaGFuY2VkTWF0Y2hpbmcoJ2ZpbmQnKSwKICAgICAgZW5oYW5jZWRTb21lICAgICAgPSBidWlsZEVuaGFuY2VkTWF0Y2hpbmcoJ3NvbWUnKSwKICAgICAgZW5oYW5jZWRFdmVyeSAgICAgPSBidWlsZEVuaGFuY2VkTWF0Y2hpbmcoJ2V2ZXJ5JyksCiAgICAgIGVuaGFuY2VkRmlsdGVyICAgID0gYnVpbGRFbmhhbmNlZE1hdGNoaW5nKCdmaWx0ZXInKSwKICAgICAgZW5oYW5jZWRGaW5kSW5kZXggPSBidWlsZEVuaGFuY2VkTWF0Y2hpbmcoJ2ZpbmRJbmRleCcpOwoKICBmdW5jdGlvbiBhcnJheU5vbmUoKSB7CiAgICByZXR1cm4gIWVuaGFuY2VkU29tZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KCiAgZnVuY3Rpb24gYXJyYXlDb3VudChhcnIsIGYpIHsKICAgIGlmIChpc1VuZGVmaW5lZChmKSkgewogICAgICByZXR1cm4gYXJyLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiBlbmhhbmNlZEZpbHRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpLmxlbmd0aDsKICB9CgogIC8vIEVuaGFuY2VkIG1ldGhvZHMKCiAgZnVuY3Rpb24gYnVpbGRFbmhhbmNlZE1hcHBpbmcobmFtZSkgewogICAgcmV0dXJuIHdyYXBOYXRpdmVBcnJheU1ldGhvZChuYW1lLCBlbmhhbmNlZE1hcHBpbmcpOwogIH0KCgogIGZ1bmN0aW9uIGJ1aWxkRW5oYW5jZWRNYXRjaGluZyhuYW1lKSB7CiAgICByZXR1cm4gd3JhcE5hdGl2ZUFycmF5TWV0aG9kKG5hbWUsIGVuaGFuY2VkTWF0Y2hpbmcpOwogIH0KCiAgZnVuY3Rpb24gZW5oYW5jZWRNYXBwaW5nKG1hcCwgY29udGV4dCkgewogICAgaWYgKGlzRnVuY3Rpb24obWFwKSkgewogICAgICByZXR1cm4gbWFwOwogICAgfSBlbHNlIGlmIChtYXApIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGVsLCBpLCBhcnIpIHsKICAgICAgICByZXR1cm4gbWFwV2l0aFNob3J0Y3V0cyhlbCwgbWFwLCBjb250ZXh0LCBbZWwsIGksIGFycl0pOwogICAgICB9OwogICAgfQogIH0KCiAgZnVuY3Rpb24gZW5oYW5jZWRNYXRjaGluZyhmKSB7CiAgICB2YXIgbWF0Y2hlcjsKICAgIGlmIChpc0Z1bmN0aW9uKGYpKSB7CiAgICAgIHJldHVybiBmOwogICAgfQogICAgbWF0Y2hlciA9IGdldE1hdGNoZXIoZik7CiAgICByZXR1cm4gZnVuY3Rpb24oZWwsIGksIGFycikgewogICAgICByZXR1cm4gbWF0Y2hlcihlbCwgaSwgYXJyKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiB3cmFwTmF0aXZlQXJyYXlNZXRob2QobWV0aG9kTmFtZSwgd3JhcHBlcikgewogICAgdmFyIG5hdGl2ZUZuID0gQXJyYXkucHJvdG90eXBlW21ldGhvZE5hbWVdOwogICAgcmV0dXJuIGZ1bmN0aW9uKGFyciwgZiwgY29udGV4dCwgYXJnc0xlbikgewogICAgICB2YXIgYXJncyA9IG5ldyBBcnJheSgyKTsKICAgICAgYXNzZXJ0QXJndW1lbnQoYXJnc0xlbiA+IDApOwogICAgICBhcmdzWzBdID0gd3JhcHBlcihmLCBjb250ZXh0KTsKICAgICAgYXJnc1sxXSA9IGNvbnRleHQ7CiAgICAgIHJldHVybiBuYXRpdmVGbi5hcHBseShhcnIsIGFyZ3MpOwogICAgfTsKICB9CgoKICAvKioqCiAgICogQG1ldGhvZCBbZm5dRnJvbUluZGV4KHN0YXJ0SW5kZXgsIFtsb29wXSwgLi4uKQogICAqIEByZXR1cm5zIE1peGVkCiAgICogQHNob3J0IFJ1bnMgbmF0aXZlIGFycmF5IGZ1bmN0aW9ucyBiZWdpbm5pbmcgZnJvbSBgc3RhcnRJbmRleGAuCiAgICogQGV4dHJhIElmIFtsb29wXSBpcyBgdHJ1ZWAsIG9uY2UgdGhlIGVuZCBvZiB0aGUgYXJyYXkgaGFzIGJlZW4gcmVhY2hlZCwKICAgKiAgICAgICAgaXRlcmF0aW9uIHdpbGwgY29udGludWUgZnJvbSB0aGUgc3RhcnQgb2YgdGhlIGFycmF5IHVwIHRvCiAgICogICAgICAgIGBzdGFydEluZGV4IC0gMWAuIElmIFtsb29wXSBpcyBmYWxzZSBpdCBjYW4gYmUgb21pdHRlZC4gU3RhbmRhcmQKICAgKiAgICAgICAgYXJndW1lbnRzIGFyZSB0aGVuIHBhc3NlZCB3aGljaCB3aWxsIGJlIGZvcndhcmRlZCB0byB0aGUgbmF0aXZlCiAgICogICAgICAgIG1ldGhvZHMuIFdoZW4gYXZhaWxhYmxlLCBtZXRob2RzIGFyZSBhbHdheXMgYGVuaGFuY2VkYC4gVGhpcyBpbmNsdWRlcwogICAqICAgICAgICBgZGVlcCBwcm9wZXJ0aWVzYCBmb3IgYG1hcGAsIGFuZCBgZW5oYW5jZWQgbWF0Y2hpbmdgIGZvciBgc29tZWAsCiAgICogICAgICAgIGBldmVyeWAsIGBmaWx0ZXJgLCBgZmluZGAsIGFuZCBgZmluZEluZGV4YC4gTm90ZSBhbHNvIHRoYXQKICAgKiAgICAgICAgYGZvckVhY2hGcm9tSW5kZXhgIGlzIG9wdGltaXplZCBmb3Igc3BhcnNlIGFycmF5cyBhbmQgbWF5IGJlIGZhc3RlcgogICAqICAgICAgICB0aGFuIG5hdGl2ZSBgZm9yRWFjaGAuCiAgICoKICAgKiBAc2V0CiAgICogICBtYXBGcm9tSW5kZXgKICAgKiAgIGZvckVhY2hGcm9tSW5kZXgKICAgKiAgIGZpbHRlckZyb21JbmRleAogICAqICAgc29tZUZyb21JbmRleAogICAqICAgZXZlcnlGcm9tSW5kZXgKICAgKiAgIHJlZHVjZUZyb21JbmRleAogICAqICAgcmVkdWNlUmlnaHRGcm9tSW5kZXgKICAgKiAgIGZpbmRGcm9tSW5kZXgKICAgKiAgIGZpbmRJbmRleEZyb21JbmRleAogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgdXNlcnMubWFwRnJvbUluZGV4KDIsICduYW1lJyk7CiAgICogICB1c2Vycy5tYXBGcm9tSW5kZXgoMiwgdHJ1ZSwgJ25hbWUnKTsKICAgKiAgIG5hbWVzLmZvckVhY2hGcm9tSW5kZXgoMTAsIGxvZyk7CiAgICogICBuYW1lcy5ldmVyeUZyb21JbmRleCgxNSwgL15bQS1GXS8pOwogICAqCiAgICogQHNpZ25hdHVyZSBbZm5dRnJvbUluZGV4KHN0YXJ0SW5kZXgsIC4uLikKICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnRJbmRleAogICAqIEBwYXJhbSB7Ym9vbGVhbn0gbG9vcAogICAqCiAgICoqKi8KICBmdW5jdGlvbiBidWlsZEZyb21JbmRleE1ldGhvZHMoKSB7CgogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICdmb3JFYWNoJzogewogICAgICAgIGJhc2U6IGZvckVhY2hBc05hdGl2ZQogICAgICB9LAogICAgICAnbWFwJzogewogICAgICAgIHdyYXBwZXI6IGVuaGFuY2VkTWFwcGluZwogICAgICB9LAogICAgICAnc29tZSBldmVyeSc6IHsKICAgICAgICB3cmFwcGVyOiBlbmhhbmNlZE1hdGNoaW5nCiAgICAgIH0sCiAgICAgICdmaW5kSW5kZXgnOiB7CiAgICAgICAgd3JhcHBlcjogZW5oYW5jZWRNYXRjaGluZywKICAgICAgICByZXN1bHQ6IGluZGV4UmVzdWx0CiAgICAgIH0sCiAgICAgICdyZWR1Y2UnOiB7CiAgICAgICAgYXBwbHk6IGFwcGx5UmVkdWNlCiAgICAgIH0sCiAgICAgICdmaWx0ZXIgZmluZCc6IHsKICAgICAgICB3cmFwcGVyOiBlbmhhbmNlZE1hdGNoaW5nCiAgICAgIH0sCiAgICAgICdyZWR1Y2VSaWdodCc6IHsKICAgICAgICBhcHBseTogYXBwbHlSZWR1Y2UsCiAgICAgICAgc2xpY2U6IHNsaWNlQXJyYXlGcm9tUmlnaHQsCiAgICAgICAgY2xhbXA6IGNsYW1wU3RhcnRJbmRleEZyb21SaWdodAogICAgICB9CiAgICB9OwoKICAgIGZvckVhY2hQcm9wZXJ0eShtZXRob2RzLCBmdW5jdGlvbihvcHRzLCBrZXkpIHsKICAgICAgZm9yRWFjaChzcGFjZVNwbGl0KGtleSksIGZ1bmN0aW9uKGJhc2VOYW1lKSB7CiAgICAgICAgdmFyIG1ldGhvZE5hbWUgPSBiYXNlTmFtZSArICdGcm9tSW5kZXgnOwogICAgICAgIHZhciBmbiA9IGNyZWF0ZUZyb21JbmRleFdpdGhPcHRpb25zKGJhc2VOYW1lLCBvcHRzKTsKICAgICAgICBkZWZpbmVJbnN0YW5jZVdpdGhBcmd1bWVudHMoc3VnYXJBcnJheSwgbWV0aG9kTmFtZSwgZm4pOwogICAgICB9KTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIGZvckVhY2hBc05hdGl2ZShmbikgewogICAgICBmb3JFYWNoKHRoaXMsIGZuKTsKICAgIH0KCiAgICAvLyBNZXRob2RzIGxpa2UgZmlsdGVyIGFuZCBmaW5kIGhhdmUgYSBkaXJlY3QgYXNzb2NpYXRpb24gYmV0d2VlbiB0aGUgdmFsdWUKICAgIC8vIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFjayBhbmQgdGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLiBUaGlzCiAgICAvLyBtZWFucyB0aGF0IHdoZW4gbG9vcGluZywgYXJyYXkgZWxlbWVudHMgbXVzdCBtYXRjaCB0aGUgYWN0dWFsIGluZGV4IGZvcgogICAgLy8gd2hpY2ggdGhleSBhcmUgYmVpbmcgY2FsbGVkLCBzbyB0aGUgYXJyYXkgbXVzdCBiZSBzbGljZWQuIFRoaXMgaXMgbm90IHRoZQogICAgLy8gY2FzZSBmb3IgbWV0aG9kcyBsaWtlIGZvckVhY2ggYW5kIG1hcCwgd2hpY2ggZWl0aGVyIGRvIG5vdCB1c2UgcmV0dXJuCiAgICAvLyB2YWx1ZXMgb3IgdXNlIHRoZW0gaW4gYSB3YXkgdGhhdCBzaW1wbHkgZ2V0dGluZyB0aGUgZWxlbWVudCBhdCBhIHNoaWZ0ZWQKICAgIC8vIGluZGV4IHdpbGwgbm90IGFmZmVjdCB0aGUgZmluYWwgcmV0dXJuIHZhbHVlLiBIb3dldmVyLCB0aGVzZSBtZXRob2RzIHdpbGwKICAgIC8vIHN0aWxsIGZhaWwgb24gc3BhcnNlIGFycmF5cywgc28gYWx3YXlzIHNsaWNpbmcgdGhlbSBoZXJlLiBGb3IgZXhhbXBsZSwgaWYKICAgIC8vICJmb3JFYWNoRnJvbUluZGV4IiB3ZXJlIHRvIGJlIGNhbGxlZCBvbiBbMSwsMl0gZnJvbSBpbmRleCAxLCBhbHRob3VnaCB0aGUKICAgIC8vIGFjdHVhbCBpbmRleCAxIHdvdWxkIGl0c2VsZiB3b3VsZCBiZSBza2lwcGVkLCB3aGVuIHRoZSBhcnJheSBsb29wcyBiYWNrIHRvCiAgICAvLyBpbmRleCAwLCBzaGlmdGluZyBpdCBieSBhZGRpbmcgMSB3b3VsZCByZXN1bHQgaW4gdGhlIGVsZW1lbnQgZm9yIHRoYXQKICAgIC8vIGl0ZXJhdGlvbiBiZWluZyB1bmRlZmluZWQuIEZvciBzaGlmdGluZyB0byB3b3JrLCBhbGwgZ2FwcyBpbiB0aGUgYXJyYXkKICAgIC8vIGJldHdlZW4gdGhlIGFjdHVhbCBpbmRleCBhbmQgdGhlIHNoaWZ0ZWQgaW5kZXggd291bGQgaGF2ZSB0byBiZSBhY2NvdW50ZWQKICAgIC8vIGZvci4gVGhpcyBpcyBpbmZlYXNpYmxlIGFuZCBpcyBlYXNpbHkgc29sdmVkIGJ5IHNpbXBseSBzbGljaW5nIHRoZSBhY3R1YWwKICAgIC8vIGFycmF5IGluc3RlYWQgc28gdGhhdCBnYXBzIGFsaWduLiBOb3RlIGFsc28gdGhhdCBpbiB0aGUgY2FzZSBvZiBmb3JFYWNoLAogICAgLy8gd2UgYXJlIHVzaW5nIHRoZSBpbnRlcm5hbCBmdW5jdGlvbiB3aGljaCBoYW5kbGVzIHNwYXJzZSBhcnJheXMgaW4gYSB3YXkKICAgIC8vIHRoYXQgZG9lcyBub3QgaW5jcmVtZW50IHRoZSBpbmRleCwgYW5kIHNvIGlzIGhpZ2hseSBvcHRpbWl6ZWQgY29tcGFyZWQgdG8KICAgIC8vIHRoZSBvdGhlcnMgaGVyZSwgd2hpY2ggYXJlIHNpbXBseSBnb2luZyB0aHJvdWdoIHRoZSBuYXRpdmUgaW1wbGVtZW50YXRpb24uCiAgICBmdW5jdGlvbiBzbGljZUFycmF5RnJvbUxlZnQoYXJyLCBzdGFydEluZGV4LCBsb29wKSB7CiAgICAgIHZhciByZXN1bHQgPSBhcnI7CiAgICAgIGlmIChzdGFydEluZGV4KSB7CiAgICAgICAgcmVzdWx0ID0gYXJyLnNsaWNlKHN0YXJ0SW5kZXgpOwogICAgICAgIGlmIChsb29wKSB7CiAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KGFyci5zbGljZSgwLCBzdGFydEluZGV4KSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLy8gV2hlbiBpdGVyYXRpbmcgZnJvbSB0aGUgcmlnaHQsIGluZGV4ZXMgYXJlIGVmZmVjdGl2ZWx5IHNoaWZ0ZWQgYnkgMS4KICAgIC8vIEZvciBleGFtcGxlLCBpdGVyYXRpbmcgZnJvbSB0aGUgcmlnaHQgZnJvbSBpbmRleCAyIGluIGFuIGFycmF5IG9mIDMKICAgIC8vIHNob3VsZCBhbHNvIGluY2x1ZGUgdGhlIGxhc3QgZWxlbWVudCBpbiB0aGUgYXJyYXkuIFRoaXMgbWF0Y2hlcyB0aGUKICAgIC8vICJsYXN0SW5kZXhPZiIgbWV0aG9kIHdoaWNoIGFsc28gaXRlcmF0ZXMgZnJvbSB0aGUgcmlnaHQuCiAgICBmdW5jdGlvbiBzbGljZUFycmF5RnJvbVJpZ2h0KGFyciwgc3RhcnRJbmRleCwgbG9vcCkgewogICAgICBpZiAoIWxvb3ApIHsKICAgICAgICBzdGFydEluZGV4ICs9IDE7CiAgICAgICAgYXJyID0gYXJyLnNsaWNlKDAsIG1heCgwLCBzdGFydEluZGV4KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFycjsKICAgIH0KCiAgICBmdW5jdGlvbiBjbGFtcFN0YXJ0SW5kZXgoc3RhcnRJbmRleCwgbGVuKSB7CiAgICAgIHJldHVybiBtaW4obGVuLCBtYXgoMCwgc3RhcnRJbmRleCkpOwogICAgfQoKICAgIC8vIEFzIGluZGV4ZXMgYXJlIHNoaWZ0ZWQgYnkgMSB3aGVuIHN0YXJ0aW5nIGZyb20gdGhlIHJpZ2h0LCBjbGFtcGluZyBoYXMgdG8KICAgIC8vIGdvIGRvd24gdG8gLTEgdG8gYWNjb21tb2RhdGUgdGhlIGZ1bGwgcmFuZ2Ugb2YgdGhlIHNsaWNlZCBhcnJheS4KICAgIGZ1bmN0aW9uIGNsYW1wU3RhcnRJbmRleEZyb21SaWdodChzdGFydEluZGV4LCBsZW4pIHsKICAgICAgcmV0dXJuIG1pbihsZW4sIG1heCgtMSwgc3RhcnRJbmRleCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFwcGx5UmVkdWNlKGFyciwgc3RhcnRJbmRleCwgZm4sIGNvbnRleHQsIGxlbiwgbG9vcCkgewogICAgICByZXR1cm4gZnVuY3Rpb24oYWNjLCB2YWwsIGkpIHsKICAgICAgICBpID0gZ2V0Tm9ybWFsaXplZEluZGV4KGkgKyBzdGFydEluZGV4LCBsZW4sIGxvb3ApOwogICAgICAgIHJldHVybiBmbi5jYWxsKGFyciwgYWNjLCB2YWwsIGksIGFycik7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gYXBwbHlFYWNoKGFyciwgc3RhcnRJbmRleCwgZm4sIGNvbnRleHQsIGxlbiwgbG9vcCkgewogICAgICByZXR1cm4gZnVuY3Rpb24oZWwsIGkpIHsKICAgICAgICBpID0gZ2V0Tm9ybWFsaXplZEluZGV4KGkgKyBzdGFydEluZGV4LCBsZW4sIGxvb3ApOwogICAgICAgIHJldHVybiBmbi5jYWxsKGNvbnRleHQsIGFycltpXSwgaSwgYXJyKTsKICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbmRleFJlc3VsdChyZXN1bHQsIHN0YXJ0SW5kZXgsIGxlbikgewogICAgICBpZiAocmVzdWx0ICE9PSAtMSkgewogICAgICAgIHJlc3VsdCA9IChyZXN1bHQgKyBzdGFydEluZGV4KSAlIGxlbjsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUZyb21JbmRleFdpdGhPcHRpb25zKG1ldGhvZE5hbWUsIG9wdHMpIHsKCiAgICAgIHZhciBiYXNlRm4gPSBvcHRzLmJhc2UgfHwgQXJyYXkucHJvdG90eXBlW21ldGhvZE5hbWVdLAogICAgICAgICAgYXBwbHlDYWxsYmFjayA9IG9wdHMuYXBwbHkgfHwgYXBwbHlFYWNoLAogICAgICAgICAgc2xpY2VBcnJheSA9IG9wdHMuc2xpY2UgfHwgc2xpY2VBcnJheUZyb21MZWZ0LAogICAgICAgICAgY2xhbXBJbmRleCA9IG9wdHMuY2xhbXAgfHwgY2xhbXBTdGFydEluZGV4LAogICAgICAgICAgZ2V0UmVzdWx0ID0gb3B0cy5yZXN1bHQsCiAgICAgICAgICB3cmFwcGVyID0gb3B0cy53cmFwcGVyOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFyciwgc3RhcnRJbmRleCwgYXJncykgewogICAgICAgIHZhciBjYWxsQXJncyA9IFtdLCBhcmdJbmRleCA9IDAsIGxhc3RBcmcsIHJlc3VsdCwgbGVuLCBsb29wLCBmbjsKICAgICAgICBsZW4gPSBhcnIubGVuZ3RoOwogICAgICAgIGlmIChpc0Jvb2xlYW4oYXJnc1swXSkpIHsKICAgICAgICAgIGxvb3AgPSBhcmdzW2FyZ0luZGV4KytdOwogICAgICAgIH0KICAgICAgICBmbiA9IGFyZ3NbYXJnSW5kZXgrK107CiAgICAgICAgbGFzdEFyZyA9IGFyZ3NbYXJnSW5kZXhdOwogICAgICAgIGlmIChzdGFydEluZGV4IDwgMCkgewogICAgICAgICAgc3RhcnRJbmRleCArPSBsZW47CiAgICAgICAgfQogICAgICAgIHN0YXJ0SW5kZXggPSBjbGFtcEluZGV4KHN0YXJ0SW5kZXgsIGxlbik7CiAgICAgICAgYXNzZXJ0QXJndW1lbnQoYXJncy5sZW5ndGgpOwogICAgICAgIGZuID0gd3JhcHBlciA/IHdyYXBwZXIoZm4sIGxhc3RBcmcpIDogZm47CiAgICAgICAgY2FsbEFyZ3MucHVzaChhcHBseUNhbGxiYWNrKGFyciwgc3RhcnRJbmRleCwgZm4sIGxhc3RBcmcsIGxlbiwgbG9vcCkpOwogICAgICAgIGlmIChsYXN0QXJnKSB7CiAgICAgICAgICBjYWxsQXJncy5wdXNoKGxhc3RBcmcpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBiYXNlRm4uYXBwbHkoc2xpY2VBcnJheShhcnIsIHN0YXJ0SW5kZXgsIGxvb3ApLCBjYWxsQXJncyk7CiAgICAgICAgaWYgKGdldFJlc3VsdCkgewogICAgICAgICAgcmVzdWx0ID0gZ2V0UmVzdWx0KHJlc3VsdCwgc3RhcnRJbmRleCwgbGVuKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KICB9CgogIGRlZmluZUluc3RhbmNlKHN1Z2FyQXJyYXksIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIG1hcChtYXAsIFtjb250ZXh0XSkKICAgICAqIEByZXR1cm5zIE5ldyBBcnJheQogICAgICogQHBvbHlmaWxsIEVTNQogICAgICogQHNob3J0IE1hcHMgdGhlIGFycmF5IHRvIGFub3RoZXIgYXJyYXkgd2hvc2UgZWxlbWVudHMgYXJlIHRoZSB2YWx1ZXMKICAgICAqICAgICAgICByZXR1cm5lZCBieSB0aGUgYG1hcGAgY2FsbGJhY2suCiAgICAgKiBAZXh0cmEgW2NvbnRleHRdIGlzIHRoZSBgdGhpc2Agb2JqZWN0LiBTdWdhciBlbmhhbmNlcyB0aGlzIG1ldGhvZCB0byBhY2NlcHQKICAgICAqICAgICAgICBhIHN0cmluZyBmb3IgYG1hcGAsIHdoaWNoIGlzIGEgc2hvcnRjdXQgZm9yIGEgZnVuY3Rpb24gdGhhdCBnZXRzCiAgICAgKiAgICAgICAgYSBwcm9wZXJ0eSBvciBpbnZva2VzIGEgZnVuY3Rpb24gb24gZWFjaCBlbGVtZW50LgogICAgICogICAgICAgIFN1cHBvcnRzIGBkZWVwIHByb3BlcnRpZXNgLgogICAgICoKICAgICAqIEBjYWxsYmFjayBtYXBGbgogICAgICoKICAgICAqICAgZWwgICBUaGUgZWxlbWVudCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGkgICAgVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgYXJyICBBIHJlZmVyZW5jZSB0byB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFsxLDIsM10ubWFwKGZ1bmN0aW9uKG4pIHsKICAgICAqICAgICByZXR1cm4gbiAqIDM7CiAgICAgKiAgIH0pOyAtPiBbMyw2LDldCiAgICAgKgogICAgICogICBbJ2EnLCdhYScsJ2FhYSddLm1hcCgnbGVuZ3RoJykgLT4gWzEsMiwzXQogICAgICogICBbJ0EnLCdCJywnQyddLm1hcCgndG9Mb3dlckNhc2UnKSAtPiBbJ2EnLCdiJywnYyddCiAgICAgKiAgIHVzZXJzLm1hcCgnbmFtZScpIC0+IGFycmF5IG9mIHVzZXIgbmFtZXMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xtYXBGbn0gbWFwCiAgICAgKiBAcGFyYW0ge2FueX0gY29udGV4dAogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5RWxlbWVudH0gZWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtudW1iZXJ9IGkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheX0gYXJyCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtOZXdBcnJheUVsZW1lbnR9IG1hcEZuCiAgICAgKgogICAgICoqKi8KICAgICdtYXAnOiBmaXhBcmd1bWVudExlbmd0aChlbmhhbmNlZE1hcCksCgogICAgLyoqKgogICAgICogQG1ldGhvZCBzb21lKHNlYXJjaCwgW2NvbnRleHRdKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHBvbHlmaWxsIEVTNQogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiBgc2VhcmNoYCBpcyB0cnVlIGZvciBhbnkgZWxlbWVudCBpbiB0aGUgYXJyYXkuCiAgICAgKiBAZXh0cmEgW2NvbnRleHRdIGlzIHRoZSBgdGhpc2Agb2JqZWN0LiBJbXBsZW1lbnRzIGBlbmhhbmNlZCBtYXRjaGluZ2AuCiAgICAgKgogICAgICogQGNhbGxiYWNrIHNlYXJjaEZuCiAgICAgKgogICAgICogICBlbCAgIFRoZSBlbGVtZW50IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBhcnIgIEEgcmVmZXJlbmNlIHRvIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWydhJywnYicsJ2MnXS5zb21lKGZ1bmN0aW9uKG4pIHsKICAgICAqICAgICByZXR1cm4gbiA9PSAnYSc7CiAgICAgKiAgIH0pOwogICAgICogICBbJ2EnLCdiJywnYyddLnNvbWUoZnVuY3Rpb24obikgewogICAgICogICAgIHJldHVybiBuID09ICdkJzsKICAgICAqICAgfSk7CiAgICAgKiAgIFsnYScsJ2InLCdjJ10uc29tZSgnYScpICAgIC0+IHRydWUKICAgICAqICAgW3thOjJ9LHtiOjV9XS5zb21lKHthOjJ9KSAgLT4gdHJ1ZQogICAgICogICB1c2Vycy5zb21lKHsgbmFtZTogL15ILyB9KSAtPiB0cnVlIGlmIGFueSBoYXZlIGEgbmFtZSBzdGFydGluZyB3aXRoIEgKICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5RWxlbWVudHxzZWFyY2hGbn0gc2VhcmNoCiAgICAgKiBAcGFyYW0ge2FueX0gY29udGV4dAogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5RWxlbWVudH0gZWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtudW1iZXJ9IGkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheX0gYXJyCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtib29sZWFufSBzZWFyY2hGbgogICAgICoKICAgICAqKiovCiAgICAnc29tZSc6IGZpeEFyZ3VtZW50TGVuZ3RoKGVuaGFuY2VkU29tZSksCgogICAgLyoqKgogICAgICogQG1ldGhvZCBldmVyeShzZWFyY2gsIFtjb250ZXh0XSkKICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAqIEBwb2x5ZmlsbCBFUzUKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgYHNlYXJjaGAgaXMgdHJ1ZSBmb3IgYWxsIGVsZW1lbnRzIG9mIHRoZSBhcnJheS4KICAgICAqIEBleHRyYSBbY29udGV4dF0gaXMgdGhlIGB0aGlzYCBvYmplY3QuIEltcGxlbWVudHMgYGVuaGFuY2VkIG1hdGNoaW5nYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgc2VhcmNoRm4KICAgICAqCiAgICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBpICAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGFyciAgQSByZWZlcmVuY2UgdG8gdGhlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbJ2EnLCdhJywnYSddLmV2ZXJ5KGZ1bmN0aW9uKG4pIHsKICAgICAqICAgICByZXR1cm4gbiA9PSAnYSc7CiAgICAgKiAgIH0pOwogICAgICogICBbJ2EnLCdhJywnYSddLmV2ZXJ5KCdhJykgICAtPiB0cnVlCiAgICAgKiAgIFt7YToyfSx7YToyfV0uZXZlcnkoe2E6Mn0pIC0+IHRydWUKICAgICAqICAgdXNlcnMuZXZlcnkoeyBuYW1lOiAvXkgvIH0pIC0+IHRydWUgaWYgYWxsIGhhdmUgYSBuYW1lIHN0YXJ0aW5nIHdpdGggSAogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fHNlYXJjaEZufSBzZWFyY2gKICAgICAqIEBwYXJhbSB7YW55fSBjb250ZXh0CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXlFbGVtZW50fSBlbAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5fSBhcnIKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdldmVyeSc6IGZpeEFyZ3VtZW50TGVuZ3RoKGVuaGFuY2VkRXZlcnkpLAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZmlsdGVyKHNlYXJjaCwgW2NvbnRleHRdKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBwb2x5ZmlsbCBFUzUKICAgICAqIEBzaG9ydCBSZXR1cm5zIGFueSBlbGVtZW50cyBpbiB0aGUgYXJyYXkgdGhhdCBtYXRjaCBgc2VhcmNoYC4KICAgICAqIEBleHRyYSBbY29udGV4dF0gaXMgdGhlIGB0aGlzYCBvYmplY3QuIEltcGxlbWVudHMgYGVuaGFuY2VkIG1hdGNoaW5nYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgc2VhcmNoRm4KICAgICAqCiAgICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBpICAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGFyciAgQSByZWZlcmVuY2UgdG8gdGhlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDNdLmZpbHRlcihmdW5jdGlvbihuKSB7CiAgICAgKiAgICAgcmV0dXJuIG4gPiAxOwogICAgICogICB9KTsKICAgICAqICAgWzEsMiwyLDRdLmZpbHRlcigyKSAtPiAyCiAgICAgKiAgIHVzZXJzLmZpbHRlcih7IG5hbWU6IC9eSC8gfSkgLT4gYWxsIHVzZXJzIHdpdGggYSBuYW1lIHN0YXJ0aW5nIHdpdGggSAogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fHNlYXJjaEZufSBzZWFyY2gKICAgICAqIEBwYXJhbSB7YW55fSBjb250ZXh0CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXlFbGVtZW50fSBlbAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5fSBhcnIKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdmaWx0ZXInOiBmaXhBcmd1bWVudExlbmd0aChlbmhhbmNlZEZpbHRlciksCgogICAgLyoqKgogICAgICogQG1ldGhvZCBmaW5kKHNlYXJjaCwgW2NvbnRleHRdKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBwb2x5ZmlsbCBFUzYKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSBhcnJheSB0aGF0IG1hdGNoZXMgYHNlYXJjaGAuCiAgICAgKiBAZXh0cmEgSW1wbGVtZW50cyBgZW5oYW5jZWQgbWF0Y2hpbmdgLgogICAgICoKICAgICAqIEBjYWxsYmFjayBzZWFyY2hGbgogICAgICoKICAgICAqICAgZWwgICBUaGUgZWxlbWVudCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGkgICAgVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgYXJyICBBIHJlZmVyZW5jZSB0byB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIHVzZXJzLmZpbmQoZnVuY3Rpb24odXNlcikgewogICAgICogICAgIHJldHVybiB1c2VyLm5hbWUgPSAnSGFycnknOwogICAgICogICB9KTsgLT4gaGFycnkhCiAgICAgKgogICAgICogICB1c2Vycy5maW5kKHsgbmFtZTogJ0hhcnJ5JyB9KTsgLT4gaGFycnkhCiAgICAgKiAgIHVzZXJzLmZpbmQoeyBuYW1lOiAvXltBLUhdLyB9KTsgIC0+IEZpcnN0IHVzZXIgd2l0aCBuYW1lIHN0YXJ0aW5nIHdpdGggQS1ICiAgICAgKiAgIHVzZXJzLmZpbmQoeyB0aXRsZXM6IFsnTXMnLCAnRHInXSB9KTsgLT4gbm90IGhhcnJ5IQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fHNlYXJjaEZufSBzZWFyY2gKICAgICAqIEBwYXJhbSB7YW55fSBjb250ZXh0CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXlFbGVtZW50fSBlbAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5fSBhcnIKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdmaW5kJzogZml4QXJndW1lbnRMZW5ndGgoZW5oYW5jZWRGaW5kKSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGZpbmRJbmRleChzZWFyY2gsIFtjb250ZXh0XSkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHBvbHlmaWxsIEVTNgogICAgICogQHNob3J0IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSBhcnJheSB0aGF0IG1hdGNoZXMKICAgICAqICAgICAgICBgc2VhcmNoYCwgb3IgYC0xYCBpZiBub25lLgogICAgICogQGV4dHJhIFtjb250ZXh0XSBpcyB0aGUgYHRoaXNgIG9iamVjdC4gSW1wbGVtZW50cyBgZW5oYW5jZWQgbWF0Y2hpbmdgLgogICAgICoKICAgICAqIEBjYWxsYmFjayBzZWFyY2hGbgogICAgICoKICAgICAqICAgZWwgICBUaGUgZWxlbWVudCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGkgICAgVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgYXJyICBBIHJlZmVyZW5jZSB0byB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFsxLDIsMyw0XS5maW5kSW5kZXgoZnVuY3Rpb24obikgewogICAgICogICAgIHJldHVybiBuICUgMiA9PSAwOwogICAgICogICB9KTsgLT4gMQogICAgICogICBbJ2EnLCdiJywnYyddLmZpbmRJbmRleCgnYycpOyAgICAgICAgLT4gMgogICAgICogICBbJ2N1YmEnLCdqYXBhbicsJ2NhbmFkYSddLmZpbmQoL15jLykgLT4gMAogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fHNlYXJjaEZufSBzZWFyY2gKICAgICAqIEBwYXJhbSB7YW55fSBjb250ZXh0CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXlFbGVtZW50fSBlbAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5fSBhcnIKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdmaW5kSW5kZXgnOiBmaXhBcmd1bWVudExlbmd0aChlbmhhbmNlZEZpbmRJbmRleCkKCiAgfSwgW0VOSEFOQ0VNRU5UU19GTEFHLCBBUlJBWV9FTkhBTkNFTUVOVFNfRkxBR10pOwoKCiAgZGVmaW5lSW5zdGFuY2Uoc3VnYXJBcnJheSwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2Qgbm9uZShzZWFyY2gsIFtjb250ZXh0XSkKICAgICAqCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIG5vbmUgb2YgdGhlIGVsZW1lbnRzIGluIHRoZSBhcnJheSBtYXRjaCBgc2VhcmNoYC4KICAgICAqIEBleHRyYSBbY29udGV4dF0gaXMgdGhlIGB0aGlzYCBvYmplY3QuIEltcGxlbWVudHMgYGVuaGFuY2VkIG1hdGNoaW5nYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgc2VhcmNoRm4KICAgICAqCiAgICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBpICAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGFyciAgQSByZWZlcmVuY2UgdG8gdGhlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDNdLm5vbmUoNSkgICAgICAgICAtPiB0cnVlCiAgICAgKiAgIFsnYScsJ2InLCdjJ10ubm9uZSgvYi8pIC0+IGZhbHNlCiAgICAgKiAgIHVzZXJzLm5vbmUoZnVuY3Rpb24odXNlcikgewogICAgICogICAgIHJldHVybiB1c2VyLm5hbWUgPT0gJ1dvbHZlcmluZSc7CiAgICAgKiAgIH0pOyAtPiBwcm9iYWJseSB0cnVlCiAgICAgKiAgIHVzZXJzLm5vbmUoeyBuYW1lOiAnV29sdmVyaW5lJyB9KTsgLT4gc2FtZSBhcyBhYm92ZQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXlFbGVtZW50fHNlYXJjaEZufSBzZWFyY2gKICAgICAqIEBwYXJhbSB7YW55fSBjb250ZXh0CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXlFbGVtZW50fSBlbAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5fSBhcnIKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdub25lJzogZml4QXJndW1lbnRMZW5ndGgoYXJyYXlOb25lKSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGNvdW50KHNlYXJjaCwgW2NvbnRleHRdKQogICAgICogQHJldHVybnMgTnVtYmVyCiAgICAgKiBAc2hvcnQgQ291bnRzIGFsbCBlbGVtZW50cyBpbiB0aGUgYXJyYXkgdGhhdCBtYXRjaCBgc2VhcmNoYC4KICAgICAqIEBleHRyYSBJbXBsZW1lbnRzIGBlbmhhbmNlZCBtYXRjaGluZ2AuCiAgICAgKgogICAgICogQGNhbGxiYWNrIHNlYXJjaEZuCiAgICAgKgogICAgICogICBlbCAgIFRoZSBlbGVtZW50IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBhcnIgIEEgcmVmZXJlbmNlIHRvIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWydhJywnYicsJ2EnXS5jb3VudCgnYScpIC0+IDIKICAgICAqICAgWydhJywnYicsJ2MnXS5jb3VudCgvYi8pIC0+IDEKICAgICAqICAgdXNlcnMuY291bnQoZnVuY3Rpb24odXNlcikgewogICAgICogICAgIHJldHVybiB1c2VyLmFnZSA+IDMwOwogICAgICogICB9KTsgLT4gbnVtYmVyIG9mIHVzZXJzIG9sZGVyIHRoYW4gMzAKICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5RWxlbWVudHxzZWFyY2hGbn0gc2VhcmNoCiAgICAgKiBAcGFyYW0ge2FueX0gY29udGV4dAogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5RWxlbWVudH0gZWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtudW1iZXJ9IGkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheX0gYXJyCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtib29sZWFufSBzZWFyY2hGbgogICAgICoKICAgICAqKiovCiAgICAnY291bnQnOiBmaXhBcmd1bWVudExlbmd0aChhcnJheUNvdW50KSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIG1pbihbYWxsXSA9IGZhbHNlLCBbbWFwXSkKICAgICAqIEByZXR1cm5zIE1peGVkCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0aGUgZWxlbWVudCBpbiB0aGUgYXJyYXkgd2l0aCB0aGUgbG93ZXN0IHZhbHVlLgogICAgICogQGV4dHJhIFttYXBdIG1heSBiZSBwYXNzZWQgaW4gcGxhY2Ugb2YgW2FsbF0sIGFuZCBpcyBhIGZ1bmN0aW9uIG1hcHBpbmcgdGhlCiAgICAgKiAgICAgICAgdmFsdWUgdG8gYmUgY2hlY2tlZCBvciBhIHN0cmluZyBhY3RpbmcgYXMgYSBzaG9ydGN1dC4gSWYgW2FsbF0gaXMKICAgICAqICAgICAgICB0cnVlLCBtdWx0aXBsZSBlbGVtZW50cyB3aWxsIGJlIHJldHVybmVkLiBTdXBwb3J0cyBgZGVlcCBwcm9wZXJ0aWVzYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgbWFwRm4KICAgICAqCiAgICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBpICAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGFyciAgQSByZWZlcmVuY2UgdG8gdGhlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDNdLm1pbigpICAgICAgICAgICAgICAgICAgICAgICAgICAtPiAxCiAgICAgKiAgIFsnZmVlJywnZm8nLCdmdW0nXS5taW4oJ2xlbmd0aCcpICAgICAgIC0+ICdmbycKICAgICAqICAgWydmZWUnLCdmbycsJ2Z1bSddLm1pbih0cnVlLCAnbGVuZ3RoJykgLT4gWydmbyddCiAgICAgKiAgIHVzZXJzLm1pbignYWdlJykgICAgICAgICAgICAgICAgICAgICAgIC0+IHlvdW5nZXN0IGd1eSEKICAgICAqCiAgICAgKiAgIFsnZmVlJywnZm8nLCdmdW0nXS5taW4odHJ1ZSwgZnVuY3Rpb24obikgewogICAgICogICAgIHJldHVybiBuLmxlbmd0aDsKICAgICAqICAgfSk7IC0+IFsnZm8nXQogICAgICoKICAgICAqIEBzaWduYXR1cmUgbWluKFttYXBdKQogICAgICogQHBhcmFtIHtzdHJpbmd8bWFwRm59IG1hcAogICAgICogQHBhcmFtIHtib29sZWFufSBhbGwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXl9IGFycgogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3QXJyYXlFbGVtZW50fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnbWluJzogZnVuY3Rpb24oYXJyLCBhbGwsIG1hcCkgewogICAgICByZXR1cm4gZ2V0TWluT3JNYXgoYXJyLCBhbGwsIG1hcCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbWF4KFthbGxdID0gZmFsc2UsIFttYXBdKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBlbGVtZW50IGluIHRoZSBhcnJheSB3aXRoIHRoZSBncmVhdGVzdCB2YWx1ZS4KICAgICAqIEBleHRyYSBbbWFwXSBtYXkgYmUgcGFzc2VkIGluIHBsYWNlIG9mIFthbGxdLCBhbmQgaXMgYSBmdW5jdGlvbiBtYXBwaW5nIHRoZQogICAgICogICAgICAgIHZhbHVlIHRvIGJlIGNoZWNrZWQgb3IgYSBzdHJpbmcgYWN0aW5nIGFzIGEgc2hvcnRjdXQuIElmIFthbGxdIGlzCiAgICAgKiAgICAgICAgdHJ1ZSwgbXVsdGlwbGUgZWxlbWVudHMgd2lsbCBiZSByZXR1cm5lZC4gU3VwcG9ydHMgYGRlZXAgcHJvcGVydGllc2AuCiAgICAgKgogICAgICogQGNhbGxiYWNrIG1hcEZuCiAgICAgKgogICAgICogICBlbCAgIFRoZSBlbGVtZW50IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBhcnIgIEEgcmVmZXJlbmNlIHRvIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzXS5tYXgoKSAgICAgICAgICAgICAgICAgICAgICAgICAgLT4gMwogICAgICogICBbJ2ZlZScsJ2ZvJywnZnVtJ10ubWF4KCdsZW5ndGgnKSAgICAgICAtPiAnZmVlJwogICAgICogICBbJ2ZlZScsJ2ZvJywnZnVtJ10ubWF4KHRydWUsICdsZW5ndGgnKSAtPiBbJ2ZlZScsJ2Z1bSddCiAgICAgKiAgIHVzZXJzLm1heCgnYWdlJykgICAgICAgICAgICAgICAgICAgICAgIC0+IG9sZGVzdCBndXkhCiAgICAgKgogICAgICogICBbJ2ZlZScsJ2ZvJywnZnVtJ10ubWF4KHRydWUsIGZ1bmN0aW9uKG4pIHsKICAgICAqICAgICByZXR1cm4gbi5sZW5ndGg7CiAgICAgKiAgIH0pOyAtPiBbJ2ZlZScsICdmdW0nXQogICAgICoKICAgICAqIEBzaWduYXR1cmUgbWF4KFttYXBdKQogICAgICogQHBhcmFtIHtzdHJpbmd8bWFwRm59IG1hcAogICAgICogQHBhcmFtIHtib29sZWFufSBhbGwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXl9IGFycgogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3QXJyYXlFbGVtZW50fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnbWF4JzogZnVuY3Rpb24oYXJyLCBhbGwsIG1hcCkgewogICAgICByZXR1cm4gZ2V0TWluT3JNYXgoYXJyLCBhbGwsIG1hcCwgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbGVhc3QoW2FsbF0gPSBmYWxzZSwgW21hcF0pCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IFJldHVybnMgdGhlIGVsZW1lbnRzIGluIHRoZSBhcnJheSB3aXRoIHRoZSBsZWFzdCBjb21tb25seSBvY2N1cmluZyB2YWx1ZS4KICAgICAqIEBleHRyYSBbbWFwXSBtYXkgYmUgcGFzc2VkIGluIHBsYWNlIG9mIFthbGxdLCBhbmQgaXMgYSBmdW5jdGlvbiBtYXBwaW5nIHRoZQogICAgICogICAgICAgIHZhbHVlIHRvIGJlIGNoZWNrZWQgb3IgYSBzdHJpbmcgYWN0aW5nIGFzIGEgc2hvcnRjdXQuIElmIFthbGxdIGlzCiAgICAgKiAgICAgICAgdHJ1ZSwgd2lsbCByZXR1cm4gbXVsdGlwbGUgdmFsdWVzIGluIGFuIGFycmF5LgogICAgICogICAgICAgIFN1cHBvcnRzIGBkZWVwIHByb3BlcnRpZXNgLgogICAgICoKICAgICAqIEBjYWxsYmFjayBtYXBGbgogICAgICoKICAgICAqICAgZWwgICBUaGUgZWxlbWVudCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGkgICAgVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgYXJyICBBIHJlZmVyZW5jZSB0byB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIFszLDIsMl0ubGVhc3QoKSAtPiAzCiAgICAgKiAgIFsnZmUnLCdmbycsJ2Z1bSddLmxlYXN0KHRydWUsICdsZW5ndGgnKSAtPiBbJ2Z1bSddCiAgICAgKiAgIHVzZXJzLmxlYXN0KCdwcm9maWxlLnR5cGUnKSAgICAgICAgICAgICAtPiAodXNlciB3aXRoIGxlYXN0IGNvbW1vbmx5IG9jY3VycmluZyB0eXBlKQogICAgICogICB1c2Vycy5sZWFzdCh0cnVlLCAncHJvZmlsZS50eXBlJykgICAgICAgLT4gKHVzZXJzIHdpdGggbGVhc3QgY29tbW9ubHkgb2NjdXJyaW5nIHR5cGUpCiAgICAgKgogICAgICogQHNpZ25hdHVyZSBsZWFzdChbbWFwXSkKICAgICAqIEBwYXJhbSB7c3RyaW5nfG1hcEZufSBtYXAKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gYWxsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXlFbGVtZW50fSBlbAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge0FycmF5fSBhcnIKICAgICAqIEBjYWxsYmFja1JldHVybnMge05ld0FycmF5RWxlbWVudH0gbWFwRm4KICAgICAqCiAgICAgKioqLwogICAgJ2xlYXN0JzogZnVuY3Rpb24oYXJyLCBhbGwsIG1hcCkgewogICAgICByZXR1cm4gZ2V0TGVhc3RPck1vc3QoYXJyLCBhbGwsIG1hcCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbW9zdChbYWxsXSA9IGZhbHNlLCBbbWFwXSkKICAgICAqIEByZXR1cm5zIEFycmF5CiAgICAgKiBAc2hvcnQgUmV0dXJucyB0aGUgZWxlbWVudHMgaW4gdGhlIGFycmF5IHdpdGggdGhlIG1vc3QgY29tbW9ubHkgb2NjdXJpbmcgdmFsdWUuCiAgICAgKiBAZXh0cmEgW21hcF0gbWF5IGJlIHBhc3NlZCBpbiBwbGFjZSBvZiBbYWxsXSwgYW5kIGlzIGEgZnVuY3Rpb24gbWFwcGluZyB0aGUKICAgICAqICAgICAgICB2YWx1ZSB0byBiZSBjaGVja2VkIG9yIGEgc3RyaW5nIGFjdGluZyBhcyBhIHNob3J0Y3V0LiBJZiBbYWxsXSBpcwogICAgICogICAgICAgIHRydWUsIHdpbGwgcmV0dXJuIG11bHRpcGxlIHZhbHVlcyBpbiBhbiBhcnJheS4KICAgICAqICAgICAgICBTdXBwb3J0cyBgZGVlcCBwcm9wZXJ0aWVzYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgbWFwRm4KICAgICAqCiAgICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBpICAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGFyciAgQSByZWZlcmVuY2UgdG8gdGhlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMywyLDJdLm1vc3QoMikgLT4gMgogICAgICogICBbJ2ZlJywnZm8nLCdmdW0nXS5tb3N0KHRydWUsICdsZW5ndGgnKSAtPiBbJ2ZlJywnZm8nXQogICAgICogICB1c2Vycy5tb3N0KCdwcm9maWxlLnR5cGUnKSAgICAgICAgICAgICAtPiAodXNlciB3aXRoIG1vc3QgY29tbW9ubHkgb2NjdXJyaW5nIHR5cGUpCiAgICAgKiAgIHVzZXJzLm1vc3QodHJ1ZSwgJ3Byb2ZpbGUudHlwZScpICAgICAgIC0+ICh1c2VycyB3aXRoIG1vc3QgY29tbW9ubHkgb2NjdXJyaW5nIHR5cGUpCiAgICAgKgogICAgICogQHNpZ25hdHVyZSBtb3N0KFttYXBdKQogICAgICogQHBhcmFtIHtzdHJpbmd8bWFwRm59IG1hcAogICAgICogQHBhcmFtIHtib29sZWFufSBhbGwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXl9IGFycgogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3QXJyYXlFbGVtZW50fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnbW9zdCc6IGZ1bmN0aW9uKGFyciwgYWxsLCBtYXApIHsKICAgICAgcmV0dXJuIGdldExlYXN0T3JNb3N0KGFyciwgYWxsLCBtYXAsIHRydWUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHN1bShbbWFwXSkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IFN1bXMgYWxsIHZhbHVlcyBpbiB0aGUgYXJyYXkuCiAgICAgKiBAZXh0cmEgW21hcF0gbWF5IGJlIGEgZnVuY3Rpb24gbWFwcGluZyB0aGUgdmFsdWUgdG8gYmUgc3VtbWVkIG9yIGEgc3RyaW5nCiAgICAgKiAgICAgICAgYWN0aW5nIGFzIGEgc2hvcnRjdXQuCiAgICAgKgogICAgICogQGNhbGxiYWNrIG1hcEZuCiAgICAgKgogICAgICogICBlbCAgIFRoZSBlbGVtZW50IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBhcnIgIEEgcmVmZXJlbmNlIHRvIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwyXS5zdW0oKSAtPiA1CiAgICAgKiAgIHVzZXJzLnN1bShmdW5jdGlvbih1c2VyKSB7CiAgICAgKiAgICAgcmV0dXJuIHVzZXIudm90ZXM7CiAgICAgKiAgIH0pOyAtPiB0b3RhbCB2b3RlcyEKICAgICAqICAgdXNlcnMuc3VtKCd2b3RlcycpIC0+IHRvdGFsIHZvdGVzIQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG1hcEZufSBtYXAKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXl9IGFycgogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3QXJyYXlFbGVtZW50fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnc3VtJzogZnVuY3Rpb24oYXJyLCBtYXApIHsKICAgICAgcmV0dXJuIHN1bShhcnIsIG1hcCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgYXZlcmFnZShbbWFwXSkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IEdldHMgdGhlIG1lYW4gYXZlcmFnZSBmb3IgYWxsIHZhbHVlcyBpbiB0aGUgYXJyYXkuCiAgICAgKiBAZXh0cmEgW21hcF0gbWF5IGJlIGEgZnVuY3Rpb24gbWFwcGluZyB0aGUgdmFsdWUgdG8gYmUgYXZlcmFnZWQgb3IgYSBzdHJpbmcKICAgICAqICAgICAgICBhY3RpbmcgYXMgYSBzaG9ydGN1dC4gU3VwcG9ydHMgYGRlZXAgcHJvcGVydGllc2AuCiAgICAgKgogICAgICogQGNhbGxiYWNrIG1hcEZuCiAgICAgKgogICAgICogICBlbCAgIFRoZSBlbGVtZW50IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBhcnIgIEEgcmVmZXJlbmNlIHRvIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgWzEsMiwzLDRdLmF2ZXJhZ2UoKSAtPiAyCiAgICAgKiAgIHVzZXJzLmF2ZXJhZ2UoZnVuY3Rpb24odXNlcikgewogICAgICogICAgIHJldHVybiB1c2VyLmFnZTsKICAgICAqICAgfSk7IC0+IGF2ZXJhZ2UgdXNlciBhZ2UKICAgICAqICAgdXNlcnMuYXZlcmFnZSgnYWdlJykgLT4gYXZlcmFnZSB1c2VyIGFnZQogICAgICogICB1c2Vycy5hdmVyYWdlKCdjdXJyZW5jaWVzLnVzZC5iYWxhbmNlJykgLT4gYXZlcmFnZSBVU0QgYmFsYW5jZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG1hcEZufSBtYXAKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXl9IGFycgogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3QXJyYXlFbGVtZW50fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnYXZlcmFnZSc6IGZ1bmN0aW9uKGFyciwgbWFwKSB7CiAgICAgIHJldHVybiBhdmVyYWdlKGFyciwgbWFwKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBtZWRpYW4oW21hcF0pCiAgICAgKiBAcmV0dXJucyBOdW1iZXIKICAgICAqIEBzaG9ydCBHZXRzIHRoZSBtZWRpYW4gYXZlcmFnZSBmb3IgYWxsIHZhbHVlcyBpbiB0aGUgYXJyYXkuCiAgICAgKiBAZXh0cmEgW21hcF0gbWF5IGJlIGEgZnVuY3Rpb24gbWFwcGluZyB0aGUgdmFsdWUgdG8gYmUgYXZlcmFnZWQgb3IgYSBzdHJpbmcKICAgICAqICAgICAgICBhY3RpbmcgYXMgYSBzaG9ydGN1dC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgbWFwRm4KICAgICAqCiAgICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBpICAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGFyciAgQSByZWZlcmVuY2UgdG8gdGhlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBbMSwyLDJdLm1lZGlhbigpIC0+IDIKICAgICAqICAgW3thOjF9LHthOjJ9LHthOjJ9XS5tZWRpYW4oJ2EnKSAtPiAyCiAgICAgKiAgIHVzZXJzLm1lZGlhbignYWdlJykgLT4gbWVkaWFuIHVzZXIgYWdlCiAgICAgKiAgIHVzZXJzLm1lZGlhbignY3VycmVuY2llcy51c2QuYmFsYW5jZScpIC0+IG1lZGlhbiBVU0QgYmFsYW5jZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG1hcEZufSBtYXAKICAgICAqIEBjYWxsYmFja1BhcmFtIHtBcnJheUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7QXJyYXl9IGFycgogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3QXJyYXlFbGVtZW50fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnbWVkaWFuJzogZnVuY3Rpb24oYXJyLCBtYXApIHsKICAgICAgcmV0dXJuIG1lZGlhbihhcnIsIG1hcCk7CiAgICB9CgogIH0pOwoKCiAgLyoqKiBAbmFtZXNwYWNlIE9iamVjdCAqKiovCgogIC8vIE9iamVjdCBtYXRjaGVycwogIHZhciBvYmplY3RTb21lICA9IHdyYXBPYmplY3RNYXRjaGVyKCdzb21lJyksCiAgICAgIG9iamVjdEZpbmQgID0gd3JhcE9iamVjdE1hdGNoZXIoJ2ZpbmQnKSwKICAgICAgb2JqZWN0RXZlcnkgPSB3cmFwT2JqZWN0TWF0Y2hlcignZXZlcnknKTsKCiAgZnVuY3Rpb24gb2JqZWN0Rm9yRWFjaChvYmosIGZuKSB7CiAgICBhc3NlcnRDYWxsYWJsZShmbik7CiAgICBmb3JFYWNoUHJvcGVydHkob2JqLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICBmbih2YWwsIGtleSwgb2JqKTsKICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIG9iamVjdE1hcChvYmosIG1hcCkgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yRWFjaFByb3BlcnR5KG9iaiwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAgcmVzdWx0W2tleV0gPSBtYXBXaXRoU2hvcnRjdXRzKHZhbCwgbWFwLCBvYmosIFt2YWwsIGtleSwgb2JqXSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBvYmplY3RSZWR1Y2Uob2JqLCBmbiwgYWNjKSB7CiAgICB2YXIgaW5pdCA9IGlzRGVmaW5lZChhY2MpOwogICAgZm9yRWFjaFByb3BlcnR5KG9iaiwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAgaWYgKCFpbml0KSB7CiAgICAgICAgYWNjID0gdmFsOwogICAgICAgIGluaXQgPSB0cnVlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBhY2MgPSBmbihhY2MsIHZhbCwga2V5LCBvYmopOwogICAgfSk7CiAgICByZXR1cm4gYWNjOwogIH0KCiAgZnVuY3Rpb24gb2JqZWN0Tm9uZShvYmosIGYpIHsKICAgIHJldHVybiAhb2JqZWN0U29tZShvYmosIGYpOwogIH0KCiAgZnVuY3Rpb24gb2JqZWN0RmlsdGVyKG9iaiwgZikgewogICAgdmFyIG1hdGNoZXIgPSBnZXRNYXRjaGVyKGYpLCByZXN1bHQgPSB7fTsKICAgIGZvckVhY2hQcm9wZXJ0eShvYmosIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgIGlmIChtYXRjaGVyKHZhbCwga2V5LCBvYmopKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSB2YWw7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIG9iamVjdENvdW50KG9iaiwgZikgewogICAgdmFyIG1hdGNoZXIgPSBnZXRNYXRjaGVyKGYpLCBjb3VudCA9IDA7CiAgICBmb3JFYWNoUHJvcGVydHkob2JqLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICBpZiAobWF0Y2hlcih2YWwsIGtleSwgb2JqKSkgewogICAgICAgIGNvdW50Kys7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGNvdW50OwogIH0KCiAgLy8gU3VwcG9ydAoKICBmdW5jdGlvbiB3cmFwT2JqZWN0TWF0Y2hlcihuYW1lKSB7CiAgICB2YXIgbmF0aXZlRm4gPSBBcnJheS5wcm90b3R5cGVbbmFtZV07CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqLCBmKSB7CiAgICAgIHZhciBtYXRjaGVyID0gZ2V0TWF0Y2hlcihmKTsKICAgICAgcmV0dXJuIG5hdGl2ZUZuLmNhbGwoZ2V0S2V5cyhvYmopLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gbWF0Y2hlcihvYmpba2V5XSwga2V5LCBvYmopOwogICAgICB9KTsKICAgIH07CiAgfQoKICBkZWZpbmVJbnN0YW5jZUFuZFN0YXRpYyhzdWdhck9iamVjdCwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZm9yRWFjaChmbikKICAgICAqIEByZXR1cm5zIE9iamVjdAogICAgICogQHNob3J0IFJ1bnMgYGZuYCBhZ2FpbnN0IGVhY2ggcHJvcGVydHkgaW4gdGhlIG9iamVjdC4KICAgICAqIEBleHRyYSBEb2VzIG5vdCBpdGVyYXRlIG92ZXIgaW5oZXJpdGVkIG9yIG5vbi1lbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGVhY2hGbgogICAgICoKICAgICAqICAgdmFsICBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBrZXkgIFRoZSBrZXkgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBvYmogIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5mb3JFYWNoKHthOidiJ30sIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgKiAgICAgLy8gdmFsID0gJ2InLCBrZXkgPSBhCiAgICAgKiAgIH0pOwogICAgICoKICAgICAqIEBwYXJhbSB7ZWFjaEZufSBmbgogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKgogICAgICoqKi8KICAgICdmb3JFYWNoJzogZnVuY3Rpb24ob2JqLCBmbikgewogICAgICByZXR1cm4gb2JqZWN0Rm9yRWFjaChvYmosIGZuKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBtYXAobWFwKQogICAgICogQHJldHVybnMgT2JqZWN0CiAgICAgKiBAc2hvcnQgTWFwcyB0aGUgb2JqZWN0IHRvIGFub3RoZXIgb2JqZWN0IHdob3NlIHByb3BlcnRpZXMgYXJlIHRoZSB2YWx1ZXMKICAgICAqICAgICAgICByZXR1cm5lZCBieSBgbWFwYC4KICAgICAqIEBleHRyYSBgbWFwYCBjYW4gYWxzbyBiZSBhIHN0cmluZywgd2hpY2ggaXMgYSBzaG9ydGN1dCBmb3IgYSBmdW5jdGlvbiB0aGF0CiAgICAgKiAgICAgICAgZ2V0cyB0aGF0IHByb3BlcnR5IChvciBpbnZva2VzIGEgZnVuY3Rpb24pIG9uIGVhY2ggZWxlbWVudC4KICAgICAqICAgICAgICBTdXBwb3J0cyBgZGVlcCBwcm9wZXJ0aWVzYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgbWFwRm4KICAgICAqCiAgICAgKiAgIHZhbCAgVGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IHByb3BlcnR5LgogICAgICogICBrZXkgIFRoZSBrZXkgb2YgdGhlIGN1cnJlbnQgcHJvcGVydHkuCiAgICAgKiAgIG9iaiAgQSByZWZlcmVuY2UgdG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgZGF0YS5tYXAoZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAqICAgICByZXR1cm4ga2V5OwogICAgICogICB9KTsgLT4ge2E6J2InfQogICAgICogICB1c2Vycy5tYXAoJ2FnZScpOwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG1hcEZufSBtYXAKICAgICAqIEBjYWxsYmFja1BhcmFtIHtQcm9wZXJ0eX0gdmFsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7c3RyaW5nfSBrZXkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtPYmplY3R9IG9iagogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3UHJvcGVydHl9IG1hcEZuCiAgICAgKgogICAgICoqKi8KICAgICdtYXAnOiBmdW5jdGlvbihvYmosIG1hcCkgewogICAgICByZXR1cm4gb2JqZWN0TWFwKG9iaiwgbWFwKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBzb21lKHNlYXJjaCkKICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgYHNlYXJjaGAgaXMgdHJ1ZSBmb3IgYW55IHByb3BlcnR5IGluIHRoZSBvYmplY3QuCiAgICAgKiBAZXh0cmEgSW1wbGVtZW50cyBgZW5oYW5jZWQgbWF0Y2hpbmdgLgogICAgICoKICAgICAqIEBjYWxsYmFjayBzZWFyY2hGbgogICAgICoKICAgICAqICAgdmFsICBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBrZXkgIFRoZSBrZXkgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBvYmogIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5zb21lKHthOjEsYjoyfSwgZnVuY3Rpb24odmFsKSB7CiAgICAgKiAgICAgcmV0dXJuIHZhbCA9PSAxOwogICAgICogICB9KTsgLT4gdHJ1ZQogICAgICogICBPYmplY3Quc29tZSh7YToxLGI6Mn0sIDEpOyAtPiB0cnVlCiAgICAgKgogICAgICogQHBhcmFtIHtQcm9wZXJ0eXxzZWFyY2hGbn0gc2VhcmNoCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UHJvcGVydHl9IHZhbAogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30ga2V5CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7T2JqZWN0fSBvYmoKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdzb21lJzogb2JqZWN0U29tZSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGV2ZXJ5KHNlYXJjaCkKICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgYHNlYXJjaGAgaXMgdHJ1ZSBmb3IgYWxsIHByb3BlcnRpZXMgaW4gdGhlIG9iamVjdC4KICAgICAqIEBleHRyYSBJbXBsZW1lbnRzIGBlbmhhbmNlZCBtYXRjaGluZ2AuCiAgICAgKgogICAgICogQGNhbGxiYWNrIHNlYXJjaEZuCiAgICAgKgogICAgICogICB2YWwgIFRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGtleSAgVGhlIGtleSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIG9iaiAgQSByZWZlcmVuY2UgdG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LmV2ZXJ5KHthOjEsYjoyfSwgZnVuY3Rpb24odmFsKSB7CiAgICAgKiAgICAgcmV0dXJuIHZhbCA+IDA7CiAgICAgKiAgIH0pOyAtPiB0cnVlCiAgICAgKiAgIE9iamVjdC5ldmVyeSh7YTonYScsYjonYid9LCAvW2Etel0vKTsgLT4gdHJ1ZQogICAgICoKICAgICAqIEBwYXJhbSB7UHJvcGVydHl8c2VhcmNoRm59IHNlYXJjaAogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtib29sZWFufSBzZWFyY2hGbgogICAgICoKICAgICAqKiovCiAgICAnZXZlcnknOiBvYmplY3RFdmVyeSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGZpbHRlcihzZWFyY2gpCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IFJldHVybnMgYSBuZXcgb2JqZWN0IHdpdGggcHJvcGVydGllcyB0aGF0IG1hdGNoIGBzZWFyY2hgLgogICAgICogQGV4dHJhIEltcGxlbWVudHMgYGVuaGFuY2VkIG1hdGNoaW5nYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgc2VhcmNoRm4KICAgICAqCiAgICAgKiAgIHZhbCAgVGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAga2V5ICBUaGUga2V5IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgb2JqICBBIHJlZmVyZW5jZSB0byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuZmlsdGVyKHthOjEsYjoyfSwgZnVuY3Rpb24odmFsKSB7CiAgICAgKiAgICAgcmV0dXJuIHZhbCA9PSAxOwogICAgICogICB9KTsgLT4ge2E6MX0KICAgICAqICAgT2JqZWN0LmZpbHRlcih7YTonYScsejoneid9LCAvW2EtZl0vKTsgLT4ge2E6J2EnfQogICAgICogICBPYmplY3QuZmlsdGVyKHVzZXJzQnlOYW1lLCAvXkgvKTsgLT4gYWxsIHVzZXJzIHdpdGggbmFtZXMgc3RhcnRpbmcgd2l0aCBICiAgICAgKgogICAgICogQHBhcmFtIHtQcm9wZXJ0eXxzZWFyY2hGbn0gc2VhcmNoCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UHJvcGVydHl9IHZhbAogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30ga2V5CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7T2JqZWN0fSBvYmoKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdmaWx0ZXInOiBmdW5jdGlvbihvYmosIGYpIHsKICAgICAgcmV0dXJuIG9iamVjdEZpbHRlcihvYmosIGYpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJlZHVjZShyZWR1Y2VGbiwgW2luaXRdKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBzaG9ydCBSZWR1Y2VzIHRoZSBvYmplY3QgdG8gYSBzaW5nbGUgcmVzdWx0LgogICAgICogQGV4dHJhIFRoaXMgb3BlcmF0aW9uIGlzIHNvbWV0aW1lcyBjYWxsZWQgImFjY3VtdWxhdGlvbiIsIGFzIGl0IHRha2VzIHRoZQogICAgICogICAgICAgIHJlc3VsdCBvZiB0aGUgbGFzdCBpdGVyYXRpb24gb2YgYGZuYCBhbmQgcGFzc2VzIGl0IGFzIHRoZSBmaXJzdAogICAgICogICAgICAgIGFyZ3VtZW50IHRvIHRoZSBuZXh0IGl0ZXJhdGlvbiwgImFjY3VtdWxhdGluZyIgdGhhdCB2YWx1ZSBhcyBpdCBnb2VzLgogICAgICogICAgICAgIFRoZSByZXR1cm4gdmFsdWUgb2YgdGhpcyBtZXRob2Qgd2lsbCBiZSB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmaW5hbAogICAgICogICAgICAgIGl0ZXJhdGlvbiBvZiBgZm5gLiBJZiBbaW5pdF0gaXMgcGFzc2VkLCBpdCB3aWxsIGJlIHRoZSBpbml0aWFsCiAgICAgKiAgICAgICAgImFjY3VtdWxhdG9yIiAodGhlIGZpcnN0IGFyZ3VtZW50KS4gSWYgW2luaXRdIGlzIG5vdCBwYXNzZWQsIHRoZW4gYQogICAgICogICAgICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3Qgd2lsbCBiZSB1c2VkIGluc3RlYWQgYW5kIGBmbmAgd2lsbCBub3QgYmUKICAgICAqICAgICAgICBjYWxsZWQgZm9yIHRoYXQgcHJvcGVydHkuIE5vdGUgdGhhdCBvYmplY3QgcHJvcGVydGllcyBoYXZlIG5vIG9yZGVyLAogICAgICogICAgICAgIGFuZCB0aGlzIG1heSBsZWFkIHRvIGJ1Z3MgKGZvciBleGFtcGxlIGlmIHBlcmZvcm1pbmcgZGl2aXNpb24gb3IKICAgICAqICAgICAgICBzdWJ0cmFjdGlvbiBvcGVyYXRpb25zIG9uIGEgdmFsdWUpLiBJZiBvcmRlciBpcyBpbXBvcnRhbnQsIHVzZSBhbgogICAgICogICAgICAgIGFycmF5IGluc3RlYWQhCiAgICAgKgogICAgICogQGNhbGxiYWNrIHJlZHVjZUZuCiAgICAgKgogICAgICogICBhY2MgIFRoZSAiYWNjdW11bGF0b3IiLCBlaXRoZXIgW2luaXRdLCB0aGUgcmVzdWx0IG9mIHRoZSBsYXN0IGl0ZXJhdGlvbgogICAgICogICAgICAgIG9mIGBmbmAsIG9yIGEgcHJvcGVydHkgb2YgYG9iamAuCiAgICAgKiAgIHZhbCAgVGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IHByb3BlcnR5IGNhbGxlZCBmb3IgYGZuYC4KICAgICAqICAga2V5ICBUaGUga2V5IG9mIHRoZSBjdXJyZW50IHByb3BlcnR5IGNhbGxlZCBmb3IgYGZuYC4KICAgICAqICAgb2JqICBBIHJlZmVyZW5jZSB0byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QucmVkdWNlKHthOjIsYjo0fSwgZnVuY3Rpb24oYSwgYikgewogICAgICogICAgIHJldHVybiBhICogYjsKICAgICAqICAgfSk7IC0+IDgKICAgICAqCiAgICAgKiAgIE9iamVjdC5yZWR1Y2Uoe2E6MixiOjR9LCBmdW5jdGlvbihhLCBiKSB7CiAgICAgKiAgICAgcmV0dXJuIGEgKiBiOwogICAgICogICB9LCAxMCk7IC0+IDgwCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7cmVkdWNlRm59IHJlZHVjZUZuCiAgICAgKiBAcGFyYW0ge2FueX0gW2luaXRdCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UHJvcGVydHl9IGFjYwogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKgogICAgICoqKi8KICAgICdyZWR1Y2UnOiBmdW5jdGlvbihvYmosIGZuLCBpbml0KSB7CiAgICAgIHJldHVybiBvYmplY3RSZWR1Y2Uob2JqLCBmbiwgaW5pdCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZmluZChzZWFyY2gpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0aGUgZmlyc3Qga2V5IHdob3NlIHZhbHVlIG1hdGNoZXMgYHNlYXJjaGAuCiAgICAgKiBAZXh0cmEgSW1wbGVtZW50cyBgZW5oYW5jZWQgbWF0Y2hpbmdgLiBOb3RlIHRoYXQgImZpcnN0IiBpcwogICAgICogICAgICAgIGltcGxlbWVudGF0aW9uLWRlcGVuZGVudC4gSWYgb3JkZXIgaXMgaW1wb3J0YW50IGFuIGFycmF5IHNob3VsZCBiZQogICAgICogICAgICAgIHVzZWQgaW5zdGVhZC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgc2VhcmNoRm4KICAgICAqCiAgICAgKiAgIHZhbCAgVGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAga2V5ICBUaGUga2V5IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgb2JqICBBIHJlZmVyZW5jZSB0byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QuZmluZCh7YToxLGI6Mn0sIGZ1bmN0aW9uKHZhbCkgewogICAgICogICAgIHJldHVybiB2YWwgPT0gMjsKICAgICAqICAgfSk7IC0+ICdiJwogICAgICogICBPYmplY3QuZmluZCh7YTonYScsYjonYid9LCAvW2Etel0vKTsgLT4gJ2EnCiAgICAgKgogICAgICogQHBhcmFtIHtQcm9wZXJ0eXxzZWFyY2hGbn0gc2VhcmNoCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UHJvcGVydHl9IHZhbAogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30ga2V5CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7T2JqZWN0fSBvYmoKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdmaW5kJzogb2JqZWN0RmluZCwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGNvdW50KHNlYXJjaCkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IENvdW50cyBhbGwgcHJvcGVydGllcyBpbiB0aGUgb2JqZWN0IHRoYXQgbWF0Y2ggYHNlYXJjaGAuCiAgICAgKiBAZXh0cmEgSW1wbGVtZW50cyBgZW5oYW5jZWQgbWF0Y2hpbmdgLgogICAgICoKICAgICAqIEBjYWxsYmFjayBzZWFyY2hGbgogICAgICoKICAgICAqICAgdmFsICBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBrZXkgIFRoZSBrZXkgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBvYmogIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5jb3VudCh7YTonYScsYjonYicsYzonYSd9LCAnYScpIC0+IDIKICAgICAqICAgT2JqZWN0LmNvdW50KHVzZXJzQnlOYW1lLCBmdW5jdGlvbih1c2VyKSB7CiAgICAgKiAgICAgcmV0dXJuIHVzZXIuYWdlID4gMzA7CiAgICAgKiAgIH0pOyAtPiBudW1iZXIgb2YgdXNlcnMgb2xkZXIgdGhhbiAzMAogICAgICogICBPYmplY3QuY291bnQodXNlcnNCeU5hbWUsIHsgbmFtZTogL15bSC1aXS8gfSk7CiAgICAgKgogICAgICogQHBhcmFtIHtQcm9wZXJ0eXxzZWFyY2hGbn0gc2VhcmNoCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UHJvcGVydHl9IHZhbAogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30ga2V5CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7T2JqZWN0fSBvYmoKICAgICAqIEBjYWxsYmFja1JldHVybnMge2Jvb2xlYW59IHNlYXJjaEZuCiAgICAgKgogICAgICoqKi8KICAgICdjb3VudCc6IGZ1bmN0aW9uKG9iaiwgZikgewogICAgICByZXR1cm4gb2JqZWN0Q291bnQob2JqLCBmKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBub25lKHNlYXJjaCkKICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgbm9uZSBvZiB0aGUgcHJvcGVydGllcyBpbiB0aGUgb2JqZWN0IG1hdGNoIGBzZWFyY2hgLgogICAgICogQGV4dHJhIEltcGxlbWVudHMgYGVuaGFuY2VkIG1hdGNoaW5nYC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgc2VhcmNoRm4KICAgICAqCiAgICAgKiAgIHZhbCAgVGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAga2V5ICBUaGUga2V5IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgb2JqICBBIHJlZmVyZW5jZSB0byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3Qubm9uZSh7YToxLGI6Mn0sIDMpOyAtPiB0cnVlCiAgICAgKiAgIE9iamVjdC5ub25lKHVzZXJzQnlOYW1lLCBmdW5jdGlvbih1c2VyKSB7CiAgICAgKiAgICAgcmV0dXJuIHVzZXIubmFtZSA9PSAnV29sdmVyaW5lJzsKICAgICAqICAgfSk7IC0+IHByb2JhYmx5IHRydWUKICAgICAqCiAgICAgKiBAcGFyYW0ge1Byb3BlcnR5fHNlYXJjaEZufSBzZWFyY2gKICAgICAqIEBjYWxsYmFja1BhcmFtIHtQcm9wZXJ0eX0gdmFsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7c3RyaW5nfSBrZXkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtPYmplY3R9IG9iagogICAgICogQGNhbGxiYWNrUmV0dXJucyB7Ym9vbGVhbn0gc2VhcmNoRm4KICAgICAqCiAgICAgKioqLwogICAgJ25vbmUnOiBmdW5jdGlvbihvYmosIGYpIHsKICAgICAgcmV0dXJuIG9iamVjdE5vbmUob2JqLCBmKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBzdW0oW21hcF0pCiAgICAgKiBAcmV0dXJucyBOdW1iZXIKICAgICAqIEBzaG9ydCBTdW1zIGFsbCBwcm9wZXJ0aWVzIGluIHRoZSBvYmplY3QuCiAgICAgKiBAZXh0cmEgW21hcF0gbWF5IGJlIGEgZnVuY3Rpb24gbWFwcGluZyB0aGUgdmFsdWUgdG8gYmUgc3VtbWVkIG9yIGEgc3RyaW5nCiAgICAgKiAgICAgICAgYWN0aW5nIGFzIGEgc2hvcnRjdXQuCiAgICAgKgogICAgICogQGNhbGxiYWNrIG1hcEZuCiAgICAgKgogICAgICogICB2YWwgIFRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGtleSAgVGhlIGtleSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIG9iaiAgQSByZWZlcmVuY2UgdG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LnN1bSh7YTozNSxiOjEzfSk7IC0+IDQ4CiAgICAgKiAgIE9iamVjdC5zdW0odXNlcnNCeU5hbWUsIGZ1bmN0aW9uKHVzZXIpIHsKICAgICAqICAgICByZXR1cm4gdXNlci52b3RlczsKICAgICAqICAgfSk7IC0+IHRvdGFsIHVzZXIgdm90ZXMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xtYXBGbn0gbWFwCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UHJvcGVydHl9IHZhbAogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30ga2V5CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7T2JqZWN0fSBvYmoKICAgICAqIEBjYWxsYmFja1JldHVybnMge05ld1Byb3BlcnR5fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnc3VtJzogZnVuY3Rpb24ob2JqLCBtYXApIHsKICAgICAgcmV0dXJuIHN1bShvYmosIG1hcCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgYXZlcmFnZShbbWFwXSkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IEdldHMgdGhlIG1lYW4gYXZlcmFnZSBvZiBhbGwgcHJvcGVydGllcyBpbiB0aGUgb2JqZWN0LgogICAgICogQGV4dHJhIFttYXBdIG1heSBiZSBhIGZ1bmN0aW9uIG1hcHBpbmcgdGhlIHZhbHVlIHRvIGJlIGF2ZXJhZ2VkIG9yIGEgc3RyaW5nCiAgICAgKiAgICAgICAgYWN0aW5nIGFzIGEgc2hvcnRjdXQuCiAgICAgKgogICAgICogQGNhbGxiYWNrIG1hcEZuCiAgICAgKgogICAgICogICB2YWwgIFRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGtleSAgVGhlIGtleSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIG9iaiAgQSByZWZlcmVuY2UgdG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0LmF2ZXJhZ2Uoe2E6MzUsYjoxMX0pOyAtPiAyMwogICAgICogICBPYmplY3QuYXZlcmFnZSh1c2Vyc0J5TmFtZSwgJ2FnZScpOyAtPiBhdmVyYWdlIHVzZXIgYWdlCiAgICAgKiAgIE9iamVjdC5hdmVyYWdlKHVzZXJzQnlOYW1lLCAnY3VycmVuY2llcy51c2QuYmFsYW5jZScpOyAtPiBVU0QgbWVhbiBiYWxhbmNlCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8bWFwRm59IG1hcAogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtOZXdQcm9wZXJ0eX0gbWFwRm4KICAgICAqCiAgICAgKioqLwogICAgJ2F2ZXJhZ2UnOiBmdW5jdGlvbihvYmosIG1hcCkgewogICAgICByZXR1cm4gYXZlcmFnZShvYmosIG1hcCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbWVkaWFuKFttYXBdKQogICAgICogQHJldHVybnMgTnVtYmVyCiAgICAgKiBAc2hvcnQgR2V0cyB0aGUgbWVkaWFuIGF2ZXJhZ2Ugb2YgYWxsIHByb3BlcnRpZXMgaW4gdGhlIG9iamVjdC4KICAgICAqIEBleHRyYSBbbWFwXSBtYXkgYmUgYSBmdW5jdGlvbiBtYXBwaW5nIHRoZSB2YWx1ZSB0byBiZSBhdmVyYWdlZCBvciBhIHN0cmluZwogICAgICogICAgICAgIGFjdGluZyBhcyBhIHNob3J0Y3V0LgogICAgICoKICAgICAqIEBjYWxsYmFjayBtYXBGbgogICAgICoKICAgICAqICAgdmFsICBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBrZXkgIFRoZSBrZXkgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBvYmogIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5tZWRpYW4oe2E6MSxiOjIsYzoyfSkgLT4gMgogICAgICogICBPYmplY3QubWVkaWFuKHVzZXJzQnlOYW1lLCAnYWdlJyk7IC0+IG1lZGlhbiB1c2VyIGFnZQogICAgICogICBPYmplY3QubWVkaWFuKHVzZXJzQnlOYW1lLCAnY3VycmVuY2llcy51c2QuYmFsYW5jZScpOyAtPiBVU0QgbWVkaWFuIGJhbGFuY2UKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xtYXBGbn0gbWFwCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UHJvcGVydHl9IHZhbAogICAgICogQGNhbGxiYWNrUGFyYW0ge3N0cmluZ30ga2V5CiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7T2JqZWN0fSBvYmoKICAgICAqIEBjYWxsYmFja1JldHVybnMge05ld1Byb3BlcnR5fSBtYXBGbgogICAgICoKICAgICAqKiovCiAgICAnbWVkaWFuJzogZnVuY3Rpb24ob2JqLCBtYXApIHsKICAgICAgcmV0dXJuIG1lZGlhbihvYmosIG1hcCk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbWluKFthbGxdID0gZmFsc2UsIFttYXBdKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBrZXkgb2YgdGhlIHByb3BlcnR5IGluIHRoZSBvYmplY3Qgd2l0aCB0aGUgbG93ZXN0IHZhbHVlLgogICAgICogQGV4dHJhIElmIFthbGxdIGlzIHRydWUsIHdpbGwgcmV0dXJuIGFuIG9iamVjdCB3aXRoIGFsbCBwcm9wZXJ0aWVzIGluIHRoZQogICAgICogICAgICAgIG9iamVjdCB3aXRoIHRoZSBsb3dlc3QgdmFsdWUuIFttYXBdIG1heSBiZSBwYXNzZWQgaW4gcGxhY2Ugb2YgW2FsbF0KICAgICAqICAgICAgICBhbmQgaXMgYSBmdW5jdGlvbiBtYXBwaW5nIHRoZSB2YWx1ZSB0byBiZSBjaGVja2VkIG9yIGEgc3RyaW5nIGFjdGluZwogICAgICogICAgICAgIGFzIGEgc2hvcnRjdXQuCiAgICAgKgogICAgICogQGNhbGxiYWNrIG1hcEZuCiAgICAgKgogICAgICogICB2YWwgIFRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGtleSAgVGhlIGtleSBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIG9iaiAgQSByZWZlcmVuY2UgdG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgT2JqZWN0Lm1pbih7YToxLGI6MixjOjN9KSAgICAgICAgICAgICAgICAgICAgLT4gJ2EnCiAgICAgKiAgIE9iamVjdC5taW4oe2E6J2FhYScsYjonYmInLGM6J2MnfSwgJ2xlbmd0aCcpIC0+ICdjJwogICAgICogICBPYmplY3QubWluKHthOjEsYjoxLGM6M30sIHRydWUpICAgICAgICAgICAgICAtPiB7YToxLGI6MX0KICAgICAqCiAgICAgKiBAc2lnbmF0dXJlIG1pbihbbWFwXSkKICAgICAqIEBwYXJhbSB7c3RyaW5nfG1hcEZufSBtYXAKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2FsbF0KICAgICAqIEBjYWxsYmFja1BhcmFtIHtQcm9wZXJ0eX0gdmFsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7c3RyaW5nfSBrZXkKICAgICAqIEBjYWxsYmFja1BhcmFtIHtPYmplY3R9IG9iagogICAgICogQGNhbGxiYWNrUmV0dXJucyB7TmV3UHJvcGVydHl9IG1hcEZuCiAgICAgKgogICAgICoqKi8KICAgICdtaW4nOiBmdW5jdGlvbihvYmosIGFsbCwgbWFwKSB7CiAgICAgIHJldHVybiBnZXRNaW5Pck1heChvYmosIGFsbCwgbWFwLCBmYWxzZSwgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbWF4KFthbGxdID0gZmFsc2UsIFttYXBdKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBrZXkgb2YgdGhlIHByb3BlcnR5IGluIHRoZSBvYmplY3Qgd2l0aCB0aGUgaGlnaGVzdCB2YWx1ZS4KICAgICAqIEBleHRyYSBJZiBbYWxsXSBpcyB0cnVlLCB3aWxsIHJldHVybiBhbiBvYmplY3Qgd2l0aCBhbGwgcHJvcGVydGllcyBpbiB0aGUKICAgICAqICAgICAgICBvYmplY3Qgd2l0aCB0aGUgaGlnaGVzdCB2YWx1ZS4gW21hcF0gbWF5IGJlIHBhc3NlZCBpbiBwbGFjZSBvZiBbYWxsXQogICAgICogICAgICAgIGFuZCBpcyBhIGZ1bmN0aW9uIG1hcHBpbmcgdGhlIHZhbHVlIHRvIGJlIGNoZWNrZWQgb3IgYSBzdHJpbmcgYWN0aW5nCiAgICAgKiAgICAgICAgYXMgYSBzaG9ydGN1dC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgbWFwRm4KICAgICAqCiAgICAgKiAgIHZhbCAgVGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAga2V5ICBUaGUga2V5IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgb2JqICBBIHJlZmVyZW5jZSB0byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBPYmplY3QubWF4KHthOjEsYjoyLGM6M30pICAgICAgICAgICAgICAgICAgICAtPiAnYycKICAgICAqICAgT2JqZWN0Lm1heCh7YTonYWFhJyxiOidiYicsYzonYyd9LCAnbGVuZ3RoJykgLT4gJ2EnCiAgICAgKiAgIE9iamVjdC5tYXgoe2E6MSxiOjMsYzozfSwgdHJ1ZSkgICAgICAgICAgICAgIC0+IHtiOjMsYzozfQogICAgICoKICAgICAqIEBzaWduYXR1cmUgbWF4KFttYXBdKQogICAgICogQHBhcmFtIHtzdHJpbmd8bWFwRm59IG1hcAogICAgICogQHBhcmFtIHtib29sZWFufSBbYWxsXQogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtOZXdQcm9wZXJ0eX0gbWFwRm4KICAgICAqCiAgICAgKioqLwogICAgJ21heCc6IGZ1bmN0aW9uKG9iaiwgYWxsLCBtYXApIHsKICAgICAgcmV0dXJuIGdldE1pbk9yTWF4KG9iaiwgYWxsLCBtYXAsIHRydWUsIHRydWUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGxlYXN0KFthbGxdID0gZmFsc2UsIFttYXBdKQogICAgICogQHJldHVybnMgTWl4ZWQKICAgICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBrZXkgb2YgdGhlIHByb3BlcnR5IGluIHRoZSBvYmplY3Qgd2l0aCB0aGUgbGVhc3QgY29tbW9ubHkKICAgICAqICAgICAgICBvY2N1cmluZyB2YWx1ZS4KICAgICAqIEBleHRyYSBJZiBbYWxsXSBpcyB0cnVlLCB3aWxsIHJldHVybiBhbiBvYmplY3Qgd2l0aCBhbGwgcHJvcGVydGllcyBpbiB0aGUKICAgICAqICAgICAgICBvYmplY3Qgd2l0aCB0aGUgbGVhc3QgY29tbW9uIHZhbHVlLiBbbWFwXSBtYXkgYmUgcGFzc2VkIGluIHBsYWNlIG9mCiAgICAgKiAgICAgICAgW2FsbF0gYW5kIGlzIGEgZnVuY3Rpb24gbWFwcGluZyB0aGUgdmFsdWUgdG8gYmUgY2hlY2tlZCBvciBhIHN0cmluZwogICAgICogICAgICAgIGFjdGluZyBhcyBhIHNob3J0Y3V0LgogICAgICoKICAgICAqIEBjYWxsYmFjayBtYXBGbgogICAgICoKICAgICAqICAgdmFsICBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBrZXkgIFRoZSBrZXkgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBvYmogIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5sZWFzdCh7YToxLGI6MyxjOjN9KSAgICAgICAgICAgICAgICAgICAtPiAnYScKICAgICAqICAgT2JqZWN0LmxlYXN0KHthOidhYScsYjonYmInLGM6J2MnfSwgJ2xlbmd0aCcpIC0+ICdjJwogICAgICogICBPYmplY3QubGVhc3Qoe2E6MSxiOjMsYzozfSwgdHJ1ZSkgICAgICAgICAgICAgLT4ge2E6MX0KICAgICAqCiAgICAgKiBAc2lnbmF0dXJlIGxlYXN0KFttYXBdKQogICAgICogQHBhcmFtIHtzdHJpbmd8bWFwRm59IG1hcAogICAgICogQHBhcmFtIHtib29sZWFufSBbYWxsXQogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtOZXdQcm9wZXJ0eX0gbWFwRm4KICAgICAqCiAgICAgKioqLwogICAgJ2xlYXN0JzogZnVuY3Rpb24ob2JqLCBhbGwsIG1hcCkgewogICAgICByZXR1cm4gZ2V0TGVhc3RPck1vc3Qob2JqLCBhbGwsIG1hcCwgZmFsc2UsIHRydWUpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIG1vc3QoW2FsbF0gPSBmYWxzZSwgW21hcF0pCiAgICAgKiBAcmV0dXJucyBNaXhlZAogICAgICogQHNob3J0IFJldHVybnMgdGhlIGtleSBvZiB0aGUgcHJvcGVydHkgaW4gdGhlIG9iamVjdCB3aXRoIHRoZSBtb3N0IGNvbW1vbmx5CiAgICAgKiAgICAgICAgb2NjdXJpbmcgdmFsdWUuCiAgICAgKiBAZXh0cmEgSWYgW2FsbF0gaXMgdHJ1ZSwgd2lsbCByZXR1cm4gYW4gb2JqZWN0IHdpdGggYWxsIHByb3BlcnRpZXMgaW4gdGhlCiAgICAgKiAgICAgICAgb2JqZWN0IHdpdGggdGhlIG1vc3QgY29tbW9uIHZhbHVlLiBbbWFwXSBtYXkgYmUgcGFzc2VkIGluIHBsYWNlIG9mCiAgICAgKiAgICAgICAgW2FsbF0gYW5kIGlzIGEgZnVuY3Rpb24gbWFwcGluZyB0aGUgdmFsdWUgdG8gYmUgY2hlY2tlZCBvciBhIHN0cmluZwogICAgICogICAgICAgIGFjdGluZyBhcyBhIHNob3J0Y3V0LgogICAgICoKICAgICAqIEBjYWxsYmFjayBtYXBGbgogICAgICoKICAgICAqICAgdmFsICBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBrZXkgIFRoZSBrZXkgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBvYmogIEEgcmVmZXJlbmNlIHRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE9iamVjdC5tb3N0KHthOjEsYjozLGM6M30pICAgICAgICAgICAgICAgICAgIC0+ICdiJwogICAgICogICBPYmplY3QubW9zdCh7YTonYWEnLGI6J2JiJyxjOidjJ30sICdsZW5ndGgnKSAtPiAnYScKICAgICAqICAgT2JqZWN0Lm1vc3Qoe2E6MSxiOjMsYzozfSwgdHJ1ZSkgICAgICAgICAgICAgLT4ge2I6MyxjOjN9CiAgICAgKgogICAgICogQHNpZ25hdHVyZSBtb3N0KFttYXBdKQogICAgICogQHBhcmFtIHtzdHJpbmd8bWFwRm59IG1hcAogICAgICogQHBhcmFtIHtib29sZWFufSBbYWxsXQogICAgICogQGNhbGxiYWNrUGFyYW0ge1Byb3BlcnR5fSB2YWwKICAgICAqIEBjYWxsYmFja1BhcmFtIHtzdHJpbmd9IGtleQogICAgICogQGNhbGxiYWNrUGFyYW0ge09iamVjdH0gb2JqCiAgICAgKiBAY2FsbGJhY2tSZXR1cm5zIHtOZXdQcm9wZXJ0eX0gbWFwRm4KICAgICAqCiAgICAgKioqLwogICAgJ21vc3QnOiBmdW5jdGlvbihvYmosIGFsbCwgbWFwKSB7CiAgICAgIHJldHVybiBnZXRMZWFzdE9yTW9zdChvYmosIGFsbCwgbWFwLCB0cnVlLCB0cnVlKTsKICAgIH0KCiAgfSk7CgoKICBidWlsZEZyb21JbmRleE1ldGhvZHMoKTsKCiAgLyoqKgogICAqIEBtb2R1bGUgTnVtYmVyCiAgICogQGRlc2NyaXB0aW9uIE51bWJlciBmb3JtYXR0aW5nLCBwcmVjaXNpb24gcm91bmRpbmcsIE1hdGggYWxpYXNlcywgYW5kIG1vcmUuCiAgICoKICAgKioqLwoKCiAgdmFyIE5VTUJFUl9PUFRJT05TID0gewogICAgJ2RlY2ltYWwnOiBIQUxGX1dJRFRIX1BFUklPRCwKICAgICd0aG91c2FuZHMnOiBIQUxGX1dJRFRIX0NPTU1BCiAgfTsKCiAgLy8gQWJicmV2aWF0aW9uIFVuaXRzCiAgdmFyIEJBU0lDX1VOSVRTICAgICAgICAgPSAnfGttYnQnLAogICAgICBNRU1PUllfVU5JVFMgICAgICAgID0gJ3xLTUdUUEUnLAogICAgICBNRU1PUllfQklOQVJZX1VOSVRTID0gJ3wsS2ksTWksR2ksVGksUGksRWknLAogICAgICBNRVRSSUNfVU5JVFNfU0hPUlQgID0gJ27OvG18aycsCiAgICAgIE1FVFJJQ19VTklUU19GVUxMICAgPSAneXphZnBuzrxtfEtNR1RQRVpZJzsKCgogIC8qKioKICAgKiBAbWV0aG9kIGdldE9wdGlvbihuYW1lKQogICAqIEByZXR1cm5zIE1peGVkCiAgICogQGFjY2Vzc29yCiAgICogQHNob3J0IEdldHMgYW4gb3B0aW9uIHVzZWQgaW50ZXJhbGx5IGJ5IE51bWJlci4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICBTdWdhci5OdW1iZXIuZ2V0T3B0aW9uKCd0aG91c2FuZHMnKTsKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICoKICAgKioqCiAgICogQG1ldGhvZCBzZXRPcHRpb24obmFtZSwgdmFsdWUpCiAgICogQGFjY2Vzc29yCiAgICogQHNob3J0IFNldHMgYW4gb3B0aW9uIHVzZWQgaW50ZXJhbGx5IGJ5IE51bWJlci4KICAgKiBAZXh0cmEgSWYgYHZhbHVlYCBpcyBgbnVsbGAsIHRoZSBkZWZhdWx0IHZhbHVlIHdpbGwgYmUgcmVzdG9yZWQuCiAgICogQG9wdGlvbnMKICAgKgogICAqICAgZGVjaW1hbCAgICAgQSBzdHJpbmcgdXNlZCBhcyB0aGUgZGVjaW1hbCBtYXJrZXIgYnkgYGZvcm1hdGAsIGBhYmJyYCwKICAgKiAgICAgICAgICAgICAgIGBtZXRyaWNgLCBhbmQgYGJ5dGVzYC4gRGVmYXVsdCBpcyBgLmAuCiAgICoKICAgKiAgIHRob3VzYW5kcyAgIEEgc3RyaW5nIHVzZWQgYXMgdGhlIHRob3VzYW5kcyBtYXJrZXIgYnkgYGZvcm1hdGAsIGBhYmJyYCwKICAgKiAgICAgICAgICAgICAgIGBtZXRyaWNgLCBhbmQgYGJ5dGVzYC4gRGVmYXVsdCBpcyBgLGAuCiAgICoKICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgIFN1Z2FyLk51bWJlci5zZXRPcHRpb24oJ2RlY2ltYWwnLCAnLCcpOwogICAqICAgU3VnYXIuTnVtYmVyLnNldE9wdGlvbigndGhvdXNhbmRzJywgJyAnKTsKICAgKgogICAqIEBzaWduYXR1cmUgc2V0T3B0aW9uKG9wdGlvbnMpCiAgICogQHBhcmFtIHtOdW1iZXJPcHRpb25zfSBvcHRpb25zCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKiBAcGFyYW0ge2FueX0gdmFsdWUKICAgKiBAb3B0aW9uIHtzdHJpbmd9IGRlY2ltYWwKICAgKiBAb3B0aW9uIHtzdHJpbmd9IHRob3VzYW5kcwogICAqCiAgICoqKi8KICB2YXIgX251bWJlck9wdGlvbnMgPSBkZWZpbmVPcHRpb25zQWNjZXNzb3Ioc3VnYXJOdW1iZXIsIE5VTUJFUl9PUFRJT05TKTsKCgogIGZ1bmN0aW9uIGFiYnJldmlhdGVOdW1iZXIobnVtLCBwcmVjaXNpb24sIHVzdHIsIGJ5dGVzKSB7CiAgICB2YXIgZml4ZWQgICAgICAgID0gbnVtLnRvRml4ZWQoMjApLAogICAgICAgIGRlY2ltYWxQbGFjZSA9IGZpeGVkLnNlYXJjaCgvXC4vKSwKICAgICAgICBudW1lcmFsUGxhY2UgPSBmaXhlZC5zZWFyY2goL1sxLTldLyksCiAgICAgICAgc2lnbmlmaWNhbnQgID0gZGVjaW1hbFBsYWNlIC0gbnVtZXJhbFBsYWNlLAogICAgICAgIHVuaXRzLCB1bml0LCBtaWQsIGksIGRpdmlzb3I7CiAgICBpZiAoc2lnbmlmaWNhbnQgPiAwKSB7CiAgICAgIHNpZ25pZmljYW50IC09IDE7CiAgICB9CiAgICB1bml0cyA9IGNvbW1hU3BsaXQodXN0cik7CiAgICBpZiAodW5pdHMubGVuZ3RoID09PSAxKSB7CiAgICAgIHVuaXRzID0gdXN0ci5zcGxpdCgnJyk7CiAgICB9CiAgICBtaWQgPSB1bml0cy5pbmRleE9mKCd8Jyk7CiAgICBpZiAobWlkID09PSAtMSkgewogICAgICAvLyBTa2lwcGluZyB0aGUgcGxhY2Vob2xkZXIgbWVhbnMgdGhlIHVuaXRzIHNob3VsZCBzdGFydCBmcm9tIHplcm8sCiAgICAgIC8vIG90aGVyd2lzZSBhc3N1bWUgdGhleSBlbmQgYXQgemVyby4KICAgICAgbWlkID0gdW5pdHNbMF0gPT09ICdfJyA/IDAgOiB1bml0cy5sZW5ndGg7CiAgICB9CiAgICBpID0gbWF4KG1pbihmbG9vcihzaWduaWZpY2FudCAvIDMpLCB1bml0cy5sZW5ndGggLSBtaWQgLSAxKSwgLW1pZCk7CiAgICB1bml0ID0gdW5pdHNbaSArIG1pZF07CiAgICB3aGlsZSAodW5pdCA9PT0gJ18nKSB7CiAgICAgIGkgKz0gaSA8IDAgPyAtMSA6IDE7CiAgICAgIHVuaXQgPSB1bml0c1tpICsgbWlkXTsKICAgIH0KICAgIGlmICh1bml0ID09PSAnfCcpIHsKICAgICAgdW5pdCA9ICcnOwogICAgfQogICAgaWYgKHNpZ25pZmljYW50IDwgLTkpIHsKICAgICAgcHJlY2lzaW9uID0gYWJzKHNpZ25pZmljYW50KSAtIDk7CiAgICB9CiAgICBkaXZpc29yID0gYnl0ZXMgPyBwb3coMiwgMTAgKiBpKSA6IHBvdygxMCwgaSAqIDMpOwogICAgcmV0dXJuIG51bWJlckZvcm1hdCh3aXRoUHJlY2lzaW9uKG51bSAvIGRpdmlzb3IsIHByZWNpc2lvbiB8fCAwKSkgKyB1bml0OwogIH0KCiAgZnVuY3Rpb24gbnVtYmVyRm9ybWF0KG51bSwgcGxhY2UpIHsKICAgIHZhciByZXN1bHQgPSAnJywgdGhvdXNhbmRzLCBkZWNpbWFsLCBmcmFjdGlvbiwgaW50ZWdlciwgc3BsaXQsIHN0cjsKCiAgICBkZWNpbWFsICAgPSBfbnVtYmVyT3B0aW9ucygnZGVjaW1hbCcpOwogICAgdGhvdXNhbmRzID0gX251bWJlck9wdGlvbnMoJ3Rob3VzYW5kcycpOwoKICAgIGlmIChpc051bWJlcihwbGFjZSkpIHsKICAgICAgc3RyID0gd2l0aFByZWNpc2lvbihudW0sIHBsYWNlIHx8IDApLnRvRml4ZWQobWF4KHBsYWNlLCAwKSk7CiAgICB9IGVsc2UgewogICAgICBzdHIgPSBudW0udG9TdHJpbmcoKTsKICAgIH0KCiAgICBzdHIgPSBzdHIucmVwbGFjZSgvXi0vLCAnJyk7CiAgICBzcGxpdCAgICA9IHBlcmlvZFNwbGl0KHN0cik7CiAgICBpbnRlZ2VyICA9IHNwbGl0WzBdOwogICAgZnJhY3Rpb24gPSBzcGxpdFsxXTsKICAgIGlmICgvZS8udGVzdChzdHIpKSB7CiAgICAgIHJlc3VsdCA9IHN0cjsKICAgIH0gZWxzZSB7CiAgICAgIGZvcih2YXIgaSA9IGludGVnZXIubGVuZ3RoOyBpID4gMDsgaSAtPSAzKSB7CiAgICAgICAgaWYgKGkgPCBpbnRlZ2VyLmxlbmd0aCkgewogICAgICAgICAgcmVzdWx0ID0gdGhvdXNhbmRzICsgcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBpbnRlZ2VyLnNsaWNlKG1heCgwLCBpIC0gMyksIGkpICsgcmVzdWx0OwogICAgICB9CiAgICB9CiAgICBpZiAoZnJhY3Rpb24pIHsKICAgICAgcmVzdWx0ICs9IGRlY2ltYWwgKyByZXBlYXRTdHJpbmcoJzAnLCAocGxhY2UgfHwgMCkgLSBmcmFjdGlvbi5sZW5ndGgpICsgZnJhY3Rpb247CiAgICB9CiAgICByZXR1cm4gKG51bSA8IDAgPyAnLScgOiAnJykgKyByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBpc0ludGVnZXIobikgewogICAgcmV0dXJuIG4gJSAxID09PSAwOwogIH0KCiAgZnVuY3Rpb24gaXNNdWx0aXBsZU9mKG4xLCBuMikgewogICAgcmV0dXJuIG4xICUgbjIgPT09IDA7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVSb3VuZGluZ0Z1bmN0aW9uKGZuKSB7CiAgICByZXR1cm4gZnVuY3Rpb24obiwgcHJlY2lzaW9uKSB7CiAgICAgIHJldHVybiBwcmVjaXNpb24gPyB3aXRoUHJlY2lzaW9uKG4sIHByZWNpc2lvbiwgZm4pIDogZm4obik7CiAgICB9OwogIH0KCiAgZGVmaW5lU3RhdGljKHN1Z2FyTnVtYmVyLCB7CgogICAgLyoqKgogICAgICogQG1ldGhvZCByYW5kb20oW24xXSwgW24yXSkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHN0YXRpYwogICAgICogQHNob3J0IFJldHVybnMgYSByYW5kb20gaW50ZWdlciBmcm9tIFtuMV0gdG8gW24yXSAoYm90aCBpbmNsdXNpdmUpLgogICAgICogQGV4dHJhIElmIG9ubHkgMSBudW1iZXIgaXMgcGFzc2VkLCB0aGUgb3RoZXIgd2lsbCBiZSAwLiBJZiBub25lIGFyZSBwYXNzZWQsCiAgICAgKiAgICAgICAgdGhlIG51bWJlciB3aWxsIGJlIGVpdGhlciAwIG9yIDEuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE51bWJlci5yYW5kb20oNTAsIDEwMCkgLT4gZXguIDg1CiAgICAgKiAgIE51bWJlci5yYW5kb20oNTApICAgICAgLT4gZXguIDI3CiAgICAgKiAgIE51bWJlci5yYW5kb20oKSAgICAgICAgLT4gZXguIDAKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW24xXQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtuMl0KICAgICAqCiAgICAgKioqLwogICAgJ3JhbmRvbSc6IGZ1bmN0aW9uKG4xLCBuMikgewogICAgICB2YXIgbWluTnVtLCBtYXhOdW07CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIG4yID0gbjEsIG4xID0gMDsKICAgICAgbWluTnVtID0gbWluKG4xIHx8IDAsIGlzVW5kZWZpbmVkKG4yKSA/IDEgOiBuMik7CiAgICAgIG1heE51bSA9IG1heChuMSB8fCAwLCBpc1VuZGVmaW5lZChuMikgPyAxIDogbjIpICsgMTsKICAgICAgcmV0dXJuIHRydW5jKChNYXRoLnJhbmRvbSgpICogKG1heE51bSAtIG1pbk51bSkpICsgbWluTnVtKTsKICAgIH0KCiAgfSk7CgogIGRlZmluZUluc3RhbmNlKHN1Z2FyTnVtYmVyLCB7CgogICAgLyoqKgogICAgICogQG1ldGhvZCBpc0ludGVnZXIoKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgbnVtYmVyIGhhcyBubyB0cmFpbGluZyBkZWNpbWFsLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAoNDIwKS5pc0ludGVnZXIoKSAtPiB0cnVlCiAgICAgKiAgICg0LjUpLmlzSW50ZWdlcigpIC0+IGZhbHNlCiAgICAgKgogICAgICoqKi8KICAgICdpc0ludGVnZXInOiBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBpc0ludGVnZXIobik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaXNPZGQoKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgbnVtYmVyIGlzIG9kZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgKDMpLmlzT2RkKCkgIC0+IHRydWUKICAgICAqICAgKDE4KS5pc09kZCgpIC0+IGZhbHNlCiAgICAgKgogICAgICoqKi8KICAgICdpc09kZCc6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIGlzSW50ZWdlcihuKSAmJiAhaXNNdWx0aXBsZU9mKG4sIDIpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGlzRXZlbigpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIHRoZSBudW1iZXIgaXMgZXZlbi4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgKDYpLmlzRXZlbigpICAtPiB0cnVlCiAgICAgKiAgICgxNykuaXNFdmVuKCkgLT4gZmFsc2UKICAgICAqCiAgICAgKioqLwogICAgJ2lzRXZlbic6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIGlzTXVsdGlwbGVPZihuLCAyKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBpc011bHRpcGxlT2YobnVtKQogICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICogQHNob3J0IFJldHVybnMgdHJ1ZSBpZiB0aGUgbnVtYmVyIGlzIGEgbXVsdGlwbGUgb2YgYG51bWAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICg2KS5pc011bHRpcGxlT2YoMikgIC0+IHRydWUKICAgICAqICAgKDE3KS5pc011bHRpcGxlT2YoMikgLT4gZmFsc2UKICAgICAqICAgKDMyKS5pc011bHRpcGxlT2YoNCkgLT4gdHJ1ZQogICAgICogICAoMzQpLmlzTXVsdGlwbGVPZig0KSAtPiBmYWxzZQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW0KICAgICAqCiAgICAgKioqLwogICAgJ2lzTXVsdGlwbGVPZic6IGZ1bmN0aW9uKG4sIG51bSkgewogICAgICByZXR1cm4gaXNNdWx0aXBsZU9mKG4sIG51bSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbG9nKFtiYXNlXSA9IE1hdGguRSkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IFJldHVybnMgdGhlIGxvZ2FyaXRobSBvZiB0aGUgbnVtYmVyIHdpdGggYGJhc2VgLCBvciB0aGUgbmF0dXJhbAogICAgICogICAgICAgIGxvZ2FyaXRobSBvZiB0aGUgbnVtYmVyIGlmIGBiYXNlYCBpcyB1bmRlZmluZWQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICg2NCkubG9nKDIpIC0+IDYKICAgICAqICAgKDkpLmxvZygzKSAgLT4gMgogICAgICogICAoNSkubG9nKCkgICAtPiAxLjYwOTQzNzkxMjQzNDEwMDMKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Jhc2VdCiAgICAgKgogICAgICoqKi8KICAgICdsb2cnOiBmdW5jdGlvbihuLCBiYXNlKSB7CiAgICAgIHJldHVybiBNYXRoLmxvZyhuKSAvIChiYXNlID8gTWF0aC5sb2coYmFzZSkgOiAxKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBhYmJyKFtwcmVjaXNpb25dID0gMCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJldHVybnMgYW4gYWJicmV2aWF0ZWQgZm9ybSBvZiB0aGUgbnVtYmVyICgiayIgZm9yIHRob3VzYW5kLCAibSIKICAgICAqICAgICAgICBmb3IgbWlsbGlvbiwgZXRjKS4KICAgICAqIEBleHRyYSBbcHJlY2lzaW9uXSB3aWxsIHJvdW5kIHRvIHRoZSBnaXZlbiBwcmVjaXNpb24uIGB0aG91c2FuZHNgIGFuZAogICAgICogICAgICAgIGBkZWNpbWFsYCBhbGxvdyBjdXN0b20gc2VwYXJhdG9ycyB0byBiZSB1c2VkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAoMTAwMCkuYWJicigpICAgIC0+ICIxayIKICAgICAqICAgKDEwMDAwMDApLmFiYnIoKSAtPiAiMW0iCiAgICAgKiAgICgxMjgwKS5hYmJyKDEpICAgLT4gIjEuM2siCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwcmVjaXNpb25dCiAgICAgKgogICAgICoqKi8KICAgICdhYmJyJzogZnVuY3Rpb24obiwgcHJlY2lzaW9uKSB7CiAgICAgIHJldHVybiBhYmJyZXZpYXRlTnVtYmVyKG4sIHByZWNpc2lvbiwgQkFTSUNfVU5JVFMpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIG1ldHJpYyhbcHJlY2lzaW9uXSA9IDAsIFt1bml0c10gPSAibs68bXxrIikKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJldHVybnMgdGhlIG51bWJlciBhcyBhIHN0cmluZyBpbiBtZXRyaWMgbm90YXRpb24uCiAgICAgKiBAZXh0cmEgW3ByZWNpc2lvbl0gd2lsbCByb3VuZCB0byB0aGUgZ2l2ZW4gcHJlY2lzaW9uIChjYW4gYmUgbmVnYXRpdmUpLgogICAgICogICAgICAgIFt1bml0c10gaXMgYSBzdHJpbmcgdGhhdCBkZXRlcm1pbmVzIGJvdGggdGhlIHVuaXQgbm90YXRpb24gYW5kIHRoZQogICAgICogICAgICAgIG1pbi9tYXggdW5pdCBhbGxvd2VkLiBUaGUgZGVmYXVsdCBpcyBuYXR1cmFsIG5vdGF0aW9uIGZvciBjb21tb24KICAgICAqICAgICAgICB1bml0cyAobWV0ZXJzLCBncmFtcywgZXRjKS4gImFsbCIgY2FuIGJlIHBhc3NlZCBmb3IgW3VuaXRzXSBhbmQgaXMgYQogICAgICogICAgICAgIHNob3J0Y3V0IHRvIGFsbCBzdGFuZGFyZCBTSSB1bml0cy4gVGhlIHRva2VuIGAsYCBpZiBwcmVzZW50IHNlcGFyYXRlcwogICAgICogICAgICAgIHVuaXRzLCBvdGhlcndpc2UgZWFjaCBjaGFyYWN0ZXIgaXMgYSB1bml0LiBUaGUgdG9rZW4gYHxgIGlmIHByZXNlbnQKICAgICAqICAgICAgICBtYXJrcyB3aGVyZSBmcmFjdGlvbmFsIHVuaXRzIGVuZCwgb3RoZXJ3aXNlIG5vIGZyYWN0aW9uYWwgdW5pdHMgYXJlCiAgICAgKiAgICAgICAgdXNlZC4gRmluYWxseSwgdGhlIHRva2VuIGBfYCBpZiBwcmVzZW50IGlzIGEgcGxhY2Vob2xkZXIgZm9yIG5vIHVuaXQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICgxMDAwKS5tZXRyaWMoKSAgICAgICAgLT4gIjFrIgogICAgICogICAoMTAwMDAwMCkubWV0cmljKCkgICAgIC0+ICIxLDAwMGsiCiAgICAgKiAgICgxMjQ5KS5tZXRyaWMoMikgKyAnZycgLT4gIjEuMjVrZyIKICAgICAqICAgKDAuMDI1KS5tZXRyaWMoKSArICdtJyAtPiAiMjVtbSIKICAgICAqICAgKDEwMDAwMDApLm1ldHJpYygwLCAnbs68bXxrTScpIC0+ICIxTSIKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3ByZWNpc2lvbl0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdW5pdHNdCiAgICAgKgogICAgICoqKi8KICAgICdtZXRyaWMnOiBmdW5jdGlvbihuLCBwcmVjaXNpb24sIHVuaXRzKSB7CiAgICAgIGlmICh1bml0cyA9PT0gJ2FsbCcpIHsKICAgICAgICB1bml0cyA9IE1FVFJJQ19VTklUU19GVUxMOwogICAgICB9IGVsc2UgaWYgKCF1bml0cykgewogICAgICAgIHVuaXRzID0gTUVUUklDX1VOSVRTX1NIT1JUOwogICAgICB9CiAgICAgIHJldHVybiBhYmJyZXZpYXRlTnVtYmVyKG4sIHByZWNpc2lvbiwgdW5pdHMpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGJ5dGVzKFtwcmVjaXNpb25dID0gMCwgW2JpbmFyeV0gPSBmYWxzZSwgW3VuaXRzXSA9ICdzaScpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZXR1cm5zIGFuIGFiYnJldmlhdGVkIGZvcm0gb2YgdGhlIG51bWJlciwgd2l0aCAnQicgb24gdGhlIGVuZCBmb3IgImJ5dGVzIi4KICAgICAqIEBleHRyYSBbcHJlY2lzaW9uXSB3aWxsIHJvdW5kIHRvIHRoZSBnaXZlbiBwcmVjaXNpb24uIElmIFtiaW5hcnldIGlzIGB0cnVlYCwKICAgICAqICAgICAgICBwb3dlcnMgb2YgMTAyNCB3aWxsIGJlIHVzZWQgaW5zdGVhZCBvZiAxMDAwLCBhbmQgdW5pdHMgd2lsbCBkZWZhdWx0CiAgICAgKiAgICAgICAgdG8gdGhlIGJpbmFyeSB1bml0cyAiS2lCIiwgIk1pQiIsIGV0Yy4gVW5pdHMgY2FuIGJlIG92ZXJyaWRkZW4gYnkKICAgICAqICAgICAgICBwYXNzaW5nICJzaSIgb3IgImJpbmFyeSIgZm9yIFt1bml0c10sIG9yIGZ1cnRoZXIgY3VzdG9taXplZCBieQogICAgICogICAgICAgIHBhc3NpbmcgYSB1bml0IHN0cmluZy4gU2VlIGBtZXRyaWNgIGZvciBtb3JlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAoMTAwMCkuYnl0ZXMoKSAgICAgICAgICAgICAgICAgLT4gIjFLQiIKICAgICAqICAgKDEyODkpLmJ5dGVzKDIpICAgICAgICAgICAgICAgIC0+ICIxLjI5S0IiCiAgICAgKiAgICgxMDAwKS5ieXRlcygyLCB0cnVlKSAgICAgICAgICAtPiAiMC45OEtpQiIKICAgICAqICAgKDEwMDApLmJ5dGVzKDIsIHRydWUsICdzaScpICAgIC0+ICIwLjk4S0IiCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwcmVjaXNpb25dCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtiaW5hcnldCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3VuaXRzXQogICAgICoKICAgICAqKiovCiAgICAnYnl0ZXMnOiBmdW5jdGlvbihuLCBwcmVjaXNpb24sIGJpbmFyeSwgdW5pdHMpIHsKICAgICAgaWYgKHVuaXRzID09PSAnYmluYXJ5JyB8fCAoIXVuaXRzICYmIGJpbmFyeSkpIHsKICAgICAgICB1bml0cyA9IE1FTU9SWV9CSU5BUllfVU5JVFM7CiAgICAgIH0gZWxzZSBpZih1bml0cyA9PT0gJ3NpJyB8fCAhdW5pdHMpIHsKICAgICAgICB1bml0cyA9IE1FTU9SWV9VTklUUzsKICAgICAgfQogICAgICByZXR1cm4gYWJicmV2aWF0ZU51bWJlcihuLCBwcmVjaXNpb24sIHVuaXRzLCBiaW5hcnkpICsgJ0InOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGZvcm1hdChbcGxhY2VdID0gMCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IEZvcm1hdHMgdGhlIG51bWJlciB0byBhIHJlYWRhYmxlIHN0cmluZy4KICAgICAqIEBleHRyYSBJZiBbcGxhY2VdIGlzIGB1bmRlZmluZWRgLCB0aGUgcGxhY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGJlIGRldGVybWluZWQuCiAgICAgKiAgICAgICAgYHRob3VzYW5kc2AgYW5kIGBkZWNpbWFsYCBhbGxvdyBjdXN0b20gbWFya2VycyB0byBiZSB1c2VkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAoNTY3ODIpLmZvcm1hdCgpICAgIC0+ICc1Niw3ODInCiAgICAgKiAgICg1Njc4MikuZm9ybWF0KDIpICAgLT4gJzU2LDc4Mi4wMCcKICAgICAqICAgKDQzODguNDMpLmZvcm1hdCgyKSAtPiAnNCwzODguNDMnCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwbGFjZV0KICAgICAqCiAgICAgKioqLwogICAgJ2Zvcm1hdCc6IGZ1bmN0aW9uKG4sIHBsYWNlKSB7CiAgICAgIHJldHVybiBudW1iZXJGb3JtYXQobiwgcGxhY2UpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGhleChbcGFkXSA9IDEpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBDb252ZXJ0cyB0aGUgbnVtYmVyIHRvIGhleGlkZWNpbWFsLgogICAgICogQGV4dHJhIFtwYWRdIHdpbGwgcGFkIHRoZSByZXN1bHRpbmcgc3RyaW5nIHRvIHRoYXQgbWFueSBwbGFjZXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICgyNTUpLmhleCgpICAgLT4gJ2ZmJzsKICAgICAqICAgKDI1NSkuaGV4KDQpICAtPiAnMDBmZic7CiAgICAgKiAgICgyMzY1NCkuaGV4KCkgLT4gJzVjNjYnOwogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcGFkXQogICAgICoKICAgICAqKiovCiAgICAnaGV4JzogZnVuY3Rpb24obiwgcGFkKSB7CiAgICAgIHJldHVybiBwYWROdW1iZXIobiwgcGFkIHx8IDEsIGZhbHNlLCAxNik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgdGltZXMoZm4pCiAgICAgKiBAcmV0dXJucyBNaXhlZAogICAgICogQHNob3J0IENhbGxzIGBmbmAgYSBudW1iZXIgb2YgdGltZXMgZXF1aXZhbGVudCB0byB0aGUgbnVtYmVyLgogICAgICogQGV4dHJhIEFueSBub24tdW5kZWZpbmVkIHJldHVybiB2YWx1ZXMgb2YgYGZuYCB3aWxsIGJlIGNvbGxlY3RlZCBhbmQKICAgICAqICAgICAgICByZXR1cm5lZCBpbiBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgaW5kZXhNYXBGbgogICAgICoKICAgICAqICAgaSAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICg4KS50aW1lcyhsb2dIZWxsbykgLT4gbG9ncyAiaGVsbG8iIDggdGltZXMKICAgICAqICAgKDcpLnRpbWVzKGZ1bmN0aW9uKG4pIHsKICAgICAqICAgICByZXR1cm4gTWF0aC5wb3coMiwgbik7CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqIEBjYWxsYmFja1BhcmFtIHtudW1iZXJ9IGkKICAgICAqIEBjYWxsYmFja1JldHVybnMge2FueX0gaW5kZXhNYXBGbgogICAgICogQHBhcmFtIHtpbmRleE1hcEZufSBmbgogICAgICoKICAgICAqKiovCiAgICAndGltZXMnOiBmdW5jdGlvbihuLCBmbikgewogICAgICB2YXIgYXJyLCByZXN1bHQ7CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgICByZXN1bHQgPSBmbi5jYWxsKG4sIGkpOwogICAgICAgIGlmIChpc0RlZmluZWQocmVzdWx0KSkgewogICAgICAgICAgaWYgKCFhcnIpIHsKICAgICAgICAgICAgYXJyID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBhcnIucHVzaChyZXN1bHQpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJyOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGNocigpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZXR1cm5zIGEgc3RyaW5nIGF0IHRoZSBjb2RlIHBvaW50IG9mIHRoZSBudW1iZXIuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICg2NSkuY2hyKCkgLT4gIkEiCiAgICAgKiAgICg3NSkuY2hyKCkgLT4gIksiCiAgICAgKgogICAgICoqKi8KICAgICdjaHInOiBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBjaHIobik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgcGFkKFtwbGFjZV0gPSAwLCBbc2lnbl0gPSBmYWxzZSwgW2Jhc2VdID0gMTApCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBQYWRzIGEgbnVtYmVyIHdpdGggIjAiIHRvIGBwbGFjZWAuCiAgICAgKiBAZXh0cmEgW3NpZ25dIGFsbG93cyB5b3UgdG8gZm9yY2UgdGhlIHNpZ24gYXMgd2VsbCAoKzA1LCBldGMpLiBbYmFzZV0gY2FuCiAgICAgKiAgICAgICAgY2hhbmdlIHRoZSBiYXNlIGZvciBudW1lcmFsIGNvbnZlcnNpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICg1KS5wYWQoMikgICAgICAgIC0+ICcwNScKICAgICAqICAgKC01KS5wYWQoNCkgICAgICAgLT4gJy0wMDA1JwogICAgICogICAoODIpLnBhZCgzLCB0cnVlKSAtPiAnKzA4MicKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gcGxhY2UKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3NpZ25dCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Jhc2VdCiAgICAgKgogICAgICoqKi8KICAgICdwYWQnOiBmdW5jdGlvbihuLCBwbGFjZSwgc2lnbiwgYmFzZSkgewogICAgICByZXR1cm4gcGFkTnVtYmVyKG4sIHBsYWNlLCBzaWduLCBiYXNlKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBvcmRpbmFsaXplKCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJldHVybnMgYW4gb3JkaW5hbGl6ZWQgRW5nbGlzaCBzdHJpbmcsIGkuZS4gIjFzdCIsICIybmQiLCBldGMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICgxKS5vcmRpbmFsaXplKCkgLT4gJzFzdCc7CiAgICAgKiAgICgyKS5vcmRpbmFsaXplKCkgLT4gJzJuZCc7CiAgICAgKiAgICg4KS5vcmRpbmFsaXplKCkgLT4gJzh0aCc7CiAgICAgKgogICAgICoqKi8KICAgICdvcmRpbmFsaXplJzogZnVuY3Rpb24obikgewogICAgICB2YXIgbnVtID0gYWJzKG4pLCBsYXN0ID0gK251bS50b1N0cmluZygpLnNsaWNlKC0yKTsKICAgICAgcmV0dXJuIG4gKyBnZXRPcmRpbmFsU3VmZml4KGxhc3QpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHRvTnVtYmVyKCkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IElkZW50aXR5IGZ1bmN0aW9uIGZvciBjb21wYXRpYmlsdHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICg0MjApLnRvTnVtYmVyKCkgLT4gNDIwCiAgICAgKgogICAgICoqKi8KICAgICd0b051bWJlcic6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4udmFsdWVPZigpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJvdW5kKFtwcmVjaXNpb25dID0gMCkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IFNob3J0Y3V0IGZvciBgTWF0aC5yb3VuZGAgdGhhdCBhbHNvIGFsbG93cyBhIGBwcmVjaXNpb25gLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAoMy4yNDEpLnJvdW5kKCkgIC0+IDMKICAgICAqICAgKC0zLjg0MSkucm91bmQoKSAtPiAtNAogICAgICogICAoMy4yNDEpLnJvdW5kKDIpIC0+IDMuMjQKICAgICAqICAgKDM3NDgpLnJvdW5kKC0yKSAtPiAzODAwCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwcmVjaXNpb25dCiAgICAgKgogICAgICoqKi8KICAgICdyb3VuZCc6IGNyZWF0ZVJvdW5kaW5nRnVuY3Rpb24ocm91bmQpLAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgY2VpbChbcHJlY2lzaW9uXSA9IDApCiAgICAgKiBAcmV0dXJucyBOdW1iZXIKICAgICAqIEBzaG9ydCBTaG9ydGN1dCBmb3IgYE1hdGguY2VpbGAgdGhhdCBhbHNvIGFsbG93cyBhIGBwcmVjaXNpb25gLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAoMy4yNDEpLmNlaWwoKSAgLT4gNAogICAgICogICAoLTMuMjQxKS5jZWlsKCkgLT4gLTMKICAgICAqICAgKDMuMjQxKS5jZWlsKDIpIC0+IDMuMjUKICAgICAqICAgKDM3NDgpLmNlaWwoLTIpIC0+IDM4MDAKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3ByZWNpc2lvbl0KICAgICAqCiAgICAgKioqLwogICAgJ2NlaWwnOiBjcmVhdGVSb3VuZGluZ0Z1bmN0aW9uKGNlaWwpLAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZmxvb3IoW3ByZWNpc2lvbl0gPSAwKQogICAgICogQHJldHVybnMgTnVtYmVyCiAgICAgKiBAc2hvcnQgU2hvcnRjdXQgZm9yIGBNYXRoLmZsb29yYCB0aGF0IGFsc28gYWxsb3dzIGEgYHByZWNpc2lvbmAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICgzLjI0MSkuZmxvb3IoKSAgLT4gMwogICAgICogICAoLTMuODQxKS5mbG9vcigpIC0+IC00CiAgICAgKiAgICgzLjI0MSkuZmxvb3IoMikgLT4gMy4yNAogICAgICogICAoMzc0OCkuZmxvb3IoLTIpIC0+IDM3MDAKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3ByZWNpc2lvbl0KICAgICAqCiAgICAgKioqLwogICAgJ2Zsb29yJzogY3JlYXRlUm91bmRpbmdGdW5jdGlvbihmbG9vcikKCiAgfSk7CgogIC8qKioKICAgKiBAbWV0aG9kIFttYXRoXSgpCiAgICogQHJldHVybnMgTnVtYmVyCiAgICogQHNob3J0IE1hdGggcmVsYXRlZCBmdW5jdGlvbnMgYXJlIG1hcHBlZCBhcyBzaG9ydGN1dHMgdG8gbnVtYmVycyBhbmQgYXJlCiAgICogICAgICAgIGlkZW50aWNhbC4gTm90ZSB0aGF0IGBsb2dgIHByb3ZpZGVzIHNvbWUgc3BlY2lhbCBkZWZhdWx0cy4KICAgKgogICAqIEBzZXQKICAgKiAgIGFicwogICAqICAgc2luCiAgICogICBhc2luCiAgICogICBjb3MKICAgKiAgIGFjb3MKICAgKiAgIHRhbgogICAqICAgYXRhbgogICAqICAgc3FydAogICAqICAgZXhwCiAgICogICBwb3cKICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICgzKS5wb3coMykgLT4gMjcKICAgKiAgICgtMykuYWJzKCkgLT4gMwogICAqICAgKDEwMjQpLnNxcnQoKSAtPiAzMgogICAqCiAgICoqKi8KICBmdW5jdGlvbiBidWlsZE1hdGhBbGlhc2VzKCkgewogICAgZGVmaW5lSW5zdGFuY2VTaW1pbGFyKHN1Z2FyTnVtYmVyLCAnYWJzIHBvdyBzaW4gYXNpbiBjb3MgYWNvcyB0YW4gYXRhbiBleHAgcG93IHNxcnQnLCBmdW5jdGlvbihtZXRob2RzLCBuYW1lKSB7CiAgICAgIG1ldGhvZHNbbmFtZV0gPSBmdW5jdGlvbihuLCBhcmcpIHsKICAgICAgICAvLyBOb3RlIHRoYXQgLnZhbHVlT2YoKSBoZXJlIGlzIG9ubHkgcmVxdWlyZWQgZHVlIHRvIGEKICAgICAgICAvLyB2ZXJ5IHN0cmFuZ2UgYnVnIGluIGlPUzcgdGhhdCBvbmx5IG9jY3VycyBvY2Nhc2lvbmFsbHkKICAgICAgICAvLyBpbiB3aGljaCBNYXRoLmFicygpIGNhbGxlZCBvbiBub24tcHJpbWl0aXZlIG51bWJlcnMKICAgICAgICAvLyByZXR1cm5zIGEgY29tcGxldGVseSBkaWZmZXJlbnQgbnVtYmVyIChJc3N1ZSAjNDAwKQogICAgICAgIHJldHVybiBNYXRoW25hbWVdKG4udmFsdWVPZigpLCBhcmcpOwogICAgICB9OwogICAgfSk7CiAgfQoKICBidWlsZE1hdGhBbGlhc2VzKCk7CgogIC8qKioKICAgKiBAbW9kdWxlIEZ1bmN0aW9uCiAgICogQGRlc2NyaXB0aW9uIExhenksIHRocm90dGxlZCwgYW5kIG1lbW9pemVkIGZ1bmN0aW9ucywgZGVsYXllZCBmdW5jdGlvbnMgYW5kCiAgICogICAgICAgICAgICAgIGhhbmRsaW5nIG9mIHRpbWVycywgYXJndW1lbnQgY3VycnlpbmcuCiAgICoKICAgKioqLwoKICB2YXIgX2xvY2sgICAgID0gcHJpdmF0ZVByb3BlcnR5QWNjZXNzb3IoJ2xvY2snKTsKICB2YXIgX3RpbWVycyAgID0gcHJpdmF0ZVByb3BlcnR5QWNjZXNzb3IoJ3RpbWVycycpOwogIHZhciBfcGFydGlhbCAgPSBwcml2YXRlUHJvcGVydHlBY2Nlc3NvcigncGFydGlhbCcpOwogIHZhciBfY2FuY2VsZWQgPSBwcml2YXRlUHJvcGVydHlBY2Nlc3NvcignY2FuY2VsZWQnKTsKCiAgdmFyIGNyZWF0ZUluc3RhbmNlRnJvbVByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUgfHwgZnVuY3Rpb24ocHJvdG90eXBlKSB7CiAgICB2YXIgY3RvciA9IGZ1bmN0aW9uKCkge307CiAgICBjdG9yLnByb3RvdHlwZSA9IHByb3RvdHlwZTsKICAgIHJldHVybiBuZXcgY3RvcjsKICB9OwoKICBmdW5jdGlvbiBzZXREZWxheShmbiwgbXMsIGFmdGVyLCBzY29wZSwgYXJncykgewogICAgLy8gRGVsYXkgb2YgaW5maW5pdHkgaXMgbmV2ZXIgY2FsbGVkIG9mIGNvdXJzZS4uLgogICAgbXMgPSBjb2VyY2VQb3NpdGl2ZUludGVnZXIobXMgfHwgMCk7CiAgICBpZiAoIV90aW1lcnMoZm4pKSB7CiAgICAgIF90aW1lcnMoZm4sIFtdKTsKICAgIH0KICAgIC8vIFRoaXMgaXMgYSB3b3JrYXJvdW5kIGZvciA8PSBJRTgsIHdoaWNoIGFwcGFyZW50bHkgaGFzIHRoZQogICAgLy8gYWJpbGl0eSB0byBjYWxsIHRpbWVvdXRzIGluIHRoZSBxdWV1ZSBvbiB0aGUgc2FtZSB0aWNrIChtcz8pCiAgICAvLyBldmVuIGlmIGZ1bmN0aW9uYWxseSB0aGV5IGhhdmUgYWxyZWFkeSBiZWVuIGNsZWFyZWQuCiAgICBfY2FuY2VsZWQoZm4sIGZhbHNlKTsKICAgIF90aW1lcnMoZm4pLnB1c2goc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgaWYgKCFfY2FuY2VsZWQoZm4pKSB7CiAgICAgICAgYWZ0ZXIuYXBwbHkoc2NvcGUsIGFyZ3MgfHwgW10pOwogICAgICB9CiAgICB9LCBtcykpOwogIH0KCiAgZnVuY3Rpb24gY2FuY2VsRnVuY3Rpb24oZm4pIHsKICAgIHZhciB0aW1lcnMgPSBfdGltZXJzKGZuKSwgdGltZXI7CiAgICBpZiAoaXNBcnJheSh0aW1lcnMpKSB7CiAgICAgIHdoaWxlKHRpbWVyID0gdGltZXJzLnNoaWZ0KCkpIHsKICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICB9CiAgICB9CiAgICBfY2FuY2VsZWQoZm4sIHRydWUpOwogICAgcmV0dXJuIGZuOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlTGF6eUZ1bmN0aW9uKGZuLCBtcywgaW1tZWRpYXRlLCBsaW1pdCkgewogICAgdmFyIHF1ZXVlID0gW10sIGxvY2tlZCA9IGZhbHNlLCBleGVjdXRlLCByb3VuZGVkLCBwZXJFeGVjdXRpb24sIHJlc3VsdDsKICAgIG1zID0gbXMgfHwgMTsKICAgIGxpbWl0ID0gbGltaXQgfHwgSW5maW5pdHk7CiAgICByb3VuZGVkID0gY2VpbChtcyk7CiAgICBwZXJFeGVjdXRpb24gPSByb3VuZChyb3VuZGVkIC8gbXMpIHx8IDE7CiAgICBleGVjdXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBxdWV1ZUxlbmd0aCA9IHF1ZXVlLmxlbmd0aCwgbWF4UGVyUm91bmQ7CiAgICAgIGlmIChxdWV1ZUxlbmd0aCA9PSAwKSByZXR1cm47CiAgICAgIC8vIEFsbG93IGZyYWN0aW9ucyBvZiBhIG1pbGxpc2Vjb25kIGJ5IGNhbGxpbmcKICAgICAgLy8gbXVsdGlwbGUgdGltZXMgcGVyIGFjdHVhbCB0aW1lb3V0IGV4ZWN1dGlvbgogICAgICBtYXhQZXJSb3VuZCA9IG1heChxdWV1ZUxlbmd0aCAtIHBlckV4ZWN1dGlvbiwgMCk7CiAgICAgIHdoaWxlKHF1ZXVlTGVuZ3RoID4gbWF4UGVyUm91bmQpIHsKICAgICAgICAvLyBHZXR0aW5nIHViZXItbWV0YSBoZXJlLi4uCiAgICAgICAgcmVzdWx0ID0gRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmFwcGx5KGZuLCBxdWV1ZS5zaGlmdCgpKTsKICAgICAgICBxdWV1ZUxlbmd0aC0tOwogICAgICB9CiAgICAgIHNldERlbGF5KGxhenksIHJvdW5kZWQsIGZ1bmN0aW9uKCkgewogICAgICAgIGxvY2tlZCA9IGZhbHNlOwogICAgICAgIGV4ZWN1dGUoKTsKICAgICAgfSk7CiAgICB9OwogICAgZnVuY3Rpb24gbGF6eSgpIHsKICAgICAgLy8gSWYgdGhlIGV4ZWN1dGlvbiBoYXMgbG9ja2VkIGFuZCBpdCdzIGltbWVkaWF0ZSwgdGhlbgogICAgICAvLyBhbGxvdyAxIGxlc3MgaW4gdGhlIHF1ZXVlIGFzIDEgY2FsbCBoYXMgYWxyZWFkeSB0YWtlbiBwbGFjZS4KICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA8IGxpbWl0IC0gKGxvY2tlZCAmJiBpbW1lZGlhdGUgPyAxIDogMCkpIHsKICAgICAgICAvLyBPcHRpbWl6ZWQ6IG5vIGxlYWtpbmcgYXJndW1lbnRzCiAgICAgICAgdmFyIGFyZ3MgPSBbXTsgZm9yKHZhciAkaSA9IDAsICRsZW4gPSBhcmd1bWVudHMubGVuZ3RoOyAkaSA8ICRsZW47ICRpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbJGldKTsKICAgICAgICBxdWV1ZS5wdXNoKFt0aGlzLCBhcmdzXSk7CiAgICAgIH0KICAgICAgaWYgKCFsb2NrZWQpIHsKICAgICAgICBsb2NrZWQgPSB0cnVlOwogICAgICAgIGlmIChpbW1lZGlhdGUpIHsKICAgICAgICAgIGV4ZWN1dGUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2V0RGVsYXkobGF6eSwgcm91bmRlZCwgZXhlY3V0ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFJldHVybiB0aGUgbWVtb2l6ZWQgcmVzdWx0CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICByZXR1cm4gbGF6eTsKICB9CgogIC8vIENvbGxlY3RpbmcgYXJndW1lbnRzIGluIGFuIGFycmF5IGluc3RlYWQgb2YKICAvLyBwYXNzaW5nIGJhY2sgdGhlIGFyZ3VtZW50cyBvYmplY3Qgd2hpY2ggd2lsbAogIC8vIGRlb3B0IHRoaXMgZnVuY3Rpb24gaW4gVjguCiAgZnVuY3Rpb24gY29sbGVjdEFyZ3VtZW50cygpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLCBpID0gYXJncy5sZW5ndGgsIGFyciA9IG5ldyBBcnJheShpKTsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgYXJyW2ldID0gYXJnc1tpXTsKICAgIH0KICAgIHJldHVybiBhcnI7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVIYXNoZWRNZW1vaXplRnVuY3Rpb24oZm4sIGhhc2hGbiwgbGltaXQpIHsKICAgIHZhciBtYXAgPSB7fSwgcmVmcyA9IFtdLCBjb3VudGVyID0gMDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGhhc2hPYmogPSBoYXNoRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdmFyIGtleSA9IHNlcmlhbGl6ZUludGVybmFsKGhhc2hPYmosIHJlZnMpOwogICAgICBpZiAoaGFzT3duKG1hcCwga2V5KSkgewogICAgICAgIHJldHVybiBnZXRPd24obWFwLCBrZXkpOwogICAgICB9CiAgICAgIGlmIChjb3VudGVyID09PSBsaW1pdCkgewogICAgICAgIG1hcCA9IHt9OwogICAgICAgIHJlZnMgPSBbXTsKICAgICAgICBjb3VudGVyID0gMDsKICAgICAgfQogICAgICBjb3VudGVyKys7CiAgICAgIHJldHVybiBtYXBba2V5XSA9IGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KCiAgZGVmaW5lSW5zdGFuY2Uoc3VnYXJGdW5jdGlvbiwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgbGF6eShbbXNdID0gMSwgW2ltbWVkaWF0ZV0gPSBmYWxzZSwgW2xpbWl0XSA9IEluZmluaXR5KQogICAgICogQHJldHVybnMgRnVuY3Rpb24KICAgICAqIEBzaG9ydCBDcmVhdGVzIGEgbGF6eSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCByZXBlYXRlZGx5LCB3aWxsIHF1ZXVlCiAgICAgKiAgICAgICAgZXhlY3V0aW9uIGFuZCB3YWl0IFttc10gbWlsbGlzZWNvbmRzIHRvIGV4ZWN1dGUuCiAgICAgKiBAZXh0cmEgSWYgW2ltbWVkaWF0ZV0gaXMgYHRydWVgLCBmaXJzdCBleGVjdXRpb24gd2lsbCBoYXBwZW4gaW1tZWRpYXRlbHksCiAgICAgKiAgICAgICAgdGhlbiBsb2NrLiBJZiBbbGltaXRdIGlzIGEgZmluaW50ZSBudW1iZXIsIGNhbGxzIHBhc3QgW2xpbWl0XSB3aWxsCiAgICAgKiAgICAgICAgYmUgaWdub3JlZCB3aGlsZSBleGVjdXRpb24gaXMgbG9ja2VkLiBDb21wYXJlIHRoaXMgdG8gYHRocm90dGxlYCwKICAgICAqICAgICAgICB3aGljaCB3aWxsIGV4ZWN1dGUgb25seSBvbmNlIHBlciBbbXNdIG1pbGxpc2Vjb25kcy4gTm90ZSB0aGF0IFttc10KICAgICAqICAgICAgICBjYW4gYWxzbyBiZSBhIGZyYWN0aW9uLiBDYWxsaW5nIGBjYW5jZWxgIG9uIGEgbGF6eSBmdW5jdGlvbiB3aWxsCiAgICAgKiAgICAgICAgY2xlYXIgdGhlIGVudGlyZSBxdWV1ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgdmFyIGZuID0gbG9nSGVsbG8ubGF6eSgyNTApOwogICAgICogICBydW5UZW5UaW1lcyhmbik7IC0+IExvZ3MgMTAgdGltZXMgZWFjaCB0aW1lIDI1MG1zIGxhdGVyCiAgICAgKgogICAgICogICB2YXIgZm4gPSBsb2dIZWxsby5sYXp5KDI1MCwgZmFsc2UsIDUpOwogICAgICogICBydW5UZW5UaW1lcyhmbik7IC0+IExvZ3MgNSB0aW1lcyBlYWNoIHRpbWUgMjUwbXMgbGF0ZXIKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21zXQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtsaW1pdF0KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ltbWVkaWF0ZV0KICAgICAqCiAgICAgKioqLwogICAgJ2xhenknOiBmdW5jdGlvbihmbiwgbXMsIGltbWVkaWF0ZSwgbGltaXQpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUxhenlGdW5jdGlvbihmbiwgbXMsIGltbWVkaWF0ZSwgbGltaXQpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHRocm90dGxlKFttc10gPSAxKQogICAgICogQHJldHVybnMgRnVuY3Rpb24KICAgICAqIEBzaG9ydCBDcmVhdGVzIGEgInRocm90dGxlZCIgdmVyc2lvbiBvZiB0aGUgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUKICAgICAqICAgICAgICBleGVjdXRlZCBvbmNlIHBlciBgbXNgIG1pbGxpc2Vjb25kcy4KICAgICAqIEBleHRyYSBUaGlzIGlzIGZ1bmN0aW9uYWxseSBlcXVpdmFsZW50IHRvIGNhbGxpbmcgYGxhenlgIHdpdGggYSBbbGltaXRdIG9mCiAgICAgKiAgICAgICAgYDFgIGFuZCBbaW1tZWRpYXRlXSBhcyBgdHJ1ZWAuIGB0aHJvdHRsZWAgaXMgYXBwcm9wcmlhdGUgd2hlbiB5b3UKICAgICAqICAgICAgICB3YW50IHRvIG1ha2Ugc3VyZSBhIGZ1bmN0aW9uIGlzIG9ubHkgZXhlY3V0ZWQgYXQgbW9zdCBvbmNlIGZvciBhCiAgICAgKiAgICAgICAgZ2l2ZW4gZHVyYXRpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIHZhciBmbiA9IGxvZ0hlbGxvLnRocm90dGxlKDUwKTsKICAgICAqICAgcnVuVGVuVGltZXMoZm4pOwogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbXNdCiAgICAgKgogICAgICoqKi8KICAgICd0aHJvdHRsZSc6IGZ1bmN0aW9uKGZuLCBtcykgewogICAgICByZXR1cm4gY3JlYXRlTGF6eUZ1bmN0aW9uKGZuLCBtcywgdHJ1ZSwgMSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZGVib3VuY2UoW21zXSA9IDEpCiAgICAgKiBAcmV0dXJucyBGdW5jdGlvbgogICAgICogQHNob3J0IENyZWF0ZXMgYSAiZGVib3VuY2VkIiBmdW5jdGlvbiB0aGF0IHBvc3Rwb25lcyBpdHMgZXhlY3V0aW9uIHVudGlsCiAgICAgKiAgICAgICAgYWZ0ZXIgYG1zYCBtaWxsaXNlY29uZHMgaGF2ZSBwYXNzZWQuCiAgICAgKiBAZXh0cmEgVGhpcyBtZXRob2QgaXMgdXNlZnVsIHRvIGV4ZWN1dGUgYSBmdW5jdGlvbiBhZnRlciB0aGluZ3MgaGF2ZQogICAgICogICAgICAgICJzZXR0bGVkIGRvd24iLiBBIGdvb2QgZXhhbXBsZSBvZiB0aGlzIGlzIHdoZW4gYSB1c2VyIHRhYnMgcXVpY2tseQogICAgICogICAgICAgIHRocm91Z2ggZm9ybSBmaWVsZHMsIGV4ZWN1dGlvbiBvZiBhIGhlYXZ5IG9wZXJhdGlvbiBzaG91bGQgaGFwcGVuCiAgICAgKiAgICAgICAgYWZ0ZXIgYSBmZXcgbWlsbGlzZWNvbmRzIHdoZW4gdGhleSBoYXZlICJzZXR0bGVkIiBvbiBhIGZpZWxkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICB2YXIgZm4gPSBsb2dIZWxsby5kZWJvdW5jZSgyNTApCiAgICAgKiAgIHJ1blRlblRpbWVzKGZuKTsgLT4gY2FsbGVkIG9uY2UgMjUwbXMgbGF0ZXIKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21zXQogICAgICoKICAgICAqKiovCiAgICAnZGVib3VuY2UnOiBmdW5jdGlvbihmbiwgbXMpIHsKICAgICAgZnVuY3Rpb24gZGVib3VuY2VkKCkgewogICAgICAgIC8vIE9wdGltaXplZDogbm8gbGVha2luZyBhcmd1bWVudHMKICAgICAgICB2YXIgYXJncyA9IFtdOyBmb3IodmFyICRpID0gMCwgJGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7ICRpIDwgJGxlbjsgJGkrKykgYXJncy5wdXNoKGFyZ3VtZW50c1skaV0pOwogICAgICAgIGNhbmNlbEZ1bmN0aW9uKGRlYm91bmNlZCk7CiAgICAgICAgc2V0RGVsYXkoZGVib3VuY2VkLCBtcywgZm4sIHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICAgIHJldHVybiBkZWJvdW5jZWQ7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgY2FuY2VsKCkKICAgICAqIEByZXR1cm5zIEZ1bmN0aW9uCiAgICAgKiBAc2hvcnQgQ2FuY2VscyBhIGRlbGF5ZWQgZnVuY3Rpb24gc2NoZWR1bGVkIHRvIGJlIHJ1bi4KICAgICAqIEBleHRyYSBgZGVsYXlgLCBgbGF6eWAsIGB0aHJvdHRsZWAsIGFuZCBgZGVib3VuY2VgIGNhbiBhbGwgc2V0IGRlbGF5cy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbG9nSGVsbG8uZGVsYXkoNTAwKS5jYW5jZWwoKSAtPiBuZXZlciBsb2dzCiAgICAgKgogICAgICoqKi8KICAgICdjYW5jZWwnOiBmdW5jdGlvbihmbikgewogICAgICByZXR1cm4gY2FuY2VsRnVuY3Rpb24oZm4pOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGFmdGVyKG4pCiAgICAgKiBAcmV0dXJucyBGdW5jdGlvbgogICAgICogQHNob3J0IENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgZXhlY3V0ZSBhZnRlciBgbmAgY2FsbHMuCiAgICAgKiBAZXh0cmEgYGFmdGVyYCBpcyB1c2VmdWwgZm9yIHJ1bm5pbmcgYSBmaW5hbCBjYWxsYmFjayBhZnRlciBhIHNwZWNpZmljCiAgICAgKiAgICAgICAgbnVtYmVyIG9mIG9wZXJhdGlvbnMsIG9mdGVuIHdoZW4gdGhlIG9yZGVyIGluIHdoaWNoIHRoZSBvcGVyYXRpb25zCiAgICAgKiAgICAgICAgd2lsbCBjb21wbGV0ZSBpcyB1bmtub3duLiBUaGUgY3JlYXRlZCBmdW5jdGlvbiB3aWxsIGJlIHBhc3NlZCBhbgogICAgICogICAgICAgIGFycmF5IG9mIHRoZSBhcmd1bWVudHMgdGhhdCBpdCBoYXMgY29sbGVjdGVkIGZyb20gZWFjaCBhZnRlciBgbmAuCiAgICAgKiAgICAgICAgTm90ZSB0aGF0IHRoZSBmdW5jdGlvbiB3aWxsIGV4ZWN1dGUgb24gZXZlcnkgY2FsbCBhZnRlciBgbmAuCiAgICAgKiAgICAgICAgVXNlIGBvbmNlYCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoaXMgbWV0aG9kIHRvIHByZXZlbnQgYmVpbmcKICAgICAqICAgICAgICB0cmlnZ2VyZWQgYnkgc3Vic2VxdWVudCBjYWxscy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgdmFyIGZuID0gbG9nSGVsbG8uYWZ0ZXIoNSk7CiAgICAgKiAgIHJ1blRlblRpbWVzKGZuKTsgLT4gbG9ncyA2IHRpbWVzCiAgICAgKgogICAgICogICB2YXIgZm4gPSBsb2dIZWxsby5vbmNlKCkuYWZ0ZXIoNSkKICAgICAqICAgcnVuVGVuVGltZXMoZm4pOyAtPiBsb2dzIG9uY2UKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW25dCiAgICAgKgogICAgICoqKi8KICAgICdhZnRlcic6IGZ1bmN0aW9uKGZuLCBudW0pIHsKICAgICAgdmFyIGNvdW50ID0gMCwgY29sbGVjdGVkQXJncyA9IFtdOwogICAgICBudW0gPSBjb2VyY2VQb3NpdGl2ZUludGVnZXIobnVtKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIC8vIE9wdGltaXplZDogbm8gbGVha2luZyBhcmd1bWVudHMKICAgICAgICB2YXIgYXJncyA9IFtdOyBmb3IodmFyICRpID0gMCwgJGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7ICRpIDwgJGxlbjsgJGkrKykgYXJncy5wdXNoKGFyZ3VtZW50c1skaV0pOwogICAgICAgIGNvbGxlY3RlZEFyZ3MucHVzaChhcmdzKTsKICAgICAgICBjb3VudCsrOwogICAgICAgIGlmIChjb3VudCA+PSBudW0pIHsKICAgICAgICAgIHJldHVybiBmbi5jYWxsKHRoaXMsIGNvbGxlY3RlZEFyZ3MpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBvbmNlKCkKICAgICAqIEByZXR1cm5zIEZ1bmN0aW9uCiAgICAgKiBAc2hvcnQgQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBleGVjdXRlIG9ubHkgb25jZSBhbmQgc3RvcmUgdGhlIHJlc3VsdC4KICAgICAqIEBleHRyYSBgb25jZWAgaXMgdXNlZnVsIGZvciBjcmVhdGluZyBmdW5jdGlvbnMgdGhhdCB3aWxsIGNhY2hlIHRoZSByZXN1bHQKICAgICAqICAgICAgICBvZiBhbiBleHBlbnNpdmUgb3BlcmF0aW9uIGFuZCB1c2UgaXQgb24gc3Vic2VxdWVudCBjYWxscy4gQWxzbyBpdAogICAgICogICAgICAgIGNhbiBiZSB1c2VmdWwgZm9yIGNyZWF0aW5nIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9ucyB0aGF0IG9ubHkgbmVlZAogICAgICogICAgICAgIHRvIGJlIHJ1biBvbmNlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICB2YXIgZm4gPSBsb2dIZWxsby5vbmNlKCk7CiAgICAgKiAgIHJ1blRlblRpbWVzKGZuKTsgLT4gbG9ncyBvbmNlCiAgICAgKgogICAgICoqKi8KICAgICdvbmNlJzogZnVuY3Rpb24oZm4pIHsKICAgICAgdmFyIGNhbGxlZCA9IGZhbHNlLCB2YWw7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoY2FsbGVkKSB7CiAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0KICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgIHJldHVybiB2YWwgPSBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIG1lbW9pemUoW2hhc2hGbl0sIFtsaW1pdF0pCiAgICAgKiBAcmV0dXJucyBGdW5jdGlvbgogICAgICogQHNob3J0IENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgbWVtb2l6ZSByZXN1bHRzIGZvciB1bmlxdWUgY2FsbHMuCiAgICAgKiBAZXh0cmEgYG1lbW9pemVgIGNhbiBiZSB0aG91Z2h0IG9mIGFzIGEgbW9yZSBwb3dlcmZ1bCBgb25jZWAuIFdoZXJlIGBvbmNlYAogICAgICogICAgICAgIHdpbGwgb25seSBjYWxsIGEgZnVuY3Rpb24gb25jZSBldmVyLCBtZW1vaXplZCBmdW5jdGlvbnMgd2lsbCBiZQogICAgICogICAgICAgIGNhbGxlZCBvbmNlIHBlciB1bmlxdWUgY2FsbC4gQSAidW5pcXVlIGNhbGwiIGlzIGRldGVybWluZWQgYnkgdGhlCiAgICAgKiAgICAgICAgcmV0dXJuIHZhbHVlIG9mIFtoYXNoRm5dLCB3aGljaCBpcyBwYXNzZWQgdGhlIGFyZ3VtZW50cyBvZiBlYWNoIGNhbGwuCiAgICAgKiAgICAgICAgSWYgW2hhc2hGbl0gaXMgdW5kZWZpbmVkLCBpdCB3aWxsIGRlZXBseSBzZXJpYWxpemUgYWxsIGFyZ3VtZW50cywKICAgICAqICAgICAgICBzdWNoIHRoYXQgYW55IGRpZmZlcmVudCBhcmd1bWVudCBzaWduYXR1cmUgd2lsbCByZXN1bHQgaW4gYSB1bmlxdWUKICAgICAqICAgICAgICBjYWxsLiBbaGFzaEZuXSBtYXkgYmUgYSBzdHJpbmcgKGFsbG93cyBgZGVlcCBwcm9wZXJ0aWVzYCkgdGhhdCBhY3RzCiAgICAgKiAgICAgICAgYXMgYSBzaG9ydGN1dCB0byByZXR1cm4gYSBwcm9wZXJ0eSBvZiB0aGUgZmlyc3QgYXJndW1lbnQgcGFzc2VkLgogICAgICogICAgICAgIFtsaW1pdF0gc2V0cyBhbiB1cHBlciBsaW1pdCBvbiBtZW1vaXplZCByZXN1bHRzLiBUaGUgZGVmYXVsdCBpcyBubwogICAgICogICAgICAgIGxpbWl0LCBtZWFuaW5nIHRoYXQgdW5pcXVlIGNhbGxzIHdpbGwgY29udGludWUgdG8gbWVtb2l6ZSByZXN1bHRzLgogICAgICogICAgICAgIEZvciBtb3N0IHVzZSBjYXNlcyB0aGlzIGlzIGZpbmUsIGhvd2V2ZXIgW2xpbWl0XSBpcyB1c2VmdWwgZm9yIG1vcmUKICAgICAqICAgICAgICBwZXJzaXN0ZW50IChvZnRlbiBzZXJ2ZXItc2lkZSkgYXBwbGljYXRpb25zIGZvciB3aG9tIG1lbW9yeSBsZWFrcwogICAgICogICAgICAgIGFyZSBhIGNvbmNlcm4uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIHZhciBmbiA9IGxvZ0hlbGxvLm1lbW9pemUoKTsKICAgICAqICAgZm4oMSk7IGZuKDEpOyBmbigyKTsgLT4gbG9ncyB0d2ljZSwgbWVtb2l6aW5nIG9uY2UKICAgICAqCiAgICAgKiAgIHZhciBmbiA9IGNhbGN1bGF0ZVVzZXJCYWxhbmNlLm1lbW9pemUoJ2lkJyk7CiAgICAgKiAgIGZuKEhhcnJ5KTsgZm4oTWFyayk7IGZuKE1hcmspOyAtPiBsb2dzIHR3aWNlLCBtZW1vaXppbmcgb25jZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfEZ1bmN0aW9ufSBbaGFzaEZuXQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtsaW1pdF0KICAgICAqCiAgICAgKioqLwogICAgJ21lbW9pemUnOiBmdW5jdGlvbihmbiwgYXJnMSwgYXJnMikgewogICAgICB2YXIgaGFzaEZuLCBsaW1pdCwgcHJvcDsKICAgICAgaWYgKGlzTnVtYmVyKGFyZzEpKSB7CiAgICAgICAgbGltaXQgPSBhcmcxOwogICAgICB9IGVsc2UgewogICAgICAgIGhhc2hGbiA9IGFyZzE7CiAgICAgICAgbGltaXQgID0gYXJnMjsKICAgICAgfQogICAgICBpZiAoaXNTdHJpbmcoaGFzaEZuKSkgewogICAgICAgIHByb3AgPSBoYXNoRm47CiAgICAgICAgaGFzaEZuID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICByZXR1cm4gZGVlcEdldFByb3BlcnR5KG9iaiwgcHJvcCk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIGlmICghaGFzaEZuKSB7CiAgICAgICAgaGFzaEZuID0gY29sbGVjdEFyZ3VtZW50czsKICAgICAgfQogICAgICByZXR1cm4gY3JlYXRlSGFzaGVkTWVtb2l6ZUZ1bmN0aW9uKGZuLCBoYXNoRm4sIGxpbWl0KTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBsb2NrKFtuXSkKICAgICAqIEByZXR1cm5zIEZ1bmN0aW9uCiAgICAgKiBAc2hvcnQgTG9ja3MgdGhlIG51bWJlciBvZiBhcmd1bWVudHMgYWNjZXB0ZWQgYnkgdGhlIGZ1bmN0aW9uLgogICAgICogQGV4dHJhIElmIG5vdCBwYXNzZWQsIFtuXSB3aWxsIGJlIHRoZSBsZW5ndGggb2YgdGhlIGZ1bmN0aW9uLiBUaGlzIG1ldGhvZAogICAgICogICAgICAgIGNhbiBiZSBjYWxsZWQgb24gZnVuY3Rpb25zIGNyZWF0ZWQgYnkgYHBhcnRpYWxgLCBpbiB3aGljaCBjYXNlIGl0CiAgICAgKiAgICAgICAgd2lsbCBsb2NrIHRoZSB0b3RhbCBhcmd1bWVudHMgZHVyaW5nIGV4ZWN1dGlvbi4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbG9nQXJncy5sb2NrKDIpKDEsMiwzKSAgICAgIC0+IGxvZ3MgMSwyCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtuXQogICAgICoKICAgICAqKiovCiAgICAnbG9jayc6IGZ1bmN0aW9uKGZuLCBuKSB7CiAgICAgIHZhciBsb2NrZWRGbjsKICAgICAgaWYgKF9wYXJ0aWFsKGZuKSkgewogICAgICAgIF9sb2NrKGZuLCBpc051bWJlcihuKSA/IG4gOiBudWxsKTsKICAgICAgICByZXR1cm4gZm47CiAgICAgIH0KICAgICAgbG9ja2VkRm4gPSBmdW5jdGlvbigpIHsKICAgICAgICBhcmd1bWVudHMubGVuZ3RoID0gbWluKF9sb2NrKGxvY2tlZEZuKSwgYXJndW1lbnRzLmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICAgIF9sb2NrKGxvY2tlZEZuLCBpc051bWJlcihuKSA/IG4gOiBmbi5sZW5ndGgpOwogICAgICByZXR1cm4gbG9ja2VkRm47CiAgICB9CgogIH0pOwoKICBkZWZpbmVJbnN0YW5jZVdpdGhBcmd1bWVudHMoc3VnYXJGdW5jdGlvbiwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgcGFydGlhbChbYXJnMV0sIFthcmcyXSwgLi4uKQogICAgICogQHJldHVybnMgRnVuY3Rpb24KICAgICAqIEBzaG9ydCBSZXR1cm5zIGEgbmV3IHZlcnNpb24gb2YgdGhlIGZ1bmN0aW9uIHdoaWNoIGhhcyBwYXJ0IG9mIGl0cyBhcmd1bWVudHMKICAgICAqICAgICAgICBwcmUtZW1wdGl2ZWx5IGZpbGxlZCBpbiwgYWxzbyBrbm93biBhcyAiY3VycnlpbmciLgogICAgICogQGV4dHJhIGB1bmRlZmluZWRgIGNhbiBiZSBwYXNzZWQgYXMgYW55IGFyZ3VtZW50LCBhbmQgaXMgYSBwbGFjZWhvbGRlciB0aGF0CiAgICAgKiAgICAgICAgd2lsbCBiZSByZXBsYWNlZCB3aXRoIGFyZ3VtZW50cyBwYXNzZWQgd2hlbiB0aGUgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAgICAgKiAgICAgICAgVGhpcyBhbGxvd3MgY3Vycnlpbmcgb2YgYXJndW1lbnRzIGV2ZW4gd2hlbiB0aGV5IG9jY3VyIHRvd2FyZCB0aGUgZW5kCiAgICAgKiAgICAgICAgb2YgYW4gYXJndW1lbnQgbGlzdCAodGhlIGV4YW1wbGUgZGVtb25zdHJhdGVzIHRoaXMgbW9yZSBjbGVhcmx5KS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbG9nQXJncy5wYXJ0aWFsKHVuZGVmaW5lZCwgJ2InKSgnYScpIC0+IGxvZ3MgYSwgYgogICAgICoKICAgICAqIEBwYXJhbSB7YW55fSBbYXJnMV0KICAgICAqIEBwYXJhbSB7YW55fSBbYXJnMl0KICAgICAqCiAgICAgKioqLwogICAgJ3BhcnRpYWwnOiBmdW5jdGlvbihmbiwgY3VycmllZEFyZ3MpIHsKICAgICAgdmFyIGN1cnJpZWRMZW4gPSBjdXJyaWVkQXJncy5sZW5ndGg7CiAgICAgIHZhciBwYXJ0aWFsRm4gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJnSW5kZXggPSAwLCBhcHBseUFyZ3MgPSBbXSwgc2VsZiA9IHRoaXMsIGxvY2sgPSBfbG9jayhwYXJ0aWFsRm4pLCByZXN1bHQsIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGN1cnJpZWRMZW47IGkrKykgewogICAgICAgICAgdmFyIGFyZyA9IGN1cnJpZWRBcmdzW2ldOwogICAgICAgICAgaWYgKGlzRGVmaW5lZChhcmcpKSB7CiAgICAgICAgICAgIGFwcGx5QXJnc1tpXSA9IGFyZzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGFwcGx5QXJnc1tpXSA9IGFyZ3VtZW50c1thcmdJbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChpID0gYXJnSW5kZXg7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGFwcGx5QXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgfQogICAgICAgIGlmIChsb2NrID09PSBudWxsKSB7CiAgICAgICAgICBsb2NrID0gY3VycmllZExlbjsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTnVtYmVyKGxvY2spKSB7CiAgICAgICAgICBhcHBseUFyZ3MubGVuZ3RoID0gbWluKGFwcGx5QXJncy5sZW5ndGgsIGxvY2spOwogICAgICAgIH0KICAgICAgICAvLyBJZiB0aGUgYm91bmQgInRoaXMiIG9iamVjdCBpcyBhbiBpbnN0YW5jZSBvZiB0aGUgcGFydGlhbGVkCiAgICAgICAgLy8gZnVuY3Rpb24sIHRoZW4gIm5ldyIgd2FzIHVzZWQsIHNvIHByZXNlcnZlIHRoZSBwcm90b3R5cGUKICAgICAgICAvLyBzbyB0aGF0IGNvbnN0cnVjdG9yIGZ1bmN0aW9ucyBjYW4gYWxzbyBiZSBwYXJ0aWFsZWQuCiAgICAgICAgaWYgKHNlbGYgaW5zdGFuY2VvZiBwYXJ0aWFsRm4pIHsKICAgICAgICAgIHNlbGYgPSBjcmVhdGVJbnN0YW5jZUZyb21Qcm90b3R5cGUoZm4ucHJvdG90eXBlKTsKICAgICAgICAgIHJlc3VsdCA9IGZuLmFwcGx5KHNlbGYsIGFwcGx5QXJncyk7CiAgICAgICAgICAvLyBBbiBleHBsaWNpdCByZXR1cm4gdmFsdWUgaXMgYWxsb3dlZCBmcm9tIGNvbnN0cnVjdG9ycwogICAgICAgICAgLy8gYXMgbG9uZyBhcyB0aGV5IGFyZSBvZiAib2JqZWN0IiB0eXBlLCBzbyByZXR1cm4gdGhlCiAgICAgICAgICAvLyBjb3JyZWN0IHJlc3VsdCBoZXJlIGFjY29yZGluZ2x5LgogICAgICAgICAgcmV0dXJuIGlzT2JqZWN0VHlwZShyZXN1bHQpID8gcmVzdWx0IDogc2VsZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFwcGx5QXJncyk7CiAgICAgIH07CiAgICAgIF9wYXJ0aWFsKHBhcnRpYWxGbiwgdHJ1ZSk7CiAgICAgIHJldHVybiBwYXJ0aWFsRm47CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZGVsYXkoW21zXSA9IDEsIFthcmcxXSwgW2FyZzJdLCAuLi4pCiAgICAgKiBAcmV0dXJucyBGdW5jdGlvbgogICAgICogQHNob3J0IEV4ZWN1dGVzIHRoZSBmdW5jdGlvbiBhZnRlciBgbXNgIG1pbGxpc2Vjb25kcy4KICAgICAqIEBleHRyYSBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIGl0c2VsZi4gYGRlbGF5YCBpcyBhbHNvIGEgd2F5IHRvIGV4ZWN1dGUgbm9uLQogICAgICogICAgICAgIGJsb2NraW5nIG9wZXJhdGlvbnMgdGhhdCB3aWxsIHdhaXQgdW50aWwgdGhlIENQVSBpcyBmcmVlLiBEZWxheWVkCiAgICAgKiAgICAgICAgZnVuY3Rpb25zIGNhbiBiZSBjYW5jZWxlZCB1c2luZyB0aGUgYGNhbmNlbGAgbWV0aG9kLiBDYW4gYWxzbyBjdXJyeQogICAgICogICAgICAgIGFyZ3VtZW50cyBwYXNzZWQgaW4gYWZ0ZXIgYG1zYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbG9nSGVsbG8uZGVsYXkoNTAwKSAgICAgLT4gbG9ncyBhZnRlciA1MDBtcwogICAgICogICBsb2dBcmdzLmRlbGF5KDUwMCwgJ2EnKSAtPiBsb2dzICJhIiBhZnRlciA1MDBtcwogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbXNdCiAgICAgKiBAcGFyYW0ge2FueX0gW2FyZzFdCiAgICAgKiBAcGFyYW0ge2FueX0gW2FyZzJdCiAgICAgKgogICAgICoqKi8KICAgICdkZWxheSc6IGZ1bmN0aW9uKGZuLCBtcywgYXJncykgewogICAgICBzZXREZWxheShmbiwgbXMsIGZuLCBmbiwgYXJncyk7CiAgICAgIHJldHVybiBmbjsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBldmVyeShbbXNdID0gMSwgW2FyZzFdLCBbYXJnMl0sIC4uLikKICAgICAqIEByZXR1cm5zIEZ1bmN0aW9uCiAgICAgKiBAc2hvcnQgRXhlY3V0ZXMgdGhlIGZ1bmN0aW9uIGV2ZXJ5IGBtc2AgbWlsbGlzZWNvbmRzLgogICAgICogQGV4dHJhIFJldHVybnMgYSByZWZlcmVuY2UgdG8gaXRzZWxmLiBgZXZlcnlgIHVzZXMgYHNldFRpbWVvdXRgLCB3aGljaAogICAgICogICAgICAgIG1lYW5zIHRoYXQgeW91IGFyZSBndWFyYW50ZWVkIGEgcGVyaW9kIG9mIGlkbGUgdGltZSBlcXVhbCB0byBbbXNdCiAgICAgKiAgICAgICAgYWZ0ZXIgZXhlY3V0aW9uIGhhcyBmaW5pc2hlZC4gQ29tcGFyZSB0aGlzIHRvIGBzZXRJbnRlcnZhbGAgd2hpY2gKICAgICAqICAgICAgICB3aWxsIHRyeSB0byBydW4gYSBmdW5jdGlvbiBldmVyeSBbbXNdLCBldmVuIHdoZW4gZXhlY3V0aW9uIGl0c2VsZgogICAgICogICAgICAgIHRha2VzIHVwIGEgcG9ydGlvbiBvZiB0aGF0IHRpbWUuIEluIG1vc3QgY2FzZXMgYXZvaWRpbmcgYHNldEludGVydmFsYAogICAgICogICAgICAgIGlzIGJldHRlciBhcyBjYWxscyB3b24ndCAiYmFjayB1cCIgd2hlbiB0aGUgQ1BVIGlzIHVuZGVyIHN0cmFpbiwKICAgICAqICAgICAgICBob3dldmVyIHRoaXMgYWxzbyBtZWFucyB0aGF0IGNhbGxzIGFyZSBsZXNzIGxpa2VseSB0byBoYXBwZW4gYXQKICAgICAqICAgICAgICBleGFjdCBpbnRlcnZhbHMgb2YgW21zXSwgc28gdGhlIHVzZSBjYXNlIGhlcmUgc2hvdWxkIGJlIGNvbnNpZGVyZWQuCiAgICAgKiAgICAgICAgQWRkaXRpb25hbGx5LCBgZXZlcnlgIGNhbiBjdXJyeSBhcmd1bWVudHMgcGFzc2VkIGluIGFmdGVyIFttc10sIGFuZAogICAgICogICAgICAgIGFsc28gYmUgY2FuY2VsZWQgd2l0aCBgY2FuY2VsYC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgbG9nSGVsbG8uZXZlcnkoMTAwMCkgICAgICAgIC0+IGxvZ3MgZXZlcnkgc2Vjb25kCiAgICAgKiAgIGxvZ0FyZ3MuZXZlcnkoMTAwMCwgJ0hvbGEnKSAtPiBsb2dzICdob2xhJyBldmVyeSBzZWNvbmQKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21zXQogICAgICogQHBhcmFtIHthbnl9IFthcmcxXQogICAgICogQHBhcmFtIHthbnl9IFthcmcyXQogICAgICoKICAgICAqKiovCiAgICAnZXZlcnknOiBmdW5jdGlvbihmbiwgbXMsIGFyZ3MpIHsKICAgICAgZnVuY3Rpb24gZXhlY3V0ZSAoKSB7CiAgICAgICAgLy8gU2V0IHRoZSBkZWxheSBmaXJzdCBoZXJlLCBzbyB0aGF0IGNhbmNlbAogICAgICAgIC8vIGNhbiBiZSBjYWxsZWQgd2l0aGluIHRoZSBleGVjdXRpbmcgZnVuY3Rpb24uCiAgICAgICAgc2V0RGVsYXkoZm4sIG1zLCBleGVjdXRlKTsKICAgICAgICBmbi5hcHBseShmbiwgYXJncyk7CiAgICAgIH0KICAgICAgc2V0RGVsYXkoZm4sIG1zLCBleGVjdXRlKTsKICAgICAgcmV0dXJuIGZuOwogICAgfQoKICB9KTsKCiAgLyoqKgogICAqIEBtb2R1bGUgUmVnRXhwCiAgICogQGRlc2NyaXB0aW9uIFJlZ0V4cCBlc2NhcGluZyBhbmQgZmxhZyBtYW5pcHVsYXRpb24uCiAgICoKICAgKiBOb3RlIGhlcmUgdGhhdCBtZXRob2RzIG9uIHRoZSBSZWdFeHAgY2xhc3MgbGlrZSAuZXhlYyBhbmQgLnRlc3Qgd2lsbCBmYWlsIGluCiAgICogdGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBTcGlkZXJNb25rZXkgYmVpbmcgdXNlZCBieSBDb3VjaERCIHdoZW4gdXNpbmcKICAgKiBzaG9ydGhhbmQgcmVnZXggbm90YXRpb24gbGlrZSAvZm9vLy4gVGhpcyBpcyB0aGUgcmVhc29uIGZvciB0aGUgaW50ZXJtaXhlZAogICAqIHVzZSBvZiBzaG9ydGhhbmQgYW5kIGNvbXBpbGVkIHJlZ2V4ZXMgaGVyZS4gSWYgeW91J3JlIHVzaW5nIEpTIGluIENvdWNoREIsIGl0CiAgICogaXMgc2FmZXIgdG8gQUxXQVlTIGNvbXBpbGUgeW91ciByZWdleGVzIGZyb20gYSBzdHJpbmcuCiAgICoKICAgKioqLwoKICBkZWZpbmVTdGF0aWMoc3VnYXJSZWdFeHAsIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGVzY2FwZShbc3RyXSA9ICcnKQogICAgICogQHJldHVybnMgU3RyaW5nCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2hvcnQgRXNjYXBlcyBhbGwgUmVnRXhwIHRva2VucyBpbiBhIHN0cmluZy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgUmVnRXhwLmVzY2FwZSgncmVhbGx5PycpICAgICAgLT4gJ3JlYWxseVw/JwogICAgICogICBSZWdFeHAuZXNjYXBlKCd5ZXMuJykgICAgICAgICAtPiAneWVzXC4nCiAgICAgKiAgIFJlZ0V4cC5lc2NhcGUoJyhub3QgcmVhbGx5KScpIC0+ICdcKG5vdCByZWFsbHlcKScKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyCiAgICAgKgogICAgICoqKi8KICAgICdlc2NhcGUnOiBmdW5jdGlvbihzdHIpIHsKICAgICAgcmV0dXJuIGVzY2FwZVJlZ0V4cChzdHIpOwogICAgfQoKICB9KTsKCiAgZGVmaW5lSW5zdGFuY2Uoc3VnYXJSZWdFeHAsIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGdldEZsYWdzKCkKICAgICAqIEByZXR1cm5zIFN0cmluZwogICAgICogQHNob3J0IFJldHVybnMgdGhlIGZsYWdzIG9mIHRoZSByZWdleCBhcyBhIHN0cmluZy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgL3RleHR5L2dpbS5nZXRGbGFncygpIC0+ICdnaW0nCiAgICAgKgogICAgICoqKi8KICAgICdnZXRGbGFncyc6IGZ1bmN0aW9uKHIpIHsKICAgICAgcmV0dXJuIGdldFJlZ0V4cEZsYWdzKHIpOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHNldEZsYWdzKGZsYWdzKQogICAgICogQHJldHVybnMgUmVnRXhwCiAgICAgKiBAc2hvcnQgQ3JlYXRlcyBhIGNvcHkgb2YgdGhlIHJlZ2V4IHdpdGggYGZsYWdzYCBzZXQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIC90ZXh0eS8uc2V0RmxhZ3MoJ2dpbScpIC0+IG5vdyBoYXMgZ2xvYmFsLCBpZ25vcmVDYXNlLCBhbmQgbXVsdGlsaW5lIHNldAogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmbGFncwogICAgICoKICAgICAqKiovCiAgICAnc2V0RmxhZ3MnOiBmdW5jdGlvbihyLCBmbGFncykgewogICAgICByZXR1cm4gUmVnRXhwKHIuc291cmNlLCBmbGFncyk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgYWRkRmxhZ3MoZmxhZ3MpCiAgICAgKiBAcmV0dXJucyBSZWdFeHAKICAgICAqIEBzaG9ydCBDcmVhdGVzIGEgY29weSBvZiB0aGUgcmVnZXggd2l0aCBgZmxhZ3NgIGFkZGVkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAvdGV4dHkvLmFkZEZsYWdzKCdnJykgIC0+IC90ZXh0eS9nCiAgICAgKiAgIC90ZXh0eS8uYWRkRmxhZ3MoJ2ltJykgLT4gL3RleHR5L2ltCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGZsYWdzCiAgICAgKgogICAgICoqKi8KICAgICdhZGRGbGFncyc6IGZ1bmN0aW9uKHIsIGZsYWdzKSB7CiAgICAgIHJldHVybiBSZWdFeHAoci5zb3VyY2UsIGdldFJlZ0V4cEZsYWdzKHIsIGZsYWdzKSk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgcmVtb3ZlRmxhZ3MoZmxhZ3MpCiAgICAgKiBAcmV0dXJucyBSZWdFeHAKICAgICAqIEBzaG9ydCBDcmVhdGVzIGEgY29weSBvZiB0aGUgcmVnZXggd2l0aCBgZmxhZ3NgIHJlbW92ZWQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIC90ZXh0eS9naW0ucmVtb3ZlRmxhZ3MoJ2cnKSAgLT4gL3RleHR5L2ltCiAgICAgKiAgIC90ZXh0eS9naW0ucmVtb3ZlRmxhZ3MoJ2ltJykgLT4gL3RleHR5L2cKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmxhZ3MKICAgICAqCiAgICAgKioqLwogICAgJ3JlbW92ZUZsYWdzJzogZnVuY3Rpb24ociwgZmxhZ3MpIHsKICAgICAgdmFyIHJlZyA9IGFsbENoYXJzUmVnKGZsYWdzKTsKICAgICAgcmV0dXJuIFJlZ0V4cChyLnNvdXJjZSwgZ2V0UmVnRXhwRmxhZ3MocikucmVwbGFjZShyZWcsICcnKSk7CiAgICB9CgogIH0pOwoKICAvKioqCiAgICogQG1vZHVsZSBSYW5nZQogICAqIEBkZXNjcmlwdGlvbiBEYXRlLCBOdW1iZXIsIGFuZCBTdHJpbmcgcmFuZ2VzIHRoYXQgY2FuIGJlIG1hbmlwdWxhdGVkIGFuZCBjb21wYXJlZCwKICAgKiAgICAgICAgICAgICAgb3IgZW51bWVyYXRlIG92ZXIgc3BlY2lmaWMgcG9pbnRzIHdpdGhpbiB0aGUgcmFuZ2UuCiAgICoKICAgKioqLwoKICB2YXIgRFVSQVRJT05fVU5JVFMgPSAneWVhcnxtb250aHx3ZWVrfGRheXxob3VyfG1pbnV0ZXxzZWNvbmR8bWlsbGlzZWNvbmQnOwogIHZhciBEVVJBVElPTl9SRUcgICA9IFJlZ0V4cCgnKFxcZCspP1xccyooJysgRFVSQVRJT05fVU5JVFMgKycpcz8nLCAnaScpOwoKICB2YXIgTVVMVElQTElFUlMgPSB7CiAgICAnSG91cnMnOiA2MCAqIDYwICogMTAwMCwKICAgICdNaW51dGVzJzogNjAgKiAxMDAwLAogICAgJ1NlY29uZHMnOiAxMDAwLAogICAgJ01pbGxpc2Vjb25kcyc6IDEKICB9OwoKICB2YXIgUHJpbWl0aXZlUmFuZ2VDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgIHJldHVybiBuZXcgUmFuZ2Uoc3RhcnQsIGVuZCk7CiAgfTsKCiAgZnVuY3Rpb24gUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgdGhpcy5zdGFydCA9IGNsb25lUmFuZ2VNZW1iZXIoc3RhcnQpOwogICAgdGhpcy5lbmQgICA9IGNsb25lUmFuZ2VNZW1iZXIoZW5kKTsKICB9CgogIGZ1bmN0aW9uIGdldFJhbmdlTWVtYmVyTnVtZXJpY1ZhbHVlKG0pIHsKICAgIHJldHVybiBpc1N0cmluZyhtKSA/IG0uY2hhckNvZGVBdCgwKSA6IG07CiAgfQoKICBmdW5jdGlvbiBnZXRSYW5nZU1lbWJlclByaW1pdGl2ZVZhbHVlKG0pIHsKICAgIGlmIChtID09IG51bGwpIHJldHVybiBtOwogICAgcmV0dXJuIGlzRGF0ZShtKSA/IG0uZ2V0VGltZSgpIDogbS52YWx1ZU9mKCk7CiAgfQoKICBmdW5jdGlvbiBnZXRQcmVjaXNpb24obikgewogICAgdmFyIHNwbGl0ID0gcGVyaW9kU3BsaXQobi50b1N0cmluZygpKTsKICAgIHJldHVybiBzcGxpdFsxXSA/IHNwbGl0WzFdLmxlbmd0aCA6IDA7CiAgfQoKICBmdW5jdGlvbiBnZXRHcmVhdGVyUHJlY2lzaW9uKG4xLCBuMikgewogICAgcmV0dXJuIG1heChnZXRQcmVjaXNpb24objEpLCBnZXRQcmVjaXNpb24objIpKTsKICB9CgogIGZ1bmN0aW9uIGNsb25lUmFuZ2VNZW1iZXIobSkgewogICAgaWYgKGlzRGF0ZShtKSkgewogICAgICByZXR1cm4gbmV3IERhdGUobS5nZXRUaW1lKCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGdldFJhbmdlTWVtYmVyUHJpbWl0aXZlVmFsdWUobSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1ZhbGlkUmFuZ2VNZW1iZXIobSkgewogICAgdmFyIHZhbCA9IGdldFJhbmdlTWVtYmVyUHJpbWl0aXZlVmFsdWUobSk7CiAgICByZXR1cm4gKCEhdmFsIHx8IHZhbCA9PT0gMCkgJiYgdmFsdWVJc05vdEluZmluaXRlKG0pOwogIH0KCiAgZnVuY3Rpb24gdmFsdWVJc05vdEluZmluaXRlKG0pIHsKICAgIHJldHVybiBtICE9PSAtSW5maW5pdHkgJiYgbSAhPT0gSW5maW5pdHk7CiAgfQoKICBmdW5jdGlvbiByYW5nZUlzVmFsaWQocmFuZ2UpIHsKICAgIHJldHVybiBpc1ZhbGlkUmFuZ2VNZW1iZXIocmFuZ2Uuc3RhcnQpICYmCiAgICAgICAgICAgaXNWYWxpZFJhbmdlTWVtYmVyKHJhbmdlLmVuZCkgJiYKICAgICAgICAgICB0eXBlb2YgcmFuZ2Uuc3RhcnQgPT09IHR5cGVvZiByYW5nZS5lbmQ7CiAgfQoKICBmdW5jdGlvbiByYW5nZUV2ZXJ5KHJhbmdlLCBzdGVwLCBjb3VudE9ubHksIGZuKSB7CiAgICB2YXIgaW5jcmVtZW50LAogICAgICAgIHByZWNpc2lvbiwKICAgICAgICBkaW8sCiAgICAgICAgdW5pdCwKICAgICAgICBzdGFydCAgID0gcmFuZ2Uuc3RhcnQsCiAgICAgICAgZW5kICAgICA9IHJhbmdlLmVuZCwKICAgICAgICBpbnZlcnNlID0gZW5kIDwgc3RhcnQsCiAgICAgICAgY3VycmVudCA9IHN0YXJ0LAogICAgICAgIGluZGV4ICAgPSAwLAogICAgICAgIHJlc3VsdCAgPSBbXTsKCiAgICBpZiAoIXJhbmdlSXNWYWxpZChyYW5nZSkpIHsKICAgICAgcmV0dXJuIGNvdW50T25seSA/IE5hTiA6IFtdOwogICAgfQogICAgaWYgKGlzRnVuY3Rpb24oc3RlcCkpIHsKICAgICAgZm4gPSBzdGVwOwogICAgICBzdGVwID0gbnVsbDsKICAgIH0KICAgIHN0ZXAgPSBzdGVwIHx8IDE7CiAgICBpZiAoaXNOdW1iZXIoc3RhcnQpKSB7CiAgICAgIHByZWNpc2lvbiA9IGdldEdyZWF0ZXJQcmVjaXNpb24oc3RhcnQsIHN0ZXApOwogICAgICBpbmNyZW1lbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaW5jcmVtZW50TnVtYmVyKGN1cnJlbnQsIHN0ZXAsIHByZWNpc2lvbik7CiAgICAgIH07CiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKHN0YXJ0KSkgewogICAgICBpbmNyZW1lbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaW5jcmVtZW50U3RyaW5nKGN1cnJlbnQsIHN0ZXApOwogICAgICB9OwogICAgfSBlbHNlIGlmIChpc0RhdGUoc3RhcnQpKSB7CiAgICAgIGRpbyAgPSBnZXREYXRlSW5jcmVtZW50T2JqZWN0KHN0ZXApOwogICAgICBzdGVwID0gZGlvWzBdOwogICAgICB1bml0ID0gZGlvWzFdOwogICAgICBpbmNyZW1lbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaW5jcmVtZW50RGF0ZShjdXJyZW50LCBzdGVwLCB1bml0KTsKICAgICAgfTsKICAgIH0KICAgIC8vIEF2b2lkaW5nIGluZmluaXRlIGxvb3BzCiAgICBpZiAoaW52ZXJzZSAmJiBzdGVwID4gMCkgewogICAgICBzdGVwICo9IC0xOwogICAgfQogICAgd2hpbGUoaW52ZXJzZSA/IGN1cnJlbnQgPj0gZW5kIDogY3VycmVudCA8PSBlbmQpIHsKICAgICAgaWYgKCFjb3VudE9ubHkpIHsKICAgICAgICByZXN1bHQucHVzaChjdXJyZW50KTsKICAgICAgfQogICAgICBpZiAoZm4pIHsKICAgICAgICBmbihjdXJyZW50LCBpbmRleCwgcmFuZ2UpOwogICAgICB9CiAgICAgIGN1cnJlbnQgPSBpbmNyZW1lbnQoKTsKICAgICAgaW5kZXgrKzsKICAgIH0KICAgIHJldHVybiBjb3VudE9ubHkgPyBpbmRleCAtIDEgOiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBnZXREYXRlSW5jcmVtZW50T2JqZWN0KGFtdCkgewogICAgdmFyIG1hdGNoLCB2YWwsIHVuaXQ7CiAgICBpZiAoaXNOdW1iZXIoYW10KSkgewogICAgICByZXR1cm4gW2FtdCwgJ01pbGxpc2Vjb25kcyddOwogICAgfQogICAgbWF0Y2ggPSBhbXQubWF0Y2goRFVSQVRJT05fUkVHKTsKICAgIHZhbCA9ICttYXRjaFsxXSB8fCAxOwogICAgdW5pdCA9IHNpbXBsZUNhcGl0YWxpemUobWF0Y2hbMl0udG9Mb3dlckNhc2UoKSk7CiAgICBpZiAodW5pdC5tYXRjaCgvaG91cnxtaW51dGV8c2Vjb25kL2kpKSB7CiAgICAgIHVuaXQgKz0gJ3MnOwogICAgfSBlbHNlIGlmICh1bml0ID09PSAnWWVhcicpIHsKICAgICAgdW5pdCA9ICdGdWxsWWVhcic7CiAgICB9IGVsc2UgaWYgKHVuaXQgPT09ICdXZWVrJykgewogICAgICB1bml0ID0gJ0RhdGUnOwogICAgICB2YWwgKj0gNzsKICAgIH0gZWxzZSBpZiAodW5pdCA9PT0gJ0RheScpIHsKICAgICAgdW5pdCA9ICdEYXRlJzsKICAgIH0KICAgIHJldHVybiBbdmFsLCB1bml0XTsKICB9CgogIGZ1bmN0aW9uIGluY3JlbWVudERhdGUoc3JjLCBhbW91bnQsIHVuaXQpIHsKICAgIHZhciBtdWx0ID0gTVVMVElQTElFUlNbdW5pdF0sIGQ7CiAgICBpZiAobXVsdCkgewogICAgICBkID0gbmV3IERhdGUoc3JjLmdldFRpbWUoKSArIChhbW91bnQgKiBtdWx0KSk7CiAgICB9IGVsc2UgewogICAgICBkID0gbmV3IERhdGUoc3JjKTsKICAgICAgY2FsbERhdGVTZXQoZCwgdW5pdCwgY2FsbERhdGVHZXQoc3JjLCB1bml0KSArIGFtb3VudCk7CiAgICB9CiAgICByZXR1cm4gZDsKICB9CgogIGZ1bmN0aW9uIGluY3JlbWVudFN0cmluZyhjdXJyZW50LCBhbW91bnQpIHsKICAgIHJldHVybiBjaHIoY3VycmVudC5jaGFyQ29kZUF0KDApICsgYW1vdW50KTsKICB9CgogIGZ1bmN0aW9uIGluY3JlbWVudE51bWJlcihjdXJyZW50LCBhbW91bnQsIHByZWNpc2lvbikgewogICAgcmV0dXJuIHdpdGhQcmVjaXNpb24oY3VycmVudCArIGFtb3VudCwgcHJlY2lzaW9uKTsKICB9CgogIGZ1bmN0aW9uIHJhbmdlQ2xhbXAocmFuZ2UsIG9iaikgewogICAgdmFyIGNsYW1wZWQsCiAgICAgICAgc3RhcnQgPSByYW5nZS5zdGFydCwKICAgICAgICBlbmQgPSByYW5nZS5lbmQsCiAgICAgICAgbWluID0gZW5kIDwgc3RhcnQgPyBlbmQgOiBzdGFydCwKICAgICAgICBtYXggPSBzdGFydCA+IGVuZCA/IHN0YXJ0IDogZW5kOwogICAgaWYgKG9iaiA8IG1pbikgewogICAgICBjbGFtcGVkID0gbWluOwogICAgfSBlbHNlIGlmIChvYmogPiBtYXgpIHsKICAgICAgY2xhbXBlZCA9IG1heDsKICAgIH0gZWxzZSB7CiAgICAgIGNsYW1wZWQgPSBvYmo7CiAgICB9CiAgICByZXR1cm4gY2xvbmVSYW5nZU1lbWJlcihjbGFtcGVkKTsKICB9CgogIGRlZmluZU9uUHJvdG90eXBlKFJhbmdlLCB7CgogICAgLyoqKgogICAgICogQG1ldGhvZCB0b1N0cmluZygpCiAgICAgKiBAcmV0dXJucyBTdHJpbmcKICAgICAqIEBzaG9ydCBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByYW5nZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgTnVtYmVyLnJhbmdlKDEsIDUpLnRvU3RyaW5nKCkgLT4gMS4uNQogICAgICogICBqYW5Ub01heS50b1N0cmluZygpICAgICAgICAgICAtPiBKYW51YXJ5IDEsIHh4eHguLk1heSAxLCB4eHh4CiAgICAgKgogICAgICoqKi8KICAgICd0b1N0cmluZyc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcmFuZ2VJc1ZhbGlkKHRoaXMpID8gdGhpcy5zdGFydCArICcuLicgKyB0aGlzLmVuZCA6ICdJbnZhbGlkIFJhbmdlJzsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBpc1ZhbGlkKCkKICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAqIEBzaG9ydCBSZXR1cm5zIHRydWUgaWYgdGhlIHJhbmdlIGlzIHZhbGlkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIGphblRvTWF5LmlzVmFsaWQoKSAtPiB0cnVlCiAgICAgKiAgIE51bWJlci5yYW5nZShOYU4sIE5hTikuaXNWYWxpZCgpICAgICAgICAgICAgICAgICAgICAgICAgICAgLT4gZmFsc2UKICAgICAqCiAgICAgKioqLwogICAgJ2lzVmFsaWQnOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJhbmdlSXNWYWxpZCh0aGlzKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBzcGFuKCkKICAgICAqIEByZXR1cm5zIE51bWJlcgogICAgICogQHNob3J0IFJldHVybnMgdGhlIHNwYW4gb2YgdGhlIHJhbmdlLiBJZiB0aGUgcmFuZ2UgaXMgYSBkYXRlIHJhbmdlLCB0aGUKICAgICAqICAgICAgICB2YWx1ZSBpcyBpbiBtaWxsaXNlY29uZHMuCiAgICAgKiBAZXh0cmEgVGhlIHNwYW4gaW5jbHVkZXMgYm90aCB0aGUgc3RhcnQgYW5kIHRoZSBlbmQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE51bWJlci5yYW5nZSg1LCAxMCkuc3BhbigpICAtPiA2CiAgICAgKiAgIE51bWJlci5yYW5nZSg0MCwgMjUpLnNwYW4oKSAtPiAxNgogICAgICogICBqYW5Ub01heS5zcGFuKCkgICAgICAgICAgICAgLT4gMTAzNjgwMDAwMDEgKG9yIG1vcmUgZGVwZW5kaW5nIG9uIGxlYXAgeWVhcikKICAgICAqCiAgICAgKioqLwogICAgJ3NwYW4nOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG4gPSBnZXRSYW5nZU1lbWJlck51bWVyaWNWYWx1ZSh0aGlzLmVuZCkgLSBnZXRSYW5nZU1lbWJlck51bWVyaWNWYWx1ZSh0aGlzLnN0YXJ0KTsKICAgICAgcmV0dXJuIHJhbmdlSXNWYWxpZCh0aGlzKSA/IGFicyhuKSArIDEgOiBOYU47CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgY29udGFpbnMoZWwpCiAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgKiBAc2hvcnQgUmV0dXJucyB0cnVlIGlmIGBlbGAgaXMgY29udGFpbmVkIGluc2lkZSB0aGUgcmFuZ2UuIGBlbGAgbWF5IGJlIGEKICAgICAqICAgICAgICB2YWx1ZSBvciBhbm90aGVyIHJhbmdlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBOdW1iZXIucmFuZ2UoNSwgMTApLmNvbnRhaW5zKDcpICAgICAgICAgLT4gdHJ1ZQogICAgICogICBOdW1iZXIucmFuZ2UoNSwgMTApLmNvbnRhaW5zKDIpICAgICAgICAgLT4gZmFsc2UKICAgICAqICAgamFuVG9NYXkuY29udGFpbnMobWFyKSAgICAgICAgICAgICAgICAgIC0+IHRydWUKICAgICAqICAgamFuVG9NYXkuY29udGFpbnMobWFyVG9BdWcpICAgICAgICAgICAgIC0+IGZhbHNlCiAgICAgKiAgIGphblRvTWF5LmNvbnRhaW5zKGZlYlRvQXByKSAgICAgICAgICAgICAtPiB0cnVlCiAgICAgKgogICAgICogQHBhcmFtIHtSYW5nZUVsZW1lbnR9IGVsCiAgICAgKgogICAgICoqKi8KICAgICdjb250YWlucyc6IGZ1bmN0aW9uKGVsKSB7CiAgICAgIGlmIChlbCA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmIChlbC5zdGFydCAmJiBlbC5lbmQpIHsKICAgICAgICByZXR1cm4gZWwuc3RhcnQgPj0gdGhpcy5zdGFydCAmJiBlbC5zdGFydCA8PSB0aGlzLmVuZCAmJgogICAgICAgICAgICAgICBlbC5lbmQgICA+PSB0aGlzLnN0YXJ0ICYmIGVsLmVuZCAgIDw9IHRoaXMuZW5kOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBlbCA+PSB0aGlzLnN0YXJ0ICYmIGVsIDw9IHRoaXMuZW5kOwogICAgICB9CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgZXZlcnkoYW1vdW50LCBbZm5dKQogICAgICogQHJldHVybnMgQXJyYXkKICAgICAqIEBzaG9ydCBJdGVyYXRlcyB0aHJvdWdoIHRoZSByYW5nZSBieSBgYW1vdW50YCwgY2FsbGluZyBbZm5dIGZvciBlYWNoIHN0ZXAuCiAgICAgKiBAZXh0cmEgUmV0dXJucyBhbiBhcnJheSBvZiBlYWNoIGluY3JlbWVudCB2aXNpdGVkLiBGb3IgZGF0ZSByYW5nZXMsCiAgICAgKiAgICAgICAgYGFtb3VudGAgY2FuIGFsc28gYmUgYSBzdHJpbmcgbGlrZSBgIjIgZGF5cyJgLiBUaGlzIHdpbGwgc3RlcAogICAgICogICAgICAgIHRocm91Z2ggdGhlIHJhbmdlIGJ5IGluY3JlbWVudGluZyBhIGRhdGUgb2JqZWN0IGJ5IHRoYXQgc3BlY2lmaWMKICAgICAqICAgICAgICB1bml0LCBhbmQgc28gaXMgZ2VuZXJhbGx5IHByZWZlcmFibGUgZm9yIHZhZ3VlIHVuaXRzIHN1Y2ggYXMKICAgICAqICAgICAgICBgIjIgbW9udGhzImAuCiAgICAgKgogICAgICogQGNhbGxiYWNrIHJhbmdlRXZlcnlGbgogICAgICoKICAgICAqICAgZWwgICBUaGUgZWxlbWVudCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIGkgICAgVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IGl0ZXJhdGlvbi4KICAgICAqICAgciAgICBBIHJlZmVyZW5jZSB0byB0aGUgcmFuZ2UuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIE51bWJlci5yYW5nZSgyLCA4KS5ldmVyeSgyKSAtPiBbMiw0LDYsOF0KICAgICAqICAgamFuVG9NYXkuZXZlcnkoJzIgbW9udGhzJykgIC0+IFtKYW4gMSwgTWFyIDEsIE1heSAxXQogICAgICoKICAgICAqICAgc2VwVG9PY3QuZXZlcnkoJ3dlZWsnLCBmdW5jdGlvbigpIHsKICAgICAqICAgICAvLyBXaWxsIGJlIGNhbGxlZCBldmVyeSB3ZWVrIGZyb20gU2VwdGVtYmVyIHRvIE9jdG9iZXIKICAgICAqICAgfSkKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGFtb3VudAogICAgICogQHBhcmFtIHtyYW5nZUV2ZXJ5Rm59IFtmbl0KICAgICAqIEBjYWxsYmFja1BhcmFtIHtSYW5nZUVsZW1lbnR9IGVsCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UmFuZ2V9IHIKICAgICAqCiAgICAgKioqLwogICAgJ2V2ZXJ5JzogZnVuY3Rpb24oYW1vdW50LCBmbikgewogICAgICByZXR1cm4gcmFuZ2VFdmVyeSh0aGlzLCBhbW91bnQsIGZhbHNlLCBmbik7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgdG9BcnJheSgpCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IENyZWF0ZXMgYW4gYXJyYXkgZnJvbSB0aGUgcmFuZ2UuCiAgICAgKiBAZXh0cmEgSWYgdGhlIHJhbmdlIGlzIGEgZGF0ZSByYW5nZSwgZXZlcnkgbWlsbGlzZWNvbmQgYmV0d2VlbiB0aGUgc3RhcnQKICAgICAqICAgICAgICBhbmQgZW5kIGRhdGVzIHdpbGwgYmUgcmV0dXJuZWQuIFRvIGNvbnRyb2wgdGhpcyB1c2UgYGV2ZXJ5YCBpbnN0ZWFkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBOdW1iZXIucmFuZ2UoMSwgNSkudG9BcnJheSgpIC0+IFsxLDIsMyw0LDVdCiAgICAgKiAgIERhdGUucmFuZ2UoJzEgbWlsbGlzZWNvbmQgYWdvJywgJ25vdycpLnRvQXJyYXkoKSAtPiBbMW1zIGFnbywgbm93XQogICAgICoKICAgICAqKiovCiAgICAndG9BcnJheSc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcmFuZ2VFdmVyeSh0aGlzKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCB1bmlvbihyYW5nZSkKICAgICAqIEByZXR1cm5zIFJhbmdlCiAgICAgKiBAc2hvcnQgUmV0dXJucyBhIG5ldyByYW5nZSB3aXRoIHRoZSBlYXJsaWVzdCBzdGFydGluZyBwb2ludCBhcyBpdHMgc3RhcnQsCiAgICAgKiAgICAgICAgYW5kIHRoZSBsYXRlc3QgZW5kaW5nIHBvaW50IGFzIGl0cyBlbmQuIElmIHRoZSB0d28gcmFuZ2VzIGRvIG5vdAogICAgICogICAgICAgIGludGVyc2VjdCB0aGlzIHdpbGwgZWZmZWN0aXZlbHkgcmVtb3ZlIHRoZSAiZ2FwIiBiZXR3ZWVuIHRoZW0uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG9uZVRvVGVuLnVuaW9uKGZpdmVUb1R3ZW50eSkgLT4gMS4uMjAKICAgICAqICAgamFuVG9NYXkudW5pb24obWFyVG9BdWcpICAgICAtPiBKYW4gMSwgeHh4eC4uQXVnIDEsIHh4eHgKICAgICAqCiAgICAgKiBAcGFyYW0ge1JhbmdlfSByYW5nZQogICAgICoKICAgICAqKiovCiAgICAndW5pb24nOiBmdW5jdGlvbihyYW5nZSkgewogICAgICByZXR1cm4gbmV3IFJhbmdlKAogICAgICAgIHRoaXMuc3RhcnQgPCByYW5nZS5zdGFydCA/IHRoaXMuc3RhcnQgOiByYW5nZS5zdGFydCwKICAgICAgICB0aGlzLmVuZCAgID4gcmFuZ2UuZW5kICAgPyB0aGlzLmVuZCAgIDogcmFuZ2UuZW5kCiAgICAgICk7CiAgICB9LAoKICAgIC8qKioKICAgICAqIEBtZXRob2QgaW50ZXJzZWN0KHJhbmdlKQogICAgICogQHJldHVybnMgUmFuZ2UKICAgICAqIEBzaG9ydCBSZXR1cm5zIGEgbmV3IHJhbmdlIHdpdGggdGhlIGxhdGVzdCBzdGFydGluZyBwb2ludCBhcyBpdHMgc3RhcnQsCiAgICAgKiAgICAgICAgYW5kIHRoZSBlYXJsaWVzdCBlbmRpbmcgcG9pbnQgYXMgaXRzIGVuZC4gSWYgdGhlIHR3byByYW5nZXMgZG8gbm90CiAgICAgKiAgICAgICAgaW50ZXJzZWN0IHRoaXMgd2lsbCBlZmZlY3RpdmVseSBwcm9kdWNlIGFuIGludmFsaWQgcmFuZ2UuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIG9uZVRvVGVuLmludGVyc2VjdChmaXZlVG9Ud2VudHkpIC0+IDUuLjEwCiAgICAgKiAgIGphblRvTWF5LmludGVyc2VjdChtYXJUb0F1ZykgICAgIC0+IE1hciAxLCB4eHh4Li5NYXkgMSwgeHh4eAogICAgICoKICAgICAqIEBwYXJhbSB7UmFuZ2V9IHJhbmdlCiAgICAgKgogICAgICoqKi8KICAgICdpbnRlcnNlY3QnOiBmdW5jdGlvbihyYW5nZSkgewogICAgICBpZiAocmFuZ2Uuc3RhcnQgPiB0aGlzLmVuZCB8fCByYW5nZS5lbmQgPCB0aGlzLnN0YXJ0KSB7CiAgICAgICAgcmV0dXJuIG5ldyBSYW5nZShOYU4sIE5hTik7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBSYW5nZSgKICAgICAgICB0aGlzLnN0YXJ0ID4gcmFuZ2Uuc3RhcnQgPyB0aGlzLnN0YXJ0IDogcmFuZ2Uuc3RhcnQsCiAgICAgICAgdGhpcy5lbmQgICA8IHJhbmdlLmVuZCAgID8gdGhpcy5lbmQgICA6IHJhbmdlLmVuZAogICAgICApOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGNsb25lKCkKICAgICAqIEByZXR1cm5zIFJhbmdlCiAgICAgKiBAc2hvcnQgQ2xvbmVzIHRoZSByYW5nZS4KICAgICAqIEBleHRyYSBNZW1iZXJzIG9mIHRoZSByYW5nZSB3aWxsIGFsc28gYmUgY2xvbmVkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBOdW1iZXIucmFuZ2UoMSwgNSkuY2xvbmUoKSAtPiBSZXR1cm5zIGEgY29weSBvZiB0aGUgcmFuZ2UuCiAgICAgKgogICAgICoqKi8KICAgICdjbG9uZSc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IFJhbmdlKHRoaXMuc3RhcnQsIHRoaXMuZW5kKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBjbGFtcChlbCkKICAgICAqIEByZXR1cm5zIE1peGVkCiAgICAgKiBAc2hvcnQgQ2xhbXBzIGBlbGAgdG8gYmUgd2l0aGluIHRoZSByYW5nZSBpZiBpdCBmYWxscyBvdXRzaWRlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBOdW1iZXIucmFuZ2UoMSwgNSkuY2xhbXAoOCkgICAgIC0+IDUKICAgICAqICAgamFuVG9NYXkuY2xhbXAoYXVnKSAtPiBNYXkgMSwgeHh4eAogICAgICoKICAgICAqIEBwYXJhbSB7UmFuZ2VFbGVtZW50fSBlbAogICAgICoKICAgICAqKiovCiAgICAnY2xhbXAnOiBmdW5jdGlvbihlbCkgewogICAgICByZXR1cm4gcmFuZ2VDbGFtcCh0aGlzLCBlbCk7CiAgICB9CgogIH0pOwoKCiAgLyoqKiBAbmFtZXNwYWNlIE51bWJlciAqKiovCgogIGRlZmluZVN0YXRpYyhzdWdhck51bWJlciwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgcmFuZ2UoW3N0YXJ0XSwgW2VuZF0pCiAgICAgKiBAcmV0dXJucyBSYW5nZQogICAgICogQHN0YXRpYwogICAgICogQHNob3J0IENyZWF0ZXMgYSBuZXcgbnVtYmVyIHJhbmdlIGJldHdlZW4gW3N0YXJ0XSBhbmQgW2VuZF0uIFNlZSBgcmFuZ2VzYAogICAgICogICAgICAgIGZvciBtb3JlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICBOdW1iZXIucmFuZ2UoNSwgMTApCiAgICAgKiAgIE51bWJlci5yYW5nZSgyMCwgMTUpCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydF0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZW5kXQogICAgICoKICAgICAqKiovCiAgICAncmFuZ2UnOiBQcmltaXRpdmVSYW5nZUNvbnN0cnVjdG9yCgogIH0pOwoKICBkZWZpbmVJbnN0YW5jZShzdWdhck51bWJlciwgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgdXB0byhudW0sIFtzdGVwXSA9IDEsIFtmbl0pCiAgICAgKiBAcmV0dXJucyBBcnJheQogICAgICogQHNob3J0IFJldHVybnMgYW4gYXJyYXkgY29udGFpbmluZyBudW1iZXJzIGZyb20gdGhlIG51bWJlciB1cCB0byBgbnVtYC4KICAgICAqIEBleHRyYSBPcHRpb25hbGx5IGNhbGxzIFtmbl0gZm9yIGVhY2ggbnVtYmVyIGluIHRoYXQgYXJyYXkuIFtzdGVwXSBhbGxvd3MKICAgICAqICAgICAgICBtdWx0aXBsZXMgb3RoZXIgdGhhbiAxLiBbZm5dIGNhbiBiZSBwYXNzZWQgaW4gcGxhY2Ugb2YgW3N0ZXBdLgogICAgICoKICAgICAqIEBjYWxsYmFjayByYW5nZUV2ZXJ5Rm4KICAgICAqCiAgICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAgICogICBpICAgIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVyYXRpb24uCiAgICAgKiAgIHIgICAgQSByZWZlcmVuY2UgdG8gdGhlIHJhbmdlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogICAoMikudXB0byg2KSAtPiBbMiwgMywgNCwgNSwgNl0KICAgICAqICAgKDIpLnVwdG8oNiwgZnVuY3Rpb24obikgewogICAgICogICAgIC8vIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIDUgdGltZXMgcmVjZWl2aW5nIG4gYXMgdGhlIHZhbHVlLgogICAgICogICB9KTsKICAgICAqICAgKDIpLnVwdG8oOCwgMikgLT4gWzIsIDQsIDYsIDhdCiAgICAgKgogICAgICogQHNpZ25hdHVyZSB1cHRvKG51bSwgW2ZuXSkKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RlcF0KICAgICAqIEBwYXJhbSB7cmFuZ2VFdmVyeUZufSBbZm5dCiAgICAgKiBAY2FsbGJhY2tQYXJhbSB7UmFuZ2VFbGVtZW50fSBlbAogICAgICogQGNhbGxiYWNrUGFyYW0ge251bWJlcn0gaQogICAgICogQGNhbGxiYWNrUGFyYW0ge1JhbmdlfSByCiAgICAgKgogICAgICoqKi8KICAgICd1cHRvJzogZnVuY3Rpb24obiwgbnVtLCBzdGVwLCBmbikgewogICAgICByZXR1cm4gcmFuZ2VFdmVyeShuZXcgUmFuZ2UobiwgbnVtKSwgc3RlcCwgZmFsc2UsIGZuKTsKICAgIH0sCgogICAgLyoqKgogICAgICogQG1ldGhvZCBjbGFtcChbc3RhcnRdID0gSW5maW5pdHksIFtlbmRdID0gSW5maW5pdHkpCiAgICAgKiBAcmV0dXJucyBOdW1iZXIKICAgICAqIEBzaG9ydCBDb25zdHJhaW5zIHRoZSBudW1iZXIgc28gdGhhdCBpdCBmYWxscyBvbiBvciBiZXR3ZWVuIFtzdGFydF0gYW5kCiAgICAgKiAgICAgICAgW2VuZF0uCiAgICAgKiBAZXh0cmEgVGhpcyB3aWxsIGJ1aWxkIGEgcmFuZ2Ugb2JqZWN0IHRoYXQgaGFzIGFuIGVxdWl2YWxlbnQgYGNsYW1wYCBtZXRob2QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgICgzKS5jbGFtcCg1MCwgMTAwKSAgLT4gNTAKICAgICAqICAgKDg1KS5jbGFtcCg1MCwgMTAwKSAtPiA4NQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnRdCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2VuZF0KICAgICAqCiAgICAgKioqLwogICAgJ2NsYW1wJzogZnVuY3Rpb24obiwgc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gcmFuZ2VDbGFtcChuZXcgUmFuZ2Uoc3RhcnQsIGVuZCksIG4pOwogICAgfSwKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIGNhcChbbWF4XSA9IEluZmluaXR5KQogICAgICogQHJldHVybnMgTnVtYmVyCiAgICAgKiBAc2hvcnQgQ29uc3RyYWlucyB0aGUgbnVtYmVyIHNvIHRoYXQgaXQgaXMgbm8gZ3JlYXRlciB0aGFuIFttYXhdLgogICAgICogQGV4dHJhIFRoaXMgd2lsbCBidWlsZCBhIHJhbmdlIG9iamVjdCB0aGF0IGhhcyBhbiBlcXVpdmFsZW50IGBjYXBgIG1ldGhvZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgKDEwMCkuY2FwKDgwKSAtPiA4MAogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4XQogICAgICoKICAgICAqKiovCiAgICAnY2FwJzogZnVuY3Rpb24obiwgbWF4KSB7CiAgICAgIHJldHVybiByYW5nZUNsYW1wKG5ldyBSYW5nZSh1bmRlZmluZWQsIG1heCksIG4pOwogICAgfQoKICB9KTsKCiAgLyoqKgogICAqIEBtZXRob2QgZG93bnRvKG51bSwgW3N0ZXBdID0gMSwgW2ZuXSkKICAgKiBAcmV0dXJucyBBcnJheQogICAqIEBzaG9ydCBSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgbnVtYmVycyBmcm9tIHRoZSBudW1iZXIgZG93biB0byBgbnVtYC4KICAgKiBAZXh0cmEgT3B0aW9uYWxseSBjYWxscyBbZm5dIGZvciBlYWNoIG51bWJlciBpbiB0aGF0IGFycmF5LiBbc3RlcF0gYWxsb3dzCiAgICogICAgICAgIG11bHRpcGxlcyBvdGhlciB0aGFuIDEuIFtmbl0gY2FuIGJlIHBhc3NlZCBpbiBwbGFjZSBvZiBbc3RlcF0uCiAgICoKICAgKiBAY2FsbGJhY2sgcmFuZ2VFdmVyeUZuCiAgICoKICAgKiAgIGVsICAgVGhlIGVsZW1lbnQgb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAqICAgaSAgICBUaGUgaW5kZXggb2YgdGhlIGN1cnJlbnQgaXRlcmF0aW9uLgogICAqICAgciAgICBBIHJlZmVyZW5jZSB0byB0aGUgcmFuZ2UuCiAgICoKICAgKiBAZXhhbXBsZQogICAqCiAgICogICAoOCkuZG93bnRvKDMpIC0+IFs4LCA3LCA2LCA1LCA0LCAzXQogICAqICAgKDgpLmRvd250bygzLCBmdW5jdGlvbihuKSB7CiAgICogICAgIC8vIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIDYgdGltZXMgcmVjZWl2aW5nIG4gYXMgdGhlIHZhbHVlLgogICAqICAgfSk7CiAgICogICAoOCkuZG93bnRvKDIsIDIpIC0+IFs4LCA2LCA0LCAyXQogICAqCiAgICogQHNpZ25hdHVyZSB1cHRvKG51bSwgW2ZuXSkKICAgKiBAcGFyYW0ge251bWJlcn0gbnVtCiAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGVwXQogICAqIEBwYXJhbSB7cmFuZ2VFdmVyeUZufSBbZm5dCiAgICogQGNhbGxiYWNrUGFyYW0ge1JhbmdlRWxlbWVudH0gZWwKICAgKiBAY2FsbGJhY2tQYXJhbSB7bnVtYmVyfSBpCiAgICogQGNhbGxiYWNrUGFyYW0ge1JhbmdlfSByCiAgICoKICAgKioqLwogIGFsaWFzKHN1Z2FyTnVtYmVyLCAnZG93bnRvJywgJ3VwdG8nKTsKCgogIC8qKiogQG5hbWVzcGFjZSBTdHJpbmcgKioqLwoKICBkZWZpbmVTdGF0aWMoc3VnYXJTdHJpbmcsIHsKCiAgICAvKioqCiAgICAgKiBAbWV0aG9kIHJhbmdlKFtzdGFydF0sIFtlbmRdKQogICAgICogQHJldHVybnMgUmFuZ2UKICAgICAqIEBzdGF0aWMKICAgICAqIEBzaG9ydCBDcmVhdGVzIGEgbmV3IHN0cmluZyByYW5nZSBiZXR3ZWVuIFtzdGFydF0gYW5kIFtlbmRdLiBTZWUgYHJhbmdlc2AKICAgICAqICAgICAgICBmb3IgbW9yZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqICAgU3RyaW5nLnJhbmdlKCdhJywgJ3onKQogICAgICogICBTdHJpbmcucmFuZ2UoJ3QnLCAnbScpCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzdGFydF0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbZW5kXQogICAgICoKICAgICAqKiovCiAgICAncmFuZ2UnOiBQcmltaXRpdmVSYW5nZUNvbnN0cnVjdG9yCgogIH0pOwoKCiAgLyoqKiBAbmFtZXNwYWNlIERhdGUgKioqLwoKCiAgdmFyIEZVTExfQ0FQVFVSRURfRFVSQVRJT04gPSAnKCg/OlxcZCspP1xccyooPzonICsgRFVSQVRJT05fVU5JVFMgKyAnKSlzPyc7CgogIC8vIER1cmF0aW9uIHRleHQgZm9ybWF0cwogIHZhciBSQU5HRV9SRUdfRlJPTV9UTyAgICAgICAgPSAvKD86ZnJvbSk/XHMqKC4rKVxzKyg/OnRvfHVudGlsKVxzKyguKykkL2ksCiAgICAgIFJBTkdFX1JFR19SRUFSX0RVUkFUSU9OICA9IFJlZ0V4cCgnKC4rKVxccypmb3JcXHMqJyArIEZVTExfQ0FQVFVSRURfRFVSQVRJT04sICdpJyksCiAgICAgIFJBTkdFX1JFR19GUk9OVF9EVVJBVElPTiA9IFJlZ0V4cCgnKD86Zm9yKT9cXHMqJysgRlVMTF9DQVBUVVJFRF9EVVJBVElPTiArJ1xccyooPzpzdGFydGluZyk/XFxzKD86YXRcXHMpPyguKyknLCAnaScpOwoKICB2YXIgRGF0ZVJhbmdlQ29uc3RydWN0b3IgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiBpc1N0cmluZyhzdGFydCkpIHsKICAgICAgcmV0dXJuIGNyZWF0ZURhdGVSYW5nZUZyb21TdHJpbmcoc3RhcnQpOwogICAgfQogICAgcmV0dXJuIG5ldyBSYW5nZShnZXREYXRlRm9yUmFuZ2Uoc3RhcnQpLCBnZXREYXRlRm9yUmFuZ2UoZW5kKSk7CiAgfTsKCiAgZnVuY3Rpb24gY3JlYXRlRGF0ZVJhbmdlRnJvbVN0cmluZyhzdHIpIHsKICAgIHZhciBtYXRjaCwgZGF0ZXRpbWUsIGR1cmF0aW9uLCBkaW8sIHN0YXJ0LCBlbmQ7CiAgICBpZiAoc3VnYXJEYXRlLmdldCAmJiAobWF0Y2ggPSBzdHIubWF0Y2goUkFOR0VfUkVHX0ZST01fVE8pKSkgewogICAgICBzdGFydCA9IGdldERhdGVGb3JSYW5nZShtYXRjaFsxXS5yZXBsYWNlKCdmcm9tJywgJ2F0JykpOwogICAgICBlbmQgPSBzdWdhckRhdGUuZ2V0KHN0YXJ0LCBtYXRjaFsyXSk7CiAgICAgIHJldHVybiBuZXcgUmFuZ2Uoc3RhcnQsIGVuZCk7CiAgICB9CiAgICBpZiAobWF0Y2ggPSBzdHIubWF0Y2goUkFOR0VfUkVHX0ZST05UX0RVUkFUSU9OKSkgewogICAgICBkdXJhdGlvbiA9IG1hdGNoWzFdOwogICAgICBkYXRldGltZSA9IG1hdGNoWzJdOwogICAgfQogICAgaWYgKG1hdGNoID0gc3RyLm1hdGNoKFJBTkdFX1JFR19SRUFSX0RVUkFUSU9OKSkgewogICAgICBkYXRldGltZSA9IG1hdGNoWzFdOwogICAgICBkdXJhdGlvbiA9IG1hdGNoWzJdOwogICAgfQogICAgaWYgKGRhdGV0aW1lICYmIGR1cmF0aW9uKSB7CiAgICAgIHN0YXJ0ID0gZ2V0RGF0ZUZvclJhbmdlKGRhdGV0aW1lKTsKICAgICAgZGlvID0gZ2V0RGF0ZUluY3JlbWVudE9iamVjdChkdXJhdGlvbik7CiAgICAgIGVuZCA9IGluY3JlbWVudERhdGUoc3RhcnQsIGRpb1swXSwgZGlvWzFdKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YXJ0ID0gc3RyOwogICAgfQogICAgcmV0dXJuIG5ldyBSYW5nZShnZXREYXRlRm9yUmFuZ2Uoc3RhcnQpLCBnZXREYXRlRm9yUmFuZ2UoZW5kKSk7CiAgfQoKICBmdW5jdGlvbiBnZXREYXRlRm9yUmFuZ2UoZCkgewogICAgaWYgKGlzRGF0ZShkKSkgewogICAgICByZXR1cm4gZDsKICAgIH0gZWxzZSBpZiAoZCA9PSBudWxsKSB7CiAgICAgIHJldHVybiBuZXcgRGF0ZSgpOwogICAgfSBlbHNlIGlmIChzdWdhckRhdGUuY3JlYXRlKSB7CiAgICAgIHJldHVybiBzdWdhckRhdGUuY3JlYXRlKGQpOwogICAgfQogICAgcmV0dXJuIG5ldyBEYXRlKGQpOwogIH0KCiAgLyoqKgogICAqIEBtZXRob2QgW2RhdGVVbml0XSgpCiAgICogQHJldHVybnMgTnVtYmVyCiAgICogQG5hbWVzcGFjZSBSYW5nZQogICAqIEBzaG9ydCBSZXR1cm5zIHRoZSBzcGFuIG9mIGEgZGF0ZSByYW5nZSBpbiB0aGUgZ2l2ZW4gdW5pdC4KICAgKiBAZXh0cmEgSGlnaGVyIG9yZGVyIHVuaXRzICgiZGF5cyIgYW5kIGdyZWF0ZXIpIHdhbGsgdGhlIGRhdGUgdG8gYXZvaWQKICAgKiAgICAgICAgZGlzY3JlcGFuY2llcyB3aXRoIGFtYmlndWl0eS4gTG93ZXIgb3JkZXIgdW5pdHMgc2ltcGx5IHN1YnRyYWN0IHRoZQogICAqICAgICAgICBzdGFydCBmcm9tIHRoZSBlbmQuCiAgICoKICAgKiBAc2V0CiAgICogICBtaWxsaXNlY29uZHMKICAgKiAgIHNlY29uZHMKICAgKiAgIG1pbnV0ZXMKICAgKiAgIGhvdXJzCiAgICogICBkYXlzCiAgICogICB3ZWVrcwogICAqICAgbW9udGhzCiAgICogICB5ZWFycwogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgamFuVG9NYXkubW9udGhzKCkgIC0+IDQKICAgKiAgIGphblRvTWF5LmRheXMoKSAgICAtPiAxMjEKICAgKiAgIGphblRvTWF5LmhvdXJzKCkgICAtPiAyOTA0CiAgICogICBqYW5Ub01heS5taW51dGVzKCkgLT4gMjIwMzIwCiAgICoKICAgKioqLwogIGZ1bmN0aW9uIGJ1aWxkRGF0ZVJhbmdlVW5pdHMoKSB7CiAgICB2YXIgbWV0aG9kcyA9IHt9OwogICAgZm9yRWFjaChEVVJBVElPTl9VTklUUy5zcGxpdCgnfCcpLCBmdW5jdGlvbih1bml0LCBpKSB7CiAgICAgIHZhciBuYW1lID0gdW5pdCArICdzJywgbXVsdCwgZm47CiAgICAgIGlmIChpIDwgNCkgewogICAgICAgIGZuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gcmFuZ2VFdmVyeSh0aGlzLCB1bml0LCB0cnVlKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIG11bHQgPSBNVUxUSVBMSUVSU1tzaW1wbGVDYXBpdGFsaXplKG5hbWUpXTsKICAgICAgICBmbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRydW5jKCh0aGlzLmVuZCAtIHRoaXMuc3RhcnQpIC8gbXVsdCk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBtZXRob2RzW25hbWVdID0gZm47CiAgICB9KTsKICAgIGRlZmluZU9uUHJvdG90eXBlKFJhbmdlLCBtZXRob2RzKTsKICB9CgogIGRlZmluZVN0YXRpYyhzdWdhckRhdGUsICAgewoKICAgIC8qKioKICAgICAqIEBtZXRob2QgcmFuZ2UoW3N0YXJ0XSwgW2VuZF0pCiAgICAgKiBAcmV0dXJucyBSYW5nZQogICAgICogQG5hbWVzcGFjZSBEYXRlCiAgICAgKiBAc3RhdGljCiAgICAgKiBAc2hvcnQgQ3JlYXRlcyBhIG5ldyBkYXRlIHJhbmdlIGJldHdlZW4gW3N0YXJ0XSBhbmQgW2VuZF0uCiAgICAgKiBAZXh0cmEgQXJndW1lbnRzIG1heSBiZSBlaXRoZXIgZGF0ZXMgb3Igc3RyaW5ncyB3aGljaCB3aWxsIGJlIGZvcndhcmRlZCB0bwogICAgICogICAgICAgIHRoZSBkYXRlIGNvbnN0cnVjdG9yIChgY3JlYXRlYCB3aWxsIGJlIHVzZWQgaWYgcHJlc2VudCBpbiB0aGUgYnVpbGQpLgogICAgICogICAgICAgIElmIGVpdGhlciBbc3RhcnRdIG9yIFtlbmRdIGFyZSB1bmRlZmluZWQsIHRoZXkgd2lsbCBkZWZhdWx0IHRvIHRoZQogICAgICogICAgICAgIGN1cnJlbnQgZGF0ZS4gVGhpcyBtZXRob2QgYWxzbyBhY2NlcHRzIGFuIGFsdGVybmF0ZSBzeW50YXggb2YgYQogICAgICogICAgICAgIHNpbmdsZSBzdHJpbmcgZGVzY3JpYmluZyB0aGUgcmFuZ2UgaW4gbmF0dXJhbCBsYW5ndWFnZS4gU2VlIGByYW5nZXNgCiAgICAgKiAgICAgICAgZm9yIG1vcmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAgIERhdGUucmFuZ2UoamFuLCBtYXkpCiAgICAgKiAgIERhdGUucmFuZ2UoJ3RvZGF5JywgJ3RvbW9ycm93JykKICAgICAqICAgRGF0ZS5yYW5nZSgnbm93JywgJzUgZGF5cyBhZ28nKQogICAgICogICBEYXRlLnJhbmdlKCdsYXN0IE1vbmRheScpCiAgICAgKiAgIERhdGUucmFuZ2UoJ01vbmRheSB0byBGcmlkYXknKQogICAgICogICBEYXRlLnJhbmdlKCd0b21vcnJvdyBmcm9tIDNwbSB0byA1cG0nKQogICAgICogICBEYXRlLnJhbmdlKCcxIGhvdXIgc3RhcnRpbmcgYXQgNXBtIFR1ZXNkYXknKQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfERhdGV9IFtzdGFydF0KICAgICAqIEBwYXJhbSB7c3RyaW5nfERhdGV9IFtlbmRdCiAgICAgKgogICAgICoqKi8KICAgICdyYW5nZSc6IERhdGVSYW5nZUNvbnN0cnVjdG9yCgogIH0pOwoKICBidWlsZERhdGVSYW5nZVVuaXRzKCk7Cgp9KS5jYWxsKHRoaXMpOw==',
  /* custom-helpers */ 'Ly8gQ2xvbmVzIGEgYnJhbmNoIG9mIHRoZSBET00gdGhhdCBoYXMgYG5vZGVgIGFzIGl0cyBib3R0b20gbGVhZiwgYW5kIHJldHVybnMKLy8gdGhlIHJvb3Qgbm9kZS4Kd2luZG93LmJyYW5jaCA9IGZ1bmN0aW9uKG5vZGUpIHsKICAgIHZhciBuZXh0LCBub2Rlcywgcm9vdDsKICAgIG5vZGVzID0gW107CiAgICB3aGlsZSAobm9kZSkgewogICAgICAgIG5vZGVzLnB1c2gobm9kZS5jbG9uZU5vZGUoZmFsc2UpKTsKICAgICAgICBub2RlID0gbm9kZS5wYXJlbnRFbGVtZW50OwogICAgfQogICAgcm9vdCA9IG5vZGUgPSBub2Rlcy5wb3AoKTsKICAgIHdoaWxlIChub2Rlcy5sZW5ndGgpIHsKICAgICAgICBuZXh0ID0gbm9kZXMucG9wKCk7CiAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChuZXh0KTsKICAgICAgICBub2RlID0gbmV4dDsKICAgIH0KICAgIHJldHVybiByb290Owp9OwoKLy8gU2ltaWxhciB0byBgYnJhbmNoKClgLCBidXQgZG9lc24ndCBjbG9uZSBhbnl0aGluZyBhbmQgcmV0dXJucyBlYWNoIERPTSBub2RlCi8vIGluIGEgZmxhdCBhcnJheSwgb3JkZXJlZCBmcm9tIHJvb3QgLT4gbGVhZi4Kd2luZG93Lm5vZGVzID0gZnVuY3Rpb24obm9kZSkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgcmVzdWx0cy5wdXNoKG5vZGUpOwogICAgICAgIG5vZGUgPSBub2RlLnBhcmVudEVsZW1lbnQ7CiAgICB9CiAgICByZXN1bHRzLnJldmVyc2UoKTsKICAgIHJldHVybiByZXN1bHRzOwp9OwoKLy8gRmxhdHRlbnMgb3V0IHdoaXRlc3BhY2UgZnJvbSB0aGUgcmVzdWx0cyBvZiAkLnRleHQoKS4KJC5mbi5mbGF0dGV4dCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICQodGhpcykKICAgICAgICAudGV4dCgpCiAgICAgICAgLnJlcGxhY2UoL1xuL2csICcgJykKICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAudHJpbSgpCn07Cgp3aW5kb3cuY29tbWlmeSA9IGZ1bmN0aW9uKHMpIHsKCiAgICBmdW5jdGlvbiByKHIpIHsKICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShyKSA/IHIgOiBTdHJpbmcocikuc3BsaXQoL1tlRV0vKQogICAgfQoKICAgIGZ1bmN0aW9uIGZyb21FeHAoZSkgewogICAgICAgIHZhciB0ID0gcihlKTsKICAgICAgICBpZiAoISBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHIoZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gIU51bWJlci5pc05hTihOdW1iZXIodFsxXSkpCiAgICAgICAgICAgIH0odCkpIHJldHVybiB0WzBdOwogICAgICAgIHZhciBuID0gIi0iID09PSB0WzBdWzBdID8gIi0iIDogIiIsCiAgICAgICAgICAgIHUgPSB0WzBdLnJlcGxhY2UoL14tLywgIiIpLnNwbGl0KCIuIiksCiAgICAgICAgICAgIGkgPSB1WzBdLAogICAgICAgICAgICBmID0gdVsxXSB8fCAiIiwKICAgICAgICAgICAgbyA9IE51bWJlcih0WzFdKTsKICAgICAgICBpZiAoMCA9PT0gbykgcmV0dXJuIG4gKyBpICsgIi4iICsgZjsKICAgICAgICBpZiAobyA8IDApIHsKICAgICAgICAgICAgdmFyIHMgPSBpLmxlbmd0aCArIG87CiAgICAgICAgICAgIGlmIChzID4gMCkgcmV0dXJuIG4gKyBpLnN1YnN0cigwLCBzKSArICIuIiArIGkuc3Vic3RyKHMpICsgZjsKICAgICAgICAgICAgdmFyIGEgPSAiMC4iOwogICAgICAgICAgICBmb3IgKG8gKz0gMTsgbzspIGEgKz0gIjAiLCBvICs9IDE7CiAgICAgICAgICAgIHJldHVybiBuICsgYSArIGkgKyBmCiAgICAgICAgfQogICAgICAgIHZhciBjID0gZi5sZW5ndGggLSBvOwogICAgICAgIGlmIChjID4gMCkgewogICAgICAgICAgICB2YXIgcCA9IGYuc3Vic3RyKG8pOwogICAgICAgICAgICByZXR1cm4gbiArIGkgKyBmLnN1YnN0cigwLCBvKSArICIuIiArIHAKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgYiA9IC1jLCBkID0gIiI7IGI7KSBkICs9ICIwIiwgYiAtPSAxOwogICAgICAgIHJldHVybiBuICsgaSArIGYgKyBkCiAgICB9CgogICAgdmFyIGRlY2ltYWxzLCBtLCByZWY7CiAgICB2YXIgbnVtID0gZnJvbUV4cChldmFsKHMpKTsKICAgIGlmIChtID0gbnVtLm1hdGNoKC8oXGQrKShcLihcZCspKT8vKSkgewogICAgICBkZWNpbWFscyA9IChyZWYgPSBtWzNdKSAhPSBudWxsID8gcmVmLnJlcGxhY2UoLyhcZHszfSkoPz1cZCkvZywgZnVuY3Rpb24oYSxiKSB7CiAgICAgICAgcmV0dXJuIGIgKyAnLCc7CiAgICAgIH0pIDogdm9pZCAwOwogICAgICBudW0gPSBtWzFdLnJlcGxhY2UoL1xCKD89KFxkezN9KSsoPyFcZCkpL2csICIsIikgKyAoZGVjaW1hbHMgPyAnLicgKyBkZWNpbWFscyA6ICcnKTsKICAgIH0KCiAgICByZXR1cm4gbnVtOwp9Owo=',
  /* markdown-table */ 'd2luZG93Lm1kdGFibGUgPSBmdW5jdGlvbih0YWJsZSwgb3B0aW9ucykgewogIGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPT09ICJzeW1ib2wiKSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gdHlwZW9mIG9iajsgfTsgfSBlbHNlIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7IH07IH0gcmV0dXJuIF90eXBlb2Yob2JqKTsgfQoKICB2YXIgcmVwZWF0ID0gZnVuY3Rpb24ocywgbikgewogICAgdmFyIHJlc3VsdCA9ICcnOwogICAgZm9yICh2YXIgaSA9IDE7IGkgPD0gbjsgaSsrKSB7CiAgICAgIHJlc3VsdCArPSBzOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICB2YXIgc2VyaWFsaXplID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkID8gJycgOiBTdHJpbmcodmFsdWUpOwogIH0KCiAgdmFyIGRlZmF1bHRTdHJpbmdMZW5ndGggPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLmxlbmd0aDsKICB9CgogIHZhciB0b0FsaWdubWVudCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB2YXIgY29kZSA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyB2YWx1ZS5jaGFyQ29kZUF0KDApIDogeDsKICAgIHJldHVybiBjb2RlID09PSBMIHx8IGNvZGUgPT09IGwgPyBsIDogY29kZSA9PT0gUiB8fCBjb2RlID09PSByID8gciA6IGNvZGUgPT09IEMgfHwgY29kZSA9PT0gYyA/IGMgOiB4OwogIH0KCiAgdmFyIHRyYWlsaW5nV2hpdGVzcGFjZSA9IC8gKyQvOyAvLyBDaGFyYWN0ZXJzLgoKICB2YXIgc3BhY2UgPSAnICc7CiAgdmFyIGxpbmVGZWVkID0gJ1xuJzsKICB2YXIgZGFzaCA9ICctJzsKICB2YXIgY29sb24gPSAnOic7CiAgdmFyIHZlcnRpY2FsQmFyID0gJ3wnOwogIHZhciB4ID0gMDsKICB2YXIgQyA9IDY3OwogIHZhciBMID0gNzY7CiAgdmFyIFIgPSA4MjsKICB2YXIgYyA9IDk5OwogIHZhciBsID0gMTA4OwogIHZhciByID0gMTE0OyAvLyBDcmVhdGUgYSB0YWJsZSBmcm9tIGEgbWF0cml4IG9mIHN0cmluZ3MuCgogIHZhciBzdHJpbmcgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgc2V0dGluZ3MgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIHBhZGRpbmcgPSBzZXR0aW5ncy5wYWRkaW5nICE9PSBmYWxzZTsKICAgIHZhciBzdGFydCA9IHNldHRpbmdzLmRlbGltaXRlclN0YXJ0ICE9PSBmYWxzZTsKICAgIHZhciBlbmQgPSBzZXR0aW5ncy5kZWxpbWl0ZXJFbmQgIT09IGZhbHNlOwogICAgdmFyIGFsaWduID0gc2V0dGluZ3MuYWxpZ24gfHwgW107CiAgICBhbGlnbiA9IHR5cGVvZiBhbGlnbiA9PT0gJ3N0cmluZycgPyBhbGlnbi5zcGxpdCgnJykgOiBhbGlnbi5jb25jYXQoKTsKICAgIHZhciBhbGlnbkRlbGltaXRlcnMgPSBzZXR0aW5ncy5hbGlnbkRlbGltaXRlcnMgIT09IGZhbHNlOwogICAgdmFyIGFsaWdubWVudHMgPSBbXTsKICAgIHZhciBzdHJpbmdMZW5ndGggPSBzZXR0aW5ncy5zdHJpbmdMZW5ndGggfHwgZGVmYXVsdFN0cmluZ0xlbmd0aDsKICAgIHZhciByb3dJbmRleCA9IC0xOwogICAgdmFyIHJvd0xlbmd0aCA9IHRhYmxlLmxlbmd0aDsKICAgIHZhciBjZWxsTWF0cml4ID0gW107CiAgICB2YXIgc2l6ZU1hdHJpeCA9IFtdOwogICAgdmFyIHJvdyA9IFtdOwogICAgdmFyIHNpemVzID0gW107CiAgICB2YXIgbG9uZ2VzdENlbGxCeUNvbHVtbiA9IFtdOwogICAgdmFyIG1vc3RDZWxsc1BlclJvdyA9IDA7CiAgICB2YXIgY2VsbHM7CiAgICB2YXIgY29sdW1uSW5kZXg7CiAgICB2YXIgY29sdW1uTGVuZ3RoOwogICAgdmFyIGxhcmdlc3Q7CiAgICB2YXIgc2l6ZTsKICAgIHZhciBjZWxsOwogICAgdmFyIGxpbmVzOwogICAgdmFyIGxpbmU7CiAgICB2YXIgYmVmb3JlOwogICAgdmFyIGFmdGVyOwogICAgdmFyIGNvZGU7IC8vIFRoaXMgaXMgYSBzdXBlcmZsdW91cyBsb29wIGlmIHdlIGRvbuKAmXQgYWxpZ24gZGVsaW1pdGVycywgYnV0IG90aGVyd2lzZSB3ZeKAmWQKICAgIC8vIGRvIHN1cGVyZmx1b3VzIHdvcmsgd2hlbiBhbGlnbmluZywgc28gb3B0aW1pemUgZm9yIGFsaWduaW5nLgoKICAgIHdoaWxlICgrK3Jvd0luZGV4IDwgcm93TGVuZ3RoKSB7CiAgICAgIGNlbGxzID0gdGFibGVbcm93SW5kZXhdOwogICAgICBjb2x1bW5JbmRleCA9IC0xOwogICAgICBjb2x1bW5MZW5ndGggPSBjZWxscy5sZW5ndGg7CiAgICAgIHJvdyA9IFtdOwogICAgICBzaXplcyA9IFtdOwoKICAgICAgaWYgKGNvbHVtbkxlbmd0aCA+IG1vc3RDZWxsc1BlclJvdykgewogICAgICAgIG1vc3RDZWxsc1BlclJvdyA9IGNvbHVtbkxlbmd0aDsKICAgICAgfQoKICAgICAgd2hpbGUgKCsrY29sdW1uSW5kZXggPCBjb2x1bW5MZW5ndGgpIHsKICAgICAgICBjZWxsID0gc2VyaWFsaXplKGNlbGxzW2NvbHVtbkluZGV4XSk7CgogICAgICAgIGlmIChhbGlnbkRlbGltaXRlcnMgPT09IHRydWUpIHsKICAgICAgICAgIHNpemUgPSBzdHJpbmdMZW5ndGgoY2VsbCk7CiAgICAgICAgICBzaXplc1tjb2x1bW5JbmRleF0gPSBzaXplOwogICAgICAgICAgbGFyZ2VzdCA9IGxvbmdlc3RDZWxsQnlDb2x1bW5bY29sdW1uSW5kZXhdOwoKICAgICAgICAgIGlmIChsYXJnZXN0ID09PSB1bmRlZmluZWQgfHwgc2l6ZSA+IGxhcmdlc3QpIHsKICAgICAgICAgICAgbG9uZ2VzdENlbGxCeUNvbHVtbltjb2x1bW5JbmRleF0gPSBzaXplOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcm93LnB1c2goY2VsbCk7CiAgICAgIH0KCiAgICAgIGNlbGxNYXRyaXhbcm93SW5kZXhdID0gcm93OwogICAgICBzaXplTWF0cml4W3Jvd0luZGV4XSA9IHNpemVzOwogICAgfSAvLyBGaWd1cmUgb3V0IHdoaWNoIGFsaWdubWVudHMgdG8gdXNlLgoKCiAgICBjb2x1bW5JbmRleCA9IC0xOwogICAgY29sdW1uTGVuZ3RoID0gbW9zdENlbGxzUGVyUm93OwoKICAgIGlmIChfdHlwZW9mKGFsaWduKSA9PT0gJ29iamVjdCcgJiYgJ2xlbmd0aCcgaW4gYWxpZ24pIHsKICAgICAgd2hpbGUgKCsrY29sdW1uSW5kZXggPCBjb2x1bW5MZW5ndGgpIHsKICAgICAgICBhbGlnbm1lbnRzW2NvbHVtbkluZGV4XSA9IHRvQWxpZ25tZW50KGFsaWduW2NvbHVtbkluZGV4XSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvZGUgPSB0b0FsaWdubWVudChhbGlnbik7CgogICAgICB3aGlsZSAoKytjb2x1bW5JbmRleCA8IGNvbHVtbkxlbmd0aCkgewogICAgICAgIGFsaWdubWVudHNbY29sdW1uSW5kZXhdID0gY29kZTsKICAgICAgfQogICAgfSAvLyBJbmplY3QgdGhlIGFsaWdubWVudCByb3cuCgoKICAgIGNvbHVtbkluZGV4ID0gLTE7CiAgICBjb2x1bW5MZW5ndGggPSBtb3N0Q2VsbHNQZXJSb3c7CiAgICByb3cgPSBbXTsKICAgIHNpemVzID0gW107CgogICAgd2hpbGUgKCsrY29sdW1uSW5kZXggPCBjb2x1bW5MZW5ndGgpIHsKICAgICAgY29kZSA9IGFsaWdubWVudHNbY29sdW1uSW5kZXhdOwogICAgICBiZWZvcmUgPSAnJzsKICAgICAgYWZ0ZXIgPSAnJzsKCiAgICAgIGlmIChjb2RlID09PSBsKSB7CiAgICAgICAgYmVmb3JlID0gY29sb247CiAgICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gcikgewogICAgICAgIGFmdGVyID0gY29sb247CiAgICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gYykgewogICAgICAgIGJlZm9yZSA9IGNvbG9uOwogICAgICAgIGFmdGVyID0gY29sb247CiAgICAgIH0gLy8gVGhlcmUgKm11c3QqIGJlIGF0IGxlYXN0IG9uZSBoeXBoZW4tbWludXMgaW4gZWFjaCBhbGlnbm1lbnQgY2VsbC4KCgogICAgICBzaXplID0gYWxpZ25EZWxpbWl0ZXJzID8gTWF0aC5tYXgoMSwgbG9uZ2VzdENlbGxCeUNvbHVtbltjb2x1bW5JbmRleF0gLSBiZWZvcmUubGVuZ3RoIC0gYWZ0ZXIubGVuZ3RoKSA6IDE7CiAgICAgIGNlbGwgPSBiZWZvcmUgKyByZXBlYXQoZGFzaCwgc2l6ZSkgKyBhZnRlcjsKCiAgICAgIGlmIChhbGlnbkRlbGltaXRlcnMgPT09IHRydWUpIHsKICAgICAgICBzaXplID0gYmVmb3JlLmxlbmd0aCArIHNpemUgKyBhZnRlci5sZW5ndGg7CgogICAgICAgIGlmIChzaXplID4gbG9uZ2VzdENlbGxCeUNvbHVtbltjb2x1bW5JbmRleF0pIHsKICAgICAgICAgIGxvbmdlc3RDZWxsQnlDb2x1bW5bY29sdW1uSW5kZXhdID0gc2l6ZTsKICAgICAgICB9CgogICAgICAgIHNpemVzW2NvbHVtbkluZGV4XSA9IHNpemU7CiAgICAgIH0KCiAgICAgIHJvd1tjb2x1bW5JbmRleF0gPSBjZWxsOwogICAgfSAvLyBJbmplY3QgdGhlIGFsaWdubWVudCByb3cuCgoKICAgIGNlbGxNYXRyaXguc3BsaWNlKDEsIDAsIHJvdyk7CiAgICBzaXplTWF0cml4LnNwbGljZSgxLCAwLCBzaXplcyk7CiAgICByb3dJbmRleCA9IC0xOwogICAgcm93TGVuZ3RoID0gY2VsbE1hdHJpeC5sZW5ndGg7CiAgICBsaW5lcyA9IFtdOwoKICAgIHdoaWxlICgrK3Jvd0luZGV4IDwgcm93TGVuZ3RoKSB7CiAgICAgIHJvdyA9IGNlbGxNYXRyaXhbcm93SW5kZXhdOwogICAgICBzaXplcyA9IHNpemVNYXRyaXhbcm93SW5kZXhdOwogICAgICBjb2x1bW5JbmRleCA9IC0xOwogICAgICBjb2x1bW5MZW5ndGggPSBtb3N0Q2VsbHNQZXJSb3c7CiAgICAgIGxpbmUgPSBbXTsKCiAgICAgIHdoaWxlICgrK2NvbHVtbkluZGV4IDwgY29sdW1uTGVuZ3RoKSB7CiAgICAgICAgY2VsbCA9IHJvd1tjb2x1bW5JbmRleF0gfHwgJyc7CiAgICAgICAgYmVmb3JlID0gJyc7CiAgICAgICAgYWZ0ZXIgPSAnJzsKCiAgICAgICAgaWYgKGFsaWduRGVsaW1pdGVycyA9PT0gdHJ1ZSkgewogICAgICAgICAgc2l6ZSA9IGxvbmdlc3RDZWxsQnlDb2x1bW5bY29sdW1uSW5kZXhdIC0gKHNpemVzW2NvbHVtbkluZGV4XSB8fCAwKTsKICAgICAgICAgIGNvZGUgPSBhbGlnbm1lbnRzW2NvbHVtbkluZGV4XTsKCiAgICAgICAgICBpZiAoY29kZSA9PT0gcikgewogICAgICAgICAgICBiZWZvcmUgPSByZXBlYXQoc3BhY2UsIHNpemUpOwogICAgICAgICAgfSBlbHNlIGlmIChjb2RlID09PSBjKSB7CiAgICAgICAgICAgIGlmIChzaXplICUgMiA9PT0gMCkgewogICAgICAgICAgICAgIGJlZm9yZSA9IHJlcGVhdChzcGFjZSwgc2l6ZSAvIDIpOwogICAgICAgICAgICAgIGFmdGVyID0gYmVmb3JlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJlZm9yZSA9IHJlcGVhdChzcGFjZSwgc2l6ZSAvIDIgKyAwLjUpOwogICAgICAgICAgICAgIGFmdGVyID0gcmVwZWF0KHNwYWNlLCBzaXplIC8gMiAtIDAuNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGFmdGVyID0gcmVwZWF0KHNwYWNlLCBzaXplKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChzdGFydCA9PT0gdHJ1ZSAmJiBjb2x1bW5JbmRleCA9PT0gMCkgewogICAgICAgICAgbGluZS5wdXNoKHZlcnRpY2FsQmFyKTsKICAgICAgICB9CgogICAgICAgIGlmIChwYWRkaW5nID09PSB0cnVlICYmIC8vIERvbuKAmXQgYWRkIHRoZSBvcGVuaW5nIHNwYWNlIGlmIHdl4oCZcmUgbm90IGFsaWduaW5nIGFuZCB0aGUgY2VsbCBpcwogICAgICAgIC8vIGVtcHR5OiB0aGVyZSB3aWxsIGJlIGEgY2xvc2luZyBzcGFjZS4KICAgICAgICAhKGFsaWduRGVsaW1pdGVycyA9PT0gZmFsc2UgJiYgY2VsbCA9PT0gJycpICYmIChzdGFydCA9PT0gdHJ1ZSB8fCBjb2x1bW5JbmRleCAhPT0gMCkpIHsKICAgICAgICAgIGxpbmUucHVzaChzcGFjZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYWxpZ25EZWxpbWl0ZXJzID09PSB0cnVlKSB7CiAgICAgICAgICBsaW5lLnB1c2goYmVmb3JlKTsKICAgICAgICB9CgogICAgICAgIGxpbmUucHVzaChjZWxsKTsKCiAgICAgICAgaWYgKGFsaWduRGVsaW1pdGVycyA9PT0gdHJ1ZSkgewogICAgICAgICAgbGluZS5wdXNoKGFmdGVyKTsKICAgICAgICB9CgogICAgICAgIGlmIChwYWRkaW5nID09PSB0cnVlKSB7CiAgICAgICAgICBsaW5lLnB1c2goc3BhY2UpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVuZCA9PT0gdHJ1ZSB8fCBjb2x1bW5JbmRleCAhPT0gY29sdW1uTGVuZ3RoIC0gMSkgewogICAgICAgICAgbGluZS5wdXNoKHZlcnRpY2FsQmFyKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGxpbmUgPSBsaW5lLmpvaW4oJycpOwoKICAgICAgaWYgKGVuZCA9PT0gZmFsc2UpIHsKICAgICAgICBsaW5lID0gbGluZS5yZXBsYWNlKHRyYWlsaW5nV2hpdGVzcGFjZSwgJycpOwogICAgICB9CgogICAgICBsaW5lcy5wdXNoKGxpbmUpOwogICAgfQoKICAgIGlmIChzZXR0aW5ncy5ub2FsaWduKSB7CiAgICAgIC8vIFJlbW92ZXMgdGhlIGxpbmUgb2YgZGFzaGVzIHRoYXQgZGVub3RlIGJvdGggYWxpZ25tZW50IGFuZCB0aGUgdGFibGUKICAgICAgLy8gaGVhZGVycy4gTm90ZSB0aGlzIHN0eWxlIG9mIG1hcmtkb3duIHRhYmxlIGlzIG9ubHkgc3VwcG9ydGVkIGJ5CiAgICAgIC8vIHNvbWUgb2RkYmFsbCBtYXJrZG93bnMgKGVnIHBhbmRvYykgYW5kIElTIE5PVCBzdXBwb3J0ZWQgYnkgR2l0aHViLgogICAgICBsaW5lcy5zcGxpY2UoMSwgMSk7CiAgICB9CgogICAgcmV0dXJuIGxpbmVzLmpvaW4obGluZUZlZWQpOwogIH0pKCk7CgogIHJldHVybiBzdHJpbmc7Cn07CnZvaWQgMDsK',
];